
# TDD_P031_預算分析頁面_v1.0.0

**文件編號**: 8831  
**版本**: v1.0.0  
**建立日期**: 2025-01-26  
**建立者**: LCAS SA Team  
**最後更新**: 2025-01-26 15:00:00 UTC+8

---

## 目次

1. [模組概述](#10-模組概述module-overview)
2. [P031預算分析頁面簡介](#20-p031預算分析頁面簡介budget-analysis-page-introduction)
3. [TDD測試規格](#30-tdd測試規格tdd-test-specification)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
P031 預算分析頁面是 LCAS 2.0 Flutter Presentation Layer 的核心分析模組，負責提供全方位的預算執行分析與洞察功能，支援22個測試函數，為使用者提供多維度數據視覺化、趨勢分析、效能評估等完整分析體驗。

### 1.2 核心職責
- **多維度分析引擎**: 支援時間、分類、專案等多維度分析展示
- **智慧圖表視覺化**: 提供折線圖、柱狀圖、圓餅圖、熱力圖等豐富圖表類型
- **四模式差異化體驗**: 支援精準控制者、紀錄習慣者、轉型挑戰者、潛在覺醒者的差異化分析介面
- **智慧洞察與預測**: 提供AI驅動的分析建議和趨勢預測功能

---

## 2.0 P031預算分析頁面簡介（Budget Analysis Page Introduction）

### 2.1 目標與角色
預算分析頁面在 LCAS 2.0 Flutter 架構中提供深度的預算分析功能：
- **視覺化分析**: 實作多種圖表類型的互動式數據展示
- **智慧洞察**: 提供AI驅動的分析建議和異常檢測
- **預測分析**: 基於歷史資料提供趨勢預測和未來預算建議
- **報告匯出**: 支援多種格式的分析報告匯出功能

---

## 3.0 TDD測試規格（TDD Test Specification）

### 3.1 分析頁面載入測試群組（F001-F005）

#### 3.1.1 F001: 分析頁面初始化測試
**功能描述**: 驗證預算分析頁面的正確初始化流程

**測試規格**:
```dart
/**
 * 01. 分析頁面初始化測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證分析頁面載入、權限檢查、預設配置設定
 */
class AnalysisPageInitializationTest {
  // 測試資料設定
  final testUserId = "test_user_001";
  final testBudgetIds = ["budget_001", "budget_002"];
  final mockAnalysisData = MockAnalysisData();
  
  // 01-01: 頁面載入成功測試
  void testPageLoadSuccess() {
    test('分析頁面載入成功', () async {
      // Arrange
      final analysisPage = BudgetAnalysisPage(userId: testUserId);
      
      // Act
      await tester.pumpWidget(analysisPage);
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(BudgetAnalysisPage), findsOneWidget);
      expect(find.text('預算分析'), findsOneWidget);
      expect(find.byType(CircularProgressIndicator), findsNothing);
    });
  }
  
  // 01-02: 權限檢查測試
  void testPermissionCheck() {
    test('分析權限檢查', () async {
      // Arrange
      when(mockAuthService.hasAnalysisPermission(testUserId))
          .thenReturn(true);
      
      // Act
      final hasPermission = await analysisPage.checkAnalysisPermission();
      
      // Assert
      expect(hasPermission, true);
      verify(mockAuthService.hasAnalysisPermission(testUserId)).called(1);
    });
  }
  
  // 01-03: 預設配置載入測試
  void testDefaultConfigurationLoad() {
    test('預設分析配置載入', () async {
      // Arrange
      final expectedConfig = AnalysisConfiguration.defaultConfig();
      
      // Act
      await analysisPage.loadDefaultConfiguration();
      
      // Assert
      expect(analysisPage.currentConfig, equals(expectedConfig));
      expect(analysisPage.timeRange.granularity, equals(TimeGranularity.MONTHLY));
    });
  }
}
```

#### 3.1.2 F002: 分析資料載入測試
**功能描述**: 驗證分析資料的正確載入和處理流程

**測試規格**:
```dart
/**
 * 02. 分析資料載入測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證分析資料載入、API整合、快取處理
 */
class AnalysisDataLoadingTest {
  // 02-01: 預算資料載入成功測試
  void testBudgetDataLoadSuccess() {
    test('預算分析資料載入成功', () async {
      // Arrange
      when(mockBudgetService.getBudgetAnalysis(any))
          .thenAnswer((_) async => mockAnalysisData);
      
      // Act
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Assert
      expect(analysisPage.analysisData, isNotNull);
      expect(analysisPage.isLoading, false);
      verify(mockBudgetService.getBudgetAnalysis(any)).called(1);
    });
  }
  
  // 02-02: API整合測試
  void testAPIIntegration() {
    test('BudgetService API整合', () async {
      // Arrange
      final request = BudgetAnalysisRequest(
        budgetIds: testBudgetIds,
        timeRange: TimeRangeConfig.monthly(),
        dimensions: [AnalysisDimension.TIME, AnalysisDimension.CATEGORY],
      );
      
      // Act
      final response = await mockBudgetService.getBudgetAnalysis(request);
      
      // Assert
      expect(response.success, true);
      expect(response.data.chartData, isNotEmpty);
      expect(response.insights, isNotEmpty);
    });
  }
  
  // 02-03: 快取機制測試
  void testCacheHandling() {
    test('分析資料快取處理', () async {
      // Arrange
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Act - 第二次載入相同資料
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Assert
      verify(mockBudgetService.getBudgetAnalysis(any)).called(1); // 只調用一次
      expect(analysisPage.analysisData, isNotNull);
    });
  }
}
```

### 3.2 圖表視覺化測試群組（F003-F007）

#### 3.2.1 F003: 多圖表類型渲染測試
**功能描述**: 驗證各種圖表類型的正確渲染和互動功能

**測試規格**:
```dart
/**
 * 03. 多圖表類型渲染測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證折線圖、柱狀圖、圓餅圖等多種圖表的渲染
 */
class MultiChartRenderingTest {
  // 03-01: 折線圖渲染測試
  void testLineChartRendering() {
    test('折線圖渲染測試', () async {
      // Arrange
      final chartData = generateLineChartData();
      
      // Act
      await analysisPage.renderChart(ChartType.LINE, chartData);
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(LineChart), findsOneWidget);
      expect(find.byType(ChartContainer), findsOneWidget);
      expect(analysisPage.activeChartType, equals(ChartType.LINE));
    });
  }
  
  // 03-02: 圓餅圖渲染測試
  void testPieChartRendering() {
    test('圓餅圖渲染測試', () async {
      // Arrange
      final pieData = generatePieChartData();
      
      // Act
      await analysisPage.renderChart(ChartType.PIE, pieData);
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(PieChart), findsOneWidget);
      expect(find.byType(PieChartLegend), findsOneWidget);
      expect(pieData.sections.length, greaterThan(0));
    });
  }
  
  // 03-03: 柱狀圖渲染測試
  void testBarChartRendering() {
    test('柱狀圖渲染測試', () async {
      // Arrange
      final barData = generateBarChartData();
      
      // Act
      await analysisPage.renderChart(ChartType.BAR, barData);
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(BarChart), findsOneWidget);
      expect(find.byType(ChartAxisLabel), findsWidgets);
      expect(barData.barGroups.length, greaterThan(0));
    });
  }
}
```

#### 3.2.2 F004: 圖表互動功能測試
**功能描述**: 驗證圖表的縮放、平移、選擇等互動功能

**測試規格**:
```dart
/**
 * 04. 圖表互動功能測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證圖表縮放、平移、資料點選擇等互動功能
 */
class ChartInteractionTest {
  // 04-01: 圖表縮放功能測試
  void testChartZoomInteraction() {
    test('圖表縮放功能', () async {
      // Arrange
      final chartWidget = find.byType(LineChart);
      await tester.pumpWidget(analysisPage);
      
      // Act
      await tester.timedDrag(chartWidget, Offset(100, 0), Duration(seconds: 1));
      await tester.pumpAndSettle();
      
      // Assert
      expect(analysisPage.chartState.zoomLevel, greaterThan(1.0));
      expect(analysisPage.chartState.isZoomed, true);
    });
  }
  
  // 04-02: 資料點選擇測試
  void testDataPointSelection() {
    test('資料點選擇功能', () async {
      // Arrange
      final dataPoint = find.byKey(Key('data_point_0'));
      
      // Act
      await tester.tap(dataPoint);
      await tester.pumpAndSettle();
      
      // Assert
      expect(analysisPage.selectedDataPoints.length, equals(1));
      expect(find.byType(DataPointTooltip), findsOneWidget);
    });
  }
  
  // 04-03: 圖表類型切換測試
  void testChartTypeSwitching() {
    test('圖表類型切換功能', () async {
      // Arrange
      final switchButton = find.byKey(Key('chart_type_switch'));
      
      // Act
      await tester.tap(switchButton);
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(ChartTypePicker), findsOneWidget);
      expect(analysisPage.availableChartTypes.length, greaterThan(3));
    });
  }
}
```

### 3.3 智慧分析功能測試群組（F005-F010）

#### 3.3.1 F005: 洞察生成測試
**功能描述**: 驗證智慧洞察的生成和展示功能

**測試規格**:
```dart
/**
 * 05. 智慧洞察生成測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證AI驅動的智慧洞察生成、異常檢測、建議提供
 */
class SmartInsightsTest {
  // 05-01: 洞察生成測試
  void testInsightGeneration() {
    test('智慧洞察生成', () async {
      // Arrange
      final analysisData = mockAnalysisData;
      
      // Act
      final insights = await analysisPage.generateInsights(analysisData);
      
      // Assert
      expect(insights, isNotEmpty);
      expect(insights.first.type, isIn([InsightType.TREND, InsightType.ANOMALY]));
      expect(insights.first.confidence, greaterThan(0.7));
    });
  }
  
  // 05-02: 異常檢測測試
  void testAnomalyDetection() {
    test('支出異常檢測', () async {
      // Arrange
      final anomalyData = generateAnomalyData();
      
      // Act
      final anomalies = await analysisPage.detectAnomalies(anomalyData);
      
      // Assert
      expect(anomalies, isNotEmpty);
      expect(anomalies.first.severity, equals(AnomalySeverity.HIGH));
      expect(anomalies.first.description, contains('異常'));
    });
  }
  
  // 05-03: 智慧建議測試
  void testSmartRecommendations() {
    test('智慧建議生成', () async {
      // Arrange
      final budgetPerformance = mockBudgetPerformance;
      
      // Act
      final recommendations = await analysisPage.generateRecommendations(budgetPerformance);
      
      // Assert
      expect(recommendations.length, greaterThan(0));
      expect(recommendations.first.category, isIn([
        RecommendationCategory.BUDGET_OPTIMIZATION,
        RecommendationCategory.SPENDING_REDUCTION
      ]));
    });
  }
}
```

#### 3.3.2 F006: 預測分析測試
**功能描述**: 驗證趨勢預測和未來預算建議功能

**測試規格**:
```dart
/**
 * 06. 預測分析測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證趨勢預測、預算預估、未來分析功能
 */
class PredictiveAnalysisTest {
  // 06-01: 趨勢預測測試
  void testTrendPrediction() {
    test('支出趨勢預測', () async {
      // Arrange
      final historicalData = generateHistoricalSpendingData();
      
      // Act
      final prediction = await analysisPage.predictTrend(historicalData);
      
      // Assert
      expect(prediction.predictedValue, greaterThan(0));
      expect(prediction.confidence, greaterThan(0.6));
      expect(prediction.methodology, isNotEmpty);
    });
  }
  
  // 06-02: 預算預估測試
  void testBudgetForecast() {
    test('未來預算需求預估', () async {
      // Arrange
      final currentBudgets = testBudgetData;
      final timeHorizon = Duration(days: 90);
      
      // Act
      final forecast = await analysisPage.forecastBudgetNeeds(currentBudgets, timeHorizon);
      
      // Assert
      expect(forecast.projectedBudgets, isNotEmpty);
      expect(forecast.totalProjectedAmount, greaterThan(0));
      expect(forecast.accuracy, greaterThan(0.7));
    });
  }
  
  // 06-03: 情境分析測試
  void testScenarioAnalysis() {
    test('預算情境分析', () async {
      // Arrange
      final scenarios = [
        BudgetScenario.optimistic(),
        BudgetScenario.realistic(),
        BudgetScenario.pessimistic()
      ];
      
      // Act
      final analysis = await analysisPage.analyzeScenarios(scenarios);
      
      // Assert
      expect(analysis.scenarios.length, equals(3));
      expect(analysis.recommendedScenario, isNotNull);
      expect(analysis.riskAssessment, isNotNull);
    });
  }
}
```

### 3.4 四模式差異化測試群組（F007-F014）

#### 3.4.1 F007-F008: 精準控制者模式測試
**功能描述**: 驗證精準控制者模式的進階分析功能

**測試規格**:
```dart
/**
 * 07-08. 精準控制者模式測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證專業深度分析、複雜多維圖表、進階統計功能
 */
class ControllerModeTest {
  // 07-01: 進階統計功能測試
  void testAdvancedStatistics() {
    test('進階統計分析功能', () async {
      // Arrange
      analysisPage.setUserMode(UserMode.CONTROLLER);
      final statisticalData = mockStatisticalData;
      
      // Act
      final stats = await analysisPage.calculateAdvancedStatistics(statisticalData);
      
      // Assert
      expect(stats.correlation, isNotNull);
      expect(stats.regression, isNotNull);
      expect(stats.variance, greaterThan(0));
      expect(find.byType(StatisticalTable), findsOneWidget);
    });
  }
  
  // 07-02: 多維度分析測試
  void testMultiDimensionalAnalysis() {
    test('多維度複合分析', () async {
      // Arrange
      final dimensions = [
        AnalysisDimension.TIME,
        AnalysisDimension.CATEGORY,
        AnalysisDimension.PROJECT,
        AnalysisDimension.BUDGET
      ];
      
      // Act
      await analysisPage.performMultiDimensionalAnalysis(dimensions);
      
      // Assert
      expect(analysisPage.activeDimensions.length, equals(4));
      expect(find.byType(MultiDimensionalChart), findsOneWidget);
      expect(find.byType(DimensionSelector), findsOneWidget);
    });
  }
  
  // 08-01: 自訂計算功能測試
  void testCustomCalculations() {
    test('自訂指標計算', () async {
      // Arrange
      final customFormula = "SUM(income) - SUM(expense) * 0.1";
      
      // Act
      final result = await analysisPage.calculateCustomMetric(customFormula);
      
      // Assert
      expect(result.value, isNotNull);
      expect(result.isValid, true);
      expect(find.byType(CustomFormulaEditor), findsOneWidget);
    });
  }
}
```

#### 3.4.2 F009-F010: 紀錄習慣者模式測試
**功能描述**: 驗證紀錄習慣者模式的美觀視覺化功能

**測試規格**:
```dart
/**
 * 09-10. 紀錄習慣者模式測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證美觀圖表展示、優雅動畫、個性化主題
 */
class LoggerModeTest {
  // 09-01: 美觀圖表測試
  void testAestheticCharts() {
    test('美觀圖表展示', () async {
      // Arrange
      analysisPage.setUserMode(UserMode.LOGGER);
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Act
      await tester.pumpAndSettle(Duration(seconds: 2));
      
      // Assert
      expect(find.byType(AestheticChartContainer), findsWidgets);
      expect(analysisPage.currentTheme.name, equals('elegant'));
      expect(find.byType(AnimatedChart), findsOneWidget);
    });
  }
  
  // 09-02: 動畫效果測試
  void testChartAnimations() {
    test('圖表動畫效果', () async {
      // Arrange
      final animationController = analysisPage.animationController;
      
      // Act
      await analysisPage.animateChartTransition(ChartType.PIE);
      
      // Assert
      expect(animationController.isAnimating, true);
      expect(find.byType(FadeTransition), findsOneWidget);
      expect(find.byType(SlideTransition), findsOneWidget);
    });
  }
  
  // 10-01: 個性化主題測試
  void testPersonalizedThemes() {
    test('個性化主題配置', () async {
      // Arrange
      final customTheme = ChartTheme.createCustom(
        primaryColor: Colors.purple,
        accentColor: Colors.amber,
      );
      
      // Act
      await analysisPage.applyTheme(customTheme);
      
      // Assert
      expect(analysisPage.currentTheme, equals(customTheme));
      expect(find.byType(ThemeCustomizer), findsOneWidget);
    });
  }
}
```

#### 3.4.3 F011-F012: 轉型挑戰者模式測試
**功能描述**: 驗證轉型挑戰者模式的目標導向分析功能

**測試規格**:
```dart
/**
 * 11-12. 轉型挑戰者模式測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證目標追蹤、挑戰進度、激勵機制功能
 */
class StrugglerModeTest {
  // 11-01: 目標達成分析測試
  void testGoalAchievementAnalysis() {
    test('目標達成進度分析', () async {
      // Arrange
      analysisPage.setUserMode(UserMode.STRUGGLER);
      final goals = mockFinancialGoals;
      
      // Act
      final progress = await analysisPage.analyzeGoalProgress(goals);
      
      // Assert
      expect(progress.completionPercentage, inInclusiveRange(0.0, 100.0));
      expect(find.byType(GoalProgressChart), findsOneWidget);
      expect(find.byType(AchievementBadge), findsWidgets);
    });
  }
  
  // 11-02: 習慣改善追蹤測試
  void testHabitImprovementTracking() {
    test('財務習慣改善追蹤', () async {
      // Arrange
      final habits = mockSpendingHabits;
      
      // Act
      final tracking = await analysisPage.trackHabitImprovement(habits);
      
      // Assert
      expect(tracking.improvementScore, greaterThan(0));
      expect(find.byType(HabitTracker), findsOneWidget);
      expect(find.text('習慣改善'), findsOneWidget);
    });
  }
  
  // 12-01: 激勵機制測試
  void testMotivationalFeatures() {
    test('激勵與挑戰機制', () async {
      // Arrange
      final achievements = mockUserAchievements;
      
      // Act
      await analysisPage.displayMotivationalContent(achievements);
      
      // Assert
      expect(find.byType(MotivationalCard), findsWidgets);
      expect(find.byType(ChallengeProgressBar), findsOneWidget);
      expect(find.text('繼續加油！'), findsOneWidget);
    });
  }
}
```

#### 3.4.4 F013-F014: 潛在覺醒者模式測試
**功能描述**: 驗證潛在覺醒者模式的簡化分析功能

**測試規格**:
```dart
/**
 * 13-14. 潛在覺醒者模式測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證簡化介面、基本圖表、易懂洞察功能
 */
class SleeperModeTest {
  // 13-01: 簡化介面測試
  void testSimplifiedInterface() {
    test('簡化分析介面', () async {
      // Arrange
      analysisPage.setUserMode(UserMode.SLEEPER);
      
      // Act
      await analysisPage.loadSimplifiedView();
      
      // Assert
      expect(find.byType(SimplifiedSummaryCard), findsOneWidget);
      expect(find.byType(BasicChart), findsOneWidget);
      expect(find.byType(AdvancedControls), findsNothing);
    });
  }
  
  // 13-02: 基本圖表測試
  void testBasicCharts() {
    test('基本圖表展示', () async {
      // Arrange
      final basicData = generateBasicChartData();
      
      // Act
      await analysisPage.renderBasicChart(basicData);
      
      // Assert
      expect(find.byType(SimpleBarChart), findsOneWidget);
      expect(find.byType(ChartTitle), findsOneWidget);
      expect(find.text('收入 vs 支出'), findsOneWidget);
    });
  }
  
  // 14-01: 易懂洞察測試
  void testEasyInsights() {
    test('簡單易懂洞察', () async {
      // Arrange
      final simpleData = mockSimpleAnalysisData;
      
      // Act
      final insights = await analysisPage.generateEasyInsights(simpleData);
      
      // Assert
      expect(insights.first.language, equals(InsightLanguage.SIMPLE));
      expect(insights.first.description.length, lessThan(100));
      expect(find.byType(EasyInsightCard), findsWidgets);
    });
  }
}
```

### 3.5 報告匯出測試群組（F015-F018）

#### 3.5.1 F015-F016: 報告生成與匯出測試
**功能描述**: 驗證分析報告的生成和多格式匯出功能

**測試規格**:
```dart
/**
 * 15-16. 報告生成與匯出測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證PDF、HTML、Excel等格式的報告匯出功能
 */
class ReportExportTest {
  // 15-01: PDF報告生成測試
  void testPDFReportGeneration() {
    test('PDF格式報告生成', () async {
      // Arrange
      final reportConfig = ReportConfiguration.pdf();
      
      // Act
      final pdfReport = await analysisPage.generatePDFReport(reportConfig);
      
      // Assert
      expect(pdfReport.fileSize, greaterThan(0));
      expect(pdfReport.format, equals(ExportFormat.PDF));
      expect(pdfReport.includesCharts, true);
    });
  }
  
  // 15-02: HTML報告生成測試
  void testHTMLReportGeneration() {
    test('HTML格式報告生成', () async {
      // Arrange
      final reportConfig = ReportConfiguration.html();
      
      // Act
      final htmlReport = await analysisPage.generateHTMLReport(reportConfig);
      
      // Assert
      expect(htmlReport.content, contains('<html>'));
      expect(htmlReport.content, contains('預算分析報告'));
      expect(htmlReport.isInteractive, true);
    });
  }
  
  // 16-01: Excel報告匯出測試
  void testExcelReportExport() {
    test('Excel格式資料匯出', () async {
      // Arrange
      final exportConfig = ExportConfiguration.excel();
      
      // Act
      final excelFile = await analysisPage.exportToExcel(exportConfig);
      
      // Assert
      expect(excelFile.worksheets.length, greaterThan(0));
      expect(excelFile.worksheets.first.name, equals('分析資料'));
      expect(excelFile.hasCharts, true);
    });
  }
}
```

#### 3.5.2 F017-F018: 報告分享與範本測試
**功能描述**: 驗證報告分享和範本管理功能

**測試規格**:
```dart
/**
 * 17-18. 報告分享與範本測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證報告分享、範本儲存、範本套用功能
 */
class ReportSharingAndTemplateTest {
  // 17-01: 報告分享功能測試
  void testReportSharing() {
    test('分析報告分享功能', () async {
      // Arrange
      final report = await analysisPage.generateReport();
      final shareConfig = ShareConfiguration.team();
      
      // Act
      final shareResult = await analysisPage.shareReport(report, shareConfig);
      
      // Assert
      expect(shareResult.success, true);
      expect(shareResult.shareUrl, isNotEmpty);
      expect(shareResult.expiresAt, isAfter(DateTime.now()));
    });
  }
  
  // 17-02: 權限控制測試
  void testSharingPermissions() {
    test('分享權限控制', () async {
      // Arrange
      final restrictedConfig = ShareConfiguration.restricted();
      
      // Act
      final permissions = await analysisPage.checkSharingPermissions(restrictedConfig);
      
      // Assert
      expect(permissions.canShare, isNotNull);
      expect(permissions.allowedUsers, isNotNull);
      expect(permissions.restrictions, isNotEmpty);
    });
  }
  
  // 18-01: 範本管理測試
  void testTemplateManagement() {
    test('分析範本管理', () async {
      // Arrange
      final customTemplate = AnalysisTemplate.create('Monthly Review');
      
      // Act
      await analysisPage.saveTemplate(customTemplate);
      final templates = await analysisPage.loadTemplates();
      
      // Assert
      expect(templates, contains(customTemplate));
      expect(find.byType(TemplateSelector), findsOneWidget);
    });
  }
}
```

### 3.6 效能與穩定性測試群組（F019-F022）

#### 3.6.1 F019-F020: 效能壓力測試
**功能描述**: 驗證大量資料處理和高併發情況下的效能表現

**測試規格**:
```dart
/**
 * 19-20. 效能壓力測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證大量資料處理、高併發、記憶體使用優化
 */
class PerformanceStressTest {
  // 19-01: 大量資料處理測試
  void testLargeDatasetProcessing() {
    test('大量資料集處理效能', () async {
      // Arrange
      final largeDataset = generateLargeDataset(100000); // 10萬筆資料
      final startTime = DateTime.now();
      
      // Act
      await analysisPage.processLargeDataset(largeDataset);
      final endTime = DateTime.now();
      
      // Assert
      final processingTime = endTime.difference(startTime);
      expect(processingTime.inSeconds, lessThan(10));
      expect(analysisPage.isResponsive, true);
    });
  }
  
  // 19-02: 記憶體使用優化測試
  void testMemoryUsageOptimization() {
    test('記憶體使用優化', () async {
      // Arrange
      final initialMemory = getMemoryUsage();
      
      // Act
      await analysisPage.loadMultipleAnalyses(10);
      await analysisPage.clearCache();
      
      // Assert
      final finalMemory = getMemoryUsage();
      expect(finalMemory - initialMemory, lessThan(100 * 1024 * 1024)); // < 100MB
    });
  }
  
  // 20-01: 併發處理測試
  void testConcurrentProcessing() {
    test('併發分析處理', () async {
      // Arrange
      final futures = List.generate(5, (i) => 
        analysisPage.performAnalysis(generateTestData(i))
      );
      
      // Act
      final results = await Future.wait(futures);
      
      // Assert
      expect(results.length, equals(5));
      expect(results.every((r) => r.success), true);
    });
  }
}
```

#### 3.6.2 F021-F022: 錯誤處理與恢復測試
**功能描述**: 驗證各種異常情況的處理和系統恢復能力

**測試規格**:
```dart
/**
 * 21-22. 錯誤處理與恢復測試
 * @version 2025-01-26-V1.0.1
 * @date 2025-01-26 15:00:00
 * @description 驗證網路異常、API錯誤、資料異常的處理和恢復
 */
class ErrorHandlingAndRecoveryTest {
  // 21-01: 網路異常處理測試
  void testNetworkErrorHandling() {
    test('網路連線異常處理', () async {
      // Arrange
      when(mockBudgetService.getBudgetAnalysis(any))
          .thenThrow(NetworkException('Connection timeout'));
      
      // Act
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Assert
      expect(find.text('網路連線異常'), findsOneWidget);
      expect(find.byType(RetryButton), findsOneWidget);
      expect(analysisPage.hasError, true);
    });
  }
  
  // 21-02: API錯誤處理測試
  void testAPIErrorHandling() {
    test('API服務錯誤處理', () async {
      // Arrange
      when(mockBudgetService.getBudgetAnalysis(any))
          .thenThrow(APIException('Internal server error', statusCode: 500));
      
      // Act
      await analysisPage.loadAnalysisData(testBudgetIds);
      
      // Assert
      expect(analysisPage.errorMessage, contains('服務暫時無法使用'));
      expect(find.byType(ErrorDialog), findsOneWidget);
    });
  }
  
  // 22-01: 自動恢復機制測試
  void testAutoRecoveryMechanism() {
    test('自動恢復機制', () async {
      // Arrange
      var callCount = 0;
      when(mockBudgetService.getBudgetAnalysis(any)).thenAnswer((_) async {
        callCount++;
        if (callCount < 3) throw NetworkException('Temporary failure');
        return mockAnalysisData;
      });
      
      // Act
      await analysisPage.loadAnalysisDataWithRetry(testBudgetIds);
      
      // Assert
      expect(callCount, equals(3));
      expect(analysisPage.analysisData, isNotNull);
      expect(analysisPage.isLoading, false);
    });
  }
  
  // 22-02: 資料一致性保護測試
  void testDataConsistencyProtection() {
    test('資料一致性保護', () async {
      // Arrange
      final corruptData = generateCorruptAnalysisData();
      
      // Act
      final isValid = await analysisPage.validateAnalysisData(corruptData);
      
      // Assert
      expect(isValid, false);
      expect(analysisPage.hasValidData, false);
      expect(find.text('資料驗證失敗'), findsOneWidget);
    });
  }
}
```

---

## 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| **v1.0.0** | **2025-01-26** | **LCAS SA Team** | **初版建立：實作22個測試函數，完整覆蓋預算分析頁面功能，包含多維度分析引擎、智慧圖表視覺化、四模式差異化體驗、智慧洞察與預測、報告匯出等核心功能** |

---

## 備註

- **版本1.0.0特色**: 完整的預算分析頁面TDD測試規格，涵蓋所有分析功能
- **22個測試函數**: F001-F022 全方位測試覆蓋（頁面載入、圖表渲染、智慧分析、四模式體驗、報告匯出、效能穩定性）
- **四模式差異化**: 精準控制者、紀錄習慣者、轉型挑戰者、潛在覺醒者的完整測試覆蓋
- **智慧分析引擎**: AI驅動洞察、異常檢測、趨勢預測、情境分析的全面測試
- **視覺化測試**: 多種圖表類型、互動功能、動畫效果的完整驗證
- **整合測試**: 與BudgetService、ReportService、AnalyticsService的API整合測試
- **效能測試**: 大量資料處理、高併發、記憶體優化的壓力測試
- **對應SRS**: 完全對應P031_預算分析頁面_SRS.md的所有功能需求
- **API版本**: 整合BudgetService v1.0.0、F017 v2.0.0分析API
