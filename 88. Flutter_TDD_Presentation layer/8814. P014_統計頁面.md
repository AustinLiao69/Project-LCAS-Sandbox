
# 8814. P014_統計頁面 TDD

**文件版本：v1.0.0**  
**建立日期：2025-01-27**  
**最後更新：2025-01-27 12:00:00**

---

## 1.0 模組資訊

### 1.1 模組識別
```dart
/**
 * P014_統計頁面TDD_1.0.0
 * @module 統計頁面TDD
 * @description Flutter統計頁面測試驅動開發規格 - 完整統計分析功能與圖表視覺化
 * @update 2025-01-27: 新建統計頁面TDD，支援多維度統計分析、圖表互動、數據匯出等功能
 */
```

### 1.2 依賴關係
- **SRS規格**：P014_統計頁面_SRS.md
- **AP Layer**：8903 ProjectLedgerService、8902 EntryService、8904 BudgetService、8906 ReportService
- **相關頁面**：8806首頁儀表板、8809記帳歷史頁面、8812設定頁面

---

## 2.0 核心Widget測試規格

### 2.1 StatisticsPage主控件
```dart
/**
 * 01. 對應 2.1：統計頁面主控件
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計頁面的主要控件，整合各種統計功能
 */
class StatisticsPage extends ConsumerStatefulWidget {
  final String? ledgerId;
  final UserMode? mode;
  final StatisticsViewType initialView;

  const StatisticsPage({
    Key? key,
    this.ledgerId,
    this.mode,
    this.initialView = StatisticsViewType.overview,
  }) : super(key: key);

  /**
   * 02. 對應 2.1：建立統計頁面狀態
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 初始化統計頁面狀態管理
   */
  @override
  ConsumerState<StatisticsPage> createState() => _StatisticsPageState();
}

/**
 * 03. 對應 2.1：統計頁面狀態管理
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 管理統計頁面的狀態和生命週期
 */
class _StatisticsPageState extends ConsumerState<StatisticsPage>
    with TickerProviderStateMixin {
  late TabController _tabController;
  late AnimationController _animationController;
  final ScrollController _scrollController = ScrollController();

  /**
   * 04. 對應 2.1：初始化統計頁面
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 初始化控制器和監聽器
   */
  @override
  void initState();

  /**
   * 05. 對應 2.1：建構統計頁面UI
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據模式和狀態建構適應式統計介面
   */
  @override
  Widget build(BuildContext context);

  /**
   * 06. 對應 2.1：釋放資源
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 清理控制器和監聽器
   */
  @override
  void dispose();
}
```

### 2.2 統計概覽Widget
```dart
/**
 * 07. 對應 2.2：統計概覽Widget
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 顯示收支統計概覽和關鍵指標
 */
class StatisticsOverviewWidget extends ConsumerWidget {
  final DateTimeRange? dateRange;
  final String? categoryFilter;
  final UserMode? mode;

  const StatisticsOverviewWidget({
    Key? key,
    this.dateRange,
    this.categoryFilter,
    this.mode,
  }) : super(key: key);

  /**
   * 08. 對應 2.2：建構概覽介面
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據模式建構統計概覽介面
   */
  @override
  Widget build(BuildContext context, WidgetRef ref);

  /**
   * 09. 對應 2.2：建構關鍵指標卡片
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構收入、支出、結餘等關鍵指標卡片
   */
  Widget _buildMetricCards(StatisticsData data, UserMode? mode);

  /**
   * 10. 對應 2.2：建構趨勢圖表
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構收支趨勢折線圖
   */
  Widget _buildTrendChart(List<TrendData> trendData, UserMode? mode);
}
```

### 2.3 分類統計Widget
```dart
/**
 * 11. 對應 2.3：分類統計Widget
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 顯示各分類的支出統計和圓餅圖
 */
class CategoryStatisticsWidget extends ConsumerWidget {
  final DateTimeRange? dateRange;
  final TransactionType type;
  final UserMode? mode;

  const CategoryStatisticsWidget({
    Key? key,
    this.dateRange,
    this.type = TransactionType.expense,
    this.mode,
  }) : super(key: key);

  /**
   * 12. 對應 2.3：建構分類統計介面
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據交易類型建構分類統計介面
   */
  @override
  Widget build(BuildContext context, WidgetRef ref);

  /**
   * 13. 對應 2.3：建構圓餅圖
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構分類占比圓餅圖
   */
  Widget _buildPieChart(List<CategoryStatistics> categoryData, UserMode? mode);

  /**
   * 14. 對應 2.3：建構分類清單
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構分類統計明細清單
   */
  Widget _buildCategoryList(List<CategoryStatistics> categoryData, UserMode? mode);
}
```

### 2.4 時間統計Widget
```dart
/**
 * 15. 對應 2.4：時間統計Widget
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 顯示月度、週度、日度統計分析
 */
class TimeStatisticsWidget extends ConsumerWidget {
  final TimePeriod period;
  final DateTimeRange? customRange;
  final UserMode? mode;

  const TimeStatisticsWidget({
    Key? key,
    this.period = TimePeriod.monthly,
    this.customRange,
    this.mode,
  }) : super(key: key);

  /**
   * 16. 對應 2.4：建構時間統計介面
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據時間週期建構統計介面
   */
  @override
  Widget build(BuildContext context, WidgetRef ref);

  /**
   * 17. 對應 2.4：建構柱狀圖
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構時間統計柱狀圖
   */
  Widget _buildBarChart(List<TimeStatistics> timeData, UserMode? mode);

  /**
   * 18. 對應 2.4：建構同期比較
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構同期比較統計
   */
  Widget _buildPeriodComparison(TimeStatistics current, TimeStatistics? previous);
}
```

---

## 3.0 互動功能測試

### 3.1 篩選器控制
```dart
/**
 * 19. 對應 3.1：統計篩選器控制器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 管理統計數據的篩選條件
 */
class StatisticsFilterController extends ChangeNotifier {
  DateTimeRange? _dateRange;
  List<String> _selectedCategories = [];
  TransactionType? _transactionType;
  String? _ledgerId;

  /**
   * 20. 對應 3.1：設定日期範圍
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 設定統計的日期範圍篩選
   */
  void setDateRange(DateTimeRange? range);

  /**
   * 21. 對應 3.1：設定分類篩選
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 設定要統計的分類篩選
   */
  void setCategories(List<String> categories);

  /**
   * 22. 對應 3.1：設定交易類型篩選
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 設定收入或支出類型篩選
   */
  void setTransactionType(TransactionType? type);

  /**
   * 23. 對應 3.1：重設篩選條件
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 重設所有篩選條件為預設值
   */
  void resetFilters();
}

/**
 * 24. 對應 3.1：篩選器UI Widget
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計篩選器的UI控制介面
 */
class StatisticsFilterWidget extends ConsumerWidget {
  final VoidCallback? onFilterChanged;
  final UserMode? mode;

  const StatisticsFilterWidget({
    Key? key,
    this.onFilterChanged,
    this.mode,
  }) : super(key: key);

  /**
   * 25. 對應 3.1：建構篩選器介面
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建構篩選器控制介面
   */
  @override
  Widget build(BuildContext context, WidgetRef ref);

  /**
   * 26. 對應 3.1：顯示日期選擇器
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 顯示日期範圍選擇對話框
   */
  Future<void> _showDatePicker(BuildContext context, WidgetRef ref);

  /**
   * 27. 對應 3.1：顯示分類選擇器
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 顯示分類多選對話框
   */
  Future<void> _showCategoryPicker(BuildContext context, WidgetRef ref);
}
```

### 3.2 圖表互動
```dart
/**
 * 28. 對應 3.2：圖表互動處理器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 處理圖表的點擊、縮放、平移等互動
 */
class ChartInteractionHandler {
  final Function(ChartPoint)? onPointTap;
  final Function(ChartSection)? onSectionTap;
  final Function(double)? onZoom;

  ChartInteractionHandler({
    this.onPointTap,
    this.onSectionTap,
    this.onZoom,
  });

  /**
   * 29. 對應 3.2：處理圖表點擊
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理圖表數據點的點擊事件
   */
  void handleChartTap(TapUpDetails details, ChartData chartData);

  /**
   * 30. 對應 3.2：處理圖表長按
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理圖表的長按顯示詳細資訊
   */
  void handleChartLongPress(LongPressStartDetails details, ChartData chartData);

  /**
   * 31. 對應 3.2：處理圖表縮放
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理圖表的縮放手勢
   */
  void handleChartScale(ScaleUpdateDetails details);
}

/**
 * 32. 對應 3.2：互動式圖表Widget
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 支援互動的圖表基礎Widget
 */
class InteractiveChartWidget extends StatefulWidget {
  final ChartData data;
  final ChartType type;
  final ChartInteractionHandler? interactionHandler;
  final UserMode? mode;

  const InteractiveChartWidget({
    Key? key,
    required this.data,
    required this.type,
    this.interactionHandler,
    this.mode,
  }) : super(key: key);

  /**
   * 33. 對應 3.2：建立圖表狀態
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建立互動式圖表的狀態管理
   */
  @override
  State<InteractiveChartWidget> createState() => _InteractiveChartWidgetState();
}
```

---

## 4.0 狀態管理測試

### 4.1 統計數據Provider
```dart
/**
 * 34. 對應 4.1：統計數據狀態Provider
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 管理統計頁面的數據狀態
 */
class StatisticsStateNotifier extends StateNotifier<StatisticsState> {
  final EntryService _entryService;
  final BudgetService _budgetService;
  final ReportService _reportService;

  StatisticsStateNotifier(
    this._entryService,
    this._budgetService,
    this._reportService,
  ) : super(const StatisticsState.initial());

  /**
   * 35. 對應 4.1：載入統計數據
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據篩選條件載入統計數據
   */
  Future<void> loadStatistics({
    String? ledgerId,
    DateTimeRange? dateRange,
    List<String>? categories,
    TransactionType? type,
  });

  /**
   * 36. 對應 4.1：更新篩選條件
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 更新統計的篩選條件並重新載入數據
   */
  Future<void> updateFilters(StatisticsFilter filter);

  /**
   * 37. 對應 4.1：載入趨勢數據
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 載入特定時間範圍的趨勢統計數據
   */
  Future<void> loadTrendData(TimePeriod period, DateTimeRange range);

  /**
   * 38. 對應 4.1：快取統計數據
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 快取統計數據以提升效能
   */
  void cacheStatistics(String key, StatisticsData data);
}

/**
 * 39. 對應 4.1：統計狀態定義
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 定義統計頁面的各種狀態
 */
@freezed
class StatisticsState with _$StatisticsState {
  const factory StatisticsState.initial() = _Initial;
  const factory StatisticsState.loading() = _Loading;
  const factory StatisticsState.loaded(StatisticsData data) = _Loaded;
  const factory StatisticsState.error(String message) = _Error;
  const factory StatisticsState.refreshing(StatisticsData currentData) = _Refreshing;
}
```

### 4.2 圖表狀態管理
```dart
/**
 * 40. 對應 4.2：圖表狀態管理Provider
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 管理圖表的顯示狀態和互動狀態
 */
class ChartStateNotifier extends StateNotifier<ChartState> {
  ChartStateNotifier() : super(const ChartState.initial());

  /**
   * 41. 對應 4.2：設定圖表類型
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 切換圖表的顯示類型
   */
  void setChartType(ChartType type);

  /**
   * 42. 對應 4.2：設定圖表縮放
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 設定圖表的縮放等級
   */
  void setZoomLevel(double zoom);

  /**
   * 43. 對應 4.2：設定選中數據點
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 設定圖表中選中的數據點
   */
  void setSelectedPoint(ChartPoint? point);

  /**
   * 44. 對應 4.2：切換圖表動畫
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 開啟或關閉圖表動畫效果
   */
  void toggleAnimation(bool enabled);
}

/**
 * 45. 對應 4.2：圖表狀態定義
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 定義圖表的各種狀態
 */
@freezed
class ChartState with _$ChartState {
  const factory ChartState.initial({
    @Default(ChartType.line) ChartType type,
    @Default(1.0) double zoomLevel,
    ChartPoint? selectedPoint,
    @Default(true) bool animationEnabled,
  }) = _ChartState;
}
```

---

## 5.0 資料模型

### 5.1 統計數據模型
```dart
/**
 * 46. 對應 5.1：統計數據模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計分析的核心數據結構
 */
class StatisticsData {
  final OverviewStatistics overview;
  final List<CategoryStatistics> categoryStats;
  final List<TimeStatistics> timeStats;
  final List<TrendData> trendData;
  final DateTime generatedAt;

  StatisticsData({
    required this.overview,
    required this.categoryStats,
    required this.timeStats,
    required this.trendData,
    required this.generatedAt,
  });

  factory StatisticsData.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}

/**
 * 47. 對應 5.1：概覽統計模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計概覽數據結構
 */
class OverviewStatistics {
  final double totalIncome;
  final double totalExpense;
  final double netAmount;
  final int transactionCount;
  final double averageTransaction;
  final double incomeGrowth;
  final double expenseGrowth;

  OverviewStatistics({
    required this.totalIncome,
    required this.totalExpense,
    required this.netAmount,
    required this.transactionCount,
    required this.averageTransaction,
    required this.incomeGrowth,
    required this.expenseGrowth,
  });

  factory OverviewStatistics.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}

/**
 * 48. 對應 5.1：分類統計模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 分類統計數據結構
 */
class CategoryStatistics {
  final String categoryId;
  final String categoryName;
  final double amount;
  final double percentage;
  final int transactionCount;
  final double averageAmount;
  final Color color;
  final List<SubcategoryStatistics> subcategories;

  CategoryStatistics({
    required this.categoryId,
    required this.categoryName,
    required this.amount,
    required this.percentage,
    required this.transactionCount,
    required this.averageAmount,
    required this.color,
    required this.subcategories,
  });

  factory CategoryStatistics.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}

/**
 * 49. 對應 5.1：時間統計模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 時間週期統計數據結構
 */
class TimeStatistics {
  final DateTime period;
  final TimePeriod periodType;
  final double income;
  final double expense;
  final double net;
  final int transactionCount;
  final double previousPeriodGrowth;

  TimeStatistics({
    required this.period,
    required this.periodType,
    required this.income,
    required this.expense,
    required this.net,
    required this.transactionCount,
    required this.previousPeriodGrowth,
  });

  factory TimeStatistics.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}

/**
 * 50. 對應 5.1：趨勢數據模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 趨勢分析數據結構
 */
class TrendData {
  final DateTime date;
  final double value;
  final TrendType type;
  final double? prediction;
  final double? confidence;

  TrendData({
    required this.date,
    required this.value,
    required this.type,
    this.prediction,
    this.confidence,
  });

  factory TrendData.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

### 5.2 圖表數據模型
```dart
/**
 * 51. 對應 5.2：圖表數據模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 圖表渲染的數據結構
 */
class ChartData {
  final List<ChartPoint> points;
  final List<ChartSeries> series;
  final ChartAxes axes;
  final ChartStyle style;

  ChartData({
    required this.points,
    required this.series,
    required this.axes,
    required this.style,
  });

  factory ChartData.fromStatistics(StatisticsData statistics, ChartType type);
}

/**
 * 52. 對應 5.2：圖表數據點模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 圖表中的數據點結構
 */
class ChartPoint {
  final double x;
  final double y;
  final String? label;
  final Color? color;
  final Map<String, dynamic>? metadata;

  ChartPoint({
    required this.x,
    required this.y,
    this.label,
    this.color,
    this.metadata,
  });
}

/**
 * 53. 對應 5.2：篩選條件模型
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計篩選條件數據結構
 */
class StatisticsFilter {
  final DateTimeRange? dateRange;
  final List<String> categories;
  final TransactionType? transactionType;
  final String? ledgerId;
  final double? minAmount;
  final double? maxAmount;

  StatisticsFilter({
    this.dateRange,
    this.categories = const [],
    this.transactionType,
    this.ledgerId,
    this.minAmount,
    this.maxAmount,
  });

  factory StatisticsFilter.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

---

## 6.0 導航路由設計

### 6.1 路由配置
```dart
/**
 * 54. 對應 6.1：統計頁面路由配置
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 定義統計頁面的路由規則與導航邏輯
 */
class StatisticsRoutes {
  static const String statistics = '/statistics';
  static const String categoryDetail = '/statistics/category';
  static const String timeDetail = '/statistics/time';
  static const String exportData = '/statistics/export';

  /**
   * 55. 對應 6.1：取得統計頁面路由
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 建立統計頁面的GoRoute配置
   */
  static GoRoute getStatisticsRoute();
}

/**
 * 56. 對應 6.1：統計導航服務
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 處理統計相關的導航邏輯
 */
class StatisticsNavigationService {
  static final GoRouter _router;
  static GoRouter get router;

  /**
   * 57. 對應 6.1：導航到分類詳情
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 導航到特定分類的詳細統計
   */
  Future<void> navigateToCategoryDetail(String categoryId);

  /**
   * 58. 對應 6.1：導航到數據匯出
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 導航到統計數據匯出頁面
   */
  Future<void> navigateToExport(StatisticsData data);

  /**
   * 59. 對應 6.1：返回首頁
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 返回到首頁儀表板
   */
  Future<void> navigateToHome();
}
```

---

## 7.0 響應式設計

### 7.1 模式適配
```dart
/**
 * 60. 對應 7.1：統計頁面響應式適配器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 根據使用者模式和裝置類型調整統計頁面佈局
 */
class StatisticsResponsiveAdapter {
  final UserMode? mode;
  final DeviceType deviceType;

  StatisticsResponsiveAdapter({
    this.mode,
    required this.deviceType,
  });

  /**
   * 61. 對應 7.1：取得統計佈局配置
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據使用者模式和裝置類型返回適當統計佈局
   */
  StatisticsLayoutConfig getLayoutConfigForMode(UserMode? mode);

  /**
   * 62. 對應 7.1：取得圖表尺寸
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據裝置類型返回適當圖表尺寸
   */
  Size getChartSizeForDevice(DeviceType deviceType, ChartType chartType);

  /**
   * 63. 對應 7.1：取得列數配置
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據螢幕寬度返回適當的統計卡片列數
   */
  int getColumnCountForWidth(double width);

  /**
   * 64. 對應 7.1：取得字體縮放
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 根據使用者模式返回適當字體縮放比例
   */
  double getFontScaleForMode(UserMode? mode);
}

/**
 * 65. 對應 7.1：統計佈局配置
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計頁面佈局的配置參數
 */
class StatisticsLayoutConfig {
  final EdgeInsets padding;
  final double spacing;
  final int crossAxisCount;
  final double aspectRatio;
  final bool showSidebar;
  final double chartHeight;

  StatisticsLayoutConfig({
    required this.padding,
    required this.spacing,
    required this.crossAxisCount,
    required this.aspectRatio,
    required this.showSidebar,
    required this.chartHeight,
  });
}
```

---

## 8.0 無障礙功能

### 8.1 語意化支援
```dart
/**
 * 66. 對應 8.1：統計頁面無障礙語意化Widget包裝器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 提供WCAG 2.1 AA標準的完整無障礙支援（9005規範）
 */
class StatisticsAccessibilityWrapper {

  /**
   * 67. 對應 8.1：為統計卡片提供語意化標籤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 為統計指標卡片添加適當的語意化標籤
   */
  static Widget wrapStatCard(Widget child, String metricType, double value, String unit);

  /**
   * 68. 對應 8.1：為圖表提供語意化標籤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 為圖表添加適當的語意化標籤和描述
   */
  static Widget wrapChart(Widget child, ChartType type, String description, List<ChartPoint> data);

  /**
   * 69. 對應 8.1：為篩選器提供語意化標籤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 為篩選控制項添加適當的語意化標籤
   */
  static Widget wrapFilter(Widget child, String filterType, {bool isActive = false, String? value});

  /**
   * 70. 對應 8.1：為數據點提供語意化標籤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 為圖表數據點添加適當的語意化標籤
   */
  static Widget wrapDataPoint(Widget child, ChartPoint point, String context);

  /**
   * 71. 對應 8.1：為匯出按鈕提供語意化標籤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 為數據匯出按鈕添加適當的語意化標籤
   */
  static Widget wrapExportButton(Widget child, ExportFormat format, bool isEnabled);
}
```

---

## 9.0 效能最佳化

### 9.1 Widget快取策略
```dart
/**
 * 72. 對應 9.1：統計頁面Widget快取管理器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 優化統計頁面Widget重建效能，減少不必要的重建
 */
class StatisticsWidgetCache {
  static final Map<String, Widget> _cache = {};
  static final Map<String, DateTime> _cacheTimestamps = {};
  static const Duration _cacheValidDuration = Duration(minutes: 5);

  /**
   * 73. 對應 9.1：取得快取的圖表或建立新的
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 從快取中獲取圖表Widget或創建新的
   */
  static Widget getChartOrCreate(String chartKey, Widget Function() creator);

  /**
   * 74. 對應 9.1：取得快取的統計卡片或建立新的
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 從快取中獲取統計卡片Widget或創建新的
   */
  static Widget getStatCardOrCreate(String cardKey, Widget Function() creator);

  /**
   * 75. 對應 9.1：清理過期快取
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 清理超過有效期的Widget快取
   */
  static void cleanExpiredCache();

  /**
   * 76. 對應 9.1：清除所有快取
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 清除所有Widget快取
   */
  static void clearAllCache();
}

/**
 * 77. 對應 9.1：數據快取管理器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 管理統計數據的快取策略
 */
class StatisticsDataCache {
  static final Map<String, StatisticsData> _dataCache = {};
  static final Map<String, DateTime> _cacheTimestamps = {};
  static const Duration _dataValidDuration = Duration(minutes: 10);

  /**
   * 78. 對應 9.1：快取統計數據
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 快取統計數據以減少重複計算
   */
  static void cacheData(String key, StatisticsData data);

  /**
   * 79. 對應 9.1：取得快取的統計數據
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 從快取中獲取統計數據
   */
  static StatisticsData? getCachedData(String key);

  /**
   * 80. 對應 9.1：檢查快取有效性
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 檢查快取數據是否仍然有效
   */
  static bool isCacheValid(String key);
}
```

---

## 10.0 測試用例定義

### 10.1 Widget測試
```dart
/**
 * 81. 對應 10.1：統計頁面Widget測試套件
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計頁面主要Widget的測試用例
 */
class StatisticsPageWidgetTest {

  /**
   * 82. 對應 10.1：測試統計頁面初始化
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試統計頁面正確初始化和渲染
   */
  void testStatisticsPageInitialization();

  /**
   * 83. 對應 10.1：測試統計數據顯示
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試統計數據正確顯示
   */
  void testStatisticsDataDisplay();

  /**
   * 84. 對應 10.1：測試圖表渲染
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試各種圖表正確渲染
   */
  void testChartRendering();

  /**
   * 85. 對應 10.1：測試篩選器功能
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試篩選器正確更新統計數據
   */
  void testFilterFunctionality();

  /**
   * 86. 對應 10.1：測試響應式佈局
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試不同螢幕尺寸下的響應式佈局
   */
  void testResponsiveLayout();
}

/**
 * 87. 對應 10.1：圖表Widget測試套件
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 圖表相關Widget的測試用例
 */
class ChartWidgetTest {

  /**
   * 88. 對應 10.1：測試圖表互動
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試圖表的點擊、縮放等互動功能
   */
  void testChartInteraction();

  /**
   * 89. 對應 10.1：測試圖表動畫
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試圖表動畫效果
   */
  void testChartAnimation();

  /**
   * 90. 對應 10.1：測試圖表數據更新
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試圖表數據更新時的重新渲染
   */
  void testChartDataUpdate();
}
```

### 10.2 整合測試
```dart
/**
 * 91. 對應 10.2：統計頁面整合測試套件
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 統計頁面與API和狀態管理的整合測試
 */
class StatisticsIntegrationTest {

  /**
   * 92. 對應 10.2：測試API整合
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試與EntryService、BudgetService等API的整合
   */
  void testAPIIntegration();

  /**
   * 93. 對應 10.2：測試狀態管理整合
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試與Riverpod狀態管理的整合
   */
  void testStateManagementIntegration();

  /**
   * 94. 對應 10.2：測試導航整合
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試與GoRouter導航的整合
   */
  void testNavigationIntegration();

  /**
   * 95. 對應 10.2：測試快取整合
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 測試數據和Widget快取的整合
   */
  void testCacheIntegration();
}
```

---

## 11.0 錯誤處理

### 11.1 異常處理策略
```dart
/**
 * 96. 對應 11.1：統計頁面異常處理器
 * @version 2025-01-27-V1.0.0
 * @date 2025-01-27 12:00:00
 * @description 處理統計頁面的各種異常情況
 */
class StatisticsErrorHandler {

  /**
   * 97. 對應 11.1：處理數據載入錯誤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理統計數據載入失敗的情況
   */
  static Widget handleDataLoadError(Object error, VoidCallback? onRetry);

  /**
   * 98. 對應 11.1：處理圖表渲染錯誤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理圖表渲染失敗的情況
   */
  static Widget handleChartRenderError(Object error, ChartType chartType);

  /**
   * 99. 對應 11.1：處理網路連線錯誤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理網路連線異常的情況
   */
  static Widget handleNetworkError(Object error, VoidCallback? onRetry);

  /**
   * 100. 對應 11.1：處理數據格式錯誤
   * @version 2025-01-27-V1.0.0
   * @date 2025-01-27 12:00:00
   * @description 處理API回傳數據格式不正確的情況
   */
  static void handleDataFormatError(Object error, Map<String, dynamic>? rawData);
}
```

---

## 結語

本TDD文件定義了P014統計頁面的完整測試規格，涵蓋了統計分析的核心功能、圖表視覺化、互動操作、狀態管理等各個層面。文件遵循0055設計原則，確保了代碼的一致性、可維護性和可測試性。

透過這個TDD規格，開發團隊可以系統性地實作統計頁面功能，確保每個組件都能正確運作並提供良好的使用者體驗。
