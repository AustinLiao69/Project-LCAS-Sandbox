
# TDD_P030_é ç®—è­¦ç¤ºé é¢_v1.0.0

**æ–‡ä»¶ç·¨è™Ÿ**: 8830  
**ç‰ˆæœ¬**: v1.0.0  
**å»ºç«‹æ—¥æœŸ**: 2025-01-26  
**å»ºç«‹è€…**: LCAS SA Team  
**æœ€å¾Œæ›´æ–°**: 2025-01-26 21:15:00 UTC+8

---

## ç›®æ¬¡

1. [æ¸¬è©¦æ¦‚è¿°](#10-æ¸¬è©¦æ¦‚è¿°test-overview)
2. [é é¢æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦](#20-é é¢æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦page-core-function-tests)
3. [è­¦ç¤ºç®¡ç†åŠŸèƒ½æ¸¬è©¦](#30-è­¦ç¤ºç®¡ç†åŠŸèƒ½æ¸¬è©¦alert-management-function-tests)
4. [é€šçŸ¥ç³»çµ±åŠŸèƒ½æ¸¬è©¦](#40-é€šçŸ¥ç³»çµ±åŠŸèƒ½æ¸¬è©¦notification-system-function-tests)
5. [è­¦ç¤ºè¦å‰‡è¨­å®šæ¸¬è©¦](#50-è­¦ç¤ºè¦å‰‡è¨­å®šæ¸¬è©¦alert-rules-configuration-tests)
6. [å››æ¨¡å¼å·®ç•°åŒ–æ¸¬è©¦](#60-å››æ¨¡å¼å·®ç•°åŒ–æ¸¬è©¦four-modes-differentiation-tests)
7. [APIæ•´åˆåŠŸèƒ½æ¸¬è©¦](#70-apiæ•´åˆåŠŸèƒ½æ¸¬è©¦api-integration-function-tests)
8. [ç„¡éšœç¤™åŠŸèƒ½æ¸¬è©¦](#80-ç„¡éšœç¤™åŠŸèƒ½æ¸¬è©¦accessibility-function-tests)

---

## 1.0 æ¸¬è©¦æ¦‚è¿°ï¼ˆTest Overviewï¼‰

### 1.1 æ¸¬è©¦ç›®æ¨™
å°æ‡‰P030_é ç®—è­¦ç¤ºé é¢_SRS.mdè¦æ ¼ï¼Œæ¸¬è©¦å®Œæ•´çš„é ç®—è­¦ç¤ºè¨­å®šå’Œç®¡ç†åŠŸèƒ½ï¼ŒåŒ…å«å¤šå±¤ç´šè­¦ç¤ºæ©Ÿåˆ¶ã€æ™ºæ…§é–¾å€¼è¨­å®šã€å€‹äººåŒ–é€šçŸ¥åå¥½ï¼Œä»¥åŠå››ç¨®ä½¿ç”¨è€…æ¨¡å¼çš„å·®ç•°åŒ–è­¦ç¤ºé«”é©—ã€‚

### 1.2 æ¸¬è©¦ç¯„åœ
- è­¦ç¤ºè¨­å®šèˆ‡ç®¡ç†åŠŸèƒ½
- å¤šå±¤ç´šè­¦ç¤ºè§¸ç™¼æ©Ÿåˆ¶
- é€šçŸ¥ç³»çµ±èˆ‡åå¥½è¨­å®š
- æ™ºæ…§å»ºè­°åŠŸèƒ½
- å››æ¨¡å¼å·®ç•°åŒ–ç•Œé¢
- BudgetService APIæ•´åˆ
- ä½¿ç”¨è€…é«”é©—èˆ‡ç„¡éšœç¤™åŠŸèƒ½

---

## 2.0 é é¢æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦ï¼ˆPage Core Function Testsï¼‰

### 2.1 é é¢åˆå§‹åŒ–æ¸¬è©¦

#### 2.1.1 PreBudgetAlertPageWidgetæ¸¬è©¦
```dart
/**
 * 01. å°æ‡‰ 2.1ï¼šé ç®—è­¦ç¤ºé é¢åˆå§‹åŒ–Widget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦é ç®—è­¦ç¤ºé é¢çš„åˆå§‹åŒ–å’ŒåŸºæœ¬æ¸²æŸ“åŠŸèƒ½
 */
class PreBudgetAlertPageWidget extends StatefulWidget {
  final String? budgetId;
  final UserMode userMode;
  final BudgetAlertSettings? existingSettings;
  
  const PreBudgetAlertPageWidget({
    Key? key,
    this.budgetId,
    required this.userMode,
    this.existingSettings,
  }) : super(key: key);

  @override
  State<PreBudgetAlertPageWidget> createState() => _PreBudgetAlertPageWidgetState();
}

class _PreBudgetAlertPageWidgetState extends State<PreBudgetAlertPageWidget> {
  final GlobalKey<FormState> _formKey = GlobalKey<FormState>();
  final BudgetAlertController _controller = BudgetAlertController();
  
  @override
  void initState() {
    super.initState();
    _initializePage();
  }

  /**
   * 02. å°æ‡‰ 2.1ï¼šåˆå§‹åŒ–é é¢æ•¸æ“š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è¼‰å…¥ç¾æœ‰è­¦ç¤ºè¨­å®šå’Œé ç®—è³‡æ–™
   */
  Future<void> _initializePage() async {
    await _controller.loadBudgetData(widget.budgetId);
    await _controller.loadExistingAlerts(widget.budgetId);
    if (widget.existingSettings != null) {
      _controller.applySettings(widget.existingSettings!);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: _buildAppBar(context),
      body: _buildBody(context),
      floatingActionButton: _buildFloatingActionButton(context),
    );
  }

  /**
   * 03. å°æ‡‰ 2.1ï¼šå»ºæ§‹æ‡‰ç”¨ç¨‹å¼é ‚éƒ¨æ¬„
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šå››æ¨¡å¼å·®ç•°åŒ–é¡¯ç¤ºä¸åŒæ¨£å¼çš„é ‚éƒ¨æ¬„
   */
  PreferredSizeWidget _buildAppBar(BuildContext context);

  /**
   * 04. å°æ‡‰ 2.1ï¼šå»ºæ§‹é é¢ä¸»é«”å…§å®¹
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šä½¿ç”¨è€…æ¨¡å¼æ¸²æŸ“ç›¸æ‡‰çš„è­¦ç¤ºè¨­å®šç•Œé¢
   */
  Widget _buildBody(BuildContext context);

  /**
   * 05. å°æ‡‰ 2.1ï¼šå»ºæ§‹æµ®å‹•æ“ä½œæŒ‰éˆ•
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›å¿«é€Ÿå­˜å–åŠŸèƒ½çš„æµ®å‹•æŒ‰éˆ•
   */
  Widget? _buildFloatingActionButton(BuildContext context);
}
```

### 2.2 é é¢ç‹€æ…‹ç®¡ç†æ¸¬è©¦

#### 2.2.1 BudgetAlertControlleræ¸¬è©¦
```dart
/**
 * 06. å°æ‡‰ 2.2ï¼šé ç®—è­¦ç¤ºé é¢æ§åˆ¶å™¨
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description ç®¡ç†é ç®—è­¦ç¤ºé é¢çš„ç‹€æ…‹å’Œæ¥­å‹™é‚è¼¯
 */
class BudgetAlertController extends ChangeNotifier {
  final BudgetService _budgetService = BudgetService();
  final NotificationService _notificationService = NotificationService();
  
  BudgetAlertPageState _pageState = BudgetAlertPageState();
  BudgetAlertPageState get pageState => _pageState;
  
  bool _isLoading = false;
  bool get isLoading => _isLoading;
  
  String? _error;
  String? get error => _error;

  /**
   * 07. å°æ‡‰ 2.2ï¼šè¼‰å…¥é ç®—è³‡æ–™
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å¾BudgetServiceè¼‰å…¥ç‰¹å®šé ç®—çš„è³‡æ–™
   */
  Future<void> loadBudgetData(String? budgetId) async {
    if (budgetId == null) return;
    
    _setLoading(true);
    try {
      final budgetData = await _budgetService.getBudgetById(budgetId);
      _pageState = _pageState.copyWith(budgetData: budgetData);
      notifyListeners();
    } catch (e) {
      _setError('è¼‰å…¥é ç®—è³‡æ–™å¤±æ•—: ${e.toString()}');
    } finally {
      _setLoading(false);
    }
  }

  /**
   * 08. å°æ‡‰ 2.2ï¼šè¼‰å…¥ç¾æœ‰è­¦ç¤ºè¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è¼‰å…¥å·²è¨­å®šçš„é ç®—è­¦ç¤ºè¦å‰‡
   */
  Future<void> loadExistingAlerts(String? budgetId) async {
    if (budgetId == null) return;
    
    try {
      final alerts = await _budgetService.getBudgetAlerts(budgetId);
      _pageState = _pageState.copyWith(existingAlerts: alerts);
      notifyListeners();
    } catch (e) {
      _setError('è¼‰å…¥è­¦ç¤ºè¨­å®šå¤±æ•—: ${e.toString()}');
    }
  }

  /**
   * 09. å°æ‡‰ 2.2ï¼šå„²å­˜è­¦ç¤ºè¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å°‡è­¦ç¤ºè¨­å®šå„²å­˜è‡³å¾Œç«¯
   */
  Future<bool> saveAlertSettings(BudgetAlertRequest request) async {
    _setLoading(true);
    try {
      final response = await _budgetService.setBudgetAlerts(request);
      if (response.success) {
        _pageState = _pageState.copyWith(
          isSaved: true,
          lastSaveTime: DateTime.now(),
        );
        notifyListeners();
        return true;
      }
      return false;
    } catch (e) {
      _setError('å„²å­˜è­¦ç¤ºè¨­å®šå¤±æ•—: ${e.toString()}');
      return false;
    } finally {
      _setLoading(false);
    }
  }

  void _setLoading(bool loading) {
    _isLoading = loading;
    notifyListeners();
  }

  void _setError(String error) {
    _error = error;
    notifyListeners();
  }
}

/**
 * 10. å°æ‡‰ 2.2ï¼šé ç®—è­¦ç¤ºé é¢ç‹€æ…‹æ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description å°è£é ç®—è­¦ç¤ºé é¢çš„æ‰€æœ‰ç‹€æ…‹æ•¸æ“š
 */
class BudgetAlertPageState {
  final BudgetModel? budgetData;
  final List<AlertRule> existingAlerts;
  final List<AlertRule> pendingAlerts;
  final BudgetAlertSettings currentSettings;
  final bool isEnabled;
  final bool isSaved;
  final DateTime? lastSaveTime;
  final List<SmartSuggestion> suggestions;
  
  const BudgetAlertPageState({
    this.budgetData,
    this.existingAlerts = const [],
    this.pendingAlerts = const [],
    this.currentSettings = const BudgetAlertSettings(),
    this.isEnabled = false,
    this.isSaved = false,
    this.lastSaveTime,
    this.suggestions = const [],
  });

  BudgetAlertPageState copyWith({
    BudgetModel? budgetData,
    List<AlertRule>? existingAlerts,
    List<AlertRule>? pendingAlerts,
    BudgetAlertSettings? currentSettings,
    bool? isEnabled,
    bool? isSaved,
    DateTime? lastSaveTime,
    List<SmartSuggestion>? suggestions,
  }) {
    return BudgetAlertPageState(
      budgetData: budgetData ?? this.budgetData,
      existingAlerts: existingAlerts ?? this.existingAlerts,
      pendingAlerts: pendingAlerts ?? this.pendingAlerts,
      currentSettings: currentSettings ?? this.currentSettings,
      isEnabled: isEnabled ?? this.isEnabled,
      isSaved: isSaved ?? this.isSaved,
      lastSaveTime: lastSaveTime ?? this.lastSaveTime,
      suggestions: suggestions ?? this.suggestions,
    );
  }
}
```

---

## 3.0 è­¦ç¤ºç®¡ç†åŠŸèƒ½æ¸¬è©¦ï¼ˆAlert Management Function Testsï¼‰

### 3.1 è­¦ç¤ºç¸½é–‹é—œæ¸¬è©¦

#### 3.1.1 AlertMasterSwitchWidgetæ¸¬è©¦
```dart
/**
 * 11. å°æ‡‰ 3.1ï¼šè­¦ç¤ºç¸½é–‹é—œWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦é ç®—è­¦ç¤ºçš„ä¸»è¦å•Ÿç”¨/åœç”¨é–‹é—œåŠŸèƒ½
 */
class AlertMasterSwitchWidget extends StatelessWidget {
  final bool isEnabled;
  final ValueChanged<bool> onChanged;
  final UserMode userMode;
  final BudgetModel? budgetData;
  
  const AlertMasterSwitchWidget({
    Key? key,
    required this.isEnabled,
    required this.onChanged,
    required this.userMode,
    this.budgetData,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(20.0),
      decoration: _buildContainerDecoration(),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildHeader(context),
          const SizedBox(height: 16.0),
          _buildSwitchRow(context),
          if (isEnabled) ...[
            const SizedBox(height: 16.0),
            _buildCurrentStatus(context),
          ],
        ],
      ),
    );
  }

  /**
   * 12. å°æ‡‰ 3.1ï¼šå»ºæ§‹ç¸½é–‹é—œæ¨™é¡Œå€åŸŸ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºè­¦ç¤ºåŠŸèƒ½çš„æ¨™é¡Œå’Œèªªæ˜
   */
  Widget _buildHeader(BuildContext context);

  /**
   * 13. å°æ‡‰ 3.1ï¼šå»ºæ§‹é–‹é—œæ§åˆ¶è¡Œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå•Ÿç”¨/åœç”¨é–‹é—œå’Œç›¸é—œæ–‡å­—
   */
  Widget _buildSwitchRow(BuildContext context);

  /**
   * 14. å°æ‡‰ 3.1ï¼šå»ºæ§‹ç•¶å‰è­¦ç¤ºç‹€æ…‹
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºç›®å‰çš„è­¦ç¤ºå•Ÿç”¨ç‹€æ…‹å’Œçµ±è¨ˆè³‡è¨Š
   */
  Widget _buildCurrentStatus(BuildContext context);

  /**
   * 15. å°æ‡‰ 3.1ï¼šå–å¾—å®¹å™¨è£é£¾æ¨£å¼
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šä½¿ç”¨è€…æ¨¡å¼è¿”å›ä¸åŒçš„å®¹å™¨è£é£¾æ¨£å¼
   */
  BoxDecoration _buildContainerDecoration();
}
```

### 3.2 é–¾å€¼è¨­å®šæ¸¬è©¦

#### 3.2.1 ThresholdSettingsWidgetæ¸¬è©¦
```dart
/**
 * 16. å°æ‡‰ 3.2ï¼šé–¾å€¼è¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦å¤šå±¤ç´šè­¦ç¤ºé–¾å€¼çš„è¨­å®šåŠŸèƒ½
 */
class ThresholdSettingsWidget extends StatefulWidget {
  final ThresholdSettings initialSettings;
  final ValueChanged<ThresholdSettings> onChanged;
  final UserMode userMode;
  final BudgetModel? budgetData;
  
  const ThresholdSettingsWidget({
    Key? key,
    required this.initialSettings,
    required this.onChanged,
    required this.userMode,
    this.budgetData,
  }) : super(key: key);

  @override
  State<ThresholdSettingsWidget> createState() => _ThresholdSettingsWidgetState();
}

class _ThresholdSettingsWidgetState extends State<ThresholdSettingsWidget> {
  late ThresholdSettings _settings;
  late List<ThresholdSliderController> _sliderControllers;

  @override
  void initState() {
    super.initState();
    _settings = widget.initialSettings;
    _initializeSliders();
  }

  /**
   * 17. å°æ‡‰ 3.2ï¼šåˆå§‹åŒ–é–¾å€¼æ»‘æ¡¿æ§åˆ¶å™¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å»ºç«‹å¤šå€‹é–¾å€¼æ»‘æ¡¿çš„æ§åˆ¶å™¨
   */
  void _initializeSliders() {
    _sliderControllers = [
      ThresholdSliderController(
        type: AlertType.reminder,
        initialValue: _settings.reminderThreshold,
        onChanged: _handleReminderThresholdChanged,
      ),
      ThresholdSliderController(
        type: AlertType.warning,
        initialValue: _settings.warningThreshold,
        onChanged: _handleWarningThresholdChanged,
      ),
      ThresholdSliderController(
        type: AlertType.critical,
        initialValue: _settings.criticalThreshold,
        onChanged: _handleCriticalThresholdChanged,
      ),
    ];
  }

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 2.0,
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionHeader(context),
            const SizedBox(height: 20.0),
            _buildThresholdModeSelector(context),
            const SizedBox(height: 20.0),
            _buildThresholdSliders(context),
            const SizedBox(height: 20.0),
            _buildPreviewChart(context),
          ],
        ),
      ),
    );
  }

  /**
   * 18. å°æ‡‰ 3.2ï¼šå»ºæ§‹é–¾å€¼æ¨¡å¼é¸æ“‡å™¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¸æ“‡ç™¾åˆ†æ¯”æˆ–çµ•å°é‡‘é¡æ¨¡å¼
   */
  Widget _buildThresholdModeSelector(BuildContext context);

  /**
   * 19. å°æ‡‰ 3.2ï¼šå»ºæ§‹é–¾å€¼æ»‘æ¡¿çµ„
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºæé†’ã€è­¦å‘Šã€åš´é‡ä¸‰å€‹ç´šåˆ¥çš„é–¾å€¼æ»‘æ¡¿
   */
  Widget _buildThresholdSliders(BuildContext context);

  /**
   * 20. å°æ‡‰ 3.2ï¼šå»ºæ§‹é è¦½åœ–è¡¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å³æ™‚é è¦½é–¾å€¼è¨­å®šæ•ˆæœçš„åœ–è¡¨
   */
  Widget _buildPreviewChart(BuildContext context);

  /**
   * 21. å°æ‡‰ 3.2ï¼šè™•ç†æé†’é–¾å€¼è®Šæ›´
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è™•ç†æé†’ç´šåˆ¥é–¾å€¼çš„è®Šæ›´äº‹ä»¶
   */
  void _handleReminderThresholdChanged(double value);

  /**
   * 22. å°æ‡‰ 3.2ï¼šè™•ç†è­¦å‘Šé–¾å€¼è®Šæ›´
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è™•ç†è­¦å‘Šç´šåˆ¥é–¾å€¼çš„è®Šæ›´äº‹ä»¶
   */
  void _handleWarningThresholdChanged(double value);

  /**
   * 23. å°æ‡‰ 3.2ï¼šè™•ç†åš´é‡é–¾å€¼è®Šæ›´
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è™•ç†åš´é‡ç´šåˆ¥é–¾å€¼çš„è®Šæ›´äº‹ä»¶
   */
  void _handleCriticalThresholdChanged(double value);
}

/**
 * 24. å°æ‡‰ 3.2ï¼šé–¾å€¼æ»‘æ¡¿æ§åˆ¶å™¨
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description ç®¡ç†å–®å€‹é–¾å€¼æ»‘æ¡¿çš„ç‹€æ…‹å’Œé‚è¼¯
 */
class ThresholdSliderController {
  final AlertType type;
  double _value;
  final ValueChanged<double> onChanged;
  
  ThresholdSliderController({
    required this.type,
    required double initialValue,
    required this.onChanged,
  }) : _value = initialValue;

  double get value => _value;
  
  set value(double newValue) {
    _value = newValue.clamp(getMinValue(), getMaxValue());
    onChanged(_value);
  }

  /**
   * 25. å°æ‡‰ 3.2ï¼šå–å¾—æœ€å°å€¼
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šè­¦ç¤ºé¡å‹è¿”å›é©ç•¶çš„æœ€å°é–¾å€¼
   */
  double getMinValue() {
    switch (type) {
      case AlertType.reminder:
        return 30.0;
      case AlertType.warning:
        return 60.0;
      case AlertType.critical:
        return 80.0;
    }
  }

  /**
   * 26. å°æ‡‰ 3.2ï¼šå–å¾—æœ€å¤§å€¼
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šè­¦ç¤ºé¡å‹è¿”å›é©ç•¶çš„æœ€å¤§é–¾å€¼
   */
  double getMaxValue() {
    switch (type) {
      case AlertType.reminder:
        return 70.0;
      case AlertType.warning:
        return 90.0;
      case AlertType.critical:
        return 100.0;
    }
  }
}
```

---

## 4.0 é€šçŸ¥ç³»çµ±åŠŸèƒ½æ¸¬è©¦ï¼ˆNotification System Function Testsï¼‰

### 4.1 é€šçŸ¥æ–¹å¼è¨­å®šæ¸¬è©¦

#### 4.1.1 NotificationMethodsWidgetæ¸¬è©¦
```dart
/**
 * 27. å°æ‡‰ 4.1ï¼šé€šçŸ¥æ–¹å¼è¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦å¤šç¨®é€šçŸ¥æ–¹å¼çš„é¸æ“‡å’Œè¨­å®šåŠŸèƒ½
 */
class NotificationMethodsWidget extends StatefulWidget {
  final List<NotificationMethod> selectedMethods;
  final ValueChanged<List<NotificationMethod>> onChanged;
  final UserMode userMode;
  
  const NotificationMethodsWidget({
    Key? key,
    required this.selectedMethods,
    required this.onChanged,
    required this.userMode,
  }) : super(key: key);

  @override
  State<NotificationMethodsWidget> createState() => _NotificationMethodsWidgetState();
}

class _NotificationMethodsWidgetState extends State<NotificationMethodsWidget> {
  late List<NotificationMethod> _selectedMethods;
  final Map<NotificationMethod, bool> _methodAvailability = {};

  @override
  void initState() {
    super.initState();
    _selectedMethods = List.from(widget.selectedMethods);
    _checkMethodAvailability();
  }

  /**
   * 28. å°æ‡‰ 4.1ï¼šæª¢æŸ¥é€šçŸ¥æ–¹å¼å¯ç”¨æ€§
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æª¢æŸ¥å„ç¨®é€šçŸ¥æ–¹å¼æ˜¯å¦å¯ç”¨
   */
  Future<void> _checkMethodAvailability() async {
    for (final method in NotificationMethod.values) {
      _methodAvailability[method] = await _isMethodAvailable(method);
    }
    setState(() {});
  }

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionHeader(context),
            const SizedBox(height: 16.0),
            _buildMethodGrid(context),
            const SizedBox(height: 16.0),
            _buildFrequencySettings(context),
            const SizedBox(height: 16.0),
            _buildQuietHoursSettings(context),
            const SizedBox(height: 16.0),
            _buildTestNotificationButton(context),
          ],
        ),
      ),
    );
  }

  /**
   * 29. å°æ‡‰ 4.1ï¼šå»ºæ§‹é€šçŸ¥æ–¹å¼ç¶²æ ¼
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå¯é¸çš„é€šçŸ¥æ–¹å¼é¸é …ç¶²æ ¼
   */
  Widget _buildMethodGrid(BuildContext context) {
    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: _getCrossAxisCount(),
        crossAxisSpacing: 12.0,
        mainAxisSpacing: 12.0,
        childAspectRatio: 1.2,
      ),
      itemCount: NotificationMethod.values.length,
      itemBuilder: (context, index) {
        final method = NotificationMethod.values[index];
        final isSelected = _selectedMethods.contains(method);
        final isAvailable = _methodAvailability[method] ?? false;
        
        return _buildMethodCard(context, method, isSelected, isAvailable);
      },
    );
  }

  /**
   * 30. å°æ‡‰ 4.1ï¼šå»ºæ§‹å–®å€‹é€šçŸ¥æ–¹å¼å¡ç‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å»ºæ§‹å–®ä¸€é€šçŸ¥æ–¹å¼çš„é¸æ“‡å¡ç‰‡
   */
  Widget _buildMethodCard(
    BuildContext context,
    NotificationMethod method,
    bool isSelected,
    bool isAvailable,
  );

  /**
   * 31. å°æ‡‰ 4.1ï¼šå»ºæ§‹é€šçŸ¥é »ç‡è¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è¨­å®šé€šçŸ¥çš„é »ç‡é¸é …
   */
  Widget _buildFrequencySettings(BuildContext context);

  /**
   * 32. å°æ‡‰ 4.1ï¼šå»ºæ§‹å‹¿æ“¾æ™‚æ®µè¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è¨­å®šå…æ‰“æ“¾çš„æ™‚é–“ç¯„åœ
   */
  Widget _buildQuietHoursSettings(BuildContext context);

  /**
   * 33. å°æ‡‰ 4.1ï¼šå»ºæ§‹æ¸¬è©¦é€šçŸ¥æŒ‰éˆ•
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›æ¸¬è©¦é€šçŸ¥åŠŸèƒ½çš„æŒ‰éˆ•
   */
  Widget _buildTestNotificationButton(BuildContext context);

  /**
   * 34. å°æ‡‰ 4.1ï¼šæª¢æŸ¥é€šçŸ¥æ–¹å¼æ˜¯å¦å¯ç”¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æª¢æŸ¥ç‰¹å®šé€šçŸ¥æ–¹å¼æ˜¯å¦åœ¨ç•¶å‰ç’°å¢ƒä¸­å¯ç”¨
   */
  Future<bool> _isMethodAvailable(NotificationMethod method) async {
    switch (method) {
      case NotificationMethod.push:
        return await _checkPushNotificationPermission();
      case NotificationMethod.line:
        return await _checkLineIntegration();
      case NotificationMethod.email:
        return await _checkEmailConfiguration();
      case NotificationMethod.sms:
        return await _checkSmsCapability();
    }
  }

  /**
   * 35. å°æ‡‰ 4.1ï¼šå–å¾—ç¶²æ ¼è¡Œæ•¸
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šä½¿ç”¨è€…æ¨¡å¼æ±ºå®šé€šçŸ¥æ–¹å¼ç¶²æ ¼çš„è¡Œæ•¸
   */
  int _getCrossAxisCount() {
    switch (widget.userMode) {
      case UserMode.controller:
        return 4;
      case UserMode.logger:
        return 3;
      case UserMode.struggler:
        return 2;
      case UserMode.sleeper:
        return 2;
    }
  }

  Future<bool> _checkPushNotificationPermission() async {
    // å¯¦ä½œæ¨æ’­é€šçŸ¥æ¬Šé™æª¢æŸ¥
    return true;
  }

  Future<bool> _checkLineIntegration() async {
    // å¯¦ä½œLINEæ•´åˆæª¢æŸ¥
    return true;
  }

  Future<bool> _checkEmailConfiguration() async {
    // å¯¦ä½œEmailè¨­å®šæª¢æŸ¥
    return true;
  }

  Future<bool> _checkSmsCapability() async {
    // å¯¦ä½œSMSåŠŸèƒ½æª¢æŸ¥
    return false; // é€šå¸¸APPä¸æ”¯æ´SMS
  }
}
```

### 4.2 è¨Šæ¯ç¯„æœ¬è¨­å®šæ¸¬è©¦

#### 4.2.1 MessageTemplateWidgetæ¸¬è©¦
```dart
/**
 * 36. å°æ‡‰ 4.2ï¼šè¨Šæ¯ç¯„æœ¬è¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦è­¦ç¤ºé€šçŸ¥çš„è¨Šæ¯ç¯„æœ¬è‡ªè¨‚åŠŸèƒ½
 */
class MessageTemplateWidget extends StatefulWidget {
  final MessageTemplate initialTemplate;
  final ValueChanged<MessageTemplate> onChanged;
  final UserMode userMode;
  
  const MessageTemplateWidget({
    Key? key,
    required this.initialTemplate,
    required this.onChanged,
    required this.userMode,
  }) : super(key: key);

  @override
  State<MessageTemplateWidget> createState() => _MessageTemplateWidgetState();
}

class _MessageTemplateWidgetState extends State<MessageTemplateWidget> {
  late TextEditingController _reminderController;
  late TextEditingController _warningController;
  late TextEditingController _criticalController;
  final Map<AlertType, String> _templates = {};
  final List<TemplateVariable> _availableVariables = [
    TemplateVariable('budgetName', 'é ç®—åç¨±'),
    TemplateVariable('currentAmount', 'ç›®å‰é‡‘é¡'),
    TemplateVariable('budgetLimit', 'é ç®—ä¸Šé™'),
    TemplateVariable('usagePercentage', 'ä½¿ç”¨ç™¾åˆ†æ¯”'),
    TemplateVariable('remainingAmount', 'å‰©é¤˜é‡‘é¡'),
    TemplateVariable('remainingDays', 'å‰©é¤˜å¤©æ•¸'),
  ];

  @override
  void initState() {
    super.initState();
    _initializeControllers();
  }

  /**
   * 37. å°æ‡‰ 4.2ï¼šåˆå§‹åŒ–æ–‡å­—æ§åˆ¶å™¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description åˆå§‹åŒ–å„å€‹è­¦ç¤ºç´šåˆ¥çš„è¨Šæ¯ç¯„æœ¬æ§åˆ¶å™¨
   */
  void _initializeControllers() {
    _reminderController = TextEditingController(
      text: widget.initialTemplate.reminderMessage ?? '',
    );
    _warningController = TextEditingController(
      text: widget.initialTemplate.warningMessage ?? '',
    );
    _criticalController = TextEditingController(
      text: widget.initialTemplate.criticalMessage ?? '',
    );
    
    _reminderController.addListener(() => _updateTemplate());
    _warningController.addListener(() => _updateTemplate());
    _criticalController.addListener(() => _updateTemplate());
  }

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionHeader(context),
            const SizedBox(height: 16.0),
            _buildTemplateEditor(AlertType.reminder, _reminderController),
            const SizedBox(height: 12.0),
            _buildTemplateEditor(AlertType.warning, _warningController),
            const SizedBox(height: 12.0),
            _buildTemplateEditor(AlertType.critical, _criticalController),
            const SizedBox(height: 16.0),
            _buildVariableHelper(context),
            const SizedBox(height: 16.0),
            _buildPreviewArea(context),
          ],
        ),
      ),
    );
  }

  /**
   * 38. å°æ‡‰ 4.2ï¼šå»ºæ§‹ç¯„æœ¬ç·¨è¼¯å™¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å»ºæ§‹ç‰¹å®šè­¦ç¤ºé¡å‹çš„è¨Šæ¯ç¯„æœ¬ç·¨è¼¯å™¨
   */
  Widget _buildTemplateEditor(AlertType alertType, TextEditingController controller) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          _getAlertTypeLabel(alertType),
          style: Theme.of(context).textTheme.titleSmall?.copyWith(
            fontWeight: FontWeight.w600,
          ),
        ),
        const SizedBox(height: 8.0),
        TextField(
          controller: controller,
          maxLines: 3,
          maxLength: 200,
          decoration: InputDecoration(
            hintText: _getDefaultTemplate(alertType),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8.0),
            ),
            contentPadding: EdgeInsets.all(12.0),
          ),
        ),
      ],
    );
  }

  /**
   * 39. å°æ‡‰ 4.2ï¼šå»ºæ§‹è®Šæ•¸è¼”åŠ©å€åŸŸ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå¯ç”¨çš„ç¯„æœ¬è®Šæ•¸å’Œæ’å…¥æŒ‰éˆ•
   */
  Widget _buildVariableHelper(BuildContext context) {
    return ExpansionTile(
      title: Text('å¯ç”¨è®Šæ•¸'),
      children: [
        Wrap(
          spacing: 8.0,
          runSpacing: 8.0,
          children: _availableVariables.map((variable) {
            return ActionChip(
              label: Text(variable.description),
              onPressed: () => _insertVariable(variable),
            );
          }).toList(),
        ),
      ],
    );
  }

  /**
   * 40. å°æ‡‰ 4.2ï¼šå»ºæ§‹é è¦½å€åŸŸ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å³æ™‚é è¦½ç¯„æœ¬æ•ˆæœ
   */
  Widget _buildPreviewArea(BuildContext context);

  /**
   * 41. å°æ‡‰ 4.2ï¼šæ’å…¥ç¯„æœ¬è®Šæ•¸
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å°‡é¸ä¸­çš„è®Šæ•¸æ’å…¥åˆ°ç•¶å‰ç„¦é»çš„æ–‡å­—æ¡†ä¸­
   */
  void _insertVariable(TemplateVariable variable);

  /**
   * 42. å°æ‡‰ 4.2ï¼šæ›´æ–°ç¯„æœ¬
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç•¶ä»»ä½•ç¯„æœ¬å…§å®¹è®Šæ›´æ™‚æ›´æ–°æ•´é«”ç¯„æœ¬
   */
  void _updateTemplate();

  String _getAlertTypeLabel(AlertType type) {
    switch (type) {
      case AlertType.reminder:
        return 'æé†’è¨Šæ¯';
      case AlertType.warning:
        return 'è­¦å‘Šè¨Šæ¯';
      case AlertType.critical:
        return 'åš´é‡è­¦ç¤ºè¨Šæ¯';
    }
  }

  String _getDefaultTemplate(AlertType type) {
    switch (type) {
      case AlertType.reminder:
        return 'âš ï¸ é ç®—æé†’ï¼šæ‚¨çš„ {budgetName} å·²ä½¿ç”¨ {usagePercentage}%';
      case AlertType.warning:
        return 'ğŸš¨ é ç®—è­¦å‘Šï¼š{budgetName} ä½¿ç”¨ç‡é” {usagePercentage}%ï¼Œè«‹æ³¨æ„æ”¯å‡º';
      case AlertType.critical:
        return 'âŒ ç·Šæ€¥è­¦ç¤ºï¼š{budgetName} å³å°‡è¶…æ”¯ï¼ç›®å‰ä½¿ç”¨ {usagePercentage}%';
    }
  }
}

/**
 * 43. å°æ‡‰ 4.2ï¼šç¯„æœ¬è®Šæ•¸æ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description å®šç¾©è¨Šæ¯ç¯„æœ¬ä¸­å¯ç”¨çš„è®Šæ•¸
 */
class TemplateVariable {
  final String key;
  final String description;
  
  const TemplateVariable(this.key, this.description);
  
  String get placeholder => '{$key}';
}
```

---

## 5.0 è­¦ç¤ºè¦å‰‡è¨­å®šæ¸¬è©¦ï¼ˆAlert Rules Configuration Testsï¼‰

### 5.1 é€²éšè¦å‰‡è¨­å®šæ¸¬è©¦

#### 5.1.1 AdvancedRulesWidgetæ¸¬è©¦
```dart
/**
 * 44. å°æ‡‰ 5.1ï¼šé€²éšè­¦ç¤ºè¦å‰‡è¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦è¤‡é›œæ¢ä»¶çš„è­¦ç¤ºè¦å‰‡è¨­å®šåŠŸèƒ½ï¼ˆåƒ…ç²¾æº–æ§åˆ¶è€…æ¨¡å¼ï¼‰
 */
class AdvancedRulesWidget extends StatefulWidget {
  final List<ConditionalRule> initialRules;
  final ValueChanged<List<ConditionalRule>> onChanged;
  final UserMode userMode;
  
  const AdvancedRulesWidget({
    Key? key,
    required this.initialRules,
    required this.onChanged,
    required this.userMode,
  }) : super(key: key);

  @override
  State<AdvancedRulesWidget> createState() => _AdvancedRulesWidgetState();
}

class _AdvancedRulesWidgetState extends State<AdvancedRulesWidget> {
  late List<ConditionalRule> _rules;
  final List<RuleCondition> _availableConditions = [
    RuleCondition('usage_percentage', 'ä½¿ç”¨ç™¾åˆ†æ¯”'),
    RuleCondition('daily_average', 'æ—¥å¹³å‡èŠ±è²»'),
    RuleCondition('weekly_trend', 'é€±è¶¨å‹¢è®ŠåŒ–'),
    RuleCondition('remaining_days', 'å‰©é¤˜å¤©æ•¸'),
    RuleCondition('time_of_day', 'æ™‚æ®µæ¢ä»¶'),
    RuleCondition('day_of_week', 'æ˜ŸæœŸæ¢ä»¶'),
    RuleCondition('category_spending', 'åˆ†é¡æ”¯å‡º'),
  ];

  @override
  void initState() {
    super.initState();
    _rules = List.from(widget.initialRules);
  }

  @override
  Widget build(BuildContext context) {
    // åªæœ‰ç²¾æº–æ§åˆ¶è€…æ¨¡å¼æ‰é¡¯ç¤ºé€²éšè¦å‰‡
    if (widget.userMode != UserMode.controller) {
      return const SizedBox.shrink();
    }

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionHeader(context),
            const SizedBox(height: 16.0),
            _buildRulesList(context),
            const SizedBox(height: 16.0),
            _buildAddRuleButton(context),
            const SizedBox(height: 16.0),
            _buildRulePreview(context),
          ],
        ),
      ),
    );
  }

  /**
   * 45. å°æ‡‰ 5.1ï¼šå»ºæ§‹è¦å‰‡åˆ—è¡¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå·²å»ºç«‹çš„æ¢ä»¶è¦å‰‡åˆ—è¡¨
   */
  Widget _buildRulesList(BuildContext context) {
    if (_rules.isEmpty) {
      return _buildEmptyRulesState(context);
    }

    return ListView.separated(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _rules.length,
      separatorBuilder: (context, index) => const SizedBox(height: 8.0),
      itemBuilder: (context, index) {
        final rule = _rules[index];
        return _buildRuleCard(context, rule, index);
      },
    );
  }

  /**
   * 46. å°æ‡‰ 5.1ï¼šå»ºæ§‹è¦å‰‡å¡ç‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå–®å€‹æ¢ä»¶è¦å‰‡çš„è¨­å®šå¡ç‰‡
   */
  Widget _buildRuleCard(BuildContext context, ConditionalRule rule, int index) {
    return Card(
      elevation: 1.0,
      child: Padding(
        padding: EdgeInsets.all(12.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Expanded(
                  child: Text(
                    'è¦å‰‡ ${index + 1}',
                    style: Theme.of(context).textTheme.titleSmall?.copyWith(
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
                Switch(
                  value: rule.isActive,
                  onChanged: (value) => _toggleRule(index, value),
                ),
                IconButton(
                  icon: Icon(Icons.delete_outline),
                  onPressed: () => _removeRule(index),
                ),
              ],
            ),
            const SizedBox(height: 8.0),
            _buildRuleConditions(context, rule, index),
            const SizedBox(height: 8.0),
            _buildRuleActions(context, rule, index),
          ],
        ),
      ),
    );
  }

  /**
   * 47. å°æ‡‰ 5.1ï¼šå»ºæ§‹è¦å‰‡æ¢ä»¶
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå’Œç·¨è¼¯è¦å‰‡çš„è§¸ç™¼æ¢ä»¶
   */
  Widget _buildRuleConditions(BuildContext context, ConditionalRule rule, int index);

  /**
   * 48. å°æ‡‰ 5.1ï¼šå»ºæ§‹è¦å‰‡å‹•ä½œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description è¨­å®šè¦å‰‡è§¸ç™¼æ™‚çš„åŸ·è¡Œå‹•ä½œ
   */
  Widget _buildRuleActions(BuildContext context, ConditionalRule rule, int index);

  /**
   * 49. å°æ‡‰ 5.1ï¼šå»ºæ§‹æ–°å¢è¦å‰‡æŒ‰éˆ•
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›æ–°å¢æ¢ä»¶è¦å‰‡çš„æŒ‰éˆ•
   */
  Widget _buildAddRuleButton(BuildContext context);

  /**
   * 50. å°æ‡‰ 5.1ï¼šå»ºæ§‹è¦å‰‡é è¦½
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é è¦½è¦å‰‡çš„é‚è¼¯å’ŒåŸ·è¡Œæ•ˆæœ
   */
  Widget _buildRulePreview(BuildContext context);

  /**
   * 51. å°æ‡‰ 5.1ï¼šåˆ‡æ›è¦å‰‡å•Ÿç”¨ç‹€æ…‹
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å•Ÿç”¨æˆ–åœç”¨æŒ‡å®šçš„æ¢ä»¶è¦å‰‡
   */
  void _toggleRule(int index, bool isActive);

  /**
   * 52. å°æ‡‰ 5.1ï¼šç§»é™¤è¦å‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description åˆªé™¤æŒ‡å®šçš„æ¢ä»¶è¦å‰‡
   */
  void _removeRule(int index);

  /**
   * 53. å°æ‡‰ 5.1ï¼šæ–°å¢è¦å‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ–°å¢ä¸€å€‹æ–°çš„æ¢ä»¶è¦å‰‡
   */
  void _addRule();

  Widget _buildEmptyRulesState(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(32.0),
      child: Column(
        children: [
          Icon(
            Icons.rule_outlined,
            size: 48.0,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16.0),
          Text(
            'å°šæœªå»ºç«‹é€²éšè¦å‰‡',
            style: Theme.of(context).textTheme.bodyLarge?.copyWith(
              color: Colors.grey[600],
            ),
          ),
          const SizedBox(height: 8.0),
          Text(
            'é»æ“Šä¸‹æ–¹æŒ‰éˆ•å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹æ¢ä»¶è¦å‰‡',
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              color: Colors.grey[500],
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }
}

/**
 * 54. å°æ‡‰ 5.1ï¼šæ¢ä»¶è¦å‰‡æ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description å®šç¾©æ¢ä»¶è¦å‰‡çš„çµæ§‹å’Œå±¬æ€§
 */
class ConditionalRule {
  final String ruleId;
  final String name;
  final List<RuleCondition> conditions;
  final List<RuleAction> actions;
  final bool isActive;
  final RuleLogic logic; // AND, OR
  
  const ConditionalRule({
    required this.ruleId,
    required this.name,
    required this.conditions,
    required this.actions,
    this.isActive = true,
    this.logic = RuleLogic.and,
  });
}

class RuleCondition {
  final String key;
  final String description;
  final RuleOperator operator;
  final dynamic value;
  
  const RuleCondition(
    this.key,
    this.description, {
    this.operator = RuleOperator.greaterThan,
    this.value,
  });
}

enum RuleLogic { and, or }
enum RuleOperator { 
  equals, 
  greaterThan, 
  lessThan, 
  between, 
  contains,
  notEquals,
}

class RuleAction {
  final String type;
  final Map<String, dynamic> parameters;
  
  const RuleAction({
    required this.type,
    required this.parameters,
  });
}
```

### 5.2 æ™ºæ…§å»ºè­°åŠŸèƒ½æ¸¬è©¦

#### 5.2.1 SmartSuggestionsWidgetæ¸¬è©¦
```dart
/**
 * 55. å°æ‡‰ 5.2ï¼šæ™ºæ…§å»ºè­°Widget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦AIé©…å‹•çš„è­¦ç¤ºè¨­å®šå»ºè­°åŠŸèƒ½
 */
class SmartSuggestionsWidget extends StatefulWidget {
  final BudgetModel? budgetData;
  final UserSpendingPattern? spendingPattern;
  final ValueChanged<BudgetAlertSettings> onApplySuggestion;
  final UserMode userMode;
  
  const SmartSuggestionsWidget({
    Key? key,
    this.budgetData,
    this.spendingPattern,
    required this.onApplySuggestion,
    required this.userMode,
  }) : super(key: key);

  @override
  State<SmartSuggestionsWidget> createState() => _SmartSuggestionsWidgetState();
}

class _SmartSuggestionsWidgetState extends State<SmartSuggestionsWidget> {
  List<SmartSuggestion> _suggestions = [];
  bool _isLoading = false;
  String? _error;

  @override
  void initState() {
    super.initState();
    _loadSuggestions();
  }

  /**
   * 56. å°æ‡‰ 5.2ï¼šè¼‰å…¥æ™ºæ…§å»ºè­°
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å¾BudgetServiceè¼‰å…¥AIç”Ÿæˆçš„å»ºè­°
   */
  Future<void> _loadSuggestions() async {
    if (widget.budgetData == null) return;

    setState(() {
      _isLoading = true;
      _error = null;
    });

    try {
      final suggestions = await BudgetService.getSmartSuggestions(
        budgetId: widget.budgetData!.budgetId,
        userMode: widget.userMode,
        spendingPattern: widget.spendingPattern,
      );
      
      setState(() {
        _suggestions = suggestions;
      });
    } catch (e) {
      setState(() {
        _error = 'è¼‰å…¥å»ºè­°å¤±æ•—: ${e.toString()}';
      });
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionHeader(context),
            const SizedBox(height: 16.0),
            _buildContent(context),
          ],
        ),
      ),
    );
  }

  /**
   * 57. å°æ‡‰ 5.2ï¼šå»ºæ§‹å…§å®¹å€åŸŸ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ ¹æ“šè¼‰å…¥ç‹€æ…‹é¡¯ç¤ºä¸åŒçš„å…§å®¹
   */
  Widget _buildContent(BuildContext context) {
    if (_isLoading) {
      return _buildLoadingState(context);
    }
    
    if (_error != null) {
      return _buildErrorState(context);
    }
    
    if (_suggestions.isEmpty) {
      return _buildEmptyState(context);
    }
    
    return _buildSuggestionsList(context);
  }

  /**
   * 58. å°æ‡‰ 5.2ï¼šå»ºæ§‹å»ºè­°åˆ—è¡¨
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºæ™ºæ…§å»ºè­°çš„åˆ—è¡¨
   */
  Widget _buildSuggestionsList(BuildContext context) {
    return ListView.separated(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _suggestions.length,
      separatorBuilder: (context, index) => const SizedBox(height: 12.0),
      itemBuilder: (context, index) {
        final suggestion = _suggestions[index];
        return _buildSuggestionCard(context, suggestion);
      },
    );
  }

  /**
   * 59. å°æ‡‰ 5.2ï¼šå»ºæ§‹å»ºè­°å¡ç‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå–®å€‹æ™ºæ…§å»ºè­°çš„è©³ç´°å¡ç‰‡
   */
  Widget _buildSuggestionCard(BuildContext context, SmartSuggestion suggestion) {
    return Container(
      padding: EdgeInsets.all(16.0),
      decoration: BoxDecoration(
        color: _getSuggestionColor(suggestion.confidence),
        borderRadius: BorderRadius.circular(12.0),
        border: Border.all(
          color: Theme.of(context).dividerColor,
          width: 1.0,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                _getSuggestionIcon(suggestion.type),
                color: Theme.of(context).primaryColor,
              ),
              const SizedBox(width: 8.0),
              Expanded(
                child: Text(
                  suggestion.title,
                  style: Theme.of(context).textTheme.titleSmall?.copyWith(
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
              _buildConfidenceBadge(context, suggestion.confidence),
            ],
          ),
          const SizedBox(height: 8.0),
          Text(
            suggestion.description,
            style: Theme.of(context).textTheme.bodyMedium,
          ),
          const SizedBox(height: 8.0),
          _buildSuggestionDetails(context, suggestion),
          const SizedBox(height: 12.0),
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              TextButton(
                onPressed: () => _showSuggestionDetails(suggestion),
                child: Text('è©³ç´°è³‡è¨Š'),
              ),
              const SizedBox(width: 8.0),
              ElevatedButton(
                onPressed: () => _applySuggestion(suggestion),
                child: Text('å¥—ç”¨å»ºè­°'),
              ),
            ],
          ),
        ],
      ),
    );
  }

  /**
   * 60. å°æ‡‰ 5.2ï¼šå»ºæ§‹ä¿¡å¿ƒåº¦å¾½ç« 
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºAIå»ºè­°çš„ä¿¡å¿ƒåº¦è©•åˆ†
   */
  Widget _buildConfidenceBadge(BuildContext context, double confidence);

  /**
   * 61. å°æ‡‰ 5.2ï¼šå»ºæ§‹å»ºè­°è©³æƒ…
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå»ºè­°çš„å…·é«”è¨­å®šåƒæ•¸
   */
  Widget _buildSuggestionDetails(BuildContext context, SmartSuggestion suggestion);

  /**
   * 62. å°æ‡‰ 5.2ï¼šå¥—ç”¨å»ºè­°
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å°‡é¸ä¸­çš„å»ºè­°å¥—ç”¨åˆ°è­¦ç¤ºè¨­å®šä¸­
   */
  void _applySuggestion(SmartSuggestion suggestion);

  /**
   * 63. å°æ‡‰ 5.2ï¼šé¡¯ç¤ºå»ºè­°è©³æƒ…
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå»ºè­°çš„è©³ç´°èªªæ˜å’ŒåŸå› 
   */
  void _showSuggestionDetails(SmartSuggestion suggestion);

  Color _getSuggestionColor(double confidence) {
    if (confidence >= 0.8) return Colors.green.shade50;
    if (confidence >= 0.6) return Colors.orange.shade50;
    return Colors.blue.shade50;
  }

  IconData _getSuggestionIcon(SuggestionType type) {
    switch (type) {
      case SuggestionType.threshold:
        return Icons.tune;
      case SuggestionType.frequency:
        return Icons.notifications_active;
      case SuggestionType.method:
        return Icons.message;
      case SuggestionType.timing:
        return Icons.schedule;
    }
  }

  Widget _buildLoadingState(BuildContext context) {
    return Center(
      child: Column(
        children: [
          CircularProgressIndicator(),
          const SizedBox(height: 16.0),
          Text('æ­£åœ¨åˆ†ææ‚¨çš„ä½¿ç”¨æ¨¡å¼...'),
        ],
      ),
    );
  }

  Widget _buildErrorState(BuildContext context) {
    return Center(
      child: Column(
        children: [
          Icon(Icons.error_outline, size: 48.0),
          const SizedBox(height: 16.0),
          Text(_error ?? 'è¼‰å…¥å¤±æ•—'),
          const SizedBox(height: 16.0),
          ElevatedButton(
            onPressed: _loadSuggestions,
            child: Text('é‡è©¦'),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState(BuildContext context) {
    return Center(
      child: Column(
        children: [
          Icon(Icons.lightbulb_outline, size: 48.0),
          const SizedBox(height: 16.0),
          Text('ç›®å‰æ²’æœ‰æ™ºæ…§å»ºè­°'),
          const SizedBox(height: 8.0),
          Text(
            'ç•¶æ‚¨æœ‰æ›´å¤šè¨˜å¸³è³‡æ–™å¾Œï¼Œæˆ‘å€‘å°‡æä¾›å€‹äººåŒ–å»ºè­°',
            textAlign: TextAlign.center,
            style: Theme.of(context).textTheme.bodySmall,
          ),
        ],
      ),
    );
  }
}

/**
 * 64. å°æ‡‰ 5.2ï¼šæ™ºæ…§å»ºè­°æ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description å®šç¾©æ™ºæ…§å»ºè­°çš„çµæ§‹å’Œå±¬æ€§
 */
class SmartSuggestion {
  final String suggestionId;
  final String title;
  final String description;
  final SuggestionType type;
  final double confidence; // 0.0 - 1.0
  final BudgetAlertSettings suggestedSettings;
  final String reasoning;
  final List<String> benefits;
  
  const SmartSuggestion({
    required this.suggestionId,
    required this.title,
    required this.description,
    required this.type,
    required this.confidence,
    required this.suggestedSettings,
    required this.reasoning,
    this.benefits = const [],
  });
}

enum SuggestionType {
  threshold,  // é–¾å€¼å»ºè­°
  frequency,  // é »ç‡å»ºè­°
  method,     // é€šçŸ¥æ–¹å¼å»ºè­°
  timing,     // æ™‚æ©Ÿå»ºè­°
}
```

---

## 6.0 å››æ¨¡å¼å·®ç•°åŒ–æ¸¬è©¦ï¼ˆFour Modes Differentiation Testsï¼‰

### 6.1 ç²¾æº–æ§åˆ¶è€…æ¨¡å¼æ¸¬è©¦

#### 6.1.1 ControllerModeAlertWidgetæ¸¬è©¦
```dart
/**
 * 65. å°æ‡‰ 6.1ï¼šç²¾æº–æ§åˆ¶è€…æ¨¡å¼è­¦ç¤ºè¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦ç²¾æº–æ§åˆ¶è€…æ¨¡å¼çš„é«˜åº¦ç´°ç·»è­¦ç¤ºè¨­å®šç•Œé¢
 */
class ControllerModeAlertWidget extends StatelessWidget {
  final BudgetAlertController controller;
  final BudgetModel? budgetData;
  
  const ControllerModeAlertWidget({
    Key? key,
    required this.controller,
    this.budgetData,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildControllerHeader(context),
          const SizedBox(height: 20.0),
          AlertMasterSwitchWidget(
            isEnabled: controller.pageState.isEnabled,
            onChanged: controller.toggleAlerts,
            userMode: UserMode.controller,
            budgetData: budgetData,
          ),
          const SizedBox(height: 20.0),
          _buildProfessionalThresholds(context),
          const SizedBox(height: 20.0),
          _buildAdvancedNotifications(context),
          const SizedBox(height: 20.0),
          AdvancedRulesWidget(
            initialRules: controller.pageState.currentSettings.advancedRules,
            onChanged: controller.updateAdvancedRules,
            userMode: UserMode.controller,
          ),
          const SizedBox(height: 20.0),
          _buildAnalyticsIntegration(context),
          const SizedBox(height: 20.0),
          _buildAPIIntegration(context),
          const SizedBox(height: 20.0),
          _buildDiagnosticTools(context),
        ],
      ),
    );
  }

  /**
   * 66. å°æ‡‰ 6.1ï¼šå»ºæ§‹æ§åˆ¶è€…æ¨¡å¼æ¨™é¡Œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå°ˆæ¥­çš„æ¨™é¡Œå’Œç³»çµ±ç‹€æ…‹è³‡è¨Š
   */
  Widget _buildControllerHeader(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(16.0),
      decoration: BoxDecoration(
        color: Colors.blue.shade50,
        borderRadius: BorderRadius.circular(8.0),
        border: Border.all(color: Colors.blue.shade200),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.precision_manufacturing, color: Colors.blue.shade700),
              const SizedBox(width: 8.0),
              Text(
                'ç²¾æº–æ§åˆ¶è€…æ¨¡å¼',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  color: Colors.blue.shade700,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8.0),
          Text(
            'å°ˆæ¥­ç´šé ç®—è­¦ç¤ºæ§åˆ¶é¢æ¿',
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              color: Colors.blue.shade600,
            ),
          ),
          const SizedBox(height: 12.0),
          _buildSystemStatus(context),
        ],
      ),
    );
  }

  /**
   * 67. å°æ‡‰ 6.1ï¼šå»ºæ§‹å°ˆæ¥­é–¾å€¼è¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›ç²¾å¯†çš„é–¾å€¼èª¿æ•´å’Œå¤šå±¤ç´šè¨­å®š
   */
  Widget _buildProfessionalThresholds(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ç²¾å¯†é–¾å€¼æ§åˆ¶',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w600,
              ),
            ),
            const SizedBox(height: 16.0),
            _buildPrecisionSliders(context),
            const SizedBox(height: 16.0),
            _buildCustomThresholds(context),
            const SizedBox(height: 16.0),
            _buildThresholdFormulas(context),
          ],
        ),
      ),
    );
  }

  /**
   * 68. å°æ‡‰ 6.1ï¼šå»ºæ§‹é€²éšé€šçŸ¥è¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›å¤šç®¡é“ã€å¤šæ ¼å¼çš„é€šçŸ¥è¨­å®š
   */
  Widget _buildAdvancedNotifications(BuildContext context);

  /**
   * 69. å°æ‡‰ 6.1ï¼šå»ºæ§‹åˆ†ææ•´åˆ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ•´åˆæ·±åº¦åˆ†æå’Œå ±å‘ŠåŠŸèƒ½
   */
  Widget _buildAnalyticsIntegration(BuildContext context);

  /**
   * 70. å°æ‡‰ 6.1ï¼šå»ºæ§‹APIæ•´åˆ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›ç¬¬ä¸‰æ–¹APIæ•´åˆå’Œè‡ªå‹•åŒ–åŠŸèƒ½
   */
  Widget _buildAPIIntegration(BuildContext context);

  /**
   * 71. å°æ‡‰ 6.1ï¼šå»ºæ§‹è¨ºæ–·å·¥å…·
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›ç³»çµ±è¨ºæ–·å’Œæ•ˆèƒ½ç›£æ§å·¥å…·
   */
  Widget _buildDiagnosticTools(BuildContext context);

  Widget _buildSystemStatus(BuildContext context) {
    return Row(
      children: [
        _buildStatusIndicator('è­¦ç¤ºå¼•æ“', true),
        const SizedBox(width: 16.0),
        _buildStatusIndicator('é€šçŸ¥æœå‹™', true),
        const SizedBox(width: 16.0),
        _buildStatusIndicator('åˆ†ææ¨¡çµ„', true),
      ],
    );
  }

  Widget _buildStatusIndicator(String label, bool isOnline) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          width: 8.0,
          height: 8.0,
          decoration: BoxDecoration(
            color: isOnline ? Colors.green : Colors.red,
            shape: BoxShape.circle,
          ),
        ),
        const SizedBox(width: 4.0),
        Text(
          label,
          style: TextStyle(fontSize: 12.0),
        ),
      ],
    );
  }

  Widget _buildPrecisionSliders(BuildContext context) {
    return Column(
      children: [
        _buildPrecisionSlider('æé†’', 30.0, 70.0, 50.0),
        const SizedBox(height: 12.0),
        _buildPrecisionSlider('è­¦å‘Š', 60.0, 90.0, 75.0),
        const SizedBox(height: 12.0),
        _buildPrecisionSlider('åš´é‡', 80.0, 100.0, 90.0),
      ],
    );
  }

  Widget _buildPrecisionSlider(String label, double min, double max, double value) {
    return Row(
      children: [
        SizedBox(
          width: 60.0,
          child: Text(label),
        ),
        Expanded(
          child: Slider(
            min: min,
            max: max,
            value: value,
            divisions: ((max - min) * 2).round(),
            label: '${value.toStringAsFixed(1)}%',
            onChanged: (value) {},
          ),
        ),
        SizedBox(
          width: 60.0,
          child: TextFormField(
            initialValue: value.toStringAsFixed(1),
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 12.0),
            decoration: InputDecoration(
              isDense: true,
              contentPadding: EdgeInsets.all(8.0),
              suffix: Text('%', style: TextStyle(fontSize: 10.0)),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildCustomThresholds(BuildContext context) {
    return ExpansionTile(
      title: Text('è‡ªè¨‚é–¾å€¼'),
      children: [
        // è‡ªè¨‚é–¾å€¼è¨­å®šç•Œé¢
        Container(
          height: 200.0,
          child: Text('è‡ªè¨‚é–¾å€¼è¨­å®šåŠŸèƒ½'),
        ),
      ],
    );
  }

  Widget _buildThresholdFormulas(BuildContext context) {
    return ExpansionTile(
      title: Text('å‹•æ…‹å…¬å¼'),
      children: [
        // é–¾å€¼å…¬å¼ç·¨è¼¯å™¨
        Container(
          height: 150.0,
          child: Text('é–¾å€¼è¨ˆç®—å…¬å¼ç·¨è¼¯å™¨'),
        ),
      ],
    );
  }
}
```

### 6.2 æ½›åœ¨è¦ºé†’è€…æ¨¡å¼æ¸¬è©¦

#### 6.2.1 SleeperModeAlertWidgetæ¸¬è©¦
```dart
/**
 * 72. å°æ‡‰ 6.2ï¼šæ½›åœ¨è¦ºé†’è€…æ¨¡å¼è­¦ç¤ºè¨­å®šWidget
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦æ½›åœ¨è¦ºé†’è€…æ¨¡å¼çš„æ¥µç°¡æ˜“æ‡‚è­¦ç¤ºè¨­å®šç•Œé¢
 */
class SleeperModeAlertWidget extends StatelessWidget {
  final BudgetAlertController controller;
  final BudgetModel? budgetData;
  
  const SleeperModeAlertWidget({
    Key? key,
    required this.controller,
    this.budgetData,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: EdgeInsets.all(24.0),
      child: Column(
        children: [
          _buildSleeperHeader(context),
          const SizedBox(height: 32.0),
          _buildSimpleToggle(context),
          const SizedBox(height: 32.0),
          _buildSmartSetupCard(context),
          const SizedBox(height: 24.0),
          _buildBasicSettings(context),
          const SizedBox(height: 32.0),
          _buildQuickActions(context),
        ],
      ),
    );
  }

  /**
   * 73. å°æ‡‰ 6.2ï¼šå»ºæ§‹è¦ºé†’è€…æ¨¡å¼æ¨™é¡Œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå‹å–„çš„æ¨™é¡Œå’Œé¼“å‹µè¨Šæ¯
   */
  Widget _buildSleeperHeader(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(24.0),
      decoration: BoxDecoration(
        color: Colors.green.shade50,
        borderRadius: BorderRadius.circular(20.0),
      ),
      child: Column(
        children: [
          Icon(
            Icons.lightbulb_outline,
            size: 48.0,
            color: Colors.green.shade600,
          ),
          const SizedBox(height: 16.0),
          Text(
            'é ç®—æé†’è¨­å®š',
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
              color: Colors.green.shade700,
              fontWeight: FontWeight.w600,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8.0),
          Text(
            'è®“æˆ‘å€‘å¹«æ‚¨è¨­å®šç°¡å–®çš„é ç®—æé†’',
            style: Theme.of(context).textTheme.bodyLarge?.copyWith(
              color: Colors.green.shade600,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  /**
   * 74. å°æ‡‰ 6.2ï¼šå»ºæ§‹ç°¡å–®é–‹é—œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›è¶…å¤§å°ºå¯¸çš„å•Ÿç”¨é–‹é—œ
   */
  Widget _buildSimpleToggle(BuildContext context) {
    return Card(
      elevation: 2.0,
      child: Padding(
        padding: EdgeInsets.all(32.0),
        child: Column(
          children: [
            Text(
              'å•Ÿç”¨é ç®—æé†’',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.w600,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20.0),
            GestureDetector(
              onTap: () => controller.toggleAlerts(!controller.pageState.isEnabled),
              child: AnimatedContainer(
                duration: Duration(milliseconds: 300),
                width: 120.0,
                height: 60.0,
                decoration: BoxDecoration(
                  color: controller.pageState.isEnabled 
                      ? Colors.green 
                      : Colors.grey.shade300,
                  borderRadius: BorderRadius.circular(30.0),
                ),
                child: Center(
                  child: AnimatedSwitcher(
                    duration: Duration(milliseconds: 200),
                    child: Icon(
                      controller.pageState.isEnabled 
                          ? Icons.check 
                          : Icons.close,
                      key: ValueKey(controller.pageState.isEnabled),
                      color: Colors.white,
                      size: 32.0,
                    ),
                  ),
                ),
              ),
            ),
            const SizedBox(height: 16.0),
            Text(
              controller.pageState.isEnabled ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                color: controller.pageState.isEnabled 
                    ? Colors.green.shade700 
                    : Colors.grey.shade600,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  /**
   * 75. å°æ‡‰ 6.2ï¼šå»ºæ§‹æ™ºæ…§è¨­å®šå¡ç‰‡
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›ä¸€éµæ™ºæ…§è¨­å®šåŠŸèƒ½
   */
  Widget _buildSmartSetupCard(BuildContext context) {
    return Card(
      elevation: 3.0,
      child: Padding(
        padding: EdgeInsets.all(24.0),
        child: Column(
          children: [
            Icon(
              Icons.auto_awesome,
              size: 40.0,
              color: Colors.blue.shade600,
            ),
            const SizedBox(height: 16.0),
            Text(
              'æ™ºæ…§è¨­å®š',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w600,
              ),
            ),
            const SizedBox(height: 8.0),
            Text(
              'è®“ç³»çµ±æ ¹æ“šæ‚¨çš„ä½¿ç”¨ç¿’æ…£è‡ªå‹•è¨­å®šæœ€é©åˆçš„æé†’æ–¹å¼',
              style: Theme.of(context).textTheme.bodyMedium,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20.0),
            SizedBox(
              width: double.infinity,
              height: 56.0,
              child: ElevatedButton.icon(
                onPressed: _handleSmartSetup,
                icon: Icon(Icons.settings_suggest),
                label: Text(
                  'ä¸€éµæ™ºæ…§è¨­å®š',
                  style: TextStyle(fontSize: 16.0, fontWeight: FontWeight.w600),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue.shade600,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12.0),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  /**
   * 76. å°æ‡‰ 6.2ï¼šå»ºæ§‹åŸºæœ¬è¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºç•¶å‰çš„ç°¡åŒ–è¨­å®šç‹€æ…‹
   */
  Widget _buildBasicSettings(BuildContext context) {
    if (!controller.pageState.isEnabled) {
      return const SizedBox.shrink();
    }

    return Card(
      child: Padding(
        padding: EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ç›®å‰è¨­å®š',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w600,
              ),
            ),
            const SizedBox(height: 16.0),
            _buildSettingSummary(context, 'æé†’æ™‚æ©Ÿ', 'é ç®—ä½¿ç”¨é” 80% æ™‚'),
            const SizedBox(height: 8.0),
            _buildSettingSummary(context, 'æé†’æ–¹å¼', 'æ‰‹æ©Ÿé€šçŸ¥'),
            const SizedBox(height: 8.0),
            _buildSettingSummary(context, 'æé†’é »ç‡', 'æ¯æ—¥æœ€å¤šä¸€æ¬¡'),
          ],
        ),
      ),
    );
  }

  /**
   * 77. å°æ‡‰ 6.2ï¼šå»ºæ§‹å¿«é€Ÿæ“ä½œ
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æä¾›å¤§æŒ‰éˆ•çš„å¿«é€Ÿæ“ä½œé¸é …
   */
  Widget _buildQuickActions(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: _buildQuickActionButton(
            context,
            'æ¸¬è©¦æé†’',
            Icons.notifications_active,
            Colors.orange,
            _handleTestNotification,
          ),
        ),
        const SizedBox(width: 16.0),
        Expanded(
          child: _buildQuickActionButton(
            context,
            'é‡è¨­è¨­å®š',
            Icons.refresh,
            Colors.grey,
            _handleResetSettings,
          ),
        ),
      ],
    );
  }

  /**
   * 78. å°æ‡‰ 6.2ï¼šå»ºæ§‹è¨­å®šæ‘˜è¦é …ç›®
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é¡¯ç¤ºå–®é …è¨­å®šçš„æ‘˜è¦è³‡è¨Š
   */
  Widget _buildSettingSummary(BuildContext context, String title, String value) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          title,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
            color: Colors.grey.shade600,
          ),
        ),
        Text(
          value,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  /**
   * 79. å°æ‡‰ 6.2ï¼šå»ºæ§‹å¿«é€Ÿæ“ä½œæŒ‰éˆ•
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description å»ºæ§‹å¤§å°ºå¯¸çš„å¿«é€Ÿæ“ä½œæŒ‰éˆ•
   */
  Widget _buildQuickActionButton(
    BuildContext context,
    String label,
    IconData icon,
    Color color,
    VoidCallback onPressed,
  ) {
    return SizedBox(
      height: 64.0,
      child: ElevatedButton.icon(
        onPressed: onPressed,
        icon: Icon(icon),
        label: Text(
          label,
          style: TextStyle(fontSize: 14.0, fontWeight: FontWeight.w600),
        ),
        style: ElevatedButton.styleFrom(
          backgroundColor: color.shade50,
          foregroundColor: color.shade700,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12.0),
            side: BorderSide(color: color.shade200),
          ),
        ),
      ),
    );
  }

  /**
   * 80. å°æ‡‰ 6.2ï¼šè™•ç†æ™ºæ…§è¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description åŸ·è¡Œä¸€éµæ™ºæ…§è¨­å®šåŠŸèƒ½
   */
  void _handleSmartSetup() {
    // å±•ç¤ºé€²åº¦å°è©±æ¡†ä¸¦åŸ·è¡Œæ™ºæ…§è¨­å®š
    showDialog(
      context: controller.context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            CircularProgressIndicator(),
            const SizedBox(height: 16.0),
            Text('æ­£åœ¨ç‚ºæ‚¨è¨­å®šæœ€ä½³åŒ–çš„æé†’...'),
          ],
        ),
      ),
    );

    // æ¨¡æ“¬æ™ºæ…§è¨­å®šéç¨‹
    Future.delayed(Duration(seconds: 2), () {
      Navigator.of(controller.context).pop();
      controller.applySmartSettings();
      
      ScaffoldMessenger.of(controller.context).showSnackBar(
        SnackBar(
          content: Text('âœ… æ™ºæ…§è¨­å®šå®Œæˆï¼'),
          backgroundColor: Colors.green,
        ),
      );
    });
  }

  void _handleTestNotification() {
    controller.sendTestNotification();
  }

  void _handleResetSettings() {
    controller.resetToDefaults();
  }
}
```

---

## 7.0 APIæ•´åˆåŠŸèƒ½æ¸¬è©¦ï¼ˆAPI Integration Function Testsï¼‰

### 7.1 BudgetServiceæ•´åˆæ¸¬è©¦

#### 7.1.1 BudgetServiceIntegrationTestæ¸¬è©¦
```dart
/**
 * 81. å°æ‡‰ 7.1ï¼šBudgetServiceæ•´åˆæ¸¬è©¦
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦èˆ‡BudgetServiceçš„å®Œæ•´APIæ•´åˆåŠŸèƒ½
 */
class BudgetServiceIntegrationTest {

  /**
   * 82. å°æ‡‰ 7.1ï¼šæ¸¬è©¦å–å¾—é ç®—è­¦ç¤ºè¨­å®š
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦F018 APIçš„è­¦ç¤ºè¨­å®šæŸ¥è©¢åŠŸèƒ½
   */
  static Future<void> testGetBudgetAlerts(String budgetId) async {
    try {
      final service = BudgetService();
      final alerts = await service.getBudgetAlerts(budgetId);
      
      assert(alerts != null, 'æ‡‰è©²æˆåŠŸå–å¾—è­¦ç¤ºè¨­å®š');
      assert(alerts.budgetId == budgetId, 'é ç®—IDæ‡‰è©²åŒ¹é…');
      assert(alerts.activeRules.isNotEmpty, 'æ‡‰è©²æœ‰å•Ÿç”¨çš„è¦å‰‡');
      
      print('âœ… getBudgetAlerts æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ getBudgetAlerts æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 83. å°æ‡‰ 7.1ï¼šæ¸¬è©¦è¨­å®šé ç®—è­¦ç¤º
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦F018 APIçš„è­¦ç¤ºè¨­å®šæ›´æ–°åŠŸèƒ½
   */
  static Future<void> testSetBudgetAlerts(BudgetAlertRequest request) async {
    try {
      final service = BudgetService();
      final response = await service.setBudgetAlerts(request);
      
      assert(response.success, 'è¨­å®šæ‡‰è©²æˆåŠŸ');
      assert(response.budgetId == request.budgetId, 'é ç®—IDæ‡‰è©²åŒ¹é…');
      assert(response.activeRules.isNotEmpty, 'æ‡‰è©²æœ‰å•Ÿç”¨çš„è¦å‰‡');
      
      print('âœ… setBudgetAlerts æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ setBudgetAlerts æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 84. å°æ‡‰ 7.1ï¼šæ¸¬è©¦é ç®—é€²åº¦æŸ¥è©¢
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦F017 APIçš„é ç®—é€²åº¦æŸ¥è©¢ï¼Œç”¨æ–¼è­¦ç¤ºè§¸ç™¼åˆ¤æ–·
   */
  static Future<void> testGetBudgetProgress(String budgetId) async {
    try {
      final service = BudgetService();
      final progress = await service.getBudgetProgressById(budgetId);
      
      assert(progress != null, 'æ‡‰è©²æˆåŠŸå–å¾—é ç®—é€²åº¦');
      assert(progress.budgetId == budgetId, 'é ç®—IDæ‡‰è©²åŒ¹é…');
      assert(progress.usagePercentage >= 0.0, 'ä½¿ç”¨ç‡æ‡‰è©²ç‚ºéè² æ•¸');
      assert(progress.usagePercentage <= 100.0, 'ä½¿ç”¨ç‡ä¸æ‡‰è¶…é100%');
      
      print('âœ… getBudgetProgress æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ getBudgetProgress æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 85. å°æ‡‰ 7.1ï¼šæ¸¬è©¦æ™ºæ…§å»ºè­°API
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦æ™ºæ…§å»ºè­°åŠŸèƒ½çš„APIæ•´åˆ
   */
  static Future<void> testGetSmartSuggestions(String budgetId, UserMode userMode) async {
    try {
      final service = BudgetService();
      final suggestions = await service.getSmartSuggestions(
        budgetId: budgetId,
        userMode: userMode,
      );
      
      assert(suggestions != null, 'æ‡‰è©²æˆåŠŸå–å¾—æ™ºæ…§å»ºè­°');
      assert(suggestions.isNotEmpty, 'æ‡‰è©²è‡³å°‘æœ‰ä¸€å€‹å»ºè­°');
      
      for (final suggestion in suggestions) {
        assert(suggestion.confidence >= 0.0 && suggestion.confidence <= 1.0, 
               'ä¿¡å¿ƒåº¦æ‡‰è©²åœ¨0-1ä¹‹é–“');
        assert(suggestion.title.isNotEmpty, 'å»ºè­°æ¨™é¡Œä¸æ‡‰ç‚ºç©º');
        assert(suggestion.suggestedSettings != null, 'å»ºè­°è¨­å®šä¸æ‡‰ç‚ºç©º');
      }
      
      print('âœ… getSmartSuggestions æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ getSmartSuggestions æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 86. å°æ‡‰ 7.1ï¼šæ¸¬è©¦è­¦ç¤ºè§¸ç™¼æ¨¡æ“¬
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¨¡æ“¬è­¦ç¤ºè§¸ç™¼çš„å®Œæ•´æµç¨‹æ¸¬è©¦
   */
  static Future<void> testAlertTriggerFlow(String budgetId) async {
    try {
      final service = BudgetService();
      
      // 1. å–å¾—ç•¶å‰é ç®—é€²åº¦
      final progress = await service.getBudgetProgressById(budgetId);
      
      // 2. å–å¾—è­¦ç¤ºè¨­å®š
      final alerts = await service.getBudgetAlerts(budgetId);
      
      // 3. æª¢æŸ¥æ˜¯å¦æ‡‰è©²è§¸ç™¼è­¦ç¤º
      final shouldTrigger = _shouldTriggerAlert(progress, alerts.activeRules);
      
      if (shouldTrigger.isNotEmpty) {
        // 4. æ¨¡æ“¬è§¸ç™¼è­¦ç¤º
        for (final rule in shouldTrigger) {
          await _simulateAlertTrigger(rule, progress);
        }
      }
      
      print('âœ… è­¦ç¤ºè§¸ç™¼æµç¨‹æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ è­¦ç¤ºè§¸ç™¼æµç¨‹æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 87. å°æ‡‰ 7.1ï¼šæª¢æŸ¥æ˜¯å¦æ‡‰è©²è§¸ç™¼è­¦ç¤º
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description åˆ¤æ–·æ ¹æ“šç•¶å‰é€²åº¦å’Œè¦å‰‡æ˜¯å¦éœ€è¦è§¸ç™¼è­¦ç¤º
   */
  static List<AlertRule> _shouldTriggerAlert(
    BudgetProgress progress, 
    List<AlertRule> rules,
  ) {
    final triggeredRules = <AlertRule>[];
    
    for (final rule in rules) {
      if (!rule.isActive) continue;
      
      bool shouldTrigger = false;
      
      switch (rule.trigger) {
        case AlertTrigger.percentage:
          shouldTrigger = progress.usagePercentage >= rule.threshold;
          break;
        case AlertTrigger.amount:
          shouldTrigger = progress.currentSpent >= rule.threshold;
          break;
        case AlertTrigger.dailyAverage:
          shouldTrigger = progress.dailyAverageSpent >= rule.threshold;
          break;
        case AlertTrigger.projectedOverrun:
          shouldTrigger = progress.projectedTotal > progress.budgetAmount;
          break;
      }
      
      if (shouldTrigger) {
        triggeredRules.add(rule);
      }
    }
    
    return triggeredRules;
  }

  /**
   * 88. å°æ‡‰ 7.1ï¼šæ¨¡æ“¬è­¦ç¤ºè§¸ç™¼
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¨¡æ“¬å¯¦éš›çš„è­¦ç¤ºè§¸ç™¼å’Œé€šçŸ¥ç™¼é€
   */
  static Future<void> _simulateAlertTrigger(
    AlertRule rule, 
    BudgetProgress progress,
  ) async {
    // å»ºç«‹è­¦ç¤ºè¨˜éŒ„
    final alertRecord = AlertRecord(
      alertId: 'test_${DateTime.now().millisecondsSinceEpoch}',
      budgetId: progress.budgetId,
      ruleId: rule.ruleId,
      alertType: rule.alertType,
      triggeredAt: DateTime.now(),
      budgetUsageAtTrigger: progress.usagePercentage,
      message: _generateAlertMessage(rule, progress),
    );
    
    // è¨˜éŒ„è­¦ç¤ºæ—¥èªŒ
    print('ğŸš¨ è­¦ç¤ºè§¸ç™¼: ${alertRecord.message}');
    print('   é ç®—: ${progress.budgetName}');
    print('   ä½¿ç”¨ç‡: ${progress.usagePercentage.toStringAsFixed(1)}%');
    print('   è¦å‰‡: ${rule.ruleId}');
    
    // æ¨¡æ“¬é€šçŸ¥ç™¼é€
    await _simulateNotificationSending(alertRecord);
  }

  static String _generateAlertMessage(AlertRule rule, BudgetProgress progress) {
    switch (rule.alertType) {
      case AlertType.reminder:
        return 'âš ï¸ é ç®—æé†’ï¼š${progress.budgetName} å·²ä½¿ç”¨ ${progress.usagePercentage.toStringAsFixed(1)}%';
      case AlertType.warning:
        return 'ğŸš¨ é ç®—è­¦å‘Šï¼š${progress.budgetName} ä½¿ç”¨ç‡é” ${progress.usagePercentage.toStringAsFixed(1)}%';
      case AlertType.critical:
        return 'âŒ ç·Šæ€¥è­¦ç¤ºï¼š${progress.budgetName} å³å°‡è¶…æ”¯ï¼ç›®å‰ ${progress.usagePercentage.toStringAsFixed(1)}%';
    }
  }

  static Future<void> _simulateNotificationSending(AlertRecord record) async {
    // æ¨¡æ“¬é€šçŸ¥å»¶é²
    await Future.delayed(Duration(milliseconds: 100));
    
    print('ğŸ“± é€šçŸ¥å·²ç™¼é€: ${record.alertType.toString().split('.').last}');
  }
}

/**
 * 89. å°æ‡‰ 7.1ï¼šè­¦ç¤ºè¨˜éŒ„æ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description è¨˜éŒ„è­¦ç¤ºè§¸ç™¼çš„è©³ç´°è³‡è¨Š
 */
class AlertRecord {
  final String alertId;
  final String budgetId;
  final String ruleId;
  final AlertType alertType;
  final DateTime triggeredAt;
  final double budgetUsageAtTrigger;
  final String message;
  
  const AlertRecord({
    required this.alertId,
    required this.budgetId,
    required this.ruleId,
    required this.alertType,
    required this.triggeredAt,
    required this.budgetUsageAtTrigger,
    required this.message,
  });
}
```

### 7.2 é€šçŸ¥æœå‹™æ•´åˆæ¸¬è©¦

#### 7.2.1 NotificationServiceIntegrationTestæ¸¬è©¦
```dart
/**
 * 90. å°æ‡‰ 7.2ï¼šé€šçŸ¥æœå‹™æ•´åˆæ¸¬è©¦
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æ¸¬è©¦é€šçŸ¥ç³»çµ±çš„å®Œæ•´æ•´åˆåŠŸèƒ½
 */
class NotificationServiceIntegrationTest {

  /**
   * 91. å°æ‡‰ 7.2ï¼šæ¸¬è©¦æ¨æ’­é€šçŸ¥
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦æ¨æ’­é€šçŸ¥çš„ç™¼é€å’Œæ¥æ”¶
   */
  static Future<void> testPushNotification(AlertRecord alert) async {
    try {
      final service = NotificationService();
      
      final notification = PushNotification(
        title: 'é ç®—è­¦ç¤º',
        body: alert.message,
        data: {
          'type': 'budget_alert',
          'budget_id': alert.budgetId,
          'alert_id': alert.alertId,
        },
      );
      
      final result = await service.sendPushNotification(notification);
      
      assert(result.success, 'æ¨æ’­é€šçŸ¥æ‡‰è©²ç™¼é€æˆåŠŸ');
      assert(result.notificationId.isNotEmpty, 'æ‡‰è©²æœ‰é€šçŸ¥ID');
      
      print('âœ… æ¨æ’­é€šçŸ¥æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ æ¨æ’­é€šçŸ¥æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 92. å°æ‡‰ 7.2ï¼šæ¸¬è©¦LINEé€šçŸ¥
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦LINEè¨Šæ¯é€šçŸ¥çš„ç™¼é€
   */
  static Future<void> testLineNotification(AlertRecord alert) async {
    try {
      final service = NotificationService();
      
      final lineMessage = LineMessage(
        userId: 'test_user_id',
        message: alert.message,
        quickReplies: [
          LineQuickReply(action: 'view_budget', label: 'æŸ¥çœ‹é ç®—'),
          LineQuickReply(action: 'adjust_budget', label: 'èª¿æ•´é ç®—'),
        ],
      );
      
      final result = await service.sendLineMessage(lineMessage);
      
      assert(result.success, 'LINEé€šçŸ¥æ‡‰è©²ç™¼é€æˆåŠŸ');
      
      print('âœ… LINEé€šçŸ¥æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ LINEé€šçŸ¥æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 93. å°æ‡‰ 7.2ï¼šæ¸¬è©¦Emailé€šçŸ¥
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦é›»å­éƒµä»¶é€šçŸ¥çš„ç™¼é€
   */
  static Future<void> testEmailNotification(AlertRecord alert) async {
    try {
      final service = NotificationService();
      
      final email = EmailNotification(
        to: 'test@example.com',
        subject: 'é ç®—è­¦ç¤ºé€šçŸ¥',
        body: _buildEmailBody(alert),
        isHtml: true,
      );
      
      final result = await service.sendEmail(email);
      
      assert(result.success, 'Emailé€šçŸ¥æ‡‰è©²ç™¼é€æˆåŠŸ');
      
      print('âœ… Emailé€šçŸ¥æ¸¬è©¦é€šé');
    } catch (e) {
      print('âŒ Emailé€šçŸ¥æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  /**
   * 94. å°æ‡‰ 7.2ï¼šæ¸¬è©¦æ‰¹é‡é€šçŸ¥
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description æ¸¬è©¦åŒæ™‚ç™¼é€å¤šç¨®é¡å‹çš„é€šçŸ¥
   */
  static Future<void> testBatchNotifications(
    AlertRecord alert, 
    List<NotificationMethod> methods,
  ) async {
    try {
      final service = NotificationService();
      final results = <NotificationResult>[];
      
      for (final method in methods) {
        switch (method) {
          case NotificationMethod.push:
            final result = await service.sendPushNotification(
              PushNotification(
                title: 'é ç®—è­¦ç¤º',
                body: alert.message,
              ),
            );
            results.add(result);
            break;
            
          case NotificationMethod.line:
            final result = await service.sendLineMessage(
              LineMessage(
                userId: 'test_user_id',
                message: alert.message,
              ),
            );
            results.add(result);
            break;
            
          case NotificationMethod.email:
            final result = await service.sendEmail(
              EmailNotification(
                to: 'test@example.com',
                subject: 'é ç®—è­¦ç¤ºé€šçŸ¥',
                body: alert.message,
              ),
            );
            results.add(result);
            break;
            
          case NotificationMethod.sms:
            // SMSé€šçŸ¥é€šå¸¸ä¸æ”¯æ´
            break;
        }
      }
      
      final successCount = results.where((r) => r.success).length;
      assert(successCount > 0, 'è‡³å°‘æ‡‰è©²æœ‰ä¸€å€‹é€šçŸ¥ç™¼é€æˆåŠŸ');
      
      print('âœ… æ‰¹é‡é€šçŸ¥æ¸¬è©¦é€šéï¼ŒæˆåŠŸç™¼é€ $successCount/${results.length} å€‹é€šçŸ¥');
    } catch (e) {
      print('âŒ æ‰¹é‡é€šçŸ¥æ¸¬è©¦å¤±æ•—: $e');
      rethrow;
    }
  }

  static String _buildEmailBody(AlertRecord alert) {
    return '''
    <html>
    <body>
      <h2>é ç®—è­¦ç¤ºé€šçŸ¥</h2>
      <p>${alert.message}</p>
      <p>è§¸ç™¼æ™‚é–“ï¼š${alert.triggeredAt.toString()}</p>
      <p>é ç®—ä½¿ç”¨ç‡ï¼š${alert.budgetUsageAtTrigger.toStringAsFixed(1)}%</p>
      <hr>
      <p><small>æ­¤éƒµä»¶ç”±LCASç³»çµ±è‡ªå‹•ç™¼é€</small></p>
    </body>
    </html>
    ''';
  }
}

/**
 * 95. å°æ‡‰ 7.2ï¼šé€šçŸ¥ç›¸é—œæ•¸æ“šé¡
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description å®šç¾©å„ç¨®é€šçŸ¥é¡å‹çš„æ•¸æ“šçµæ§‹
 */
class PushNotification {
  final String title;
  final String body;
  final Map<String, dynamic>? data;
  
  const PushNotification({
    required this.title,
    required this.body,
    this.data,
  });
}

class LineMessage {
  final String userId;
  final String message;
  final List<LineQuickReply>? quickReplies;
  
  const LineMessage({
    required this.userId,
    required this.message,
    this.quickReplies,
  });
}

class LineQuickReply {
  final String action;
  final String label;
  
  const LineQuickReply({
    required this.action,
    required this.label,
  });
}

class EmailNotification {
  final String to;
  final String subject;
  final String body;
  final bool isHtml;
  
  const EmailNotification({
    required this.to,
    required this.subject,
    required this.body,
    this.isHtml = false,
  });
}

class NotificationResult {
  final bool success;
  final String? notificationId;
  final String? errorMessage;
  
  const NotificationResult({
    required this.success,
    this.notificationId,
    this.errorMessage,
  });
}
```

---

## 8.0 ç„¡éšœç¤™åŠŸèƒ½æ¸¬è©¦ï¼ˆAccessibility Function Testsï¼‰

### 8.1 èªæ„åŒ–æ”¯æ´æ¸¬è©¦

#### 8.1.1 BudgetAlertAccessibilityWrapperæ¸¬è©¦
```dart
/**
 * 96. å°æ‡‰ 8.1ï¼šé ç®—è­¦ç¤ºé é¢ç„¡éšœç¤™èªæ„åŒ–WidgetåŒ…è£å™¨
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æä¾›WCAG 2.1 AAæ¨™æº–çš„å®Œæ•´ç„¡éšœç¤™æ”¯æ´ï¼ˆ9005è¦ç¯„ï¼‰
 */
class BudgetAlertAccessibilityWrapper {

  /**
   * 97. å°æ‡‰ 8.1ï¼šç‚ºè­¦ç¤ºè¨­å®šæä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºè­¦ç¤ºè¨­å®šå…ƒä»¶æ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Widget wrapAlertSettings(Widget child, BudgetAlertSettings settings) {
    return Semantics(
      container: true,
      label: 'é ç®—è­¦ç¤ºè¨­å®š',
      hint: settings.isEnabled ? 'è­¦ç¤ºå·²å•Ÿç”¨' : 'è­¦ç¤ºå·²åœç”¨',
      child: child,
    );
  }

  /**
   * 98. å°æ‡‰ 8.1ï¼šç‚ºé–¾å€¼æ»‘æ¡¿æä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºé–¾å€¼èª¿æ•´æ»‘æ¡¿æ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤å’Œæ“ä½œèªªæ˜
   */
  static Widget wrapThresholdSlider(
    Widget child, 
    AlertType alertType, 
    double currentValue,
  ) {
    final String label = _getAlertTypeLabel(alertType);
    final String hint = 'èª¿æ•´${label}é–¾å€¼ï¼Œç›®å‰è¨­å®šç‚º ${currentValue.toStringAsFixed(1)}%';
    
    return Semantics(
      slider: true,
      label: '${label}é–¾å€¼è¨­å®š',
      hint: hint,
      value: '${currentValue.toStringAsFixed(1)}%',
      increasedValue: '${(currentValue + 1).toStringAsFixed(1)}%',
      decreasedValue: '${(currentValue - 1).toStringAsFixed(1)}%',
      onIncrease: () {
        // ç”±å¯¦éš›çš„æ»‘æ¡¿Widgetè™•ç†
      },
      onDecrease: () {
        // ç”±å¯¦éš›çš„æ»‘æ¡¿Widgetè™•ç†
      },
      child: child,
    );
  }

  /**
   * 99. å°æ‡‰ 8.1ï¼šç‚ºé€šçŸ¥æ–¹å¼é¸æ“‡æä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºé€šçŸ¥æ–¹å¼é¸æ“‡å™¨æ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Widget wrapNotificationMethod(
    Widget child, 
    NotificationMethod method, 
    bool isSelected,
    bool isAvailable,
  ) {
    final String methodName = _getMethodName(method);
    final String status = isSelected ? 'å·²é¸å–' : 'æœªé¸å–';
    final String availability = isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
    
    return Semantics(
      button: true,
      selected: isSelected,
      enabled: isAvailable,
      label: '${methodName}é€šçŸ¥',
      hint: '$statusï¼Œ$availability',
      onTap: isAvailable ? () {
        // ç”±å¯¦éš›çš„é¸æ“‡å™¨Widgetè™•ç†
      } : null,
      child: child,
    );
  }

  /**
   * 100. å°æ‡‰ 8.1ï¼šç‚ºæ™ºæ…§å»ºè­°æä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºæ™ºæ…§å»ºè­°å¡ç‰‡æ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Widget wrapSmartSuggestion(
    Widget child, 
    SmartSuggestion suggestion,
  ) {
    final String confidenceDescription = _getConfidenceDescription(suggestion.confidence);
    
    return Semantics(
      container: true,
      label: 'æ™ºæ…§å»ºè­°ï¼š${suggestion.title}',
      hint: '${suggestion.description}ï¼Œä¿¡å¿ƒåº¦ï¼š$confidenceDescription',
      child: Semantics(
        button: true,
        label: 'å¥—ç”¨å»ºè­°',
        hint: 'å¥—ç”¨æ­¤æ™ºæ…§å»ºè­°åˆ°æ‚¨çš„è­¦ç¤ºè¨­å®š',
        child: child,
      ),
    );
  }

  /**
   * 101. å°æ‡‰ 8.1ï¼šç‚ºè­¦ç¤ºç¸½é–‹é—œæä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºè­¦ç¤ºç¸½é–‹é—œæ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤å’Œæ“ä½œèªªæ˜
   */
  static Widget wrapMasterSwitch(
    Widget child, 
    bool isEnabled, 
    ValueChanged<bool> onChanged,
  ) {
    return Semantics(
      toggled: isEnabled,
      label: 'é ç®—è­¦ç¤ºç¸½é–‹é—œ',
      hint: isEnabled ? 'é»æ“Šä»¥åœç”¨æ‰€æœ‰è­¦ç¤º' : 'é»æ“Šä»¥å•Ÿç”¨é ç®—è­¦ç¤º',
      onTap: () => onChanged(!isEnabled),
      child: child,
    );
  }

  /**
   * 102. å°æ‡‰ 8.1ï¼šç‚ºé€²éšè¦å‰‡æä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºé€²éšè¦å‰‡è¨­å®šæ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Widget wrapAdvancedRule(
    Widget child, 
    ConditionalRule rule, 
    int ruleIndex,
  ) {
    final String status = rule.isActive ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨';
    
    return Semantics(
      container: true,
      label: 'é€²éšè¦å‰‡ ${ruleIndex + 1}ï¼š${rule.name}',
      hint: 'è¦å‰‡ç‹€æ…‹ï¼š$statusï¼ŒåŒ…å« ${rule.conditions.length} å€‹æ¢ä»¶',
      child: child,
    );
  }

  /**
   * 103. å°æ‡‰ 8.1ï¼šç‚ºå››æ¨¡å¼ç•Œé¢æä¾›èªæ„åŒ–æ¨™ç±¤
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description ç‚ºä¸åŒä½¿ç”¨è€…æ¨¡å¼çš„ç•Œé¢æ·»åŠ é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Widget wrapModeInterface(Widget child, UserMode userMode) {
    final String modeDescription = _getModeDescription(userMode);
    
    return Semantics(
      container: true,
      label: 'é ç®—è­¦ç¤ºè¨­å®šé é¢',
      hint: 'ç•¶å‰æ¨¡å¼ï¼š$modeDescription',
      child: child,
    );
  }

  // è¼”åŠ©æ–¹æ³•
  static String _getAlertTypeLabel(AlertType type) {
    switch (type) {
      case AlertType.reminder:
        return 'æé†’';
      case AlertType.warning:
        return 'è­¦å‘Š';
      case AlertType.critical:
        return 'åš´é‡è­¦ç¤º';
    }
  }

  static String _getMethodName(NotificationMethod method) {
    switch (method) {
      case NotificationMethod.push:
        return 'æ¨æ’­';
      case NotificationMethod.line:
        return 'LINE';
      case NotificationMethod.email:
        return 'é›»å­éƒµä»¶';
      case NotificationMethod.sms:
        return 'ç°¡è¨Š';
    }
  }

  static String _getConfidenceDescription(double confidence) {
    if (confidence >= 0.9) return 'éå¸¸é«˜';
    if (confidence >= 0.7) return 'é«˜';
    if (confidence >= 0.5) return 'ä¸­ç­‰';
    if (confidence >= 0.3) return 'ä½';
    return 'å¾ˆä½';
  }

  static String _getModeDescription(UserMode mode) {
    switch (mode) {
      case UserMode.controller:
        return 'ç²¾æº–æ§åˆ¶è€…ï¼Œæä¾›å®Œæ•´çš„å°ˆæ¥­è¨­å®šåŠŸèƒ½';
      case UserMode.logger:
        return 'ç´€éŒ„ç¿’æ…£è€…ï¼Œæä¾›å„ªé›…çš„ç°¡åŒ–è¨­å®š';
      case UserMode.struggler:
        return 'è½‰å‹æŒ‘æˆ°è€…ï¼Œæä¾›ç›®æ¨™å°å‘çš„è¨­å®š';
      case UserMode.sleeper:
        return 'æ½›åœ¨è¦ºé†’è€…ï¼Œæä¾›æ¥µç°¡æ˜“æ‡‚çš„è¨­å®š';
    }
  }
}

/**
 * 104. å°æ‡‰ 8.1ï¼šç„¡éšœç¤™æ¸¬è©¦è¼”åŠ©å·¥å…·
 * @version 2025-01-26-V1.0.0
 * @date 2025-01-26 21:15:00
 * @description æä¾›ç„¡éšœç¤™åŠŸèƒ½çš„æ¸¬è©¦å’Œé©—è­‰å·¥å…·
 */
class AccessibilityTestHelper {

  /**
   * 105. å°æ‡‰ 8.1ï¼šæ¸¬è©¦èªæ„åŒ–æ¨™ç±¤å®Œæ•´æ€§
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é©—è­‰æ‰€æœ‰äº’å‹•å…ƒç´ éƒ½æœ‰é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
   */
  static Future<void> testSemanticLabels(WidgetTester tester) async {
    final semanticNodes = tester.binding.pipelineOwner.semanticsOwner?.rootSemanticsNode?.children ?? [];
    
    for (final node in semanticNodes) {
      _validateSemanticsNode(node);
    }
  }

  /**
   * 106. å°æ‡‰ 8.1ï¼šæ¸¬è©¦éµç›¤å°èˆª
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é©—è­‰æ‰€æœ‰äº’å‹•å…ƒç´ å¯ä»¥é€ééµç›¤å°èˆªæ“ä½œ
   */
  static Future<void> testKeyboardNavigation(WidgetTester tester) async {
    // æ¨¡æ“¬Tabéµå°èˆª
    await tester.sendKeyEvent(LogicalKeyboardKey.tab);
    
    // æª¢æŸ¥ç„¦é»æ˜¯å¦æ­£ç¢ºç§»å‹•
    final focusedElement = tester.binding.focusManager.primaryFocus;
    assert(focusedElement != null, 'æ‡‰è©²æœ‰å…ƒç´ ç²å¾—ç„¦é»');
  }

  /**
   * 107. å°æ‡‰ 8.1ï¼šæ¸¬è©¦è¢å¹•é–±è®€å™¨ç›¸å®¹æ€§
   * @version 2025-01-26-V1.0.0
   * @date 2025-01-26 21:15:00
   * @description é©—è­‰è¢å¹•é–±è®€å™¨å¯ä»¥æ­£ç¢ºè®€å–æ‰€æœ‰å…§å®¹
   */
  static Future<void> testScreenReaderCompatibility(WidgetTester tester) async {
    // å•Ÿç”¨èªæ„åŒ–æ¸¬è©¦
    tester.binding.semanticsEnabled = true;
    
    // æª¢æŸ¥æ‰€æœ‰æ–‡å­—å…§å®¹éƒ½æœ‰é©ç•¶çš„èªæ„åŒ–æ¨™ç±¤
    final textWidgets = tester.widgetList(find.byType(Text));
    
    for (final textWidget in textWidgets) {
      final text = textWidget as Text;
      assert(text.data != null || text.textSpan != null, 'æ–‡å­—å…§å®¹ä¸æ‡‰ç‚ºç©º');
    }
  }

  static void _validateSemanticsNode(dynamic node) {
    // æª¢æŸ¥äº’å‹•å…ƒç´ æ˜¯å¦æœ‰é©ç•¶æ¨™ç±¤
    if (node.hasFlag(SemanticsFlag.isButton) || 
        node.hasFlag(SemanticsFlag.isTextField) ||
        node.hasFlag(SemanticsFlag.isSlider)) {
      assert(node.label != null && node.label.isNotEmpty, 
             'äº’å‹•å…ƒç´ æ‡‰è©²æœ‰æ¨™ç±¤ï¼š${node.runtimeType}');
    }
    
    // éè¿´æª¢æŸ¥å­ç¯€é»
    if (node.children != null) {
      for (final child in node.children) {
        _validateSemanticsNode(child);
      }
    }
  }
}
```

---

## æ–‡ä»¶ç¶­è­·è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹è€… | ä¿®æ”¹å…§å®¹ |
|------|------|--------|----------|
| **v1.0.0** | **2025-01-26** | **LCAS SA Team** | **åˆç‰ˆå»ºç«‹ï¼šå®Œæ•´çš„P030é ç®—è­¦ç¤ºé é¢TDDè¦æ ¼ï¼ŒåŒ…å«è­¦ç¤ºç®¡ç†ã€é€šçŸ¥ç³»çµ±ã€æ™ºæ…§å»ºè­°ã€å››æ¨¡å¼å·®ç•°åŒ–è¨­è¨ˆã€BudgetService APIæ•´åˆF016-F018ã€ç„¡éšœç¤™åŠŸèƒ½ç­‰107å€‹æ¸¬è©¦å‡½æ•¸** |

---

## å‚™è¨»

- **ç‰ˆæœ¬1.0.0ç‰¹è‰²**: å®Œæ•´çš„é ç®—è­¦ç¤ºé é¢æ¸¬è©¦é©…å‹•é–‹ç™¼ï¼Œæ¶µè“‹æ‰€æœ‰è­¦ç¤ºç›¸é—œåŠŸèƒ½
- **107å€‹æ¸¬è©¦å‡½æ•¸**: å¾é é¢åˆå§‹åŒ–åˆ°APIæ•´åˆçš„å®Œæ•´æ¸¬è©¦è¦†è“‹
- **å››æ¨¡å¼å·®ç•°åŒ–**: é‡å°ç²¾æº–æ§åˆ¶è€…ã€ç´€éŒ„ç¿’æ…£è€…ã€è½‰å‹æŒ‘æˆ°è€…ã€æ½›åœ¨è¦ºé†’è€…çš„å°ˆå±¬æ¸¬è©¦
- **è¤‡é›œè­¦ç¤ºç³»çµ±**: å¤šå±¤ç´šè­¦ç¤ºã€æ™ºæ…§é–¾å€¼ã€æ¢ä»¶è¦å‰‡ã€é€šçŸ¥ç®¡ç†ç­‰é€²éšåŠŸèƒ½æ¸¬è©¦
- **APIæ•´åˆæ¸¬è©¦**: å®Œæ•´çš„BudgetServiceæ•´åˆï¼ŒåŒ…å«F016-F018é ç®—ç®¡ç†APIæ¸¬è©¦
- **é€šçŸ¥ç³»çµ±æ¸¬è©¦**: æ¨æ’­ã€LINEã€Emailç­‰å¤šé€šé“é€šçŸ¥åŠŸèƒ½æ¸¬è©¦
- **ç„¡éšœç¤™åŠŸèƒ½**: å®Œæ•´çš„WCAG 2.1 AAæ¨™æº–èªæ„åŒ–æ”¯æ´æ¸¬è©¦
- **æ™ºæ…§å»ºè­°**: AIé©…å‹•çš„è­¦ç¤ºè¨­å®šå»ºè­°åŠŸèƒ½æ¸¬è©¦
- **å°æ‡‰æ–‡ä»¶**: åŸºæ–¼P030_é ç®—è­¦ç¤ºé é¢_SRS.mdå’Œ9909æ–‡ä»¶çš„SAæ“ä½œè¦ç¯„
- **æŠ€è¡“æ•´åˆ**: èˆ‡8904 BudgetService_é ç®—ç®¡ç†.mdå’Œ5012 BM_é ç®—ç®¡ç†æ¨¡çµ„.mdæ•´åˆ
- **æ¶æ§‹éµå¾ª**: åš´æ ¼éµå¾ª0055è¨­è¨ˆåŸå‰‡å’Œ9006 Flutter_AP layer.mdçš„æ¶æ§‹è¦ç¯„
