
# DCN-0009 API端點路徑重構

**版本**: v1.0.0  
**建立日期**: 2025-09-18  
**最後更新**: 2025-09-18  
**建立者**: AustinLiao69  

---

## 目次 (Table of Contents)

### 1. [需求說明](#1-需求說明)
### 2. [業務背景與價值主張](#2-業務背景與價值主張)
   - 2.1 [業務需求](#21-業務需求)
   - 2.2 [預期效益](#22-預期效益)

### 3. [須新增/修改內容](#3-須新增修改內容)
   - 3.1 [APL層API端點路徑修改](#31-apl層api端點路徑修改)
   - 3.2 [PL層API客戶端調用修改](#32-pl層api客戶端調用修改)
   - 3.3 [設計文件同步更新](#33-設計文件同步更新)
   - 3.4 [SIT測試修改](#34-sit測試修改)

### 4. [技術架構設計](#4-技術架構設計)
### 5. [實作階段規劃](#5-實作階段規劃)
### 6. [資料庫架構需求](#6-資料庫架構需求)
### 7. [API介面規格](#7-api介面規格)
### 8. [版本升級計畫](#8-版本升級計畫)
### 9. [測試策略](#9-測試策略)
### 10. [風險評估與緩解](#10-風險評估與緩解)
### 11. [驗收標準](#11-驗收標準)
### 12. [其他注意事項](#12-其他注意事項)

---

## 1. 需求說明

本次變更目標為：統一LCAS 2.0系統中132個API端點路徑格式，解決當前APL層與BL層API路徑不一致問題，確保系統架構的完整性和維護性。

根據9504文件分析，目前系統存在以下問題：
- **APL層**：使用 `/auth/register` 格式（缺少版本前綴）
- **BL層**：使用 `/api/v1/auth/register` 格式（已有正確前綴）
- **PL層**：調用APL層端點，導致路徑不匹配問題

此次重構將統一採用 `/api/v1` 前綴，建立一致的API路徑規範。

---

## 2. 業務背景與價值主張

### 2.1 業務需求
- **系統一致性**：確保三層架構API路徑統一標準
- **維護效率**：降低開發維護成本，減少路徑配置錯誤
- **擴展性**：為未來版本迭代建立標準化基礎
- **開發體驗**：提供清晰的API路徑規範，提升開發效率

### 2.2 預期效益
- **技術債務清理**：解決現有架構不一致問題
- **開發效率提升**：統一路徑規範，減少配置錯誤
- **系統穩定性**：降低因路徑不匹配導致的系統錯誤
- **未來擴展**：為API版本管理建立標準基礎

---

## 3. 須新增/修改內容

### 3.1 APL層API端點路徑修改

#### 3.1.1 API規格文件修改（1個）
- `80. Flutter_PRD_APL/8020. API list.md`
  - 更新132個API端點路徑，統一加上 `/api/v1` 前綴
  - 修改API端點清單章節
  - 更新API契約規格範例

#### 3.1.2 模組代碼檔案修改（3個）
- `83. Flutter_Module code(API route)_APL/8301. 認證服務.dart`
  - 更新11個認證API端點路徑
  - 修改路由定義從 `/auth/*` 到 `/api/v1/auth/*`
  
- `83. Flutter_Module code(API route)_APL/8302. 用戶管理服務.dart`
  - 更新11個用戶管理API端點路徑
  - 修改路由定義從 `/users/*` 到 `/api/v1/users/*`
  
- `83. Flutter_Module code(API route)_APL/8303. 記帳交易服務.dart`
  - 更新20個記帳交易API端點路徑
  - 修改路由定義從 `/transactions/*` 到 `/api/v1/transactions/*`

#### 3.1.3 測試代碼檔案修改（3個）
- `85. Flutter_Test_code_APL/8501. 認證服務_test.dart`
  - 更新測試案例中的API端點路徑
  - 修改Mock API調用路徑
  
- `85. Flutter_Test_code_APL/8502. 用戶管理服務_test.dart`
  - 更新測試案例中的API端點路徑
  - 修改Mock API調用路徑
  
- `85. Flutter_Test_code_APL/8503. 記帳交易服務_test.dart`
  - 更新測試案例中的API端點路徑
  - 修改Mock API調用路徑

### 3.2 PL層API客戶端調用修改

#### 3.2.1 模組代碼檔案修改（2個）
- `73. Flutter_Module code_PL/7301. 系統進入功能群.dart`
  - 更新API客戶端調用URL
  - 修改HTTP請求端點路徑配置
  
- `73. Flutter_Module code_PL/7302. 記帳核心功能群.dart`
  - 更新API客戶端調用URL
  - 修改HTTP請求端點路徑配置

#### 3.2.2 測試代碼檔案修改（2個）
- `75. Flutter_Test_code_PL/7501. 系統進入功能群.dart`
  - 更新測試案例中的API調用路徑
  - 修改Mock服務端點配置
  
- `75. Flutter_Test_code_PL/7502. 記帳核心功能群.dart`
  - 更新測試案例中的API調用路徑
  - 修改Mock服務端點配置

### 3.3 設計文件同步更新

#### 3.3.1 PL層LLD設計文件修改（2個）
- `72. Flutter_LLD_PL/7201. 系統進入功能群_LLD.md`
  - 更新API集成設計章節中的端點路徑
  - 修改API調用流程圖
  
- `72. Flutter_LLD_PL/7202. 記帳核心功能群_LLD.md`
  - 更新API集成設計章節中的端點路徑
  - 修改API調用流程圖

#### 3.3.2 APL層LLD設計文件修改（2個）
- `82. Flutter_LLD_APL/8201. 認證服務.md`
  - 更新API端點映射表
  - 修改API規格說明
  
- `82. Flutter_LLD_APL/8203. 記帳交易服務.md`
  - 更新API端點映射表
  - 修改API規格說明

### 3.4 SIT測試修改

#### 3.4.1 SIT測試代碼修改（1個）
- `06. SIT_Test code/0603. SIT_TC_P1.js`
  - 更新測試案例中的API端點路徑
  - 修改API測試請求URL配置

---

## 4. 技術架構設計

### 4.1 API路徑統一策略
```
修改前：
APL層: /auth/register, /users/profile, /transactions
BL層:  /api/v1/auth/register, /api/v1/users/profile, /api/v1/transactions

修改後：
APL層: /api/v1/auth/register, /api/v1/users/profile, /api/v1/transactions  
BL層:  /api/v1/auth/register, /api/v1/users/profile, /api/v1/transactions
```

### 4.2 路徑重構規則
- **認證服務**：`/auth/*` → `/api/v1/auth/*`
- **用戶管理**：`/users/*` → `/api/v1/users/*`
- **記帳交易**：`/transactions/*` → `/api/v1/transactions/*`
- **帳本管理**：`/ledgers/*` → `/api/v1/ledgers/*`
- **其他服務**：依此類推，統一加上 `/api/v1` 前綴

### 4.3 影響範圍矩陣
```
層級    | 影響檔案數 | 主要修改內容
--------|-----------|-------------
APL層   | 7個檔案   | API端點路徑定義
PL層    | 4個檔案   | API客戶端調用
設計文件 | 4個檔案   | 設計文件同步
SIT測試 | 1個檔案   | 測試端點路徑
總計    | 16個檔案  | API路徑統一重構
```

---

## 5. 實作階段規劃

### Phase 1：APL層API端點定義修改（Week 1）
- 修改 `8020. API list.md` API規格文件
- 更新 3 個 APL 模組代碼檔案的路由定義
- 修改 3 個 APL 測試代碼檔案的測試路徑

### Phase 2：PL層API客戶端調用修改（Week 2）
- 更新 2 個 PL 模組代碼檔案的API調用
- 修改 2 個 PL 測試代碼檔案的測試配置
- 驗證 PL-APL 層API調用連通性

### Phase 3：設計文件同步更新與SIT測試修改（Week 3）
- 同步更新 4 個 LLD 設計文件
- 修改 SIT 測試代碼的API端點配置
- 執行完整的端到端測試驗證

---

## 6. 資料庫架構需求

本次API端點路徑重構**不涉及資料庫結構變更**，僅修改API路由定義和客戶端調用配置。現有Firestore集合結構保持不變。

---

## 7. API介面規格

### 7.1 路徑重構範例

#### 認證服務API (11個端點)
```
修改前: POST /auth/register
修改後: POST /api/v1/auth/register

修改前: POST /auth/login  
修改後: POST /api/v1/auth/login

修改前: POST /auth/forgot-password
修改後: POST /api/v1/auth/forgot-password
```

#### 記帳交易API (20個端點)
```
修改前: POST /transactions
修改後: POST /api/v1/transactions

修改前: GET /transactions/{id}
修改後: GET /api/v1/transactions/{id}

修改前: POST /transactions/quick
修改後: POST /api/v1/transactions/quick
```

### 7.2 API回應格式
API回應格式和狀態碼**保持不變**，僅修改請求端點路徑。

---

## 8. 版本升級計畫

### 8.1 檔案版本升級
- **APL層模組代碼**：函數版本號遞增
- **PL層模組代碼**：函數版本號遞增  
- **測試代碼檔案**：測試案例版本號遞增
- **設計文件**：文件版本號遞增

### 8.2 向後相容性
- 舊版API路徑將在過渡期間保持支援
- 建議客戶端儘快遷移至新路徑格式
- 未來版本將移除舊路徑支援

---

## 9. 測試策略

### 9.1 單元測試
- APL層：3個模組代碼檔案的API路由測試
- PL層：2個模組代碼檔案的API調用測試
- 測試覆蓋率目標：95%以上

### 9.2 整合測試
- PL-APL層API調用連通性測試
- API端點路徑正確性驗證
- 錯誤處理機制測試

### 9.3 SIT測試
- 完整的系統整合測試
- API端點路徑重構驗證
- 端到端功能測試

### 9.4 測試案例範例

#### TC-001：認證API路徑測試
```
測試目標：驗證認證服務API路徑重構
測試步驟：
1. 調用 POST /api/v1/auth/register
2. 驗證API回應狀態碼為201
3. 驗證回應格式正確性
預期結果：API調用成功，路徑正確
```

#### TC-002：記帳API路徑測試
```
測試目標：驗證記帳交易API路徑重構
測試步驟：
1. 調用 POST /api/v1/transactions
2. 驗證API回應狀態碼為201
3. 驗證交易資料建立成功
預期結果：API調用成功，路徑正確
```

---

## 10. 風險評估與緩解

### 10.1 技術風險
- **風險**：API路徑修改可能導致現有功能異常
- **緩解**：分階段實作，充分測試，保留向後相容性

### 10.2 整合風險
- **風險**：PL-APL層API調用可能出現路徑不匹配
- **緩解**：建立完整的整合測試，逐步驗證連通性

### 10.3 測試風險
- **風險**：測試案例修改不完整可能導致測試失敗
- **緩解**：系統性檢查所有測試檔案，確保路徑一致性

---

## 11. 驗收標準

### 11.1 功能驗收
- [ ] 132個API端點路徑統一加上 `/api/v1` 前綴
- [ ] APL層7個檔案API路徑修改完成
- [ ] PL層4個檔案API調用修改完成
- [ ] 設計文件4個檔案同步更新完成

### 11.2 測試驗收
- [ ] 單元測試通過率 > 95%
- [ ] 整合測試全數通過
- [ ] SIT測試通過率 > 90%
- [ ] API端點路徑正確性驗證通過

### 11.3 文件驗收
- [ ] 所有LLD設計文件同步更新
- [ ] API規格文件路徑更新完成
- [ ] 測試文件版本升級完成

---

## 12. 其他注意事項

### 12.1 開發規範
- 遵循現有代碼風格和註解規範
- 所有修改需要完整的變更日誌記錄
- 測試案例需要涵蓋新舊路徑格式

### 12.2 文件維護
- 完整的API路徑變更對照表
- 詳細的遷移指南
- 向後相容性說明文件

### 12.3 部署準備
- 確認所有環境配置正確
- 建立API路徑監控機制
- 準備回滾計畫

---

> **重要提醒**：此需求為系統性的API路徑重構，影響範圍廣泛，需要謹慎規劃和充分測試。所有開發人員請嚴格遵循分階段實作計畫，確保系統穩定性和功能完整性。API路徑變更後，請及時更新相關文件和測試案例，確保系統的一致性和可維護性。
