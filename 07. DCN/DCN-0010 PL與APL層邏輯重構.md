
# DCN-0010 PL與APL層邏輯重構

**版本**: v1.0.0  
**建立日期**: 2025-09-18  
**最後更新**: 2025-09-18  
**建立者**: AustinLiao69  

---

## 目次 (Table of Contents)

### 1. [需求說明](#1-需求說明)
### 2. [業務背景與價值主張](#2-業務背景與價值主張)
   - 2.1 [業務需求](#21-業務需求)
   - 2.2 [預期效益](#22-預期效益)

### 3. [須新增/修改內容](#3-須新增修改內容)
   - 3.1 [PL層邏輯增強](#31-pl層邏輯增強)
   - 3.2 [APL層簡化重構](#32-apl層簡化重構)
   - 3.3 [架構層級重新定義](#33-架構層級重新定義)

### 4. [技術架構設計](#4-技術架構設計)
### 5. [實作階段規劃](#5-實作階段規劃)
### 6. [資料庫架構需求](#6-資料庫架構需求)
### 7. [API介面規格](#7-api介面規格)
### 8. [版本升級計畫](#8-版本升級計畫)
### 9. [測試策略](#9-測試策略)
### 10. [風險評估與緩解](#10-風險評估與緩解)
### 11. [驗收標準](#11-驗收標準)
### 12. [其他注意事項](#12-其他注意事項)

---

## 1. 需求說明

本次變更目標為：重構LCAS 2.0系統PL層與APL層的職責分工，解決當前83號資料夾APL代碼包含過多業務邏輯的架構問題，建立清晰的三層架構分離。

**核心問題**：
- 83號APL代碼包含大量業務邏輯（資料模型、驗證邏輯、錯誤處理等）
- 業務邏輯重複了BL層功能，造成架構混亂
- APL層缺少真正的HTTP路由定義和API Gateway功能
- 違反了關注點分離和單一職責原則

**重構策略**：採用方案二 - 業務邏輯移至PL層，APL純API Gateway

---

## 2. 業務背景與價值主張

### 2.1 業務需求
- **架構清晰化**：建立清晰的三層架構分離，符合0026文件規範
- **職責單一化**：每層專注於自己的核心職責
- **維護效率提升**：減少代碼重複，降低維護成本
- **擴展性增強**：為未來功能擴展建立良好的架構基礎

### 2.2 預期效益
- **架構完整性**：建立符合業界標準的三層架構
- **開發效率提升**：清晰的職責分工，提升開發效率
- **維護成本降低**：減少代碼重複，降低維護複雜度
- **系統穩定性**：清晰的架構分離，提升系統穩定性

---

## 3. 須新增/修改內容

### 3.1 PL層邏輯增強（73號資料夾）

#### 3.1.1 新增業務邏輯處理（2個檔案）
- `73. Flutter_Module code_PL/7301. 系統進入功能群.dart`
  - 從83號資料夾移入：使用者認證邏輯、表單驗證邏輯
  - 新增：四模式UI差異化邏輯、本地狀態管理
  - 新增：HTTP客戶端調用APL API的邏輯

- `73. Flutter_Module code_PL/7302. 記帳核心功能群.dart`
  - 從83號資料夾移入：交易資料模型、驗證邏輯
  - 新增：記帳表單處理邏輯、本地數據快取
  - 新增：統計計算與圖表資料處理

#### 3.1.2 資料模型整合（新增內容）
- 將83號資料夾的資料模型類別移至73號
  - RegisterRequest、LoginRequest、TransactionRequest等
  - UserProfile、TransactionItem、DashboardData等
  - ValidationError、ApiResponse處理邏輯

#### 3.1.3 API調用介面（新增功能）
- 建立與APL層的標準化介面
- 實作API調用的封裝邏輯
- 處理UI層面的錯誤顯示
- 本地狀態與遠端資料同步

### 3.2 APL層簡化重構（83號資料夾）

#### 3.2.1 移除業務邏輯（3個檔案修改）
- `83. Flutter_Module code(API route)_APL/8301. 認證服務.dart`
  - 移除：複雜的資料模型定義和驗證邏輯
  - 保留：HTTP路由定義、請求轉發、基本驗證
  - 簡化為：純API Gateway功能

- `83. Flutter_Module code(API route)_APL/8302. 用戶管理服務.dart`
  - 移除：用戶資料處理邏輯和四模式適配
  - 保留：路由定義和請求轉發機制
  - 新增：統一錯誤處理和回應過濾

- `83. Flutter_Module code(API route)_APL/8303. 記帳交易服務.dart`
  - 移除：交易業務邏輯和統計計算
  - 保留：API路由和請求轉發
  - 簡化：專注於API Gateway功能

#### 3.2.2 新增HTTP路由定義與客戶端整合（核心功能）
- 實作Dart shelf框架的HTTP服務器
- 定義RESTful API路由規則
- 建立統一的請求轉發機制
- 實作四模式回應過濾器
- 建立統一的HTTP客戶端類別
- 實作RESTful API調用邏輯
- 處理網路錯誤和重試機制
- JWT Token管理和自動刷新

### 3.3 架構層級重新定義

#### 3.3.1 PL層新職責定義
- **UI展示與互動**：使用者介面邏輯
- **表單驗證**：即時驗證和完整表單驗證
- **用戶體驗邏輯**：四模式UI差異化處理
- **本地狀態管理**：應用程式狀態和數據快取
- **API客戶端**：調用APL層API服務

#### 3.3.2 APL層新職責定義
- **API Gateway**：統一的API入口點
- **路由管理**：HTTP路由定義和請求分發
- **請求轉發**：將請求轉發至適當的BL層服務
- **統一錯誤處理**：標準化錯誤回應格式
- **四模式回應過濾**：根據使用者模式過濾回應內容

#### 3.3.3 BL層職責保持
- **核心業務邏輯**：維持現有的業務規則處理
- **資料驗證與處理**：後端資料驗證和處理邏輯
- **Firestore操作**：資料庫存取和操作
- **業務邏輯計算**：複雜的業務計算和統計

---

## 4. 技術架構設計

### 4.1 重構後架構圖
```
┌─────────────────────────────────────────┐
│               PL層 (73號)                │
│  ┌─────────────┐  ┌─────────────────────┐ │
│  │  UI邏輯     │  │  業務邏輯處理       │ │
│  │  表單驗證    │  │  資料模型          │ │
│  │  狀態管理    │  │  HTTP客戶端        │ │
│  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────┘
                     │ RESTful API
                     ▼
┌─────────────────────────────────────────┐
│               APL層 (83號)               │
│  ┌─────────────────────────────────────┐ │
│  │         API Gateway                 │ │
│  │  - HTTP路由定義                     │ │
│  │  - 請求轉發                        │ │
│  │  - 統一錯誤處理                     │ │
│  │  - 四模式回應過濾                   │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                     │ 標準化API
                     ▼
┌─────────────────────────────────────────┐
│               BL層 (13號)                │
│         核心業務邏輯保持不變             │
└─────────────────────────────────────────┘
```

### 4.2 資料流重新設計
```
用戶操作 → PL層UI → PL層業務邏輯 → HTTP客戶端 
                                      ↓
APL層API Gateway → 路由分發 → BL層業務邏輯 → Firestore
                                      ↓
回應過濾 ← APL層 ← BL層處理結果 ← 資料庫操作
    ↓
PL層處理 → UI更新 → 用戶看到結果
```

### 4.3 關鍵技術決策
- **PL層**：使用Flutter Provider進行狀態管理，整合HTTP客戶端
- **APL層**：採用Dart shelf框架建立HTTP服務器
- **API通訊**：統一使用RESTful API，JSON格式傳輸
- **錯誤處理**：建立統一的錯誤處理機制

---

## 5. 實作階段規劃

### Phase 1：APL層HTTP路由建立（Week 1-2）
- 在83號資料夾建立Dart shelf HTTP服務器
- 實作基本的API路由定義（GET、POST、PUT、DELETE）
- 建立請求轉發到BL層的機制
- 實作統一錯誤處理器

### Phase 2：業務邏輯遷移（Week 3-4）
- 將83號資料夾的資料模型移至73號資料夾
- 將驗證邏輯和業務處理移至PL層
- 在73號資料夾建立HTTP客戶端
- 實作PL層調用APL層API的邏輯

### Phase 3：APL層簡化與整合測試（Week 5-6）
- 移除83號資料夾的多餘業務邏輯
- 簡化APL層為純API Gateway功能
- 實作四模式回應過濾器
- 執行完整的端到端測試驗證

---

## 6. 資料庫架構需求

本次重構**不涉及Firestore資料庫結構變更**，僅重新分配應用層的職責。現有的資料庫集合和文檔結構保持不變。

---

## 7. API介面規格

### 7.1 PL層API客戶端介面
```dart
// PL層HTTP客戶端
class ApiClient {
  Future<ApiResponse<T>> get<T>(String endpoint);
  Future<ApiResponse<T>> post<T>(String endpoint, dynamic data);
  Future<ApiResponse<T>> put<T>(String endpoint, dynamic data);
  Future<ApiResponse<T>> delete<T>(String endpoint);
}
```

### 7.2 APL層API Gateway介面
```dart
// APL層路由定義
class ApiGateway {
  void setupRoutes() {
    router.get('/api/v1/auth/profile', handleGetProfile);
    router.post('/api/v1/auth/login', handleLogin);
    router.post('/api/v1/transactions', handleCreateTransaction);
    // ... 其他路由
  }
}
```

### 7.3 請求轉發機制
- APL層接收HTTP請求
- 進行基本驗證（JWT Token、格式檢查）
- 轉發請求至對應的BL層函數
- 根據使用者模式過濾回應內容
- 返回標準化的JSON回應

---

## 8. 版本升級計畫

### 8.1 檔案版本升級
- **PL層模組代碼**：從v2.1.0升級至v3.0.0（重大架構變更）
- **APL層模組代碼**：從v2.2.0升級至v3.0.0（重大簡化重構）
- **測試代碼檔案**：同步升級至v3.0.0
- **LLD設計文件**：更新架構設計說明

### 8.2 向後相容性策略
- 暫時保留舊的API調用方式
- 提供遷移指南和工具
- 段階性移除舊的實作方式

---

## 9. 測試策略

### 9.1 單元測試
- **PL層測試**：業務邏輯處理、HTTP客戶端調用
- **APL層測試**：API路由、請求轉發、錯誤處理
- 測試覆蓋率目標：95%以上

### 9.2 整合測試
- **PL-APL整合**：端到端API調用測試
- **APL-BL整合**：請求轉發正確性測試
- **四模式測試**：回應過濾器功能測試

### 9.3 架構驗證測試
- 職責分離正確性驗證
- 代碼重複度檢查
- 效能影響評估

### 9.4 測試案例範例

#### TC-001：PL層業務邏輯測試
```
測試目標：驗證PL層業務邏輯處理正確性
測試步驟：
1. 模擬使用者輸入
2. 執行PL層驗證邏輯
3. 檢查處理結果
預期結果：業務邏輯處理正確，無BL層依賴
```

#### TC-002：APL層API Gateway測試
```
測試目標：驗證APL層純API Gateway功能
測試步驟：
1. 發送HTTP請求至APL層
2. 檢查請求轉發機制
3. 驗證回應過濾功能
預期結果：正確轉發請求，無業務邏輯處理
```

---

## 10. 風險評估與緩解

### 10.1 技術風險
- **風險**：大規模重構可能引入新的錯誤
- **緩解**：分階段實作，每階段充分測試

### 10.2 架構風險
- **風險**：職責分離可能導致效能下降
- **緩解**：建立效能基準測試，監控重構影響

### 10.3 開發風險
- **風險**：開發團隊需要適應新的架構模式
- **緩解**：提供完整的開發指南和培訓

---

## 11. 驗收標準

### 11.1 架構驗收
- [ ] PL層專注於UI和本地業務邏輯
- [ ] APL層純粹為API Gateway功能
- [ ] BL層核心業務邏輯保持不變
- [ ] 三層職責清晰分離

### 11.2 功能驗收
- [ ] 所有現有功能正常運作
- [ ] API調用流程順暢
- [ ] 四模式回應過濾正確
- [ ] 錯誤處理機制完善

### 11.3 程式碼品質驗收
- [ ] 代碼重複度 < 5%
- [ ] 單元測試覆蓋率 > 95%
- [ ] 整合測試通過率 100%
- [ ] 符合Dart語言規範

---

## 12. 其他注意事項

### 12.1 開發規範
- 嚴格遵循新的三層架構職責分工
- 禁止在APL層添加業務邏輯
- PL層HTTP客戶端必須通過APL層調用BL層

### 12.2 文件維護
- 更新所有相關的設計文件
- 建立架構決策記錄（ADR）
- 提供開發者遷移指南

### 12.3 監控機制
- 建立架構合規性檢查工具
- 定期審查代碼職責分離
- 監控系統效能影響

---

> **重要提醒**：此重構為重大架構變更，將徹底改變PL層和APL層的職責分工。所有開發人員必須理解新架構的設計理念，嚴格遵循職責分離原則。重構過程中請密切關注系統穩定性和效能表現，確保使用者體驗不受影響。
