
# DCN-0020 首次註冊初始化帳本

**版本**: v1.0.0  
**建立日期**: 2025-10-28  
**最後更新**: 2025-10-28  
**建立者**: LCAS PM Team  

---

## 目次 (Table of Contents)

### 1. [需求說明](#1-需求說明)
### 2. [業務背景與價值主張](#2-業務背景與價值主張)
   - 2.1 [業務需求](#21-業務需求)
   - 2.2 [預期效益](#22-預期效益)
### 3. [須新增/修改內容](#3-須新增修改內容)
   - 3.1 [強化1309 AM模組資料初始化能力](#31-強化1309-am模組資料初始化能力)
   - 3.2 [修改7301模組註冊流程](#32-修改7301模組註冊流程)
   - 3.3 [資料流完整性驗證](#33-資料流完整性驗證)
### 4. [技術架構設計](#4-技術架構設計)
   - 4.1 [統一初始化架構](#41-統一初始化架構)
   - 4.2 [Firebase資料結構設計](#42-firebase資料結構設計)
   - 4.3 [錯誤處理機制](#43-錯誤處理機制)
### 5. [實作階段規劃](#5-實作階段規劃)
### 6. [資料結構初始化清單](#6-資料結構初始化清單)
### 7. [風險評估與因應策略](#7-風險評估與因應策略)
### 8. [文件更新清單](#8-文件更新清單)
### 9. [版本紀錄](#9-版本紀錄)

---

## 1. 需求說明

本次變更目標為：解決用戶首次註冊後缺乏完整Firebase資料結構初始化的問題，確保註冊完成後能立即使用記帳功能。根據MVP階段要求，專注於核心功能完整性，建立可靠的用戶註冊到記帳的完整流程。

此變更將實現：
1. 強化AM_initializeUserSubjects為完整的帳本初始化功能
2. 在7301註冊流程中整合完整的資料結構初始化
3. 建立三個核心子集合：transactions、accounts、categories
4. 確保註冊到記帳的端到端用戶體驗流暢

---

## 2. 業務背景與價值主張

### 2.1 業務需求
- **用戶體驗連續性**：註冊完成後應能立即開始記帳，避免功能斷點
- **產品完整性保證**：核心記帳功能必須在註冊後立即可用
- **MVP階段聚焦**：專注解決當前阻塞問題，避免過度工程化
- **架構一致性要求**：統一資料初始化策略，降低維護複雜度

### 2.2 預期效益
- **用戶留存率提升**：消除首次使用障礙，提升用戶滿意度
- **開發效率改善**：統一初始化邏輯，減少跨模組協調成本
- **維護成本降低**：集中式初始化減少故障排除複雜度
- **擴展性準備**：為後續功能擴展建立穩固基礎

---

## 3. 須新增/修改內容

### 3.1 強化1309 AM模組資料初始化能力

#### 3.1.1 函數重構規格
- **原函數**：AM_initializeUserSubjects
- **新函數**：AM_initializeUserLedger
- **模組版次升級**：1309. AM.js v3.1.0 → v3.2.0
- **函數版次**：v2025-11-27-V1.0.0

#### 3.1.2 功能擴展內容
```javascript
// 擴展後的初始化功能範圍
AM_initializeUserLedger(UID, userMode) {
  // 1. 建立用戶預設帳本
  // 2. 初始化交易記錄子集合 (ledgers/{ledger_id}/transactions)
  // 3. 初始化帳戶子集合 (ledgers/{ledger_id}/accounts) - 含預設帳戶
  // 4. 初始化科目子集合 (ledgers/{ledger_id}/categories) - 從0099.json載入
  // 5. 設定用戶模式相關的預設配置
}
```

### 3.2 修改7301模組註冊流程

#### 3.2.1 註冊流程整合
- **模組版次升級**：7301. 系統進入功能群.dart v2.5.0 → v2.6.0
- **修改函數版次**：v2025-11-27-V1.1.0
- **整合時點**：在用戶資料成功建立後立即調用AM_initializeUserLedger

#### 3.2.2 錯誤處理強化
```dart
// 註冊流程錯誤處理邏輯（遵循PL→APL→ASL→BL→DL資料流）
Future<RegisterResponse> registerWithEmail(RegisterRequest request) async {
  try {
    // 1. 建立用戶基本資料（調用APL層API）
    // 2. 通過APL層調用帳本初始化API
    // 3. 接收ASL統一格式回應，驗證初始化結果
    // 4. 處理初始化失敗情況 - 避免半完成狀態
  } catch (error) {
    // 錯誤透過正確層級向上傳遞
  }
}
```

### 3.3 資料流完整性驗證

#### 3.3.1 驗證檢查點
- **資料結構完整性**：確認三個子集合正確建立
- **預設資料載入**：驗證0099.json科目資料正確匯入
- **帳戶初始化**：確認預設帳戶建立成功
- **功能連續性**：驗證註冊後立即可進行記帳操作

---

## 4. 技術架構設計

### 4.1 統一初始化架構

#### 4.1.1 資料流向設計
**完整五層架構資料流**：
```
7301(PL) → APL層API → ASL統一格式 → AM_initializeUserLedger(BL) → Firebase
    ↓         ↓           ↓                    ↓                      ↓              ↓
用戶註冊請求 → API路由處理 → 統一回應格式 → 帳本子集合初始化邏輯 → Firebase操作 → 資料結構建立
```

**各層職責明確劃分**：
- **PL層(7301)**：用戶介面邏輯，調用APL層API
- **APL層**：API路由處理，轉發到ASL層  
- **ASL層**：統一回應格式處理，調用BL層
- **BL層(AM模組)**：業務邏輯處理，調用DL層
- **DL層(FS模組)**：資料庫操作，直接對接Firebase

#### 4.1.2 模組職責劃分（遵循0098第7條：嚴格遵守資料流）
- **7301 PL層**：負責註冊流程協調和用戶體驗，調用APL層API
- **APL層**：負責API路由處理，調用ASL層
- **ASL層**：負責統一API回應格式，調用BL層
- **1309 AM模組（BL層）**：負責完整的帳本資料結構初始化，調用DL層
- **1311 FS模組（DL層）**：負責Firebase資料操作和結構驗證

### 4.2 Firebase資料結構設計

#### 4.2.1 帳本集合結構
```
ledgers/{ledger_id}/
├── transactions/     # 交易記錄子集合
├── accounts/         # 帳戶子集合
└── categories/       # 科目子集合
```

#### 4.2.2 遵循規範要求
- **嚴格遵守1311文件規範**：所有Firebase文檔結構符合FS.js標準
- **資料來源統一**：預設科目必須從0099. Subject_code.json載入
- **禁止hard coding**：所有預設值從配置檔案取得

### 4.3 錯誤處理機制

#### 4.3.1 統一錯誤處理
- **遵循0098第7條**：嚴格遵守PL→APL→ASL→BL→DL資料流，禁止隔層呼叫
- **DL模組日誌記錄**：完整記錄初始化過程和錯誤詳情
- **回滾機制**：初始化失敗時清理已建立的不完整資料，確保資料一致性
- **錯誤傳遞機制**：錯誤訊息需通過正確的層級向上傳遞（DL→BL→ASL→APL→PL）
- **錯誤分類處理**：根據錯誤類型提供適當的用戶提示和系統處理

---

## 5. 實作階段規劃

### 階段一：AM模組功能擴展（Week 1）

**目標**：將AM_initializeUserSubjects擴展為AM_initializeUserLedger

**具體任務**：
1. 重構現有AM_initializeUserSubjects函數
2. 新增交易記錄子集合初始化邏輯
3. 新增帳戶子集合初始化邏輯，包含預設帳戶建立
4. 保持現有科目初始化邏輯，確保從0099.json正確載入
5. 整合用戶模式相關的個人化設定

**版本升級**：1309. AM.js → v3.2.0

**驗收標準**：
- AM_initializeUserLedger函數成功建立完整帳本結構
- 三個子集合（transactions、accounts、categories）正確初始化
- 預設資料正確載入，符合用戶模式要求

### 階段二：PL層註冊流程整合（Week 2）

**目標**：在7301註冊流程中整合完整初始化功能

**具體任務**：
1. 修改registerWithEmail函數，整合AM_initializeUserLedger調用
2. 建立完整的錯誤處理機制，避免用戶卡在半完成狀態
3. 實作初始化失敗的回滾機制
4. 優化用戶回饋訊息，提供初始化進度資訊

**版本升級**：7301. 系統進入功能群.dart → v2.6.0

**驗收標準**：
- 註冊流程包含完整的帳本初始化
- 錯誤處理機制完整，無用戶卡死情況
- 初始化失敗能正確回滾，不留殘餘資料

### 階段三：整合驗證與最佳化（Week 3）

**目標**：驗證端到端流程，確保註冊到記帳功能完整性

**具體任務**：
1. 端到端流程測試：註冊 → 初始化 → 立即記帳
2. 資料完整性驗證：確認三個子集合正確建立
3. 效能最佳化：優化初始化流程時間
4. 文件更新：更新相關SRS、LLD文件

**最終驗收標準**：
- 用戶註冊後立即可進行記帳操作
- 資料結構完整，符合1311規範
- 整體流程穩定可靠，符合MVP品質要求

---

## 6. 資料結構初始化清單

### 6.1 帳本主體結構
```json
{
  "ledger_id": "user_{UID}_{timestamp}",
  "name": "個人記帳本",
  "owner": "{UID}",
  "type": "personal",
  "created_at": "timestamp",
  "settings": {
    "currency": "TWD",
    "timezone": "Asia/Taipei",
    "user_mode": "{用戶選擇的模式}"
  }
}
```

### 6.2 交易記錄子集合 (transactions)
- **集合路徑**：`ledgers/{ledger_id}/transactions`
- **初始狀態**：空集合，準備接收交易記錄
- **文檔結構**：符合1311 FS.js交易記錄規範

### 6.3 帳戶子集合 (accounts)
- **集合路徑**：`ledgers/{ledger_id}/accounts`
- **預設帳戶**：
  - 現金帳戶 (預設)
  - 銀行帳戶
- **文檔結構**：符合1311 FS.js帳戶管理規範

### 6.4 科目子集合 (categories)
- **集合路徑**：`ledgers/{ledger_id}/categories`
- **資料來源**：0099. Subject_code.json
- **載入邏輯**：完整匯入所有預設科目
- **文檔結構**：符合1311 FS.js科目管理規範

---

## 7. 風險評估與因應策略

### 7.1 技術風險
**風險**：Firebase寫入操作失敗導致初始化不完整
**因應策略**：實作事務性操作和回滾機制，確保資料一致性

**風險**：大量資料初始化影響註冊流程效能
**因應策略**：採用批次寫入最佳化，設定合理的超時機制

### 7.2 業務風險
**風險**：初始化失敗導致用戶無法使用核心功能
**因應策略**：建立完整的錯誤處理和用戶提示機制

**風險**：版本升級影響現有用戶
**因應策略**：採用向後相容設計，確保既有功能不受影響

### 7.3 因應措施
1. **完整測試**：包含正常流程和異常流程測試
2. **監控機制**：透過DL模組記錄初始化成功率
3. **快速回復**：準備回滾計畫，必要時可快速恢復舊版本

---

## 8. 文件更新清單

### 8.1 核心模組文件更新 (2個修改)
- `11. Replit_SRS_BL/1109. AM_帳號管理模組.md`
  - 更新AM_initializeUserLedger函數規格
  - 新增帳本初始化流程說明
- `71. Flutter_SRS_PL/7101. 系統進入功能群_SRS.md`
  - 更新註冊流程規格，包含資料初始化步驟

### 8.2 LLD技術文件更新 (2個修改)
- `12. Replit_LLD_BL/1209. AM_帳號管理模組.md`
  - 新增AM_initializeUserLedger詳細設計
  - 更新Firebase資料結構初始化邏輯
- `72. Flutter_LLD_PL/7201. 系統進入功能群_LLD.md`
  - 更新註冊流程技術設計，包含初始化整合

### 8.3 測試計畫文件更新 (2個修改)
- `14. Replit_Test plan_BL/1409. AM_帳號管理模組.md`
  - 新增帳本初始化測試案例
- `74. Flutter_Test plan_PL/7401. 系統進入功能群.md`
  - 新增端到端註冊流程測試案例

**總計：6個文件需要更新**

---

## 9. 版本紀錄

| 版本 | 日期 | 修改內容 | 修改者 |
|------|------|----------|--------|
| v1.0.0 | 2025-10-28 | 初版建立，定義用戶首次註冊後帳本初始化解決方案 | LCAS PM Team |

---

> **重要提醒**：此變更將對LCAS 2.0用戶註冊流程產生重大改善，直接影響用戶首次使用體驗。所有開發人員請嚴格遵循三階段實作規劃，確保每個階段的驗收標準都能達成。

> **MVP原則堅持**：本次變更專注於解決用戶註冊後無法立即記帳的核心問題，避免過度工程化設計，確保在提升用戶體驗的同時維持開發效率。

> **關鍵PM Insight**：完整的用戶旅程體驗是產品成功的關鍵。註冊到首次使用的流暢度直接決定用戶留存率，這個技術改進具有重要的商業價值。統一的初始化策略不僅解決當前問題，更為產品未來擴展奠定穩固基礎。
