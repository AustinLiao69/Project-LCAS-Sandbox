
# 8205. 帳戶管理服務 - Low Level Design (LLD)

**版本**: 1.0.0  
**建立日期**: 2025-09-05  
**最後更新**: 2025-09-05  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8105. 帳戶管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
帳戶管理服務提供 LCAS 2.0 系統的完整帳戶管理功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **帳戶CRUD模組**：帳戶建立、查詢、修改、刪除處理
- **帳戶類型管理模組**：現金、銀行、信用卡、投資、借貸帳戶類型處理
- **餘額管理模組**：即時餘額查詢、餘額歷史追蹤
- **帳戶轉帳模組**：帳戶間資金轉移處理
- **帳戶統計模組**：使用統計與分析功能

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8105. 帳戶管理服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│         (AccountController)             │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │AccountSvc   │BalanceSvc   │TransSvc│ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │ValidationSvc│ UserModeAdapter     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
AccountController
    ├─ depends on ──→ AccountService
    ├─ depends on ──→ BalanceService
    ├─ depends on ──→ TransferService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

AccountService
    ├─ depends on ──→ AccountRepository
    ├─ depends on ──→ ValidationService
    └─ depends on ──→ AccountTypeService

BalanceService
    ├─ depends on ──→ AccountRepository
    └─ depends on ──→ TransactionRepository

TransferService
    ├─ depends on ──→ AccountRepository
    ├─ depends on ──→ TransactionRepository
    └─ depends on ──→ BalanceService

UserModeAdapter
    ├─ depends on ──→ ModeConfigService
    └─ depends on ──→ ResponseFilter
```

---

## 3. 模組與類別設計

### 3.1 AccountController 類別設計

#### 3.1.1 類別職責
- 統一處理所有帳戶管理相關的API請求
- 協調各服務模組完成業務邏輯
- 實作8088規範的統一回應格式
- 處理四模式差異化邏輯

#### 3.1.2 方法簽名規格

**帳戶CRUD方法**
```dart
/**
 * 01. 取得帳戶列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AccountListResponse>> getAccounts(GetAccountsRequest request)

/**
 * 02. 建立帳戶
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<Account>> createAccount(CreateAccountRequest request)

/**
 * 03. 取得帳戶詳情
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AccountDetailResponse>> getAccount(String accountId)

/**
 * 04. 更新帳戶
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<Account>> updateAccount(String accountId, UpdateAccountRequest request)

/**
 * 05. 刪除帳戶
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<DeleteAccountResponse>> deleteAccount(String accountId, DeleteAccountRequest request)
```

**餘額管理方法**
```dart
/**
 * 06. 取得帳戶餘額
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<BalanceResponse>> getAccountBalance(String accountId, GetBalanceRequest request)
```

**帳戶類型方法**
```dart
/**
 * 07. 取得帳戶類型列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AccountTypesResponse>> getAccountTypes()
```

**帳戶轉帳方法**
```dart
/**
 * 08. 帳戶轉帳
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<TransferResponse>> transferFunds(TransferRequest request)
```

**內部輔助方法**
```dart
/**
 * 09. 建構回應物件
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
ApiResponse<T> _buildResponse<T>(T data, UserMode userMode, String requestId)

/**
 * 10. 記錄帳戶事件
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
void _logAccountEvent(String event, Map<String, dynamic> details)

/**
 * 11. 驗證請求參數
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
ValidationResult _validateRequest(dynamic request)

/**
 * 12. 提取使用者模式
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
UserMode _extractUserMode(HttpRequest request)
```

### 3.2 AccountService 類別設計

#### 3.2.1 類別職責
- 實作核心帳戶管理業務邏輯
- 管理帳戶生命週期
- 整合驗證服務與資料層
- 執行業務規則檢查

#### 3.2.2 方法簽名規格

**帳戶管理核心方法**
```dart
/**
 * 13. 處理帳戶建立
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<Account> processAccountCreation(CreateAccountRequest request)

/**
 * 14. 取得帳戶列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<AccountListResult> getAccountsList(GetAccountsRequest request)

/**
 * 15. 取得帳戶詳情
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<AccountDetailResult> getAccountDetails(String accountId, bool includeTransactions)

/**
 * 16. 處理帳戶更新
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<Account> processAccountUpdate(String accountId, UpdateAccountRequest request)

/**
 * 17. 處理帳戶刪除
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<DeleteAccountResult> processAccountDeletion(String accountId, DeleteAccountRequest request)
```

**內部業務邏輯方法**
```dart
/**
 * 18. 驗證帳戶資料
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ValidationResult> _validateAccountData(dynamic accountData)

/**
 * 19. 建立帳戶實體
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<AccountEntity> _createAccountEntity(CreateAccountRequest request)

/**
 * 20. 檢查帳戶名稱重複
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<bool> _checkAccountNameDuplication(String name, String ledgerId)

/**
 * 21. 更新帳戶活動時間
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<void> _updateAccountActivity(String accountId)
```

### 3.3 BalanceService 類別設計

#### 3.3.1 類別職責
- 管理帳戶餘額查詢與計算
- 處理餘額歷史記錄
- 實作餘額統計功能

#### 3.3.2 方法簽名規格

**餘額管理方法**
```dart
/**
 * 22. 取得即時餘額
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<BalanceResult> getCurrentBalance(String accountId)

/**
 * 23. 取得餘額歷史
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<List<BalanceHistory>> getBalanceHistory(String accountId, int days)

/**
 * 24. 計算餘額變動
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<BalanceChange> calculateBalanceChange(String accountId)

/**
 * 25. 更新帳戶餘額
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<void> updateAccountBalance(String accountId, double amount)
```

### 3.4 TransferService 類別設計

#### 3.4.1 類別職責
- 處理帳戶間轉帳業務邏輯
- 管理轉帳事務一致性
- 建立轉帳交易記錄

#### 3.4.2 方法簽名規格

**轉帳處理方法**
```dart
/**
 * 26. 處理帳戶轉帳
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<TransferResult> processTransfer(TransferRequest request)

/**
 * 27. 驗證轉帳參數
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<TransferValidation> validateTransfer(TransferRequest request)

/**
 * 28. 執行轉帳事務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<TransactionPair> executeTransferTransaction(TransferRequest request)

/**
 * 29. 建立轉帳記錄
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<void> createTransferRecords(TransferRequest request, TransactionPair transactions)
```

### 3.5 UserModeAdapter 類別設計

#### 3.5.1 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.5.2 方法簽名規格

**核心適配方法**
```dart
/**
 * 30. 適配回應內容
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
T adaptResponse<T>(T response, UserMode userMode)

/**
 * 31. 適配錯誤回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
ApiError adaptErrorResponse(ApiError error, UserMode userMode)
```

**具體回應適配方法**
```dart
/**
 * 32. 適配帳戶列表回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
AccountListResponse adaptAccountListResponse(AccountListResponse response, UserMode userMode)

/**
 * 33. 適配帳戶詳情回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
AccountDetailResponse adaptAccountDetailResponse(AccountDetailResponse response, UserMode userMode)

/**
 * 34. 適配餘額回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
BalanceResponse adaptBalanceResponse(BalanceResponse response, UserMode userMode)
```

---

## 4. API 設計規格

### 4.1 API 端點設計規格

本節嚴格遵循 **8088. API設計規範.md** 的規範，實作統一的回應格式、錯誤處理機制，並支援四模式差異化。

#### 4.1.1 統一回應格式設計

**成功回應格式**
```dart
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  // 建構子定義
  ApiResponse.success({required T data, required ApiMetadata metadata})
  ApiResponse.error({required ApiError error, required ApiMetadata metadata})

  // 工廠方法
  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata)
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata)

  // JSON 轉換方法
  Map<String, dynamic> toJson()
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT)
}
```

#### 4.1.2 API 端點映射規格

遵循 **8020. API list.md** 和 **8105. 帳戶管理服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/accounts` | GET | `getAccounts(GetAccountsRequest)` | S-205, S-304 |
| `/accounts` | POST | `createAccount(CreateAccountRequest)` | S-305 |
| `/accounts/{id}` | GET | `getAccount(String)` | S-304 |
| `/accounts/{id}` | PUT | `updateAccount(String, UpdateAccountRequest)` | S-305 |
| `/accounts/{id}` | DELETE | `deleteAccount(String, DeleteAccountRequest)` | S-304 |
| `/accounts/{id}/balance` | GET | `getAccountBalance(String, GetBalanceRequest)` | S-205, S-304 |
| `/accounts/types` | GET | `getAccountTypes()` | S-305 |
| `/accounts/transfer` | POST | `transferFunds(TransferRequest)` | S-304 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 CreateAccountRequest 類別規格

```dart
class CreateAccountRequest {
  final String name;
  final AccountType type;
  final String ledgerId;
  final String? currency;
  final double? initialBalance;
  final String? description;
  final String? bankName;
  final String? accountNumber;
  final double? creditLimit;
  final double? interestRate;
  final String? icon;
  final String? color;
  final bool? isActive;
  final int? sortOrder;

  // 建構子
  CreateAccountRequest({required name, required type, required ledgerId, ...})

  // 驗證方法
  List<ValidationError> validate()

  // 轉換方法
  Map<String, dynamic> toJson()
  static CreateAccountRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.2 GetAccountsRequest 類別規格

```dart
class GetAccountsRequest {
  final String? ledgerId;
  final AccountType? type;
  final bool? active;
  final bool? includeBalance;
  final int? page;
  final int? limit;
  final String? sortBy;
  final String? sortOrder;

  // 方法定義
  GetAccountsRequest({...})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static GetAccountsRequest fromJson(Map<String, dynamic> json)
}
```

### 5.2 回應資料模型

#### 5.2.1 Account 類別規格

```dart
class Account {
  final String id;
  final String name;
  final AccountType type;
  final String ledgerId;
  final String currency;
  final double currentBalance;
  final String? description;
  final String? bankName;
  final String? accountNumber;
  final double? creditLimit;
  final double? interestRate;
  final String? icon;
  final String? color;
  final bool isActive;
  final int? sortOrder;
  final DateTime createdAt;
  final DateTime updatedAt;
  final DateTime? lastTransactionAt;

  // 方法定義
  Account({required id, ...})
  Map<String, dynamic> toJson()
  static Account fromJson(Map<String, dynamic> json)
}
```

#### 5.2.2 AccountListResponse 類別規格

```dart
class AccountListResponse {
  final List<Account> accounts;
  final Pagination pagination;
  final AccountSummary? summary;

  // 方法定義
  AccountListResponse({required accounts, required pagination, ...})
  Map<String, dynamic> toJson()
  static AccountListResponse fromJson(Map<String, dynamic> json)
}
```

### 5.3 資料存取層設計

#### 5.3.1 AccountRepository 介面規格

```dart
abstract class AccountRepository {
  Future<Account?> findById(String id);
  Future<List<Account>> findByLedgerId(String ledgerId);
  Future<Account> create(Account account);
  Future<Account> update(Account account);
  Future<void> delete(String id);
  Future<bool> existsByName(String name, String ledgerId);
  Future<List<Account>> findByType(AccountType type);
  Future<List<Account>> findByStatus(bool isActive);
}
```

#### 5.3.2 AccountEntity 類別規格

```dart
class AccountEntity {
  final String id;
  final String name;
  final AccountType type;
  final String ledgerId;
  final String currency;
  final double currentBalance;
  final String? description;
  final String? bankName;
  final String? accountNumber;
  final double? creditLimit;
  final double? interestRate;
  final String? icon;
  final String? color;
  final bool isActive;
  final int? sortOrder;
  final DateTime createdAt;
  final DateTime updatedAt;
  final DateTime? lastTransactionAt;

  // 方法定義
  AccountEntity({required id, ...})
  Map<String, dynamic> toFirestore()
  static AccountEntity fromFirestore(Map<String, dynamic> data, String id)
  bool isActive()
  bool canDelete()
  AccountEntity updateBalance(double newBalance)
}
```

---

## 6. 安全與驗證設計

### 6.1 安全服務設計

#### 6.1.1 ValidationService 類別規格

```dart
abstract class ValidationService {
  List<ValidationError> validateAccountName(String name);
  List<ValidationError> validateAccountType(AccountType type);
  List<ValidationError> validateCurrency(String currency);
  List<ValidationError> validateBalance(double balance);
  List<ValidationError> validateCreateAccountRequest(CreateAccountRequest request);
  List<ValidationError> validateUpdateAccountRequest(UpdateAccountRequest request);
  List<ValidationError> validateTransferRequest(TransferRequest request);
}
```

#### 6.1.2 SecurityService 類別規格

```dart
abstract class SecurityService {
  bool canAccessAccount(String userId, String accountId);
  bool canModifyAccount(String userId, String accountId);
  bool canDeleteAccount(String userId, String accountId);
  bool canTransferFunds(String userId, String fromAccountId, String toAccountId);
  List<String> getAccessibleAccounts(String userId);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤分類體系

遵循 **8088. API設計規範** 的錯誤處理標準：

#### 7.1.1 AccountErrorCode 枚舉規格

```dart
enum AccountErrorCode {
  // 驗證錯誤 (400)
  validationError,
  invalidAccountName,
  invalidAccountType,
  invalidBalance,
  missingRequiredField,

  // 認證錯誤 (401)
  unauthorized,
  accessDenied,

  // 權限錯誤 (403)
  insufficientPermissions,
  accountNotAccessible,

  // 資源錯誤 (404, 409)
  accountNotFound,
  accountNameExists,
  ledgerNotFound,

  // 業務邏輯錯誤
  insufficientBalance,
  sameAccountTransfer,
  accountHasTransactions,

  // 系統錯誤 (500)
  internalServerError,
  databaseError;

  // 方法定義
  int get httpStatusCode
  String getMessage(UserMode userMode)
}
```

#### 7.1.2 ApiError 類別規格

```dart
class ApiError {
  final AccountErrorCode code;
  final String message;
  final String? field;
  final DateTime timestamp;
  final String requestId;
  final Map<String, dynamic>? details;

  // 建構子與方法
  ApiError({required code, required message, ...})
  Map<String, dynamic> toJson()
  static ApiError fromJson(Map<String, dynamic> json)
  static ApiError create(AccountErrorCode code, UserMode userMode, {...})
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 ModeConfigService 類別規格

```dart
abstract class ModeConfigService {
  ModeConfig getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getDefaultSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
}
```

#### 8.1.2 ResponseFilter 類別規格

```dart
abstract class ResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含完整的帳戶統計資訊
- 提供進階操作選項
- 顯示詳細的餘額歷史

#### 8.2.2 Guiding Mode 回應特性
- 極簡化的回應內容
- 隱藏複雜的統計資訊
- 提供簡單明瞭的帳戶資訊

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**AccountController 測試規格**
```dart
abstract class AccountControllerTest {
  void testGetAccountsWithValidRequest();
  void testCreateAccountWithValidData();
  void testGetAccountWithExistingId();
  void testUpdateAccountWithValidChanges();
  void testDeleteAccountWithoutTransactions();
  void testGetAccountBalanceWithValidId();
  void testTransferFundsWithSufficientBalance();
}
```

**AccountService 測試規格**
```dart
abstract class AccountServiceTest {
  void testAccountCreationProcess();
  void testAccountNameValidation();
  void testAccountTypeValidation();
  void testBalanceCalculation();
  void testTransferValidation();
}
```

#### 9.1.2 整合測試設計

**API 端點測試規格**
```dart
abstract class AccountAPIIntegrationTest {
  void testCompleteAccountManagementFlow();
  void testAccountCreationToBalanceQuery();
  void testAccountTransferFlow();
  void testAccountDeletionFlow();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
abstract class UserModeTest {
  void testExpertModeAccountResponse();
  void testInertialModeAccountResponse();
  void testCultivationModeAccountResponse();
  void testGuidingModeAccountResponse();
  void testModeFeatureFiltering();
  void testModeResponseConsistency();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
enum AccountType { cash, bank, credit_card, investment, loan, other }
enum UserMode { expert, inertial, cultivation, guiding }
enum SortOrder { asc, desc }
enum DeleteType { soft, hard, transferred }
```

### B. 介面契約定義

#### B.1 Repository 基礎介面

```dart
abstract class BaseRepository<T, ID> {
  Future<T?> findById(ID id);
  Future<T> save(T entity);
  Future<void> delete(ID id);
  Future<List<T>> findAll();
  Future<bool> exists(ID id);
}
```

---

**文件完成日期**: 2025-09-05  
**版本**: 1.0.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8105 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計
