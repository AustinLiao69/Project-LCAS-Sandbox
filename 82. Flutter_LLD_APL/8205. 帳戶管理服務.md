# 8205. 帳戶管理服務 - API Gateway設計規格

**版本**: 2.0.0  
**建立日期**: 2025-09-04  
**最後更新**: 2025-09-19  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8105. 帳戶管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API Gateway架構](#2-api-gateway架構)
### 3. [RESTful端點設計](#3-restful端點設計)
### 4. [統一回應格式](#4-統一回應格式)
### 5. [錯誤處理機制](#5-錯誤處理機制)
### 6. [認證授權設計](#6-認證授權設計)
### 7. [BL層轉發規範](#7-bl層轉發規範)
### 8. [四模式支援規範](#8-四模式支援規範)
### 9. [測試規範](#9-測試規範)

---

## 1. 簡介

### 1.1 設計目的與範圍
帳戶管理服務API Gateway提供LCAS 2.0系統帳戶管理功能的統一API端點，負責接收HTTP請求並轉發至BL層處理。本文件定義純API Gateway的設計規範，專注於RESTful API端點定義、統一回應格式、錯誤處理與BL層轉發機制。

### 1.2 API Gateway核心職責
- **RESTful端點定義**：提供標準化的帳戶管理API端點
- **統一回應格式**：實作8088規範的統一回應結構
- **請求路由轉發**：將HTTP請求轉發至對應BL層函數
- **認證授權控制**：JWT token驗證與權限檢查
- **錯誤統一處理**：標準化錯誤回應格式
- **四模式差異化**：根據使用者模式調整回應內容

### 1.3 設計遵循規範
- **完全遵循8088 API設計規範**：RESTful設計、統一回應格式
- **對應8105 API規格文件**：確保端點定義完全一致
- **符合0015產品規格書**：APL層作為純API Gateway職責

---

## 2. API Gateway架構

### 2.1 純轉發架構設計
```
┌─────────────────────────────────────────┐
│           HTTP請求層                     │
│         (Express Routes)                │
├─────────────────────────────────────────┤
│           API Gateway層                  │
│      (純轉發，無業務邏輯)                 │
│  ┌─────────────────────────────────────┐ │
│  │  - JWT認證驗證                      │ │
│  │  - 請求參數驗證                      │ │
│  │  - 統一回應格式                      │ │
│  │  - 錯誤處理轉換                      │ │
│  │  └─ BL層函數調用                    │ │
│  └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│              BL層轉發                    │
│         (呼叫13號資料夾模組)              │
│  ┌─────────────────────────────────────┐ │
│  │  1351.MLS.js - 多帳本管理邏輯        │ │
│  │  1314.BS.js - 備份服務邏輯           │ │
│  │  1301.BK.js - 記帳核心邏輯           │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 2.2 轉發機制流程
```
HTTP請求 → Express路由 → JWT驗證 → 參數驗證 → BL層調用 → 統一回應格式
     ↓
1. 接收HTTP請求與參數
2. 驗證JWT token有效性  
3. 驗證請求參數格式
4. 調用對應BL層函數
5. 處理BL層回應結果
6. 套用四模式差異化
7. 回傳統一格式JSON
```

---

## 3. RESTful端點設計

### 3.1 API端點總覽

根據8105 API規格文件，帳戶管理服務提供以下RESTful端點：

| HTTP方法 | 端點路徑 | 功能描述 | BL層函數 |
|---------|----------|----------|----------|
| GET | `/accounts` | 查詢帳戶列表 | `1351.MLS.getAccountList()` |
| POST | `/accounts` | 建立新帳戶 | `1351.MLS.createAccount()` |
| GET | `/accounts/{id}` | 取得帳戶詳情 | `1351.MLS.getAccountDetail()` |
| PUT | `/accounts/{id}` | 更新帳戶資訊 | `1351.MLS.updateAccount()` |
| DELETE | `/accounts/{id}` | 刪除帳戶 | `1351.MLS.deleteAccount()` |
| GET | `/accounts/{id}/balance` | 查詢帳戶餘額 | `1301.BK.getAccountBalance()` |
| POST | `/accounts/{id}/balance/adjust` | 調整帳戶餘額 | `1301.BK.adjustBalance()` |
| GET | `/accounts/{id}/transactions` | 查詢帳戶交易記錄 | `1301.BK.getAccountTransactions()` |
| GET | `/accounts/{id}/statistics` | 查詢帳戶統計 | `1301.BK.getAccountStatistics()` |
| POST | `/accounts/batch` | 批次建立帳戶 | `1351.MLS.batchCreateAccounts()` |
| GET | `/accounts/types` | 取得帳戶類型 | `1351.MLS.getAccountTypes()` |

### 3.2 帳戶CRUD端點規範

**GET `/accounts`** - 查詢帳戶列表
```javascript
// 端點職責：接收帳戶查詢請求並轉發至BL層
// BL層函數：1351.MLS.getAccountList(queryParams)
// 回應格式：遵循8088統一回應規範

Query Parameters:
- ledgerId: 帳本ID篩選
- type: 帳戶類型篩選 (cash/bank/creditCard/investment)
- active: 啟用狀態篩選 (true/false)
- page: 頁碼 (預設: 1)
- limit: 每頁筆數 (預設: 20)

Response (成功):
{
  "success": true,
  "data": {
    "accounts": [
      {
        "id": "account-uuid-001",
        "ledgerId": "ledger-uuid-001",
        "name": "現金帳戶",
        "type": "cash",
        "currency": "TWD",
        "currentBalance": 15000,
        "initialBalance": 10000,
        "isActive": true,
        "lastTransactionDate": "2025-09-19T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 5,
      "totalPages": 1,
      "hasNext": false,
      "hasPrev": false
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

**POST `/accounts`** - 建立新帳戶
```javascript
// 轉發至：1351.MLS.createAccount(accountData)
Request Body:
{
  "ledgerId": "ledger-uuid-001",
  "name": "銀行帳戶",
  "type": "bank",
  "currency": "TWD",
  "initialBalance": 50000,
  "description": "主要銀行帳戶",
  "settings": {
    "overdraftLimit": 10000,
    "alertThreshold": 1000
  }
}

Response (成功):
{
  "success": true,
  "data": {
    "accountId": "account-uuid-002",
    "ledgerId": "ledger-uuid-001",
    "name": "銀行帳戶",
    "type": "bank",
    "currency": "TWD",
    "currentBalance": 50000,
    "initialBalance": 50000,
    "createdAt": "2025-09-19T10:00:00Z"
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_789",
    "userMode": "Expert"
  }
}
```

### 3.3 帳戶餘額管理端點規範

**GET `/accounts/{id}/balance`** - 查詢帳戶餘額
```javascript
// 轉發至：1301.BK.getAccountBalance(accountId, queryParams)
Path Parameters:
- id: 帳戶ID

Query Parameters:
- asOfDate: 指定日期的餘額 (可選)
- includeProjected: 包含預計餘額 (true/false)

Response (成功):
{
  "success": true,
  "data": {
    "accountId": "account-uuid-001",
    "currentBalance": 25000,
    "availableBalance": 23000,
    "projectedBalance": 22000,
    "lastUpdated": "2025-09-19T09:30:00Z",
    "balanceHistory": [
      {
        "date": "2025-09-01",
        "balance": 20000
      }
    ]
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_123",
    "userMode": "Expert"
  }
}
```

**POST `/accounts/{id}/balance/adjust`** - 調整帳戶餘額
```javascript
// 轉發至：1301.BK.adjustBalance(accountId, adjustmentData)
Request Body:
{
  "amount": 1000,
  "reason": "餘額調整",
  "description": "手動調整帳戶餘額",
  "type": "manual_adjustment"
}

Response (成功):
{
  "success": true,
  "data": {
    "accountId": "account-uuid-001",
    "previousBalance": 25000,
    "adjustmentAmount": 1000,
    "newBalance": 26000,
    "adjustmentId": "adj-uuid-001",
    "processedAt": "2025-09-19T10:00:00Z"
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

---

## 4. 統一回應格式

### 4.1 成功回應格式

所有API端點遵循8088規範的統一回應格式：

```javascript
{
  "success": true,
  "data": {
    // 具體回應數據
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert|Inertial|Cultivation|Guiding",
    "apiVersion": "v1.0.0",
    "processingTimeMs": 150
  }
}
```

### 4.2 HTTP狀態碼使用規範

| 狀態碼 | 使用場景 | 說明 |
|--------|----------|------|
| 200 | 查詢成功 | 成功取得帳戶資料 |
| 201 | 建立成功 | 成功建立帳戶 |
| 204 | 刪除成功 | 成功刪除帳戶，無回應內容 |
| 400 | 請求錯誤 | 參數驗證失敗 |
| 401 | 未授權 | JWT token無效 |
| 403 | 權限不足 | 無權限存取帳戶 |
| 404 | 找不到資源 | 帳戶不存在 |
| 409 | 衝突 | 帳戶名稱重複 |
| 422 | 業務邏輯錯誤 | 餘額不足、帳戶類型錯誤等 |
| 500 | 系統錯誤 | 伺服器內部錯誤 |

---

## 5. 錯誤處理機制

### 5.1 錯誤回應格式

```javascript
{
  "success": false,
  "error": {
    "code": "ACCOUNT_NOT_FOUND",
    "message": "帳戶不存在",
    "field": "accountId",
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "details": {
      "accountId": "account-uuid-001"
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert"
  }
}
```

### 5.2 錯誤碼定義

| 錯誤碼 | HTTP狀態 | 說明 |
|--------|----------|------|
| `VALIDATION_ERROR` | 400 | 請求參數驗證失敗 |
| `UNAUTHORIZED` | 401 | JWT token無效或過期 |
| `INSUFFICIENT_PERMISSIONS` | 403 | 權限不足 |
| `ACCOUNT_NOT_FOUND` | 404 | 帳戶不存在 |
| `DUPLICATE_ACCOUNT_NAME` | 409 | 帳戶名稱重複 |
| `INSUFFICIENT_BALANCE` | 422 | 餘額不足 |
| `INVALID_ACCOUNT_TYPE` | 422 | 無效的帳戶類型 |
| `ACCOUNT_INACTIVE` | 422 | 帳戶已停用 |
| `INTERNAL_SERVER_ERROR` | 500 | 系統內部錯誤 |

---

## 6. 認證授權設計

### 6.1 JWT Token驗證

所有API端點都需要有效的JWT token：

```javascript
// 請求標頭
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-User-Mode: Expert|Inertial|Cultivation|Guiding
```

### 6.2 權限檢查流程

```javascript
1. 驗證JWT token有效性
2. 解析使用者ID與權限
3. 檢查帳本存取權限
4. 驗證帳戶操作權限
5. 記錄存取日誌
6. 繼續轉發至BL層
```

### 6.3 權限層級定義

| 操作類型 | 所需權限 | 說明 |
|----------|----------|------|
| 查詢帳戶 | view | 可檢視帳戶資訊 |
| 建立帳戶 | edit | 可建立新帳戶 |
| 修改帳戶 | edit | 可修改帳戶設定 |
| 刪除帳戶 | admin | 僅帳本管理員可刪除 |
| 調整餘額 | admin | 僅帳本管理員可調整 |

---

## 7. BL層轉發規範

### 7.1 BL層函數對應

| API端點 | BL層模組 | 函數名稱 |
|---------|----------|----------|
| `GET /accounts` | 1351.MLS.js | `getAccountList()` |
| `POST /accounts` | 1351.MLS.js | `createAccount()` |
| `GET /accounts/{id}` | 1351.MLS.js | `getAccountDetail()` |
| `PUT /accounts/{id}` | 1351.MLS.js | `updateAccount()` |
| `DELETE /accounts/{id}` | 1351.MLS.js | `deleteAccount()` |
| `GET /accounts/{id}/balance` | 1301.BK.js | `getAccountBalance()` |
| `POST /accounts/{id}/balance/adjust` | 1301.BK.js | `adjustBalance()` |
| `GET /accounts/{id}/transactions` | 1301.BK.js | `getAccountTransactions()` |
| `POST /accounts/batch` | 1351.MLS.js | `batchCreateAccounts()` |

### 7.2 轉發機制實作

```javascript
// 轉發至BL層的標準流程
const result = await BLModule.functionName({
  userId: req.user.id,
  userMode: req.headers['x-user-mode'],
  requestData: req.body,
  queryParams: req.query,
  pathParams: req.params
});

// 套用統一回應格式
return formatApiResponse(result, req.headers['x-user-mode']);
```

---

## 8. 四模式支援規範

### 8.1 模式差異化處理

根據`X-User-Mode`標頭調整回應內容：

**Expert Mode（專家模式）**
- 完整的帳戶詳細資訊
- 進階統計與分析數據
- 詳細的餘額歷史記錄
- 完整的設定選項

**Inertial Mode（慣性模式）**
- 標準帳戶資訊
- 基本統計數據
- 簡化的操作選項

**Cultivation Mode（培育模式）**
- 帳戶使用建議
- 理財習慣提示
- 預算管理建議

**Guiding Mode（引導模式）**
- 極簡化帳戶資訊
- 基本操作指引
- 清晰的下一步建議

### 8.2 模式適配實作

```javascript
function adaptAccountResponseForUserMode(data, userMode) {
  switch(userMode) {
    case 'Expert':
      return includeAdvancedMetrics(data);
    case 'Cultivation':
      return addFinancialTips(data);
    case 'Guiding':
      return simplifyAccountInfo(data);
    default:
      return data; // Inertial模式
  }
}
```

---

## 9. 測試規範

### 9.1 API Gateway測試重點

**端點存在性測試**
- 驗證所有定義的端點都可正常存取
- 確認HTTP方法與路徑正確對應

**轉發機制測試**
- 驗證請求正確轉發至BL層函數
- 確認參數傳遞完整性

**回應格式測試**
- 驗證統一回應格式正確性
- 確認錯誤回應格式一致性

**權限控制測試**
- 測試不同權限角色的存取控制
- 驗證JWT token驗證機制

### 9.2 四模式回應測試

**模式差異化測試**
- 驗證不同模式回應內容差異
- 確認模式特定功能正確過濾

**帳戶功能測試**
- 測試帳戶CRUD操作完整性
- 驗證餘額管理機制

### 9.3 整合測試

**端到端測試**
- 從HTTP請求到BL層完整流程測試
- 驗證帳戶管理完整流程

**效能測試**
- 測試大量帳戶查詢效能
- 驗證併發請求處理能力

---

**文件版本**: 2.0.0  
**最後更新**: 2025-09-19  
**重構說明**: 根據DCN-0013計劃，將LLD重構為純API Gateway設計規格，移除API客戶端實作邏輯，專注於RESTful端點定義、統一回應格式與BL層轉發機制