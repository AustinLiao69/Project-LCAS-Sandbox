
# 8204. 帳本管理服務 - API Gateway設計規格

**版本**: 2.0.0  
**建立日期**: 2025-09-04  
**最後更新**: 2025-09-19  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8104. 帳本管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API Gateway架構](#2-api-gateway架構)
### 3. [RESTful端點設計](#3-restful端點設計)
### 4. [統一回應格式](#4-統一回應格式)
### 5. [錯誤處理機制](#5-錯誤處理機制)
### 6. [認證授權設計](#6-認證授權設計)
### 7. [BL層轉發規範](#7-bl層轉發規範)
### 8. [四模式支援規範](#8-四模式支援規範)
### 9. [測試規範](#9-測試規範)

---

## 1. 簡介

### 1.1 設計目的與範圍
帳本管理服務API Gateway提供LCAS 2.0系統帳本管理功能的統一API端點，負責接收HTTP請求並轉發至BL層處理。本文件定義純API Gateway的設計規範，專注於RESTful API端點定義、統一回應格式、錯誤處理與BL層轉發機制。

### 1.2 API Gateway核心職責
- **RESTful端點定義**：提供標準化的API端點
- **統一回應格式**：實作8088規範的統一回應結構
- **請求路由轉發**：將HTTP請求轉發至對應BL層函數
- **認證授權控制**：JWT token驗證與權限檢查
- **錯誤統一處理**：標準化錯誤回應格式
- **四模式差異化**：根據使用者模式調整回應內容

### 1.3 設計遵循規範
- **完全遵循8088 API設計規範**：RESTful設計、統一回應格式
- **對應8104 API規格文件**：確保端點定義完全一致
- **符合0015產品規格書**：APL層作為純API Gateway職責

---

## 2. API Gateway架構

### 2.1 純轉發架構設計
```
┌─────────────────────────────────────────┐
│           HTTP請求層                     │
│         (Express Routes)                │
├─────────────────────────────────────────┤
│           API Gateway層                  │
│      (純轉發，無業務邏輯)                 │
│  ┌─────────────────────────────────────┐ │
│  │  - JWT認證驗證                      │ │
│  │  - 請求參數驗證                      │ │
│  │  - 統一回應格式                      │ │
│  │  - 錯誤處理轉換                      │ │
│  │  └─ BL層函數調用                    │ │
│  └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│              BL層轉發                    │
│         (呼叫13號資料夾模組)              │
│  ┌─────────────────────────────────────┐ │
│  │  1351.MLS.js - 多帳本管理邏輯        │ │
│  │  1313.CM.js - 協作管理邏輯           │ │
│  │  1314.BS.js - 備份服務邏輯           │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 2.2 轉發機制流程
```
HTTP請求 → Express路由 → JWT驗證 → 參數驗證 → BL層調用 → 統一回應格式
     ↓
1. 接收HTTP請求與參數
2. 驗證JWT token有效性  
3. 驗證請求參數格式
4. 調用對應BL層函數
5. 處理BL層回應結果
6. 套用四模式差異化
7. 回傳統一格式JSON
```

---

## 3. RESTful端點設計

### 3.1 API端點總覽

根據8104 API規格文件，帳本管理服務提供以下RESTful端點：

| HTTP方法 | 端點路徑 | 功能描述 | BL層函數 |
|---------|----------|----------|----------|
| GET | `/ledgers` | 查詢帳本列表 | `1351.MLS.getLedgerList()` |
| POST | `/ledgers` | 建立新帳本 | `1351.MLS.createLedger()` |
| GET | `/ledgers/{id}` | 取得帳本詳情 | `1351.MLS.getLedgerDetail()` |
| PUT | `/ledgers/{id}` | 更新帳本設定 | `1351.MLS.updateLedger()` |
| DELETE | `/ledgers/{id}` | 刪除帳本 | `1351.MLS.deleteLedger()` |
| GET | `/ledgers/{id}/collaborators` | 取得協作者列表 | `1313.CM.getCollaborators()` |
| POST | `/ledgers/{id}/collaborators` | 邀請協作者 | `1313.CM.inviteCollaborator()` |
| PUT | `/ledgers/{id}/collaborators/{userId}` | 更新協作者權限 | `1313.CM.updatePermission()` |
| DELETE | `/ledgers/{id}/collaborators/{userId}` | 移除協作者 | `1313.CM.removeCollaborator()` |
| POST | `/ledgers/{id}/backup` | 建立帳本備份 | `1314.BS.createBackup()` |
| GET | `/ledgers/{id}/backup/history` | 查詢備份歷史 | `1314.BS.getBackupHistory()` |
| POST | `/ledgers/{id}/restore` | 還原帳本備份 | `1314.BS.restoreBackup()` |

### 3.2 帳本CRUD端點規範

**GET `/ledgers`** - 查詢帳本列表
```javascript
// 端點職責：接收帳本查詢請求並轉發至BL層
// BL層函數：1351.MLS.getLedgerList(queryParams)
// 回應格式：遵循8088統一回應規範

Query Parameters:
- type: 帳本類型篩選 (personal/shared/team)
- active: 啟用狀態篩選 (true/false)
- page: 頁碼 (預設: 1)
- limit: 每頁筆數 (預設: 20)

Response (成功):
{
  "success": true,
  "data": {
    "ledgers": [
      {
        "id": "ledger-uuid-001",
        "name": "個人帳本",
        "type": "personal",
        "description": "我的個人記帳",
        "isActive": true,
        "collaboratorCount": 1,
        "lastActivity": "2025-09-19T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 5,
      "totalPages": 1,
      "hasNext": false,
      "hasPrev": false
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

**POST `/ledgers`** - 建立新帳本
```javascript
// 轉發至：1351.MLS.createLedger(ledgerData)
Request Body:
{
  "name": "家庭帳本",
  "type": "shared",
  "description": "家庭共同記帳",
  "currency": "TWD",
  "settings": {
    "autoBackup": true,
    "notificationEnabled": true
  }
}

Response (成功):
{
  "success": true,
  "data": {
    "ledgerId": "ledger-uuid-002",
    "name": "家庭帳本",
    "type": "shared",
    "currency": "TWD",
    "createdAt": "2025-09-19T10:00:00Z",
    "role": "owner"
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_789",
    "userMode": "Expert"
  }
}
```

### 3.3 協作管理端點規範

**GET `/ledgers/{id}/collaborators`** - 取得協作者列表
```javascript
// 轉發至：1313.CM.getCollaborators(ledgerId, queryParams)
Path Parameters:
- id: 帳本ID

Response (成功):
{
  "success": true,
  "data": {
    "collaborators": [
      {
        "userId": "user-uuid-001",
        "displayName": "張三",
        "email": "zhang@example.com",
        "role": "owner",
        "permissions": ["read", "write", "admin"],
        "joinedAt": "2025-01-01T00:00:00Z",
        "lastActive": "2025-09-19T09:00:00Z"
      }
    ],
    "invitations": [
      {
        "invitationId": "inv-uuid-001",
        "email": "li@example.com",
        "role": "editor",
        "status": "pending",
        "invitedAt": "2025-09-18T10:00:00Z",
        "expiresAt": "2025-09-25T10:00:00Z"
      }
    ]
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_123",
    "userMode": "Expert"
  }
}
```

**POST `/ledgers/{id}/collaborators`** - 邀請協作者
```javascript
// 轉發至：1313.CM.inviteCollaborator(ledgerId, invitationData)
Request Body:
{
  "email": "new@example.com",
  "role": "editor",
  "permissions": ["read", "write"],
  "message": "邀請你一起記帳"
}

Response (成功):
{
  "success": true,
  "data": {
    "invitationId": "inv-uuid-002",
    "email": "new@example.com",
    "role": "editor",
    "status": "sent",
    "expiresAt": "2025-09-26T10:00:00Z"
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

---

## 4. 統一回應格式

### 4.1 成功回應格式

所有API端點遵循8088規範的統一回應格式：

```javascript
{
  "success": true,
  "data": {
    // 具體回應數據
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert|Inertial|Cultivation|Guiding",
    "apiVersion": "v1.0.0",
    "processingTimeMs": 150
  }
}
```

### 4.2 HTTP狀態碼使用規範

| 狀態碼 | 使用場景 | 說明 |
|--------|----------|------|
| 200 | 查詢成功 | 成功取得資料 |
| 201 | 建立成功 | 成功建立帳本或邀請 |
| 204 | 刪除成功 | 成功刪除，無回應內容 |
| 400 | 請求錯誤 | 參數驗證失敗 |
| 401 | 未授權 | JWT token無效 |
| 403 | 權限不足 | 無權限存取帳本 |
| 404 | 找不到資源 | 帳本不存在 |
| 409 | 衝突 | 帳本名稱重複、已邀請等 |
| 422 | 業務邏輯錯誤 | BL層邏輯驗證失敗 |
| 500 | 系統錯誤 | 伺服器內部錯誤 |

---

## 5. 錯誤處理機制

### 5.1 錯誤回應格式

```javascript
{
  "success": false,
  "error": {
    "code": "LEDGER_NOT_FOUND",
    "message": "帳本不存在",
    "field": "ledgerId",
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "details": {
      "ledgerId": "ledger-uuid-001"
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert"
  }
}
```

### 5.2 錯誤碼定義

| 錯誤碼 | HTTP狀態 | 說明 |
|--------|----------|------|
| `VALIDATION_ERROR` | 400 | 請求參數驗證失敗 |
| `UNAUTHORIZED` | 401 | JWT token無效或過期 |
| `INSUFFICIENT_PERMISSIONS` | 403 | 權限不足 |
| `LEDGER_NOT_FOUND` | 404 | 帳本不存在 |
| `COLLABORATOR_NOT_FOUND` | 404 | 協作者不存在 |
| `DUPLICATE_LEDGER_NAME` | 409 | 帳本名稱重複 |
| `ALREADY_INVITED` | 409 | 已邀請該用戶 |
| `BUSINESS_LOGIC_ERROR` | 422 | 業務邏輯驗證失敗 |
| `BACKUP_FAILED` | 422 | 備份操作失敗 |
| `INTERNAL_SERVER_ERROR` | 500 | 系統內部錯誤 |

---

## 6. 認證授權設計

### 6.1 JWT Token驗證

所有API端點都需要有效的JWT token：

```javascript
// 請求標頭
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-User-Mode: Expert|Inertial|Cultivation|Guiding
```

### 6.2 權限檢查流程

```javascript
1. 驗證JWT token有效性
2. 解析使用者ID與權限
3. 檢查帳本存取權限
4. 驗證操作權限層級
5. 記錄存取日誌
6. 繼續轉發至BL層
```

### 6.3 權限層級定義

| 角色 | 權限 | 說明 |
|------|------|------|
| owner | 完整權限 | 帳本擁有者，所有操作 |
| admin | 管理權限 | 可管理協作者，不可刪除帳本 |
| editor | 編輯權限 | 可編輯記錄，不可管理協作者 |
| viewer | 檢視權限 | 僅可檢視記錄 |

---

## 7. BL層轉發規範

### 7.1 BL層函數對應

| API端點 | BL層模組 | 函數名稱 |
|---------|----------|----------|
| `GET /ledgers` | 1351.MLS.js | `getLedgerList()` |
| `POST /ledgers` | 1351.MLS.js | `createLedger()` |
| `GET /ledgers/{id}` | 1351.MLS.js | `getLedgerDetail()` |
| `PUT /ledgers/{id}` | 1351.MLS.js | `updateLedger()` |
| `DELETE /ledgers/{id}` | 1351.MLS.js | `deleteLedger()` |
| `GET /ledgers/{id}/collaborators` | 1313.CM.js | `getCollaborators()` |
| `POST /ledgers/{id}/collaborators` | 1313.CM.js | `inviteCollaborator()` |
| `PUT /ledgers/{id}/collaborators/{userId}` | 1313.CM.js | `updatePermission()` |
| `DELETE /ledgers/{id}/collaborators/{userId}` | 1313.CM.js | `removeCollaborator()` |
| `POST /ledgers/{id}/backup` | 1314.BS.js | `createBackup()` |

### 7.2 轉發機制實作

```javascript
// 轉發至BL層的標準流程
const result = await BLModule.functionName({
  userId: req.user.id,
  userMode: req.headers['x-user-mode'],
  requestData: req.body,
  queryParams: req.query,
  pathParams: req.params
});

// 套用統一回應格式
return formatApiResponse(result, req.headers['x-user-mode']);
```

---

## 8. 四模式支援規範

### 8.1 模式差異化處理

根據`X-User-Mode`標頭調整回應內容：

**Expert Mode（專家模式）**
- 完整的協作者詳細資訊
- 進階權限管理功能
- 詳細的備份統計資料
- 完整的審計日誌

**Inertial Mode（慣性模式）**
- 標準帳本功能
- 基本協作者資訊
- 簡化的權限設定

**Cultivation Mode（培育模式）**
- 帳本使用建議
- 協作最佳實務提示
- 記帳習慣追蹤

**Guiding Mode（引導模式）**
- 極簡化帳本資訊
- 基本協作功能
- 清晰的操作指引

### 8.2 模式適配實作

```javascript
function adaptLedgerResponseForUserMode(data, userMode) {
  switch(userMode) {
    case 'Expert':
      return includeDetailedMetrics(data);
    case 'Cultivation':
      return addUsageRecommendations(data);
    case 'Guiding':
      return simplifyLedgerInfo(data);
    default:
      return data; // Inertial模式
  }
}
```

---

## 9. 測試規範

### 9.1 API Gateway測試重點

**端點存在性測試**
- 驗證所有定義的端點都可正常存取
- 確認HTTP方法與路徑正確對應

**轉發機制測試**
- 驗證請求正確轉發至BL層函數
- 確認參數傳遞完整性

**回應格式測試**
- 驗證統一回應格式正確性
- 確認錯誤回應格式一致性

**權限控制測試**
- 測試不同角色的權限驗證
- 驗證越權操作阻擋機制

### 9.2 四模式回應測試

**模式差異化測試**
- 驗證不同模式回應內容差異
- 確認模式特定功能正確過濾

**協作功能測試**
- 測試邀請流程完整性
- 驗證權限變更機制

### 9.3 整合測試

**端到端測試**
- 從HTTP請求到BL層完整流程測試
- 驗證帳本管理完整流程

**備份還原測試**
- 測試備份建立機制
- 驗證還原流程正確性

---

**文件版本**: 2.0.0  
**最後更新**: 2025-09-19  
**重構說明**: 根據DCN-0013計劃，將LLD重構為純API Gateway設計規格，移除API客戶端實作邏輯，專注於RESTful端點定義、統一回應格式與BL層轉發機制
