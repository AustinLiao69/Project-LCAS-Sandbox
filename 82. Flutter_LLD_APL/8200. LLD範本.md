# LCAS 2.0 認證服務 API - Low Level Design (LLD)

## 版本資訊
- 文件版本: 1.0
- API 版本: 1.1.0
- 日期: 2025-08-27
- 作者: LCAS 開發團隊

---

## 目錄
1. 簡介
2. 架構設計
3. 模組與類別設計
4. API 詳細實作設計
5. 資料庫設計
6. 安全與驗證
7. 錯誤處理
8. 日誌與監控
9. 測試設計
10. 部署與運維

---

## 1. 簡介
- 說明 API 目的與範圍
- 核心功能列表：
  - 使用者註冊 / 登入
  - Google OAuth 登入
  - LINE 帳號綁定
  - 密碼管理（忘記、重設）
  - Token 管理與刷新
  - 多平台帳號整合
- 支援的四種使用者模式: Expert / Inertial / Cultivation / Guiding

---

## 2. 架構設計
- 系統架構圖
- 模組間依賴圖
- API Gateway / Service 層 / Database 層
- 外部服務整合：
  - Google OAuth
  - LINE API

---

## 3. 模組與類別設計
### 3.1 認證模組 (Auth Module)
- 功能:
  - 註冊
  - 登入
  - 登出
  - Token 刷新
- 類別與方法：
  - `AuthService`
    - `register(userDto)`
    - `login(credentials)`
    - `logout(userId, options)`
    - `refreshToken(refreshToken)`
  - `TokenManager`
    - `generateAccessToken(payload)`
    - `generateRefreshToken(payload)`
    - `validateToken(token)`

### 3.2 密碼管理模組 (Password Module)
- 功能:
  - 忘記密碼
  - 驗證重設 Token
  - 重設密碼
- 類別與方法：
  - `PasswordService`
    - `sendResetEmail(email)`
    - `verifyResetToken(token)`
    - `resetPassword(token, newPassword)`

### 3.3 跨平台整合模組 (Multi-Platform Module)
- 功能:
  - LINE / Google 帳號綁定
  - 查詢綁定狀態
- 類別與方法：
  - `BindingService`
    - `bindLine(userId, lineData)`
    - `bindGoogle(userId, googleData)`
    - `getBindingStatus(userId)`

---

## 4. API 詳細實作設計
### 4.1 Endpoint: `/auth/register`
- HTTP Method: POST
- Request Payload Schema
- Response Schema
- 主要邏輯流程:
  1. 驗證請求參數
  2. 檢查 Email 是否已存在
  3. 建立使用者紀錄
  4. 發送驗證信（必要時）
  5. 生成 Token
- 使用者模式差異化流程

### 4.2 Endpoint: `/auth/login`
- 同上，描述登入流程、Token 生成邏輯、模式差異化

### 4.3 Endpoint: `/auth/google-login`
- 描述 OAuth 驗證流程、帳號自動建立邏輯

### 4.4 Endpoint: `/auth/logout`
- 描述 Token 失效策略、選擇性登出流程

### 4.5 Endpoint: `/auth/refresh`
- 描述 Refresh Token 驗證與新 Token 發放

### 4.6 Endpoint: `/auth/forgot-password` / `/auth/reset-password`
- 描述密碼重設流程、Token 驗證、郵件發送策略

### 4.7 Endpoint: `/auth/bind-line` / `/auth/bind-status`
- 描述跨平台帳號綁定與查詢流程

---

## 5. 資料庫設計
- ER 圖
- 主要表格：
  - Users
  - AuthTokens
  - PasswordResetTokens
  - AccountBindings
  - LoginHistory / StreakInfo
- 欄位設計與索引

---

## 6. 安全與驗證
- JWT Token 生成與驗證策略
- Refresh Token 失效與管理
- 密碼加密策略（例如 bcrypt）
- OAuth Token 驗證流程
- 跨平台綁定安全檢查

---

## 7. 錯誤處理
- 錯誤碼規範
- 例外處理流程
- Validation / Server / Conflict 等類型
- JSON Error Response 統一結構

---

## 8. 日誌與監控
- 請求與回應日誌
- Token 使用與刷新日誌
- 綁定與解除綁定日誌
- 監控指標與告警策略

---

## 9. 測試設計
- 單元測試（Unit Test）
- API 測試（Postman / Integration Test）
- 驗證使用者模式差異化
- 邊界條件與異常測試

---

## 10. 部署與運維
- CI/CD 流程
- 環境設定（生產 / 測試）
- 版本管理與回滾策略
- 外部服務依賴與容錯處理

