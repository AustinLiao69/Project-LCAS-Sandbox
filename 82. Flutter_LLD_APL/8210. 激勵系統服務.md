# 8210. 激勵系統服務 - Low Level Design (LLD)

**版本**: 2.2.0  
**建立日期**: 2025-09-05  
**最後更新**: 2025-09-05  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8110. 激勵系統服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
激勵系統服務提供 LCAS 2.0 系統的完整遊戲化激勵功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **成就系統模組**：成就徽章、解鎖條件、進度追蹤
- **等級經驗模組**：使用者等級、經驗值計算、升級獎勵
- **任務挑戰模組**：每日任務、週期挑戰、自訂目標
- **排行榜模組**：競賽排名、社交比較、階段性競賽
- **獎勵積分模組**：積分獲得、兌換機制、虛擬商店

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8110. 激勵系統服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│      (GamificationController)           │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │AchievementSvc│ LevelSvc   │ QuestSvc│ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │RewardEngine │ ProgressTracker     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
GamificationController
    ├─ depends on ──→ AchievementService
    ├─ depends on ──→ LevelService
    ├─ depends on ──→ QuestService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

AchievementService
    ├─ depends on ──→ AchievementRepository
    ├─ depends on ──→ RewardEngine
    └─ depends on ──→ ProgressTracker
```

---

## 3. 模組與類別設計

### 3.1 GamificationController 類別設計

#### 3.1.1 類別職責
- 處理所有激勵系統相關的HTTP請求
- 協調Service層處理業務邏輯
- 確保四模式差異化回應
- 統一錯誤處理與回應格式

#### 3.1.2 方法簽名規格

**成就系統方法**
```dart
/**
 * 01. 取得使用者成就
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UserAchievementsResponse>> getUserAchievements();

/**
 * 02. 取得成就列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AchievementListResponse>> getAchievementList(AchievementListRequest request);

/**
 * 03. 解鎖成就
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UnlockAchievementResponse>> unlockAchievement(String achievementId);
```

**等級經驗方法**
```dart
/**
 * 04. 取得使用者等級
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UserLevelResponse>> getUserLevel();

/**
 * 05. 更新經驗值
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UpdateExperienceResponse>> updateExperience(UpdateExperienceRequest request);

/**
 * 06. 取得等級進度
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<LevelProgressResponse>> getLevelProgress();
```

**任務挑戰方法**
```dart
/**
 * 07. 取得任務列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<QuestListResponse>> getQuestList(QuestListRequest request);

/**
 * 08. 接受任務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AcceptQuestResponse>> acceptQuest(String questId);

/**
 * 09. 完成任務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<CompleteQuestResponse>> completeQuest(String questId);
```

**排行榜方法**
```dart
/**
 * 10. 取得排行榜
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<LeaderboardResponse>> getLeaderboard(LeaderboardRequest request);
```

### 3.2 AchievementService 類別設計

#### 3.2.1 類別職責
- 管理成就系統邏輯
- 追蹤成就進度
- 處理成就解鎖條件
- 分發成就獎勵

#### 3.2.2 方法簽名規格

**核心業務方法**
```dart
/**
 * 11. 檢查成就進度
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<List<AchievementProgress>> checkAchievementProgress(String userId, String actionType);

/**
 * 12. 處理成就解鎖
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<AchievementUnlockResult> processAchievementUnlock(String userId, String achievementId);

/**
 * 13. 計算成就進度
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<decimal> calculateAchievementProgress(String userId, AchievementCriteria criteria);
```

**獎勵分發方法**
```dart
/**
 * 14. 分發成就獎勵
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<RewardDistributionResult> distributeAchievementReward(String userId, String achievementId);

/**
 * 15. 計算獎勵積分
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<int> calculateRewardPoints(AchievementType type, AchievementDifficulty difficulty);
```

### 3.3 LevelService 類別設計

#### 3.3.1 類別職責
- 管理使用者等級系統
- 計算經驗值與升級
- 處理等級獎勵分發
- 追蹤等級進度

#### 3.3.2 方法簽名規格

**等級計算方法**
```dart
/**
 * 16. 計算所需經驗值
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<int> calculateRequiredExperience(int targetLevel);

/**
 * 17. 處理等級升級
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<LevelUpResult> processLevelUp(String userId, int newExperience);

/**
 * 18. 取得等級資訊
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<UserLevelInfo> getUserLevelInfo(String userId);
```

### 3.4 QuestService 類別設計

#### 3.4.1 類別職責
- 管理任務系統
- 生成動態任務
- 追蹤任務完成度
- 處理任務獎勵

#### 3.4.2 方法簽名規格

**任務管理方法**
```dart
/**
 * 19. 生成每日任務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<List<QuestEntity>> generateDailyQuests(String userId);

/**
 * 20. 更新任務進度
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<QuestProgressUpdate> updateQuestProgress(String userId, String questId, QuestProgressData data);

/**
 * 21. 檢查任務完成
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<bool> checkQuestCompletion(String userId, String questId);
```

### 3.5 RewardEngine 類別設計

#### 3.5.1 類別職責
- 計算各種獎勵
- 處理獎勵分發邏輯
- 管理積分系統
- 處理特殊獎勵

#### 3.5.2 方法簽名規格

**獎勵計算方法**
```dart
/**
 * 22. 計算行為獎勵
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<RewardCalculation> calculateActionReward(UserAction action, UserProfile userProfile);

/**
 * 23. 分發獎勵
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<RewardDistribution> distributeReward(String userId, Reward reward);

/**
 * 24. 計算連續獎勵
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<StreakReward> calculateStreakReward(String userId, int streakDays);
```

---

## 4. API 設計規格

### 4.1 標準回應格式

**ApiResponse 泛型類別**
```dart
/**
 * 25. API回應基礎類別
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  // 建構子定義
  ApiResponse.success({required T data, required ApiMetadata metadata});
  ApiResponse.error({required ApiError error, required ApiMetadata metadata});

  // 工廠方法
  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata);
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata);

  // JSON 轉換方法
  Map<String, dynamic> toJson();
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT);
}
```

### 4.2 API 端點映射規格

遵循 **8110. 激勵系統服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/gamification/achievements` | GET | `getUserAchievements()` | S-501 |
| `/gamification/achievements/list` | GET | `getAchievementList(AchievementListRequest)` | S-501 |
| `/gamification/achievements/{id}/unlock` | POST | `unlockAchievement(String)` | S-501 |
| `/gamification/level` | GET | `getUserLevel()` | S-501 |
| `/gamification/level/experience` | PUT | `updateExperience(UpdateExperienceRequest)` | S-501 |
| `/gamification/level/progress` | GET | `getLevelProgress()` | S-501 |
| `/gamification/quests` | GET | `getQuestList(QuestListRequest)` | S-501 |
| `/gamification/quests/{id}/accept` | POST | `acceptQuest(String)` | S-501 |
| `/gamification/quests/{id}/complete` | POST | `completeQuest(String)` | S-501 |
| `/gamification/leaderboard` | GET | `getLeaderboard(LeaderboardRequest)` | S-501 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 AchievementListRequest 類別規格

```dart
/**
 * 26. 成就列表請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class AchievementListRequest {
  final AchievementCategory? category;
  final AchievementStatus? status;
  final AchievementDifficulty? difficulty;
  final bool includeProgress;
  final SortBy sortBy;
  final SortOrder sortOrder;

  // 建構子
  AchievementListRequest({...});

  // 驗證方法
  List<ValidationError> validate();

  // 轉換方法
  Map<String, dynamic> toJson();
  static AchievementListRequest fromJson(Map<String, dynamic> json);
}
```

#### 5.1.2 UpdateExperienceRequest 類別規格

```dart
/**
 * 27. 更新經驗值請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class UpdateExperienceRequest {
  final String actionType;
  final int experiencePoints;
  final String? reason;
  final Map<String, dynamic>? metadata;

  // 方法定義
  UpdateExperienceRequest({required actionType, required experiencePoints, ...});
  List<ValidationError> validate();
  Map<String, dynamic> toJson();
  static UpdateExperienceRequest fromJson(Map<String, dynamic> json);
}
```

### 5.2 回應資料模型

#### 5.2.1 UserAchievementsResponse 類別規格

```dart
/**
 * 28. 使用者成就回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class UserAchievementsResponse {
  final List<UserAchievement> unlockedAchievements;
  final List<AchievementProgress> inProgressAchievements;
  final AchievementStatistics statistics;
  final List<RecentUnlock> recentUnlocks;
  final NextAchievement? nextRecommended;

  // 方法定義
  UserAchievementsResponse({required unlockedAchievements, ...});
  Map<String, dynamic> toJson();
  static UserAchievementsResponse fromJson(Map<String, dynamic> json);
}
```

#### 5.2.2 UserLevelResponse 類別規格

```dart
/**
 * 29. 使用者等級回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class UserLevelResponse {
  final int currentLevel;
  final int currentExperience;
  final int experienceToNextLevel;
  final int totalExperienceRequired;
  final decimal progressPercentage;
  final LevelRewards? nextLevelRewards;
  final List<LevelMilestone> milestones;

  // 方法定義
  UserLevelResponse({required currentLevel, required currentExperience, ...});
  Map<String, dynamic> toJson();
  static UserLevelResponse fromJson(Map<String, dynamic> json);
}
```

### 5.3 資料存取層設計

#### 5.3.1 GamificationRepository 介面規格

```dart
/**
 * 30. 激勵系統資料存取介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationRepository {
  Future<List<UserAchievement>> getUserAchievements(String userId);
  Future<UserLevelInfo> getUserLevel(String userId);
  Future<List<QuestEntity>> getUserQuests(String userId);
  Future<UserAchievement> unlockAchievement(String userId, String achievementId);
  Future<UserLevelInfo> updateUserExperience(String userId, int experiencePoints);
  Future<QuestEntity> acceptQuest(String userId, String questId);
  Future<QuestEntity> completeQuest(String userId, String questId);
}
```

#### 5.3.2 UserAchievement 類別規格

```dart
/**
 * 31. 使用者成就實體
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class UserAchievement {
  final String id;
  final String userId;
  final String achievementId;
  final String name;
  final String description;
  final AchievementCategory category;
  final AchievementDifficulty difficulty;
  final int pointsRewarded;
  final DateTime unlockedAt;
  final decimal progressPercentage;
  final bool isCompleted;

  // 方法定義
  UserAchievement({required id, ...});
  Map<String, dynamic> toFirestore();
  static UserAchievement fromFirestore(Map<String, dynamic> data, String id);
  bool isRecentlyUnlocked();
  String getDisplayTitle();
}
```

---

## 6. 安全與驗證設計

### 6.1 驗證服務設計

#### 6.1.1 GamificationValidationService 類別規格

```dart
/**
 * 32. 激勵系統驗證服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationValidationService {
  Future<ValidationResult> validateExperienceUpdate(String userId, int experiencePoints);
  Future<ValidationResult> validateAchievementUnlock(String userId, String achievementId);
  Future<ValidationResult> validateQuestAcceptance(String userId, String questId);
  bool validateRewardDistribution(Reward reward);
}
```

### 6.2 安全檢查設計

#### 6.2.1 GamificationSecurityService 類別規格

```dart
/**
 * 33. 激勵系統安全服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationSecurityService {
  Future<bool> canAccessGamificationFeatures(String userId);
  Future<bool> canUnlockAchievement(String userId, String achievementId);
  Future<bool> canAcceptQuest(String userId, String questId);
  Future<bool> isExperienceUpdateLegitimate(String userId, ExperienceUpdate update);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤碼定義

#### 7.1.1 GamificationErrorCode 枚舉

```dart
/**
 * 34. 激勵系統錯誤碼枚舉
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
enum GamificationErrorCode {
  ACHIEVEMENT_NOT_FOUND,
  ACHIEVEMENT_ALREADY_UNLOCKED,
  QUEST_NOT_AVAILABLE,
  QUEST_ALREADY_ACCEPTED,
  INVALID_EXPERIENCE_AMOUNT,
  LEVEL_CALCULATION_ERROR,
  REWARD_DISTRIBUTION_FAILED,
  PERMISSION_DENIED
}
```

### 7.2 錯誤處理服務

#### 7.2.1 GamificationErrorHandler 類別規格

```dart
/**
 * 35. 激勵系統錯誤處理器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(GamificationErrorCode code, String message, UserMode userMode);
  String getLocalizedErrorMessage(GamificationErrorCode code, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 GamificationModeConfig 類別規格

```dart
/**
 * 36. 激勵系統模式配置服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationModeConfig {
  GamificationModeSettings getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getRewardSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
}
```

#### 8.1.2 GamificationResponseFilter 類別規格

```dart
/**
 * 37. 激勵系統回應過濾器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含詳細的統計數據和進度分析
- 提供高級成就和挑戰性任務
- 顯示完整的排行榜和競賽資訊

#### 8.2.2 Cultivation Mode 回應特性
- 強調學習成長和習慣養成
- 包含教育性的任務和成就
- 提供個人進步追蹤和鼓勵

#### 8.2.3 Guiding Mode 回應特性
- 極簡化的成就和任務展示
- 隱藏複雜的統計和排名
- 提供直接明瞭的激勵反饋

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**GamificationController 測試規格**
```dart
/**
 * 38. 激勵系統控制器測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationControllerTest {
  void testGetUserAchievementsWithValidUser();
  void testUnlockAchievementWithValidId();
  void testUpdateExperienceWithValidData();
  void testAcceptQuestWithValidId();
}
```

**AchievementService 測試規格**
```dart
/**
 * 39. 成就服務測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AchievementServiceTest {
  void testAchievementProgressCalculation();
  void testAchievementUnlockProcess();
  void testRewardDistribution();
  void testProgressTracking();
}
```

#### 9.1.2 整合測試設計

**Gamification API 整合測試規格**
```dart
/**
 * 40. 激勵系統API整合測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationAPIIntegrationTest {
  void testCompleteGamificationFlow();
  void testAchievementSystem();
  void testLevelSystem();
  void testQuestSystem();
  void testGamificationModeFiltering();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
/**
 * 41. 激勵系統模式測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class GamificationModeTest {
  void testExpertModeResponse();
  void testInertialModeResponse();
  void testCultivationModeResponse();
  void testGuidingModeResponse();
  void testModeResponseConsistency();
  void testRewardAdjustment();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
enum AchievementCategory { finance, habit, social, milestone, special }
enum AchievementStatus { locked, in_progress, unlocked }
enum AchievementDifficulty { easy, normal, hard, legendary }
enum QuestType { daily, weekly, monthly, special }
enum QuestStatus { available, accepted, completed, expired }
enum SortBy { name, difficulty, progress, unlock_date }
enum SortOrder { asc, desc }
enum UserMode { expert, inertial, cultivation, guiding }
```

### B. 介面契約定義

#### B.1 Reward Calculator 基礎介面

```dart
/**
 * 42. 獎勵計算基礎介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class RewardCalculator {
  int calculateExperienceReward(UserAction action);
  int calculatePointsReward(AchievementType type);
  Reward calculateLevelUpReward(int newLevel);
  StreakReward calculateStreakBonus(int streakCount);
}
```

---

**文件完成日期**: 2025-09-05  
**版本**: 2.2.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8110 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計