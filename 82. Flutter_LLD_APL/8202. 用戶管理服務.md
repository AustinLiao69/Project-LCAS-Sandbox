# 8202. 用戶管理服務 - Low Level Design (LLD)

**版本**: 2.0.0  
**建立日期**: 2025-09-02  
**最後更新**: 2025-01-27  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8102. 用戶管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API Gateway架構設計](#2-api-gateway架構設計)
### 3. [API端點設計](#3-api端點設計)
### 4. [統一回應格式](#4-統一回應格式)
### 5. [認證授權機制](#5-認證授權機制)
### 6. [錯誤處理設計](#6-錯誤處理設計)
### 7. [四模式支援設計](#7-四模式支援設計)
### 8. [API Gateway測試策略](#8-api-gateway測試策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
用戶管理服務API Gateway提供LCAS 2.0系統的用戶管理功能RESTful API端點，作為純API Gateway層，負責接收HTTP請求並轉發至Business Layer進行處理。本文件定義API端點規格、轉發機制及Gateway層職責。

### 1.2 API Gateway核心職責
- **API端點定義**：用戶資料管理RESTful API端點
- **請求轉發**：將HTTP請求轉發至BL層對應函數
- **回應格式化**：統一API回應格式
- **認證檢查**：JWT token驗證與授權
- **錯誤處理**：標準化錯誤回應
- **四模式支援**：根據使用者模式調整回應內容

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8102. 用戶管理服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. API Gateway架構設計

### 2.1 Gateway層級架構
```
┌─────────────────────────────────────────┐
│              HTTP Request               │
│            (RESTful API)                │
├─────────────────────────────────────────┤
│            API Gateway Layer            │
│  ┌─────────────┬─────────────────────┐  │
│  │Route Handler│  Response Formatter │  │
│  ├─────────────┼─────────────────────┤  │
│  │Auth Validator│  Error Handler     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Business Layer               │
│         (Function Calls)                │
└─────────────────────────────────────────┘
```

### 2.2 請求處理流程
```
HTTP Request → Route Validation → Auth Check → BL Function Call → Response Format → HTTP Response
```

---

## 3. API端點設計

### 3.1 用戶資料管理端點

#### 3.1.1 取得用戶個人資料
```
GET /users/profile
```
**Gateway職責**：
- 驗證JWT token
- 呼叫 BL.AM.getUserProfile()
- 根據userMode過濾回應
- 格式化回應

**BL函數映射**：`1309.AM.getUserProfile()`

#### 3.1.2 更新用戶個人資料
```
PUT /users/profile
```
**Gateway職責**：
- 驗證JWT token
- 驗證請求格式
- 呼叫 BL.AM.updateUserProfile()
- 格式化回應

**BL函數映射**：`1309.AM.updateUserProfile()`

#### 3.1.3 更新用戶偏好設定
```
PUT /users/preferences
```
**Gateway職責**：
- 驗證JWT token
- 驗證偏好設定格式
- 呼叫 BL.AM.updateUserPreferences()
- 格式化回應

**BL函數映射**：`1309.AM.updateUserPreferences()`

### 3.2 模式評估管理端點

#### 3.2.1 取得模式評估問卷
```
GET /users/assessment-questions
```
**Gateway職責**：
- 驗證JWT token
- 呼叫 BL.AM.getAssessmentQuestions()
- 根據userMode調整問卷內容
- 格式化回應

**BL函數映射**：`1309.AM.getAssessmentQuestions()`

#### 3.2.2 提交模式評估結果
```
POST /users/assessment
```
**Gateway職責**：
- 驗證JWT token
- 驗證評估結果格式
- 呼叫 BL.AM.submitAssessment()
- 格式化回應

**BL函數映射**：`1309.AM.submitAssessment()`

### 3.3 模式管理端點

#### 3.3.1 切換用戶模式
```
PUT /users/mode
```
**Gateway職責**：
- 驗證JWT token
- 驗證模式切換請求
- 呼叫 BL.AM.switchUserMode()
- 更新JWT中的userMode
- 格式化回應

**BL函數映射**：`1309.AM.switchUserMode()`

#### 3.3.2 取得模式預設值
```
GET /users/mode-defaults?mode={mode}
```
**Gateway職責**：
- 驗證JWT token
- 驗證模式參數
- 呼叫 BL.AM.getModeDefaults()
- 格式化回應

**BL函數映射**：`1309.AM.getModeDefaults()`

### 3.4 安全管理端點

#### 3.4.1 更新安全設定
```
PUT /users/security
```
**Gateway職責**：
- 驗證JWT token
- 驗證安全設定格式
- 呼叫 BL.AM.updateSecuritySettings()
- 格式化回應

**BL函數映射**：`1309.AM.updateSecuritySettings()`

#### 3.4.2 PIN碼驗證
```
POST /users/verify-pin
```
**Gateway職責**：
- 驗證JWT token
- 驗證PIN碼格式
- 呼叫 BL.AM.verifyPin()
- 格式化回應

**BL函數映射**：`1309.AM.verifyPin()`

### 3.5 行為分析端點

#### 3.5.1 記錄使用行為追蹤
```
POST /users/behavior-tracking
```
**Gateway職責**：
- 驗證JWT token
- 驗證行為資料格式
- 呼叫 BL.AM.trackUserBehavior()
- 格式化回應

**BL函數映射**：`1309.AM.trackUserBehavior()`

#### 3.5.2 取得模式優化建議
```
GET /users/mode-recommendations
```
**Gateway職責**：
- 驗證JWT token
- 呼叫 BL.AM.getModeRecommendations()
- 根據userMode過濾建議
- 格式化回應

**BL函數映射**：`1309.AM.getModeRecommendations()`

---

## 4. 統一回應格式

### 4.1 成功回應格式

所有API端點遵循8088規範的統一回應格式：

```javascript
{
  "success": true,
  "data": {
    // 具體回應數據
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert|Inertial|Cultivation|Guiding",
    "apiVersion": "v1.0.0",
    "processingTimeMs": 150
  }
}
```

### 4.2 HTTP狀態碼使用規範

| 狀態碼 | 使用場景 | 說明 |
|--------|----------|------|
| 200 | 查詢成功 | 成功取得用戶資料 |
| 201 | 建立成功 | 成功建立資源 |
| 204 | 刪除成功 | 成功刪除，無回應內容 |
| 400 | 請求錯誤 | 參數驗證失敗 |
| 401 | 未授權 | JWT token無效 |
| 403 | 權限不足 | 權限不足 |
| 404 | 找不到資源 | 用戶不存在 |
| 409 | 衝突 | 資料更新衝突 |
| 422 | 業務邏輯錯誤 | BL層邏輯驗證失敗 |
| 500 | 系統錯誤 | 伺服器內部錯誤 |

---

## 5. 認證授權機制

### 5.1 JWT Token驗證
- **Token格式**：Bearer {jwt_token}
- **驗證位置**：Authorization Header
- **Token包含**：userId, userMode, exp, iat

### 5.2 端點權限控制
| 端點 | 認證需求 | 權限檢查 |
|------|----------|----------|
| GET /users/profile | ✅ 需要JWT | 有效用戶 |
| PUT /users/profile | ✅ 需要JWT | 有效用戶 |
| PUT /users/preferences | ✅ 需要JWT | 有效用戶 |
| GET /users/assessment-questions | ✅ 需要JWT | 有效用戶 |
| POST /users/assessment | ✅ 需要JWT | 有效用戶 |
| PUT /users/mode | ✅ 需要JWT | 有效用戶 |
| GET /users/mode-defaults | ✅ 需要JWT | 有效用戶 |
| PUT /users/security | ✅ 需要JWT | 有效用戶 |
| POST /users/verify-pin | ✅ 需要JWT | 有效用戶 |
| POST /users/behavior-tracking | ✅ 需要JWT | 有效用戶 |
| GET /users/mode-recommendations | ✅ 需要JWT | 有效用戶 |

---

## 6. 錯誤處理設計

### 6.1 用戶管理相關錯誤碼

| HTTP狀態碼 | 錯誤碼 | 說明 |
|-----------|--------|------|
| 400 | VALIDATION_ERROR | 請求格式錯誤 |
| 400 | INVALID_DISPLAY_NAME | 顯示名稱格式錯誤 |
| 400 | INVALID_MODE | 無效的用戶模式 |
| 400 | INVALID_PIN | PIN碼格式錯誤 |
| 401 | UNAUTHORIZED | 未授權訪問 |
| 401 | TOKEN_EXPIRED | Token已過期 |
| 403 | INSUFFICIENT_PERMISSIONS | 權限不足 |
| 404 | USER_NOT_FOUND | 用戶不存在 |
| 409 | PROFILE_UPDATE_CONFLICT | 資料更新衝突 |
| 500 | INTERNAL_SERVER_ERROR | 伺服器內部錯誤 |

### 6.2 錯誤處理流程
```
BL Function Error → Gateway Error Mapping → HTTP Status Code → Formatted Error Response
```

---

## 7. 四模式支援設計

### 7.1 模式差異化回應

#### 7.1.1 Expert Mode
- 包含完整的用戶資料和統計資訊
- 提供詳細的行為分析數據
- 顯示進階設定選項
- 包含系統診斷資訊

#### 7.1.2 Inertial Mode
- 標準功能完整回應
- 平衡的資訊詳細度
- 實用的設定選項
- 適中的資料呈現

#### 7.1.3 Cultivation Mode
- 強調學習和成長相關功能
- 包含個人化建議和提示
- 突出習慣養成功能
- 提供進度追蹤資訊

#### 7.1.4 Guiding Mode
- 極簡化的用戶資料
- 隱藏複雜設定選項
- 提供基本必要功能
- 簡化操作流程

### 7.2 模式回應過濾
Gateway根據JWT中的userMode字段，自動過濾回應內容：

```javascript
// 模式回應過濾範例
function filterUserProfileByMode(profileData, userMode) {
  switch(userMode) {
    case 'expert':
      return profileData; // 完整資料
    case 'guiding':
      return {
        displayName: profileData.displayName,
        avatar: profileData.avatar,
        currentMode: profileData.currentMode
      }; // 基本資料
    // ... 其他模式
  }
}
```

---

## 8. API Gateway測試策略

### 8.1 Gateway層測試重點

#### 8.1.1 路由測試
- 驗證所有端點路由正確
- 測試HTTP方法對應
- 檢查參數傳遞

#### 8.1.2 認證測試
- JWT Token驗證
- 權限檢查機制
- Token過期處理

#### 8.1.3 格式化測試
- 成功回應格式一致性
- 錯誤回應格式標準化
- 四模式回應差異化

#### 8.1.4 轉發測試
- BL函數呼叫正確性
- 參數傳遞完整性
- 回應處理正確性

### 8.2 整合測試
- 端到端API測試
- 用戶資料一致性測試
- 模式切換功能測試

---

## 附錄

### A. BL函數映射清單

| API端點 | BL函數 | 說明 |
|---------|--------|------|
| GET /users/profile | 1309.AM.getUserProfile() | 取得用戶資料 |
| PUT /users/profile | 1309.AM.updateUserProfile() | 更新用戶資料 |
| PUT /users/preferences | 1309.AM.updateUserPreferences() | 更新偏好設定 |
| GET /users/assessment-questions | 1309.AM.getAssessmentQuestions() | 取得評估問卷 |
| POST /users/assessment | 1309.AM.submitAssessment() | 提交評估結果 |
| PUT /users/mode | 1309.AM.switchUserMode() | 切換用戶模式 |
| GET /users/mode-defaults | 1309.AM.getModeDefaults() | 取得模式預設值 |
| PUT /users/security | 1309.AM.updateSecuritySettings() | 更新安全設定 |
| POST /users/verify-pin | 1309.AM.verifyPin() | PIN碼驗證 |
| POST /users/behavior-tracking | 1309.AM.trackUserBehavior() | 記錄行為追蹤 |
| GET /users/mode-recommendations | 1309.AM.getModeRecommendations() | 取得模式建議 |

### B. 四模式功能差異表

| 功能 | Expert | Inertial | Cultivation | Guiding |
|------|--------|----------|-------------|---------|
| 詳細統計 | ✅ 完整 | ⚠️ 部分 | ⚠️ 學習相關 | ❌ 隱藏 |
| 進階設定 | ✅ 全部 | ⚠️ 常用 | ⚠️ 習慣相關 | ❌ 基本 |
| 行為分析 | ✅ 詳細 | ⚠️ 摘要 | ✅ 成長導向 | ❌ 隱藏 |
| 個人化建議 | ⚠️ 技術性 | ⚠️ 實用性 | ✅ 教育性 | ✅ 簡單明瞭 |

---

**文件完成日期**: 2025-01-27  
**版本**: 2.0.0  
**維護者**: LCAS SA Team  
**重構說明**: 轉換為純API Gateway設計，移除API客戶端邏輯，專注於端點定義與BL層轉發