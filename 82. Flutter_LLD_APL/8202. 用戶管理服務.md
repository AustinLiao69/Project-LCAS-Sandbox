
# 8202. 用戶管理服務 - Low Level Design (LLD)

**版本**: 1.0.0  
**建立日期**: 2025-09-02  
**最後更新**: 2025-09-02  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8102. 用戶管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
用戶管理服務提供 LCAS 2.0 系統的完整用戶生命週期管理功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **用戶資料管理模組**：個人資料、偏好設定、頭像管理
- **模式評估管理模組**：問卷取得、評估處理、模式推薦
- **模式切換管理模組**：模式變更、預設值配置、適配處理
- **安全設定模組**：PIN碼、生物辨識、隱私模式、應用鎖
- **行為追蹤模組**：使用行為記錄、統計分析、個人化推薦
- **偏好設定模組**：通知偏好、顯示偏好、功能偏好

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8102. 用戶管理服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│         (UserController)                │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │ProfileSvc   │AssessmentSvc│SecuritySvc│ │
│  ├─────────────┼─────────────┼────────┤ │
│  │PreferenceSvc│BehaviorSvc  │ModeSvc │ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │ModeAdapter  │RecommendationEngine │  │
│  ├─────────────┼─────────────────────┤  │
│  │PinValidator │SecurityValidator    │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
UserController
    ├─ depends on ──→ ProfileService
    ├─ depends on ──→ AssessmentService
    ├─ depends on ──→ SecurityService
    ├─ depends on ──→ ModeService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

ProfileService
    ├─ depends on ──→ UserRepository
    ├─ depends on ──→ PreferenceRepository
    └─ depends on ──→ ValidationService

SecurityService
    ├─ depends on ──→ PinValidator
    ├─ depends on ──→ BiometricService
    └─ depends on ──→ SecurityRepository

AssessmentService
    ├─ depends on ──→ QuestionnaireRepository
    ├─ depends on ──→ ModeCalculator
    └─ depends on ──→ UserRepository
```

---

## 3. 模組與類別設計

### 3.1 UserController 類別設計

#### 3.1.1 類別職責
- 統一處理所有用戶管理相關的API請求
- 協調各服務模組完成業務邏輯
- 實作8088規範的統一回應格式
- 處理四模式差異化邏輯

#### 3.1.2 方法簽名規格

**用戶資料管理方法**
```dart
/**
 * 01. 取得用戶個人資料 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UserProfileResponse>> getProfile()

/**
 * 02. 更新用戶個人資料 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UpdateProfileResponse>> updateProfile(UpdateProfileRequest request)

/**
 * 03. 更新用戶偏好設定 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UpdatePreferencesResponse>> updatePreferences(UpdatePreferencesRequest request)
```

**模式評估管理方法**
```dart
/**
 * 04. 取得模式評估問卷 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<AssessmentQuestionsResponse>> getAssessmentQuestions()

/**
 * 05. 提交模式評估結果 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<AssessmentResultResponse>> submitAssessment(SubmitAssessmentRequest request)
```

**模式管理方法**
```dart
/**
 * 06. 切換用戶模式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<SwitchModeResponse>> switchUserMode(SwitchModeRequest request)

/**
 * 07. 取得模式預設值 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<ModeDefaultsResponse>> getModeDefaults(String mode)
```

**安全管理方法**
```dart
/**
 * 08. 更新安全設定 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UpdateSecurityResponse>> updateSecurity(UpdateSecurityRequest request)

/**
 * 09. PIN碼驗證 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<VerifyPinResponse>> verifyPin(VerifyPinRequest request)
```

**行為分析方法**
```dart
/**
 * 10. 記錄使用行為追蹤 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<BehaviorTrackingResponse>> trackBehavior(BehaviorTrackingRequest request)

/**
 * 11. 取得模式優化建議 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<ModeRecommendationsResponse>> getModeRecommendations()
```

**內部輔助方法**
```dart
/**
 * 12. 建構API回應格式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ApiResponse<T> _buildResponse<T>(T data, UserMode userMode, String requestId)

/**
 * 13. 記錄用戶事件 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
void _logUserEvent(String event, Map<String, dynamic> details)

/**
 * 14. 驗證請求格式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ValidationResult _validateRequest(dynamic request)

/**
 * 15. 提取用戶模式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
UserMode _extractUserMode(HttpRequest request)
```

### 3.2 ProfileService 類別設計

#### 3.2.1 類別職責
- 實作用戶資料管理核心業務邏輯
- 處理個人資料的CRUD操作
- 管理用戶偏好設定
- 整合資料層與控制層

#### 3.2.2 方法簽名規格

**用戶資料核心方法**
```dart
/**
 * 16. 處理用戶資料獲取 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<UserProfileResult> processGetProfile(String userId)

/**
 * 17. 處理用戶資料更新 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<UpdateResult> processUpdateProfile(String userId, UpdateProfileRequest request)

/**
 * 18. 處理偏好設定更新 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<PreferenceUpdateResult> processUpdatePreferences(String userId, UpdatePreferencesRequest request)

/**
 * 19. 處理頭像上傳 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<AvatarUploadResult> processAvatarUpload(String userId, String avatarData)
```

**內部業務邏輯方法**
```dart
/**
 * 20. 驗證用戶資料格式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ValidationResult> _validateProfileData(UpdateProfileRequest request)

/**
 * 21. 建立用戶實體 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<UserEntity> _createUserEntity(UpdateProfileRequest request)

/**
 * 22. 更新用戶活動時間 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<void> _updateUserActivity(String userId)

/**
 * 23. 執行安全檢查 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
SecurityCheck _performSecurityCheck(String userId)
```

### 3.3 AssessmentService 類別設計

#### 3.3.1 類別職責
- 管理模式評估問卷的取得與處理
- 計算評估結果並推薦合適模式
- 整合問卷邏輯與模式算法

#### 3.3.2 方法簽名規格

**評估問卷管理方法**
```dart
/**
 * 24. 取得評估問卷題目 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<QuestionnaireResult> getAssessmentQuestionnaire()

/**
 * 25. 處理評估結果提交 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<AssessmentResult> processAssessmentSubmission(String userId, SubmitAssessmentRequest request)

/**
 * 26. 計算模式推薦分數 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ModeScoreResult> calculateModeScores(List<AnswerData> answers)

/**
 * 27. 生成模式推薦結果 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<RecommendationResult> generateModeRecommendation(ModeScoreResult scores)
```

**內部評估邏輯方法**
```dart
/**
 * 28. 驗證問卷回答格式 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ValidationResult _validateAnswers(List<AnswerData> answers)

/**
 * 29. 載入問卷配置 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<QuestionnaireConfig> _loadQuestionnaireConfig()

/**
 * 30. 計算信心度分數 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
double _calculateConfidenceScore(ModeScoreResult scores)
```

### 3.4 SecurityService 類別設計

#### 3.4.1 類別職責
- 管理用戶安全設定的更新與驗證
- 處理PIN碼、生物辨識等安全機制
- 實作隱私模式與應用鎖功能

#### 3.4.2 方法簽名規格

**安全設定管理方法**
```dart
/**
 * 31. 處理安全設定更新 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<SecurityUpdateResult> processSecurityUpdate(String userId, UpdateSecurityRequest request)

/**
 * 32. 處理PIN碼驗證 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<PinVerificationResult> processPinVerification(String userId, VerifyPinRequest request)

/**
 * 33. 處理生物辨識設定 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BiometricSetupResult> processBiometricSetup(String userId, BiometricSetupRequest request)

/**
 * 34. 處理隱私模式設定 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<PrivacyModeResult> processPrivacyModeSetup(String userId, PrivacyModeRequest request)
```

**內部安全邏輯方法**
```dart
/**
 * 35. 驗證PIN碼強度 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
PinStrengthResult _validatePinStrength(String pinCode)

/**
 * 36. 加密PIN碼 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<String> _encryptPin(String pinCode)

/**
 * 37. 檢查安全設定衝突 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
SecurityConflictResult _checkSecurityConflicts(UpdateSecurityRequest request)

/**
 * 38. 更新安全等級 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
SecurityLevel _calculateSecurityLevel(SecuritySettings settings)
```

### 3.5 UserModeAdapter 類別設計

#### 3.5.1 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.5.2 方法簽名規格

**核心適配方法**
```dart
/**
 * 39. 適配回應內容 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
T adaptResponse<T>(T response, UserMode userMode)

/**
 * 40. 適配錯誤回應 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ApiError adaptErrorResponse(ApiError error, UserMode userMode)
```

**具體回應適配方法**
```dart
/**
 * 41. 適配用戶資料回應 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
UserProfileResponse adaptProfileResponse(UserProfileResponse response, UserMode userMode)

/**
 * 42. 適配評估結果回應 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
AssessmentResultResponse adaptAssessmentResponse(AssessmentResultResponse response, UserMode userMode)

/**
 * 43. 適配安全設定回應 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
UpdateSecurityResponse adaptSecurityResponse(UpdateSecurityResponse response, UserMode userMode)
```

**功能選項過濾方法**
```dart
/**
 * 44. 取得可用操作選項 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
List<String> getAvailableActions(UserMode userMode)

/**
 * 45. 過濾回應資料 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Map<String, dynamic> filterResponseData(Map<String, dynamic> data, UserMode userMode)

/**
 * 46. 判斷是否顯示進階選項 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
bool shouldShowAdvancedOptions(UserMode userMode)

/**
 * 47. 判斷是否包含進度追蹤 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
bool shouldIncludeProgressTracking(UserMode userMode)

/**
 * 48. 判斷是否簡化介面 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
bool shouldSimplifyInterface(UserMode userMode)

/**
 * 49. 取得模式特定訊息 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
String getModeSpecificMessage(String baseMessage, UserMode userMode)
```

---

## 4. API 設計規格

### 4.1 API 端點設計規格

本節嚴格遵循 **8088. API設計規範.md** 的規範，實作統一的回應格式、錯誤處理機制，並支援四模式差異化。

#### 4.1.1 統一回應格式設計

**成功回應格式**
```dart
/**
 * 50. API回應類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  ApiResponse.success({required T data, required ApiMetadata metadata})
  ApiResponse.error({required ApiError error, required ApiMetadata metadata})

  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata)
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata)

  Map<String, dynamic> toJson()
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT)
}
```

**ApiMetadata 類別**
```dart
/**
 * 51. API元資料類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class ApiMetadata {
  final DateTime timestamp;
  final String requestId;
  final UserMode userMode;
  final String apiVersion;
  final int processingTimeMs;
  final Map<String, dynamic>? additionalInfo;

  ApiMetadata({...})
  Map<String, dynamic> toJson()
  static ApiMetadata fromJson(Map<String, dynamic> json)
  static ApiMetadata create(UserMode userMode, {Map<String, dynamic>? additionalInfo})
}
```

#### 4.1.2 API 端點映射規格

遵循 **8020. API list.md** 和 **8102. 用戶管理服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/users/profile` | GET | `getProfile()` | S-505 |
| `/users/profile` | PUT | `updateProfile(UpdateProfileRequest)` | S-505 |
| `/users/assessment-questions` | GET | `getAssessmentQuestions()` | S-106 |
| `/users/assessment` | POST | `submitAssessment(SubmitAssessmentRequest)` | S-106 |
| `/users/preferences` | PUT | `updatePreferences(UpdatePreferencesRequest)` | S-505 |
| `/users/security` | PUT | `updateSecurity(UpdateSecurityRequest)` | S-503 |
| `/users/mode` | PUT | `switchUserMode(SwitchModeRequest)` | - |
| `/users/mode-defaults` | GET | `getModeDefaults(String)` | - |
| `/users/behavior-tracking` | POST | `trackBehavior(BehaviorTrackingRequest)` | - |
| `/users/mode-recommendations` | GET | `getModeRecommendations()` | - |
| `/users/verify-pin` | POST | `verifyPin(VerifyPinRequest)` | S-503 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 UpdateProfileRequest 類別規格

**類別定義**
```dart
/**
 * 52. 更新用戶資料請求類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class UpdateProfileRequest {
  final String? displayName;
  final String? avatar;
  final String? language;
  final String? timezone;
  final String? theme;

  UpdateProfileRequest({displayName, avatar, language, timezone, theme})

  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static UpdateProfileRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.2 SubmitAssessmentRequest 類別規格

```dart
/**
 * 53. 提交評估結果請求類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class SubmitAssessmentRequest {
  final String questionnaireId;
  final List<AnswerData> answers;
  final DateTime? completedAt;

  SubmitAssessmentRequest({required questionnaireId, required answers, completedAt})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static SubmitAssessmentRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.3 UpdateSecurityRequest 類別規格

```dart
/**
 * 54. 更新安全設定請求類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class UpdateSecurityRequest {
  final AppLockSettings? appLock;
  final PrivacyModeSettings? privacyMode;
  final BiometricSettings? biometric;
  final TwoFactorSettings? twoFactor;

  UpdateSecurityRequest({appLock, privacyMode, biometric, twoFactor})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static UpdateSecurityRequest fromJson(Map<String, dynamic> json)
}
```

### 5.2 回應資料模型

#### 5.2.1 UserProfileResponse 類別規格

```dart
/**
 * 55. 用戶資料回應類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class UserProfileResponse {
  final String id;
  final String email;
  final String? displayName;
  final String? avatar;
  final UserMode userMode;
  final DateTime createdAt;
  final DateTime? lastLoginAt;

  // Expert/Inertial Mode: 詳細統計
  final UserStatistics? statistics;

  // Cultivation Mode: 成就與進度
  final UserAchievements? achievements;

  // Expert Mode: 進階設定
  final UserPreferences? preferences;

  // 安全設定
  final SecuritySettings security;

  UserProfileResponse({required id, required email, ...})
  Map<String, dynamic> toJson()
  static UserProfileResponse fromJson(Map<String, dynamic> json)
}
```

#### 5.2.2 AssessmentResultResponse 類別規格

```dart
/**
 * 56. 評估結果回應類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class AssessmentResultResponse {
  final AssessmentResult result;
  final bool applied;
  final String? previousMode;

  AssessmentResultResponse({required result, required applied, previousMode})
  Map<String, dynamic> toJson()
  static AssessmentResultResponse fromJson(Map<String, dynamic> json)
}
```

### 5.3 資料存取層設計

#### 5.3.1 UserRepository 介面規格

```dart
/**
 * 57. 用戶資料存取介面 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class UserRepository {
  Future<UserEntity?> findById(String id);
  Future<UserEntity?> findByEmail(String email);
  Future<UserEntity> create(UserEntity user);
  Future<UserEntity> update(UserEntity user);
  Future<void> delete(String id);
  Future<List<UserEntity>> findByMode(UserMode mode);
  Future<UserEntity?> findByAssessmentId(String assessmentId);
}
```

#### 5.3.2 PreferenceRepository 介面規格

```dart
/**
 * 58. 偏好設定資料存取介面 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class PreferenceRepository {
  Future<UserPreferences?> findByUserId(String userId);
  Future<UserPreferences> create(UserPreferences preferences);
  Future<UserPreferences> update(UserPreferences preferences);
  Future<void> delete(String userId);
  Future<UserPreferences> getDefaultPreferences(UserMode mode);
}
```

#### 5.3.3 UserEntity 類別規格

```dart
/**
 * 59. 用戶實體類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class UserEntity {
  final String id;
  final String email;
  final String? displayName;
  final String? avatar;
  final UserMode userMode;
  final bool emailVerified;
  final AccountStatus status;
  final UserPreferences preferences;
  final SecuritySettings security;
  final DateTime createdAt;
  final DateTime updatedAt;
  final DateTime? lastActiveAt;

  UserEntity({required id, required email, ...})
  Map<String, dynamic> toFirestore()
  static UserEntity fromFirestore(Map<String, dynamic> data, String id)
  bool isActive()
  bool canPerformAction(String action)
  UserEntity updateLastActive()
  UserEntity updateMode(UserMode newMode)
}
```

---

## 6. 安全與驗證設計

### 6.1 安全服務設計

#### 6.1.1 SecurityValidator 類別規格

```dart
/**
 * 60. 安全驗證服務 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class SecurityValidator {
  PinStrengthResult validatePinStrength(String pin);
  BiometricSupportResult checkBiometricSupport();
  SecurityConflictResult validateSecuritySettings(UpdateSecurityRequest request);
  PrivacyModeCompatibilityResult checkPrivacyModeCompatibility(PrivacyModeSettings settings);
}
```

#### 6.1.2 PinValidator 類別規格

```dart
/**
 * 61. PIN碼驗證器 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class PinValidator {
  Future<String> encryptPin(String pin);
  Future<bool> verifyPin(String inputPin, String encryptedPin);
  PinStrengthLevel assessPinStrength(String pin);
  bool isValidPinFormat(String pin);
  int getRemainingAttempts(String userId);
  Future<void> recordFailedAttempt(String userId);
  Future<void> resetFailedAttempts(String userId);
  bool isPinLocked(String userId);
  Future<DateTime?> getLockoutTime(String userId);
}
```

### 6.2 驗證規則設計

#### 6.2.1 ValidationService 類別規格

```dart
/**
 * 62. 驗證服務 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class ValidationService {
  List<ValidationError> validateDisplayName(String? displayName);
  List<ValidationError> validateTimezone(String? timezone);
  List<ValidationError> validateLanguage(String? language);
  List<ValidationError> validateTheme(String? theme);
  List<ValidationError> validateUpdateProfileRequest(UpdateProfileRequest request);
  List<ValidationError> validateAssessmentAnswers(List<AnswerData> answers);
  List<ValidationError> validateSecuritySettings(UpdateSecurityRequest request);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤分類體系

遵循 **8088. API設計規範** 的錯誤處理標準：

#### 7.1.1 UserManagementErrorCode 枚舉規格

```dart
/**
 * 63. 用戶管理錯誤碼枚舉 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
enum UserManagementErrorCode {
  // 驗證錯誤 (400)
  validationError,
  invalidDisplayName,
  invalidTimezone,
  invalidLanguage,
  invalidPinFormat,
  invalidAssessmentAnswer,

  // 認證錯誤 (401)
  unauthorized,
  tokenExpired,
  invalidToken,

  // 權限錯誤 (403)
  insufficientPermissions,
  accountDisabled,
  pinLocked,

  // 資源錯誤 (404, 409)
  userNotFound,
  assessmentNotFound,
  conflictingSettings,

  // 業務邏輯錯誤 (422)
  pinTooWeak,
  biometricNotSupported,
  assessmentAlreadyCompleted,
  securitySettingsConflict,

  // 系統錯誤 (500)
  internalServerError,
  databaseError,
  encryptionError;

  int get httpStatusCode
  String getMessage(UserMode userMode)
}
```

#### 7.1.2 ApiError 類別規格

```dart
/**
 * 64. API錯誤類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class ApiError {
  final UserManagementErrorCode code;
  final String message;
  final String? field;
  final DateTime timestamp;
  final String requestId;
  final Map<String, dynamic>? details;

  ApiError({required code, required message, ...})
  Map<String, dynamic> toJson()
  static ApiError fromJson(Map<String, dynamic> json)
  static ApiError create(UserManagementErrorCode code, UserMode userMode, {...})
}
```

### 7.2 錯誤處理服務

#### 7.2.1 ErrorHandler 類別規格

```dart
/**
 * 65. 錯誤處理器 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class ErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(String code, String message, UserMode userMode);
  String getLocalizedErrorMessage(UserManagementErrorCode code, UserMode userMode);
  ApiError createSecurityError(String code, String field, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 ModeConfigService 類別規格

```dart
/**
 * 66. 模式配置服務 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class ModeConfigService {
  ModeConfig getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getDefaultSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
  List<String> getVisibleFields(UserMode mode, String responseType);
  Map<String, dynamic> getModeSpecificMessages(UserMode mode);
}
```

#### 8.1.2 ResponseFilter 類別規格

```dart
/**
 * 67. 回應過濾器 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class ResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
  UserProfileResponse filterProfileResponse(UserProfileResponse response, UserMode mode);
  AssessmentResultResponse filterAssessmentResponse(AssessmentResultResponse response, UserMode mode);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含完整的用戶統計資訊和詳細設定選項
- 提供進階安全設定和客製化功能
- 顯示詳細的評估分析結果

#### 8.2.2 Cultivation Mode 回應特性
- 包含成就系統和進度追蹤資訊
- 提供激勵性訊息和習慣養成引導
- 強調個人成長和目標達成

#### 8.2.3 Guiding Mode 回應特性
- 極簡化的回應內容和操作選項
- 隱藏複雜的技術細節和進階設定
- 提供簡單明瞭的操作指引

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**UserController 測試規格**
```dart
/**
 * 68. UserController測試類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class UserControllerTest {
  void testGetProfileWithValidUser();
  void testGetProfileWithInvalidUser();
  void testUpdateProfileWithValidData();
  void testUpdateProfileWithInvalidData();
  void testSubmitAssessmentWithValidAnswers();
  void testSubmitAssessmentWithInvalidAnswers();
  void testUpdateSecurityWithValidSettings();
  void testUpdateSecurityWithInvalidSettings();
  void testVerifyPinWithValidPin();
  void testVerifyPinWithInvalidPin();
  void testVerifyPinWithLockedAccount();
}
```

**ProfileService 測試規格**
```dart
/**
 * 69. ProfileService測試類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class ProfileServiceTest {
  void testProcessGetProfileWithExistingUser();
  void testProcessGetProfileWithNonExistingUser();
  void testProcessUpdateProfileWithValidData();
  void testProcessUpdateProfileWithConflictingData();
  void testProcessAvatarUploadWithValidImage();
  void testProcessAvatarUploadWithInvalidImage();
}
```

#### 9.1.2 整合測試設計

**API 端點測試規格**
```dart
/**
 * 70. 用戶管理API整合測試類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class UserManagementAPIIntegrationTest {
  void testCompleteProfileUpdateFlow();
  void testCompleteAssessmentFlow();
  void testCompleteSecuritySettingsFlow();
  void testCompleteModeswitchingFlow();
  void testPinVerificationWithLockoutFlow();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
/**
 * 71. 用戶模式測試類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class UserModeTest {
  void testExpertModeProfileResponse();
  void testInertialModeProfileResponse();
  void testCultivationModeProfileResponse();
  void testGuidingModeProfileResponse();
  void testModeSpecificErrorMessages();
  void testModeFeatureFiltering();
  void testModeResponseConsistency();
  void testAssessmentResponseByMode();
  void testSecuritySettingsResponseByMode();
}
```

### 9.3 安全測試設計

#### 9.3.1 安全驗證測試規格

```dart
/**
 * 72. 安全測試類別 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class SecurityTest {
  void testPinEncryptionAndDecryption();
  void testPinStrengthValidation();
  void testPinLockoutMechanism();
  void testBiometricSettingsValidation();
  void testPrivacyModeCompatibility();
  void testSecurityConflictDetection();
  void testSecurityLevelCalculation();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
/**
 * 73. 枚舉類型定義 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
enum UserMode { expert, inertial, cultivation, guiding }
enum AccountStatus { active, inactive, locked, suspended }
enum SecurityLevel { low, medium, high, veryHigh }
enum PinStrengthLevel { weak, fair, good, strong }
enum BiometricType { fingerprint, faceId, voiceId }
enum ValidationErrorType { required, format, length, pattern, conflict }
```

### B. 介面契約定義

#### B.1 Repository 基礎介面

```dart
/**
 * 74. Repository基礎介面 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class BaseRepository<T, ID> {
  Future<T?> findById(ID id);
  Future<T> save(T entity);
  Future<void> delete(ID id);
  Future<List<T>> findAll();
  Future<bool> exists(ID id);
  Future<List<T>> findByQuery(Map<String, dynamic> query);
}
```

#### B.2 業務邏輯服務介面

```dart
/**
 * 75. 業務邏輯服務基礎介面 (完全符合8088規範第5.3節)
 * @version 2025-09-02-V1.0.0
 * @date 2025-09-02 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class BaseService<TRequest, TResponse> {
  Future<TResponse> process(TRequest request);
  Future<ValidationResult> validate(TRequest request);
  Future<void> logOperation(String operation, Map<String, dynamic> details);
  TResponse handleError(Exception error);
}
```

---

**文件完成日期**: 2025-09-02  
**版本**: 1.0.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8102 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計
