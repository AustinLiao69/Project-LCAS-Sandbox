# 8201. 認證服務 - Low Level Design (LLD)

**版本**: 3.0.0  
**建立日期**: 2025-08-29  
**最後更新**: 2025-01-27  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8101. 認證服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API Gateway架構設計](#2-api-gateway架構設計)
### 3. [API端點設計](#3-api端點設計)
### 4. [統一回應格式](#4-統一回應格式)
### 5. [認證授權機制](#5-認證授權機制)
### 6. [錯誤處理設計](#6-錯誤處理設計)
### 7. [四模式支援設計](#7-四模式支援設計)
### 8. [API Gateway測試策略](#8-api-gateway測試策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
認證服務API Gateway提供LCAS 2.0系統的認證功能RESTful API端點，作為純API Gateway層，負責接收HTTP請求並轉發至Business Layer進行處理。本文件定義API端點規格、轉發機制及Gateway層職責。

### 1.2 API Gateway核心職責
- **API端點定義**：標準化RESTful API端點
- **請求轉發**：將HTTP請求轉發至BL層對應函數
- **回應格式化**：統一API回應格式
- **認證檢查**：JWT token驗證與授權
- **錯誤處理**：標準化錯誤回應
- **四模式支援**：根據使用者模式調整回應內容

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8101. 認證服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. API Gateway架構設計

### 2.1 Gateway層級架構
```
┌─────────────────────────────────────────┐
│              HTTP Request               │
│            (RESTful API)                │
├─────────────────────────────────────────┤
│            API Gateway Layer            │
│  ┌─────────────┬─────────────────────┐  │
│  │Route Handler│  Response Formatter │  │
│  ├─────────────┼─────────────────────┤  │
│  │AuthValidator│  Error Handler     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Business Layer               │
│         (Function Calls)                │
└─────────────────────────────────────────┘
```

### 2.2 請求處理流程
```
HTTP Request → Route Validation → Auth Check → BL Function Call → Response Format → HTTP Response
```

---

## 3. API端點設計

### 3.1 認證管理端點

#### 3.1.1 用戶註冊
```
POST /auth/register
```
**Gateway職責**：
- 驗證請求格式
- 呼叫 BL.AM.registerUser()
- 格式化回應

**BL函數映射**：`1309.AM.registerUser()`

#### 3.1.2 用戶登入
```
POST /auth/login
```
**Gateway職責**：
- 驗證登入請求
- 呼叫 BL.AM.authenticateUser()
- 生成JWT token
- 格式化回應

**BL函數映射**：`1309.AM.authenticateUser()`

#### 3.1.3 Google OAuth登入
```
POST /auth/google-login
```
**Gateway職責**：
- 驗證Google token
- 呼叫 BL.AM.processGoogleLogin()
- 生成內部JWT token
- 格式化回應

**BL函數映射**：`1309.AM.processGoogleLogin()`

#### 3.1.4 用戶登出
```
POST /auth/logout
```
**Gateway職責**：
- 驗證JWT token
- 呼叫 BL.AM.logoutUser()
- 撤銷token
- 格式化回應

**BL函數映射**：`1309.AM.logoutUser()`

### 3.2 Token管理端點

#### 3.2.1 Token刷新
```
POST /auth/refresh
```
**Gateway職責**：
- 驗證refresh token
- 呼叫 BL.AM.refreshToken()
- 生成新access token
- 格式化回應

**BL函數映射**：`1309.AM.refreshToken()`

### 3.3 密碼管理端點

#### 3.3.1 忘記密碼
```
POST /auth/forgot-password
```
**Gateway職責**：
- 驗證email格式
- 呼叫 BL.AM.initiateForgotPassword()
- 格式化回應

**BL函數映射**：`1309.AM.initiateForgotPassword()`

#### 3.3.2 驗證重設Token
```
GET /auth/verify-reset-token?token=xxx
```
**Gateway職責**：
- 驗證token格式
- 呼叫 BL.AM.verifyResetToken()
- 格式化回應

**BL函數映射**：`1309.AM.verifyResetToken()`

#### 3.3.3 重設密碼
```
POST /auth/reset-password
```
**Gateway職責**：
- 驗證重設請求
- 呼叫 BL.AM.resetPassword()
- 格式化回應

**BL函數映射**：`1309.AM.resetPassword()`

### 3.4 Email驗證端點

#### 3.4.1 Email驗證
```
POST /auth/verify-email
```
**Gateway職責**：
- 驗證驗證碼格式
- 呼叫 BL.AM.verifyEmail()
- 格式化回應

**BL函數映射**：`1309.AM.verifyEmail()`

### 3.5 跨平台綁定端點

#### 3.5.1 LINE帳號綁定
```
POST /auth/bind-line
```
**Gateway職責**：
- 驗證LINE token
- 呼叫 BL.AM.bindLineAccount()
- 格式化回應

**BL函數映射**：`1309.AM.bindLineAccount()`

#### 3.5.2 綁定狀態查詢
```
GET /auth/bind-status
```
**Gateway職責**：
- 驗證JWT token
- 呼叫 BL.AM.getBindStatus()
- 格式化回應

**BL函數映射**：`1309.AM.getBindStatus()`

---

## 4. 統一回應格式

### 4.1 標準成功回應
```json
{
  "success": true,
  "data": {
    // 具體回應資料
  },
  "metadata": {
    "timestamp": "2025-01-27T10:30:00Z",
    "requestId": "req_12345",
    "userMode": "expert",
    "apiVersion": "1.0.0",
    "processingTimeMs": 150
  },
  "error": null
}
```

### 4.2 標準錯誤回應
```json
{
  "success": false,
  "data": null,
  "metadata": {
    "timestamp": "2025-01-27T10:30:00Z",
    "requestId": "req_12345",
    "userMode": "expert",
    "apiVersion": "1.0.0",
    "processingTimeMs": 50
  },
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "用戶名或密碼錯誤",
    "field": "password",
    "details": {}
  }
}
```

---

## 5. 認證授權機制

### 5.1 JWT Token驗證
- **Token格式**：Bearer {jwt_token}
- **驗證位置**：Authorization Header
- **Token包含**：userId, userMode, exp, iat

### 5.2 端點權限控制
| 端點 | 認證需求 | 權限檢查 |
|------|----------|----------|
| POST /auth/register | ❌ 不需要 | 公開端點 |
| POST /auth/login | ❌ 不需要 | 公開端點 |
| POST /auth/google-login | ❌ 不需要 | 公開端點 |
| POST /auth/logout | ✅ 需要JWT | 有效用戶 |
| POST /auth/refresh | ✅ 需要Refresh Token | Token有效 |
| POST /auth/forgot-password | ❌ 不需要 | 公開端點 |
| GET /auth/verify-reset-token | ❌ 不需要 | 公開端點 |
| POST /auth/reset-password | ❌ 不需要 | 有效Reset Token |
| POST /auth/verify-email | ❌ 不需要 | 有效驗證碼 |
| POST /auth/bind-line | ✅ 需要JWT | 有效用戶 |
| GET /auth/bind-status | ✅ 需要JWT | 有效用戶 |

---

## 6. 錯誤處理設計

### 6.1 認證相關錯誤碼

| HTTP狀態碼 | 錯誤碼 | 說明 |
|-----------|--------|------|
| 400 | VALIDATION_ERROR | 請求格式錯誤 |
| 400 | INVALID_EMAIL | Email格式錯誤 |
| 400 | WEAK_PASSWORD | 密碼強度不足 |
| 401 | UNAUTHORIZED | 未授權訪問 |
| 401 | INVALID_CREDENTIALS | 用戶名或密碼錯誤 |
| 401 | TOKEN_EXPIRED | Token已過期 |
| 401 | TOKEN_INVALID | Token無效 |
| 403 | ACCOUNT_DISABLED | 帳號已停用 |
| 404 | USER_NOT_FOUND | 用戶不存在 |
| 409 | EMAIL_ALREADY_EXISTS | Email已存在 |
| 500 | INTERNAL_SERVER_ERROR | 伺服器內部錯誤 |

### 6.2 錯誤處理流程
```
BL Function Error → Gateway Error Mapping → HTTP Status Code → Formatted Error Response
```

---

## 7. 四模式支援設計

### 7.1 模式差異化回應

#### 7.1.1 Expert Mode
- 包含完整的技術細節和錯誤資訊
- 提供詳細的Token資訊
- 顯示登入歷史和安全設定

#### 7.1.2 Inertial Mode
- 標準功能完整回應
- 平衡的資訊詳細度
- 實用的操作選項

#### 7.1.3 Cultivation Mode
- 強調安全教育和習慣養成
- 包含密碼強度建議
- 提供安全提示

#### 7.1.4 Guiding Mode
- 極簡化的回應內容
- 隱藏技術細節
- 提供簡單明瞭的操作指引

### 7.2 模式回應過濾
Gateway根據JWT中的userMode字段，自動過濾回應內容：

```javascript
// 模式回應過濾範例
function filterResponseByMode(response, userMode) {
  switch(userMode) {
    case 'expert':
      return response; // 完整回應
    case 'guiding':
      return filterForGuiding(response); // 簡化回應
    // ... 其他模式
  }
}
```

---

## 8. API Gateway測試策略

### 8.1 Gateway層測試重點

#### 8.1.1 路由測試
- 驗證所有端點路由正確
- 測試HTTP方法對應
- 檢查參數傳遞

#### 8.1.2 認證測試
- JWT Token驗證
- 權限檢查機制
- Token過期處理

#### 8.1.3 格式化測試
- 成功回應格式一致性
- 錯誤回應格式標準化
- 四模式回應差異化

#### 8.1.4 轉發測試
- BL函數呼叫正確性
- 參數傳遞完整性
- 回應處理正確性

### 8.2 整合測試
- 端到端API測試
- 負載測試
- 安全測試

---

## 附錄

### A. BL函數映射清單

| API端點 | BL函數 | 說明 |
|---------|--------|------|
| POST /auth/register | 1309.AM.registerUser() | 用戶註冊 |
| POST /auth/login | 1309.AM.authenticateUser() | 用戶登入 |
| POST /auth/google-login | 1309.AM.processGoogleLogin() | Google登入 |
| POST /auth/logout | 1309.AM.logoutUser() | 用戶登出 |
| POST /auth/refresh | 1309.AM.refreshToken() | Token刷新 |
| POST /auth/forgot-password | 1309.AM.initiateForgotPassword() | 忘記密碼 |
| GET /auth/verify-reset-token | 1309.AM.verifyResetToken() | 驗證重設Token |
| POST /auth/reset-password | 1309.AM.resetPassword() | 重設密碼 |
| POST /auth/verify-email | 1309.AM.verifyEmail() | Email驗證 |
| POST /auth/bind-line | 1309.AM.bindLineAccount() | LINE綁定 |
| GET /auth/bind-status | 1309.AM.getBindStatus() | 綁定狀態 |

### B. 四模式回應差異表

| 功能 | Expert | Inertial | Cultivation | Guiding |
|------|--------|----------|-------------|---------|
| 技術細節 | ✅ 完整 | ⚠️ 部分 | ❌ 隱藏 | ❌ 隱藏 |
| 錯誤詳情 | ✅ 詳細 | ⚠️ 適中 | ⚠️ 適中 | ❌ 簡化 |
| 安全提示 | ⚠️ 適中 | ⚠️ 適中 | ✅ 強調 | ⚠️ 基本 |
| 操作指引 | ❌ 最少 | ⚠️ 適中 | ✅ 詳細 | ✅ 簡單 |

---

**文件完成日期**: 2025-01-27  
**版本**: 3.0.0  
**維護者**: LCAS SA Team  
**重構說明**: 轉換為純API Gateway設計，移除API客戶端邏輯，專注於端點定義與BL層轉發