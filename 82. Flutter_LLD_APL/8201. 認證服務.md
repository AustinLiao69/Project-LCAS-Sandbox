# LCAS 2.0 認證服務 API - Low Level Design (LLD)

## 版本資訊
- 文件版本: 1.3.0
- API 版本: 1.1.0
- 日期: 2025-01-27
- 作者: LCAS 開發團隊

---

## 目錄
1. 簡介
2. 架構設計
3. 模組與類別設計
4. API 清單
5. API 詳細設計規格
6. 資料模型設計
7. 安全與驗證設計
8. 錯誤處理設計
9. 日誌與監控設計
10. 測試設計策略

---

## 1. 簡介

### 1.1 設計目的與範圍
認證服務 API 提供 LCAS 2.0 系統的完整認證功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，不包含具體程式碼實作。

### 1.2 核心功能模組
- **使用者認證模組**：註冊、登入、登出處理
- **密碼管理模組**：忘記密碼、重設密碼、密碼驗證
- **Token 管理模組**：JWT 生成、驗證、刷新機制
- **OAuth 整合模組**：Google OAuth 登入處理
- **跨平台綁定模組**：LINE 帳號綁定與狀態管理
- **Email 驗證模組**：註冊驗證、地址驗證流程

### 1.3 四模式支援策略
- **Expert**：完整認證選項、詳細安全資訊、進階設定功能
- **Inertial**：標準認證流程、基本安全提示、固定選項配置
- **Cultivation**：引導式認證、安全教育內容、進度追蹤機制
- **Guiding**：極簡認證流程、最少必要步驟、簡化操作介面

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│         Controller Layer                │
│    ┌─────────────────────────────────┐  │
│    │  AuthController                 │  │
│    │  - 統一API入口                  │  │
│    │  - 請求路由分發                 │  │
│    │  - 回應格式統一                 │  │
│    └─────────────────────────────────┘  │
├─────────────────────────────────────────┤
│         Service Layer                   │
│    ┌─────────────────────────────────┐  │
│    │  AuthService                    │  │
│    │  - 認證邏輯處理                 │  │
│    │  - 業務規則執行                 │  │
│    └─────────────────────────────────┘  │
│    ┌─────────────────────────────────┐  │
│    │  OAuthService                   │  │
│    │  - 第三方認證                   │  │
│    └─────────────────────────────────┘  │
│    ┌─────────────────────────────────┐  │
│    │  BindingService                 │  │
│    │  - 平台綁定管理                 │  │
│    └─────────────────────────────────┘  │
├─────────────────────────────────────────┤
│         Utility Layer                   │
│    ┌─────────────────────────────────┐  │
│    │  TokenService                   │  │
│    │  - JWT處理                      │  │
│    └─────────────────────────────────┘  │
│    ┌─────────────────────────────────┐  │
│    │  UserModeAdapter                │  │
│    │  - 四模式適配                   │  │
│    └─────────────────────────────────┘  │
├─────────────────────────────────────────┤
│         Data Access Layer               │
│           (Repository Pattern)          │
└─────────────────────────────────────────┘
```

### 2.2 模組間依賴關係
- **AuthController** → **AuthService, OAuthService, BindingService**
- **AuthService** → **TokenService, UserRepository, EmailService**
- **OAuthService** → **TokenService, GoogleOAuthProvider**
- **BindingService** → **LineAPIClient, BindingRepository**
- **所有服務** → **UserModeAdapter** (四模式支援)

### 2.3 外部服務整合點
- **Google OAuth 2.0**：第三方登入驗證服務
- **LINE API**：帳號綁定與狀態查詢服務
- **Email Service**：驗證信發送服務
- **Firestore**：使用者資料儲存服務

---

## 3. 模組與類別設計

### 3.1 AuthController 類別設計

#### 3.1.1 類別職責
- 統一處理所有認證相關的API請求
- 協調各服務模組完成業務邏輯
- 統一回應格式與錯誤處理
- 實作四模式差異化邏輯

#### 3.1.2 主要方法規格

| 方法名稱 | 輸入參數 | 輸出類型 | 功能描述 |
|----------|----------|----------|----------|
| `register()` | `RegisterRequest` | `Future<ApiResponse<RegisterResponse>>` | 處理使用者註冊請求 |
| `login()` | `LoginRequest` | `Future<ApiResponse<LoginResponse>>` | 處理使用者登入請求 |
| `logout()` | `LogoutRequest` | `Future<ApiResponse<void>>` | 處理使用者登出請求 |
| `refreshToken()` | `String refreshToken` | `Future<ApiResponse<RefreshTokenResponse>>` | 處理Token刷新請求 |
| `forgotPassword()` | `ForgotPasswordRequest` | `Future<ApiResponse<void>>` | 處理忘記密碼請求 |
| `verifyResetToken()` | `String token` | `Future<ApiResponse<VerifyResetTokenResponse>>` | 驗證密碼重設Token |
| `resetPassword()` | `ResetPasswordRequest` | `Future<ApiResponse<void>>` | 處理密碼重設請求 |
| `verifyEmail()` | `VerifyEmailRequest` | `Future<ApiResponse<void>>` | 處理Email驗證請求 |
| `googleLogin()` | `GoogleLoginRequest` | `Future<ApiResponse<LoginResponse>>` | 處理Google OAuth登入 |
| `bindLine()` | `BindLineRequest` | `Future<ApiResponse<BindingResponse>>` | 處理LINE帳號綁定 |
| `getBindStatus()` | - | `Future<ApiResponse<BindingStatusResponse>>` | 查詢綁定狀態 |

#### 3.1.3 錯誤處理策略
- 統一捕獲並轉換服務層異常
- 實作重試機制處理網路異常
- 記錄詳細錯誤日誌供除錯使用

### 3.2 AuthService 類別設計

#### 3.2.1 類別職責
- 實作核心認證業務邏輯
- 管理使用者生命週期
- 整合Token服務與資料層

#### 3.2.2 主要方法規格

| 方法名稱 | 輸入參數 | 輸出類型 | 功能描述 |
|----------|----------|----------|----------|
| `registerUser()` | `RegisterRequest` | `Future<RegisterResponse>` | 註冊新使用者並生成Token |
| `authenticateUser()` | `String email, String password` | `Future<LoginResponse>` | 驗證使用者憑證並生成Token |
| `logoutUser()` | `LogoutRequest` | `Future<void>` | 登出使用者並無效化Token |
| `refreshToken()` | `String refreshToken` | `Future<RefreshTokenResponse>` | 刷新存取Token |
| `sendPasswordResetEmail()` | `String email` | `Future<void>` | 發送密碼重設郵件 |
| `verifyResetToken()` | `String token` | `Future<VerifyResetTokenResponse>` | 驗證重設Token有效性 |
| `resetPassword()` | `String token, String newPassword` | `Future<void>` | 執行密碼重設操作 |
| `verifyEmail()` | `String email, String code` | `Future<void>` | 驗證Email地址 |

#### 3.2.3 業務規則實作
- 密碼強度驗證規則
- 登入失敗次數限制
- Email重複性檢查
- 帳號狀態管理

### 3.3 統一回應格式設計

#### 3.3.1 ApiResponse 類別規格

| 屬性名稱 | 資料類型 | 必填 | 描述 |
|----------|----------|------|------|
| `success` | `boolean` | ✅ | 請求執行結果 |
| `data` | `T?` | ❌ | 實際回應資料（成功時） |
| `metadata` | `ApiMetadata` | ✅ | 請求元資料 |

#### 3.3.2 ApiMetadata 類別規格

| 屬性名稱 | 資料類型 | 必填 | 描述 |
|----------|----------|------|------|
| `timestamp` | `DateTime` | ✅ | 回應產生時間 |
| `requestId` | `String` | ✅ | 請求唯一識別符 |
| `userMode` | `UserMode?` | ❌ | 使用者模式（成功時） |
| `error` | `ApiError?` | ❌ | 錯誤資訊（失敗時） |

### 3.4 統一錯誤處理設計

#### 3.4.1 LCASException 階層設計

```
LCASException (抽象基礎類別)
├── ValidationException (參數驗證錯誤)
├── AuthException (認證相關錯誤)
├── BusinessLogicException (業務邏輯錯誤)
└── InternalServerException (系統內部錯誤)
```

#### 3.4.2 例外類別規格

| 類別名稱 | 主要屬性 | 使用場景 |
|----------|----------|----------|
| `ValidationException` | `code, message, field, validationErrors` | 輸入參數驗證失敗 |
| `AuthException` | `code, message, field` | 認證、授權失敗 |
| `BusinessLogicException` | `code, message, field` | 業務規則違反 |
| `InternalServerException` | `code, message` | 系統內部錯誤 |

#### 3.4.3 標準錯誤碼定義

| 錯誤分類 | 錯誤碼範例 | HTTP狀態碼 |
|----------|------------|------------|
| 驗證錯誤 | `VALIDATION_ERROR`, `INVALID_EMAIL`, `WEAK_PASSWORD` | 400 |
| 認證錯誤 | `UNAUTHORIZED`, `INVALID_CREDENTIALS`, `ACCOUNT_LOCKED` | 401, 423 |
| 資源錯誤 | `EMAIL_ALREADY_EXISTS`, `USER_NOT_FOUND`, `INVALID_RESET_TOKEN` | 409, 404 |
| 系統錯誤 | `INTERNAL_SERVER_ERROR`, `SERVICE_UNAVAILABLE` | 500, 503 |

### 3.5 四模式適配器設計

#### 3.5.1 UserModeAdapter 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.5.2 模式適配方法規格

| 方法名稱 | 輸入參數 | 輸出類型 | 功能描述 |
|----------|----------|----------|----------|
| `adaptLoginResponse()` | `LoginResponse, UserMode` | `LoginResponse` | 登入回應四模式適配 |
| `adaptRegisterResponse()` | `RegisterResponse, UserMode` | `RegisterResponse` | 註冊回應四模式適配 |
| `adaptErrorResponse()` | `ApiError, UserMode` | `ApiError` | 錯誤回應四模式適配 |

#### 3.5.3 模式差異化策略

| 使用者模式 | 資料深度 | 功能選項 | 引導程度 |
|------------|----------|----------|----------|
| **Expert** | 完整詳細資料、進階統計 | 所有功能選項 | 最少引導 |
| **Inertial** | 標準資料、基本統計 | 核心功能選項 | 適度引導 |
| **Cultivation** | 激勵性資料、進度追蹤 | 登入獎勵、進度追蹤 | 主動引導 |
| **Guiding** | 極簡資料、基本訊息 | 最少功能選項 | 最多引導 |

---

## 4. API 清單

### 4.1 認證服務 API 端點總覽

本節列出認證服務的所有 API 端點，嚴格遵循 8020. API list.md 和 8088. API設計規範.md 的規範。

| 端點 | HTTP 方法 | 功能描述 | 對應畫面 | 優先級 |
|------|----------|----------|----------|--------|
| `/auth/register` | POST | 使用者註冊 | S-103 | P1 |
| `/auth/login` | POST | 使用者登入 | S-104 | P1 |
| `/auth/google-login` | POST | Google OAuth 登入 | S-104 | P1 |
| `/auth/logout` | POST | 使用者登出 | - | P1 |
| `/auth/refresh` | POST | 刷新 Token | - | P1 |
| `/auth/forgot-password` | POST | 忘記密碼 | S-105 | P1 |
| `/auth/verify-reset-token` | GET | 驗證重設連結 | S-105 | P1 |
| `/auth/reset-password` | POST | 重設密碼 | S-105 | P1 |
| `/auth/verify-email` | POST | 驗證 Email 地址 | S-103 | P1 |
| `/auth/bind-line` | POST | LINE 綁定 | S-107 | P1 |
| `/auth/bind-status` | GET | 綁定狀態查詢 | S-107 | P1 |

### 4.2 API 設計規範遵循

#### 4.2.1 URL 設計原則
- 遵循 RESTful 架構標準
- 統一使用 `/auth` 前綴
- 動詞形式表示操作行為
- 符合語義化命名規範

#### 4.2.2 HTTP 方法使用規範
- **POST**：狀態變更操作（註冊、登入、登出等）
- **GET**：查詢操作（綁定狀態查詢、Token 驗證）

#### 4.2.3 四模式支援實作
所有 API 端點支援四種使用者模式的差異化回應，通過 `X-User-Mode` 標頭識別：
```http
X-User-Mode: Expert|Inertial|Cultivation|Guiding
```

---

## 5. API 詳細設計規格

### 5.1 使用者註冊 API 設計

#### 5.1.1 端點規格
- **路徑**: `POST /auth/register`
- **功能**: 新使用者註冊處理
- **對應畫面**: S-103 APP 註冊頁

#### 5.1.2 處理流程設計
1. **輸入驗證階段**
   - Email 格式檢查
   - 密碼強度驗證
   - 必填欄位檢查
   - 使用者模式驗證

2. **業務邏輯處理階段**
   - Email 重複性檢查
   - 密碼加密處理
   - 使用者記錄建立
   - 驗證信發送觸發

3. **Token 生成階段**
   - JWT Access Token 生成
   - Refresh Token 生成
   - Token 過期時間設定

4. **回應適配階段**
   - 根據使用者模式調整回應內容
   - 四模式差異化處理

#### 5.1.3 輸入參數規格

| 參數名稱 | 資料類型 | 必填 | 驗證規則 | 描述 |
|----------|----------|------|----------|------|
| `email` | `String` | ✅ | Email格式、長度限制 | 使用者 Email 地址 |
| `password` | `String` | ✅ | 密碼強度規則 | 使用者密碼 |
| `confirmPassword` | `String` | ❌ | 與password一致 | 確認密碼（非Guiding模式） |
| `displayName` | `String` | ❌ | 長度2-50字元 | 顯示名稱（非Guiding模式） |
| `userMode` | `UserMode` | ✅ | 枚舉值驗證 | 使用者模式選擇 |
| `acceptTerms` | `boolean` | ✅ | 必須為true | 同意服務條款 |
| `acceptPrivacy` | `boolean` | ✅ | 必須為true | 同意隱私政策 |

#### 5.1.4 輸出參數規格

| 參數名稱 | 資料類型 | 必填 | 描述 |
|----------|----------|------|------|
| `userId` | `String` | ✅ | 新建使用者唯一識別符 |
| `email` | `String` | ✅ | 註冊使用的Email地址 |
| `userMode` | `UserMode` | ✅ | 使用者選擇的模式 |
| `verificationSent` | `boolean` | ✅ | 是否已發送驗證信 |
| `needsAssessment` | `boolean` | ✅ | 是否需要進行模式評估 |
| `token` | `String` | ✅ | JWT 存取 Token |
| `refreshToken` | `String` | ✅ | JWT 刷新 Token |
| `expiresAt` | `DateTime` | ✅ | Token 過期時間 |

### 5.2 使用者登入 API 設計

#### 5.2.1 端點規格
- **路徑**: `POST /auth/login`
- **功能**: 使用者身份驗證與登入
- **對應畫面**: S-104 APP 登入頁

#### 5.2.2 處理流程設計
1. **認證驗證階段**
   - Email 存在性檢查
   - 密碼正確性驗證
   - 帳號狀態檢查

2. **安全檢查階段**
   - 登入失敗次數檢查
   - 帳號鎖定狀態檢查
   - 裝置資訊記錄

3. **Token 生成階段**
   - 新 Token 對生成
   - 舊 Token 失效處理
   - 登入歷史記錄

4. **四模式適配階段**
   - 根據使用者模式提供不同深度資訊
   -個人化內容生成

#### 5.2.3 四模式差異化設計

| 模式 | 包含資訊 | 特殊功能 |
|------|----------|----------|
| **Expert** | 完整登入歷史、安全資訊、進階選項 | 多裝置管理、安全評分 |
| **Inertial** | 基本使用者資訊、標準功能 | 標準登入流程 |
| **Cultivation** | 連續登入統計、成就進度、激勵內容 | 登入獎勵、進度追蹤 |
| **Guiding** | 極簡確認訊息 | 最簡化流程 |

### 5.3 密碼重設流程設計

#### 5.3.1 完整流程設計
1. **忘記密碼請求** (`POST /auth/forgot-password`)
   - Email 驗證
   - 重設 Token 生成
   - 重設郵件發送

2. **重設連結驗證** (`GET /auth/verify-reset-token`)
   - Token 有效性檢查
   - 過期時間驗證
   - 使用狀態確認

3. **密碼重設執行** (`POST /auth/reset-password`)
   - 新密碼設定
   - Token 無效化
   - 安全日誌記錄

#### 5.3.2 安全設計考量
- Token 單次使用限制
- 時間窗口限制（1小時）
- 重設頻率限制
- 安全審計日誌

### 5.4 Email 驗證流程設計

#### 5.4.1 驗證機制設計
- **驗證碼方式**: 6位數數字驗證碼
- **Token 方式**: 唯一驗證連結Token
- **有效期限**: 24小時
- **重試次數**: 最多5次

#### 5.4.2 處理流程設計
1. 驗證請求接收
2. 驗證碼/Token 檢查
3. Email 狀態更新
4. 確認回應返回

---

## 6. 資料模型設計

### 6.1 Firestore Collection 結構設計

#### 6.1.1 Users Collection 結構

| 欄位名稱 | 資料類型 | 必填 | 索引 | 描述 |
|----------|----------|------|------|------|
| `id` | `String` | ✅ | Primary | 使用者唯一識別符 |
| `email` | `String` | ✅ | Unique | Email地址 |
| `password` | `String` | ✅ | ❌ | 加密後密碼 |
| `displayName` | `String` | ❌ | ❌ | 顯示名稱 |
| `userMode` | `String` | ✅ | Index | 使用者模式 |
| `emailVerified` | `boolean` | ✅ | Index | Email驗證狀態 |
| `status` | `String` | ✅ | Index | 帳號狀態 |
| `authProvider` | `String` | ✅ | ❌ | 認證提供者 |
| `preferences` | `Map` | ✅ | ❌ | 使用者偏好設定 |
| `security` | `Map` | ✅ | ❌ | 安全相關設定 |
| `createdAt` | `Timestamp` | ✅ | Index | 建立時間 |
| `updatedAt` | `Timestamp` | ✅ | ❌ | 更新時間 |
| `lastActiveAt` | `Timestamp` | ❌ | Index | 最後活動時間 |

#### 6.1.2 PasswordResetTokens Collection 結構

| 欄位名稱 | 資料類型 | 必填 | 索引 | 描述 |
|----------|----------|------|------|------|
| `id` | `String` | ✅ | Primary | Token唯一識別符 |
| `email` | `String` | ✅ | Index | 關聯Email地址 |
| `token` | `String` | ✅ | Unique | 重設Token值 |
| `createdAt` | `Timestamp` | ✅ | Index | 建立時間 |
| `expiresAt` | `Timestamp` | ✅ | Index | 過期時間 |
| `used` | `boolean` | ✅ | Index | 使用狀態 |
| `usedAt` | `Timestamp` | ❌ | ❌ | 使用時間 |

#### 6.1.3 EmailVerifications Collection 結構

| 欄位名稱 | 資料類型 | 必填 | 索引 | 描述 |
|----------|----------|------|------|------|
| `id` | `String` | ✅ | Primary | 驗證唯一識別符 |
| `email` | `String` | ✅ | Index | 待驗證Email地址 |
| `verificationCode` | `String` | ✅ | ❌ | 6位數驗證碼 |
| `createdAt` | `Timestamp` | ✅ | Index | 建立時間 |
| `expiresAt` | `Timestamp` | ✅ | Index | 過期時間 |
| `verified` | `boolean` | ✅ | Index | 驗證狀態 |
| `verifiedAt` | `Timestamp` | ❌ | ❌ | 驗證時間 |
| `attempts` | `number` | ✅ | ❌ | 嘗試次數 |

### 6.2 資料關係設計

#### 6.2.1 一對一關係
- User ↔ UserPreferences
- User ↔ SecuritySettings

#### 6.2.2 一對多關係
- User → PasswordResetTokens
- User → EmailVerifications
- User → AuthTokens

#### 6.2.3 資料完整性約束
- Email唯一性約束
- Token過期自動清理
- 級聯刪除規則

---

## 7. 安全與驗證設計

### 7.1 JWT Token 處理設計

#### 7.1.1 Token 結構設計
- **Header**: 演算法資訊（HS256）
- **Payload**: 使用者資訊、權限、過期時間
- **Signature**: 伺服器密鑰簽章

#### 7.1.2 Token 生命週期管理
- **Access Token**: 1小時有效期
- **Refresh Token**: 30天有效期
- **自動刷新**: 5分鐘前觸發
- **吊銷機制**: 主動登出時無效化

#### 7.1.3 Token 驗證流程設計
1. Token 格式檢查
2. 簽章驗證
3. 過期時間檢查
4. 使用者狀態檢查
5. 權限驗證

### 7.2 密碼安全設計

#### 7.2.1 密碼加密策略
- **演算法**: bcrypt
- **Salt輪數**: 12輪
- **密碼強度要求**: 最少8字元、包含大小寫字母、數字

#### 7.2.2 密碼驗證設計
- 即時強度檢查
- 常見密碼黑名單
- 歷史密碼重複檢查

### 7.3 帳號安全機制設計

#### 7.3.1 登入保護機制
- **失敗次數限制**: 5次
- **鎖定時間**: 15分鐘
- **IP位址記錄**: 異常登入檢測
- **裝置指紋**: 新裝置提醒

#### 7.3.2 資料傳輸安全
- **HTTPS**: 強制加密傳輸
- **CORS**: 跨域請求限制
- **CSP**: 內容安全政策
- **Rate Limiting**: 請求頻率限制

---

## 8. 錯誤處理設計

### 8.1 錯誤分類體系

#### 8.1.1 HTTP 狀態碼對應表

| 狀態碼 | 分類 | 使用場景 | 對應錯誤碼 |
|----------|----------|----------|------------|
| 200 | 成功 | 正常請求處理 | - |
| 201 | 建立成功 | 資源創建成功 | - |
| 400 | 請求錯誤 | 參數驗證失敗 | `VALIDATION_ERROR` |
| 401 | 未授權 | 認證失敗 | `UNAUTHORIZED` |
| 403 | 禁止存取 | 權限不足 | `INSUFFICIENT_PERMISSIONS` |
| 404 | 資源不存在 | 查詢不到資料 | `RESOURCE_NOT_FOUND` |
| 409 | 資源衝突 | 重複註冊等 | `DUPLICATE_RESOURCE` |
| 422 | 無法處理 | 業務邏輯錯誤 | `BUSINESS_LOGIC_ERROR` |
| 500 | 伺服器錯誤 | 系統異常 | `INTERNAL_SERVER_ERROR` |

#### 8.1.2 認證服務專用錯誤碼

| 錯誤碼 | HTTP狀態 | 描述 | 處理建議 |
|----------|----------|------|----------|
| `EMAIL_ALREADY_EXISTS` | 409 | Email已被註冊 | 引導至登入頁面 |
| `INVALID_CREDENTIALS` | 401 | 登入憑證錯誤 | 提示重新輸入 |
| `ACCOUNT_LOCKED` | 423 | 帳號被鎖定 | 顯示解鎖時間 |
| `WEAK_PASSWORD` | 400 | 密碼強度不足 | 顯示密碼要求 |
| `INVALID_RESET_TOKEN` | 400 | 重設Token無效 | 重新申請重設 |
| `VERIFICATION_CODE_EXPIRED` | 400 | 驗證碼過期 | 重新發送驗證碼 |

### 8.2 錯誤回應格式設計

#### 8.2.1 統一錯誤回應結構
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "使用者友善的錯誤訊息",
    "field": "發生錯誤的欄位名稱",
    "timestamp": "錯誤發生時間",
    "requestId": "請求唯一識別符",
    "details": {
      "validation": [
        {
          "field": "欄位名稱",
          "message": "驗證錯誤訊息",
          "code": "具體錯誤碼",
          "value": "導致錯誤的值"
        }
      ]
    }
  }
}
```

#### 8.2.2 多語言錯誤訊息設計
- 根據Accept-Language標頭提供對應語言
- 預設繁體中文，支援英文
- 錯誤碼保持英文以便程式處理

### 8.3 錯誤恢復策略設計

#### 8.3.1 客戶端重試機制
- **網路錯誤**: 指數退避重試
- **伺服器錯誤**: 最多3次重試
- **認證錯誤**: 不重試，引導重新登入
- **驗證錯誤**: 不重試，要求修正輸入

#### 8.3.2 降級處理策略
- **服務不可用**: 提供離線模式
- **功能異常**: 隱藏問題功能
- **效能問題**: 簡化回應內容

---

## 9. 日誌與監控設計

### 9.1 日誌記錄策略

#### 9.1.1 日誌分類設計

| 日誌類型 | 記錄內容 | 記錄時機 | 保存期限 |
|----------|----------|----------|----------|
| **認證事件** | 登入、註冊、登出行為 | 每次認證操作 | 1年 |
| **安全事件** | 異常登入、帳號鎖定 | 安全異常發生時 | 2年 |
| **Token事件** | Token生成、刷新、吊銷 | Token操作時 | 6個月 |
| **錯誤事件** | 系統錯誤、業務異常 | 錯誤發生時 | 3個月 |
| **效能事件** | API回應時間、資源使用 | 每次API呼叫 | 1個月 |

#### 9.1.2 日誌欄位設計

| 欄位名稱 | 資料類型 | 必填 | 描述 |
|----------|----------|------|------|
| `timestamp` | `DateTime` | ✅ | 事件發生時間 |
| `level` | `String` | ✅ | 日誌級別（INFO/WARN/ERROR） |
| `event` | `String` | ✅ | 事件類型 |
| `userId` | `String` | ❌ | 使用者識別符（遮罩處理） |
| `email` | `String` | ❌ | Email地址（遮罩處理） |
| `ipAddress` | `String` | ❌ | 客戶端IP地址 |
| `userAgent` | `String` | ❌ | 客戶端資訊 |
| `requestId` | `String` | ✅ | 請求追蹤識別符 |
| `duration` | `number` | ❌ | 操作耗時（毫秒） |
| `details` | `Map` | ❌ | 事件詳細資訊 |

### 9.2 效能監控設計

#### 9.2.1 關鍵指標監控

| 監控指標 | 正常範圍 | 警告閾值 | 嚴重閾值 |
|----------|----------|----------|----------|
| **API回應時間** | < 200ms | > 500ms | > 1000ms |
| **登入成功率** | > 95% | < 90% | < 80% |
| **Token刷新成功率** | > 99% | < 95% | < 90% |
| **錯誤率** | < 1% | > 5% | > 10% |
| **併發使用者數** | 正常範圍 | 接近上限 | 超過上限 |

#### 9.2.2 效能追蹤機制
- 每個API方法執行時間測量
- 資料庫查詢效能追蹤
- 外部服務呼叫監控
- 記憶體使用量監控

### 9.3 警示機制設計

#### 9.3.1 警示觸發條件
- **高頻錯誤**: 5分鐘內錯誤率超過10%
- **效能異常**: API回應時間超過1秒
- **安全異常**: 異常登入嘗試
- **系統異常**: 服務不可用

#### 9.3.2 警示通知方式
- **即時通知**: 關鍵錯誤立即通知
- **定期報告**: 每日效能摘要報告
- **儀表板**: 即時監控儀表板
- **日誌分析**: 定期日誌分析報告

---

## 10. 測試設計策略

### 10.1 測試層級規劃

#### 10.1.1 單元測試設計

| 測試目標 | 測試範圍 | 覆蓋率要求 |
|----------|----------|------------|
| **方法功能** | 每個公開方法 | 90%+ |
| **邊界條件** | 輸入參數邊界值 | 100% |
| **異常處理** | 各種異常情況 | 100% |
| **業務邏輯** | 核心業務規則 | 95%+ |

#### 10.1.2 整合測試設計

| 測試場景 | 測試內容 | 預期結果 |
|----------|----------|----------|
| **完整註冊流程** | 註冊→驗證→登入 | 成功完成 |
| **密碼重設流程** | 申請→驗證→重設→登入 | 成功完成 |
| **四模式差異化** | 不同模式下的API回應 | 內容符合預期 |
| **錯誤處理** | 各種錯誤情況 | 正確錯誤回應 |

#### 10.1.3 效能測試設計

| 測試類型 | 測試條件 | 效能目標 |
|----------|----------|----------|
| **負載測試** | 1000併發使用者 | 回應時間<500ms |
| **壓力測試** | 逐步增加負載至系統極限 | 優雅降級 |
| **耐久測試** | 長時間穩定運行 | 無記憶體洩漏 |
| **尖峰測試** | 突發高併發 | 系統穩定 |

### 10.2 四模式測試策略

#### 10.2.1 模式切換測試
- 使用者模式動態切換
- 回應內容正確適配
- 權限檢查正確執行

#### 10.2.2 模式差異化測試
- 各模式下API回應內容驗證
- 功能選項過濾正確性
- UI元素顯示邏輯

### 10.3 安全測試設計

#### 10.3.1 認證安全測試
- **暴力破解**: 密碼嘗試攻擊防護
- **Session劫持**: Token安全性驗證
- **CSRF攻擊**: 跨站請求偽造防護
- **注入攻擊**: SQL/NoSQL注入防護

#### 10.3.2 資料安全測試
- **敏感資料洩漏**: 日誌中的敏感資訊遮罩
- **權限越權**: 不同角色權限隔離
- **資料完整性**: 傳輸過程資料完整性

### 10.4 自動化測試策略

#### 10.4.1 持續整合測試
- 每次程式碼提交觸發測試
- 測試失敗阻止部署
- 測試覆蓋率報告生成

#### 10.4.2 回歸測試
- 關鍵功能回歸測試套件
- API契約變更檢測
- 效能基準比較

---

## 附錄

### A. 枚舉類型定義

#### A.1 UserMode 枚舉
```
enum UserMode {
  expert,     // 專家模式
  inertial,   // 慣性模式  
  cultivation, // 培育模式
  guiding     // 引導模式
}
```

#### A.2 AccountStatus 枚舉
```
enum AccountStatus {
  active,     // 啟用
  inactive,   // 停用
  locked,     // 鎖定
  suspended   // 暫停
}
```

#### A.3 AuthProvider 枚舉
```
enum AuthProvider {
  email,      // Email註冊
  google,     // Google OAuth
  line        // LINE登入
}
```

### B. 配置參數定義

#### B.1 系統配置常數
- **API基礎URL**: 環境變數配置
- **連線超時**: 30秒
- **Token刷新閾值**: 5分鐘
- **最大重試次數**: 3次
- **密碼最小長度**: 8字元

#### B.2 四模式配置
- **資料快取策略**: 各模式不同快取時間
- **功能開關**: 模式相關功能啟用/停用
- **UI回應速度**: 不同模式的回應時間優化

### C. 技術債務與未來優化

#### C.1 已知限制
- 目前僅支援單一裝置登入
- OAuth僅整合Google，未來需新增更多提供者
- 四模式切換需要重新登入

#### C.2 未來改進方向
- **多重認證**: 實作2FA雙重認證
- **生物辨識**: 整合指紋、Face ID
- **智慧模式**: AI自動推薦最適模式
- **社交登入**: 新增Facebook、Apple登入

---

**文件完成日期**: 2025-01-27  
**版本**: 1.3.0  
**維護者**: LCAS 開發團隊  
**規範遵循**: 完全遵循 8020、8088、8101 文件規範，專注於設計規格而非實作細節