# 8201. 認證服務 - Low Level Design (LLD)

**版本**: 2.2.0  
**建立日期**: 2025-01-27  
**最後更新**: 2025-01-27  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8101. 認證服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
認證服務提供 LCAS 2.0 系統的完整認證功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **使用者認證模組**：註冊、登入、登出處理
- **密碼管理模組**：忘記密碼、重設密碼、密碼驗證
- **Token 管理模組**：JWT 生成、驗證、刷新機制
- **OAuth 整合模組**：Google OAuth 登入處理
- **跨平台綁定模組**：LINE 帳號綁定與狀態管理
- **Email 驗證模組**：註冊驗證、地址驗證流程

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8101. 認證服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│         (AuthController)                │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │ AuthService │OAuthService │BindSvc │ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │ TokenSvc    │ UserModeAdapter     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
AuthController
    ├─ depends on ──→ AuthService
    ├─ depends on ──→ OAuthService
    ├─ depends on ──→ BindingService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

AuthService
    ├─ depends on ──→ TokenService
    ├─ depends on ──→ UserRepository
    └─ depends on ──→ EmailService

TokenService
    ├─ depends on ──→ JwtProvider
    └─ depends on ──→ SecurityService

UserModeAdapter
    ├─ depends on ──→ ModeConfigService
    └─ depends on ──→ ResponseFilter
```

---

## 3. 模組與類別設計

### 3.1 AuthController 類別設計

#### 3.1.1 類別職責
- 統一處理所有認證相關的API請求
- 協調各服務模組完成業務邏輯
- 實作8088規範的統一回應格式
- 處理四模式差異化邏輯

#### 3.1.2 方法簽名規格

**核心認證方法**
```dart
Future<ApiResponse<RegisterResponse>> register(RegisterRequest request)
Future<ApiResponse<LoginResponse>> login(LoginRequest request)
Future<ApiResponse<void>> logout(LogoutRequest request)
Future<ApiResponse<RefreshTokenResponse>> refreshToken(String refreshToken)
```

**密碼管理方法**
```dart
Future<ApiResponse<void>> forgotPassword(ForgotPasswordRequest request)
Future<ApiResponse<VerifyResetTokenResponse>> verifyResetToken(String token)
Future<ApiResponse<void>> resetPassword(ResetPasswordRequest request)
```

**Email驗證方法**
```dart
Future<ApiResponse<void>> verifyEmail(VerifyEmailRequest request)
```

**OAuth方法**
```dart
Future<ApiResponse<LoginResponse>> googleLogin(GoogleLoginRequest request)
```

**跨平台綁定方法**
```dart
Future<ApiResponse<BindingResponse>> bindLine(BindLineRequest request)
Future<ApiResponse<BindingStatusResponse>> getBindStatus()
```

**內部輔助方法**
```dart
ApiResponse<T> _buildResponse<T>(T data, UserMode userMode, String requestId)
void _logAuthEvent(String event, Map<String, dynamic> details)
ValidationResult _validateRequest(dynamic request)
UserMode _extractUserMode(HttpRequest request)
```

### 3.2 AuthService 類別設計

#### 3.2.1 類別職責
- 實作核心認證業務邏輯
- 管理使用者生命週期
- 整合Token服務與資料層
- 執行安全檢查機制

#### 3.2.2 方法簽名規格

**使用者管理核心方法**
```dart
Future<RegisterResult> processRegistration(RegisterRequest request)
Future<LoginResult> authenticateUser(String email, String password)
Future<void> processLogout(LogoutRequest request)
Future<TokenPair> processTokenRefresh(String refreshToken)
```

**密碼管理核心方法**
```dart
Future<void> initiateForgotPassword(String email)
Future<ResetTokenValidation> validateResetToken(String token)
Future<void> executePasswordReset(String token, String newPassword)
```

**Email驗證核心方法**
```dart
Future<void> processEmailVerification(String email, String code)
Future<void> sendVerificationEmail(String email)
```

**內部業務邏輯方法**
```dart
Future<ValidationResult> _validateCredentials(String email, String password)
Future<UserEntity> _createUserEntity(RegisterRequest request)
Future<void> _updateUserActivity(String userId)
SecurityCheck _performSecurityCheck(String userId)
```

### 3.3 TokenService 類別設計

#### 3.3.1 類別職責
- 管理JWT Token的生成、驗證、刷新和撤銷
- 處理Token生命週期管理
- 實作Token安全機制

#### 3.3.2 方法簽名規格

**Token生成方法**
```dart
Future<TokenPair> generateTokenPair(String userId, UserMode userMode)
Future<String> generateAccessToken(String userId, Map<String, dynamic> claims)
Future<String> generateRefreshToken(String userId)
Future<String> generateResetToken(String email)
Future<String> generateEmailVerificationToken(String email)
```

**Token驗證方法**
```dart
Future<TokenValidationResult> validateAccessToken(String token)
Future<TokenValidationResult> validateRefreshToken(String token)
Future<bool> validateResetToken(String token)
Future<bool> validateEmailVerificationToken(String token)
```

**Token管理方法**
```dart
Future<void> revokeToken(String token)
Future<void> revokeAllUserTokens(String userId)
Future<bool> isTokenRevoked(String token)
Future<void> cleanupExpiredTokens()
```

**內部方法**
```dart
Map<String, dynamic> _extractTokenClaims(String token)
bool _isTokenExpired(String token)
String _generateSecureRandomToken()
```

### 3.4 UserModeAdapter 類別設計

#### 3.4.1 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.4.2 方法簽名規格

**核心適配方法**
```dart
T adaptResponse<T>(T response, UserMode userMode)
ApiError adaptErrorResponse(ApiError error, UserMode userMode)
```

**具體回應適配方法**
```dart
LoginResponse adaptLoginResponse(LoginResponse response, UserMode userMode)
RegisterResponse adaptRegisterResponse(RegisterResponse response, UserMode userMode)
```

**功能選項過濾方法**
```dart
List<String> getAvailableActions(UserMode userMode)
Map<String, dynamic> filterResponseData(Map<String, dynamic> data, UserMode userMode)
```

**模式特性方法**
```dart
bool shouldShowAdvancedOptions(UserMode userMode)
bool shouldIncludeProgressTracking(UserMode userMode)
bool shouldSimplifyInterface(UserMode userMode)
String getModeSpecificMessage(String baseMessage, UserMode userMode)
```

---

## 4. API 設計規格

### 4.1 API 端點設計規格

本節嚴格遵循 **8088. API設計規範.md** 的規範，實作統一的回應格式、錯誤處理機制，並支援四模式差異化。

#### 4.1.1 統一回應格式設計

**成功回應格式**
```dart
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  // 建構子定義
  ApiResponse.success({required T data, required ApiMetadata metadata})
  ApiResponse.error({required ApiError error, required ApiMetadata metadata})

  // 工廠方法
  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata)
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata)

  // JSON 轉換方法
  Map<String, dynamic> toJson()
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT)
}
```

**ApiMetadata 類別**
```dart
class ApiMetadata {
  final DateTime timestamp;
  final String requestId;
  final UserMode userMode;
  final String apiVersion;
  final int processingTimeMs;
  final Map<String, dynamic>? additionalInfo;

  // 建構子與方法
  ApiMetadata({...})
  Map<String, dynamic> toJson()
  static ApiMetadata fromJson(Map<String, dynamic> json)
  static ApiMetadata create(UserMode userMode, {Map<String, dynamic>? additionalInfo})
}
```

#### 4.1.2 API 端點映射規格

遵循 **8020. API list.md** 和 **8101. 認證服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/auth/register` | POST | `register(RegisterRequest)` | S-103 |
| `/auth/login` | POST | `login(LoginRequest)` | S-104 |
| `/auth/google-login` | POST | `googleLogin(GoogleLoginRequest)` | S-104 |
| `/auth/logout` | POST | `logout(LogoutRequest)` | - |
| `/auth/refresh` | POST | `refreshToken(String)` | - |
| `/auth/forgot-password` | POST | `forgotPassword(ForgotPasswordRequest)` | S-105 |
| `/auth/verify-reset-token` | GET | `verifyResetToken(String)` | S-105 |
| `/auth/reset-password` | POST | `resetPassword(ResetPasswordRequest)` | S-105 |
| `/auth/verify-email` | POST | `verifyEmail(VerifyEmailRequest)` | S-103 |
| `/auth/bind-line` | POST | `bindLine(BindLineRequest)` | S-107 |
| `/auth/bind-status` | GET | `getBindStatus()` | S-107 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 RegisterRequest 類別規格

**類別定義**
```dart
class RegisterRequest {
  final String email;
  final String password;
  final String? confirmPassword;
  final String? displayName;
  final UserMode userMode;
  final bool acceptTerms;
  final bool acceptPrivacy;
  final String? timezone;
  final String? language;

  // 建構子
  RegisterRequest({required email, required password, ...})

  // 驗證方法
  List<ValidationError> validate()

  // 轉換方法
  Map<String, dynamic> toJson()
  static RegisterRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.2 LoginRequest 類別規格

```dart
class LoginRequest {
  final String email;
  final String password;
  final bool? rememberMe;
  final DeviceInfo? deviceInfo;

  // 方法定義
  LoginRequest({required email, required password, ...})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static LoginRequest fromJson(Map<String, dynamic> json)
}
```

### 5.2 回應資料模型

#### 5.2.1 RegisterResponse 類別規格

```dart
class RegisterResponse {
  final String userId;
  final String email;
  final UserMode userMode;
  final bool verificationSent;
  final bool needsAssessment;
  final String token;
  final String refreshToken;
  final DateTime expiresAt;

  // 方法定義
  RegisterResponse({required userId, ...})
  Map<String, dynamic> toJson()
  static RegisterResponse fromJson(Map<String, dynamic> json)
}
```

#### 5.2.2 LoginResponse 類別規格

```dart
class LoginResponse {
  final String token;
  final String refreshToken;
  final DateTime expiresAt;
  final UserProfile user;
  final Map<String, dynamic>? loginHistory;      // Expert模式專用
  final Map<String, dynamic>? streakInfo;        // Cultivation模式專用
  final String? simpleMessage;                   // Guiding模式專用

  // 方法定義
  LoginResponse({required token, ...})
  Map<String, dynamic> toJson()
  static LoginResponse fromJson(Map<String, dynamic> json)
}
```

### 5.3 資料存取層設計

#### 5.3.1 UserRepository 介面規格

```dart
abstract class UserRepository {
  Future<UserEntity?> findByEmail(String email);
  Future<UserEntity?> findById(String id);
  Future<UserEntity> create(UserEntity user);
  Future<UserEntity> update(UserEntity user);
  Future<void> delete(String id);
  Future<bool> emailExists(String email);
  Future<List<UserEntity>> findByStatus(AccountStatus status);
  Future<UserEntity?> findByProvider(AuthProvider provider, String providerId);
}
```

#### 5.3.2 UserEntity 類別規格

```dart
class UserEntity {
  final String id;
  final String email;
  final String passwordHash;
  final String? displayName;
  final UserMode userMode;
  final bool emailVerified;
  final AccountStatus status;
  final AuthProvider authProvider;
  final UserPreferences preferences;
  final SecuritySettings security;
  final DateTime createdAt;
  final DateTime updatedAt;
  final DateTime? lastActiveAt;

  // 方法定義
  UserEntity({required id, ...})
  Map<String, dynamic> toFirestore()
  static UserEntity fromFirestore(Map<String, dynamic> data, String id)
  bool isActive()
  bool canLogin()
  UserEntity updateLastActive()
}
```

---

## 6. 安全與驗證設計

### 6.1 安全服務設計

#### 6.1.1 SecurityService 類別規格

```dart
abstract class SecurityService {
  Future<String> hashPassword(String password);
  Future<bool> verifyPassword(String password, String hash);
  PasswordStrength assessPasswordStrength(String password);
  bool isPasswordSecure(String password);
  Future<String> generateSecureToken();
  bool validateTokenFormat(String token);
}
```

#### 6.1.2 JwtProvider 類別規格

```dart
abstract class JwtProvider {
  String generateToken(Map<String, dynamic> payload, Duration expiry);
  Map<String, dynamic> verifyToken(String token);
  bool isTokenExpired(String token);
  String extractUserId(String token);
  UserMode extractUserMode(String token);
}
```

### 6.2 驗證規則設計

#### 6.2.1 ValidationService 類別規格

```dart
abstract class ValidationService {
  List<ValidationError> validateEmail(String email);
  List<ValidationError> validatePassword(String password);
  List<ValidationError> validateUserMode(UserMode mode);
  List<ValidationError> validateRegisterRequest(RegisterRequest request);
  List<ValidationError> validateLoginRequest(LoginRequest request);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤分類體系

遵循 **8088. API設計規範** 的錯誤處理標準：

#### 7.1.1 AuthErrorCode 枚舉規格

```dart
enum AuthErrorCode {
  // 驗證錯誤 (400)
  validationError,
  invalidEmail,
  weakPassword,
  passwordMismatch,
  missingRequiredField,

  // 認證錯誤 (401)
  unauthorized,
  invalidCredentials,
  tokenExpired,
  tokenInvalid,
  tokenRevoked,

  // 權限錯誤 (403)
  insufficientPermissions,
  accountDisabled,
  accountNotVerified,

  // 資源錯誤 (404, 409)
  userNotFound,
  emailAlreadyExists,
  invalidResetToken,

  // 系統錯誤 (500)
  internalServerError,
  externalServiceError,
  databaseError;

  // 方法定義
  int get httpStatusCode
  String getMessage(UserMode userMode)
}
```

#### 7.1.2 ApiError 類別規格

```dart
class ApiError {
  final AuthErrorCode code;
  final String message;
  final String? field;
  final DateTime timestamp;
  final String requestId;
  final Map<String, dynamic>? details;

  // 建構子與方法
  ApiError({required code, required message, ...})
  Map<String, dynamic> toJson()
  static ApiError fromJson(Map<String, dynamic> json)
  static ApiError create(AuthErrorCode code, UserMode userMode, {...})
}
```

### 7.2 錯誤處理服務

#### 7.2.1 ErrorHandler 類別規格

```dart
abstract class ErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(String code, String message, UserMode userMode);
  String getLocalizedErrorMessage(AuthErrorCode code, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 ModeConfigService 類別規格

```dart
abstract class ModeConfigService {
  ModeConfig getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getDefaultSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
}
```

#### 8.1.2 ResponseFilter 類別規格

```dart
abstract class ResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含完整的技術細節和錯誤資訊
- 提供進階操作選項
- 顯示詳細的系統狀態

#### 8.2.2 Guiding Mode 回應特性
- 極簡化的回應內容
- 隱藏技術細節
- 提供簡單明瞭的操作指引

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**AuthController 測試規格**
```dart
abstract class AuthControllerTest {
  void testRegisterWithValidInput();
  void testRegisterWithInvalidEmail();
  void testLoginWithValidCredentials();
  void testLoginWithInvalidCredentials();
  void testLogoutWithValidToken();
  void testTokenRefreshWithValidRefreshToken();
}
```

**AuthService 測試規格**
```dart
abstract class AuthServiceTest {
  void testUserRegistrationProcess();
  void testPasswordHashing();
  void testEmailVerificationProcess();
  void testAccountSecurityChecks();
}
```

#### 9.1.2 整合測試設計

**API 端點測試規格**
```dart
abstract class AuthAPIIntegrationTest {
  void testCompleteRegistrationFlow();
  void testCompleteLoginFlow();
  void testPasswordResetFlow();
  void testOAuthIntegrationFlow();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
abstract class UserModeTest {
  void testExpertModeResponse();
  void testInertialModeResponse();
  void testCultivationModeResponse();
  void testGuidingModeResponse();
  void testModeResponseConsistency();
  void testModeFeatureFiltering();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
enum UserMode { expert, inertial, cultivation, guiding }
enum AccountStatus { active, inactive, locked, suspended }
enum AuthProvider { email, google, line }
enum ValidationErrorType { required, format, length, pattern }
```

### B. 介面契約定義

#### B.1 Repository 基礎介面

```dart
abstract class BaseRepository<T, ID> {
  Future<T?> findById(ID id);
  Future<T> save(T entity);
  Future<void> delete(ID id);
  Future<List<T>> findAll();
  Future<bool> exists(ID id);
}
```

---

**文件完成日期**: 2025-01-27  
**版本**: 2.2.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8101 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計