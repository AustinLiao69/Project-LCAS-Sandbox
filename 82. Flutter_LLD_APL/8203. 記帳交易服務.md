
# 8203. 記帳交易服務 - Low Level Design (LLD)

**版本**: 1.0.0  
**建立日期**: 2025-09-04  
**最後更新**: 2025-09-04  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8103. 記帳交易服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
記帳交易服務提供 LCAS 2.0 系統的完整交易記錄管理功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **快速記帳模組**：LINE OA 智慧文字解析記帳
- **交易管理模組**：完整交易 CRUD 操作
- **批次操作模組**：批次新增、修改、刪除交易
- **重複交易模組**：重複記帳設定與執行
- **統計分析模組**：儀表板數據、圖表生成
- **附件管理模組**：圖片上傳、管理與刪除

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8103. 記帳交易服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│      (TransactionController)            │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │TransactionSvc│QuickBookingSvc│BatchSvc│ │
│  ├─────────────┼─────────────┼────────┤ │
│  │StatisticsSvc│AttachmentSvc│RecurringSvc│ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │UserModeAdapter│IntelligentParser   │  │
│  ├─────────────┼─────────────────────┤  │
│  │ChartGenerator│ValidationService   │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
TransactionController
    ├─ depends on ──→ TransactionService
    ├─ depends on ──→ QuickBookingService
    ├─ depends on ──→ BatchOperationService
    ├─ depends on ──→ StatisticsService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

TransactionService
    ├─ depends on ──→ TransactionRepository
    ├─ depends on ──→ ValidationService
    └─ depends on ──→ AttachmentService

QuickBookingService
    ├─ depends on ──→ IntelligentParser
    ├─ depends on ──→ CategoryMatcher
    └─ depends on ──→ TransactionService

StatisticsService
    ├─ depends on ──→ ChartGenerator
    ├─ depends on ──→ TransactionRepository
    └─ depends on ──→ AnalyticsEngine
```

---

## 3. 模組與類別設計

### 3.1 TransactionController 類別設計

#### 3.1.1 類別職責
- 統一處理所有記帳交易相關的API請求
- 協調各服務模組完成業務邏輯
- 實作8088規範的統一回應格式
- 處理四模式差異化邏輯

#### 3.1.2 方法簽名規格

**快速記帳方法**
```dart
/**
 * 01. LINE OA 快速記帳 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<QuickBookingResponse>> quickBooking(QuickBookingRequest request)
```

**交易管理方法**
```dart
/**
 * 02. 查詢交易記錄列表 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<TransactionListResponse>> getTransactions(TransactionQueryRequest request)

/**
 * 03. 新增交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<CreateTransactionResponse>> createTransaction(CreateTransactionRequest request)

/**
 * 04. 取得交易記錄詳情 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<TransactionDetailResponse>> getTransactionDetail(String transactionId)

/**
 * 05. 更新交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UpdateTransactionResponse>> updateTransaction(String transactionId, UpdateTransactionRequest request)

/**
 * 06. 刪除交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<DeleteTransactionResponse>> deleteTransaction(String transactionId, bool deleteRecurring)
```

**統計分析方法**
```dart
/**
 * 07. 取得記帳主頁儀表板數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<DashboardResponse>> getDashboard(DashboardRequest request)

/**
 * 08. 取得交易統計數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<StatisticsResponse>> getStatistics(StatisticsRequest request)

/**
 * 09. 取得最近交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<RecentTransactionsResponse>> getRecentTransactions(RecentTransactionsRequest request)

/**
 * 10. 取得圖表數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<ChartDataResponse>> getChartData(ChartDataRequest request)
```

**批次操作方法**
```dart
/**
 * 11. 批次新增交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<BatchCreateResponse>> batchCreateTransactions(BatchCreateRequest request)

/**
 * 12. 批次更新交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<BatchUpdateResponse>> batchUpdateTransactions(BatchUpdateRequest request)

/**
 * 13. 批次刪除交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<BatchDeleteResponse>> batchDeleteTransactions(BatchDeleteRequest request)

/**
 * 14. 匯入交易記錄 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<ImportResponse>> importTransactions(ImportRequest request)
```

**附件管理方法**
```dart
/**
 * 15. 上傳交易附件 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UploadAttachmentResponse>> uploadAttachment(String transactionId, UploadAttachmentRequest request)

/**
 * 16. 刪除交易附件 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<DeleteAttachmentResponse>> deleteAttachment(String transactionId, String attachmentId)
```

**重複交易方法**
```dart
/**
 * 17. 查詢重複交易設定 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<RecurringTransactionsResponse>> getRecurringTransactions(RecurringTransactionsRequest request)

/**
 * 18. 建立重複交易設定 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<CreateRecurringResponse>> createRecurringTransaction(CreateRecurringRequest request)

/**
 * 19. 更新重複交易設定 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<UpdateRecurringResponse>> updateRecurringTransaction(String recurringId, UpdateRecurringRequest request)

/**
 * 20. 刪除重複交易設定 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ApiResponse<DeleteRecurringResponse>> deleteRecurringTransaction(String recurringId, bool deleteExistingTransactions)
```

**內部輔助方法**
```dart
/**
 * 21. 建構API回應格式 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ApiResponse<T> _buildResponse<T>(T data, UserMode userMode, String requestId)

/**
 * 22. 記錄交易事件 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
void _logTransactionEvent(String event, Map<String, dynamic> details)

/**
 * 23. 驗證請求格式 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ValidationResult _validateRequest(dynamic request)

/**
 * 24. 提取用戶模式 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
UserMode _extractUserMode(HttpRequest request)
```

### 3.2 TransactionService 類別設計

#### 3.2.1 類別職責
- 實作交易記錄管理核心業務邏輯
- 處理交易的CRUD操作
- 管理交易相關的業務規則
- 整合帳戶餘額計算

#### 3.2.2 方法簽名規格

**交易核心處理方法**
```dart
/**
 * 25. 處理交易建立 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<TransactionResult> processCreateTransaction(String userId, CreateTransactionRequest request)

/**
 * 26. 處理交易更新 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<UpdateResult> processUpdateTransaction(String userId, String transactionId, UpdateTransactionRequest request)

/**
 * 27. 處理交易刪除 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<DeleteResult> processDeleteTransaction(String userId, String transactionId, bool deleteRecurring)

/**
 * 28. 處理交易查詢 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<QueryResult> processTransactionQuery(String userId, TransactionQueryRequest request)
```

**業務邏輯處理方法**
```dart
/**
 * 29. 驗證交易資料 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ValidationResult> _validateTransactionData(CreateTransactionRequest request)

/**
 * 30. 計算帳戶餘額變化 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BalanceChangeResult> _calculateBalanceChange(TransactionData transaction)

/**
 * 31. 更新帳戶餘額 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<void> _updateAccountBalance(String accountId, double amount)

/**
 * 32. 檢查預算狀態 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BudgetStatus> _checkBudgetStatus(String categoryId, double amount)
```

### 3.3 QuickBookingService 類別設計

#### 3.3.1 類別職責
- 處理LINE OA智慧文字解析記帳
- 自動識別金額、科目、描述等資訊
- 提供快速記帳的業務邏輯
- 整合自然語言處理功能

#### 3.3.2 方法簽名規格

**快速記帳核心方法**
```dart
/**
 * 33. 處理快速記帳請求 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<QuickBookingResult> processQuickBooking(String userId, QuickBookingRequest request)

/**
 * 34. 解析記帳文字 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ParseResult> parseBookingText(String input)

/**
 * 35. 智慧科目匹配 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<CategoryMatchResult> matchCategory(String description)

/**
 * 36. 生成確認訊息 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
String generateConfirmationMessage(TransactionData transaction, UserMode userMode)
```

**智慧解析輔助方法**
```dart
/**
 * 37. 提取金額資訊 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
AmountParseResult _extractAmount(String input)

/**
 * 38. 判斷交易類型 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
TransactionType _determineTransactionType(String input)

/**
 * 39. 計算解析信心度 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
double _calculateConfidence(ParseResult result)
```

### 3.4 StatisticsService 類別設計

#### 3.4.1 類別職責
- 生成儀表板統計數據
- 處理圖表數據計算
- 提供統計分析功能
- 管理數據聚合邏輯

#### 3.4.2 方法簽名規格

**統計數據生成方法**
```dart
/**
 * 40. 生成儀表板數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<DashboardData> generateDashboardData(String userId, DashboardRequest request)

/**
 * 41. 生成統計摘要 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<StatisticsSummary> generateStatisticsSummary(String userId, StatisticsRequest request)

/**
 * 42. 生成圖表數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ChartData> generateChartData(String userId, ChartDataRequest request)

/**
 * 43. 計算趨勢分析 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<TrendAnalysis> calculateTrendAnalysis(String userId, String period)
```

**數據聚合處理方法**
```dart
/**
 * 44. 聚合交易數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<AggregatedData> _aggregateTransactionData(List<TransactionEntity> transactions, String groupBy)

/**
 * 45. 計算百分比分布 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
List<PercentageData> _calculatePercentageDistribution(List<CategoryAmount> categoryAmounts)

/**
 * 46. 產生時間序列數據 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
List<TimeSeriesData> _generateTimeSeriesData(List<TransactionEntity> transactions, String period)
```

### 3.5 BatchOperationService 類別設計

#### 3.5.1 類別職責
- 處理批次交易操作
- 管理批次處理邏輯
- 提供匯入匯出功能
- 處理批次錯誤與回復

#### 3.5.2 方法簽名規格

**批次操作核心方法**
```dart
/**
 * 47. 處理批次建立交易 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BatchOperationResult> processBatchCreate(String userId, BatchCreateRequest request)

/**
 * 48. 處理批次更新交易 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BatchOperationResult> processBatchUpdate(String userId, BatchUpdateRequest request)

/**
 * 49. 處理批次刪除交易 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BatchOperationResult> processBatchDelete(String userId, BatchDeleteRequest request)

/**
 * 50. 處理交易匯入 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<ImportResult> processImport(String userId, ImportRequest request)
```

**批次處理輔助方法**
```dart
/**
 * 51. 驗證批次請求 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BatchValidationResult> _validateBatchRequest(List<dynamic> requests)

/**
 * 52. 執行批次操作 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<BatchExecutionResult> _executeBatchOperation(List<Operation> operations)

/**
 * 53. 處理批次錯誤 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
BatchErrorResult _handleBatchError(Exception error, int index)

/**
 * 54. 回滾失敗操作 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Future<void> _rollbackFailedOperations(List<String> successfulIds)
```

### 3.6 UserModeAdapter 類別設計

#### 3.6.1 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.6.2 方法簽名規格

**核心適配方法**
```dart
/**
 * 55. 適配回應內容 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
T adaptResponse<T>(T response, UserMode userMode)

/**
 * 56. 適配錯誤回應 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
ApiError adaptErrorResponse(ApiError error, UserMode userMode)
```

**具體回應適配方法**
```dart
/**
 * 57. 適配交易列表回應 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
TransactionListResponse adaptTransactionListResponse(TransactionListResponse response, UserMode userMode)

/**
 * 58. 適配儀表板回應 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
DashboardResponse adaptDashboardResponse(DashboardResponse response, UserMode userMode)

/**
 * 59. 適配快速記帳回應 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
QuickBookingResponse adaptQuickBookingResponse(QuickBookingResponse response, UserMode userMode)
```

**功能選項過濾方法**
```dart
/**
 * 60. 取得可用操作選項 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
List<String> getAvailableActions(UserMode userMode)

/**
 * 61. 過濾交易詳細資訊 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
Map<String, dynamic> filterTransactionDetails(Map<String, dynamic> details, UserMode userMode)

/**
 * 62. 判斷是否顯示進階統計 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
bool shouldShowAdvancedStatistics(UserMode userMode)

/**
 * 63. 取得模式特定訊息 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
String getModeSpecificMessage(String baseMessage, UserMode userMode)
```

---

## 4. API 設計規格

### 4.1 API 端點設計規格

本節嚴格遵循 **8088. API設計規範.md** 的規範，實作統一的回應格式、錯誤處理機制，並支援四模式差異化。

#### 4.1.1 統一回應格式設計

**成功回應格式**
```dart
/**
 * 64. API回應類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  ApiResponse.success({required T data, required ApiMetadata metadata})
  ApiResponse.error({required ApiError error, required ApiMetadata metadata})

  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata)
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata)

  Map<String, dynamic> toJson()
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT)
}
```

#### 4.1.2 API 端點映射規格

遵循 **8020. API list.md** 和 **8103. 記帳交易服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/transactions/quick` | POST | `quickBooking(QuickBookingRequest)` | S-201 |
| `/transactions` | GET | `getTransactions(TransactionQueryRequest)` | S-209, S-202 |
| `/transactions` | POST | `createTransaction(CreateTransactionRequest)` | S-203 |
| `/transactions/{id}` | GET | `getTransactionDetail(String)` | S-210 |
| `/transactions/{id}` | PUT | `updateTransaction(String, UpdateTransactionRequest)` | S-210 |
| `/transactions/{id}` | DELETE | `deleteTransaction(String, bool)` | S-209 |
| `/transactions/dashboard` | GET | `getDashboard(DashboardRequest)` | S-202 |
| `/transactions/statistics` | GET | `getStatistics(StatisticsRequest)` | S-201, S-211 |
| `/transactions/recent` | GET | `getRecentTransactions(RecentTransactionsRequest)` | S-202 |
| `/transactions/charts` | GET | `getChartData(ChartDataRequest)` | S-211 |
| `/transactions/batch` | POST | `batchCreateTransactions(BatchCreateRequest)` | - |
| `/transactions/batch` | PUT | `batchUpdateTransactions(BatchUpdateRequest)` | - |
| `/transactions/batch` | DELETE | `batchDeleteTransactions(BatchDeleteRequest)` | - |
| `/transactions/import` | POST | `importTransactions(ImportRequest)` | - |
| `/transactions/{id}/attachments` | POST | `uploadAttachment(String, UploadAttachmentRequest)` | S-207 |
| `/transactions/{id}/attachments/{attachmentId}` | DELETE | `deleteAttachment(String, String)` | S-207 |
| `/transactions/recurring` | GET | `getRecurringTransactions(RecurringTransactionsRequest)` | S-208 |
| `/transactions/recurring` | POST | `createRecurringTransaction(CreateRecurringRequest)` | S-208 |
| `/transactions/recurring/{id}` | PUT | `updateRecurringTransaction(String, UpdateRecurringRequest)` | S-208 |
| `/transactions/recurring/{id}` | DELETE | `deleteRecurringTransaction(String, bool)` | S-208 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 QuickBookingRequest 類別規格

**類別定義**
```dart
/**
 * 65. 快速記帳請求類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class QuickBookingRequest {
  final String input;
  final String userId;
  final String? ledgerId;
  final ContextInfo? context;

  QuickBookingRequest({required input, required userId, ledgerId, context})

  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static QuickBookingRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.2 CreateTransactionRequest 類別規格

```dart
/**
 * 66. 建立交易請求類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class CreateTransactionRequest {
  final double amount;
  final TransactionType type;
  final String categoryId;
  final String accountId;
  final String ledgerId;
  final DateTime date;
  final String? description;
  final String? notes;
  final List<String>? tags;
  final String? toAccountId;
  final List<String>? attachmentIds;
  final LocationInfo? location;
  final RecurringSettings? recurring;

  CreateTransactionRequest({required amount, required type, ...})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static CreateTransactionRequest fromJson(Map<String, dynamic> json)
}
```

#### 5.1.3 TransactionQueryRequest 類別規格

```dart
/**
 * 67. 交易查詢請求類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class TransactionQueryRequest {
  final String? ledgerId;
  final String? categoryId;
  final String? accountId;
  final TransactionType? type;
  final DateTime? startDate;
  final DateTime? endDate;
  final double? minAmount;
  final double? maxAmount;
  final String? search;
  final int page;
  final int limit;
  final String sort;

  TransactionQueryRequest({...})
  List<ValidationError> validate()
  Map<String, dynamic> toJson()
  static TransactionQueryRequest fromJson(Map<String, dynamic> json)
}
```

### 5.2 回應資料模型

#### 5.2.1 QuickBookingResponse 類別規格

```dart
/**
 * 68. 快速記帳回應類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class QuickBookingResponse {
  final String transactionId;
  final ParsedTransaction parsed;
  final String confirmation;

  // Expert Mode: 詳細統計
  final BalanceInfo? balance;

  // Cultivation Mode: 激勵資訊
  final AchievementInfo? achievement;

  // 建議與提醒
  final List<Suggestion>? suggestions;

  QuickBookingResponse({required transactionId, required parsed, required confirmation})
  Map<String, dynamic> toJson()
  static QuickBookingResponse fromJson(Map<String, dynamic> json)
}
```

#### 5.2.2 TransactionListResponse 類別規格

```dart
/**
 * 69. 交易列表回應類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class TransactionListResponse {
  final List<TransactionItem> transactions;
  final PaginationInfo pagination;

  // Expert Mode: 統計摘要
  final TransactionSummary? summary;

  TransactionListResponse({required transactions, required pagination})
  Map<String, dynamic> toJson()
  static TransactionListResponse fromJson(Map<String, dynamic> json)
}
```

#### 5.2.3 DashboardResponse 類別規格

```dart
/**
 * 70. 儀表板回應類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class DashboardResponse {
  final DashboardSummary summary;

  // Expert Mode: 完整儀表板
  final List<TransactionItem>? recentTransactions;
  final ChartsData? charts;
  final List<BudgetStatusItem>? budgetStatus;

  // Cultivation Mode: 成就與進度
  final AchievementData? achievements;

  final List<QuickAction> quickActions;

  // Guiding Mode: 極簡資訊
  final SimpleData? simpleData;

  DashboardResponse({required summary, required quickActions})
  Map<String, dynamic> toJson()
  static DashboardResponse fromJson(Map<String, dynamic> json)
}
```

### 5.3 資料存取層設計

#### 5.3.1 TransactionRepository 介面規格

```dart
/**
 * 71. 交易資料存取介面 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionRepository {
  Future<TransactionEntity?> findById(String id);
  Future<TransactionEntity> create(TransactionEntity transaction);
  Future<TransactionEntity> update(TransactionEntity transaction);
  Future<void> delete(String id);
  Future<List<TransactionEntity>> findByQuery(TransactionQuery query);
  Future<List<TransactionEntity>> findByUserId(String userId);
  Future<List<TransactionEntity>> findByLedgerId(String ledgerId);
  Future<List<TransactionEntity>> findByDateRange(DateTime start, DateTime end);
  Future<StatisticsData> getStatistics(String userId, StatisticsQuery query);
}
```

#### 5.3.2 TransactionEntity 類別規格

```dart
/**
 * 72. 交易實體類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class TransactionEntity {
  final String id;
  final double amount;
  final TransactionType type;
  final String categoryId;
  final String accountId;
  final String ledgerId;
  final DateTime date;
  final String? description;
  final String? notes;
  final List<String>? tags;
  final String? toAccountId;
  final List<AttachmentEntity>? attachments;
  final LocationInfo? location;
  final String? recurringId;
  final TransactionSource source;
  final DateTime createdAt;
  final DateTime updatedAt;
  final String createdBy;

  TransactionEntity({required id, required amount, ...})
  Map<String, dynamic> toFirestore()
  static TransactionEntity fromFirestore(Map<String, dynamic> data, String id)
  bool isValid()
  bool isTransfer()
  TransactionEntity copyWith({...})
}
```

---

## 6. 安全與驗證設計

### 6.1 安全服務設計

#### 6.1.1 TransactionValidator 類別規格

```dart
/**
 * 73. 交易驗證服務 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionValidator {
  List<ValidationError> validateAmount(double amount);
  List<ValidationError> validateTransactionType(TransactionType type);
  List<ValidationError> validateDate(DateTime date);
  List<ValidationError> validateDescription(String? description);
  List<ValidationError> validateCreateRequest(CreateTransactionRequest request);
  List<ValidationError> validateUpdateRequest(UpdateTransactionRequest request);
  List<ValidationError> validateBatchRequest(List<dynamic> requests);
}
```

### 6.2 權限檢查設計

#### 6.2.1 TransactionPermissionService 類別規格

```dart
/**
 * 74. 交易權限檢查服務 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionPermissionService {
  Future<bool> canCreateTransaction(String userId, String ledgerId);
  Future<bool> canUpdateTransaction(String userId, String transactionId);
  Future<bool> canDeleteTransaction(String userId, String transactionId);
  Future<bool> canViewTransaction(String userId, String transactionId);
  Future<bool> canAccessLedger(String userId, String ledgerId);
  Future<bool> canPerformBatchOperation(String userId, String ledgerId);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤分類體系

遵循 **8088. API設計規範** 的錯誤處理標準：

#### 7.1.1 TransactionErrorCode 枚舉規格

```dart
/**
 * 75. 交易錯誤碼枚舉 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
enum TransactionErrorCode {
  // 驗證錯誤 (400)
  validationError,
  invalidAmount,
  invalidDate,
  invalidTransactionType,
  missingRequiredField,
  parseFailure,

  // 認證錯誤 (401)
  unauthorized,
  tokenExpired,
  invalidToken,

  // 權限錯誤 (403)
  insufficientPermissions,
  ledgerAccessDenied,
  readOnlyTransaction,

  // 資源錯誤 (404, 409)
  transactionNotFound,
  categoryNotFound,
  accountNotFound,
  ledgerNotFound,
  duplicateTransaction,

  // 業務邏輯錯誤 (422)
  insufficientBalance,
  budgetExceeded,
  invalidTransfer,
  attachmentSizeExceeded,
  recurringConflict,

  // 系統錯誤 (500)
  internalServerError,
  databaseError,
  parseServiceError,
  fileUploadError;

  int get httpStatusCode
  String getMessage(UserMode userMode)
}
```

#### 7.1.2 ApiError 類別規格

```dart
/**
 * 76. API錯誤類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
class ApiError {
  final TransactionErrorCode code;
  final String message;
  final String? field;
  final DateTime timestamp;
  final String requestId;
  final Map<String, dynamic>? details;

  ApiError({required code, required message, ...})
  Map<String, dynamic> toJson()
  static ApiError fromJson(Map<String, dynamic> json)
  static ApiError create(TransactionErrorCode code, UserMode userMode, {...})
}
```

### 7.2 錯誤處理服務

#### 7.2.1 TransactionErrorHandler 類別規格

```dart
/**
 * 77. 交易錯誤處理器 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(String code, String message, UserMode userMode);
  String getLocalizedErrorMessage(TransactionErrorCode code, UserMode userMode);
  ApiError createParseError(String input, UserMode userMode);
  ApiError createPermissionError(String resource, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 TransactionModeConfigService 類別規格

```dart
/**
 * 78. 交易模式配置服務 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionModeConfigService {
  ModeConfig getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getDefaultTransactionSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
  List<String> getVisibleFields(UserMode mode, String responseType);
  Map<String, dynamic> getModeSpecificMessages(UserMode mode);
  int getDefaultPageSize(UserMode mode);
}
```

#### 8.1.2 TransactionResponseFilter 類別規格

```dart
/**
 * 79. 交易回應過濾器 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
  TransactionDetailResponse filterTransactionDetail(TransactionDetailResponse response, UserMode mode);
  DashboardResponse filterDashboardResponse(DashboardResponse response, UserMode mode);
  StatisticsResponse filterStatisticsResponse(StatisticsResponse response, UserMode mode);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含完整的交易詳細資訊和進階統計
- 提供批次操作和進階篩選功能
- 顯示詳細的錯誤訊息和除錯資訊

#### 8.2.2 Cultivation Mode 回應特性
- 包含成就系統和進度追蹤資訊
- 提供激勵性訊息和記帳習慣引導
- 強調預算達成和目標追蹤

#### 8.2.3 Guiding Mode 回應特性
- 極簡化的回應內容和操作選項
- 隱藏複雜的統計數據和進階功能
- 提供簡單明瞭的記帳確認訊息

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**TransactionController 測試規格**
```dart
/**
 * 80. TransactionController測試類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionControllerTest {
  void testQuickBookingWithValidInput();
  void testQuickBookingWithInvalidInput();
  void testCreateTransactionWithValidData();
  void testCreateTransactionWithInvalidData();
  void testUpdateTransactionWithValidData();
  void testUpdateTransactionWithPermissionDenied();
  void testDeleteTransactionWithDependencies();
  void testGetDashboardWithDifferentModes();
  void testBatchOperationsWithMixedResults();
  void testRecurringTransactionSettings();
}
```

**QuickBookingService 測試規格**
```dart
/**
 * 81. QuickBookingService測試類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class QuickBookingServiceTest {
  void testParseSimpleExpense();
  void testParseComplexInput();
  void testParseWithAmbiguousInput();
  void testCategoryMatching();
  void testConfidenceCalculation();
  void testParsingFailure();
}
```

#### 9.1.2 整合測試設計

**Transaction API 整合測試規格**
```dart
/**
 * 82. 交易API整合測試類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionAPIIntegrationTest {
  void testCompleteTransactionLifecycle();
  void testQuickBookingToFullTransactionFlow();
  void testBatchOperationFlow();
  void testRecurringTransactionExecution();
  void testAttachmentUploadAndManagement();
  void testStatisticsGeneration();
  void testCrossLedgerTransactionHandling();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
/**
 * 83. 交易模式測試類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionModeTest {
  void testExpertModeTransactionResponse();
  void testInertialModeTransactionResponse();
  void testCultivationModeTransactionResponse();
  void testGuidingModeTransactionResponse();
  void testModeSpecificDashboard();
  void testModeSpecificErrorMessages();
  void testQuickBookingModeAdaptation();
  void testStatisticsModeFiltering();
  void testBatchOperationModeRestrictions();
}
```

### 9.3 效能測試設計

#### 9.3.1 效能測試規格

```dart
/**
 * 84. 交易效能測試類別 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class TransactionPerformanceTest {
  void testQuickBookingResponseTime();
  void testLargeTransactionListQuery();
  void testBatchOperationThroughput();
  void testStatisticsCalculationPerformance();
  void testConcurrentTransactionCreation();
  void testDashboardDataGeneration();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
/**
 * 85. 枚舉類型定義 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
enum UserMode { expert, inertial, cultivation, guiding }
enum TransactionType { income, expense, transfer }
enum TransactionSource { manual, quick, import, recurring }
enum ChartType { pie, bar, line, trend }
enum StatisticsPeriod { day, week, month, quarter, year }
enum BatchOperationType { create, update, delete }
enum RecurringFrequency { daily, weekly, monthly, yearly }
enum AttachmentType { image, pdf, document }
enum ValidationErrorType { required, format, range, business }
```

### B. 介面契約定義

#### B.1 Repository 基礎介面

```dart
/**
 * 86. Repository基礎介面 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class BaseRepository<T, ID> {
  Future<T?> findById(ID id);
  Future<T> save(T entity);
  Future<void> delete(ID id);
  Future<List<T>> findAll();
  Future<bool> exists(ID id);
  Future<List<T>> findByQuery(Map<String, dynamic> query);
  Future<int> count();
}
```

#### B.2 服務層基礎介面

```dart
/**
 * 87. 服務層基礎介面 
 * @version 2025-09-04-V1.0.0
 * @date 2025-09-04 12:00:00
 * @update: 初版建立，完全符合8088規範第5.3節HTTP狀態碼標準
 */
abstract class BaseService<TRequest, TResponse> {
  Future<TResponse> process(TRequest request);
  Future<ValidationResult> validate(TRequest request);
  Future<void> logOperation(String operation, Map<String, dynamic> details);
  TResponse handleError(Exception error);
  bool hasPermission(String userId, String operation);
}
```

---

**文件完成日期**: 2025-09-04  
**版本**: 1.0.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8103 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計
