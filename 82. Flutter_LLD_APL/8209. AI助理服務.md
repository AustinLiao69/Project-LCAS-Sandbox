# 8209. AI助理服務 - Low Level Design (LLD)

**版本**: 2.2.0  
**建立日期**: 2025-09-05  
**最後更新**: 2025-09-05  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8109. AI 助理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
AI助理服務提供 LCAS 2.0 系統的智慧助理功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **對話管理模組**：多輪對話、上下文管理、會話持續
- **意圖識別模組**：自然語言理解、意圖分類、實體抽取
- **記帳輔助模組**：語音記帳、智慧分類、自動補全
- **財務諮詢模組**：預算建議、支出分析、投資諮詢
- **個人化助理模組**：習慣學習、偏好記憶、智慧提醒

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8109. AI 助理服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│         (AIAssistantController)         │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │ConversationSvc│ NLUSvc    │ AdviceSvc│ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │ContextMgr   │ PersonalizationSvc  │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
AIAssistantController
    ├─ depends on ──→ ConversationService
    ├─ depends on ──→ NLUService
    ├─ depends on ──→ AdviceService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

ConversationService
    ├─ depends on ──→ ContextManager
    ├─ depends on ──→ NLUService
    └─ depends on ──→ PersonalizationService
```

---

## 3. 模組與類別設計

### 3.1 AIAssistantController 類別設計

#### 3.1.1 類別職責
- 處理所有AI助理相關的HTTP請求
- 協調Service層處理業務邏輯
- 確保四模式差異化回應
- 統一錯誤處理與回應格式

#### 3.1.2 方法簽名規格

**對話管理方法**
```dart
/**
 * 01. 開始新對話
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<StartConversationResponse>> startConversation(StartConversationRequest request);

/**
 * 02. 發送訊息
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<SendMessageResponse>> sendMessage(SendMessageRequest request);

/**
 * 03. 取得對話歷史
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<ConversationHistoryResponse>> getConversationHistory(String conversationId);
```

**建議與分析方法**
```dart
/**
 * 04. 取得財務建議
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<FinancialAdviceResponse>> getFinancialAdvice(FinancialAdviceRequest request);

/**
 * 05. 取得記帳建議
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<BookkeepingAdviceResponse>> getBookkeepingAdvice(BookkeepingAdviceRequest request);

/**
 * 06. 取得支出分析
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<SpendingAnalysisResponse>> getSpendingAnalysis(SpendingAnalysisRequest request);
```

**個人化設定方法**
```dart
/**
 * 07. 取得助理設定
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<AssistantSettingsResponse>> getAssistantSettings();

/**
 * 08. 更新助理設定
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UpdateAssistantSettingsResponse>> updateAssistantSettings(UpdateAssistantSettingsRequest request);
```

### 3.2 ConversationService 類別設計

#### 3.2.1 類別職責
- 管理對話會話生命週期
- 處理多輪對話邏輯
- 維護對話上下文
- 協調各種助理功能

#### 3.2.2 方法簽名規格

**對話管理方法**
```dart
/**
 * 09. 處理對話初始化
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ConversationSession> initializeConversation(String userId, ConversationType type);

/**
 * 10. 處理訊息處理
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<MessageProcessingResult> processMessage(String conversationId, UserMessage message);

/**
 * 11. 生成AI回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<AIResponse> generateResponse(MessageContext context, UserIntent intent);
```

**上下文管理方法**
```dart
/**
 * 12. 更新對話上下文
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<void> updateConversationContext(String conversationId, ContextUpdate update);

/**
 * 13. 取得對話上下文
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ConversationContext> getConversationContext(String conversationId);
```

### 3.3 NLUService 類別設計

#### 3.3.1 類別職責
- 執行自然語言理解
- 識別使用者意圖
- 抽取實體資訊
- 處理語言多樣性

#### 3.3.2 方法簽名規格

**意圖識別方法**
```dart
/**
 * 14. 識別使用者意圖
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<IntentClassificationResult> classifyIntent(String text, ConversationContext context);

/**
 * 15. 抽取實體資訊
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<EntityExtractionResult> extractEntities(String text, UserIntent intent);

/**
 * 16. 語言理解分析
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<LanguageAnalysisResult> analyzeLanguage(String text);
```

### 3.4 AdviceService 類別設計

#### 3.4.1 類別職責
- 提供財務建議與諮詢
- 分析使用者財務狀況
- 生成個人化建議
- 處理複雜查詢場景

#### 3.4.2 方法簽名規格

**建議生成方法**
```dart
/**
 * 17. 生成財務建議
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<FinancialAdvice> generateFinancialAdvice(FinancialProfile profile, AdviceRequest request);

/**
 * 18. 分析支出模式
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<SpendingPatternAnalysis> analyzeSpendingPattern(String userId, String period);

/**
 * 19. 預算優化建議
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<BudgetOptimizationAdvice> optimizeBudget(BudgetData budgetData, FinancialGoals goals);
```

### 3.5 PersonalizationService 類別設計

#### 3.5.1 類別職責
- 學習使用者行為模式
- 個人化AI回應風格
- 管理使用者偏好設定
- 提供個人化體驗

#### 3.5.2 方法簽名規格

**個人化方法**
```dart
/**
 * 20. 學習使用者偏好
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<void> learnUserPreferences(String userId, UserBehaviorData behaviorData);

/**
 * 21. 個人化回應風格
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ResponseStyle> personalizeResponseStyle(String userId, MessageContext context);

/**
 * 22. 取得個人化設定
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<PersonalizationSettings> getPersonalizationSettings(String userId);
```

---

## 4. API 設計規格

### 4.1 標準回應格式

**ApiResponse 泛型類別**
```dart
/**
 * 23. API回應基礎類別
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  // 建構子定義
  ApiResponse.success({required T data, required ApiMetadata metadata});
  ApiResponse.error({required ApiError error, required ApiMetadata metadata});

  // 工廠方法
  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata);
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata);

  // JSON 轉換方法
  Map<String, dynamic> toJson();
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT);
}
```

### 4.2 API 端點映射規格

遵循 **8109. AI 助理服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/ai/conversation/start` | POST | `startConversation(StartConversationRequest)` | S-201, S-207 |
| `/ai/conversation/message` | POST | `sendMessage(SendMessageRequest)` | S-201, S-207 |
| `/ai/conversation/{id}/history` | GET | `getConversationHistory(String)` | S-207 |
| `/ai/advice/financial` | GET | `getFinancialAdvice(FinancialAdviceRequest)` | S-207 |
| `/ai/advice/bookkeeping` | GET | `getBookkeepingAdvice(BookkeepingAdviceRequest)` | S-201, S-207 |
| `/ai/advice/spending` | GET | `getSpendingAnalysis(SpendingAnalysisRequest)` | S-207 |
| `/ai/settings` | GET | `getAssistantSettings()` | S-207 |
| `/ai/settings` | PUT | `updateAssistantSettings(UpdateAssistantSettingsRequest)` | S-207 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 StartConversationRequest 類別規格

```dart
/**
 * 24. 開始對話請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class StartConversationRequest {
  final ConversationType type;
  final String? context;
  final Map<String, dynamic>? initialData;
  final AssistantPersonality? personality;
  final String? preferredLanguage;

  // 建構子
  StartConversationRequest({required type, ...});

  // 驗證方法
  List<ValidationError> validate();

  // 轉換方法
  Map<String, dynamic> toJson();
  static StartConversationRequest fromJson(Map<String, dynamic> json);
}
```

#### 5.1.2 SendMessageRequest 類別規格

```dart
/**
 * 25. 發送訊息請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class SendMessageRequest {
  final String conversationId;
  final String message;
  final MessageType messageType;
  final Map<String, dynamic>? attachments;
  final bool expectResponse;

  // 方法定義
  SendMessageRequest({required conversationId, required message, ...});
  List<ValidationError> validate();
  Map<String, dynamic> toJson();
  static SendMessageRequest fromJson(Map<String, dynamic> json);
}
```

### 5.2 回應資料模型

#### 5.2.1 SendMessageResponse 類別規格

```dart
/**
 * 26. 發送訊息回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class SendMessageResponse {
  final String messageId;
  final AIResponse aiResponse;
  final List<SuggestedAction>? suggestedActions;
  final ConversationState conversationState;
  final ContextUpdate? contextUpdate;

  // 方法定義
  SendMessageResponse({required messageId, required aiResponse, ...});
  Map<String, dynamic> toJson();
  static SendMessageResponse fromJson(Map<String, dynamic> json);
}
```

#### 5.2.2 FinancialAdviceResponse 類別規格

```dart
/**
 * 27. 財務建議回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class FinancialAdviceResponse {
  final List<FinancialAdvice> advice;
  final FinancialHealthScore healthScore;
  final List<Recommendation> recommendations;
  final RiskAssessment riskAssessment;
  final List<ActionItem> actionItems;

  // 方法定義
  FinancialAdviceResponse({required advice, required healthScore, ...});
  Map<String, dynamic> toJson();
  static FinancialAdviceResponse fromJson(Map<String, dynamic> json);
}
```

### 5.3 資料存取層設計

#### 5.3.1 ConversationRepository 介面規格

```dart
/**
 * 28. 對話資料存取介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class ConversationRepository {
  Future<ConversationSession> createConversation(String userId, ConversationType type);
  Future<ConversationSession?> getConversation(String conversationId);
  Future<void> saveMessage(String conversationId, MessageEntity message);
  Future<List<MessageEntity>> getConversationHistory(String conversationId, int limit);
  Future<void> updateConversationContext(String conversationId, ConversationContext context);
  Future<List<ConversationSession>> getUserConversations(String userId);
}
```

#### 5.3.2 ConversationSession 類別規格

```dart
/**
 * 29. 對話會話實體
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class ConversationSession {
  final String id;
  final String userId;
  final ConversationType type;
  final ConversationState state;
  final ConversationContext context;
  final AssistantPersonality personality;
  final DateTime createdAt;
  final DateTime lastUpdatedAt;
  final bool isActive;

  // 方法定義
  ConversationSession({required id, ...});
  Map<String, dynamic> toFirestore();
  static ConversationSession fromFirestore(Map<String, dynamic> data, String id);
  bool isExpired();
  Duration getActiveDuration();
}
```

---

## 6. 安全與驗證設計

### 6.1 驗證服務設計

#### 6.1.1 AIValidationService 類別規格

```dart
/**
 * 30. AI助理驗證服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIValidationService {
  Future<ValidationResult> validateMessage(String message);
  Future<ValidationResult> validateConversationAccess(String userId, String conversationId);
  bool validateMessageLength(String message);
  bool validateAttachments(Map<String, dynamic> attachments);
}
```

### 6.2 安全檢查設計

#### 6.2.1 AISecurityService 類別規格

```dart
/**
 * 31. AI助理安全服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AISecurityService {
  Future<bool> canAccessAIFeatures(String userId);
  Future<bool> isMessageSafe(String message);
  Future<bool> canCreateConversation(String userId);
  Future<RateLimitStatus> checkRateLimit(String userId);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤碼定義

#### 7.1.1 AIErrorCode 枚舉

```dart
/**
 * 32. AI助理錯誤碼枚舉
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
enum AIErrorCode {
  CONVERSATION_NOT_FOUND,
  MESSAGE_TOO_LONG,
  INVALID_MESSAGE_TYPE,
  RATE_LIMIT_EXCEEDED,
  AI_SERVICE_UNAVAILABLE,
  INTENT_RECOGNITION_FAILED,
  INSUFFICIENT_CONTEXT,
  PERMISSION_DENIED
}
```

### 7.2 錯誤處理服務

#### 7.2.1 AIErrorHandler 類別規格

```dart
/**
 * 33. AI助理錯誤處理器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(AIErrorCode code, String message, UserMode userMode);
  String getLocalizedErrorMessage(AIErrorCode code, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 AIModeConfig 類別規格

```dart
/**
 * 34. AI助理模式配置服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIModeConfig {
  AIModeSettings getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  AssistantPersonality getPersonalityForMode(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
}
```

#### 8.1.2 AIResponseFilter 類別規格

```dart
/**
 * 35. AI助理回應過濾器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 提供詳細的分析和專業建議
- 包含技術性的財務術語
- 支援複雜的查詢和深度對話

#### 8.2.2 Cultivation Mode 回應特性
- 強調教育性和學習導向
- 包含解釋和引導
- 鼓勵良好的財務習慣

#### 8.2.3 Guiding Mode 回應特性
- 極簡化和直接的回答
- 使用簡單易懂的語言
- 提供明確的行動指示

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**AIAssistantController 測試規格**
```dart
/**
 * 36. AI助理控制器測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIAssistantControllerTest {
  void testStartConversationWithValidInput();
  void testSendMessageWithValidData();
  void testGetFinancialAdviceWithValidRequest();
  void testSendMessageWithInvalidConversationId();
}
```

**ConversationService 測試規格**
```dart
/**
 * 37. 對話服務測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class ConversationServiceTest {
  void testConversationInitialization();
  void testMessageProcessing();
  void testContextManagement();
  void testResponseGeneration();
}
```

#### 9.1.2 整合測試設計

**AI Assistant API 整合測試規格**
```dart
/**
 * 38. AI助理API整合測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIAssistantAPIIntegrationTest {
  void testCompleteConversationFlow();
  void testMultiTurnConversation();
  void testAdviceGeneration();
  void testAIModeFiltering();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
/**
 * 39. AI助理模式測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class AIModeTest {
  void testExpertModeResponse();
  void testInertialModeResponse();
  void testCultivationModeResponse();
  void testGuidingModeResponse();
  void testModeResponseConsistency();
  void testPersonalityAdaptation();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
enum ConversationType { general, bookkeeping, financial_advice, expense_analysis }
enum MessageType { text, voice, image, structured_data }
enum ConversationState { active, paused, completed, error }
enum AssistantPersonality { professional, friendly, educational, concise }
enum UserMode { expert, inertial, cultivation, guiding }
```

### B. 介面契約定義

#### B.1 NLU 基礎介面

```dart
/**
 * 40. 自然語言理解基礎介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class NLUEngine {
  Future<IntentClassificationResult> classifyIntent(String text);
  Future<EntityExtractionResult> extractEntities(String text);
  Future<SentimentAnalysisResult> analyzeSentiment(String text);
  Future<LanguageDetectionResult> detectLanguage(String text);
}
```

---

**文件完成日期**: 2025-09-05  
**版本**: 2.2.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8109 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計