
# 8206. 科目管理服務 - API Gateway設計規格

**版本**: 2.0.0  
**建立日期**: 2025-09-04  
**最後更新**: 2025-09-19  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8106. 科目管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API Gateway架構](#2-api-gateway架構)
### 3. [RESTful端點設計](#3-restful端點設計)
### 4. [統一回應格式](#4-統一回應格式)
### 5. [錯誤處理機制](#5-錯誤處理機制)
### 6. [認證授權設計](#6-認證授權設計)
### 7. [BL層轉發規範](#7-bl層轉發規範)
### 8. [四模式支援規範](#8-四模式支援規範)
### 9. [測試規範](#9-測試規範)

---

## 1. 簡介

### 1.1 設計目的與範圍
科目管理服務API Gateway提供LCAS 2.0系統科目管理功能的統一API端點，負責接收HTTP請求並轉發至BL層處理。本文件定義純API Gateway的設計規範，專注於RESTful API端點定義、統一回應格式、錯誤處理與BL層轉發機制。

### 1.2 API Gateway核心職責
- **RESTful端點定義**：提供標準化的科目管理API端點
- **統一回應格式**：實作8088規範的統一回應結構
- **請求路由轉發**：將HTTP請求轉發至對應BL層函數
- **認證授權控制**：JWT token驗證與權限檢查
- **錯誤統一處理**：標準化錯誤回應格式
- **四模式差異化**：根據使用者模式調整回應內容

### 1.3 設計遵循規範
- **完全遵循8088 API設計規範**：RESTful設計、統一回應格式
- **對應8106 API規格文件**：確保端點定義完全一致
- **符合0015產品規格書**：APL層作為純API Gateway職責

---

## 2. API Gateway架構

### 2.1 純轉發架構設計
```
┌─────────────────────────────────────────┐
│           HTTP請求層                     │
│         (Express Routes)                │
├─────────────────────────────────────────┤
│           API Gateway層                  │
│      (純轉發，無業務邏輯)                 │
│  ┌─────────────────────────────────────┐ │
│  │  - JWT認證驗證                      │ │
│  │  - 請求參數驗證                      │ │
│  │  │  - 統一回應格式                   │ │
│  │  - 錯誤處理轉換                      │ │
│  │  └─ BL層函數調用                    │ │
│  └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│              BL層轉發                    │
│         (呼叫13號資料夾模組)              │
│  ┌─────────────────────────────────────┐ │
│  │  1301.BK.js - 記帳核心邏輯           │ │
│  │  1351.MLS.js - 多帳本管理邏輯        │ │
│  │  1361.GR.js - 分群與統計邏輯         │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 2.2 轉發機制流程
```
HTTP請求 → Express路由 → JWT驗證 → 參數驗證 → BL層調用 → 統一回應格式
     ↓
1. 接收HTTP請求與參數
2. 驗證JWT token有效性  
3. 驗證請求參數格式
4. 調用對應BL層函數
5. 處理BL層回應結果
6. 套用四模式差異化
7. 回傳統一格式JSON
```

---

## 3. RESTful端點設計

### 3.1 API端點總覽

根據8106 API規格文件，科目管理服務提供以下RESTful端點：

| HTTP方法 | 端點路徑 | 功能描述 | BL層函數 |
|---------|----------|----------|----------|
| GET | `/categories` | 查詢科目列表 | `1301.BK.getCategoryList()` |
| POST | `/categories` | 建立新科目 | `1301.BK.createCategory()` |
| GET | `/categories/{id}` | 取得科目詳情 | `1301.BK.getCategoryDetail()` |
| PUT | `/categories/{id}` | 更新科目資訊 | `1301.BK.updateCategory()` |
| DELETE | `/categories/{id}` | 刪除科目 | `1301.BK.deleteCategory()` |
| GET | `/categories/tree` | 取得科目樹狀結構 | `1301.BK.getCategoryTree()` |
| POST | `/categories/batch` | 批次建立科目 | `1301.BK.batchCreateCategories()` |
| GET | `/categories/{id}/transactions` | 查詢科目交易記錄 | `1301.BK.getCategoryTransactions()` |
| GET | `/categories/{id}/statistics` | 查詢科目統計 | `1361.GR.getCategoryStatistics()` |
| POST | `/categories/import` | 匯入科目資料 | `1301.BK.importCategories()` |
| GET | `/categories/templates` | 取得科目範本 | `1301.BK.getCategoryTemplates()` |

### 3.2 科目CRUD端點規範

**GET `/categories`** - 查詢科目列表
```javascript
// 端點職責：接收科目查詢請求並轉發至BL層
// BL層函數：1301.BK.getCategoryList(queryParams)
// 回應格式：遵循8088統一回應規範

Query Parameters:
- ledgerId: 帳本ID篩選
- type: 科目類型篩選 (income/expense/transfer)
- parentId: 父科目ID篩選
- active: 啟用狀態篩選 (true/false)
- search: 科目名稱搜尋
- page: 頁碼 (預設: 1)
- limit: 每頁筆數 (預設: 20)

Response (成功):
{
  "success": true,
  "data": {
    "categories": [
      {
        "id": "category-uuid-001",
        "ledgerId": "ledger-uuid-001",
        "name": "餐飲",
        "type": "expense",
        "parentId": null,
        "code": "FOOD",
        "icon": "restaurant",
        "color": "#FF5722",
        "isActive": true,
        "hasChildren": true,
        "sortOrder": 1,
        "createdAt": "2025-09-19T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 25,
      "totalPages": 2,
      "hasNext": true,
      "hasPrev": false
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

**POST `/categories`** - 建立新科目
```javascript
// 轉發至：1301.BK.createCategory(categoryData)
Request Body:
{
  "ledgerId": "ledger-uuid-001",
  "name": "早餐",
  "type": "expense",
  "parentId": "category-uuid-001",
  "code": "BREAKFAST",
  "description": "早餐支出",
  "icon": "breakfast",
  "color": "#FFC107",
  "sortOrder": 1,
  "settings": {
    "isVisible": true,
    "allowSubcategories": false,
    "autoSuggest": true
  }
}

Response (成功):
{
  "success": true,
  "data": {
    "categoryId": "category-uuid-002",
    "ledgerId": "ledger-uuid-001",
    "name": "早餐",
    "type": "expense",
    "parentId": "category-uuid-001",
    "code": "BREAKFAST",
    "fullPath": "餐飲 > 早餐",
    "level": 2,
    "createdAt": "2025-09-19T10:00:00Z"
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_789",
    "userMode": "Expert"
  }
}
```

### 3.3 科目樹狀結構端點規範

**GET `/categories/tree`** - 取得科目樹狀結構
```javascript
// 轉發至：1301.BK.getCategoryTree(ledgerId, options)
Query Parameters:
- ledgerId: 帳本ID (必填)
- type: 科目類型篩選 (可選)
- includeInactive: 是否包含停用科目 (true/false)
- maxDepth: 最大樹狀深度 (預設: 無限制)

Response (成功):
{
  "success": true,
  "data": {
    "tree": [
      {
        "id": "category-uuid-001",
        "name": "餐飲",
        "type": "expense",
        "code": "FOOD",
        "icon": "restaurant",
        "color": "#FF5722",
        "level": 1,
        "sortOrder": 1,
        "children": [
          {
            "id": "category-uuid-002",
            "name": "早餐",
            "type": "expense",
            "code": "BREAKFAST",
            "icon": "breakfast",
            "color": "#FFC107",
            "level": 2,
            "sortOrder": 1,
            "children": []
          }
        ]
      }
    ],
    "summary": {
      "totalCategories": 25,
      "activeCategories": 22,
      "maxDepth": 3,
      "typeDistribution": {
        "income": 5,
        "expense": 18,
        "transfer": 2
      }
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_123",
    "userMode": "Expert"
  }
}
```

### 3.4 科目統計查詢端點規範

**GET `/categories/{id}/statistics`** - 查詢科目統計
```javascript
// 轉發至：1361.GR.getCategoryStatistics(categoryId, options)
Path Parameters:
- id: 科目ID

Query Parameters:
- startDate: 開始日期 (YYYY-MM-DD)
- endDate: 結束日期 (YYYY-MM-DD)
- period: 統計週期 (daily/weekly/monthly/yearly)
- includeSubcategories: 是否包含子科目 (true/false)

Response (成功):
{
  "success": true,
  "data": {
    "categoryId": "category-uuid-001",
    "categoryName": "餐飲",
    "period": {
      "startDate": "2025-09-01",
      "endDate": "2025-09-19",
      "days": 19
    },
    "statistics": {
      "totalAmount": 15000,
      "transactionCount": 35,
      "averageAmount": 428.57,
      "maxTransaction": 1200,
      "minTransaction": 50,
      "dailyAverage": 789.47
    },
    "trends": {
      "weeklyData": [
        {
          "week": "2025-W37",
          "amount": 3500,
          "transactions": 8
        }
      ],
      "monthlyComparison": {
        "currentMonth": 15000,
        "previousMonth": 12500,
        "changePercent": 20.0
      }
    },
    "subcategoryBreakdown": [
      {
        "subcategoryId": "category-uuid-002",
        "subcategoryName": "早餐",
        "amount": 4500,
        "percentage": 30.0
      }
    ]
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_456",
    "userMode": "Expert"
  }
}
```

---

## 4. 統一回應格式

### 4.1 成功回應格式

所有API端點遵循8088規範的統一回應格式：

```javascript
{
  "success": true,
  "data": {
    // 具體回應數據
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert|Inertial|Cultivation|Guiding",
    "apiVersion": "v1.0.0",
    "processingTimeMs": 150
  }
}
```

### 4.2 HTTP狀態碼使用規範

| 狀態碼 | 使用場景 | 說明 |
|--------|----------|------|
| 200 | 查詢成功 | 成功取得科目資料 |
| 201 | 建立成功 | 成功建立科目 |
| 204 | 刪除成功 | 成功刪除科目，無回應內容 |
| 400 | 請求錯誤 | 參數驗證失敗 |
| 401 | 未授權 | JWT token無效 |
| 403 | 權限不足 | 無權限存取科目 |
| 404 | 找不到資源 | 科目不存在 |
| 409 | 衝突 | 科目名稱重複 |
| 422 | 業務邏輯錯誤 | 科目層級錯誤、循環引用等 |
| 500 | 系統錯誤 | 伺服器內部錯誤 |

---

## 5. 錯誤處理機制

### 5.1 錯誤回應格式

```javascript
{
  "success": false,
  "error": {
    "code": "CATEGORY_NOT_FOUND",
    "message": "科目不存在",
    "field": "categoryId",
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "details": {
      "categoryId": "category-uuid-001"
    }
  },
  "metadata": {
    "timestamp": "2025-09-19T10:00:00Z",
    "requestId": "req_unique_id",
    "userMode": "Expert"
  }
}
```

### 5.2 錯誤碼定義

| 錯誤碼 | HTTP狀態 | 說明 |
|--------|----------|------|
| `VALIDATION_ERROR` | 400 | 請求參數驗證失敗 |
| `UNAUTHORIZED` | 401 | JWT token無效或過期 |
| `INSUFFICIENT_PERMISSIONS` | 403 | 權限不足 |
| `CATEGORY_NOT_FOUND` | 404 | 科目不存在 |
| `DUPLICATE_CATEGORY_NAME` | 409 | 科目名稱重複 |
| `INVALID_PARENT_CATEGORY` | 422 | 無效的父科目 |
| `CIRCULAR_REFERENCE` | 422 | 科目循環引用 |
| `MAX_DEPTH_EXCEEDED` | 422 | 超過最大層級深度 |
| `CATEGORY_HAS_TRANSACTIONS` | 422 | 科目有交易記錄無法刪除 |
| `INTERNAL_SERVER_ERROR` | 500 | 系統內部錯誤 |

---

## 6. 認證授權設計

### 6.1 JWT Token驗證

所有API端點都需要有效的JWT token：

```javascript
// 請求標頭
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-User-Mode: Expert|Inertial|Cultivation|Guiding
```

### 6.2 權限檢查流程

```javascript
1. 驗證JWT token有效性
2. 解析使用者ID與權限
3. 檢查帳本存取權限
4. 驗證科目操作權限
5. 記錄存取日誌
6. 繼續轉發至BL層
```

### 6.3 權限層級定義

| 操作類型 | 所需權限 | 說明 |
|----------|----------|------|
| 查詢科目 | view | 可檢視科目資訊 |
| 建立科目 | edit | 可建立新科目 |
| 修改科目 | edit | 可修改科目設定 |
| 刪除科目 | admin | 僅帳本管理員可刪除 |
| 批次操作 | admin | 僅帳本管理員可執行 |

---

## 7. BL層轉發規範

### 7.1 BL層函數對應

| API端點 | BL層模組 | 函數名稱 |
|---------|----------|----------|
| `GET /categories` | 1301.BK.js | `getCategoryList()` |
| `POST /categories` | 1301.BK.js | `createCategory()` |
| `GET /categories/{id}` | 1301.BK.js | `getCategoryDetail()` |
| `PUT /categories/{id}` | 1301.BK.js | `updateCategory()` |
| `DELETE /categories/{id}` | 1301.BK.js | `deleteCategory()` |
| `GET /categories/tree` | 1301.BK.js | `getCategoryTree()` |
| `POST /categories/batch` | 1301.BK.js | `batchCreateCategories()` |
| `GET /categories/{id}/statistics` | 1361.GR.js | `getCategoryStatistics()` |

### 7.2 轉發機制實作

```javascript
// 轉發至BL層的標準流程
const result = await BLModule.functionName({
  userId: req.user.id,
  userMode: req.headers['x-user-mode'],
  requestData: req.body,
  queryParams: req.query,
  pathParams: req.params
});

// 套用統一回應格式
return formatApiResponse(result, req.headers['x-user-mode']);
```

---

## 8. 四模式支援規範

### 8.1 模式差異化處理

根據`X-User-Mode`標頭調整回應內容：

**Expert Mode（專家模式）**
- 完整的科目詳細資訊
- 進階統計與分析數據
- 詳細的樹狀結構
- 完整的管理選項

**Inertial Mode（慣性模式）**
- 標準科目資訊
- 基本統計數據
- 簡化的操作選項

**Cultivation Mode（培育模式）**
- 科目使用建議
- 分類管理技巧
- 理財科目規劃建議

**Guiding Mode（引導模式）**
- 極簡化科目資訊
- 預設科目推薦
- 清晰的操作指引

### 8.2 模式適配實作

```javascript
function adaptCategoryResponseForUserMode(data, userMode) {
  switch(userMode) {
    case 'Expert':
      return includeAdvancedCategoryMetrics(data);
    case 'Cultivation':
      return addCategoryManagementTips(data);
    case 'Guiding':
      return simplifyCategoryInfo(data);
    default:
      return data; // Inertial模式
  }
}
```

---

## 9. 測試規範

### 9.1 API Gateway測試重點

**端點存在性測試**
- 驗證所有定義的端點都可正常存取
- 確認HTTP方法與路徑正確對應

**轉發機制測試**
- 驗證請求正確轉發至BL層函數
- 確認參數傳遞完整性

**回應格式測試**
- 驗證統一回應格式正確性
- 確認錯誤回應格式一致性

**權限控制測試**
- 測試不同權限角色的存取控制
- 驗證JWT token驗證機制

### 9.2 四模式回應測試

**模式差異化測試**
- 驗證不同模式回應內容差異
- 確認模式特定功能正確過濾

**科目功能測試**
- 測試科目CRUD操作完整性
- 驗證樹狀結構正確性

### 9.3 整合測試

**端到端測試**
- 從HTTP請求到BL層完整流程測試
- 驗證科目管理完整流程

**效能測試**
- 測試大量科目查詢效能
- 驗證樹狀結構建構效能

---

**文件版本**: 2.0.0  
**最後更新**: 2025-09-19  
**重構說明**: 根據DCN-0013計劃，將LLD重構為純API Gateway設計規格，移除API客戶端實作邏輯，專注於RESTful端點定義、統一回應格式與BL層轉發機制
