# 8206. 科目管理服務 - Low Level Design (LLD)

**版本**: 2.2.0  
**建立日期**: 2025-09-05  
**最後更新**: 2025-09-05  
**建立者**: SA  
**來源文件**: 8020. API list.md, 8088. API設計規範.md, 8106. 科目管理服務 API 規格.yaml

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [架構設計](#2-架構設計)
### 3. [模組與類別設計](#3-模組與類別設計)
### 4. [API 設計規格](#4-api-設計規格)
### 5. [資料模型設計](#5-資料模型設計)
### 6. [安全與驗證設計](#6-安全與驗證設計)
### 7. [錯誤處理設計](#7-錯誤處理設計)
### 8. [四模式支援設計](#8-四模式支援設計)
### 9. [測試設計策略](#9-測試設計策略)

---

## 1. 簡介

### 1.1 設計目的與範圍
科目管理服務提供 LCAS 2.0 系統的完整科目管理功能，採用 **Dart** 語言實作客戶端 API 介面。本文件定義系統架構、類別設計、方法規格及互動關係，專注於Low Level Design規格。

### 1.2 核心功能模組
- **科目CRUD模組**：建立、查詢、修改、刪除科目
- **階層管理模組**：科目樹狀結構、父子關係管理
- **科目分類模組**：收入科目、支出科目、轉帳科目
- **使用統計模組**：科目使用頻率、金額分析
- **個人化設定模組**：常用科目、快速選擇、預設科目

### 1.3 設計遵循規範
- **完全遵循 8088. API設計規範**：統一回應格式、錯誤處理、四模式支援
- **對應 8106. 科目管理服務 API 規格**：確保端點定義一致
- **符合 8020. API list 映射關係**：支援所有對應畫面功能

---

## 2. 架構設計

### 2.1 系統分層架構
```
┌─────────────────────────────────────────┐
│            Controller Layer             │
│         (CategoryController)            │
├─────────────────────────────────────────┤
│            Service Layer                │
│  ┌─────────────┬─────────────┬────────┐ │
│  │CategorySvc  │StatisticsSvc│ TreeSvc│ │
│  └─────────────┴─────────────┴────────┘ │
├─────────────────────────────────────────┤
│            Utility Layer                │
│  ┌─────────────┬─────────────────────┐  │
│  │ CacheService│ UserModeAdapter     │  │
│  └─────────────┴─────────────────────┘  │
├─────────────────────────────────────────┤
│            Data Access Layer            │
│         (Repository Pattern)            │
└─────────────────────────────────────────┘
```

### 2.2 類別關係圖
```
CategoryController
    ├─ depends on ──→ CategoryService
    ├─ depends on ──→ StatisticsService
    ├─ depends on ──→ TreeService
    ├─ depends on ──→ UserModeAdapter
    └─ depends on ──→ ErrorHandler

CategoryService
    ├─ depends on ──→ CategoryRepository
    ├─ depends on ──→ ValidationService
    └─ depends on ──→ CacheService
```

---

## 3. 模組與類別設計

### 3.1 CategoryController 類別設計

#### 3.1.1 類別職責
- 處理所有科目相關的HTTP請求
- 協調Service層處理業務邏輯
- 確保四模式差異化回應
- 統一錯誤處理與回應格式

#### 3.1.2 方法簽名規格

**科目查詢方法**
```dart
/**
 * 01. 取得科目列表
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<CategoryListResponse>> getCategories(GetCategoriesRequest request);

/**
 * 02. 取得科目詳情
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<CategoryDetailResponse>> getCategoryDetail(String categoryId);
```

**科目管理方法**
```dart
/**
 * 03. 建立科目
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<CreateCategoryResponse>> createCategory(CreateCategoryRequest request);

/**
 * 04. 更新科目
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<UpdateCategoryResponse>> updateCategory(String categoryId, UpdateCategoryRequest request);

/**
 * 05. 刪除科目
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ApiResponse<DeleteCategoryResponse>> deleteCategory(String categoryId);
```

### 3.2 CategoryService 類別設計

#### 3.2.1 類別職責
- 處理科目業務邏輯
- 管理科目階層結構
- 執行科目驗證規則
- 統計科目使用情況

#### 3.2.2 方法簽名規格

**核心業務方法**
```dart
/**
 * 06. 處理科目建立
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<CategoryEntity> processCategoryCreation(CreateCategoryRequest request);

/**
 * 07. 處理科目更新
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<CategoryEntity> processCategoryUpdate(String categoryId, UpdateCategoryRequest request);

/**
 * 08. 驗證科目資料
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<ValidationResult> validateCategoryData(CategoryData data);
```

**階層管理方法**
```dart
/**
 * 09. 建立科目樹狀結構
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<List<CategoryTreeNode>> buildCategoryTree(List<CategoryEntity> categories);

/**
 * 10. 驗證階層關係
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<bool> validateHierarchy(String parentId, String childId);
```

### 3.3 StatisticsService 類別設計

#### 3.3.1 類別職責
- 計算科目使用統計
- 分析科目使用模式
- 生成使用頻率報告

#### 3.3.2 方法簽名規格

**統計計算方法**
```dart
/**
 * 11. 計算使用統計
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<CategoryStatistics> calculateUsageStatistics(String categoryId, String period);

/**
 * 12. 生成使用報告
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
Future<UsageReport> generateUsageReport(List<String> categoryIds);
```

### 3.4 UserModeAdapter 類別設計

#### 3.4.1 類別職責
- 根據使用者模式調整API回應內容
- 過濾不適合的功能選項
- 提供模式特定的使用者體驗

#### 3.4.2 方法簽名規格

**模式適配方法**
```dart
/**
 * 13. 適配科目列表回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
CategoryListResponse adaptCategoryListResponse(CategoryListResponse response, UserMode userMode);

/**
 * 14. 適配科目詳情回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
CategoryDetailResponse adaptCategoryDetailResponse(CategoryDetailResponse response, UserMode userMode);
```

---

## 4. API 設計規格

### 4.1 標準回應格式

**ApiResponse 泛型類別**
```dart
/**
 * 15. API回應基礎類別
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class ApiResponse<T> {
  final bool success;
  final T? data;
  final ApiMetadata metadata;
  final ApiError? error;

  // 建構子定義
  ApiResponse.success({required T data, required ApiMetadata metadata});
  ApiResponse.error({required ApiError error, required ApiMetadata metadata});

  // 工廠方法
  static ApiResponse<T> createSuccess<T>(T data, ApiMetadata metadata);
  static ApiResponse<T> createError<T>(ApiError error, ApiMetadata metadata);

  // JSON 轉換方法
  Map<String, dynamic> toJson();
  static ApiResponse<T> fromJson<T>(Map<String, dynamic> json, T Function(Map<String, dynamic>) fromJsonT);
}
```

### 4.2 API 端點映射規格

遵循 **8106. 科目管理服務 API 規格.yaml** 的定義：

| 端點 | HTTP 方法 | Controller 方法 | 對應畫面 |
|------|----------|----------------|----------|
| `/categories` | GET | `getCategories(GetCategoriesRequest)` | S-204, S-306 |
| `/categories` | POST | `createCategory(CreateCategoryRequest)` | S-306 |
| `/categories/{id}` | GET | `getCategoryDetail(String)` | S-306 |
| `/categories/{id}` | PUT | `updateCategory(String, UpdateCategoryRequest)` | S-306 |
| `/categories/{id}` | DELETE | `deleteCategory(String)` | S-306 |

---

## 5. 資料模型設計

### 5.1 請求資料模型

#### 5.1.1 GetCategoriesRequest 類別規格

```dart
/**
 * 16. 科目列表查詢請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class GetCategoriesRequest {
  final String? ledgerId;
  final CategoryType? type;
  final String? parentId;
  final int? level;
  final bool includeInactive;
  final bool includeStatistics;
  final String? search;
  final SortBy sortBy;
  final SortOrder sortOrder;

  // 建構子
  GetCategoriesRequest({...});

  // 驗證方法
  List<ValidationError> validate();

  // 轉換方法
  Map<String, dynamic> toJson();
  static GetCategoriesRequest fromJson(Map<String, dynamic> json);
}
```

#### 5.1.2 CreateCategoryRequest 類別規格

```dart
/**
 * 17. 建立科目請求
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class CreateCategoryRequest {
  final String name;
  final CategoryType type;
  final String ledgerId;
  final String? description;
  final String? parentId;
  final String? icon;
  final String? color;
  final AdvancedSettings? advanced;

  // 方法定義
  CreateCategoryRequest({required name, required type, required ledgerId, ...});
  List<ValidationError> validate();
  Map<String, dynamic> toJson();
  static CreateCategoryRequest fromJson(Map<String, dynamic> json);
}
```

### 5.2 回應資料模型

#### 5.2.1 CategoryListResponse 類別規格

```dart
/**
 * 18. 科目列表回應
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class CategoryListResponse {
  final List<CategorySummary> categories;
  final List<CategoryTreeNode>? tree;
  final List<CategoryRecommendation>? recommendations;
  final QuickAccess? quickAccess;
  final CategorySummaryStats summary;

  // 方法定義
  CategoryListResponse({required categories, ...});
  Map<String, dynamic> toJson();
  static CategoryListResponse fromJson(Map<String, dynamic> json);
}
```

### 5.3 資料存取層設計

#### 5.3.1 CategoryRepository 介面規格

```dart
/**
 * 19. 科目資料存取介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryRepository {
  Future<List<CategoryEntity>> findByLedgerId(String ledgerId);
  Future<CategoryEntity?> findById(String id);
  Future<CategoryEntity> create(CategoryEntity category);
  Future<CategoryEntity> update(CategoryEntity category);
  Future<void> delete(String id);
  Future<List<CategoryEntity>> findByParentId(String parentId);
  Future<List<CategoryEntity>> findByType(CategoryType type);
}
```

#### 5.3.2 CategoryEntity 類別規格

```dart
/**
 * 20. 科目實體類別
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
class CategoryEntity {
  final String id;
  final String name;
  final CategoryType type;
  final String ledgerId;
  final String? description;
  final String? parentId;
  final int level;
  final String? icon;
  final String? color;
  final bool isActive;
  final bool isDefault;
  final int sortOrder;
  final DateTime createdAt;
  final DateTime updatedAt;

  // 方法定義
  CategoryEntity({required id, ...});
  Map<String, dynamic> toFirestore();
  static CategoryEntity fromFirestore(Map<String, dynamic> data, String id);
  bool hasChildren();
  String getFullPath();
}
```

---

## 6. 安全與驗證設計

### 6.1 驗證服務設計

#### 6.1.1 ValidationService 類別規格

```dart
/**
 * 21. 科目驗證服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class ValidationService {
  Future<ValidationResult> validateCategoryName(String name, String ledgerId);
  Future<ValidationResult> validateHierarchyStructure(String parentId, String childId);
  Future<ValidationResult> validateCategoryType(CategoryType type);
  bool validateColor(String color);
  bool validateIcon(String icon);
}
```

### 6.2 安全檢查設計

#### 6.2.1 SecurityService 類別規格

```dart
/**
 * 22. 科目安全服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class SecurityService {
  Future<bool> canAccessCategory(String userId, String categoryId);
  Future<bool> canModifyCategory(String userId, String categoryId);
  Future<bool> canDeleteCategory(String userId, String categoryId);
  Future<PermissionLevel> getCategoryPermission(String userId, String categoryId);
}
```

---

## 7. 錯誤處理設計

### 7.1 錯誤碼定義

#### 7.1.1 CategoryErrorCode 枚舉

```dart
/**
 * 23. 科目錯誤碼枚舉
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
enum CategoryErrorCode {
  CATEGORY_NOT_FOUND,
  CATEGORY_NAME_EXISTS,
  INVALID_HIERARCHY,
  CATEGORY_IN_USE,
  INVALID_CATEGORY_TYPE,
  PERMISSION_DENIED,
  VALIDATION_FAILED
}
```

### 7.2 錯誤處理服務

#### 7.2.1 CategoryErrorHandler 類別規格

```dart
/**
 * 24. 科目錯誤處理器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryErrorHandler {
  ApiResponse<T> handleException<T>(Exception exception, UserMode userMode);
  ApiError createValidationError(List<ValidationError> errors, UserMode userMode);
  ApiError createBusinessLogicError(CategoryErrorCode code, String message, UserMode userMode);
  String getLocalizedErrorMessage(CategoryErrorCode code, UserMode userMode);
}
```

---

## 8. 四模式支援設計

### 8.1 模式差異化策略

嚴格遵循 **8088. API設計規範** 的四模式支援規範：

#### 8.1.1 CategoryModeConfig 類別規格

```dart
/**
 * 25. 科目模式配置服務
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryModeConfig {
  CategoryModeSettings getConfigForMode(UserMode mode);
  List<String> getAvailableFeatures(UserMode mode);
  Map<String, dynamic> getDefaultSettings(UserMode mode);
  bool isFeatureEnabled(UserMode mode, String feature);
}
```

#### 8.1.2 CategoryResponseFilter 類別規格

```dart
/**
 * 26. 科目回應過濾器
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryResponseFilter {
  Map<String, dynamic> filterForExpert(Map<String, dynamic> data);
  Map<String, dynamic> filterForInertial(Map<String, dynamic> data);
  Map<String, dynamic> filterForCultivation(Map<String, dynamic> data);
  Map<String, dynamic> filterForGuiding(Map<String, dynamic> data);
}
```

### 8.2 模式特定回應策略

#### 8.2.1 Expert Mode 回應特性
- 包含完整的科目統計和分析資料
- 提供進階管理選項
- 顯示詳細的階層結構資訊

#### 8.2.2 Guiding Mode 回應特性
- 極簡化的科目列表
- 隱藏複雜設定選項
- 提供簡單明瞭的操作指引

---

## 9. 測試設計策略

### 9.1 測試分層策略

#### 9.1.1 單元測試設計

**CategoryController 測試規格**
```dart
/**
 * 27. 科目控制器測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryControllerTest {
  void testGetCategoriesWithValidInput();
  void testCreateCategoryWithValidData();
  void testUpdateCategoryWithValidData();
  void testDeleteCategoryWithValidId();
  void testGetCategoriesWithInvalidLedgerId();
}
```

**CategoryService 測試規格**
```dart
/**
 * 28. 科目服務測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryServiceTest {
  void testCategoryCreationProcess();
  void testHierarchyValidation();
  void testCategoryStatisticsCalculation();
  void testCategoryTreeBuilding();
}
```

#### 9.1.2 整合測試設計

**Category API 整合測試規格**
```dart
/**
 * 29. 科目API整合測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryAPIIntegrationTest {
  void testCompleteCategoryManagementFlow();
  void testCategoryHierarchyManagement();
  void testCategoryStatisticsGeneration();
  void testCategoryModeFiltering();
}
```

### 9.2 四模式測試設計

#### 9.2.1 模式差異化測試規格

```dart
/**
 * 30. 科目模式測試
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class CategoryModeTest {
  void testExpertModeResponse();
  void testInertialModeResponse();
  void testCultivationModeResponse();
  void testGuidingModeResponse();
  void testModeResponseConsistency();
  void testModeFeatureFiltering();
}
```

---

## 附錄

### A. 資料類型定義

#### A.1 枚舉類型定義

```dart
enum CategoryType { income, expense, transfer }
enum SortBy { name, type, usage_count, amount_total, created_at, sort_order }
enum SortOrder { asc, desc }
enum UserMode { expert, inertial, cultivation, guiding }
```

### B. 介面契約定義

#### B.1 Repository 基礎介面

```dart
/**
 * 31. 基礎資料存取介面
 * @version 2025-09-05-V1.0.0
 * @date 2025-09-05 12:00:00
 * @update: 初始版本
 */
abstract class BaseRepository<T, ID> {
  Future<T?> findById(ID id);
  Future<T> save(T entity);
  Future<void> delete(ID id);
  Future<List<T>> findAll();
  Future<bool> exists(ID id);
}
```

---

**文件完成日期**: 2025-09-05  
**版本**: 2.2.0  
**維護者**: LCAS SA Team  
**規範遵循**: 完全遵循 8020、8088、8106 文件規範，移除所有程式碼實作，專注於 Low Level Design 架構設計