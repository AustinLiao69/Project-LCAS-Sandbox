
# SRS_BudgetService_預算管理_v1.0.0

**文件編號**: 8904  
**版本**: 1.0.0  
**建立日期**: 2025-08-02  
**建立者**: LCAS SA Team  
**最後更新**: 2025-08-02 05:08:00 UTC+8

---

## 目次

1. [模組概述](#10-模組概述module-overview)
2. [預算管理服務簡介](#20-預算管理服務簡介budget-management-service-introduction)
3. [API端點規格](#30-api端點規格api-endpoints-specification)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
BudgetService 預算管理服務是 LCAS 2.0 Flutter AP Layer 的預算控制模組，負責處理3個核心預算管理API端點，為 Flutter Presentation Layer 提供完整的預算設定、監控與警示功能。

### 1.2 核心職責
- **預算建立與更新**: 支援各類型預算的建立和動態更新
- **預算進度監控**: 即時追蹤預算執行狀況和花費進度
- **預算警示管理**: 智慧化預算超支警示和提醒機制

---

## 2.0 預算管理服務簡介（Budget Management Service Introduction）

### 2.1 目標與角色
預算管理服務在 LCAS 2.0 Flutter 架構中提供核心的預算控制功能：
- **API端點實作**: 實作3個預算管理相關的API端點
- **預算生命週期管理**: 處理預算從建立到執行的完整流程
- **智慧監控機制**: 提供即時預算監控和超支預警功能

---

## 3.0 API端點規格（API Endpoints Specification）

### 3.1 預算管理API群組（F016-F018）

#### 3.1.1 F016: 建立/更新預算
**功能描述**: 支援新預算建立和既有預算更新功能

**API規格**:
- **HTTP方法**: POST (建立) / PUT (更新)
- **端點**: `/budgets` (建立) / `/budgets/{id}` (更新)
- **輸入參數**:
```dart
class CreateBudgetRequest {
  final String budgetName;        // 預算名稱（必填）
  final String categoryId;        // 預算分類ID（必填）
  final double budgetAmount;      // 預算金額（必填）
  final String budgetPeriod;      // 預算週期（monthly/yearly）
  final DateTime startDate;       // 開始日期（必填）
  final DateTime endDate;         // 結束日期（必填）
  final String? description;      // 預算描述（可選）
  final String? projectId;        // 關聯專案ID（可選）
  final BudgetType budgetType;    // 預算類型
  final bool autoRollover;        // 自動結轉（預設false）
}

class UpdateBudgetRequest {
  final String budgetId;          // 預算ID（必填）
  final String? budgetName;       // 預算名稱（可選）
  final double? budgetAmount;     // 預算金額（可選）
  final String? description;      // 預算描述（可選）
  final bool? isActive;           // 是否啟用（可選）
  final DateTime? endDate;        // 結束日期（可選）
}

enum BudgetType { category, project, total }
```

**輸出規格**:
```dart
class BudgetResponse {
  final bool success;
  final String budgetId;
  final String budgetName;
  final double budgetAmount;
  final double currentSpent;
  final double remainingAmount;
  final double usagePercentage;
  final String budgetPeriod;
  final DateTime startDate;
  final DateTime endDate;
  final BudgetStatus status;
  final String? errorMessage;
}

enum BudgetStatus { active, paused, exceeded, expired }
```

#### 3.1.2 F017: 查詢預算進度
**功能描述**: 即時查詢預算執行進度和使用狀況

**API規格**:
- **HTTP方法**: GET
- **端點**: `/budgets/{id}/progress` / `/budgets/overview`
- **輸入參數**:
```dart
class BudgetProgressRequest {
  final String? budgetId;         // 特定預算ID（可選）
  final String? projectId;        // 專案ID篩選（可選）
  final String? categoryId;       // 分類ID篩選（可選）
  final DateTime? startDate;      // 查詢起始日期（可選）
  final DateTime? endDate;        // 查詢結束日期（可選）
  final String period;            // 查詢週期（daily/weekly/monthly）
  final bool includeHistory;      // 是否包含歷史資料（預設false）
}
```

**輸出規格**:
```dart
class BudgetProgressResponse {
  final bool success;
  final List<BudgetProgress> budgets;
  final BudgetSummary summary;
  final String? errorMessage;
}

class BudgetProgress {
  final String budgetId;
  final String budgetName;
  final double budgetAmount;
  final double currentSpent;
  final double remainingAmount;
  final double usagePercentage;
  final int daysRemaining;
  final double dailyAverageSpent;
  final double projectedTotal;
  final BudgetTrend trend;
  final List<DailySpending> dailyBreakdown;
}

class BudgetSummary {
  final int totalBudgets;
  final int activeBudgets;
  final int exceededBudgets;
  final double totalBudgetAmount;
  final double totalSpent;
  final double overallUsagePercentage;
}

enum BudgetTrend { onTrack, overSpending, underSpending }
```

#### 3.1.3 F018: 設定預算警示
**功能描述**: 設定和管理預算超支警示規則

**API規格**:
- **HTTP方法**: POST (建立) / PUT (更新) / GET (查詢)
- **端點**: `/budgets/{id}/alerts`
- **輸入參數**:
```dart
class BudgetAlertRequest {
  final String budgetId;          // 預算ID（必填）
  final List<AlertRule> alertRules; // 警示規則列表（必填）
  final bool enableNotifications; // 啟用通知（預設true）
  final List<NotificationChannel> channels; // 通知管道
}

class AlertRule {
  final String ruleId;            // 規則ID
  final AlertTrigger trigger;     // 觸發條件
  final double threshold;         // 閾值（百分比或金額）
  final AlertType alertType;      // 警示類型
  final String message;           // 警示訊息
  final bool isActive;            // 是否啟用
}

enum AlertTrigger { percentage, amount, dailyAverage, projectedOverrun }
enum AlertType { warning, critical, info }
enum NotificationChannel { push, email, inApp }
```

**輸出規格**:
```dart
class BudgetAlertResponse {
  final bool success;
  final String budgetId;
  final List<AlertRule> activeRules;
  final List<AlertHistory> recentAlerts;
  final String? errorMessage;
}

class AlertHistory {
  final String alertId;
  final String budgetId;
  final AlertType alertType;
  final String message;
  final DateTime triggeredAt;
  final bool wasActionTaken;
  final double budgetUsageAtTrigger;
}
```

### 3.2 BudgetService實作

#### 3.2.1 BudgetService 主服務類別
```dart
/**
 * BudgetService_預算管理服務_v1.0.0
 * @module BudgetService
 * @description 預算管理服務 - 提供預算建立、監控、警示功能
 * @update 2025-08-02: 建立版本，實作3個核心預算管理API端點
 */
class BudgetService {
  final ApiClient _apiClient;
  final CacheManager _cacheManager;

  BudgetService(this._apiClient, this._cacheManager);

  /**
   * F016: 建立新預算
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 建立新的預算項目，支援多種預算類型
   */
  Future<BudgetResponse> createBudget(CreateBudgetRequest request) async {
    try {
      final response = await _apiClient.post(
        '/budgets',
        data: request.toJson(),
      );
      
      final budgetResponse = BudgetResponse.fromJson(response.data);
      
      // 清除相關快取
      await _cacheManager.clearGroup('budgets');
      
      return budgetResponse;
    } catch (error) {
      throw BudgetServiceException('建立預算失敗: ${error.toString()}');
    }
  }

  /**
   * F016: 更新既有預算
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 更新既有預算的設定和金額
   */
  Future<BudgetResponse> updateBudget(UpdateBudgetRequest request) async {
    try {
      final response = await _apiClient.put(
        '/budgets/${request.budgetId}',
        data: request.toJson(),
      );
      
      final budgetResponse = BudgetResponse.fromJson(response.data);
      
      // 更新快取
      await _cacheManager.put(
        'budget_${request.budgetId}',
        budgetResponse.toJson(),
        duration: Duration(minutes: 15),
      );
      
      return budgetResponse;
    } catch (error) {
      throw BudgetServiceException('更新預算失敗: ${error.toString()}');
    }
  }

  /**
   * F017: 查詢預算進度
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 查詢預算執行進度和詳細分析
   */
  Future<BudgetProgressResponse> getBudgetProgress(BudgetProgressRequest request) async {
    try {
      // 檢查快取
      final cacheKey = 'budget_progress_${request.hashCode}';
      final cached = await _cacheManager.get(cacheKey);
      
      if (cached != null) {
        return BudgetProgressResponse.fromJson(cached);
      }
      
      final response = await _apiClient.get(
        '/budgets/progress',
        queryParameters: request.toJson(),
      );
      
      final progressResponse = BudgetProgressResponse.fromJson(response.data);
      
      // 快取結果（短期快取）
      await _cacheManager.put(
        cacheKey,
        progressResponse.toJson(),
        duration: Duration(minutes: 5),
      );
      
      return progressResponse;
    } catch (error) {
      throw BudgetServiceException('查詢預算進度失敗: ${error.toString()}');
    }
  }

  /**
   * F017: 查詢特定預算進度
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 查詢單一預算的詳細執行狀況
   */
  Future<BudgetProgress> getBudgetProgressById(String budgetId) async {
    try {
      final response = await _apiClient.get('/budgets/$budgetId/progress');
      return BudgetProgress.fromJson(response.data);
    } catch (error) {
      throw BudgetServiceException('查詢預算進度失敗: ${error.toString()}');
    }
  }

  /**
   * F018: 設定預算警示
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 設定預算超支警示規則和通知
   */
  Future<BudgetAlertResponse> setBudgetAlerts(BudgetAlertRequest request) async {
    try {
      final response = await _apiClient.post(
        '/budgets/${request.budgetId}/alerts',
        data: request.toJson(),
      );
      
      return BudgetAlertResponse.fromJson(response.data);
    } catch (error) {
      throw BudgetServiceException('設定預算警示失敗: ${error.toString()}');
    }
  }

  /**
   * F018: 查詢預算警示設定
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 查詢現有的預算警示規則
   */
  Future<BudgetAlertResponse> getBudgetAlerts(String budgetId) async {
    try {
      final response = await _apiClient.get('/budgets/$budgetId/alerts');
      return BudgetAlertResponse.fromJson(response.data);
    } catch (error) {
      throw BudgetServiceException('查詢預算警示失敗: ${error.toString()}');
    }
  }

  /**
   * 輔助方法: 取得預算概覽
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 取得所有預算的概覽資訊
   */
  Future<List<BudgetResponse>> getAllBudgets() async {
    try {
      final response = await _apiClient.get('/budgets');
      return (response.data['budgets'] as List)
          .map((json) => BudgetResponse.fromJson(json))
          .toList();
    } catch (error) {
      throw BudgetServiceException('查詢預算列表失敗: ${error.toString()}');
    }
  }

  /**
   * 輔助方法: 刪除預算
   * @version v1.0.0
   * @date 2025-08-02 05:08:00
   * @description 刪除指定的預算項目
   */
  Future<bool> deleteBudget(String budgetId) async {
    try {
      final response = await _apiClient.delete('/budgets/$budgetId');
      
      // 清除相關快取
      await _cacheManager.delete('budget_$budgetId');
      await _cacheManager.clearGroup('budgets');
      
      return response.data['success'] ?? false;
    } catch (error) {
      throw BudgetServiceException('刪除預算失敗: ${error.toString()}');
    }
  }
}

/**
 * 預算服務例外類別
 * @version v1.0.0
 * @date 2025-08-02 05:08:00
 */
class BudgetServiceException implements Exception {
  final String message;
  
  const BudgetServiceException(this.message);
  
  @override
  String toString() => 'BudgetServiceException: $message';
}
```

#### 3.2.2 快取管理策略
```dart
class BudgetCacheManager {
  static const Duration shortTerm = Duration(minutes: 5);   // 進度資料
  static const Duration mediumTerm = Duration(minutes: 15); // 預算設定
  static const Duration longTerm = Duration(hours: 1);      // 預算列表
  
  static String getBudgetProgressKey(String budgetId) => 'budget_progress_$budgetId';
  static String getBudgetDataKey(String budgetId) => 'budget_data_$budgetId';
  static String getBudgetListKey() => 'budget_list';
  static String getBudgetAlertsKey(String budgetId) => 'budget_alerts_$budgetId';
}
```

---

## 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| **v1.0.0** | **2025-08-02** | **LCAS SA Team** | **初版建立：實作3個預算管理API端點的完整功能，包含預算建立/更新(F016)、進度查詢(F017)、警示設定(F018)** |

---

## 備註

- **版本1.0.0特色**: 完整的預算管理服務模組，涵蓋預算生命週期管理
- **3個API端點**: F016-F018 預算管理功能（建立/更新、進度監控、警示設定）
- **智慧監控**: 提供預算使用趨勢分析和超支預警機制
- **多層級警示**: 支援百分比、金額、日均花費等多種警示觸發條件
- **快取最佳化**: 針對不同資料類型採用差異化快取策略
- **對應模組**: 與 BM 模組 v1.2.0 整合
- **相依服務**: 需要 EntryService 提供記帳資料支援
