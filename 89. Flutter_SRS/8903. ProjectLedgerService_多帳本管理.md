
# SRS_ProjectLedgerService_多帳本管理_v1.0.0

**文件編號**: 8903  
**版本**: 1.0.0  
**建立日期**: 2025-08-02  
**建立者**: LCAS SA Team  
**最後更新**: 2025-08-02 05:08:00 UTC+8

---

## 目次

1. [模組概述](#10-模組概述module-overview)
2. [多帳本服務簡介](#20-多帳本服務簡介project-ledger-service-introduction)
3. [API端點規格](#30-api端點規格api-endpoints-specification)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
ProjectLedgerService 多帳本管理服務是 LCAS 2.0 Flutter AP Layer 的核心管理模組，負責處理6個多帳本API端點，為 Flutter Presentation Layer 提供完整的多帳本管理功能。

### 1.2 核心職責
- **專案帳本建立**: 支援專案導向的帳本創建與管理
- **專案帳本管理**: 提供帳本屬性、成員、權限的完整管理
- **專案帳本刪除**: 安全的帳本刪除機制，含二次確認
- **分類帳本建立**: 支援主題分類的帳本創建功能
- **分類帳本管理**: 分類帳本的屬性與規則管理
- **多帳本切換**: 流暢的帳本間切換機制

---

## 2.0 多帳本服務簡介（Project Ledger Service Introduction）

### 2.1 目標與角色
多帳本管理服務在 LCAS 2.0 Flutter 架構中提供進階的帳本管理功能：
- **API端點實作**: 實作6個多帳本相關的API端點
- **多類型帳本支援**: 整合專案帳本和分類帳本的管理
- **權限管理整合**: 處理帳本權限與成員管理相關功能

---

## 3.0 API端點規格（API Endpoints Specification）

### 3.1 多帳本管理API群組（F010-F015）

#### 3.1.1 F010: 專案帳本建立
**功能描述**: 建立專案導向的帳本，支援時間範圍和預算設定

**API規格**:
- **HTTP方法**: POST
- **端點**: `/projects/create`
- **輸入參數**:
```dart
class CreateProjectRequest {
  final String projectName;          // 專案名稱（必填）
  final String? description;         // 專案描述（可選）
  final DateTime startDate;          // 開始日期（必填）
  final DateTime endDate;            // 結束日期（必填）
  final double? totalBudget;         // 總預算（可選）
  final String currency;             // 幣別（必填）
  final ProjectType projectType;     // 專案類型
  final List<String>? memberIds;     // 初始成員ID列表（可選）
}

enum ProjectType { business, personal, travel, investment, education }
```

**輸出規格**:
```dart
class CreateProjectResponse {
  final bool success;
  final String projectId;
  final String ledgerId;
  final String projectName;
  final DateTime createdAt;
  final String ownerId;
  final String? errorMessage;
}
```

#### 3.1.2 F011: 專案帳本管理
**功能描述**: 管理專案帳本的基本資訊、成員和設定

**API規格**:
- **HTTP方法**: PUT
- **端點**: `/projects/manage`
- **輸入參數**:
```dart
class ManageProjectRequest {
  final String projectId;            // 專案ID（必填）
  final String? projectName;         // 新專案名稱（可選）
  final String? description;         // 新描述（可選）
  final DateTime? newEndDate;        // 新結束日期（可選）
  final double? newBudget;           // 新預算（可選）
  final List<MemberUpdate>? memberUpdates;  // 成員更新（可選）
  final Map<String, dynamic>? settings;     // 專案設定（可選）
}

class MemberUpdate {
  final String userId;
  final MemberAction action;          // add, remove, update_permission
  final ProjectRole? newRole;
}

enum MemberAction { add, remove, updatePermission }
enum ProjectRole { owner, admin, member, viewer }
```

**輸出規格**:
```dart
class ManageProjectResponse {
  final bool success;
  final String projectId;
  final String message;
  final ProjectSummary? updatedProject;
  final List<String>? warnings;
  final String? errorMessage;
}
```

#### 3.1.3 F012: 專案帳本刪除
**功能描述**: 安全刪除專案帳本，包含二次確認機制

**API規格**:
- **HTTP方法**: DELETE
- **端點**: `/projects/delete`
- **輸入參數**:
```dart
class DeleteProjectRequest {
  final String projectId;            // 專案ID（必填）
  final String confirmationText;      // 確認文字（必填）
  final String password;              // 密碼確認（必填）
  final bool deleteAllData;           // 是否刪除所有資料（必填）
  final String deleteReason;          // 刪除原因（必填）
}
```

**輸出規格**:
```dart
class DeleteProjectResponse {
  final bool success;
  final String message;
  final DateTime deletedAt;
  final bool backupCreated;
  final String? backupId;
  final String? errorMessage;
}
```

#### 3.1.4 F013: 分類帳本建立
**功能描述**: 建立主題分類的帳本，支援智慧分類規則

**API規格**:
- **HTTP方法**: POST
- **端點**: `/categories/create`
- **輸入參數**:
```dart
class CreateCategoryRequest {
  final String categoryName;         // 分類名稱（必填）
  final CategoryType categoryType;    // 分類類型（必填）
  final String? description;         // 分類描述（可選）
  final List<String> tags;           // 分類標籤（必填）
  final List<String>? defaultSubjects; // 預設科目（可選）
  final ClassificationRules? rules;   // 分類規則（可選）
  final String? iconUrl;             // 圖示URL（可選）
  final String colorTheme;           // 顏色主題（必填）
}

enum CategoryType { food, transport, entertainment, shopping, health, education, travel, investment }

class ClassificationRules {
  final List<String> keywords;
  final List<AmountRule> amountRules;
  final bool autoClassify;
  final double confidenceThreshold;
}
```

**輸出規格**:
```dart
class CreateCategoryResponse {
  final bool success;
  final String categoryId;
  final String ledgerId;
  final String categoryName;
  final DateTime createdAt;
  final int rulesConfigured;
  final String? errorMessage;
}
```

#### 3.1.5 F014: 分類帳本管理
**功能描述**: 管理分類帳本的屬性、規則和設定

**API規格**:
- **HTTP方法**: PUT
- **端點**: `/categories/manage`
- **輸入參數**:
```dart
class ManageCategoryRequest {
  final String categoryId;           // 分類ID（必填）
  final String? categoryName;        // 新分類名稱（可選）
  final String? description;         // 新描述（可選）
  final List<String>? newTags;       // 新標籤列表（可選）
  final ClassificationRules? updatedRules; // 更新的分類規則（可選）
  final String? newColorTheme;       // 新顏色主題（可選）
  final String? newIconUrl;          // 新圖示URL（可選）
  final bool? isActive;              // 是否啟用（可選）
}
```

**輸出規格**:
```dart
class ManageCategoryResponse {
  final bool success;
  final String categoryId;
  final String message;
  final CategorySummary? updatedCategory;
  final RulePerformance? rulePerformance;
  final String? errorMessage;
}

class RulePerformance {
  final double accuracyRate;
  final int totalClassified;
  final int manualAdjustments;
}
```

#### 3.1.6 F015: 多帳本切換
**功能描述**: 在不同帳本間流暢切換，支援狀態保存

**API規格**:
- **HTTP方法**: GET
- **端點**: `/ledgers/switch`
- **輸入參數**:
```dart
class SwitchLedgerRequest {
  final String targetLedgerId;       // 目標帳本ID（必填）
  final String? currentLedgerId;     // 當前帳本ID（可選）
  final bool saveCurrentState;       // 是否保存當前狀態（必填）
  final String platform;             // 平台標識（必填）
}
```

**輸出規格**:
```dart
class SwitchLedgerResponse {
  final bool success;
  final String targetLedgerId;
  final LedgerInfo ledgerInfo;
  final UserPermission userPermission;
  final LedgerSummary summary;
  final List<QuickAction> quickActions;
  final String? errorMessage;
}

class LedgerInfo {
  final String id;
  final String name;
  final String type;                // project, category, default
  final String? description;
  final DateTime createdAt;
  final String ownerId;
  final int memberCount;
}

class UserPermission {
  final ProjectRole role;
  final List<String> allowedActions;
  final bool canInvite;
  final bool canExport;
}

class LedgerSummary {
  final int totalEntries;
  final double currentBalance;
  final double monthlyIncome;
  final double monthlyExpense;
  final DateTime lastActivity;
}

class QuickAction {
  final String actionId;
  final String title;
  final String description;
  final String iconUrl;
}
```

### 3.2 ProjectLedgerService實作

#### 3.2.1 ProjectLedgerService 主服務類別
```dart
class ProjectLedgerService {
  final ApiClient _apiClient;

  ProjectLedgerService(this._apiClient);

  // 建立專案帳本
  Future<CreateProjectResponse> createProject(CreateProjectRequest request) async {
    final response = await _apiClient.post('/projects/create', data: request.toJson());
    return CreateProjectResponse.fromJson(response.data);
  }

  // 管理專案帳本
  Future<ManageProjectResponse> manageProject(ManageProjectRequest request) async {
    final response = await _apiClient.put('/projects/manage', data: request.toJson());
    return ManageProjectResponse.fromJson(response.data);
  }

  // 刪除專案帳本
  Future<DeleteProjectResponse> deleteProject(DeleteProjectRequest request) async {
    final response = await _apiClient.delete('/projects/delete', data: request.toJson());
    return DeleteProjectResponse.fromJson(response.data);
  }

  // 建立分類帳本
  Future<CreateCategoryResponse> createCategory(CreateCategoryRequest request) async {
    final response = await _apiClient.post('/categories/create', data: request.toJson());
    return CreateCategoryResponse.fromJson(response.data);
  }

  // 管理分類帳本
  Future<ManageCategoryResponse> manageCategory(ManageCategoryRequest request) async {
    final response = await _apiClient.put('/categories/manage', data: request.toJson());
    return ManageCategoryResponse.fromJson(response.data);
  }

  // 多帳本切換
  Future<SwitchLedgerResponse> switchLedger(SwitchLedgerRequest request) async {
    final response = await _apiClient.get('/ledgers/switch', queryParameters: request.toJson());
    return SwitchLedgerResponse.fromJson(response.data);
  }
}
```

---

## 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| **v1.0.0** | **2025-08-02** | **LCAS SA Team** | **初版建立：實作6個多帳本管理API端點，支援專案帳本與分類帳本的完整生命週期管理** |

---

## 備註

- **版本1.0.0特色**: 完整的多帳本管理服務模組，專注於6個API端點的進階實作
- **6個API端點**: F010-F015 多帳本管理功能（專案建立、專案管理、專案刪除、分類建立、分類管理、帳本切換）
- **進階設計**: 支援專案與分類兩種帳本類型，含權限管理與智慧分類
- **安全機制**: 刪除操作需二次確認，權限驗證嚴格控管
- **效能優化**: 帳本切換支援狀態保存，提升使用者體驗
- **對應模組**: 與 MLS 模組 v1.0.0 整合，支援多帳本架構
