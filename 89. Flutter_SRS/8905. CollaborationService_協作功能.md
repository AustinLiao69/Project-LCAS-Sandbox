
# SRS_CollaborationService_協作功能_v1.0.0

**文件編號**: 8905  
**版本**: 1.0.0  
**建立日期**: 2025-08-02  
**建立者**: LCAS SA Team  
**最後更新**: 2025-08-02 05:08:00 UTC+8

---

## 目次

1. [模組概述](#10-模組概述module-overview)
2. [協作服務簡介](#20-協作服務簡介collaboration-service-introduction)
3. [API端點規格](#30-api端點規格api-endpoints-specification)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
CollaborationService 協作功能服務是 LCAS 2.0 Flutter AP Layer 的企業級協作模組，負責處理3個核心協作API端點，為 Flutter Presentation Layer 提供多人協作記帳服務介面。

### 1.2 核心職責
- **共享帳本建立**: 支援多人協作記帳空間建立
- **協作權限管理**: 分級權限控制與成員管理
- **即時同步機制**: WebSocket即時資料同步與衝突處理

---

## 2.0 協作服務簡介（Collaboration Service Introduction）

### 2.1 目標與角色
協作服務在 LCAS 2.0 Flutter 架構中提供企業級協作功能：
- **API端點實作**: 實作3個協作相關的API端點
- **多人協作支援**: 整合共享帳本和權限管理機制
- **即時同步處理**: 處理協作相關的即時資料同步

---

## 3.0 API端點規格（API Endpoints Specification）

### 3.1 協作功能API群組（F019-F021）

#### 3.1.1 F019: 建立共享帳本
**功能描述**: 支援多人協作記帳空間建立

**API規格**:
- **HTTP方法**: POST
- **端點**: `/app/shared/create`
- **輸入參數**:
```dart
class CreateSharedLedgerRequest {
  final SharedLedgerInfo sharedLedgerInfo;      // 共享帳本資訊（必填）
  final CollaborationSettings collaborationSettings; // 協作設定
  final DefaultPermissions defaultPermissions;   // 預設權限
  final CollaborationRules collaborationRules;   // 協作規則
  final NotificationSettings notificationSettings; // 通知設定
  final InitialSetup initialSetup;              // 初始設定
}

class SharedLedgerInfo {
  final String ledgerName;                      // 帳本名稱（必填）
  final String? description;                    // 描述說明
  final CollaborationType collaborationType;    // 協作類型
  final PrivacyLevel privacyLevel;             // 隱私等級
  final String? templateId;                     // 範本ID
}

enum CollaborationType { family, team, project, friendGroup }
enum PrivacyLevel { private, protected, public }

class CollaborationSettings {
  final int maxMembers;                         // 最大成員數
  final bool autoApproval;                      // 自動審核
  final bool requireVerification;               // 需要驗證
  final bool allowGuestView;                    // 允許訪客檢視
  final int dataRetentionDays;                  // 資料保留天數
}

class DefaultPermissions {
  final String memberDefault;                   // 成員預設權限
  final String guestDefault;                    // 訪客預設權限
  final bool permissionInheritance;             // 權限繼承
  final CustomPermissions customPermissions;    // 自訂權限
}

class CollaborationRules {
  final bool entryApprovalRequired;             // 記帳需審核
  final int modificationWindowHours;            // 修改時間窗口
  final double largeAmountThreshold;            // 大額門檻
  final bool largeAmountApproval;               // 大額需審核
  final double commentRequiredAmount;           // 需備註金額
}
```

**輸出規格**:
```dart
class CreateSharedLedgerResponse {
  final bool success;
  final SharedLedger sharedLedger;
  final CollaborationSetup collaborationSetup;
  final IntegrationStatus integrationStatus;
  final List<NextStep> nextSteps;
  final List<String> quickActions;
  final String? errorMessage;
}

class SharedLedger {
  final String ledgerId;                        // 帳本ID
  final String ledgerName;                      // 帳本名稱
  final CollaborationType collaborationType;    // 協作類型
  final String ownerUid;                        // 擁有者UID
  final DateTime createdAt;                     // 建立時間
  final String shareCode;                       // 分享代碼
  final String inviteLink;                      // 邀請連結
}

class CollaborationSetup {
  final int maxMembers;                         // 最大成員數
  final int currentMembers;                     // 目前成員數
  final int permissionLevels;                   // 權限等級數
  final int activeRules;                        // 啟用規則數
  final bool autoSyncEnabled;                   // 自動同步啟用
}

class IntegrationStatus {
  final String realTimeSync;                    // 即時同步狀態
  final String notificationSystem;              // 通知系統狀態
  final String backupService;                   // 備份服務狀態
  final String conflictResolution;              // 衝突解決狀態
}

class NextStep {
  final String action;                          // 動作
  final String description;                     // 描述
  final String url;                            // 網址
}
```

#### 3.1.2 F020: 多人協作權限
**功能描述**: 支援協作成員權限管理

**API規格**:
- **HTTP方法**: PUT
- **端點**: `/app/shared/permissions`
- **輸入參數**:
```dart
class UpdatePermissionsRequest {
  final String ledgerId;                        // 帳本ID（必填）
  final PermissionUpdates permissionUpdates;    // 權限更新
  final NotificationSettings notificationSettings; // 通知設定
  final AuditSettings auditSettings;            // 稽核設定
}

class PermissionUpdates {
  final List<IndividualUpdate> individualUpdates; // 個別更新
  final BulkUpdates? bulkUpdates;               // 批量更新
}

class IndividualUpdate {
  final String userId;                          // 使用者ID
  final String action;                          // 動作類型
  final String? newPermissionLevel;             // 新權限等級
  final SpecificPermissions? specificPermissions; // 特定權限
  final PermissionScope? permissionScope;       // 權限範圍
  final String? reason;                         // 變更原因
}

class SpecificPermissions {
  final bool canAddEntry;                       // 可新增記錄
  final bool canEditEntry;                      // 可編輯記錄
  final bool canDeleteEntry;                    // 可刪除記錄
  final bool canViewAll;                        // 可檢視全部
  final bool canExportData;                     // 可匯出資料
  final bool canInviteMember;                   // 可邀請成員
  final bool canManageBudget;                   // 可管理預算
  final bool canViewReports;                    // 可檢視報表
  final bool canModifyCategories;               // 可修改分類
  final bool canAccessHistory;                  // 可存取歷史
}

class PermissionScope {
  final DateRange? dateRangeLimit;              // 日期範圍限制
  final double? amountLimit;                    // 金額限制
  final List<String> categoryRestrictions;      // 分類限制
  final bool viewOnlyOwn;                       // 僅檢視自己
}
```

**輸出規格**:
```dart
class UpdatePermissionsResponse {
  final bool success;
  final PermissionChanges permissionChanges;
  final List<UpdatedPermission> updatedPermissions;
  final CollaborationStatus collaborationStatus;
  final NotificationsSent notificationsSent;
  final String? errorMessage;
}

class PermissionChanges {
  final int totalUsersAffected;                 // 受影響使用者數
  final int successfulUpdates;                  // 成功更新數
  final int failedUpdates;                      // 失敗更新數
  final List<String> permissionConflicts;       // 權限衝突
}

class UpdatedPermission {
  final String userId;                          // 使用者ID
  final String displayName;                     // 顯示名稱
  final String? oldLevel;                       // 舊權限等級
  final String? newLevel;                       // 新權限等級
  final SpecificPermissions effectivePermissions; // 有效權限
  final String permissionSummary;               // 權限摘要
}

class CollaborationStatus {
  final int totalMembers;                       // 總成員數
  final PermissionDistribution permissionDistribution; // 權限分布
  final int activeRestrictions;                 // 啟用限制數
  final int pendingApprovals;                   // 待審核數
}

class PermissionDistribution {
  final int owner;                              // 擁有者數
  final int admin;                              // 管理員數
  final int member;                             // 成員數
  final int viewer;                             // 檢視者數
}

class NotificationsSent {
  final int totalSent;                          // 總發送數
  final DeliveryStatus deliveryStatus;          // 發送狀態
}

class DeliveryStatus {
  final int line;                               // LINE發送數
  final int appPush;                            // APP推播數
  final int email;                              // Email發送數
}
```

#### 3.1.3 F021: 即時協作同步
**功能描述**: 支援即時協作資料同步

**API規格**:
- **協定**: WebSocket
- **端點**: `/app/sync/realtime`
- **輸入參數**:
```dart
class RealtimeSyncRequest {
  final ConnectionInfo connectionInfo;          // 連線資訊
  final SyncOptions syncOptions;               // 同步選項
  final OperationData? operationData;          // 操作資料
}

class ConnectionInfo {
  final String userId;                          // 使用者ID
  final String ledgerId;                        // 帳本ID
  final String deviceId;                        // 裝置ID
  final String clientVersion;                   // 客戶端版本
}

class SyncOptions {
  final bool enableRealTime;                    // 啟用即時同步
  final String conflictResolution;              // 衝突解決策略
  final bool offlineMode;                       // 離線模式
  final bool compression;                       // 壓縮
}

class OperationData {
  final String operationType;                   // 操作類型
  final String targetDocument;                  // 目標文件
  final Changes changes;                        // 變更內容
  final String operationId;                     // 操作ID
}

class Changes {
  final Map<String, dynamic>? before;           // 變更前
  final Map<String, dynamic>? after;            // 變更後
  final DateTime timestamp;                     // 時間戳記
}
```

**輸出規格**:
```dart
class RealtimeSyncResponse {
  final String connectionStatus;                // 連線狀態
  final SyncInfo syncInfo;                      // 同步資訊
  final List<RealTimeUpdate> realTimeUpdates;   // 即時更新
  final ConflictDetection conflictDetection;    // 衝突檢測
}

class SyncInfo {
  final String ledgerId;                        // 帳本ID
  final List<ActiveUser> activeUsers;           // 活躍使用者
  final DateTime lastSync;                      // 最後同步時間
}

class ActiveUser {
  final String userId;                          // 使用者ID
  final String displayName;                     // 顯示名稱
  final DateTime lastActivity;                  // 最後活動時間
  final String currentAction;                   // 目前動作
}

class RealTimeUpdate {
  final String updateType;                      // 更新類型
  final Map<String, dynamic> data;              // 資料
  final UserInfo userInfo;                      // 使用者資訊
  final DateTime timestamp;                     // 時間戳記
}

class UserInfo {
  final String userId;                          // 使用者ID
  final String displayName;                     // 顯示名稱
}

class ConflictDetection {
  final bool hasConflicts;                      // 有衝突
  final List<dynamic> conflicts;                // 衝突清單
}
```

### 3.2 CollaborationService實作

#### 3.2.1 CollaborationService 主服務類別
```dart
class CollaborationService {
  final ApiClient _apiClient;

  CollaborationService(this._apiClient);

  // 建立共享帳本
  Future<CreateSharedLedgerResponse> createSharedLedger(CreateSharedLedgerRequest request) async {
    final response = await _apiClient.post('/app/shared/create', data: request.toJson());
    return CreateSharedLedgerResponse.fromJson(response.data);
  }

  // 多人協作權限
  Future<UpdatePermissionsResponse> updatePermissions(UpdatePermissionsRequest request) async {
    final response = await _apiClient.put('/app/shared/permissions', data: request.toJson());
    return UpdatePermissionsResponse.fromJson(response.data);
  }

  // 即時協作同步
  Stream<RealtimeSyncResponse> realtimeSync(RealtimeSyncRequest request) {
    return _apiClient.websocket('/app/sync/realtime', request.toJson())
        .map((data) => RealtimeSyncResponse.fromJson(data));
  }
}
```

---

## 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| **v1.0.0** | **2025-08-02** | **LCAS SA Team** | **協作功能服務建立：實作3個協作API端點的基本功能** |

---

## 備註

- **版本1.0.0特色**: 企業級協作功能服務模組，專注於3個API端點的基本實作
- **3個API端點**: F019-F021 協作功能（共享帳本、權限管理、即時同步）
- **簡化設計**: 移除token管理、安全驗證、狀態管理、錯誤處理等複雜功能
- **基礎實作**: 提供最基本的API調用和資料轉換功能
- **對應模組**: 與 CM 模組 v2.0.0 整合
