
# 5009. TDD_AM_å¸³è™Ÿç®¡ç†æ¨¡çµ„_v2.0

## æ–‡ä»¶è³‡è¨Š
- **æ–‡ä»¶æ¨™é¡Œ**: AM å¸³è™Ÿç®¡ç†æ¨¡çµ„æŠ€è¡“è¨­è¨ˆæ–‡ä»¶
- **æ–‡ä»¶ç‰ˆæœ¬**: v2.0
- **å‰µå»ºæ—¥æœŸ**: 2025-01-09 00:34:00 +08:00 (å°ç£æ™‚é–“)
- **å‰µå»ºè€…**: AustinLiao69
- **æœ€å¾Œæ›´æ–°**: 2025-08-02 10:00:00 +08:00 (å°ç£æ™‚é–“)
- **å°æ‡‰éœ€æ±‚æ–‡ä»¶**: 1009. AM_å¸³è™Ÿç®¡ç†æ¨¡çµ„.md
- **æ¨¡çµ„ä»£ç¢¼**: AM (Account Management)

---

## ğŸ“‘ ç›®æ¬¡ (Table of Contents)

1. æŠ€è¡“æ¶æ§‹æ¦‚è¿°
   - 1.1 æ¨¡çµ„å®šä½
   - 1.2 æŠ€è¡“å †ç–Š
   - 1.3 æ¨¡çµ„æ¶æ§‹

2. æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ
   - 2.1 å¸³è™Ÿå‰µå»ºèˆ‡è¨»å†Šå‡½æ•¸
   - 2.2 å¸³è™Ÿç®¡ç†èˆ‡ä¿®æ”¹å‡½æ•¸
   - 2.3 å¸³è™ŸæŸ¥è©¢èˆ‡é©—è­‰å‡½æ•¸
   - 2.4 LINE OAuth æ•´åˆå‡½æ•¸
   - 2.5 è·¨å¹³å°è³‡æ–™åŒæ­¥å‡½æ•¸
   - 2.6 ç”¨æˆ¶ç§‘ç›®åˆå§‹åŒ–å‡½æ•¸
   - 2.7 éŒ¯èª¤è™•ç†èˆ‡ç›£æ§å‡½æ•¸

3. æ¨¡çµ„é–“äº’å‹•æ¶æ§‹
   - 3.1 æ ¸å¿ƒä¾è³´é—œä¿‚
   - 3.2 è³‡æ–™æµå‘è¨­è¨ˆ

4. è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ
   - 4.1 Firestore é›†åˆçµæ§‹
   - 4.2 ç”¨æˆ¶é¡å‹æ¬Šé™è¨­è¨ˆ

5. API ä»‹é¢è¦æ ¼
   - 5.1 REST API ç«¯é»
   - 5.2 WebSocket äº‹ä»¶

6. å®‰å…¨æ€§è¨­è¨ˆ
   - 6.1 èº«ä»½èªè­‰å®‰å…¨
   - 6.2 è³‡æ–™ä¿è­·æªæ–½
   - 6.3 éŒ¯èª¤è™•ç†å®‰å…¨

7. æ•ˆèƒ½èˆ‡æ“´å±•æ€§è€ƒé‡
   - 7.1 å¿«å–ç­–ç•¥
   - 7.2 æ‰¹æ¬¡è™•ç†å„ªåŒ–
   - 7.3 å¹³å°æ“´å±•æ€§

8. æ–‡ä»¶ç¶­è­·è¨˜éŒ„

---

## 1.0 æŠ€è¡“æ¶æ§‹æ¦‚è¿°

### 1.1 æ¨¡çµ„å®šä½
AM å¸³è™Ÿç®¡ç†æ¨¡çµ„ä½œç‚º LCAS 2.0 çš„æ ¸å¿ƒåŸºç¤æ¨¡çµ„ï¼Œè² è²¬çµ±ä¸€ç®¡ç† LINE OA ç«¯å’Œ APP ç«¯çš„ä½¿ç”¨è€…å¸³è™Ÿï¼Œå¯¦ç¾è·¨å¹³å°å¸³è™Ÿæ•´åˆèˆ‡è³‡æ–™åŒæ­¥ï¼Œæ˜¯æ•´å€‹ç³»çµ±çš„èº«ä»½è­˜åˆ¥èˆ‡æ¬Šé™ç®¡ç†åŸºçŸ³ã€‚

### 1.2 æŠ€è¡“å †ç–Š
- **å¾Œç«¯æ¡†æ¶**: Node.js/Express
- **è³‡æ–™åº«**: Firestore
- **èº«ä»½é©—è­‰**: LINE Login OAuth 2.0
- **æ—¥èªŒç³»çµ±**: DL æ¨¡çµ„
- **è³‡æ–™åŒæ­¥**: DD è³‡æ–™åˆ†ç™¼æ¨¡çµ„
- **è·¨å¹³å°æ”¯æ´**: iOS/Android SDK æ•´åˆ

### 1.3 æ¨¡çµ„æ¶æ§‹
```javascript
/**
 * AM_å¸³è™Ÿç®¡ç†æ¨¡çµ„_1.0.0
 * @module AMæ¨¡çµ„ 
 * @description è·¨å¹³å°å¸³è™Ÿç®¡ç†ç³»çµ± - æ”¯æ´LINE OAã€iOSã€Androidçµ±ä¸€å¸³è™Ÿç®¡ç†
 * @update 2025-01-09: åˆç‰ˆå»ºç«‹ï¼Œå¯¦ç¾è·¨å¹³å°å¸³è™Ÿæ•´åˆèˆ‡è³‡æ–™åŒæ­¥
 */
```

---

## 2.0 æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ

### 2.1 å¸³è™Ÿå‰µå»ºèˆ‡è¨»å†Šå‡½æ•¸

```javascript
/**
 * 01. å‰µå»ºLINE OAç”¨æˆ¶å¸³è™Ÿ
 * @version 2025-07-11-V2.0.0
 * @date 2025-07-11 18:00:00
 * @description é€éLINE OAuthå‰µå»ºç”¨æˆ¶å¸³è™Ÿä¸¦å»ºç«‹åŸºç¤è³‡æ–™çµæ§‹ï¼ŒåŒ…å«ç§‘ç›®åˆå§‹åŒ–
 */
function AM_createLineAccount(lineUID, lineProfile, userType)
```
- **åŠŸèƒ½**: å»ºç«‹LINEç”¨æˆ¶å¸³è™Ÿï¼Œè‡ªå‹•ç”¢ç”Ÿçµ±ä¸€UIDï¼Œä¸¦åˆå§‹åŒ–é è¨­ç§‘ç›®æ•¸æ“š
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `DL_log()` - è¨˜éŒ„å¸³è™Ÿå‰µå»ºæ—¥èªŒ
  - Firestore - å»ºç«‹ users collection æ–‡ä»¶
  - `AM_initializeUserSubjects()` - åˆå§‹åŒ–ç”¨æˆ¶ç§‘ç›®æ•¸æ“š
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼æ–°ç”¨æˆ¶è³‡æ–™
- **å›å‚³å€¼**: `{success: boolean, UID: string, accountId: string, subjectInitialized: boolean, subjectCount: number}`

```javascript
/**
 * 02. å‰µå»ºAPPç«¯ç”¨æˆ¶å¸³è™Ÿ
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description ç‚ºiOS/Androidå¹³å°å‰µå»ºç”¨æˆ¶å¸³è™Ÿ
 */
function AM_createAppAccount(platform, appProfile, deviceInfo)
```
- **åŠŸèƒ½**: å»ºç«‹APPç«¯å¸³è™Ÿï¼Œæ”¯æ´iOS_UIDå’ŒAndroid_UID
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `AM_generatePlatformUID()` - ç”¢ç”Ÿå¹³å°å°ˆå±¬UID
  - **DDæ¨¡çµ„** - åŒæ­¥å¸³è™Ÿè³‡æ–™åˆ°å…¶ä»–å¹³å°
- **å›å‚³å€¼**: `{success: boolean, platformUID: string, primaryUID: string}`

```javascript
/**
 * 03. è·¨å¹³å°å¸³è™Ÿé—œè¯
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description å°‡LINEã€iOSã€Androidå¸³è™Ÿé€²è¡Œé—œè¯ç¶å®š
 */
function AM_linkCrossPlatformAccounts(primaryUID, linkedAccountInfo)
```
- **åŠŸèƒ½**: å¯¦ç¾è·¨å¹³å°å¸³è™Ÿæ•¸æ“šä¸²æ¥èˆ‡åŒæ­¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `AM_validateAccountMapping()` - é©—è­‰å¸³è™Ÿé—œè¯åˆæ³•æ€§
  - Firestore - æ›´æ–° account_mappings collection
  - `DL_info()` - è¨˜éŒ„é—œè¯æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, linkedAccounts: object, mappingId: string}`

### 2.2 å¸³è™Ÿç®¡ç†èˆ‡ä¿®æ”¹å‡½æ•¸

```javascript
/**
 * 04. æ›´æ–°å¸³è™Ÿè³‡è¨Š
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description ä¿®æ”¹ä½¿ç”¨è€…å¸³è™ŸåŸºæœ¬è³‡è¨Šå’Œè¨­å®š
 */
function AM_updateAccountInfo(UID, updateData, operatorId)
```
- **åŠŸèƒ½**: å®‰å…¨æ›´æ–°å¸³è™Ÿè³‡è¨Šï¼Œæ”¯æ´è·¨å¹³å°åŒæ­¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `AM_validateUpdatePermission()` - é©—è­‰æ›´æ–°æ¬Šé™
  - **DDæ¨¡çµ„** - åŒæ­¥æ›´æ–°åˆ°æ‰€æœ‰é—œè¯å¹³å°
  - `DL_log()` - è¨˜éŒ„æ›´æ–°æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, updatedFields: array, syncStatus: object}`

```javascript
/**
 * 05. ä¿®æ”¹ç”¨æˆ¶é¡å‹
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description è®Šæ›´ç”¨æˆ¶é¡å‹ (M/S/J) å’Œç›¸é—œæ¬Šé™
 */
function AM_changeUserType(UID, newUserType, operatorId, reason)
```
- **åŠŸèƒ½**: å‹•æ…‹èª¿æ•´ç”¨æˆ¶é¡å‹èˆ‡æ¬Šé™ç­‰ç´š
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **MLSæ¨¡çµ„** - åŒæ­¥æ›´æ–°å¸³æœ¬æ¬Šé™
  - **CMæ¨¡çµ„** - æ›´æ–°å”ä½œæ¬Šé™è¨­å®š
  - `DL_warning()` - è¨˜éŒ„é¡å‹è®Šæ›´æ—¥èªŒ
- **å›å‚³å€¼**: `{success: boolean, oldType: string, newType: string, affectedLedgers: array}`

```javascript
/**
 * 06. è¨»éŠ·ç”¨æˆ¶å¸³è™Ÿ
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description å®‰å…¨è¨»éŠ·å¸³è™Ÿä¸¦è™•ç†ç›¸é—œæ•¸æ“šæ¸…ç†
 */
function AM_deactivateAccount(UID, deactivationReason, transferData)
```
- **åŠŸèƒ½**: å®Œæ•´çš„å¸³è™Ÿè¨»éŠ·æµç¨‹ï¼ŒåŒ…å«æ•¸æ“šé·ç§»
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **BSæ¨¡çµ„** - å»ºç«‹è¨»éŠ·å‰å®Œæ•´å‚™ä»½
  - **MLSæ¨¡çµ„** - è™•ç†å¸³æœ¬æ“æœ‰æ¬Šè½‰ç§»
  - `DL_error()` - è¨˜éŒ„è¨»éŠ·æ“ä½œè©³æƒ…
- **å›å‚³å€¼**: `{success: boolean, backupId: string, transferredLedgers: array}`

### 2.3 å¸³è™ŸæŸ¥è©¢èˆ‡é©—è­‰å‡½æ•¸

```javascript
/**
 * 07. æŸ¥è©¢ç”¨æˆ¶å¸³è™Ÿè³‡è¨Š
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description å®‰å…¨æŸ¥è©¢ç”¨æˆ¶åŸºæœ¬è³‡è¨Šå’Œè·¨å¹³å°é—œè¯
 */
function AM_getUserInfo(UID, requesterId, includeLinkedAccounts)
```
- **åŠŸèƒ½**: å®Œæ•´çš„ç”¨æˆ¶è³‡è¨ŠæŸ¥è©¢ï¼Œæ”¯æ´æ¬Šé™éæ¿¾
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `AM_validateQueryPermission()` - é©—è­‰æŸ¥è©¢æ¬Šé™
  - **MLSæ¨¡çµ„** - å–å¾—ç”¨æˆ¶å¸³æœ¬æ¸…å–®
- **å›å‚³å€¼**: `{success: boolean, userData: object, linkedAccounts: object}`

```javascript
/**
 * 08. é©—è­‰å¸³è™Ÿå­˜åœ¨æ€§
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description å¿«é€Ÿé©—è­‰å¸³è™Ÿæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
 */
function AM_validateAccountExists(identifier, platform)
```
- **åŠŸèƒ½**: é«˜æ•ˆçš„å¸³è™Ÿå­˜åœ¨æ€§æª¢æŸ¥æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - Firestore - æŸ¥è©¢ç”¨æˆ¶ collection
  - `DL_info()` - è¨˜éŒ„é©—è­‰å˜—è©¦
- **å›å‚³å€¼**: `{exists: boolean, UID: string, accountStatus: string}`

```javascript
/**
 * 09. æœå°‹ç”¨æˆ¶å¸³è™Ÿ
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description æ”¯æ´æ¨¡ç³Šæœå°‹å’Œå¤šæ¢ä»¶ç¯©é¸çš„å¸³è™Ÿæœå°‹
 */
function AM_searchUserAccounts(searchCriteria, requesterId, filterOptions)
```
- **åŠŸèƒ½**: æ™ºæ…§å¸³è™Ÿæœå°‹ï¼Œæ”¯æ´æ¬Šé™æ§åˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `AM_validateSearchPermission()` - é©—è­‰æœå°‹æ¬Šé™
  - **DDæ¨¡çµ„** - åˆ†ç™¼æœå°‹çµæœ
- **å›å‚³å€¼**: `{success: boolean, results: array, totalCount: number}`

### 2.4 LINE OAuth æ•´åˆå‡½æ•¸

```javascript
/**
 * 10. è™•ç†LINE OAuthæˆæ¬Š
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description è™•ç†LINE Login OAuthæµç¨‹å’ŒTokenç®¡ç†
 */
function AM_handleLineOAuth(authCode, state, redirectUri)
```
- **åŠŸèƒ½**: å®Œæ•´çš„LINE OAuthæˆæ¬Šè™•ç†æµç¨‹
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - LINE API - OAuth Token äº¤æ›
  - `AM_storeTokenSecurely()` - å®‰å…¨å„²å­˜æˆæ¬ŠToken
  - `DL_log()` - è¨˜éŒ„æˆæ¬Šéç¨‹
- **å›å‚³å€¼**: `{success: boolean, accessToken: string, refreshToken: string, userProfile: object}`

```javascript
/**
 * 11. åˆ·æ–°LINE Access Token
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description è‡ªå‹•åˆ·æ–°éæœŸçš„LINE Access Token
 */
function AM_refreshLineToken(UID, refreshToken)
```
- **åŠŸèƒ½**: Tokenè‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ï¼Œç¢ºä¿æœå‹™æŒçºŒæ€§
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - LINE API - Token åˆ·æ–°è«‹æ±‚
  - `AM_updateStoredToken()` - æ›´æ–°å„²å­˜çš„Token
- **å›å‚³å€¼**: `{success: boolean, newAccessToken: string, expiresIn: number}`

```javascript
/**
 * 12. é©—è­‰LINEç”¨æˆ¶èº«ä»½
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description é€éLINE APIé©—è­‰ç”¨æˆ¶èº«ä»½å’Œæ¬Šé™
 */
function AM_verifyLineIdentity(accessToken, expectedUID)
```
- **åŠŸèƒ½**: å®‰å…¨çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶ï¼Œé˜²æ­¢èº«ä»½å½é€ 
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - LINE API - ç”¨æˆ¶è³‡è¨Šé©—è­‰
  - `DL_warning()` - è¨˜éŒ„é©—è­‰å¤±æ•—å˜—è©¦
- **å›å‚³å€¼**: `{verified: boolean, userProfile: object, riskScore: number}`

### 2.5 è·¨å¹³å°è³‡æ–™åŒæ­¥å‡½æ•¸

```javascript
/**
 * 13. åŒæ­¥è·¨å¹³å°ç”¨æˆ¶è³‡æ–™
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description åœ¨LINEã€iOSã€Androidå¹³å°é–“åŒæ­¥ç”¨æˆ¶è³‡æ–™
 */
function AM_syncCrossPlatformData(UID, syncOptions, targetPlatforms)
```
- **åŠŸèƒ½**: æ™ºæ…§è·¨å¹³å°è³‡æ–™åŒæ­¥ï¼Œæ”¯æ´å¢é‡æ›´æ–°
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼åŒæ­¥è³‡æ–™
  - `AM_resolveDataConflict()` - è™•ç†è³‡æ–™è¡çª
  - `DL_info()` - è¨˜éŒ„åŒæ­¥ç‹€æ…‹
- **å›å‚³å€¼**: `{success: boolean, syncedPlatforms: array, conflicts: array}`

```javascript
/**
 * 14. è™•ç†å¹³å°è³‡æ–™è¡çª
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description åµæ¸¬ä¸¦è§£æ±ºè·¨å¹³å°è³‡æ–™ä¸ä¸€è‡´å•é¡Œ
 */
function AM_resolveDataConflict(conflictData, resolutionStrategy)
```
- **åŠŸèƒ½**: æ™ºæ…§è¡çªè§£æ±ºæ©Ÿåˆ¶ï¼Œæ”¯æ´å¤šç¨®åˆä½µç­–ç•¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **BSæ¨¡çµ„** - å»ºç«‹è¡çªå‰è³‡æ–™å‚™ä»½
  - `DL_warning()` - è¨˜éŒ„è¡çªè§£æ±ºéç¨‹
- **å›å‚³å€¼**: `{resolved: boolean, finalData: object, appliedStrategy: string}`

### 2.6 ç”¨æˆ¶ç§‘ç›®åˆå§‹åŒ–å‡½æ•¸

```javascript
/**
 * 17. åˆå§‹åŒ–ç”¨æˆ¶ç§‘ç›®æ•¸æ“š
 * @version 2025-07-11-V1.0.0
 * @date 2025-07-11 18:00:00
 * @description ç‚ºæ–°ç”¨æˆ¶åˆå§‹åŒ–é è¨­ç§‘ç›®æ•¸æ“š
 */
function AM_initializeUserSubjects(UID, ledgerIdPrefix)
```
- **åŠŸèƒ½**: å¾ç³»çµ±é è¨­ç§‘ç›®è¡¨ç‚ºæ–°ç”¨æˆ¶åˆå§‹åŒ–å®Œæ•´ç§‘ç›®æ¸…å–®
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `Subject_code.json` - è®€å–é è¨­ç§‘ç›®æ•¸æ“š
  - Firestore - æ‰¹æ¬¡å¯«å…¥ç§‘ç›®åˆ°ç”¨æˆ¶å¸³æœ¬
  - `DL_log()` - è¨˜éŒ„åˆå§‹åŒ–éç¨‹
- **å›å‚³å€¼**: `{success: boolean, importCount: number, userLedgerId: string}`

```javascript
/**
 * 18. æª¢æŸ¥ä¸¦è£œå……ç”¨æˆ¶ç§‘ç›®æ•¸æ“š
 * @version 2025-07-11-V1.0.0
 * @date 2025-07-11 18:00:00
 * @description æª¢æŸ¥ç”¨æˆ¶ç§‘ç›®æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡è‡ªå‹•åˆå§‹åŒ–
 */
function AM_ensureUserSubjects(UID)
```
- **åŠŸèƒ½**: æ™ºæ…§æª¢æŸ¥ç”¨æˆ¶ç§‘ç›®ç‹€æ…‹ï¼Œè‡ªå‹•è£œå……ç¼ºå¤±æ•¸æ“š
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - Firestore - æŸ¥è©¢ç”¨æˆ¶ç§‘ç›®æ•¸æ“š
  - `AM_initializeUserSubjects()` - æ¢ä»¶æ€§åˆå§‹åŒ–ç§‘ç›®
  - `DL_log()` - è¨˜éŒ„æª¢æŸ¥çµæœ
- **å›å‚³å€¼**: `{success: boolean, message: string, userLedgerId: string}`

### 2.7 éŒ¯èª¤è™•ç†èˆ‡ç›£æ§å‡½æ•¸

```javascript
/**
 * 15. è™•ç†å¸³è™Ÿæ“ä½œéŒ¯èª¤
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description çµ±ä¸€è™•ç†å¸³è™Ÿç®¡ç†éç¨‹ä¸­çš„å„ç¨®éŒ¯èª¤
 */
function AM_handleAccountError(errorType, errorData, context, retryCount)
```
- **åŠŸèƒ½**: æ¨™æº–åŒ–éŒ¯èª¤è™•ç†èˆ‡è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - `DL_error()` - è©³ç´°éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
  - **LINE OAæ¨¡çµ„** - ç™¼é€éŒ¯èª¤é€šçŸ¥
  - `AM_triggerErrorRecovery()` - å•Ÿå‹•éŒ¯èª¤æ¢å¾©æµç¨‹
- **å›å‚³å€¼**: `{handled: boolean, errorCode: string, retryScheduled: boolean}`

```javascript
/**
 * 16. ç›£æ§å¸³è™Ÿç³»çµ±å¥åº·ç‹€æ…‹
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description å³æ™‚ç›£æ§å¸³è™Ÿç®¡ç†ç³»çµ±çš„é‹è¡Œç‹€æ…‹
 */
function AM_monitorSystemHealth()
```
- **åŠŸèƒ½**: ç³»çµ±å¥åº·ç‹€æ…‹ç›£æ§èˆ‡é è­¦æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - Firestore - æª¢æŸ¥è³‡æ–™åº«é€£ç·šç‹€æ…‹
  - LINE API - æª¢æŸ¥APIæœå‹™ç‹€æ…‹
  - **MRAæ¨¡çµ„** - ç”Ÿæˆç³»çµ±å¥åº·å ±è¡¨
- **å›å‚³å€¼**: `{healthy: boolean, activeUsers: number, apiStatus: object, performance: object}`

---

## 3.0 æ¨¡çµ„é–“äº’å‹•æ¶æ§‹

### 3.1 æ ¸å¿ƒä¾è³´é—œä¿‚
```
AM å¸³è™Ÿç®¡ç†æ¨¡çµ„
â”œâ”€â”€ LINE API Integration
â”‚   â”œâ”€â”€ OAuth 2.0 èªè­‰æµç¨‹
â”‚   â”œâ”€â”€ User Profile API
â”‚   â””â”€â”€ Token Management
â”œâ”€â”€ DLæ¨¡çµ„ (Data Logging)
â”‚   â”œâ”€â”€ DL_log() - ä¸€èˆ¬æ“ä½œæ—¥èªŒ
â”‚   â”œâ”€â”€ DL_error() - éŒ¯èª¤æ—¥èªŒ
â”‚   â”œâ”€â”€ DL_warning() - è­¦å‘Šæ—¥èªŒ
â”‚   â””â”€â”€ DL_info() - è³‡è¨Šæ—¥èªŒ
â”œâ”€â”€ DDæ¨¡çµ„ (Data Distribution)
â”‚   â”œâ”€â”€ DD_distributeData() - è·¨å¹³å°è³‡æ–™åˆ†ç™¼
â”‚   â””â”€â”€ è³‡æ–™åŒæ­¥å”èª¿
â”œâ”€â”€ MLSæ¨¡çµ„ (Multi-Ledger System)
â”‚   â”œâ”€â”€ å¸³æœ¬æ¬Šé™åŒæ­¥
â”‚   â””â”€â”€ ç”¨æˆ¶å¸³æœ¬æ¸…å–®ç®¡ç†
â”œâ”€â”€ CMæ¨¡çµ„ (Collaboration Management)
â”‚   â”œâ”€â”€ å”ä½œæ¬Šé™ç®¡ç†
â”‚   â””â”€â”€ æˆå“¡èº«ä»½é©—è­‰
â”œâ”€â”€ BSæ¨¡çµ„ (Backup Service)
â”‚   â”œâ”€â”€ å¸³è™Ÿè³‡æ–™å‚™ä»½
â”‚   â””â”€â”€ è¨»éŠ·å‰è³‡æ–™ä¿å­˜
â”œâ”€â”€ MRAæ¨¡çµ„ (Multi-platform Report & Analytics)
â”‚   â”œâ”€â”€ ç”¨æˆ¶è¡Œç‚ºåˆ†æ
â”‚   â””â”€â”€ ç³»çµ±å¥åº·å ±è¡¨
â””â”€â”€ Firestore Database
    â”œâ”€â”€ users Collection - ä¸»è¦ç”¨æˆ¶è³‡æ–™
    â”œâ”€â”€ account_mappings Collection - è·¨å¹³å°é—œè¯
    â””â”€â”€ auth_tokens Collection - èªè­‰Tokenå„²å­˜
```

### 3.2 è³‡æ–™æµå‘è¨­è¨ˆ
```
ç”¨æˆ¶æ“ä½œè«‹æ±‚ â†’ AMèº«ä»½é©—è­‰ â†’ æ¬Šé™æª¢æŸ¥ â†’ è³‡æ–™æ“ä½œ â†’ 
è·¨å¹³å°åŒæ­¥ â†’ DDè³‡æ–™åˆ†ç™¼ â†’ DLæ—¥èªŒè¨˜éŒ„ â†’ å›æ‡‰ç”¨æˆ¶
```

---

## 4.0 è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ

### 4.1 Firestore é›†åˆçµæ§‹
```
users/
â”œâ”€â”€ {UID}/
â”‚   â”œâ”€â”€ displayName: string
â”‚   â”œâ”€â”€ userType: "M" | "S" | "J"
â”‚   â”œâ”€â”€ createdAt: timestamp (UTC+8)
â”‚   â”œâ”€â”€ lastActive: timestamp (UTC+8)
â”‚   â”œâ”€â”€ timezone: "Asia/Taipei"
â”‚   â”œâ”€â”€ linkedAccounts: object
â”‚   â”‚   â”œâ”€â”€ LINE_UID: string
â”‚   â”‚   â”œâ”€â”€ iOS_UID: string
â”‚   â”‚   â””â”€â”€ Android_UID: string
â”‚   â”œâ”€â”€ settings: object
â”‚   â”‚   â”œâ”€â”€ notifications: boolean
â”‚   â”‚   â””â”€â”€ language: "zh-TW"
â”‚   â”œâ”€â”€ joined_ledgers: array
â”‚   â””â”€â”€ metadata: object

account_mappings/
â”œâ”€â”€ {mapping_id}/
â”‚   â”œâ”€â”€ primary_UID: string
â”‚   â”œâ”€â”€ platform_accounts: object
â”‚   â”‚   â”œâ”€â”€ LINE: string
â”‚   â”‚   â”œâ”€â”€ iOS: string
â”‚   â”‚   â””â”€â”€ Android: string
â”‚   â”œâ”€â”€ created_at: timestamp (UTC+8)
â”‚   â”œâ”€â”€ updated_at: timestamp (UTC+8)
â”‚   â””â”€â”€ status: "active" | "suspended" | "deactivated"

auth_tokens/
â”œâ”€â”€ {UID}/
â”‚   â”œâ”€â”€ line_access_token: string (encrypted)
â”‚   â”œâ”€â”€ line_refresh_token: string (encrypted)
â”‚   â”œâ”€â”€ token_expires_at: timestamp (UTC+8)
â”‚   â”œâ”€â”€ last_refresh: timestamp (UTC+8)
â”‚   â””â”€â”€ token_scope: array
```

### 4.2 ç”¨æˆ¶é¡å‹æ¬Šé™è¨­è¨ˆ
```javascript
userTypePermissions: {
  M: { // Merged ledger admin
    level: 3,
    actions: ["create_multiple_ledgers", "merge_data", "admin_functions", "invite_users"],
    max_ledgers: -1 // unlimited
  },
  S: { // Single ledger
    level: 2,
    actions: ["create_single_ledger", "manage_own_data", "basic_reports"],
    max_ledgers: 1
  },
  J: { // Join other ledger
    level: 1,
    actions: ["join_ledgers", "view_data", "basic_input"],
    max_ledgers: 0 // can only join, not create
  }
}
```

---

## 5.0 API ä»‹é¢è¦æ ¼

### 5.1 REST API ç«¯é»
```
POST   /api/v2/accounts/create           - å»ºç«‹æ–°å¸³è™Ÿ
PUT    /api/v2/accounts/{uid}/update     - æ›´æ–°å¸³è™Ÿè³‡è¨Š
DELETE /api/v2/accounts/{uid}/delete     - è¨»éŠ·å¸³è™Ÿ
GET    /api/v2/accounts/{uid}            - æŸ¥è©¢å¸³è™Ÿè³‡è¨Š
POST   /api/v2/accounts/link             - è·¨å¹³å°å¸³è™Ÿé—œè¯
DELETE /api/v2/accounts/unlink           - è§£é™¤å¸³è™Ÿé—œè¯
GET    /api/v2/accounts/search           - å¸³è™Ÿæœå°‹
POST   /api/v2/auth/line/oauth           - LINE OAuthæˆæ¬Š
POST   /api/v2/auth/line/refresh         - åˆ·æ–°LINE Token
POST   /api/v2/auth/verify               - é©—è­‰èº«ä»½
POST   /api/v2/accounts/sync             - è·¨å¹³å°è³‡æ–™åŒæ­¥
GET    /api/v2/accounts/health           - ç³»çµ±å¥åº·æª¢æŸ¥
```

### 5.2 WebSocket äº‹ä»¶
```javascript
// å³æ™‚å¸³è™Ÿäº‹ä»¶
'account:created'        - å¸³è™Ÿå»ºç«‹
'account:updated'        - å¸³è™Ÿæ›´æ–°
'account:linked'         - è·¨å¹³å°é—œè¯
'account:deactivated'    - å¸³è™Ÿåœç”¨
'auth:token_refreshed'   - Tokenåˆ·æ–°
'sync:data_updated'      - è³‡æ–™åŒæ­¥å®Œæˆ
'error:auth_failed'      - èªè­‰å¤±æ•—
'system:health_alert'    - ç³»çµ±å¥åº·è­¦ç¤º
```

---

## 6.0 å®‰å…¨æ€§è¨­è¨ˆ

### 6.1 èº«ä»½èªè­‰å®‰å…¨
- LINE OAuth 2.0 æ¨™æº–æµç¨‹
- Token åŠ å¯†å„²å­˜æ©Ÿåˆ¶
- è‡ªå‹•Tokenåˆ·æ–°èˆ‡éæœŸè™•ç†
- å¤šé‡èº«ä»½é©—è­‰æ”¯æ´

### 6.2 è³‡æ–™ä¿è­·æªæ–½
- æ•æ„Ÿè³‡æ–™åŠ å¯†å„²å­˜
- è·¨å¹³å°è³‡æ–™å‚³è¼¸åŠ å¯†
- å¸³è™Ÿæ“ä½œå¯©è¨ˆæ—¥èªŒ
- æ¬Šé™åˆ†ç´šå­˜å–æ§åˆ¶

### 6.3 éŒ¯èª¤è™•ç†å®‰å…¨
- ä¸æ´©éœ²æ•æ„Ÿè³‡è¨Šçš„éŒ¯èª¤è¨Šæ¯
- å¤±æ•—å˜—è©¦é™åˆ¶èˆ‡ç›£æ§
- ç•°å¸¸è¡Œç‚ºè‡ªå‹•å‘Šè­¦æ©Ÿåˆ¶

---

## 7.0 æ•ˆèƒ½èˆ‡æ“´å±•æ€§è€ƒé‡

### 7.1 å¿«å–ç­–ç•¥
- ç”¨æˆ¶åŸºæœ¬è³‡è¨Šå¿«å– (15åˆ†é˜)
- è·¨å¹³å°é—œè¯å¿«å– (30åˆ†é˜)
- æ¬Šé™è³‡è¨Šå¿«å– (10åˆ†é˜)
- Tokenç‹€æ…‹å¿«å– (5åˆ†é˜)

### 7.2 æ‰¹æ¬¡è™•ç†å„ªåŒ–
- å¤§é‡å¸³è™Ÿæ“ä½œæ‰¹æ¬¡è™•ç†
- è·¨å¹³å°åŒæ­¥åˆ†æ‰¹åŸ·è¡Œ
- Tokenåˆ·æ–°æ‰¹æ¬¡æ’ç¨‹
- è³‡æ–™è¡çªæ‰¹æ¬¡è§£æ±º

### 7.3 å¹³å°æ“´å±•æ€§
- æ–°å¹³å°æ•´åˆæ¡†æ¶è¨­è¨ˆ
- çµ±ä¸€UIDç”Ÿæˆæ©Ÿåˆ¶
- å¯é…ç½®çš„å¹³å°ç‰¹æ€§æ”¯æ´
- å‹•æ…‹æ¬Šé™æ“´å±•èƒ½åŠ›

---

## 8.0 æ–‡ä»¶ç¶­è­·è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹è€… | ä¿®æ”¹å…§å®¹ |
|------|------|--------|----------|
| v1.0 | 2025-01-09 00:34:00 +08:00 | AustinLiao69 | åˆç‰ˆå»ºç«‹ï¼Œå®Œæ•´æŠ€è¡“è¨­è¨ˆï¼Œç¬¦åˆLCAS 2.0æ¶æ§‹ |
| v2.0 | 2025-08-02 10:00:00 +08:00 | LCAS SA Team | æ·»åŠ å®Œæ•´ç›®æ¬¡çµæ§‹ï¼Œå„ªåŒ–æ–‡ä»¶çµæ§‹ |

---

**æ–‡ä»¶çµæŸ**
*æ­¤æ–‡ä»¶ç‚º LCAS 2.0 AM å¸³è™Ÿç®¡ç†æ¨¡çµ„çš„å®Œæ•´æŠ€è¡“è¨­è¨ˆè¦æ ¼ï¼Œæ‰€æœ‰å‡½æ•¸è¨­è¨ˆå‡åŸºæ–¼ PRD éœ€æ±‚ä¸¦æ•´åˆè·¨å¹³å°çµ±ä¸€ç®¡ç†æ¶æ§‹ã€‚*
