# 5013. TDD_CM_協作管理模組_v1.0

## 文件資訊
- **文件標題**: CM 協作管理模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-07-07 14:19:46 +08:00 (台灣時間)
- **創建者**: AustinLiao69
- **對應需求文件**: 1013. CM_協作管理模組.md
- **模組代碼**: CM (Collaboration Management)

---

## 1.0 技術架構概述

### 1.1 模組定位
CM 協作管理模組作為 LCAS 2.0 的核心支柱模組，負責帳本多用戶協作功能，包括成員管理、權限分級、即時同步與變更追蹤，是多帳本系統協作的核心引擎。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **資料庫**: Firestore
- **即時通訊**: WebSocket (Socket.io)
- **日誌系統**: DL 模組
- **通知系統**: LINE OA模組

### 1.3 模組架構
```javascript
/**
 * CM_協作管理模組_1.0.0
 * @module CM模組 
 * @description 協作管理系統 - 支援多用戶權限管理、即時同步與協作通知
 * @update 2025-07-07: 初版建立，實現完整協作生態系統
 */
```

---

## 2.0 核心函數設計

### 2.1 成員管理函數

```javascript
/**
 * 01. 邀請成員加入帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 邀請新成員加入指定帳本並設定初始權限
 */
function CM_inviteMember(ledgerId, inviterId, inviteeInfo, initialPermission)
```
- **功能**: 成員邀請機制，支援多種邀請方式（email、LINE、用戶名）
- **與其他模組互動**:
  - **MLS模組** - 驗證帳本存取權限
  - **AM模組** `userProfileManager.js` - 驗證被邀請用戶
  - **LINE OA模組** - 發送邀請通知
- **回傳值**: `{success: boolean, invitationId: string, message: string}`

```javascript
/**
 * 02. 處理成員加入請求
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 處理用戶接受邀請或申請加入帳本
 */
function CM_processMemberJoin(invitationId, userId, responseType)
```
- **功能**: 處理邀請回應，自動設定成員權限
- **與其他模組互動**:
  - `CM_setMemberPermission()` - 設定成員權限
  - `DL_log()` - 記錄加入操作
  - **DD模組** - 分發成員變更資訊
- **回傳值**: `{success: boolean, memberId: string, permissions: object}`

```javascript
/**
 * 03. 移除協作成員
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 從帳本移除指定成員（含退出和被移除）
 */
function CM_removeMember(ledgerId, targetUserId, operatorId, removeType)
```
- **功能**: 安全的成員移除機制，支援主動退出和被動移除
- **與其他模組互動**:
  - `CM_validatePermission()` - 驗證移除權限
  - **備份服務模組** - 備份成員歷史資料
  - `DL_warning()` - 記錄移除操作
- **回傳值**: `{success: boolean, removedUser: string, newMemberCount: number}`

```javascript
/**
 * 04. 取得帳本成員清單
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 查詢指定帳本的所有成員及其權限狀態
 */
function CM_getMemberList(ledgerId, requesterId, includePermissions)
```
- **功能**: 完整的成員資訊查詢，支援權限過濾
- **與其他模組互動**:
  - **AM模組** - 取得用戶基本資訊
  - `CM_validatePermission()` - 驗證查詢權限
- **回傳值**: `{members: array, totalCount: number, permissions: object}`

### 2.2 權限管理函數

```javascript
/**
 * 05. 設定成員權限
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 設定或修改指定成員的帳本權限等級
 */
function CM_setMemberPermission(ledgerId, targetUserId, newPermission, operatorId)
```
- **功能**: 動態權限管理，支援四級權限體系
- **與其他模組互動**:
  - `CM_validatePermissionChange()` - 驗證權限變更合法性
  - **DD模組** - 即時同步權限變更
  - `DL_log()` - 記錄權限變更日誌
- **回傳值**: `{success: boolean, oldPermission: string, newPermission: string}`

```javascript
/**
 * 06. 驗證用戶操作權限
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 檢查用戶是否有權限執行特定操作
 */
function CM_validatePermission(ledgerId, userId, operationType)
```
- **功能**: 統一的權限驗證機制，支援細粒度操作權限
- **與其他模組互動**:
  - Firestore - 查詢用戶權限配置
  - `DL_warning()` - 記錄權限拒絕事件
- **回傳值**: `{hasPermission: boolean, currentLevel: string, requiredLevel: string}`

```javascript
/**
 * 07. 取得權限矩陣
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 取得完整的權限配置矩陣和操作規則
 */
function CM_getPermissionMatrix(ledgerId, userId)
```
- **功能**: 動態權限矩陣生成，支援自訂權限規則
- **與其他模組互動**:
  - **MLS模組** - 取得帳本類型相關權限
  - **BM模組** - 整合預算管理權限
- **回傳值**: `{permissionMatrix: object, allowedOperations: array}`

### 2.3 即時同步函數

```javascript
/**
 * 08. 初始化協作同步
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 為帳本建立即時協作同步連線
 */
function CM_initializeSync(ledgerId, userId, clientInfo)
```
- **功能**: WebSocket 連線建立，初始化協作環境
- **與其他模組互動**:
  - WebSocket Server - 建立即時連線
  - `CM_validatePermission()` - 驗證同步權限
  - `DL_info()` - 記錄同步連線
- **回傳值**: `{syncId: string, channelId: string, connectedUsers: array}`

```javascript
/**
 * 09. 處理資料同步衝突
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 偵測並解決多用戶同時編輯的資料衝突
 */
function CM_resolveDataConflict(conflictData, resolutionStrategy)
```
- **功能**: 智慧衝突解決，支援多種合併策略
- **與其他模組互動**:
  - **BK模組** - 處理記帳資料衝突
  - **備份服務模組** - 建立衝突前狀態備份
  - `DL_warning()` - 記錄衝突解決過程
- **回傳值**: `{resolved: boolean, finalData: object, conflictLog: array}`

```javascript
/**
 * 10. 廣播協作事件
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 向所有協作成員廣播重要事件變更
 */
function CM_broadcastEvent(ledgerId, eventType, eventData, excludeUsers)
```
- **功能**: 即時事件廣播，確保所有成員同步
- **與其他模組互動**:
  - WebSocket Server - 即時消息推送
  - **LINE OA模組** - 離線用戶通知
- **回傳值**: `{broadcasted: boolean, deliveredCount: number, eventId: string}`

### 2.4 協作通知函數

```javascript
/**
 * 11. 發送協作通知
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 向相關成員發送協作事件通知
 */
function CM_sendCollaborationNotification(notificationType, recipientList, notificationData)
```
- **功能**: 多管道協作通知系統
- **與其他模組互動**:
  - **LINE OA模組** - LINE 通知發送
  - **AM模組** - 取得用戶通知偏好
  - `DL_info()` - 記錄通知發送狀態
- **回傳值**: `{sent: boolean, deliveredChannels: array, notificationId: string}`

```javascript
/**
 * 12. 設定通知偏好
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 讓用戶自訂協作事件的通知設定
 */
function CM_setNotificationPreferences(userId, ledgerId, preferences)
```
- **功能**: 個人化通知設定管理
- **與其他模組互動**:
  - **AM模組** - 整合用戶偏好設定
  - **DD模組** - 同步偏好設定變更
- **回傳值**: `{updated: boolean, preferences: object, message: string}`

### 2.5 變更紀錄函數

```javascript
/**
 * 13. 記錄協作操作
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 詳細記錄所有協作相關的操作日誌
 */
function CM_logCollaborationAction(ledgerId, userId, actionType, actionData)
```
- **功能**: 完整的協作操作審計追蹤
- **與其他模組互動**:
  - `DL_log()` - 整合系統日誌
  - Firestore - 儲存詳細操作記錄
- **回傳值**: `{logged: boolean, logId: string, timestamp: string}`

```javascript
/**
 * 14. 查詢協作歷史
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 查詢指定帳本的協作操作歷史記錄
 */
function CM_getCollaborationHistory(ledgerId, userId, filterOptions)
```
- **功能**: 協作歷史查詢與分析
- **與其他模組互動**:
  - `CM_validatePermission()` - 驗證歷史查詢權限
  - **MRA模組** - 生成協作分析報表
- **回傳值**: `{history: array, totalCount: number, statistics: object}`

### 2.6 錯誤處理與監控函數

```javascript
/**
 * 15. 處理協作錯誤
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 統一處理協作過程中的各種錯誤情況
 */
function CM_handleCollaborationError(errorType, errorData, context)
```
- **功能**: 標準化協作錯誤處理與恢復
- **與其他模組互動**:
  - `DL_error()` - 記錄錯誤詳情
  - **LINE OA模組** - 發送錯誤通知
  - **備份服務模組** - 錯誤狀態恢復
- **回傳值**: `{handled: boolean, errorCode: string, recoveryAction: string}`

```javascript
/**
 * 16. 監控協作狀態
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:19:46
 * @description 即時監控協作系統的健康狀態
 */
function CM_monitorCollaborationHealth(ledgerId)
```
- **功能**: 協作系統健康狀態監控與預警
- **與其他模組互動**:
  - WebSocket Server - 檢查連線狀態
  - **MRA模組** - 生成協作效能報表
- **回傳值**: `{healthy: boolean, activeUsers: number, performance: object}`

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
CM 協作管理模組
├── MLS模組 (Multi-Ledger System)
│   ├── MLS_validateLedgerAccess() - 帳本權限驗證
│   └── MLS_getLedgerInfo() - 帳本基本資訊
├── AM模組 (Account Management)
│   ├── userProfileManager.js - 用戶資訊管理
│   └── 用戶偏好設定整合
├── DL模組 (Data Logging)
│   ├── DL_log() - 一般操作日誌
│   ├── DL_error() - 錯誤日誌
│   └── DL_warning() - 警告日誌
├── DD模組 (Data Distribution)
│   └── DD_distributeData() - 協作資料分發
├── BK模組 (Bookkeeping)
│   └── 記帳資料衝突處理
├── LINE OA模組
│   └── 協作通知發送
├── WebSocket服務
│   ├── 即時連線管理
│   └── 事件廣播
└── 備份服務模組 (Backup Service)
    └── 協作狀態備份與恢復
```

### 3.2 資料流向設計
```
協作請求 → CM權限驗證 → 操作執行 → 即時同步 → 
通知發送 → 日誌記錄 → 狀態廣播 → 回應用戶
```

---

## 4.0 資料庫架構設計

### 4.1 Firestore 集合結構
```
collaborations/
├── {ledger_id}/
│   ├── members: array
│   ├── permissions: object
│   ├── sync_settings: object
│   ├── notification_rules: object
│   ├── created_at: timestamp
│   └── updated_at: timestamp

collaboration_logs/
├── {log_id}/
│   ├── ledger_id: string
│   ├── user_id: string
│   ├── action_type: string
│   ├── action_data: object
│   ├── timestamp: timestamp
│   └── ip_address: string

member_invitations/
├── {invitation_id}/
│   ├── ledger_id: string
│   ├── inviter_id: string
│   ├── invitee_info: object
│   ├── permission_level: string
│   ├── status: "pending" | "accepted" | "declined" | "expired"
│   ├── created_at: timestamp
│   └── expires_at: timestamp
```

### 4.2 權限等級設計
```javascript
permissions: {
  owner: {
    level: 4,
    actions: ["all"]
  },
  admin: {
    level: 3,
    actions: ["invite", "remove", "edit", "view", "manage_permissions"]
  },
  member: {
    level: 2,
    actions: ["edit", "view", "invite_limited"]
  },
  viewer: {
    level: 1,
    actions: ["view"]
  }
}
```

---

## 5.0 API 介面規格

### 5.1 REST API 端點
```
POST   /api/v2/collaboration/invite           - 邀請成員
PUT    /api/v2/collaboration/join/{id}        - 處理加入請求
DELETE /api/v2/collaboration/remove           - 移除成員
GET    /api/v2/collaboration/members/{id}     - 取得成員清單
PUT    /api/v2/collaboration/permissions      - 設定權限
GET    /api/v2/collaboration/permissions/{id} - 查詢權限
POST   /api/v2/collaboration/sync/init        - 初始化同步
GET    /api/v2/collaboration/history/{id}     - 查詢協作歷史
```

### 5.2 WebSocket 事件
```javascript
// 即時協作事件
'collaboration:member_joined'     - 成員加入
'collaboration:member_left'       - 成員離開
'collaboration:permission_changed' - 權限變更
'collaboration:data_updated'      - 資料更新
'collaboration:conflict_detected' - 衝突偵測
'collaboration:sync_required'     - 需要同步
'collaboration:notification'      - 協作通知
```

---

## 6.0 效能與擴展性考量

### 6.1 快取策略
- 成員權限快取 (15分鐘)
- 協作狀態快取 (5分鐘)
- 通知偏好快取 (30分鐘)

### 6.2 即時同步優化
- WebSocket 連線池管理
- 事件去重與合併
- 分層廣播策略
- 離線用戶處理

---

## 7.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-07-07 14:19:46 +08:00 | AustinLiao69 | 初版建立，完整技術設計 |

---

**文件結束**
*此文件為 LCAS 2.0 CM 協作管理模組的完整技術設計規格，所有函數設計均基於協作需求並整合多帳本系統架構。*