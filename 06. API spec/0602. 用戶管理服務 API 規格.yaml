
openapi: 3.0.3
info:
  title: LCAS 2.0 - 用戶管理服務 API 規格
  version: 1.0.0
  description: |
    **LCAS 2.0 用戶管理服務 API 規格**
    
    負責用戶資料管理、偏好設定、模式評估與個人化配置的完整 API 規格。
    支援四模式差異化體驗，提供用戶生命週期的完整管理功能。
    
    **服務範圍**:
    - 用戶資料管理（個人資料、偏好設定）
    - 模式評估與切換（Expert、Inertial、Cultivation、Guiding）
    - 安全設定（應用鎖、隱私模式）
    - 使用行為追蹤與個人化推薦
    
    **四模式差異化策略**:
    - **Expert**: 完整控制權、詳細設定選項、專業化配置
    - **Inertial**: 標準設定、簡潔選項、固定流程
    - **Cultivation**: 引導式設定、進度追蹤、習慣養成
    - **Guiding**: 極簡設定、自動化配置、最少決策
    
    **版本**: 1.0.0  
    **建立日期**: 2025-08-21  
    **對應文件**: 0021. Screen list.md (S-103, S-106, S-505)

servers:
  - url: https://api.lcas.app/v1
    description: "Production server"
  - url: https://api-staging.lcas.app/v1
    description: "Staging server"

security:
  - BearerAuth: []

paths:
  /users/profile:
    get:
      summary: "取得用戶個人資料"
      description: |
        取得當前用戶的完整個人資料，包含基本資訊、偏好設定與統計數據。
        
        **對應畫面**: S-505 個人設定頁
        **四模式差異**: 回應資料深度與個人化程度不同
      tags:
        - "用戶資料管理"
      parameters:
        - name: X-User-Mode
          in: header
          description: "用戶模式標識"
          required: false
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
      responses:
        '200':
          description: "成功取得用戶資料"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      # 基本資料（所有模式）
                      id:
                        type: string
                        example: "user-uuid-12345"
                      email:
                        type: string
                        example: "user@example.com"
                      displayName:
                        type: string
                        example: "張小明"
                      avatar:
                        type: string
                        example: "https://api.lcas.app/avatars/user-123.jpg"
                      userMode:
                        type: string
                        enum: [Expert, Inertial, Cultivation, Guiding]
                        example: "Expert"
                      createdAt:
                        type: string
                        format: date-time
                        example: "2025-01-01T00:00:00Z"
                      lastLoginAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T10:30:00Z"
                      
                      # Expert/Inertial Mode: 詳細統計
                      statistics:
                        type: object
                        properties:
                          totalTransactions:
                            type: integer
                            example: 1250
                          totalLedgers:
                            type: integer
                            example: 3
                          averageDailyRecords:
                            type: number
                            example: 4.2
                          longestStreak:
                            type: integer
                            example: 45
                      
                      # Cultivation Mode: 成就與進度
                      achievements:
                        type: object
                        properties:
                          currentLevel:
                            type: integer
                            example: 8
                          totalPoints:
                            type: integer
                            example: 2350
                          nextLevelPoints:
                            type: integer
                            example: 2500
                          currentStreak:
                            type: integer
                            example: 12
                      
                      # Expert Mode: 進階設定
                      preferences:
                        type: object
                        properties:
                          language:
                            type: string
                            example: "zh-TW"
                          currency:
                            type: string
                            example: "TWD"
                          timezone:
                            type: string
                            example: "Asia/Taipei"
                          dateFormat:
                            type: string
                            example: "YYYY-MM-DD"
                          theme:
                            type: string
                            enum: [light, dark, auto]
                            example: "auto"
                          defaultLedgerId:
                            type: string
                            example: "ledger-uuid-001"
                      
                      # 安全設定
                      security:
                        type: object
                        properties:
                          hasAppLock:
                            type: boolean
                            example: true
                          biometricEnabled:
                            type: boolean
                            example: true
                          privacyModeEnabled:
                            type: boolean
                            example: false
                          twoFactorEnabled:
                            type: boolean
                            example: false
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: "更新用戶個人資料"
      description: |
        更新用戶的個人資料，包含基本資訊與顯示偏好。
        
        **對應畫面**: S-505 個人設定頁
        **四模式差異**: 可編輯欄位數量與複雜度不同
      tags:
        - "用戶資料管理"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayName:
                  type: string
                  example: "張小明"
                  maxLength: 50
                avatar:
                  type: string
                  example: "base64-encoded-image-data"
                language:
                  type: string
                  enum: [zh-TW, en-US]
                  example: "zh-TW"
                timezone:
                  type: string
                  example: "Asia/Taipei"
                theme:
                  type: string
                  enum: [light, dark, auto]
                  example: "dark"
      responses:
        '200':
          description: "更新成功"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "個人資料更新成功"
                      updatedAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/assessment-questions:
    get:
      summary: "取得模式評估問卷"
      description: |
        取得用於判斷用戶適合模式的評估問卷題目。
        
        **對應畫面**: S-106 模式評估問卷頁
        **使用時機**: 新用戶註冊後、用戶主動重新評估
      tags:
        - "模式評估"
      responses:
        '200':
          description: "成功取得問卷題目"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      questionnaire:
                        type: object
                        properties:
                          id:
                            type: string
                            example: "assessment-v2.1"
                          version:
                            type: string
                            example: "2.1"
                          title:
                            type: string
                            example: "LCAS 2.0 使用者模式評估"
                          description:
                            type: string
                            example: "透過 5 道題目了解您的記帳習慣，為您推薦最適合的使用模式"
                          estimatedTime:
                            type: integer
                            example: 3
                          questions:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: integer
                                  example: 1
                                question:
                                  type: string
                                  example: "您對記帳軟體的功能需求程度？"
                                type:
                                  type: string
                                  enum: [single_choice, multiple_choice]
                                  example: "single_choice"
                                required:
                                  type: boolean
                                  example: true
                                options:
                                  type: array
                                  items:
                                    type: object
                                    properties:
                                      id:
                                        type: string
                                        example: "A"
                                      text:
                                        type: string
                                        example: "需要完整專業功能"
                                      weight:
                                        type: object
                                        properties:
                                          Expert:
                                            type: integer
                                            example: 3
                                          Inertial:
                                            type: integer
                                            example: 1
                                          Cultivation:
                                            type: integer
                                            example: 2
                                          Guiding:
                                            type: integer
                                            example: 0
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/assessment:
    post:
      summary: "提交模式評估結果"
      description: |
        提交用戶完成的評估問卷，系統分析後回傳推薦的使用模式。
        
        **對應畫面**: S-106 模式評估問卷頁
        **業務邏輯**: 根據回答計算最適合的模式並更新用戶設定
      tags:
        - "模式評估"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionnaireId:
                  type: string
                  example: "assessment-v2.1"
                answers:
                  type: array
                  items:
                    type: object
                    properties:
                      questionId:
                        type: integer
                        example: 1
                      selectedOptions:
                        type: array
                        items:
                          type: string
                        example: ["A"]
                completedAt:
                  type: string
                  format: date-time
                  example: "2025-01-27T12:05:00Z"
              required:
                - questionnaireId
                - answers
      responses:
        '200':
          description: "評估完成，回傳推薦模式"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      result:
                        type: object
                        properties:
                          recommendedMode:
                            type: string
                            enum: [Expert, Inertial, Cultivation, Guiding]
                            example: "Expert"
                          confidence:
                            type: number
                            example: 85.5
                          scores:
                            type: object
                            properties:
                              Expert:
                                type: number
                                example: 12.5
                              Inertial:
                                type: number
                                example: 7.0
                              Cultivation:
                                type: number
                                example: 9.5
                              Guiding:
                                type: number
                                example: 4.0
                          explanation:
                            type: string
                            example: "基於您的回答，您偏好擁有完整功能控制權與專業工具，建議使用專家模式以獲得最佳體驗。"
                          modeCharacteristics:
                            type: object
                            properties:
                              Expert:
                                type: string
                                example: "完整功能、專業工具、深度設定"
                              alternatives:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    mode:
                                      type: string
                                      example: "Inertial"
                                    reason:
                                      type: string
                                      example: "如果您偏好更簡潔的介面"
                      applied:
                        type: boolean
                        example: true
                      previousMode:
                        type: string
                        example: "Inertial"
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/preferences:
    put:
      summary: "更新用戶偏好設定"
      description: |
        更新用戶的應用偏好設定，包含預設值、通知設定等。
        
        **對應畫面**: S-505 個人設定頁
        **四模式差異**: 可設定的偏好項目數量不同
      tags:
        - "用戶資料管理"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                # 基本偏好（所有模式）
                currency:
                  type: string
                  example: "TWD"
                dateFormat:
                  type: string
                  example: "YYYY-MM-DD"
                defaultLedgerId:
                  type: string
                  example: "ledger-uuid-001"
                
                # Expert/Inertial Mode: 進階偏好
                numberFormat:
                  type: string
                  example: "#,##0.00"
                fiscalYearStart:
                  type: string
                  example: "01-01"
                autoBackupEnabled:
                  type: boolean
                  example: true
                
                # 通知偏好
                notifications:
                  type: object
                  properties:
                    dailyReminder:
                      type: boolean
                      example: true
                    budgetAlert:
                      type: boolean
                      example: true
                    weeklyReport:
                      type: boolean
                      example: false
                
                # Cultivation Mode: 激勵偏好
                gamification:
                  type: object
                  properties:
                    achievementNotifications:
                      type: boolean
                      example: true
                    challengeReminders:
                      type: boolean
                      example: true
                    streakCelebration:
                      type: boolean
                      example: true
      responses:
        '200':
          description: "偏好設定更新成功"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "偏好設定已更新"
                      updatedAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
                      appliedChanges:
                        type: array
                        items:
                          type: string
                        example: ["currency", "notifications.dailyReminder"]
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/security:
    put:
      summary: "更新安全設定"
      description: |
        更新用戶的安全相關設定，包含應用鎖、生物辨識、隱私模式等。
        
        **對應畫面**: S-503 安全設定頁
        **安全考量**: PIN 碼等敏感資料需加密傳輸
      tags:
        - "安全管理"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                appLock:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: true
                    method:
                      type: string
                      enum: [pin, pattern, biometric]
                      example: "biometric"
                    pinCode:
                      type: string
                      example: "encrypted-pin-hash"
                      description: "加密後的 PIN 碼"
                    autoLockTime:
                      type: integer
                      example: 300
                      description: "自動鎖定時間（秒）"
                
                privacyMode:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: false
                    hideAmounts:
                      type: boolean
                      example: false
                    maskCategories:
                      type: boolean
                      example: false
                
                biometric:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: true
                    method:
                      type: string
                      enum: [fingerprint, face, voice]
                      example: "fingerprint"
                
                twoFactor:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: false
                    method:
                      type: string
                      enum: [sms, email, authenticator]
                      example: "email"
      responses:
        '200':
          description: "安全設定更新成功"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "安全設定已更新"
                      securityLevel:
                        type: string
                        enum: [low, medium, high]
                        example: "high"
                      updatedSettings:
                        type: array
                        items:
                          type: string
                        example: ["appLock", "biometric"]
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/mode:
    put:
      summary: "切換用戶模式"
      description: |
        允許用戶手動切換使用模式，無需重新評估。
        
        **業務邏輯**: 切換後即時生效，影響後續 API 回應格式
        **使用場景**: 用戶體驗不同模式、臨時需求變更
      tags:
        - "模式管理"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newMode:
                  type: string
                  enum: [Expert, Inertial, Cultivation, Guiding]
                  example: "Cultivation"
                reason:
                  type: string
                  example: "想要嘗試習慣養成功能"
              required:
                - newMode
      responses:
        '200':
          description: "模式切換成功"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      previousMode:
                        type: string
                        example: "Expert"
                      currentMode:
                        type: string
                        example: "Cultivation"
                      changedAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
                      modeDescription:
                        type: string
                        example: "養成模式：專注於習慣培養與進度追蹤"
                      suggestedFeatures:
                        type: array
                        items:
                          type: string
                        example: ["每日挑戰", "成就系統", "記帳提醒"]
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/mode-defaults:
    get:
      summary: "取得模式預設值"
      description: |
        取得指定模式的預設配置，用於模式切換時的初始化。
        
        **使用場景**: 模式切換、新用戶設定、功能重置
      tags:
        - "模式管理"
      parameters:
        - name: mode
          in: query
          description: "要查詢的模式"
          required: true
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
      responses:
        '200':
          description: "成功取得模式預設值"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      mode:
                        type: string
                        example: "Expert"
                      defaults:
                        type: object
                        properties:
                          ui:
                            type: object
                            properties:
                              showAdvancedOptions:
                                type: boolean
                                example: true
                              compactView:
                                type: boolean
                                example: false
                              chartComplexity:
                                type: string
                                enum: [simple, standard, advanced]
                                example: "advanced"
                          features:
                            type: object
                            properties:
                              batchOperations:
                                type: boolean
                                example: true
                              customCategories:
                                type: boolean
                                example: true
                              detailedReports:
                                type: boolean
                                example: true
                          notifications:
                            type: object
                            properties:
                              frequency:
                                type: string
                                enum: [none, daily, weekly]
                                example: "weekly"
                              types:
                                type: array
                                items:
                                  type: string
                                example: ["budget_alert", "monthly_report"]
        '400':
          $ref: '#/components/responses/ValidationError'

  /users/behavior-tracking:
    post:
      summary: "記錄使用行為追蹤"
      description: |
        記錄用戶的使用行為，用於個人化推薦與模式優化。
        
        **隱私考量**: 僅記錄功能使用統計，不記錄具體內容
        **數據用途**: 改善用戶體驗、功能推薦、模式優化
      tags:
        - "行為分析"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sessionId:
                  type: string
                  example: "session-uuid-12345"
                events:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [screen_view, feature_used, action_completed]
                        example: "feature_used"
                      name:
                        type: string
                        example: "quick_transaction"
                      timestamp:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
                      properties:
                        type: object
                        example:
                          duration: 1200
                          success: true
                          mode: "Expert"
              required:
                - events
      responses:
        '200':
          description: "行為記錄成功"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      recorded:
                        type: integer
                        example: 5
                      sessionId:
                        type: string
                        example: "session-uuid-12345"
        '400':
          $ref: '#/components/responses/ValidationError'

  /users/mode-recommendations:
    get:
      summary: "取得模式優化建議"
      description: |
        基於用戶使用行為分析，提供模式切換或功能使用建議。
        
        **AI 分析**: 根據使用模式分析適合度並提供建議
        **推薦策略**: 個人化推薦、使用效率優化
      tags:
        - "個人化推薦"
      responses:
        '200':
          description: "成功取得個人化建議"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      currentModeScore:
                        type: number
                        example: 8.5
                        description: "當前模式適合度評分（1-10）"
                      recommendations:
                        type: array
                        items:
                          type: object
                          properties:
                            type:
                              type: string
                              enum: [mode_switch, feature_suggestion, workflow_optimization]
                              example: "feature_suggestion"
                            title:
                              type: string
                              example: "嘗試使用預算管理功能"
                            description:
                              type: string
                              example: "根據您的記帳習慣，建議設定月度預算來更好控制支出"
                            priority:
                              type: string
                              enum: [low, medium, high]
                              example: "medium"
                            action:
                              type: object
                              properties:
                                type:
                                  type: string
                                  example: "navigate"
                                target:
                                  type: string
                                  example: "/budgets/create"
                      analysisDate:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "Firebase Auth JWT Token"

  responses:
    UnauthorizedError:
      description: "未授權存取"
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: object
                properties:
                  code:
                    type: string
                    example: "UNAUTHORIZED"
                  message:
                    type: string
                    example: "Token 無效或已過期"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-27T12:00:00Z"

    ValidationError:
      description: "請求參數驗證失敗"
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: object
                properties:
                  code:
                    type: string
                    example: "VALIDATION_ERROR"
                  message:
                    type: string
                    example: "請求參數不正確"
                  field:
                    type: string
                    example: "displayName"
                  details:
                    type: string
                    example: "顯示名稱不能超過 50 個字元"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-27T12:00:00Z"

    InternalServerError:
      description: "內部伺服器錯誤"
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: object
                properties:
                  code:
                    type: string
                    example: "INTERNAL_SERVER_ERROR"
                  message:
                    type: string
                    example: "伺服器暫時無法處理請求，請稍後再試"
                  requestId:
                    type: string
                    example: "req-uuid-12345"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-27T12:00:00Z"

tags:
  - name: "用戶資料管理"
    description: "用戶個人資料與偏好設定管理"
  - name: "模式評估"
    description: "使用者模式評估與推薦"
  - name: "模式管理"
    description: "使用者模式切換與配置管理"
  - name: "安全管理"
    description: "應用安全與隱私設定"
  
  - name: "行為分析"
    description: "使用行為追蹤與分析"
  - name: "個人化推薦"
    description: "基於 AI 分析的個人化建議"
