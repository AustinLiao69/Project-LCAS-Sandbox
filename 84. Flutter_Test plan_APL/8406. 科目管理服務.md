
# 8406. 科目管理服務 

**版本**: 2.4.0  
**建立日期**: 2025-09-05  
**最後更新**: 2025-09-10  
**建立者**: SQA Team  
**來源文件**: 8206. 科目管理服務.md, 8106. 科目管理服務 API 規格.yaml  
**遵循規範**: 8020. API list.md, 8088. API設計規範.md

---

## 📑 目次 (Table of Contents)

1. [測試概覽](#1-測試概覽)
   - 1.1 [測試範圍](#11-測試範圍)
   - 1.2 [測試目標](#12-測試目標)
   - 1.3 [風險評估](#13-風險評估)

2. [測試案例索引表](#2-測試案例索引表)

3. [測試環境與準備](#3-測試環境與準備)
   - 3.1 [系統環境需求](#31-系統環境需求)
   - 3.2 [測試資料準備](#32-測試資料準備)
   - 3.3 [相依模組狀態](#33-相依模組狀態)

4. [功能測試範圍](#4-功能測試範圍)
   - 4.1 [科目CRUD模組測試](#41-科目crud模組測試)
   - 4.2 [階層管理模組測試](#42-階層管理模組測試)
   - 4.3 [科目分類模組測試](#43-科目分類模組測試)
   - 4.4 [使用統計模組測試](#44-使用統計模組測試)
   - 4.5 [個人化設定模組測試](#45-個人化設定模組測試)

5. [詳細測試案例](#5-詳細測試案例)
   - 5.1 [核心功能測試案例](#51-核心功能測試案例)
   - 5.2 [階層結構測試案例](#52-階層結構測試案例)
   - 5.3 [四模式差異化測試案例](#53-四模式差異化測試案例)
   - 5.4 [API端點一致性測試案例](#54-api端點一致性測試案例)
   - 5.5 [異常處理測試案例](#55-異常處理測試案例)

6. [效能與壓力測試](#6-效能與壓力測試)
   - 6.1 [科目管理效能](#61-科目管理效能)
   - 6.2 [階層查詢能力](#62-階層查詢能力)
   - 6.3 [記憶體使用監控](#63-記憶體使用監控)

7. [安全性與權限測試](#7-安全性與權限測試)
   - 7.1 [輸入驗證測試](#71-輸入驗證測試)
   - 7.2 [階層安全測試](#72-階層安全測試)
   - 7.3 [API安全性測試](#73-api安全性測試)

---

## 1. 測試概覽

### 1.1 測試範圍

#### 1.1.1 科目管理服務核心功能測試
- **科目CRUD操作**：建立、查詢、修改、刪除科目（5個函數）
- **階層管理**：科目樹狀結構、父子關係管理（9個函數）
- **科目分類**：收入、支出、轉帳科目類型處理（3個函數）
- **使用統計**：科目使用頻率、金額分析（2個函數）
- **個人化設定**：常用科目、快速選擇、預設科目（4個函數）
- **模式適配**：四模式差異化回應處理（8個函數）

#### 1.1.2 API端點整合測試
- **8106 API規格對應**：5個標準API端點完整驗證
- **8088 API設計規範**：統一回應格式、錯誤處理、JWT認證
- **8020 API list映射**：S-204、S-306畫面功能支援
- **四模式差異化**：Expert、Inertial、Cultivation、Guiding模式測試

#### 1.1.3 Dart語言函數規格測試
- **函數簽名驗證**：31個核心函數版次v2.4.0規格檢查
- **類別設計驗證**：4個主要類別架構完整性
- **介面一致性**：Repository Pattern實作正確性
- **模式適配器**：UserModeAdapter四模式回應過濾

### 1.2 測試目標

#### 1.2.1 功能完整性目標
- 科目管理服務31個函數100%功能驗證通過
- 3種科目類型(income、expense、transfer)完整支援驗證
- API端點與8106規格100%一致性驗證
- 四模式差異化回應100%準確性驗證

#### 1.2.2 效能指標目標
- 單次科目操作回應時間 < 1 秒
- 科目樹狀結構查詢處理回應時間 < 800ms
- 支援1000+併發科目查詢處理
- 記憶體使用率維持 < 80%

#### 1.2.3 穩定性目標
- 系統連續運行24小時無故障
- 科目操作成功率 > 99.5%
- 階層結構一致性 = 100%
- 統計資料準確性 = 100%

### 1.3 風險評估

#### 1.3.1 高風險項目
1. **階層結構循環檢測複雜性**
   - 風險：科目父子關係複雜，循環檢測演算法效能問題
   - 影響：樹狀結構錯誤，科目管理功能失效
   - 緩解：完整的循環檢測演算法效能測試與優化

2. **併發階層修改一致性**
   - 風險：多用戶同時修改階層結構造成資料不一致
   - 影響：階層結構破損，系統穩定性下降
   - 緩解：完整的併發控制與鎖定機制測試

3. **大型科目樹查詢效能**
   - 風險：大量科目(1000+)樹狀查詢效能下降
   - 影響：查詢回應緩慢，使用者體驗差
   - 緩解：建立完整的大型樹查詢效能測試

#### 1.3.2 中風險項目
1. **四模式推薦邏輯複雜性**
   - 風險：不同模式的科目推薦演算法複雜度高
   - 影響：推薦不適當的科目，影響使用者體驗
   - 緩解：每個模式的完整推薦邏輯測試

2. **階層深度限制執行**
   - 風險：5層深度限制執行不一致
   - 影響：階層結構超深，系統效能問題
   - 緩解：完整的深度限制檢查測試

---

## 2. 測試案例索引表

| 測試案例編號 | 測試案例名稱 | 測試類型 |
|-------------|-------------|----------|
| TC-001 | 科目列表查詢API樹狀結構測試 | 功能測試 |
| TC-002 | 科目建立API階層處理測試 | 功能測試 |
| TC-003 | 科目更新API階層調整測試 | 功能測試 |
| TC-004 | 科目刪除API級聯處理測試 | 功能測試 |
| TC-005 | 科目詳情查詢API完整信息測試 | 功能測試 |
| TC-006 | 科目樹狀結構建構邏輯測試 | 階層結構測試 |
| TC-007 | 階層循環檢測演算法測試 | 階層結構測試 |
| TC-008 | 階層深度限制驗證測試 | 階層結構測試 |
| TC-009 | 大型樹狀結構效能測試 | 階層結構測試 |
| TC-010 | 併發階層修改一致性測試 | 階層結構測試 |
| TC-011 | Expert模式完整功能測試 | 四模式測試 |
| TC-012 | Cultivation模式習慣分析測試 | 四模式測試 |
| TC-013 | Guiding模式簡化體驗測試 | 四模式測試 |
| TC-014 | Inertial模式標準功能測試 | 四模式測試 |
| TC-015 | 8106規格一致性驗證測試 | API一致性測試 |
| TC-016 | 統一回應格式驗證測試 | API一致性測試 |
| TC-017 | 階層結構異常處理測試 | 異常處理測試 |
| TC-018 | 科目統計異常處理測試 | 異常處理測試 |
| TC-019 | 權限驗證異常處理測試 | 異常處理測試 |
| TC-020 | 科目操作效能基準測試 | 效能測試 |
| TC-021 | 樹狀查詢併發能力測試 | 效能測試 |
| TC-022 | 記憶體使用監控測試 | 效能測試 |
| TC-023 | 惡意輸入防護測試 | 安全性測試 |
| TC-024 | 階層權限檢查測試 | 安全性測試 |
| TC-025 | 跨帳本資料隔離測試 | 安全性測試 |

---

## 3. 測試環境與準備

### 3.1 系統環境需求

#### 3.1.1 核心環境
- **Dart SDK**: 3.0.0+ (Flutter 3.13.0+)
- **測試框架**: test ^1.24.0
- **HTTP客戶端**: dio ^5.3.0
- **JSON序列化**: json_annotation ^4.8.0
- **UUID生成**: uuid ^4.0.0
- **樹狀結構**: collection ^1.17.0
- **路徑計算**: path ^1.8.0

#### 3.1.2 API測試環境
- **測試伺服器**: https://api-staging.lcas.app/v1
- **認證方式**: Bearer Token (JWT)
- **API版本**: v1.0.2
- **回應格式**: JSON (遵循8088規範)

#### 3.1.3 科目類型測試環境
- **收入科目**: 薪資、投資收益、其他收入
- **支出科目**: 餐飲、交通、購物、娛樂等
- **轉帳科目**: 帳戶間轉移、還款等
- **階層結構**: 最深5層、支援樹狀結構

### 3.2 測試資料準備

#### 3.2.1 使用者測試資料
```dart
// 測試用戶類型 - v2.4.0
const Map<String, TestUser> testUsers = {
  'expertUser': TestUser('test_expert_001', UserMode.Expert),
  'inertialUser': TestUser('test_inertial_001', UserMode.Inertial),
  'cultivationUser': TestUser('test_cultivation_001', UserMode.Cultivation),
  'guidingUser': TestUser('test_guiding_001', UserMode.Guiding),
};
```

#### 3.2.2 科目測試資料
```dart
// 科目測試案例 - v2.4.0
const Map<String, CreateCategoryRequest> testCategories = {
  'incomeCategory': CreateCategoryRequest(
    name: '薪資收入',
    type: CategoryType.income,
    icon: '💰',
    color: '#4CAF50',
    ledgerId: 'test-ledger-001'
  ),
  'expenseParentCategory': CreateCategoryRequest(
    name: '餐飲',
    type: CategoryType.expense,
    icon: '🍽️',
    color: '#FF5722',
    ledgerId: 'test-ledger-001'
  ),
  'expenseChildCategory': CreateCategoryRequest(
    name: '早餐',
    type: CategoryType.expense,
    parentId: 'category-food-parent',
    icon: '🥞',
    color: '#FFC107',
    ledgerId: 'test-ledger-001'
  ),
  'transferCategory': CreateCategoryRequest(
    name: '帳戶轉移',
    type: CategoryType.transfer,
    icon: '🔄',
    color: '#2196F3',
    ledgerId: 'test-ledger-001'
  ),
};
```

#### 3.2.3 階層結構測試資料
```dart
// 複雜階層結構測試 - v2.4.0
const Map<String, CategoryHierarchy> testHierarchies = {
  'normalHierarchy': CategoryHierarchy([
    'Level0: 支出',
    '  Level1: 餐飲',
    '    Level2: 早餐',
    '    Level2: 午餐', 
    '    Level2: 晚餐',
    '  Level1: 交通',
    '    Level2: 捷運',
    '    Level2: 公車'
  ]),
  'deepHierarchy': CategoryHierarchy([
    'L0: 投資',
    '  L1: 股票',
    '    L2: 台股',
    '      L3: 金融股',
    '        L4: 銀行股',
    '          L5: 特定銀行'
  ]),
  'complexHierarchy': CategoryHierarchy([
    'L0: 生活支出',
    '  L1: 基本需求',
    '    L2: 食物',
    '      L3: 主食',
    '      L3: 零食',
    '    L2: 住宿',
    '  L1: 娛樂休閒',
    '    L2: 運動',
    '    L2: 旅遊'
  ]),
};
```

#### 3.2.4 效能測試資料
```dart
// 大量資料測試場景 - v2.4.0
const Map<String, CategoryPerformanceScenario> performanceScenarios = {
  'smallDataSet': CategoryPerformanceScenario(
    categoryCount: 50,
    maxDepth: 3,
    childrenPerNode: 5
  ),
  'mediumDataSet': CategoryPerformanceScenario(
    categoryCount: 500,
    maxDepth: 4,
    childrenPerNode: 8
  ),
  'largeDataSet': CategoryPerformanceScenario(
    categoryCount: 2000,
    maxDepth: 5,
    childrenPerNode: 10
  ),
};
```

### 3.3 相依模組狀態

#### 3.3.1 必要依賴模組
- **帳本管理服務**: v2.4.0+ (科目所屬帳本驗證)
- **認證服務**: v2.4.0+ (JWT Token驗證)
- **記帳交易服務**: v2.4.0+ (科目使用統計計算)

#### 3.3.2 選用依賴模組
- **報表分析服務**: v2.4.0+ (科目分析統計)
- **預算管理服務**: v2.4.0+ (科目預算關聯)
- **AI助理服務**: v2.4.0+ (智慧科目建議)

---

## 4. 功能測試範圍

### 4.1 科目CRUD模組測試

#### 4.1.1 CategoryController.getCategories 測試重點
- **查詢參數驗證**: ledgerId、type、parentId、level篩選
- **樹狀結構**: 階層科目的完整樹狀回應
- **排序邏輯**: sortBy(name/type/usage/amount)正確性
- **四模式回應**: Expert完整統計、Guiding簡化顯示

#### 4.1.2 CategoryController.createCategory 測試重點  
- **輸入資料驗證**: name必填、type枚舉驗證、ledgerId存在性
- **階層設定處理**: parentId驗證、level自動計算、path生成
- **重複檢查**: 同階層內科目名稱唯一性
- **預設設定**: 不同模式的預設值應用

#### 4.1.3 CategoryController.updateCategory 測試重點
- **部分更新**: 支援選擇性欄位更新
- **階層調整**: 父科目變更、階層重新計算、path更新
- **名稱重複**: 更新後名稱不與同階層科目重複
- **子科目影響**: 父科目變更對子科目的級聯影響

#### 4.1.4 CategoryController.deleteCategory 測試重點
- **依賴檢查**: 檢查是否有子科目或交易記錄
- **級聯處理**: 子科目的處理策略(移動/刪除/孤立)
- **軟刪除**: 有交易記錄時軟刪除邏輯
- **統計更新**: 刪除後相關統計資料重新計算

### 4.2 階層管理模組測試

#### 4.2.1 CategoryService.buildCategoryTree 測試重點
- **樹狀建構**: 平面科目列表轉換為樹狀結構
- **階層正確性**: 父子關係、level層級、path路徑正確性
- **循環檢測**: 階層循環引用檢測與防護
- **效能最佳化**: 大量科目(2000+)樹狀建構效能

#### 4.2.2 CategoryService.validateHierarchy 測試重點
- **循環驗證**: 防止父子關係形成循環的演算法
- **深度限制**: 階層深度不超過5層的限制執行
- **完整性檢查**: 階層結構完整性驗證
- **修復機制**: 階層結構異常自動修復

#### 4.2.3 CategoryService.calculateCategoryPath 測試重點
- **路徑計算**: 科目完整路徑字串生成
- **路徑分隔符**: 標準化路徑分隔符處理
- **路徑更新**: 階層變更時路徑批次更新
- **路徑查詢**: 基於路徑的快速科目查詢

### 4.3 科目分類模組測試

#### 4.3.1 三種科目類型處理測試
- **收入科目**: income類型特定功能與業務邏輯
- **支出科目**: expense類型特定功能與業務邏輯  
- **轉帳科目**: transfer類型特定功能與限制
- **類型轉換**: 科目類型變更的限制與安全性

#### 4.3.2 科目類型驗證測試
- **類型一致性**: 父子科目類型必須一致的檢查
- **使用限制**: 不同類型科目的記帳使用限制
- **統計區分**: 按類型分別統計的準確性
- **預設科目**: 系統預設科目類型管理

### 4.4 使用統計模組測試

#### 4.4.1 StatisticsService.calculateUsageStatistics 測試重點
- **使用次數**: 科目使用次數統計絕對準確性
- **金額統計**: 總金額、平均金額、最大最小金額統計
- **時間區間**: 不同時間區間(日/週/月/年)統計正確性
- **即時更新**: 新交易發生時統計即時更新

#### 4.4.2 StatisticsService.generateUsageReport 測試重點
- **報告生成**: 多維度科目使用報告生成
- **排名計算**: 使用頻率、金額排名計算準確性
- **趨勢分析**: 科目使用趨勢變化分析
- **異常檢測**: 科目使用異常模式檢測

### 4.5 個人化設定模組測試

#### 4.5.1 快速存取功能測試
- **常用科目**: 常用科目列表自動維護與排序
- **最近使用**: 最近使用科目記錄即時更新
- **智慧建議**: 基於使用模式的科目智慧推薦
- **個人化排序**: 用戶自訂科目排序功能

#### 4.5.2 預設科目管理測試
- **預設設定**: 用戶預設科目設定與應用
- **快速選擇**: 記帳時預設科目快速填入
- **模式適應**: 不同用戶模式預設科目策略
- **同步機制**: 預設科目變更跨設備同步

---

## 5. 詳細測試案例

### 5.1 核心功能測試案例

#### TC-001: 科目列表查詢API樹狀結構測試
**測試函數表頭**:
```dart
/**
 * TC-001: 科目列表樹狀結構查詢測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化樹狀結構驗證邏輯
 */
Future<void> testGetCategoriesTreeStructure();
```
- **目的**: 驗證GET /categories端點樹狀結構回應完整性
- **前置條件**:
  - 測試帳本包含5層深度科目結構
  - JWT token有效且具備帳本存取權限
  - 四種用戶模式設定完成
- **測試步驟**:
  1. Expert模式查詢科目列表(includeTree=true)
  2. 驗證tree欄位包含完整5層樹狀結構
  3. 檢查每個節點的children陣列正確性
  4. 驗證level欄位遞增正確性
  5. Guiding模式查詢相同科目(簡化回應)
  6. 驗證四模式差異化回應邏輯
- **驗證點**:
  - HTTP狀態碼200
  - 樹狀結構層級完全正確
  - 父子關係完整無循環
  - path欄位路徑準確
  - 四模式回應差異符合規格

#### TC-002: 科目建立API階層處理測試
**測試函數表頭**:
```dart
/**
 * TC-002: 科目建立階層處理測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，新增路徑自動生成驗證
 */
Future<void> testCreateCategoryHierarchyHandling();
```
- **目的**: 驗證POST /categories端點階層處理邏輯
- **前置條件**:
  - 父科目已存在且未達深度限制
  - 階層空間足夠建立新科目
- **測試步驟**:
  1. 建立根層級科目(parentId=null)
  2. 建立第2層科目(指定有效parentId)
  3. 驗證level欄位自動計算為2
  4. 檢查path欄位自動生成路徑
  5. 建立第6層科目(測試深度限制)
  6. 驗證深度超限錯誤處理
  7. 測試父科目不存在情況
- **驗證點**:
  - 成功建立時HTTP狀態碼201
  - level欄位計算絕對正確
  - path欄位完整路徑格式正確
  - 深度限制HTTP狀態碼400
  - 錯誤訊息明確具體

#### TC-003: 科目更新API階層調整測試
**測試函數表頭**:
```dart
/**
 * TC-003: 科目更新階層調整測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完善級聯更新邏輯
 */
Future<void> testUpdateCategoryHierarchyAdjustment();
```
- **目的**: 驗證PUT /categories/{id}端點階層調整功能
- **前置條件**:
  - 科目存在且具更新權限
  - 目標階層位置有效
- **測試步驟**:
  1. 更新科目父節點(移動到不同分支)
  2. 驗證科目本身level重新計算
  3. 檢查所有子科目level級聯更新
  4. 驗證path欄位批次重新計算
  5. 測試移動造成循環情況
  6. 驗證循環檢測機制有效
  7. 測試移動至超深層級情況
- **驗證點**:
  - 成功移動HTTP狀態碼200
  - 本科目與子科目level全部正確
  - path欄位批次更新完整
  - 循環檢測HTTP狀態碼409
  - 深度超限HTTP狀態碼400

#### TC-004: 科目刪除API級聯處理測試
**測試函數表頭**:
```dart
/**
 * TC-004: 科目刪除級聯處理測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化級聯刪除邏輯
 */
Future<void> testDeleteCategoryCascadeHandling();
```
- **目的**: 驗證DELETE /categories/{id}端點級聯處理策略
- **前置條件**:
  - 科目存在且具刪除權限
  - 準備不同級聯情況測試資料
- **測試步驟**:
  1. 刪除葉節點科目(無子科目、無交易)
  2. 刪除有子科目無交易記錄科目
  3. 檢查子科目移動至父節點邏輯
  4. 刪除無子科目有交易記錄科目
  5. 驗證軟刪除邏輯執行
  6. 刪除有子科目有交易記錄科目
  7. 驗證複合級聯處理策略
- **驗證點**:
  - 葉節點刪除HTTP狀態碼200
  - 子科目移動邏輯正確
  - 軟刪除保留交易關聯
  - 複合情況處理策略合理
  - 級聯操作事務一致性

#### TC-005: 科目詳情查詢API完整信息測試
**測試函數表頭**:
```dart
/**
 * TC-005: 科目詳情完整信息查詢測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，新增統計資訊驗證
 */
Future<void> testGetCategoryDetailComprehensive();
```
- **目的**: 驗證GET /categories/{id}端點詳細資訊完整性
- **前置條件**:
  - 科目存在且有使用記錄
  - 科目有完整的統計資料
- **測試步驟**:
  1. 查詢科目詳細資訊(Expert模式)
  2. 驗證基本資訊欄位完整性
  3. 檢查statistics統計資料準確性
  4. 驗證path路徑資訊正確
  5. 檢查children子科目列表
  6. Guiding模式查詢相同科目
  7. 驗證簡化資訊回應差異
- **驗證點**:
  - 基本資訊欄位無缺漏
  - 統計資料計算準確
  - 路徑資訊格式正確
  - 子科目列表完整
  - 四模式差異化回應正確

### 5.2 階層結構測試案例

#### TC-006: 科目樹狀結構建構邏輯測試
**測試函數表頭**:
```dart
/**
 * TC-006: 科目樹狀結構建構邏輯測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，優化樹建構演算法
 */
Future<void> testCategoryTreeBuildingLogic();
```
- **目的**: 驗證科目樹狀結構建構演算法正確性
- **前置條件**:
  - 複雜階層科目資料完整
  - 包含多分支、多層級結構
- **測試步驟**:
  1. 建構包含100個科目的樹狀結構
  2. 驗證所有父子關係正確建立
  3. 檢查level層級遞增邏輯
  4. 驗證children陣列順序正確
  5. 測試樹狀結構遍歷完整性
  6. 檢查根節點識別正確性
  7. 驗證葉節點識別正確性
- **驗證點**:
  - 樹狀結構拓撲完全正確
  - 父子指標關係準確
  - 層級計算無錯誤
  - 遍歷覆蓋所有節點
  - 根與葉節點識別正確

#### TC-007: 階層循環檢測演算法測試
**測試函數表頭**:
```dart
/**
 * TC-007: 階層循環檢測演算法測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，提升檢測演算法效能
 */
Future<void> testHierarchyCycleDetectionAlgorithm();
```
- **目的**: 驗證階層循環檢測演算法有效性與效能
- **前置條件**:
  - 複雜階層結構測試環境
  - 循環檢測演算法配置
- **測試步驟**:
  1. 嘗試建立A→B→A的簡單循環
  2. 嘗試建立A→B→C→D→A的複雜循環
  3. 測試間接循環檢測(A→B→C→B)
  4. 驗證深層循環檢測效能
  5. 測試自循環檢測(A→A)
  6. 檢查檢測演算法時間複雜度
  7. 驗證誤檢率為0%
- **驗證點**:
  - 所有循環正確檢測並拒絕
  - 檢測時間複雜度O(n)
  - 無誤判正常階層為循環
  - 錯誤訊息明確指出循環路徑
  - 大型結構檢測效能可接受

#### TC-008: 階層深度限制驗證測試
**測試函數表頭**:
```dart
/**
 * TC-008: 階層深度限制驗證測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完善深度限制機制
 */
Future<void> testHierarchyDepthLimitValidation();
```
- **目的**: 驗證5層階層深度限制機制執行
- **前置條件**:
  - 深度限制設定為5層
  - 階層深度檢查機制啟用
- **測試步驟**:
  1. 建立5層深度科目結構(允許)
  2. 嘗試建立第6層科目(拒絕)
  3. 移動科目造成超深情況測試
  4. 驗證深度計算演算法正確性
  5. 測試邊界條件(恰好5層)
  6. 檢查深度限制動態調整
  7. 驗證限制錯誤訊息準確性
- **驗證點**:
  - 5層內建立成功
  - 超過5層建立失敗
  - 移動造成超深被拒絕
  - 深度計算絕對正確
  - 錯誤訊息包含當前深度資訊

#### TC-009: 大型樹狀結構效能測試
**測試函數表頭**:
```dart
/**
 * TC-009: 大型樹狀結構效能測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，提升大型結構處理效能
 */
Future<void> testLargeTreeStructurePerformance();
```
- **目的**: 驗證大量科目樹狀結構查詢與建構效能
- **前置條件**:
  - 準備2000個科目的測試資料
  - 效能監控工具配置
- **測試步驟**:
  1. 建構2000個科目的樹狀結構
  2. 監控樹建構處理時間
  3. 測試樹狀查詢回應時間
  4. 檢查記憶體使用量變化
  5. 測試部分樹查詢效能
  6. 驗證樹遍歷演算法效能
  7. 檢查併發樹查詢能力
- **驗證點**:
  - 樹建構時間 < 800ms
  - 查詢回應時間 < 500ms
  - 記憶體使用增長線性
  - 部分查詢效能良好
  - 併發查詢穩定性佳

#### TC-010: 併發階層修改一致性測試
**測試函數表頭**:
```dart
/**
 * TC-010: 併發階層修改一致性測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化併發控制機制
 */
Future<void> testConcurrentHierarchyModificationConsistency();
```
- **目的**: 驗證多用戶併發修改階層結構的一致性
- **前置條件**:
  - 併發測試環境配置
  - 資料庫事務隔離設定
- **測試步驟**:
  1. 模擬10個用戶同時修改不同科目
  2. 模擬2個用戶同時修改同一科目
  3. 測試併發移動造成循環情況
  4. 驗證資料庫鎖定機制有效性
  5. 檢查事務回滾正確性
  6. 測試最終一致性保證
  7. 驗證併發衝突錯誤處理
- **驗證點**:
  - 併發修改不造成資料損壞
  - 衝突時適當的錯誤回應
  - 事務隔離機制有效
  - 最終資料狀態一致
  - 效能在可接受範圍

### 5.3 四模式差異化測試案例

#### TC-011: Expert模式完整功能測試
**測試函數表頭**:
```dart
/**
 * TC-011: Expert模式科目管理完整功能測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，新增進階統計功能
 */
Future<void> testExpertModeCategoryManagementFeatures();
```
- **目的**: 驗證Expert模式科目管理完整功能存取
- **前置條件**:
  - 用戶設定為Expert模式
  - 科目包含豐富統計資料
- **測試步驟**:
  1. 查詢科目列表(Expert模式)
  2. 驗證完整樹狀結構顯示
  3. 檢查詳細統計資訊包含
  4. 測試進階篩選排序功能
  5. 驗證批次操作功能可用
  6. 檢查深度分析資料顯示
  7. 測試自訂科目屬性功能
- **驗證點**:
  - statistics包含usage、amount、frequency
  - tree結構完整顯示所有層級
  - advancedFilters功能完整可用
  - batchOperations支援多科目操作
  - customAttributes可自由設定
  - analyticsData包含趨勢分析

#### TC-012: Cultivation模式習慣分析測試
**測試函數表頭**:
```dart
/**
 * TC-012: Cultivation模式習慣分析測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化習慣分析演算法
 */
Future<void> testCultivationModeHabitsAnalysis();
```
- **目的**: 驗證Cultivation模式科目使用習慣分析功能
- **前置條件**:
  - 用戶設定為Cultivation模式
  - 有至少3個月使用歷史資料
- **測試步驟**:
  1. 查詢科目列表(Cultivation模式)
  2. 驗證habits欄位包含使用模式分析
  3. 檢查frequencyPattern週期性分析
  4. 測試preferredTimeSlots時間偏好
  5. 驗證spendingHabits支出習慣分析
  6. 檢查habitScore習慣評分
  7. 測試improvementSuggestions改善建議
- **驗證點**:
  - habits物件包含完整習慣分析
  - frequencyPattern準確識別週期
  - preferredTimeSlots反映真實偏好
  - spendingHabits提供洞察
  - habitScore評分合理
  - improvementSuggestions具教育意義

#### TC-013: Guiding模式簡化體驗測試
**測試函數表頭**:
```dart
/**
 * TC-013: Guiding模式簡化使用體驗測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，優化簡化邏輯
 */
Future<void> testGuidingModeSimplifiedExperience();
```
- **目的**: 驗證Guiding模式極簡化使用者體驗
- **前置條件**:
  - 用戶設定為Guiding模式
  - 預設科目配置完成
- **測試步驟**:
  1. 查詢科目列表(Guiding模式)
  2. 驗證回應不包含tree結構
  3. 檢查statistics統計簡化或隱藏
  4. 測試科目數量限制在必要範圍
  5. 驗證recommendedCategories推薦
  6. 檢查quickActions快速操作
  7. 測試simplifiedCreation簡化建立
- **驗證點**:
  - 不包含樹狀結構(tree)欄位
  - statistics隱藏或極度簡化
  - 科目數量控制在10-15個
  - recommendedCategories準確推薦
  - quickActions操作極度簡化
  - simplifiedCreation流程精簡

#### TC-014: Inertial模式標準功能測試
**測試函數表頭**:
```dart
/**
 * TC-014: Inertial模式標準功能測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完善標準功能集
 */
Future<void> testInertialModeStandardFeatures();
```
- **目的**: 驗證Inertial模式標準科目管理功能
- **前置條件**:
  - 用戶設定為Inertial模式
  - 標準科目模板可用
- **測試步驟**:
  1. 查詢科目列表(Inertial模式)
  2. 驗證基本樹狀結構顯示
  3. 檢查標準統計資訊顯示
  4. 測試標準篩選排序功能
  5. 驗證常用科目管理功能
  6. 檢查標準建立修改功能
  7. 測試標準分析報告功能
- **驗證點**:
  - tree結構包含基本層級
  - statistics包含基本使用統計
  - standardFilters提供常用篩選
  - favoriteCategories管理常用科目
  - standardOperations支援基本操作
  - basicAnalytics提供標準分析

### 5.4 API端點一致性測試案例

#### TC-015: 8106規格一致性驗證測試
**測試函數表頭**:
```dart
/**
 * TC-015: 8106 API規格一致性驗證測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完整覆蓋5個端點規格
 */
Future<void> testAPISpecificationConsistency();
```
- **目的**: 驗證實作與8106 API規格100%一致
- **前置條件**:
  - 8106 API規格文件可存取
  - 自動化規格比對工具配置
- **測試步驟**:
  1. 驗證5個端點路徑定義一致
  2. 檢查請求參數格式與enum值
  3. 驗證回應結構與schema完全吻合
  4. 測試所有定義的錯誤碼對應
  5. 檢查HTTP狀態碼使用標準
  6. 驗證API版本控制一致性
  7. 測試向後相容性保證
- **驗證點**:
  - 端點路徑與規格完全一致
  - 參數enum值100%符合規格
  - 回應結構符合定義schema
  - 錯誤碼對應關係正確
  - HTTP狀態碼符合RESTful標準

#### TC-016: 統一回應格式驗證測試
**測試函數表頭**:
```dart
/**
 * TC-016: 統一回應格式驗證測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化回應格式標準化
 */
Future<void> testUnifiedResponseFormat();
```
- **目的**: 驗證所有API端點遵循8088統一回應格式
- **前置條件**:
  - 8088回應格式規範文件
  - 格式驗證工具配置
- **測試步驟**:
  1. 測試成功回應格式(success=true)
  2. 測試各種錯誤回應格式(success=false)
  3. 驗證metadata結構完整性
  4. 檢查timestamp格式ISO 8601標準
  5. 確認requestId追蹤機制有效
  6. 驗證pagination分頁格式一致
  7. 測試error錯誤物件格式標準
- **驗證點**:
  - 所有回應包含success欄位
  - metadata結構標準統一
  - timestamp格式符合ISO 8601
  - requestId有效追蹤請求
  - pagination分頁資訊完整
  - error物件格式規範一致

### 5.5 異常處理測試案例

#### TC-017: 階層結構異常處理測試
**測試函數表頭**:
```dart
/**
 * TC-017: 階層結構異常處理測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完善異常處理機制
 */
Future<void> testHierarchyStructureExceptionHandling();
```
- **目的**: 驗證階層結構各種異常情況的處理能力
- **前置條件**:
  - 異常測試環境準備
  - 錯誤模擬工具配置
- **測試步驟**:
  1. 測試不存在父科目建立子科目
  2. 測試循環引用建立嘗試
  3. 測試超過深度限制建立
  4. 模擬資料庫連線中斷情況
  5. 測試併發修改衝突處理
  6. 模擬記憶體不足情況
  7. 驗證異常恢復機制
- **驗證點**:
  - 不存在父科目HTTP狀態碼404
  - 循環引用HTTP狀態碼409
  - 深度超限HTTP狀態碼400
  - 系統異常HTTP狀態碼500
  - 錯誤訊息明確具體
  - 系統狀態保持穩定

#### TC-018: 科目統計異常處理測試
**測試函數表頭**:
```dart
/**
 * TC-018: 科目統計異常處理測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化統計容錯機制
 */
Future<void> testCategoryStatisticsExceptionHandling();
```
- **目的**: 驗證科目統計計算的異常處理與容錯能力
- **前置條件**:
  - 統計資料完整性測試環境
  - 異常資料注入工具
- **測試步驟**:
  1. 測試統計資料缺失情況處理
  2. 模擬統計計算溢出情況
  3. 測試併發統計更新衝突
  4. 模擬歷史資料不完整情況
  5. 測試統計服務異常情況
  6. 驗證統計資料自動修復
  7. 檢查降級顯示機制
- **驗證點**:
  - 統計缺失時優雅降級顯示
  - 計算溢出時適當處理
  - 併發衝突正確解決
  - 不完整資料適當標示
  - 自動修復機制有效運作
  - 降級不影響核心功能

#### TC-019: 權限驗證異常處理測試
**測試函數表頭**:
```dart
/**
 * TC-019: 權限驗證異常處理測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，加強權限檢查機制
 */
Future<void> testPermissionValidationExceptionHandling();
```
- **目的**: 驗證權限驗證異常情況的處理機制
- **前置條件**:
  - 權限測試環境配置
  - 不同權限級別測試用戶
- **測試步驟**:
  1. 測試無效JWT Token存取
  2. 測試過期Token自動刷新
  3. 測試跨帳本權限檢查
  4. 模擬權限服務異常情況
  5. 測試權限升級驗證
  6. 驗證權限快取機制
  7. 檢查權限錯誤記錄
- **驗證點**:
  - 無效Token HTTP狀態碼401
  - 過期Token自動處理
  - 跨帳本存取HTTP狀態碼403
  - 權限服務異常優雅處理
  - 權限快取有效提升效能
  - 安全事件正確記錄

---

## 6. 效能與壓力測試

### 6.1 科目管理效能

#### 6.1.1 TC-020 科目操作效能基準測試
**測試函數表頭**:
```dart
/**
 * TC-020: 科目操作效能基準測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，提升效能基準要求
 */
Future<void> testCategoryOperationPerformanceBenchmark();
```
- **測試目標**: 單次科目操作回應時間 < 1 秒
- **測試方法**:
  - 執行1000次科目CRUD操作
  - 監控每次操作回應時間
  - 記錄系統資源使用情況
  - 分析操作效能瓶頸點
  - 測試不同資料量影響
- **監控指標**:
  - 平均回應時間 < 800ms
  - 95%百分位回應時間 < 1000ms
  - CPU使用率 < 70%
  - 記憶體使用量合理增長
  - 資料庫查詢次數最佳化

### 6.2 階層查詢能力

#### 6.2.1 TC-021 樹狀查詢併發能力測試
**測試函數表頭**:
```dart
/**
 * TC-021: 樹狀查詢併發能力測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，提升併發處理能力
 */
Future<void> testTreeQueryConcurrentCapability();
```
- **測試目標**: 支援100+併發樹狀查詢請求
- **測試方法**:
  - 模擬100個併發樹狀查詢請求
  - 測試不同樹大小併發查詢
  - 監控系統回應時間變化
  - 檢查併發查詢穩定性
  - 測試併發與序列查詢差異
- **驗收標準**:
  - 併發查詢成功率 > 98%
  - 平均回應時間增長 < 30%
  - 系統穩定性保持良好
  - 無併發死鎖情況
  - 記憶體使用控制在合理範圍

### 6.3 記憶體使用監控

#### 6.3.1 TC-022 記憶體使用監控測試
**測試函數表頭**:
```dart
/**
 * TC-022: 記憶體使用監控測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化記憶體監控
 */
Future<void> testMemoryUsageMonitoring();
```
- **測試目標**: 24小時運行記憶體使用穩定
- **測試方法**:
  - 啟動長時間科目操作測試
  - 每小時記錄記憶體使用量
  - 重點監控樹狀結構建構記憶體
  - 分析記憶體使用模式
  - 檢查記憶體洩漏情況
- **驗收標準**:
  - 記憶體使用增長 < 3%/24小時
  - 無明顯記憶體洩漏模式
  - 垃圾回收機制有效運作
  - 峰值記憶體使用可控

---

## 7. 安全性與權限測試

### 7.1 輸入驗證測試

#### 7.1.1 TC-023 惡意輸入防護測試
**測試函數表頭**:
```dart
/**
 * TC-023: 惡意輸入防護測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，加強安全檢查機制
 */
Future<void> testMaliciousInputProtection();
```
- **測試目標**: 完整防護各種惡意輸入攻擊
- **測試方法**:
  - SQL注入攻擊測試(科目名稱、描述)
  - NoSQL注入攻擊測試
  - XSS攻擊測試(科目屬性欄位)
  - 超長輸入處理測試
  - 特殊字元與控制字元測試
  - JSON注入攻擊測試
  - 路徑遍歷攻擊測試
- **安全要求**:
  - 所有惡意輸入被正確過濾
  - 輸入長度限制嚴格執行
  - 錯誤訊息不洩漏敏感資訊
  - 特殊字元適當編碼處理

### 7.2 階層安全測試

#### 7.2.1 TC-024 階層權限檢查測試
**測試函數表頭**:
```dart
/**
 * TC-024: 階層權限檢查測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，強化權限控制機制
 */
Future<void> testHierarchyPermissionControl();
```
- **測試目標**: 階層操作權限檢查100%正確
- **測試方法**:
  - 測試跨帳本階層操作阻擋
  - 驗證子科目權限繼承邏輯
  - 測試階層修改權限檢查
  - 檢查權限邊界清晰度
  - 測試權限升級機制
- **安全要求**:
  - 絕對無法操作他人帳本科目
  - 階層權限檢查嚴格無漏洞
  - 權限繼承邏輯完全正確
  - 權限邊界清楚明確

### 7.3 API安全性測試

#### 7.3.1 TC-025 跨帳本資料隔離測試
**測試函數表頭**:
```dart
/**
 * TC-025: 跨帳本資料隔離測試
 * @version 2.4.0
 * @date 2025-09-10
 * @update: 升版至2.4.0，完善資料隔離機制
 */
Future<void> testCrossLedgerDataIsolation();
```
- **測試目標**: 確保帳本間科目資料完全隔離
- **測試方法**:
  - 驗證科目查詢資料來源限制
  - 測試跨帳本科目存取防護
  - 檢查科目ID洩漏可能性
  - 測試統計資料跨帳本洩漏
  - 驗證權限邊界清楚
- **隔離要求**:
  - 帳本科目資料嚴格隔離
  - 無跨帳本資料污染或洩漏
  - 權限邊界清楚明確
  - 錯誤訊息不洩漏他人資訊

---

## 附錄

### A. Dart函數版次對照表

| 函數編號 | 函數名稱 | 版次 | 更新日期 | 更新說明 |
|---------|----------|------|----------|----------|
| 01 | getCategories | v2.4.0 | 2025-09-10 | 四模式差異化回應強化 |
| 02 | getCategoryDetail | v2.4.0 | 2025-09-10 | 詳細統計資訊完善 |
| 03 | createCategory | v2.4.0 | 2025-09-10 | 階層驗證演算法優化 |
| 04 | updateCategory | v2.4.0 | 2025-09-10 | 級聯更新邏輯強化 |
| 05 | deleteCategory | v2.4.0 | 2025-09-10 | 級聯刪除策略完善 |
| 06 | buildCategoryTree | v2.4.0 | 2025-09-10 | 樹建構演算法最佳化 |
| 07 | validateHierarchy | v2.4.0 | 2025-09-10 | 循環檢測效能提升 |
| 08 | calculateCategoryPath | v2.4.0 | 2025-09-10 | 路徑計算邏輯完善 |
| 09 | detectCycle | v2.4.0 | 2025-09-10 | 循環檢測演算法優化 |
| 10 | calculateUsageStatistics | v2.4.0 | 2025-09-10 | 統計計算準確性提升 |
| ... | ... | v2.4.0 | 2025-09-10 | 版次統一升級至2.4.0 |

### B. 科目類型與階層限制

| 科目類型 | 英文代碼 | 階層支援 | 最大深度 | 特殊限制 |
|----------|----------|----------|----------|----------|
| 收入 | income | 完整支援 | 5層 | 無 |
| 支出 | expense | 完整支援 | 5層 | 無 |
| 轉帳 | transfer | 有限支援 | 3層 | 不建議深層階層 |

### C. 四模式功能完整對照表

| 功能項目 | Expert | Inertial | Cultivation | Guiding |
|----------|--------|----------|-------------|---------|
| 樹狀結構 | 完整5層 | 基本3層 | 教育簡化 | 平面列表 |
| 統計資訊 | 全部統計 | 基本統計 | 習慣分析 | 隱藏統計 |
| 建立選項 | 全部選項 | 常用選項 | 引導選項 | 極簡選項 |
| 推薦功能 | 手動管理 | 智慧推薦 | 學習推薦 | 自動推薦 |
| 批次操作 | 完整支援 | 基本支援 | 有限支援 | 不支援 |
| 進階設定 | 完整控制 | 部分控制 | 引導設定 | 自動設定 |

### D. 效能基準要求

| 項目 | 基準要求 | 優化目標 | 監控指標 |
|------|----------|----------|----------|
| 單次操作 | < 1000ms | < 800ms | 平均回應時間 |
| 樹狀查詢 | < 800ms | < 500ms | 95%百分位時間 |
| 併發處理 | 100 requests | 200 requests | 併發成功率 |
| 記憶體使用 | < 100MB | < 80MB | 峰值記憶體 |
| 樹建構 | < 800ms | < 500ms | 2000科目處理時間 |

---

**文件版本記錄**:
- v2.4.0 (2025-09-10): 第一階段與第二階段升版完成，依照8408報表分析服務結構重整，新增測試案例索引表，強化階層結構循環檢測、大型樹查詢效能、四模式差異化推薦、併發修改一致性等關鍵測試，提升版本至v2.4.0，遵循8088 API設計規範統一回應格式，完善25個系統化測試案例覆蓋科目管理服務特殊需求
