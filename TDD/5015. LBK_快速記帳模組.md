
# 5015. TDD_LBK_快速記帳模組_v1.0

## 文件資訊
- **文件標題**: LBK 快速記帳模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-07-15 09:30:00 +08:00 (台灣時間)
- **創建者**: LCAS SA Team
- **對應需求文件**: 1015. LBK_快速記帳模組.md
- **模組代碼**: LBK (LINE Bookkeeping)
- **參考現有模組**: 2001. BK.js

---

## 1.0 技術架構概述

### 1.1 模組定位
LBK 快速記帳模組是從 BK 模組中分離出來的專用模組，專門處理 LINE OA 的快速記帳需求。該模組實現了從原有的 `WH → DD → BK` 三層架構簡化為 `WH → LBK` 的兩層架構，大幅減少處理時間並降低 Reply Token 60秒限制風險。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **資料庫**: Firestore
- **日誌系統**: DL 模組
- **文字解析**: 自然語言處理
- **時區處理**: moment-timezone (Asia/Taipei)
- **唯一ID生成**: crypto.randomUUID()

### 1.3 模組架構
```javascript
/**
 * LBK_快速記帳模組_1.0.0
 * @module LBK模組
 * @description LINE OA 專用快速記帳處理模組 - 簡化記帳流程，實現極速處理
 * @update 2025-07-15: 初版建立，從BK模組分離核心功能，專門處理LINE OA快速記帳
 */
```

### 1.4 架構比較

#### 原有架構 (WH → DD → BK)
```
LINE OA 文字輸入 → WH 模組 → DD 模組 → BK 模組 → Firestore
處理時間: ~5-8秒 | 經過模組數: 4個 | 函數調用: ~26個
```

#### 新架構 (WH → LBK)
```
LINE OA 文字輸入 → WH 模組 → LBK 模組 → Firestore
處理時間: <2秒 | 經過模組數: 3個 | 函數調用: ~8個
```

---

## 2.0 核心函數設計

### 2.1 主要處理函數

```javascript
/**
 * 01. 處理快速記帳的主函數
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 接收WH模組的記帳請求，執行完整的記帳處理流程
 */
function LBK_processQuickBookkeeping(inputData)
```
- **功能**: 處理LINE OA快速記帳的核心函數
- **輸入參數**: 
  ```javascript
  {
    userId: "LINE_UID",
    messageText: "午餐-100",
    replyToken: "REPLY_TOKEN", 
    timestamp: "2025-07-15T09:00:00Z"
  }
  ```
- **與其他模組互動**:
  - `LBK_parseUserMessage()` - 解析用戶訊息
  - `LBK_executeBookkeeping()` - 執行記帳
  - `LBK_formatReplyMessage()` - 格式化回覆
  - `DL_log()` - 記錄處理日誌
- **回傳值**: 
  ```javascript
  {
    success: true/false,
    message: "記帳成功/錯誤訊息",
    data: {
      amount: 100,
      type: "expense", 
      subject: "餐飲",
      recordId: "RECORD_ID"
    },
    processingTime: 1.2,
    moduleVersion: "1.0.0"
  }
  ```

### 2.2 文字解析函數

```javascript
/**
 * 02. 解析用戶訊息
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 解析LINE OA用戶的文字訊息，提取記帳資訊
 */
function LBK_parseUserMessage(messageText, userId, processId)
```
- **功能**: 從BK模組繼承的文字解析邏輯，支援「午餐-100」、「薪水+50000」等格式
- **與其他模組互動**:
  - `LBK_parseInputFormat()` - 解析輸入格式
  - `LBK_extractAmount()` - 提取金額
  - `LBK_identifySubject()` - 識別科目
- **回傳值**: 解析後的結構化資料

```javascript
/**
 * 03. 解析輸入格式
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 解析各種輸入格式，支援正負號、金額、科目識別
 */
function LBK_parseInputFormat(message, processId)
```
- **功能**: 繼承自BK_parseInputFormat，支援多種記帳格式
- **格式支援**:
  - 負數格式: `午餐-100`
  - 標準格式: `薪水50000`
  - 含支付方式: `午餐100現金`
- **與其他模組互動**:
  - `LBK_validateAmount()` - 驗證金額格式
  - `LBK_extractPaymentMethod()` - 提取支付方式

```javascript
/**
 * 04. 從文字中提取金額
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 從用戶輸入中提取並驗證金額
 */
function LBK_extractAmount(text, processId)
```
- **功能**: 繼承自BK_extractAmountFromText，增強金額驗證
- **驗證規則**:
  - 拒絕前導零
  - 金額必須大於0
  - 支援的幣別單位: 元、塊、圓
  - 拒絕不支援的幣別: NT、USD、$

### 2.3 科目處理函數

```javascript
/**
 * 05. 獲取科目代碼
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 根據科目名稱查詢對應的科目代碼
 */
function LBK_getSubjectCode(subjectName, userId, processId)
```
- **功能**: 繼承自BK_getSubjectCode，優化查詢效能
- **查詢策略**:
  1. 精確匹配
  2. 同義詞匹配
  3. 複合詞匹配
- **與其他模組互動**:
  - Firestore - 查詢用戶科目表
  - `LBK_fuzzyMatch()` - 模糊匹配
  - `DL_log()` - 記錄查詢過程

```javascript
/**
 * 06. 模糊匹配科目
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 當精確匹配失敗時，使用模糊匹配尋找最相似的科目
 */
function LBK_fuzzyMatch(input, threshold, userId, processId)
```
- **功能**: 繼承自BK_fuzzyMatch，提供智慧科目匹配
- **匹配算法**:
  - 包含匹配 (input contains subject)
  - 同義詞包含匹配
  - 字串相似度計算

```javascript
/**
 * 07. 獲取所有科目資料
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 從Firestore獲取用戶的完整科目清單
 */
function LBK_getAllSubjects(userId, processId)
```
- **功能**: 繼承自BK_getAllSubjects，優化資料讀取
- **快取策略**: 實作科目資料快取，減少Firestore查詢次數

### 2.4 記帳執行函數

```javascript
/**
 * 08. 執行記帳操作
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 執行實際的記帳操作，包含資料驗證和儲存
 */
function LBK_executeBookkeeping(bookkeepingData, processId)
```
- **功能**: 簡化版的記帳執行邏輯，專注於速度和準確性
- **處理流程**:
  1. 資料驗證
  2. 生成唯一記帳ID
  3. 格式化記帳資料
  4. 儲存至Firestore
- **與其他模組互動**:
  - `LBK_generateBookkeepingId()` - 生成記帳ID
  - `LBK_validateBookkeepingData()` - 驗證資料
  - `LBK_saveToFirestore()` - 儲存資料

```javascript
/**
 * 09. 生成唯一記帳ID
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 生成格式為YYYYMMDD-NNNNN的唯一記帳ID
 */
function LBK_generateBookkeepingId(processId)
```
- **功能**: 繼承自BK_generateBookkeepingId，確保ID唯一性
- **ID格式**: `20250715-00001`
- **生成邏輯**: 查詢當日最大序號，自動遞增

```javascript
/**
 * 10. 驗證記帳資料
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 驗證記帳資料的完整性和正確性
 */
function LBK_validateBookkeepingData(data, processId)
```
- **功能**: 快速資料驗證，確保必要欄位完整
- **驗證項目**:
  - 必要欄位檢查
  - 金額格式驗證
  - 科目代碼驗證
  - 支付方式驗證

### 2.5 資料儲存函數

```javascript
/**
 * 11. 儲存記帳資料至Firestore
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 將記帳資料儲存至Firestore，確保資料一致性
 */
function LBK_saveToFirestore(bookkeepingData, userId, processId)
```
- **功能**: 繼承自BK_saveToFirestore，優化寫入效能
- **資料結構**: 與BK模組保持一致的Firestore文檔格式
- **錯誤處理**: 完整的連線檢查和重試機制

```javascript
/**
 * 12. 準備記帳資料
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 將解析後的資料轉換為Firestore格式
 */
function LBK_prepareBookkeepingData(bookkeepingId, parsedData, processId)
```
- **功能**: 繼承自BK_prepareBookkeepingData，資料格式轉換
- **輸出格式**: Firestore文檔結構，包含所有必要欄位

### 2.6 回覆處理函數

```javascript
/**
 * 13. 格式化回覆訊息
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 格式化成功或失敗的回覆訊息
 */
function LBK_formatReplyMessage(resultData, moduleCode, options)
```
- **功能**: 繼承自BK_formatSystemReplyMessage，簡化回覆邏輯
- **訊息格式**:
  - 成功訊息: 包含記帳詳情
  - 失敗訊息: 統一錯誤格式
- **與其他模組互動**:
  - 回傳給WH模組進行LINE回覆

### 2.7 工具函數

```javascript
/**
 * 14. 移除文字中的金額和支付方式
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 從文字中移除金額和支付方式，保留備註內容
 */
function LBK_removeAmountFromText(text, amount, paymentMethod, processId)
```
- **功能**: 繼承自BK_removeAmountFromText，支援幣別單位限制

```javascript
/**
 * 15. 驗證支付方式
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 驗證並標準化支付方式
 */
function LBK_validatePaymentMethod(method, majorCode, processId)
```
- **功能**: 繼承自BK_validatePaymentMethod，支援四種標準支付方式
- **支援方式**: 現金、刷卡、轉帳、行動支付

```javascript
/**
 * 16. 時間格式化
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 格式化時間為台灣時區
 */
function LBK_formatDateTime(date, processId)
```
- **功能**: 繼承自BK_formatDateTime，使用台灣時區

### 2.8 初始化和配置函數

```javascript
/**
 * 17. LBK模組初始化
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 初始化LBK模組，建立必要的連線和配置
 */
function LBK_initialize()
```
- **功能**: 模組初始化，確保Firestore連線
- **初始化項目**:
  - Firestore連線初始化
  - DL日誌系統初始化
  - 配置參數載入

```javascript
/**
 * 18. 錯誤處理
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 統一的錯誤處理機制
 */
function LBK_handleError(error, context, userId, processId)
```
- **功能**: 標準化錯誤處理和日誌記錄
- **與其他模組互動**:
  - `DL_error()` - 錯誤日誌記錄
  - 回傳標準化錯誤格式

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
LBK 快速記帳模組
├── WH模組 (Webhook)
│   ├── 接收LINE OA事件
│   ├── 調用LBK_processQuickBookkeeping()
│   └── 處理回覆訊息
├── DL模組 (Data Logging)
│   ├── LBK_log() - 一般操作日誌
│   ├── LBK_error() - 錯誤日誌
│   ├── LBK_warning() - 警告日誌
│   └── LBK_info() - 資訊日誌
├── Firestore Database
│   ├── users Collection - 用戶資料
│   ├── ledgers/{user_id}/subjects - 用戶科目表
│   ├── ledgers/{user_id}/entries - 記帳記錄
│   └── ledgers/{user_id}/log - 操作日誌
└── 時間處理
    ├── moment-timezone - 時區處理
    └── crypto.randomUUID - 唯一ID生成
```

### 3.2 資料流向設計
```
LINE OA訊息 → WH模組接收 → LBK_processQuickBookkeeping() → 
文字解析 → 科目匹配 → 記帳執行 → Firestore儲存 → 
格式化回覆 → WH回覆LINE
```

### 3.3 與原有BK模組的關係
- **功能繼承**: LBK繼承BK模組的核心記帳邏輯
- **資料格式相容**: 確保Firestore資料格式完全一致
- **共存設計**: LBK專門處理LINE OA，BK繼續處理Rich Menu和APP

---


```javascript
/**
 * 19. 統一金額處理核心函數 (內部使用)
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 統一的金額處理邏輯，被其他金額相關函數調用
 */
function LBK_processAmountInternal(text, processId)
```
- **功能**: 統一的金額正則表達式邏輯和處理核心
- **回傳值**: 
  ```javascript
  {
    amount: 100,
    amountMatch: "100",
    cleanText: "午餐",
    currency: "NTD",
    hasAmount: true
  }
  ```

**優化後的函數設計：**

```javascript
/**
 * 04. 從文字中提取金額 (重構版)
 * @version 2025-07-15-V1.1.0
 * @description 調用統一核心邏輯提取金額
 */
function LBK_extractAmount(text, processId) {
  const result = LBK_processAmountInternal(text, processId);
  return {
    amount: result.amount,
    currency: result.currency,
    success: result.hasAmount
  };
}

/**
 * 14. 移除文字中的金額 (重構版)
 * @version 2025-07-15-V1.1.0
 * @description 調用統一核心邏輯移除金額
 */
function LBK_removeAmountFromText(text, amount, paymentMethod, processId) {
  const result = LBK_processAmountInternal(text, processId);
  return result.cleanText;
}
```


```javascript
/**
 * 20. 統一驗證框架 (內部使用)
 * @version 2025-07-15-V1.0.0
 * @date 2025-07-15 09:30:00
 * @description 統一的資料驗證邏輯框架
 */
function LBK_validateDataInternal(data, validationType, rules, processId)
```
- **功能**: 通用的驗證邏輯框架
- **支援驗證類型**: 
  - `AMOUNT`: 金額驗證
  - `PAYMENT_METHOD`: 支付方式驗證
  - `BOOKKEEPING_DATA`: 完整記帳資料驗證
- **驗證規則**: 可配置的驗證規則集

**優化後的驗證函數：**

```javascript
/**
 * 10. 驗證記帳資料 (重構版)
 * @description 使用統一驗證框架驗證完整記帳資料
 */
function LBK_validateBookkeepingData(data, processId) {
  return LBK_validateDataInternal(data, 'BOOKKEEPING_DATA', {
    required: ['amount', 'subject', 'userId'],
    amountRules: { min: 0, max: 999999999 },
    subjectRules: { notEmpty: true },
    paymentMethodRules: { allowedMethods: ['現金', '刷卡', '轉帳', '行動支付'] }
  }, processId);
}

/**
 * 15. 驗證支付方式 (重構版)
 * @description 使用統一驗證框架驗證支付方式
 */
function LBK_validatePaymentMethod(method, majorCode, processId) {
  return LBK_validateDataInternal(
    { method, majorCode }, 
    'PAYMENT_METHOD', 
    { allowedMethods: ['現金', '刷卡', '轉帳', '行動支付'] },
    processId
  );
}
```





## 4.0 資料庫架構設計

### 4.1 Firestore 集合結構
```
ledgers/
├── user_{LINE_UID}/
│   ├── entries/
│   │   └── {auto_generated_id}/
│   │       ├── 收支ID: "20250715-00001"
│   │       ├── 使用者類型: "J"
│   │       ├── 日期: "2025/07/15"
│   │       ├── 時間: "09:00"
│   │       ├── 大項代碼: "4001"
│   │       ├── 子項代碼: "4001001"
│   │       ├── 支付方式: "現金"
│   │       ├── 子項名稱: "餐飲"
│   │       ├── UID: "LINE_UID"
│   │       ├── 備註: "午餐"
│   │       ├── 收入: null
│   │       ├── 支出: 100
│   │       ├── 同義詞: ""
│   │       ├── currency: "NTD"
│   │       └── timestamp: Firestore.Timestamp
│   ├── subjects/
│   │   └── {subject_id}/
│   │       ├── 大項代碼: "4001"
│   │       ├── 大項名稱: "支出"
│   │       ├── 子項代碼: "4001001"
│   │       ├── 子項名稱: "餐飲"
│   │       ├── 同義詞: "吃飯,用餐"
│   │       └── isActive: true
│   └── log/
│       └── {auto_generated_id}/
│           ├── 時間: Firestore.Timestamp
│           ├── 訊息: "LBK記帳成功"
│           ├── 操作類型: "快速記帳"
│           ├── UID: "LINE_UID"
│           ├── 錯誤代碼: null
│           ├── 來源: "LBK"
│           └── 嚴重等級: "INFO"
```

### 4.2 資料一致性保證
- **格式相容**: 與BK模組的Firestore格式完全一致
- **欄位標準**: 所有欄位名稱和資料型別保持統一
- **時區處理**: 統一使用台灣時區 (Asia/Taipei)

---

## 5.0 API 介面規格

### 5.1 主要介面

#### 5.1.1 LBK_processQuickBookkeeping
```javascript
// 輸入
{
  userId: "LINE_UID",
  messageText: "午餐-100",
  replyToken: "REPLY_TOKEN",
  timestamp: "2025-07-15T09:00:00Z"
}

// 輸出
{
  success: true,
  message: "記帳成功！",
  data: {
    id: "20250715-00001",
    date: "2025/07/15 09:00",
    subjectName: "餐飲",
    amount: 100,
    rawAmount: "100",
    action: "支出",
    paymentMethod: "現金",
    remark: "午餐",
    userId: "LINE_UID",
    userType: "J"
  },
  processingTime: 1.2,
  moduleVersion: "1.0.0"
}
```

### 5.2 與WH模組的介面
```javascript
// WH呼叫LBK
const result = await LBK_processQuickBookkeeping({
  userId: event.source.userId,
  messageText: event.message.text,
  replyToken: event.replyToken,
  timestamp: event.timestamp
});

// LBK回傳給WH
return {
  success: result.success,
  responseMessage: result.message,
  moduleCode: "LBK",
  processingTime: result.processingTime
};
```

---

## 6.0 效能優化設計

### 6.1 處理速度優化
- **函數減少**: 從26個函數減少到8個核心函數
- **直連路徑**: 跳過DD模組的中間處理層
- **快取機制**: 科目資料快取，減少Firestore查詢

### 6.2 記憶體優化
- **物件重用**: 避免不必要的物件創建
- **垃圾回收**: 及時釋放大型物件
- **連線池**: Firestore連線重用

### 6.3 Firestore優化
- **批次操作**: 單次寫入，減少網路延遲
- **索引優化**: 針對查詢模式建立適當索引
- **連線管理**: 確保連線穩定性

---

## 7.0 錯誤處理和監控

### 7.1 錯誤分類
```javascript
const LBK_ERROR_TYPES = {
  PARSE_ERROR: "文字解析錯誤",
  SUBJECT_NOT_FOUND: "科目不存在",
  AMOUNT_INVALID: "金額格式錯誤", 
  FIRESTORE_ERROR: "資料庫錯誤",
  VALIDATION_ERROR: "資料驗證錯誤"
};
```

### 7.2 監控指標
- **處理時間**: 目標 < 2秒
- **成功率**: 目標 > 95%
- **錯誤率**: 目標 < 5%
- **Firestore連線**: 監控連線狀態

### 7.3 日誌策略
- **DEBUG**: 詳細處理步驟
- **INFO**: 重要操作記錄
- **WARNING**: 非致命錯誤
- **ERROR**: 系統錯誤和例外

---

## 8.0 測試設計

### 8.1 單元測試
- **文字解析測試**: 各種輸入格式的解析準確性
- **科目匹配測試**: 精確匹配和模糊匹配功能
- **金額驗證測試**: 各種金額格式的驗證
- **資料儲存測試**: Firestore寫入和讀取

### 8.2 整合測試
- **WH → LBK 流程測試**: 端到端記帳流程
- **錯誤處理測試**: 各種錯誤情況的處理
- **效能測試**: 處理時間和併發能力

### 8.3 測試數據
```javascript
const TEST_CASES = [
  {input: "午餐-100", expected: {subject: "午餐", amount: 100, action: "支出"}},
  {input: "薪水50000", expected: {subject: "薪水", amount: 50000, action: "收入"}},
  {input: "咖啡80現金", expected: {subject: "咖啡", amount: 80, paymentMethod: "現金"}}
];
```

---

## 9.0 部署和維護

### 9.1 部署策略
- **階段性部署**: 先小流量測試，再全面上線
- **A/B測試**: 與原有路徑並行運行
- **回滾機制**: 可快速切回原有 WH → DD → BK 路徑

### 9.2 監控和告警
- **即時監控**: 處理時間、成功率、錯誤率
- **告警機制**: 異常情況自動通知
- **健康檢查**: 定期檢查模組狀態

### 9.3 維護計畫
- **定期檢查**: 每週檢查效能指標
- **更新計畫**: 根據使用者回饋持續優化
- **文件維護**: 保持技術文件的即時性

---

## 10.0 風險評估

### 10.1 技術風險
- **Firestore連線風險**: 實作連線重試機制
- **效能風險**: 持續監控處理時間
- **相容性風險**: 確保與現有系統的資料格式相容

### 10.2 緩解措施
- **備援機制**: 保留原有 DD → BK 路徑作為備援
- **監控告警**: 即時監控系統狀態
- **快速回滾**: 可在5分鐘內回滾到原有架構

---

## 11.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-07-15 09:30:00 +08:00 | LCAS SA Team | 初版建立，完整技術設計，基於BK模組分離架構 |

---

**文件結束**

*此文件為 LCAS 2.0 LBK 快速記帳模組的完整技術設計規格，所有函數設計均基於現有BK模組的成功實作，並針對LINE OA快速記帳場景進行優化。*
