
# 5005. TDD_SR_æ’ç¨‹æé†’æ¨¡çµ„_v1.1

## æ–‡ä»¶è³‡è¨Š
- **æ–‡ä»¶æ¨™é¡Œ**: SR æ’ç¨‹æé†’æ¨¡çµ„æŠ€è¡“è¨­è¨ˆæ–‡ä»¶
- **æ–‡ä»¶ç‰ˆæœ¬**: v1.1
- **å‰µå»ºæ—¥æœŸ**: 2025-01-09 15:30:00 +08:00 (å°ç£æ™‚é–“)
- **å‰µå»ºè€…**: LCAS SA Team
- **æœ€å¾Œæ›´æ–°**: 2025-01-09 16:00:00 +08:00 (å°ç£æ™‚é–“)
- **å°æ‡‰éœ€æ±‚æ–‡ä»¶**: 1005. SR_æ’ç¨‹æé†’æ¨¡çµ„.md
- **æ¨¡çµ„ä»£ç¢¼**: SR (Scheduled Reminder)

---

## ğŸ“‘ ç›®æ¬¡ (Table of Contents)

1. [æŠ€è¡“æ¶æ§‹æ¦‚è¿°](#10-æŠ€è¡“æ¶æ§‹æ¦‚è¿°)
   - 1.1 [æ¨¡çµ„å®šä½](#11-æ¨¡çµ„å®šä½)
   - 1.2 [æŠ€è¡“å †ç–Š](#12-æŠ€è¡“å †ç–Š)
   - 1.3 [æ¨¡çµ„æ¶æ§‹](#13-æ¨¡çµ„æ¶æ§‹)

2. [å‡½æ•¸æ¸…å–®](#20-å‡½æ•¸æ¸…å–®)
   - 2.1 [å®Œæ•´å‡½æ•¸ç´¢å¼•è¡¨](#21-å®Œæ•´å‡½æ•¸ç´¢å¼•è¡¨)
   - 2.2 [å‡½æ•¸åˆ†å±¤æ¶æ§‹](#22-å‡½æ•¸åˆ†å±¤æ¶æ§‹)

3. [æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ](#30-æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ)
   - 3.1 [æ’ç¨‹ç®¡ç†å±¤å‡½æ•¸](#31-æ’ç¨‹ç®¡ç†å±¤å‡½æ•¸)
   - 3.2 [ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤å‡½æ•¸](#32-ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤å‡½æ•¸)
   - 3.3 [æ¨æ’­æœå‹™å±¤å‡½æ•¸](#33-æ¨æ’­æœå‹™å±¤å‡½æ•¸)
   - 3.4 [æ•¸æ“šæ•´åˆå±¤å‡½æ•¸](#34-æ•¸æ“šæ•´åˆå±¤å‡½æ•¸)

4. [æ¨¡çµ„é–“äº’å‹•æ¶æ§‹](#40-æ¨¡çµ„é–“äº’å‹•æ¶æ§‹)
   - 4.1 [æ ¸å¿ƒä¾è³´é—œä¿‚](#41-æ ¸å¿ƒä¾è³´é—œä¿‚)
   - 4.2 [è³‡æ–™æµå‘è¨­è¨ˆ](#42-è³‡æ–™æµå‘è¨­è¨ˆ)

5. [è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ](#50-è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ)
   - 5.1 [FSæ¨¡çµ„é›†åˆçµæ§‹éœ€æ±‚](#51-fsæ¨¡çµ„é›†åˆçµæ§‹éœ€æ±‚)
   - 5.2 [ä»˜è²»åŠŸèƒ½æ¬Šé™è¨­è¨ˆ](#52-ä»˜è²»åŠŸèƒ½æ¬Šé™è¨­è¨ˆ)

6. [API ä»‹é¢è¦æ ¼](#60-api-ä»‹é¢è¦æ ¼)
   - 6.1 [REST API ç«¯é»](#61-rest-api-ç«¯é»)
   - 6.2 [Cron è¡¨é”å¼è¨­è¨ˆ](#62-cron-è¡¨é”å¼è¨­è¨ˆ)

7. [æ’ç¨‹å¼•æ“è¨­è¨ˆ](#70-æ’ç¨‹å¼•æ“è¨­è¨ˆ)
   - 7.1 [æ’ç¨‹ä»»å‹™ç®¡ç†](#71-æ’ç¨‹ä»»å‹™ç®¡ç†)
   - 7.2 [æ™‚å€å’Œå‡æ—¥è™•ç†](#72-æ™‚å€å’Œå‡æ—¥è™•ç†)

8. [ä»˜è²»åŠŸèƒ½æ§åˆ¶æ©Ÿåˆ¶](#80-ä»˜è²»åŠŸèƒ½æ§åˆ¶æ©Ÿåˆ¶)
   - 8.1 [åŠŸèƒ½æ¬Šé™é©—è­‰æµç¨‹](#81-åŠŸèƒ½æ¬Šé™é©—è­‰æµç¨‹)
   - 8.2 [åŠŸèƒ½é™ç´šè™•ç†](#82-åŠŸèƒ½é™ç´šè™•ç†)

9. [éŒ¯èª¤è™•ç†èˆ‡ç›£æ§](#90-éŒ¯èª¤è™•ç†èˆ‡ç›£æ§)
   - 9.1 [éŒ¯èª¤é¡å‹å®šç¾©](#91-éŒ¯èª¤é¡å‹å®šç¾©)
   - 9.2 [é‡è©¦æ©Ÿåˆ¶è¨­è¨ˆ](#92-é‡è©¦æ©Ÿåˆ¶è¨­è¨ˆ)
   - 9.3 [å¥åº·ç›£æ§æ©Ÿåˆ¶](#93-å¥åº·ç›£æ§æ©Ÿåˆ¶)

10. [æ•ˆèƒ½æœ€ä½³åŒ–](#100-æ•ˆèƒ½æœ€ä½³åŒ–)
    - 10.1 [å¿«å–ç­–ç•¥](#101-å¿«å–ç­–ç•¥)
    - 10.2 [æ‰¹æ¬¡è™•ç†å„ªåŒ–](#102-æ‰¹æ¬¡è™•ç†å„ªåŒ–)

11. [æ¸¬è©¦ç­–ç•¥](#110-æ¸¬è©¦ç­–ç•¥)
    - 11.1 [å–®å…ƒæ¸¬è©¦è¦†è“‹](#111-å–®å…ƒæ¸¬è©¦è¦†è“‹)
    - 11.2 [æ•´åˆæ¸¬è©¦å ´æ™¯](#112-æ•´åˆæ¸¬è©¦å ´æ™¯)
    - 11.3 [æ•ˆèƒ½æ¸¬è©¦æŒ‡æ¨™](#113-æ•ˆèƒ½æ¸¬è©¦æŒ‡æ¨™)

12. [æ–‡ä»¶ç¶­è­·è¨˜éŒ„](#120-æ–‡ä»¶ç¶­è­·è¨˜éŒ„)

---

## 1.0 æŠ€è¡“æ¶æ§‹æ¦‚è¿°

### 1.1 æ¨¡çµ„å®šä½
SR æ’ç¨‹æé†’æ¨¡çµ„ä½œç‚º LCAS 2.0 çš„æ™ºæ…§è¨˜å¸³è‡ªå‹•åŒ–æ ¸å¿ƒï¼Œè² è²¬è™•ç†å®šæœŸè¨˜å¸³æé†’ã€è‡ªå‹•è¨˜å¸³åŸ·è¡Œã€è²¡å‹™çµ±è¨ˆæ¨æ’­ç­‰åŠŸèƒ½ã€‚æœ¬æ¨¡çµ„å°ˆæ³¨æ–¼æ’ç¨‹é‚è¼¯å’Œæ¥­å‹™è¦å‰‡ï¼Œé€éå…¶ä»–æ¨¡çµ„æä¾›çš„æ¨™æº–åŒ–ä»‹é¢é€²è¡Œè³‡æ–™åº«æ“ä½œå’Œå¤–éƒ¨æœå‹™æ•´åˆã€‚

### 1.2 æŠ€è¡“å †ç–Š
- **å¾Œç«¯æ¡†æ¶**: Node.js/Express
- **æ’ç¨‹å¼•æ“**: Node-cron
- **è³‡æ–™åº«**: Firestore (é€éFSæ¨¡çµ„)
- **æ¨æ’­æœå‹™**: LINE Push API (é€éWHæ¨¡çµ„)
- **æ™‚å€è™•ç†**: moment-timezone
- **æ—¥èªŒç³»çµ±**: DL æ¨¡çµ„
- **è³‡æ–™åˆ†ç™¼**: DD æ¨¡çµ„

### 1.3 æ¨¡çµ„æ¶æ§‹
```javascript
/**
 * SR_æ’ç¨‹æé†’æ¨¡çµ„_1.1.0
 * @module SRæ¨¡çµ„
 * @description æ™ºæ…§è¨˜å¸³è‡ªå‹•åŒ–æ ¸å¿ƒ - æ’ç¨‹æé†’ã€è‡ªå‹•è¨˜å¸³ã€è²¡å‹™çµ±è¨ˆæ¨æ’­
 * @update 2025-01-09: å‡ç´šè‡³v1.1ç‰ˆæœ¬ï¼Œæ–°å¢ç›®æ¬¡å’Œå‡½æ•¸æ¸…å–®ï¼Œå®Œå–„æ–‡ä»¶çµæ§‹
 */
```

---

## 2.0 å‡½æ•¸æ¸…å–®

### 2.1 å®Œæ•´å‡½æ•¸ç´¢å¼•è¡¨

| # | å‡½æ•¸åç¨± | ç‰ˆæœ¬ | æ‰€å±¬å±¤ç´š | åŠŸèƒ½æè¿° | ç›¸ä¾æ¨¡çµ„ |
|---|----------|------|----------|----------|----------|
| 01 | SR_createScheduledReminder | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | å»ºç«‹æ–°çš„æ’ç¨‹æé†’è¨­å®š | AMã€FSã€DL |
| 02 | SR_updateScheduledReminder | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | ä¿®æ”¹ç¾æœ‰æ’ç¨‹æé†’è¨­å®š | FSã€SRã€DL |
| 03 | SR_deleteScheduledReminder | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | å®‰å…¨åˆªé™¤æ’ç¨‹æé†’ | FSã€SRã€DL |
| 04 | SR_executeScheduledTask | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | åŸ·è¡Œåˆ°æœŸçš„æ’ç¨‹ä»»å‹™ | FSã€WHã€BKã€DL |
| 05 | SR_processHolidayLogic | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯ | FSã€SRã€DL |
| 06 | SR_optimizeReminderTime | V1.1.0 | æ’ç¨‹ç®¡ç†å±¤ | æ™ºæ…§æ™‚é–“æœ€ä½³åŒ– | AMã€MRAã€FSã€DL |
| 07 | SR_validatePremiumFeature | V1.1.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™ | AMã€DL |
| 08 | SR_checkSubscriptionStatus | V1.1.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | æª¢æŸ¥è¨‚é–±ç‹€æ…‹ | FSã€AMã€DL |
| 09 | SR_enforceFreeUserLimits | V1.1.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶ | FSã€WHã€DL |
| 10 | SR_upgradeFeatureAccess | V1.1.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™ | FSã€AMã€DDã€DL |
| 11 | SR_sendDailyFinancialSummary | V1.1.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦ | SRã€MRAã€WHã€DL |
| 12 | SR_sendBudgetWarning | V1.1.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€é ç®—è­¦å‘Š | BMã€SRã€WHã€DL |
| 13 | SR_sendMonthlyReport | V1.1.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€æœˆåº¦å ±å‘Š | MRAã€SRã€WHã€DL |
| 14 | SR_processQuickReplyStatistics | V1.1.0 | æ¨æ’­æœå‹™å±¤ | è™•ç†Quick Replyçµ±è¨ˆ | FSã€DDã€WHã€DL |
| 15 | SR_syncWithAccountModule | V1.1.0 | æ•¸æ“šæ•´åˆå±¤ | èˆ‡AMæ¨¡çµ„åŒæ­¥ | AMã€FSã€DL |
| 16 | SR_syncWithDataDistribution | V1.1.0 | æ•¸æ“šæ•´åˆå±¤ | èˆ‡DDæ¨¡çµ„åŒæ­¥ | DDã€FSã€DL |
| 17 | SR_logScheduledActivity | V1.1.0 | æ•¸æ“šæ•´åˆå±¤ | è¨˜éŒ„æ’ç¨‹æ´»å‹• | DLã€FS |
| 18 | SR_handleSchedulerError | V1.1.0 | æ•¸æ“šæ•´åˆå±¤ | è™•ç†æ’ç¨‹å™¨éŒ¯èª¤ | DLã€WHã€SR |

### 2.2 å‡½æ•¸åˆ†å±¤æ¶æ§‹

```
SRæ’ç¨‹æé†’æ¨¡çµ„ (v1.1.0)
â”œâ”€â”€ æ’ç¨‹ç®¡ç†å±¤ (6å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_createScheduledReminder() - å»ºç«‹æ’ç¨‹æé†’
â”‚   â”œâ”€â”€ SR_updateScheduledReminder() - æ›´æ–°æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ SR_deleteScheduledReminder() - åˆªé™¤æ’ç¨‹æé†’
â”‚   â”œâ”€â”€ SR_executeScheduledTask() - åŸ·è¡Œæ’ç¨‹ä»»å‹™
â”‚   â”œâ”€â”€ SR_processHolidayLogic() - è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯
â”‚   â””â”€â”€ SR_optimizeReminderTime() - æ™ºæ…§æ™‚é–“æœ€ä½³åŒ–
â”œâ”€â”€ ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ (4å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_validatePremiumFeature() - é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™
â”‚   â”œâ”€â”€ SR_checkSubscriptionStatus() - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
â”‚   â”œâ”€â”€ SR_enforceFreeUserLimits() - å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶
â”‚   â””â”€â”€ SR_upgradeFeatureAccess() - å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™
â”œâ”€â”€ æ¨æ’­æœå‹™å±¤ (4å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_sendDailyFinancialSummary() - ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦
â”‚   â”œâ”€â”€ SR_sendBudgetWarning() - ç™¼é€é ç®—è­¦å‘Š
â”‚   â”œâ”€â”€ SR_sendMonthlyReport() - ç™¼é€æœˆåº¦å ±å‘Š
â”‚   â””â”€â”€ SR_processQuickReplyStatistics() - è™•ç†Quick Replyçµ±è¨ˆ
â””â”€â”€ æ•¸æ“šæ•´åˆå±¤ (4å€‹å‡½æ•¸)
    â”œâ”€â”€ SR_syncWithAccountModule() - èˆ‡AMæ¨¡çµ„åŒæ­¥
    â”œâ”€â”€ SR_syncWithDataDistribution() - èˆ‡DDæ¨¡çµ„åŒæ­¥
    â”œâ”€â”€ SR_logScheduledActivity() - è¨˜éŒ„æ’ç¨‹æ´»å‹•
    â””â”€â”€ SR_handleSchedulerError() - è™•ç†æ’ç¨‹å™¨éŒ¯èª¤
```

---

## 3.0 æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ

### 3.1 æ’ç¨‹ç®¡ç†å±¤å‡½æ•¸

```javascript
/**
 * 01. å»ºç«‹æ’ç¨‹æé†’
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description å»ºç«‹æ–°çš„æ’ç¨‹æé†’è¨­å®šï¼Œæ”¯æ´é€±æœŸæ€§æé†’å’Œæ¢ä»¶åˆ¤æ–·
 */
function SR_createScheduledReminder(userId, reminderConfig, userType)
```
- **åŠŸèƒ½**: å»ºç«‹æ–°çš„æ’ç¨‹æé†’ï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œé…é¡é™åˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_validateUserType()` - é©—è­‰ç”¨æˆ¶é¡å‹å’Œæ¬Šé™
  - **FSæ¨¡çµ„** `FS_createDocument()` - å»ºç«‹æ’ç¨‹è¨­å®šæ–‡ä»¶
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„å»ºç«‹æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, reminderId: string, nextExecution: timestamp, quotaUsed: number}`

```javascript
/**
 * 02. æ›´æ–°æ’ç¨‹è¨­å®š
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description ä¿®æ”¹ç¾æœ‰æ’ç¨‹æé†’çš„è¨­å®šåƒæ•¸
 */
function SR_updateScheduledReminder(reminderId, updateData, userId)
```
- **åŠŸèƒ½**: å®‰å…¨æ›´æ–°æ’ç¨‹è¨­å®šï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œè¡çªæª¢æŸ¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°æ’ç¨‹è¨­å®š
  - **SRæ¨¡çµ„** `SR_recalculateNextExecution()` - é‡æ–°è¨ˆç®—åŸ·è¡Œæ™‚é–“
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ›´æ–°æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, updatedFields: array, nextExecution: timestamp}`

```javascript
/**
 * 03. åˆªé™¤æ’ç¨‹æé†’
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description å®‰å…¨åˆªé™¤æ’ç¨‹æé†’ä¸¦æ¸…ç†ç›¸é—œè³‡æ–™
 */
function SR_deleteScheduledReminder(reminderId, userId, reason)
```
- **åŠŸèƒ½**: å®Œæ•´çš„æ’ç¨‹åˆªé™¤æµç¨‹ï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œè³‡æ–™æ¸…ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_deleteDocument()` - åˆªé™¤æ’ç¨‹è¨­å®š
  - **SRæ¨¡çµ„** `SR_cleanupRelatedData()` - æ¸…ç†ç›¸é—œè³‡æ–™
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„åˆªé™¤æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, deletedId: string, cleanupStatus: object}`

```javascript
/**
 * 04. åŸ·è¡Œæ’ç¨‹ä»»å‹™
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description åŸ·è¡Œåˆ°æœŸçš„æ’ç¨‹ä»»å‹™ï¼Œè™•ç†æé†’å’Œè‡ªå‹•è¨˜å¸³
 */
function SR_executeScheduledTask(reminderId, executionContext)
```
- **åŠŸèƒ½**: æ ¸å¿ƒæ’ç¨‹åŸ·è¡Œé‚è¼¯ï¼ŒåŒ…å«æ¢ä»¶åˆ¤æ–·å’ŒéŒ¯èª¤è™•ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getDocument()` - å–å¾—æ’ç¨‹è¨­å®š
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€æé†’è¨Šæ¯
  - **BKæ¨¡çµ„** `BK_processAutoBookkeeping()` - è™•ç†è‡ªå‹•è¨˜å¸³
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„åŸ·è¡Œçµæœ
- **å›å‚³å€¼**: `{success: boolean, executionResult: object, nextExecution: timestamp}`

```javascript
/**
 * 05. è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è™•ç†åœ‹å®šå‡æ—¥å’Œé€±æœ«çš„æ’ç¨‹èª¿æ•´é‚è¼¯
 */
function SR_processHolidayLogic(scheduledDate, holidayHandling, userId)
```
- **åŠŸèƒ½**: æ™ºæ…§å‡æ—¥è™•ç†æ©Ÿåˆ¶ï¼Œæ”¯æ´è·³éã€æå‰ã€å»¶å¾Œä¸‰ç¨®ç­–ç•¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getHolidayList()` - å–å¾—åœ‹å®šå‡æ—¥æ¸…å–®
  - **SRæ¨¡çµ„** `SR_calculateAdjustedDate()` - è¨ˆç®—èª¿æ•´å¾Œæ—¥æœŸ
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„å‡æ—¥èª¿æ•´
- **å›å‚³å€¼**: `{adjustedDate: timestamp, adjustmentType: string, reason: string}`

```javascript
/**
 * 06. æ™ºæ…§æ™‚é–“æœ€ä½³åŒ–
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description åŸºæ–¼ä½¿ç”¨è€…ç¿’æ…£æœ€ä½³åŒ–æé†’æ™‚é–“ï¼ˆä»˜è²»åŠŸèƒ½ï¼‰
 */
function SR_optimizeReminderTime(userId, reminderData, userBehaviorData)
```
- **åŠŸèƒ½**: æ©Ÿå™¨å­¸ç¿’å¼æ™‚é–“æœ€ä½³åŒ–ï¼Œåˆ†æä½¿ç”¨è€…è¡Œç‚ºæ¨¡å¼
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™
  - **MRAæ¨¡çµ„** `MRA_analyzeUserBehavior()` - åˆ†æä½¿ç”¨è€…è¡Œç‚º
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°æœ€ä½³åŒ–è¨­å®š
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æœ€ä½³åŒ–çµæœ
- **å›å‚³å€¼**: `{optimizedTime: timestamp, confidence: number, reasoning: string}`

### 3.2 ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤å‡½æ•¸

```javascript
/**
 * 07. é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™ä½¿ç”¨ç‰¹å®šä»˜è²»åŠŸèƒ½
 */
function SR_validatePremiumFeature(userId, featureName, operationContext)
```
- **åŠŸèƒ½**: çµ±ä¸€çš„ä»˜è²»åŠŸèƒ½æ¬Šé™é©—è­‰æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—ä½¿ç”¨è€…è³‡è¨Š
  - **AMæ¨¡çµ„** `AM_checkSubscriptionStatus()` - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„æ¬Šé™é©—è­‰å¤±æ•—
- **å›å‚³å€¼**: `{hasPermission: boolean, subscriptionLevel: string, limitExceeded: boolean}`

```javascript
/**
 * 08. æª¢æŸ¥è¨‚é–±ç‹€æ…‹
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description æª¢æŸ¥ä½¿ç”¨è€…è¨‚é–±ç‹€æ…‹å’ŒåŠŸèƒ½å¯ç”¨æ€§
 */
function SR_checkSubscriptionStatus(userId)
```
- **åŠŸèƒ½**: è©³ç´°çš„è¨‚é–±ç‹€æ…‹æª¢æŸ¥ï¼ŒåŒ…å«éæœŸå’Œé™ç´šè™•ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getDocument()` - å–å¾—è¨‚é–±è³‡è¨Š
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—ä½¿ç”¨è€…åŸºæœ¬è³‡è¨Š
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„ç‹€æ…‹æª¢æŸ¥
- **å›å‚³å€¼**: `{isActive: boolean, expiryDate: timestamp, availableFeatures: array}`

```javascript
/**
 * 09. å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description å°å…è²»ç”¨æˆ¶å¼·åˆ¶åŸ·è¡ŒåŠŸèƒ½é™åˆ¶å’Œé…é¡æ§åˆ¶
 */
function SR_enforceFreeUserLimits(userId, operationType, currentUsage)
```
- **åŠŸèƒ½**: å…è²»ç”¨æˆ¶é™åˆ¶åŸ·è¡Œæ©Ÿåˆ¶ï¼ŒåŒ…å«è»Ÿé™åˆ¶å’Œç¡¬é™åˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getUserQuota()` - å–å¾—ä½¿ç”¨è€…é…é¡è³‡è¨Š
  - **WHæ¨¡çµ„** `WH_sendUpgradePrompt()` - ç™¼é€å‡ç´šæç¤º
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„é™åˆ¶åŸ·è¡Œ
- **å›å‚³å€¼**: `{allowed: boolean, remainingQuota: number, upgradePromptSent: boolean}`

```javascript
/**
 * 10. å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è™•ç†ä½¿ç”¨è€…å‡ç´šå¾Œçš„åŠŸèƒ½æ¬Šé™æ›´æ–°
 */
function SR_upgradeFeatureAccess(userId, newSubscriptionLevel, effectiveDate)
```
- **åŠŸèƒ½**: è¨‚é–±å‡ç´šå¾Œçš„åŠŸèƒ½æ¬Šé™å³æ™‚æ›´æ–°
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°ä½¿ç”¨è€…æ¬Šé™
  - **AMæ¨¡çµ„** `AM_updateAccountInfo()` - æ›´æ–°å¸³è™Ÿè³‡è¨Š
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼æ¬Šé™æ›´æ–°
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ¬Šé™å‡ç´š
- **å›å‚³å€¼**: `{success: boolean, activatedFeatures: array, syncStatus: object}`

### 3.3 æ¨æ’­æœå‹™å±¤å‡½æ•¸

```javascript
/**
 * 11. ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è‡ªå‹•ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦æ¨æ’­ï¼ˆä»˜è²»åŠŸèƒ½ï¼‰
 */
function SR_sendDailyFinancialSummary(userId, summaryData, pushTime)
```
- **åŠŸèƒ½**: æ™ºæ…§è²¡å‹™æ‘˜è¦ç”Ÿæˆå’Œæ¨æ’­æœå‹™
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **MRAæ¨¡çµ„** `MRA_generateFinancialSummary()` - ç”Ÿæˆè²¡å‹™æ‘˜è¦
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€æ¨æ’­è¨Šæ¯
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ¨æ’­çµæœ
- **å›å‚³å€¼**: `{success: boolean, messageId: string, deliveryStatus: object}`

```javascript
/**
 * 12. ç™¼é€é ç®—è­¦å‘Š
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è‡ªå‹•ç™¼é€é ç®—è¶…æ”¯è­¦å‘Šé€šçŸ¥
 */
function SR_sendBudgetWarning(userId, budgetData, thresholdReached)
```
- **åŠŸèƒ½**: æ™ºæ…§é ç®—ç›£æ§å’Œè­¦å‘Šæ¨æ’­ç³»çµ±
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **BMæ¨¡çµ„** `BM_getBudgetStatus()` - å–å¾—é ç®—ç‹€æ…‹
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€è­¦å‘Šè¨Šæ¯
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„é ç®—è­¦å‘Š
- **å›å‚³å€¼**: `{success: boolean, warningLevel: string, actionRequired: boolean}`

```javascript
/**
 * 13. ç™¼é€æœˆåº¦å ±å‘Š
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è‡ªå‹•ç”Ÿæˆä¸¦ç™¼é€æœˆåº¦è²¡å‹™å ±å‘Š
 */
function SR_sendMonthlyReport(userId, reportMonth, reportData)
```
- **åŠŸèƒ½**: å®Œæ•´çš„æœˆåº¦è²¡å‹™å ±å‘Šç”Ÿæˆå’Œæ¨æ’­
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **MRAæ¨¡çµ„** `MRA_generateMonthlyReport()` - ç”Ÿæˆæœˆåº¦å ±å‘Š
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€å ±å‘Šè¨Šæ¯
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„å ±å‘Šç™¼é€
- **å›å‚³å€¼**: `{success: boolean, reportId: string, deliveryTimestamp: timestamp}`

```javascript
/**
 * 14. è™•ç†Quick Replyçµ±è¨ˆ
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è™•ç†Quick Replyçµ±è¨ˆæŸ¥è©¢è«‹æ±‚
 */
function SR_processQuickReplyStatistics(userId, statisticType, queryParams)
```
- **åŠŸèƒ½**: å¿«é€Ÿçµ±è¨ˆæŸ¥è©¢è™•ç†ï¼Œæ”¯æ´ä»Šæ—¥ã€æœ¬é€±ã€æœ¬æœˆçµ±è¨ˆ
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_queryUserData()` - æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™
  - **DDæ¨¡çµ„** `DD_processDataQuery()` - è™•ç†è³‡æ–™æŸ¥è©¢
  - **WHæ¨¡çµ„** `WH_sendQuickReply()` - ç™¼é€Quick Replyå›æ‡‰
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„çµ±è¨ˆæŸ¥è©¢
- **å›å‚³å€¼**: `{success: boolean, statisticData: object, quickReplyOptions: array}`

### 3.4 æ•¸æ“šæ•´åˆå±¤å‡½æ•¸

```javascript
/**
 * 15. èˆ‡AMæ¨¡çµ„åŒæ­¥
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description èˆ‡å¸³è™Ÿç®¡ç†æ¨¡çµ„åŒæ­¥ä½¿ç”¨è€…è³‡è¨Šå’Œæ¬Šé™
 */
function SR_syncWithAccountModule(userId, syncType, syncData)
```
- **åŠŸèƒ½**: ç¢ºä¿ä½¿ç”¨è€…è³‡è¨Šå’Œæ¬Šé™çš„ä¸€è‡´æ€§åŒæ­¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—æœ€æ–°ä½¿ç”¨è€…è³‡è¨Š
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°æœ¬åœ°å¿«å–è³‡è¨Š
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„åŒæ­¥ç‹€æ…‹
- **å›å‚³å€¼**: `{success: boolean, syncedFields: array, conflictResolved: boolean}`

```javascript
/**
 * 16. èˆ‡DDæ¨¡çµ„åŒæ­¥
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description èˆ‡è³‡æ–™åˆ†ç™¼æ¨¡çµ„åŒæ­¥æ’ç¨‹ç›¸é—œè³‡æ–™
 */
function SR_syncWithDataDistribution(userId, distributionData, targetModules)
```
- **åŠŸèƒ½**: è·¨æ¨¡çµ„è³‡æ–™åˆ†ç™¼å’ŒåŒæ­¥æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼æ’ç¨‹è³‡æ–™
  - **FSæ¨¡çµ„** `FS_batchUpdate()` - æ‰¹æ¬¡æ›´æ–°è³‡æ–™
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„åˆ†ç™¼çµæœ
- **å›å‚³å€¼**: `{success: boolean, distributedModules: array, syncTimestamp: timestamp}`

```javascript
/**
 * 17. è¨˜éŒ„æ’ç¨‹æ´»å‹•
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description è¨˜éŒ„æ’ç¨‹ç›¸é—œçš„æ‰€æœ‰æ´»å‹•å’Œæ“ä½œ
 */
function SR_logScheduledActivity(userId, activityType, activityData, result)
```
- **åŠŸèƒ½**: æ¨™æº–åŒ–çš„æ’ç¨‹æ´»å‹•æ—¥èªŒè¨˜éŒ„
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„ä¸€èˆ¬æ´»å‹•
  - **DLæ¨¡çµ„** `DL_error()` - è¨˜éŒ„éŒ¯èª¤æ´»å‹•
  - **FSæ¨¡çµ„** `FS_createDocument()` - å»ºç«‹æ´»å‹•è¨˜éŒ„
- **å›å‚³å€¼**: `{success: boolean, logId: string, logLevel: string}`

```javascript
/**
 * 18. è™•ç†æ’ç¨‹å™¨éŒ¯èª¤
 * @version 2025-01-09-V1.1.0
 * @date 2025-01-09 16:00:00
 * @description çµ±ä¸€è™•ç†æ’ç¨‹å™¨é‹è¡Œéç¨‹ä¸­çš„å„ç¨®éŒ¯èª¤
 */
function SR_handleSchedulerError(errorType, errorData, context, retryCount)
```
- **åŠŸèƒ½**: æ¨™æº–åŒ–éŒ¯èª¤è™•ç†èˆ‡è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DLæ¨¡çµ„** `DL_error()` - è©³ç´°éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
  - **WHæ¨¡çµ„** `WH_sendErrorNotification()` - ç™¼é€éŒ¯èª¤é€šçŸ¥
  - **SRæ¨¡çµ„** `SR_scheduleRetry()` - å®‰æ’é‡è©¦åŸ·è¡Œ
- **å›å‚³å€¼**: `{handled: boolean, errorCode: string, retryScheduled: boolean}`

---

## 4.0 æ¨¡çµ„é–“äº’å‹•æ¶æ§‹

### 4.1 æ ¸å¿ƒä¾è³´é—œä¿‚
```
SR æ’ç¨‹æé†’æ¨¡çµ„
â”œâ”€â”€ FSæ¨¡çµ„ (Firestore Service)
â”‚   â”œâ”€â”€ FS_createDocument() - å»ºç«‹æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_updateDocument() - æ›´æ–°æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_deleteDocument() - åˆªé™¤æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_getDocument() - å–å¾—æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_queryUserData() - æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™
â”‚   â””â”€â”€ FS_batchUpdate() - æ‰¹æ¬¡æ›´æ–°è³‡æ–™
â”œâ”€â”€ WHæ¨¡çµ„ (Webhookè™•ç†)
â”‚   â”œâ”€â”€ WH_sendPushMessage() - ç™¼é€æ¨æ’­è¨Šæ¯
â”‚   â”œâ”€â”€ WH_sendQuickReply() - ç™¼é€Quick Replyå›æ‡‰
â”‚   â”œâ”€â”€ WH_sendUpgradePrompt() - ç™¼é€å‡ç´šæç¤º
â”‚   â””â”€â”€ WH_sendErrorNotification() - ç™¼é€éŒ¯èª¤é€šçŸ¥
â”œâ”€â”€ AMæ¨¡çµ„ (Account Management)
â”‚   â”œâ”€â”€ AM_validateUserType() - é©—è­‰ä½¿ç”¨è€…é¡å‹
â”‚   â”œâ”€â”€ AM_getUserInfo() - å–å¾—ä½¿ç”¨è€…è³‡è¨Š
â”‚   â”œâ”€â”€ AM_checkSubscriptionStatus() - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
â”‚   â”œâ”€â”€ AM_validatePremiumFeature() - é©—è­‰ä»˜è²»åŠŸèƒ½
â”‚   â””â”€â”€ AM_updateAccountInfo() - æ›´æ–°å¸³è™Ÿè³‡è¨Š
â”œâ”€â”€ DDæ¨¡çµ„ (Data Distribution)
â”‚   â”œâ”€â”€ DD_distributeData() - åˆ†ç™¼è³‡æ–™
â”‚   â”œâ”€â”€ DD_processDataQuery() - è™•ç†è³‡æ–™æŸ¥è©¢
â”‚   â””â”€â”€ è·¨æ¨¡çµ„è³‡æ–™åŒæ­¥å”èª¿
â”œâ”€â”€ DLæ¨¡çµ„ (Data Logging)
â”‚   â”œâ”€â”€ DL_log() - ä¸€èˆ¬æ“ä½œæ—¥èªŒ
â”‚   â”œâ”€â”€ DL_error() - éŒ¯èª¤æ—¥èªŒ
â”‚   â”œâ”€â”€ DL_warning() - è­¦å‘Šæ—¥èªŒ
â”‚   â””â”€â”€ DL_info() - è³‡è¨Šæ—¥èªŒ
â”œâ”€â”€ BKæ¨¡çµ„ (Bookkeeping)
â”‚   â”œâ”€â”€ BK_processAutoBookkeeping() - è™•ç†è‡ªå‹•è¨˜å¸³
â”‚   â””â”€â”€ è‡ªå‹•è¨˜å¸³æ•¸æ“šè™•ç†
â”œâ”€â”€ BMæ¨¡çµ„ (Budget Management)
â”‚   â”œâ”€â”€ BM_getBudgetStatus() - å–å¾—é ç®—ç‹€æ…‹
â”‚   â””â”€â”€ é ç®—ç›£æ§æ”¯æ´
â”œâ”€â”€ MRAæ¨¡çµ„ (Multi-platform Report & Analytics)
â”‚   â”œâ”€â”€ MRA_generateFinancialSummary() - ç”Ÿæˆè²¡å‹™æ‘˜è¦
â”‚   â”œâ”€â”€ MRA_generateMonthlyReport() - ç”Ÿæˆæœˆåº¦å ±å‘Š
â”‚   â”œâ”€â”€ MRA_analyzeUserBehavior() - åˆ†æä½¿ç”¨è€…è¡Œç‚º
â”‚   â””â”€â”€ è²¡å‹™å ±å‘Šç”Ÿæˆæ”¯æ´
â””â”€â”€ Node-cron
    â”œâ”€â”€ æ’ç¨‹ä»»å‹™èª¿åº¦
    â””â”€â”€ æ™‚é–“è§¸ç™¼å™¨ç®¡ç†
```

### 4.2 è³‡æ–™æµå‘è¨­è¨ˆ
```
æ’ç¨‹è§¸ç™¼ â†’ SRæ’ç¨‹é©—è­‰ â†’ ä»˜è²»åŠŸèƒ½æª¢æŸ¥ â†’ æ¢ä»¶åˆ¤æ–· â†’ 
åŸ·è¡Œå‹•ä½œ â†’ çµæœè™•ç† â†’ è·¨æ¨¡çµ„åŒæ­¥ â†’ æ—¥èªŒè¨˜éŒ„ â†’ å®Œæˆå›æ‡‰
```

---

## 5.0 è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ

### 5.1 FSæ¨¡çµ„é›†åˆçµæ§‹éœ€æ±‚
```
scheduled_reminders/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {reminder_id}/
â”‚   â”œâ”€â”€ userId: string (ç´¢å¼•)
â”‚   â”œâ”€â”€ reminderType: "daily" | "weekly" | "monthly" | "custom"
â”‚   â”œâ”€â”€ cronExpression: string
â”‚   â”œâ”€â”€ timezone: "Asia/Taipei"
â”‚   â”œâ”€â”€ isActive: boolean
â”‚   â”œâ”€â”€ reminderData: object
â”‚   â”‚   â”œâ”€â”€ subjectCode: string
â”‚   â”‚   â”œâ”€â”€ amount: number
â”‚   â”‚   â”œâ”€â”€ paymentMethod: string
â”‚   â”‚   â””â”€â”€ message: string
â”‚   â”œâ”€â”€ conditions: object
â”‚   â”‚   â”œâ”€â”€ skipWeekends: boolean
â”‚   â”‚   â”œâ”€â”€ holidayHandling: "skip" | "advance" | "delay"
â”‚   â”‚   â””â”€â”€ customConditions: array
â”‚   â”œâ”€â”€ execution: object
â”‚   â”‚   â”œâ”€â”€ lastExecuted: timestamp (UTC+8)
â”‚   â”‚   â”œâ”€â”€ nextExecution: timestamp (UTC+8)
â”‚   â”‚   â”œâ”€â”€ executionCount: number
â”‚   â”‚   â””â”€â”€ failureCount: number
â”‚   â”œâ”€â”€ createdAt: timestamp (UTC+8)
â”‚   â”œâ”€â”€ updatedAt: timestamp (UTC+8)
â”‚   â””â”€â”€ metadata: object

user_quotas/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {user_id}/
â”‚   â”œâ”€â”€ reminderQuota: number
â”‚   â”œâ”€â”€ usedReminders: number
â”‚   â”œâ”€â”€ subscriptionLevel: "free" | "premium"
â”‚   â”œâ”€â”€ lastQuotaReset: timestamp (UTC+8)
â”‚   â””â”€â”€ quotaHistory: array

holiday_calendar/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {year}/
â”‚   â”œâ”€â”€ holidays: array
â”‚   â”‚   â”œâ”€â”€ date: string (YYYY-MM-DD)
â”‚   â”‚   â”œâ”€â”€ name: string
â”‚   â”‚   â””â”€â”€ type: "national" | "religious" | "custom"
â”‚   â”œâ”€â”€ updatedAt: timestamp (UTC+8)
â”‚   â””â”€â”€ source: string

scheduler_logs/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {log_id}/
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ reminderId: string
â”‚   â”œâ”€â”€ activityType: string
â”‚   â”œâ”€â”€ activityData: object
â”‚   â”œâ”€â”€ result: object
â”‚   â”œâ”€â”€ timestamp: timestamp (UTC+8)
â”‚   â””â”€â”€ logLevel: "info" | "warning" | "error"
```

### 5.2 ä»˜è²»åŠŸèƒ½æ¬Šé™è¨­è¨ˆ
```javascript
premiumFeatures: {
  dailyFinancialSummary: {
    level: "premium",
    quotaLimited: false,
    description: "æ¯æ—¥è²¡å‹™æ‘˜è¦æ¨æ’­"
  },
  budgetWarning: {
    level: "premium", 
    quotaLimited: false,
    description: "é ç®—è­¦å‘Šé€šçŸ¥"
  },
  monthlyReport: {
    level: "premium",
    quotaLimited: false,
    description: "æœˆåº¦è²¡å‹™å ±å‘Š"
  },
  smartTimeOptimization: {
    level: "premium",
    quotaLimited: false,
    description: "æ™ºæ…§æ™‚é–“æœ€ä½³åŒ–"
  },
  unlimitedReminders: {
    level: "premium",
    quotaLimited: false,
    description: "ç„¡é™åˆ¶æé†’è¨­å®š"
  }
}

freeFeatures: {
  basicReminder: {
    level: "free",
    quotaLimited: true,
    maxCount: 2,
    description: "åŸºç¤æé†’è¨­å®š"
  },
  quickReplyStatistics: {
    level: "free",
    quotaLimited: false,
    description: "Quick Replyçµ±è¨ˆæŸ¥è©¢"
  },
  manualStatistics: {
    level: "free",
    quotaLimited: false,
    description: "æ‰‹å‹•çµ±è¨ˆæŸ¥è©¢"
  }
}
```

---

## 6.0 API ä»‹é¢è¦æ ¼

### 6.1 REST API ç«¯é»
```
POST   /api/v2/scheduler/reminder/create      - å»ºç«‹æ’ç¨‹æé†’
PUT    /api/v2/scheduler/reminder/{id}/update - æ›´æ–°æ’ç¨‹è¨­å®š
DELETE /api/v2/scheduler/reminder/{id}/delete - åˆªé™¤æ’ç¨‹æé†’
GET    /api/v2/scheduler/reminder/{id}        - æŸ¥è©¢æ’ç¨‹è¨­å®š
GET    /api/v2/scheduler/reminders/user/{uid} - æŸ¥è©¢ä½¿ç”¨è€…æ’ç¨‹æ¸…å–®
POST   /api/v2/scheduler/execute/{id}         - æ‰‹å‹•åŸ·è¡Œæ’ç¨‹
GET    /api/v2/scheduler/statistics/quick     - Quick Replyçµ±è¨ˆ
POST   /api/v2/scheduler/push/daily           - æ¯æ—¥æ¨æ’­è¨­å®š
POST   /api/v2/scheduler/push/budget          - é ç®—è­¦å‘Šè¨­å®š
POST   /api/v2/scheduler/push/monthly         - æœˆåº¦å ±å‘Šè¨­å®š
GET    /api/v2/scheduler/quota/user/{uid}     - æŸ¥è©¢ä½¿ç”¨è€…é…é¡
GET    /api/v2/scheduler/health               - æ’ç¨‹å™¨å¥åº·æª¢æŸ¥
```

### 6.2 Cron è¡¨é”å¼è¨­è¨ˆ
```javascript
cronExpressions: {
  daily: "0 21 * * *",           // æ¯æ—¥21:00
  weekly: "0 21 * * 0",          // æ¯é€±æ—¥21:00
  monthly: "0 21 1 * *",         // æ¯æœˆ1æ—¥21:00
  custom: "0 {hour} {day} {month} {weekday}" // è‡ªè¨‚æ™‚é–“
}

timezoneHandling: {
  default: "Asia/Taipei",
  format: "UTC+8",
  holidayCheck: true,
  weekendCheck: true
}
```

---

## 7.0 æ’ç¨‹å¼•æ“è¨­è¨ˆ

### 7.1 æ’ç¨‹ä»»å‹™ç®¡ç†
```javascript
const cron = require('node-cron');

// ä¸»è¦æ’ç¨‹ä»»å‹™
const schedulerTasks = {
  // æ¯åˆ†é˜æª¢æŸ¥åˆ°æœŸçš„æ’ç¨‹
  minutelyCheck: cron.schedule('* * * * *', () => {
    SR_checkPendingReminders();
  }),
  
  // æ¯æ—¥21:00åŸ·è¡Œä»˜è²»ç”¨æˆ¶æ¨æ’­
  dailyPush: cron.schedule('0 21 * * *', () => {
    SR_processDailyPushNotifications();
  }),
  
  // æ¯é€±æ—¥21:00åŸ·è¡Œé€±å ±
  weeklyReport: cron.schedule('0 21 * * 0', () => {
    SR_processWeeklyReports();
  }),
  
  // æ¯æœˆ1æ—¥21:00åŸ·è¡Œæœˆå ±
  monthlyReport: cron.schedule('0 21 1 * *', () => {
    SR_processMonthlyReports();
  }),
  
  // æ¯æ—¥å‡Œæ™¨2:00æ¸…ç†éæœŸè³‡æ–™
  dailyCleanup: cron.schedule('0 2 * * *', () => {
    SR_cleanupExpiredData();
  })
};
```

### 7.2 æ™‚å€å’Œå‡æ—¥è™•ç†
```javascript
const moment = require('moment-timezone');

// æ™‚å€è½‰æ›
function convertToUserTimezone(timestamp, timezone = 'Asia/Taipei') {
  return moment(timestamp).tz(timezone);
}

// å‡æ—¥æª¢æŸ¥
function isHoliday(date) {
  // é€éFSæ¨¡çµ„æŸ¥è©¢å‡æ—¥è³‡æ–™
  return FS_checkHolidayCalendar(date);
}

// é€±æœ«æª¢æŸ¥
function isWeekend(date) {
  const dayOfWeek = moment(date).day();
  return dayOfWeek === 0 || dayOfWeek === 6; // 0=é€±æ—¥, 6=é€±å…­
}
```

---

## 8.0 ä»˜è²»åŠŸèƒ½æ§åˆ¶æ©Ÿåˆ¶

### 8.1 åŠŸèƒ½æ¬Šé™é©—è­‰æµç¨‹
```javascript
async function validateFeatureAccess(userId, featureName) {
  // 1. å–å¾—ä½¿ç”¨è€…è³‡è¨Š
  const userInfo = await AM_getUserInfo(userId);
  
  // 2. æª¢æŸ¥è¨‚é–±ç‹€æ…‹
  const subscription = await AM_checkSubscriptionStatus(userId);
  
  // 3. é©—è­‰åŠŸèƒ½æ¬Šé™
  const hasPermission = subscription.level === 'premium' || 
                       freeFeatures[featureName];
  
  // 4. æª¢æŸ¥é…é¡é™åˆ¶
  if (hasPermission && freeFeatures[featureName]?.quotaLimited) {
    const quota = await FS_getUserQuota(userId);
    hasPermission = quota.usedReminders < freeFeatures[featureName].maxCount;
  }
  
  return {
    hasPermission,
    subscriptionLevel: subscription.level,
    quotaExceeded: !hasPermission && freeFeatures[featureName]?.quotaLimited
  };
}
```

### 8.2 åŠŸèƒ½é™ç´šè™•ç†
```javascript
async function handleFeatureDowngrade(userId, expiredFeatures) {
  // 1. åœç”¨ä»˜è²»åŠŸèƒ½
  await SR_disablePremiumFeatures(userId, expiredFeatures);
  
  // 2. èª¿æ•´æ’ç¨‹è¨­å®š
  await SR_adjustSchedulesForFreeUser(userId);
  
  // 3. ç™¼é€é™ç´šé€šçŸ¥
  await WH_sendFeatureDowngradeNotification(userId, expiredFeatures);
  
  // 4. è¨˜éŒ„é™ç´šæ“ä½œ
  await DL_log(`åŠŸèƒ½é™ç´šåŸ·è¡Œå®Œæˆ`, 'FEATURE_DOWNGRADE', userId);
}
```

---

## 9.0 éŒ¯èª¤è™•ç†èˆ‡ç›£æ§

### 9.1 éŒ¯èª¤é¡å‹å®šç¾©
```javascript
const ErrorTypes = {
  SCHEDULER_TIMEOUT: 'scheduler_timeout',
  PERMISSION_DENIED: 'permission_denied',
  QUOTA_EXCEEDED: 'quota_exceeded',
  EXTERNAL_API_ERROR: 'external_api_error',
  DATABASE_ERROR: 'database_error',
  VALIDATION_ERROR: 'validation_error',
  HOLIDAY_PROCESSING_ERROR: 'holiday_processing_error'
};
```

### 9.2 é‡è©¦æ©Ÿåˆ¶è¨­è¨ˆ
```javascript
async function executeWithRetry(operation, maxRetries = 3, delay = 1000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      if (attempt === maxRetries) {
        throw error;
      }
      
      await new Promise(resolve => setTimeout(resolve, delay * attempt));
      await DL_warning(`é‡è©¦ç¬¬ ${attempt} æ¬¡: ${error.message}`);
    }
  }
}
```

### 9.3 å¥åº·ç›£æ§æ©Ÿåˆ¶
```javascript
async function SR_monitorSystemHealth() {
  const healthMetrics = {
    activeReminders: await FS_countActiveReminders(),
    pendingExecutions: await FS_countPendingExecutions(),
    failedExecutions: await FS_countFailedExecutions(),
    systemUptime: process.uptime(),
    memoryUsage: process.memoryUsage(),
    cronJobsStatus: getCronJobsStatus()
  };
  
  // æª¢æŸ¥å¥åº·ç‹€æ…‹
  const isHealthy = healthMetrics.failedExecutions < 10 && 
                   healthMetrics.memoryUsage.heapUsed < 500 * 1024 * 1024;
  
  if (!isHealthy) {
    await DL_error('æ’ç¨‹ç³»çµ±å¥åº·ç‹€æ…‹ç•°å¸¸', 'SYSTEM_HEALTH_ALERT', 'SYSTEM');
  }
  
  return { healthy: isHealthy, metrics: healthMetrics };
}
```

---

## 10.0 æ•ˆèƒ½æœ€ä½³åŒ–

### 10.1 å¿«å–ç­–ç•¥
```javascript
const NodeCache = require('node-cache');

const cacheConfig = {
  userPermissions: new NodeCache({ stdTTL: 600 }), // 10åˆ†é˜
  holidayCalendar: new NodeCache({ stdTTL: 86400 }), // 24å°æ™‚
  userQuotas: new NodeCache({ stdTTL: 300 }), // 5åˆ†é˜
  schedulerStatus: new NodeCache({ stdTTL: 60 }) // 1åˆ†é˜
};
```

### 10.2 æ‰¹æ¬¡è™•ç†å„ªåŒ–
```javascript
async function processBatchReminders(reminders) {
  const batchSize = 50;
  const batches = [];
  
  for (let i = 0; i < reminders.length; i += batchSize) {
    batches.push(reminders.slice(i, i + batchSize));
  }
  
  for (const batch of batches) {
    await Promise.all(batch.map(reminder => 
      SR_executeScheduledTask(reminder.id, reminder.context)
    ));
    
    // æ‰¹æ¬¡é–“å»¶é²ï¼Œé¿å…ç³»çµ±éè¼‰
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}
```

---

## 11.0 æ¸¬è©¦ç­–ç•¥

### 11.1 å–®å…ƒæ¸¬è©¦è¦†è“‹
- SR_createScheduledReminder() æ¸¬è©¦
- SR_executeScheduledTask() æ¸¬è©¦  
- SR_validatePremiumFeature() æ¸¬è©¦
- SR_processHolidayLogic() æ¸¬è©¦
- éŒ¯èª¤è™•ç†æ©Ÿåˆ¶æ¸¬è©¦

### 11.2 æ•´åˆæ¸¬è©¦å ´æ™¯
- æ¨¡çµ„é–“äº’å‹•æ¸¬è©¦
- ä»˜è²»åŠŸèƒ½æ¬Šé™é©—è­‰æ¸¬è©¦
- æ’ç¨‹åŸ·è¡Œæº–ç¢ºæ€§æ¸¬è©¦
- è³‡æ–™åº«ä¸€è‡´æ€§æ¸¬è©¦

### 11.3 æ•ˆèƒ½æ¸¬è©¦æŒ‡æ¨™
- æ’ç¨‹åŸ·è¡Œå»¶é² < 30ç§’
- ä¸¦ç™¼è™•ç†èƒ½åŠ› > 1000å€‹æ’ç¨‹
- è¨˜æ†¶é«”ä½¿ç”¨ç‡ < 80%
- éŒ¯èª¤ç‡ < 1%

---

## 12.0 æ–‡ä»¶ç¶­è­·è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹è€… | ä¿®æ”¹å…§å®¹ |
|------|------|--------|----------|
| v1.0 | 2025-01-09 15:30:00 +08:00 | LCAS SA Team | åˆç‰ˆå»ºç«‹ï¼Œå®Œæ•´æŠ€è¡“è¨­è¨ˆï¼ŒåŸºæ–¼PRD 1005éœ€æ±‚ï¼Œæ•´åˆæ¨¡çµ„é–“å”ä½œæ¶æ§‹ |
| v1.1 | 2025-01-09 16:00:00 +08:00 | LCAS SA Team | å‡ç´šç‰ˆæœ¬ï¼Œæ–°å¢å®Œæ•´ç›®æ¬¡å’Œå‡½æ•¸æ¸…å–®è¡¨æ ¼ï¼Œå„ªåŒ–æ–‡ä»¶çµæ§‹å’Œå°èˆªï¼Œæ‰€æœ‰å‡½æ•¸ç‰ˆæœ¬å‡ç´šè‡³V1.1.0 |

---

**æ–‡ä»¶çµæŸ**
*æ­¤æ–‡ä»¶ç‚º LCAS 2.0 SR æ’ç¨‹æé†’æ¨¡çµ„çš„å®Œæ•´æŠ€è¡“è¨­è¨ˆè¦æ ¼ v1.1 ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´ç›®æ¬¡ã€å‡½æ•¸æ¸…å–®è¡¨æ ¼å’Œ18å€‹æ ¸å¿ƒå‡½æ•¸çš„è©³ç´°è¨­è¨ˆï¼Œæ‰€æœ‰å‡½æ•¸è¨­è¨ˆå‡åŸºæ–¼ PRD éœ€æ±‚ä¸¦éµå¾ªæ¨¡çµ„é–“å”ä½œåŸå‰‡ã€‚*
