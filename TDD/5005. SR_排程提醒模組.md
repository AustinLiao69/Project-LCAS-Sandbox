
# 5005. TDD_SR_排程提醒模組_v1.0

## 文件資訊
- **文件標題**: SR 排程提醒模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-01-09 15:30:00 +08:00 (台灣時間)
- **創建者**: LCAS SA Team
- **對應需求文件**: 1005. SR_排程提醒模組.md
- **模組代碼**: SR (Scheduled Reminder)

---

## 1.0 技術架構概述

### 1.1 模組定位
SR 排程提醒模組作為 LCAS 2.0 的智慧記帳自動化核心，負責處理定期記帳提醒、自動記帳執行、財務統計推播等功能。本模組專注於排程邏輯和業務規則，透過其他模組提供的標準化介面進行資料庫操作和外部服務整合。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **排程引擎**: Node-cron
- **資料庫**: Firestore (透過FS模組)
- **推播服務**: LINE Push API (透過WH模組)
- **時區處理**: moment-timezone
- **日誌系統**: DL 模組
- **資料分發**: DD 模組

### 1.3 模組架構
```javascript
/**
 * SR_排程提醒模組_1.0.0
 * @module SR模組
 * @description 智慧記帳自動化核心 - 排程提醒、自動記帳、財務統計推播
 * @update 2025-01-09: 初版建立，實現排程管理與付費功能控制
 */
```

---

## 2.0 核心函數設計

### 2.1 排程管理層函數

```javascript
/**
 * 01. 建立排程提醒
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 建立新的排程提醒設定，支援週期性提醒和條件判斷
 */
function SR_createScheduledReminder(userId, reminderConfig, userType)
```
- **功能**: 建立新的排程提醒，包含權限驗證和配額限制
- **與其他模組互動**:
  - **AM模組** `AM_validateUserType()` - 驗證用戶類型和權限
  - **FS模組** `FS_createDocument()` - 建立排程設定文件
  - **DL模組** `DL_log()` - 記錄建立操作
- **回傳值**: `{success: boolean, reminderId: string, nextExecution: timestamp, quotaUsed: number}`

```javascript
/**
 * 02. 更新排程設定
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 修改現有排程提醒的設定參數
 */
function SR_updateScheduledReminder(reminderId, updateData, userId)
```
- **功能**: 安全更新排程設定，包含權限驗證和衝突檢查
- **與其他模組互動**:
  - **FS模組** `FS_updateDocument()` - 更新排程設定
  - **SR模組** `SR_recalculateNextExecution()` - 重新計算執行時間
  - **DL模組** `DL_log()` - 記錄更新操作
- **回傳值**: `{success: boolean, updatedFields: array, nextExecution: timestamp}`

```javascript
/**
 * 03. 刪除排程提醒
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 安全刪除排程提醒並清理相關資料
 */
function SR_deleteScheduledReminder(reminderId, userId, reason)
```
- **功能**: 完整的排程刪除流程，包含權限驗證和資料清理
- **與其他模組互動**:
  - **FS模組** `FS_deleteDocument()` - 刪除排程設定
  - **SR模組** `SR_cleanupRelatedData()` - 清理相關資料
  - **DL模組** `DL_warning()` - 記錄刪除操作
- **回傳值**: `{success: boolean, deletedId: string, cleanupStatus: object}`

```javascript
/**
 * 04. 執行排程任務
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 執行到期的排程任務，處理提醒和自動記帳
 */
function SR_executeScheduledTask(reminderId, executionContext)
```
- **功能**: 核心排程執行邏輯，包含條件判斷和錯誤處理
- **與其他模組互動**:
  - **FS模組** `FS_getDocument()` - 取得排程設定
  - **WH模組** `WH_sendPushMessage()` - 發送提醒訊息
  - **BK模組** `BK_processAutoBookkeeping()` - 處理自動記帳
  - **DL模組** `DL_log()` - 記錄執行結果
- **回傳值**: `{success: boolean, executionResult: object, nextExecution: timestamp}`

```javascript
/**
 * 05. 處理國定假日邏輯
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 處理國定假日和週末的排程調整邏輯
 */
function SR_processHolidayLogic(scheduledDate, holidayHandling, userId)
```
- **功能**: 智慧假日處理機制，支援跳過、提前、延後三種策略
- **與其他模組互動**:
  - **FS模組** `FS_getHolidayList()` - 取得國定假日清單
  - **SR模組** `SR_calculateAdjustedDate()` - 計算調整後日期
  - **DL模組** `DL_info()` - 記錄假日調整
- **回傳值**: `{adjustedDate: timestamp, adjustmentType: string, reason: string}`

```javascript
/**
 * 06. 智慧時間最佳化
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 基於使用者習慣最佳化提醒時間（付費功能）
 */
function SR_optimizeReminderTime(userId, reminderData, userBehaviorData)
```
- **功能**: 機器學習式時間最佳化，分析使用者行為模式
- **與其他模組互動**:
  - **AM模組** `AM_validatePremiumFeature()` - 驗證付費功能權限
  - **MRA模組** `MRA_analyzeUserBehavior()` - 分析使用者行為
  - **FS模組** `FS_updateDocument()` - 更新最佳化設定
  - **DL模組** `DL_log()` - 記錄最佳化結果
- **回傳值**: `{optimizedTime: timestamp, confidence: number, reasoning: string}`

### 2.2 付費功能控制層函數

```javascript
/**
 * 07. 驗證付費功能權限
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 檢查使用者是否有權限使用特定付費功能
 */
function SR_validatePremiumFeature(userId, featureName, operationContext)
```
- **功能**: 統一的付費功能權限驗證機制
- **與其他模組互動**:
  - **AM模組** `AM_getUserInfo()` - 取得使用者資訊
  - **AM模組** `AM_checkSubscriptionStatus()` - 檢查訂閱狀態
  - **DL模組** `DL_warning()` - 記錄權限驗證失敗
- **回傳值**: `{hasPermission: boolean, subscriptionLevel: string, limitExceeded: boolean}`

```javascript
/**
 * 08. 檢查訂閱狀態
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 檢查使用者訂閱狀態和功能可用性
 */
function SR_checkSubscriptionStatus(userId)
```
- **功能**: 詳細的訂閱狀態檢查，包含過期和降級處理
- **與其他模組互動**:
  - **FS模組** `FS_getDocument()` - 取得訂閱資訊
  - **AM模組** `AM_getUserInfo()` - 取得使用者基本資訊
  - **DL模組** `DL_info()` - 記錄狀態檢查
- **回傳值**: `{isActive: boolean, expiryDate: timestamp, availableFeatures: array}`

```javascript
/**
 * 09. 強制免費用戶限制
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 對免費用戶強制執行功能限制和配額控制
 */
function SR_enforceFreeUserLimits(userId, operationType, currentUsage)
```
- **功能**: 免費用戶限制執行機制，包含軟限制和硬限制
- **與其他模組互動**:
  - **FS模組** `FS_getUserQuota()` - 取得使用者配額資訊
  - **WH模組** `WH_sendUpgradePrompt()` - 發送升級提示
  - **DL模組** `DL_warning()` - 記錄限制執行
- **回傳值**: `{allowed: boolean, remainingQuota: number, upgradePromptSent: boolean}`

```javascript
/**
 * 10. 升級功能存取權限
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 處理使用者升級後的功能權限更新
 */
function SR_upgradeFeatureAccess(userId, newSubscriptionLevel, effectiveDate)
```
- **功能**: 訂閱升級後的功能權限即時更新
- **與其他模組互動**:
  - **FS模組** `FS_updateDocument()` - 更新使用者權限
  - **AM模組** `AM_updateAccountInfo()` - 更新帳號資訊
  - **DD模組** `DD_distributeData()` - 分發權限更新
  - **DL模組** `DL_log()` - 記錄權限升級
- **回傳值**: `{success: boolean, activatedFeatures: array, syncStatus: object}`

### 2.3 推播服務層函數

```javascript
/**
 * 11. 發送每日財務摘要
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 自動發送每日財務摘要推播（付費功能）
 */
function SR_sendDailyFinancialSummary(userId, summaryData, pushTime)
```
- **功能**: 智慧財務摘要生成和推播服務
- **與其他模組互動**:
  - **SR模組** `SR_validatePremiumFeature()` - 驗證付費功能
  - **MRA模組** `MRA_generateFinancialSummary()` - 生成財務摘要
  - **WH模組** `WH_sendPushMessage()` - 發送推播訊息
  - **DL模組** `DL_log()` - 記錄推播結果
- **回傳值**: `{success: boolean, messageId: string, deliveryStatus: object}`

```javascript
/**
 * 12. 發送預算警告
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 自動發送預算超支警告通知
 */
function SR_sendBudgetWarning(userId, budgetData, thresholdReached)
```
- **功能**: 智慧預算監控和警告推播系統
- **與其他模組互動**:
  - **BM模組** `BM_getBudgetStatus()` - 取得預算狀態
  - **SR模組** `SR_validatePremiumFeature()` - 驗證付費功能
  - **WH模組** `WH_sendPushMessage()` - 發送警告訊息
  - **DL模組** `DL_warning()` - 記錄預算警告
- **回傳值**: `{success: boolean, warningLevel: string, actionRequired: boolean}`

```javascript
/**
 * 13. 發送月度報告
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 自動生成並發送月度財務報告
 */
function SR_sendMonthlyReport(userId, reportMonth, reportData)
```
- **功能**: 完整的月度財務報告生成和推播
- **與其他模組互動**:
  - **MRA模組** `MRA_generateMonthlyReport()` - 生成月度報告
  - **SR模組** `SR_validatePremiumFeature()` - 驗證付費功能
  - **WH模組** `WH_sendPushMessage()` - 發送報告訊息
  - **DL模組** `DL_log()` - 記錄報告發送
- **回傳值**: `{success: boolean, reportId: string, deliveryTimestamp: timestamp}`

```javascript
/**
 * 14. 處理Quick Reply統計
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 處理Quick Reply統計查詢請求
 */
function SR_processQuickReplyStatistics(userId, statisticType, queryParams)
```
- **功能**: 快速統計查詢處理，支援今日、本週、本月統計
- **與其他模組互動**:
  - **FS模組** `FS_queryUserData()` - 查詢使用者資料
  - **DD模組** `DD_processDataQuery()` - 處理資料查詢
  - **WH模組** `WH_sendQuickReply()` - 發送Quick Reply回應
  - **DL模組** `DL_info()` - 記錄統計查詢
- **回傳值**: `{success: boolean, statisticData: object, quickReplyOptions: array}`

### 2.4 數據整合層函數

```javascript
/**
 * 15. 與AM模組同步
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 與帳號管理模組同步使用者資訊和權限
 */
function SR_syncWithAccountModule(userId, syncType, syncData)
```
- **功能**: 確保使用者資訊和權限的一致性同步
- **與其他模組互動**:
  - **AM模組** `AM_getUserInfo()` - 取得最新使用者資訊
  - **FS模組** `FS_updateDocument()` - 更新本地快取資訊
  - **DL模組** `DL_info()` - 記錄同步狀態
- **回傳值**: `{success: boolean, syncedFields: array, conflictResolved: boolean}`

```javascript
/**
 * 16. 與DD模組同步
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 與資料分發模組同步排程相關資料
 */
function SR_syncWithDataDistribution(userId, distributionData, targetModules)
```
- **功能**: 跨模組資料分發和同步機制
- **與其他模組互動**:
  - **DD模組** `DD_distributeData()` - 分發排程資料
  - **FS模組** `FS_batchUpdate()` - 批次更新資料
  - **DL模組** `DL_log()` - 記錄分發結果
- **回傳值**: `{success: boolean, distributedModules: array, syncTimestamp: timestamp}`

```javascript
/**
 * 17. 記錄排程活動
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 記錄排程相關的所有活動和操作
 */
function SR_logScheduledActivity(userId, activityType, activityData, result)
```
- **功能**: 標準化的排程活動日誌記錄
- **與其他模組互動**:
  - **DL模組** `DL_log()` - 記錄一般活動
  - **DL模組** `DL_error()` - 記錄錯誤活動
  - **FS模組** `FS_createDocument()` - 建立活動記錄
- **回傳值**: `{success: boolean, logId: string, logLevel: string}`

```javascript
/**
 * 18. 處理排程器錯誤
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 15:30:00
 * @description 統一處理排程器運行過程中的各種錯誤
 */
function SR_handleSchedulerError(errorType, errorData, context, retryCount)
```
- **功能**: 標準化錯誤處理與自動重試機制
- **與其他模組互動**:
  - **DL模組** `DL_error()` - 詳細錯誤日誌記錄
  - **WH模組** `WH_sendErrorNotification()` - 發送錯誤通知
  - **SR模組** `SR_scheduleRetry()` - 安排重試執行
- **回傳值**: `{handled: boolean, errorCode: string, retryScheduled: boolean}`

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
SR 排程提醒模組
├── FS模組 (Firestore Service)
│   ├── FS_createDocument() - 建立排程設定
│   ├── FS_updateDocument() - 更新排程設定
│   ├── FS_deleteDocument() - 刪除排程設定
│   ├── FS_getDocument() - 取得排程設定
│   ├── FS_queryUserData() - 查詢使用者資料
│   └── FS_batchUpdate() - 批次更新資料
├── WH模組 (Webhook處理)
│   ├── WH_sendPushMessage() - 發送推播訊息
│   ├── WH_sendQuickReply() - 發送Quick Reply回應
│   ├── WH_sendUpgradePrompt() - 發送升級提示
│   └── WH_sendErrorNotification() - 發送錯誤通知
├── AM模組 (Account Management)
│   ├── AM_validateUserType() - 驗證使用者類型
│   ├── AM_getUserInfo() - 取得使用者資訊
│   ├── AM_checkSubscriptionStatus() - 檢查訂閱狀態
│   ├── AM_validatePremiumFeature() - 驗證付費功能
│   └── AM_updateAccountInfo() - 更新帳號資訊
├── DD模組 (Data Distribution)
│   ├── DD_distributeData() - 分發資料
│   ├── DD_processDataQuery() - 處理資料查詢
│   └── 跨模組資料同步協調
├── DL模組 (Data Logging)
│   ├── DL_log() - 一般操作日誌
│   ├── DL_error() - 錯誤日誌
│   ├── DL_warning() - 警告日誌
│   └── DL_info() - 資訊日誌
├── BK模組 (Bookkeeping)
│   ├── BK_processAutoBookkeeping() - 處理自動記帳
│   └── 自動記帳數據處理
├── BM模組 (Budget Management)
│   ├── BM_getBudgetStatus() - 取得預算狀態
│   └── 預算監控支援
├── MRA模組 (Multi-platform Report & Analytics)
│   ├── MRA_generateFinancialSummary() - 生成財務摘要
│   ├── MRA_generateMonthlyReport() - 生成月度報告
│   ├── MRA_analyzeUserBehavior() - 分析使用者行為
│   └── 財務報告生成支援
└── Node-cron
    ├── 排程任務調度
    └── 時間觸發器管理
```

### 3.2 資料流向設計
```
排程觸發 → SR排程驗證 → 付費功能檢查 → 條件判斷 → 
執行動作 → 結果處理 → 跨模組同步 → 日誌記錄 → 完成回應
```

---

## 4.0 資料庫架構設計

### 4.1 FS模組集合結構需求
```
scheduled_reminders/ (透過FS模組管理)
├── {reminder_id}/
│   ├── userId: string (索引)
│   ├── reminderType: "daily" | "weekly" | "monthly" | "custom"
│   ├── cronExpression: string
│   ├── timezone: "Asia/Taipei"
│   ├── isActive: boolean
│   ├── reminderData: object
│   │   ├── subjectCode: string
│   │   ├── amount: number
│   │   ├── paymentMethod: string
│   │   └── message: string
│   ├── conditions: object
│   │   ├── skipWeekends: boolean
│   │   ├── holidayHandling: "skip" | "advance" | "delay"
│   │   └── customConditions: array
│   ├── execution: object
│   │   ├── lastExecuted: timestamp (UTC+8)
│   │   ├── nextExecution: timestamp (UTC+8)
│   │   ├── executionCount: number
│   │   └── failureCount: number
│   ├── createdAt: timestamp (UTC+8)
│   ├── updatedAt: timestamp (UTC+8)
│   └── metadata: object

user_quotas/ (透過FS模組管理)
├── {user_id}/
│   ├── reminderQuota: number
│   ├── usedReminders: number
│   ├── subscriptionLevel: "free" | "premium"
│   ├── lastQuotaReset: timestamp (UTC+8)
│   └── quotaHistory: array

holiday_calendar/ (透過FS模組管理)
├── {year}/
│   ├── holidays: array
│   │   ├── date: string (YYYY-MM-DD)
│   │   ├── name: string
│   │   └── type: "national" | "religious" | "custom"
│   ├── updatedAt: timestamp (UTC+8)
│   └── source: string

scheduler_logs/ (透過FS模組管理)
├── {log_id}/
│   ├── userId: string
│   ├── reminderId: string
│   ├── activityType: string
│   ├── activityData: object
│   ├── result: object
│   ├── timestamp: timestamp (UTC+8)
│   └── logLevel: "info" | "warning" | "error"
```

### 4.2 付費功能權限設計
```javascript
premiumFeatures: {
  dailyFinancialSummary: {
    level: "premium",
    quotaLimited: false,
    description: "每日財務摘要推播"
  },
  budgetWarning: {
    level: "premium", 
    quotaLimited: false,
    description: "預算警告通知"
  },
  monthlyReport: {
    level: "premium",
    quotaLimited: false,
    description: "月度財務報告"
  },
  smartTimeOptimization: {
    level: "premium",
    quotaLimited: false,
    description: "智慧時間最佳化"
  },
  unlimitedReminders: {
    level: "premium",
    quotaLimited: false,
    description: "無限制提醒設定"
  }
}

freeFeatures: {
  basicReminder: {
    level: "free",
    quotaLimited: true,
    maxCount: 2,
    description: "基礎提醒設定"
  },
  quickReplyStatistics: {
    level: "free",
    quotaLimited: false,
    description: "Quick Reply統計查詢"
  },
  manualStatistics: {
    level: "free",
    quotaLimited: false,
    description: "手動統計查詢"
  }
}
```

---

## 5.0 API 介面規格

### 5.1 REST API 端點
```
POST   /api/v2/scheduler/reminder/create      - 建立排程提醒
PUT    /api/v2/scheduler/reminder/{id}/update - 更新排程設定
DELETE /api/v2/scheduler/reminder/{id}/delete - 刪除排程提醒
GET    /api/v2/scheduler/reminder/{id}        - 查詢排程設定
GET    /api/v2/scheduler/reminders/user/{uid} - 查詢使用者排程清單
POST   /api/v2/scheduler/execute/{id}         - 手動執行排程
GET    /api/v2/scheduler/statistics/quick     - Quick Reply統計
POST   /api/v2/scheduler/push/daily           - 每日推播設定
POST   /api/v2/scheduler/push/budget          - 預算警告設定
POST   /api/v2/scheduler/push/monthly         - 月度報告設定
GET    /api/v2/scheduler/quota/user/{uid}     - 查詢使用者配額
GET    /api/v2/scheduler/health               - 排程器健康檢查
```

### 5.2 Cron 表達式設計
```javascript
cronExpressions: {
  daily: "0 21 * * *",           // 每日21:00
  weekly: "0 21 * * 0",          // 每週日21:00
  monthly: "0 21 1 * *",         // 每月1日21:00
  custom: "0 {hour} {day} {month} {weekday}" // 自訂時間
}

timezoneHandling: {
  default: "Asia/Taipei",
  format: "UTC+8",
  holidayCheck: true,
  weekendCheck: true
}
```

---

## 6.0 排程引擎設計

### 6.1 排程任務管理
```javascript
const cron = require('node-cron');

// 主要排程任務
const schedulerTasks = {
  // 每分鐘檢查到期的排程
  minutelyCheck: cron.schedule('* * * * *', () => {
    SR_checkPendingReminders();
  }),
  
  // 每日21:00執行付費用戶推播
  dailyPush: cron.schedule('0 21 * * *', () => {
    SR_processDailyPushNotifications();
  }),
  
  // 每週日21:00執行週報
  weeklyReport: cron.schedule('0 21 * * 0', () => {
    SR_processWeeklyReports();
  }),
  
  // 每月1日21:00執行月報
  monthlyReport: cron.schedule('0 21 1 * *', () => {
    SR_processMonthlyReports();
  }),
  
  // 每日凌晨2:00清理過期資料
  dailyCleanup: cron.schedule('0 2 * * *', () => {
    SR_cleanupExpiredData();
  })
};
```

### 6.2 時區和假日處理
```javascript
const moment = require('moment-timezone');

// 時區轉換
function convertToUserTimezone(timestamp, timezone = 'Asia/Taipei') {
  return moment(timestamp).tz(timezone);
}

// 假日檢查
function isHoliday(date) {
  // 透過FS模組查詢假日資料
  return FS_checkHolidayCalendar(date);
}

// 週末檢查
function isWeekend(date) {
  const dayOfWeek = moment(date).day();
  return dayOfWeek === 0 || dayOfWeek === 6; // 0=週日, 6=週六
}
```

---

## 7.0 付費功能控制機制

### 7.1 功能權限驗證流程
```javascript
async function validateFeatureAccess(userId, featureName) {
  // 1. 取得使用者資訊
  const userInfo = await AM_getUserInfo(userId);
  
  // 2. 檢查訂閱狀態
  const subscription = await AM_checkSubscriptionStatus(userId);
  
  // 3. 驗證功能權限
  const hasPermission = subscription.level === 'premium' || 
                       freeFeatures[featureName];
  
  // 4. 檢查配額限制
  if (hasPermission && freeFeatures[featureName]?.quotaLimited) {
    const quota = await FS_getUserQuota(userId);
    hasPermission = quota.usedReminders < freeFeatures[featureName].maxCount;
  }
  
  return {
    hasPermission,
    subscriptionLevel: subscription.level,
    quotaExceeded: !hasPermission && freeFeatures[featureName]?.quotaLimited
  };
}
```

### 7.2 功能降級處理
```javascript
async function handleFeatureDowngrade(userId, expiredFeatures) {
  // 1. 停用付費功能
  await SR_disablePremiumFeatures(userId, expiredFeatures);
  
  // 2. 調整排程設定
  await SR_adjustSchedulesForFreeUser(userId);
  
  // 3. 發送降級通知
  await WH_sendFeatureDowngradeNotification(userId, expiredFeatures);
  
  // 4. 記錄降級操作
  await DL_log(`功能降級執行完成`, 'FEATURE_DOWNGRADE', userId);
}
```

---

## 8.0 錯誤處理與監控

### 8.1 錯誤類型定義
```javascript
const ErrorTypes = {
  SCHEDULER_TIMEOUT: 'scheduler_timeout',
  PERMISSION_DENIED: 'permission_denied',
  QUOTA_EXCEEDED: 'quota_exceeded',
  EXTERNAL_API_ERROR: 'external_api_error',
  DATABASE_ERROR: 'database_error',
  VALIDATION_ERROR: 'validation_error',
  HOLIDAY_PROCESSING_ERROR: 'holiday_processing_error'
};
```

### 8.2 重試機制設計
```javascript
async function executeWithRetry(operation, maxRetries = 3, delay = 1000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      if (attempt === maxRetries) {
        throw error;
      }
      
      await new Promise(resolve => setTimeout(resolve, delay * attempt));
      await DL_warning(`重試第 ${attempt} 次: ${error.message}`);
    }
  }
}
```

### 8.3 健康監控機制
```javascript
async function SR_monitorSystemHealth() {
  const healthMetrics = {
    activeReminders: await FS_countActiveReminders(),
    pendingExecutions: await FS_countPendingExecutions(),
    failedExecutions: await FS_countFailedExecutions(),
    systemUptime: process.uptime(),
    memoryUsage: process.memoryUsage(),
    cronJobsStatus: getCronJobsStatus()
  };
  
  // 檢查健康狀態
  const isHealthy = healthMetrics.failedExecutions < 10 && 
                   healthMetrics.memoryUsage.heapUsed < 500 * 1024 * 1024;
  
  if (!isHealthy) {
    await DL_error('排程系統健康狀態異常', 'SYSTEM_HEALTH_ALERT', 'SYSTEM');
  }
  
  return { healthy: isHealthy, metrics: healthMetrics };
}
```

---

## 9.0 效能最佳化

### 9.1 快取策略
```javascript
const NodeCache = require('node-cache');

const cacheConfig = {
  userPermissions: new NodeCache({ stdTTL: 600 }), // 10分鐘
  holidayCalendar: new NodeCache({ stdTTL: 86400 }), // 24小時
  userQuotas: new NodeCache({ stdTTL: 300 }), // 5分鐘
  schedulerStatus: new NodeCache({ stdTTL: 60 }) // 1分鐘
};
```

### 9.2 批次處理優化
```javascript
async function processBatchReminders(reminders) {
  const batchSize = 50;
  const batches = [];
  
  for (let i = 0; i < reminders.length; i += batchSize) {
    batches.push(reminders.slice(i, i + batchSize));
  }
  
  for (const batch of batches) {
    await Promise.all(batch.map(reminder => 
      SR_executeScheduledTask(reminder.id, reminder.context)
    ));
    
    // 批次間延遲，避免系統過載
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}
```

---

## 10.0 測試策略

### 10.1 單元測試覆蓋
- SR_createScheduledReminder() 測試
- SR_executeScheduledTask() 測試  
- SR_validatePremiumFeature() 測試
- SR_processHolidayLogic() 測試
- 錯誤處理機制測試

### 10.2 整合測試場景
- 模組間互動測試
- 付費功能權限驗證測試
- 排程執行準確性測試
- 資料庫一致性測試

### 10.3 效能測試指標
- 排程執行延遲 < 30秒
- 並發處理能力 > 1000個排程
- 記憶體使用率 < 80%
- 錯誤率 < 1%

---

## 11.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-01-09 15:30:00 +08:00 | LCAS SA Team | 初版建立，完整技術設計，基於PRD 1005需求，整合模組間協作架構 |

---

**文件結束**
*此文件為 LCAS 2.0 SR 排程提醒模組的完整技術設計規格，所有函數設計均基於 PRD 需求並遵循模組間協作原則。*
