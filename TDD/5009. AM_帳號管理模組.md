
# 5009. TDD_AM_帳號管理模組_v1.0

## 文件資訊
- **文件標題**: AM 帳號管理模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-01-09 00:34:00 +08:00 (台灣時間)
- **創建者**: AustinLiao69
- **對應需求文件**: 1009. AM_帳號管理模組.md
- **模組代碼**: AM (Account Management)

---

## 1.0 技術架構概述

### 1.1 模組定位
AM 帳號管理模組作為 LCAS 2.0 的核心基礎模組，負責統一管理 LINE OA 端和 APP 端的使用者帳號，實現跨平台帳號整合與資料同步，是整個系統的身份識別與權限管理基石。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **資料庫**: Firestore
- **身份驗證**: LINE Login OAuth 2.0
- **日誌系統**: DL 模組
- **資料同步**: DD 資料分發模組
- **跨平台支援**: iOS/Android SDK 整合

### 1.3 模組架構
```javascript
/**
 * AM_帳號管理模組_1.0.0
 * @module AM模組 
 * @description 跨平台帳號管理系統 - 支援LINE OA、iOS、Android統一帳號管理
 * @update 2025-01-09: 初版建立，實現跨平台帳號整合與資料同步
 */
```

---

## 2.0 核心函數設計

### 2.1 帳號創建與註冊函數

```javascript
/**
 * 01. 創建LINE OA用戶帳號
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 透過LINE OAuth創建用戶帳號並建立基礎資料結構
 */
function AM_createLineAccount(lineUID, lineProfile, userType)
```
- **功能**: 建立LINE用戶帳號，自動產生統一UID
- **與其他模組互動**:
  - `DL_log()` - 記錄帳號創建日誌
  - Firestore - 建立 users collection 文件
  - **DD模組** `DD_distributeData()` - 分發新用戶資料
- **回傳值**: `{success: boolean, UID: string, accountId: string}`

```javascript
/**
 * 02. 創建APP端用戶帳號
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 為iOS/Android平台創建用戶帳號
 */
function AM_createAppAccount(platform, appProfile, deviceInfo)
```
- **功能**: 建立APP端帳號，支援iOS_UID和Android_UID
- **與其他模組互動**:
  - `AM_generatePlatformUID()` - 產生平台專屬UID
  - **DD模組** - 同步帳號資料到其他平台
- **回傳值**: `{success: boolean, platformUID: string, primaryUID: string}`

```javascript
/**
 * 03. 跨平台帳號關聯
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 將LINE、iOS、Android帳號進行關聯綁定
 */
function AM_linkCrossPlatformAccounts(primaryUID, linkedAccountInfo)
```
- **功能**: 實現跨平台帳號數據串接與同步
- **與其他模組互動**:
  - `AM_validateAccountMapping()` - 驗證帳號關聯合法性
  - Firestore - 更新 account_mappings collection
  - `DL_info()` - 記錄關聯操作
- **回傳值**: `{success: boolean, linkedAccounts: object, mappingId: string}`

### 2.2 帳號管理與修改函數

```javascript
/**
 * 04. 更新帳號資訊
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 修改使用者帳號基本資訊和設定
 */
function AM_updateAccountInfo(UID, updateData, operatorId)
```
- **功能**: 安全更新帳號資訊，支援跨平台同步
- **與其他模組互動**:
  - `AM_validateUpdatePermission()` - 驗證更新權限
  - **DD模組** - 同步更新到所有關聯平台
  - `DL_log()` - 記錄更新操作
- **回傳值**: `{success: boolean, updatedFields: array, syncStatus: object}`

```javascript
/**
 * 05. 修改用戶類型
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 變更用戶類型 (M/S/J) 和相關權限
 */
function AM_changeUserType(UID, newUserType, operatorId, reason)
```
- **功能**: 動態調整用戶類型與權限等級
- **與其他模組互動**:
  - **MLS模組** - 同步更新帳本權限
  - **CM模組** - 更新協作權限設定
  - `DL_warning()` - 記錄類型變更日誌
- **回傳值**: `{success: boolean, oldType: string, newType: string, affectedLedgers: array}`

```javascript
/**
 * 06. 註銷用戶帳號
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 安全註銷帳號並處理相關數據清理
 */
function AM_deactivateAccount(UID, deactivationReason, transferData)
```
- **功能**: 完整的帳號註銷流程，包含數據遷移
- **與其他模組互動**:
  - **BS模組** - 建立註銷前完整備份
  - **MLS模組** - 處理帳本擁有權轉移
  - `DL_error()` - 記錄註銷操作詳情
- **回傳值**: `{success: boolean, backupId: string, transferredLedgers: array}`

### 2.3 帳號查詢與驗證函數

```javascript
/**
 * 07. 查詢用戶帳號資訊
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 安全查詢用戶基本資訊和跨平台關聯
 */
function AM_getUserInfo(UID, requesterId, includeLinkedAccounts)
```
- **功能**: 完整的用戶資訊查詢，支援權限過濾
- **與其他模組互動**:
  - `AM_validateQueryPermission()` - 驗證查詢權限
  - **MLS模組** - 取得用戶帳本清單
- **回傳值**: `{success: boolean, userData: object, linkedAccounts: object}`

```javascript
/**
 * 08. 驗證帳號存在性
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 快速驗證帳號是否存在且有效
 */
function AM_validateAccountExists(identifier, platform)
```
- **功能**: 高效的帳號存在性檢查機制
- **與其他模組互動**:
  - Firestore - 查詢用戶 collection
  - `DL_info()` - 記錄驗證嘗試
- **回傳值**: `{exists: boolean, UID: string, accountStatus: string}`

```javascript
/**
 * 09. 搜尋用戶帳號
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 支援模糊搜尋和多條件篩選的帳號搜尋
 */
function AM_searchUserAccounts(searchCriteria, requesterId, filterOptions)
```
- **功能**: 智慧帳號搜尋，支援權限控制
- **與其他模組互動**:
  - `AM_validateSearchPermission()` - 驗證搜尋權限
  - **DD模組** - 分發搜尋結果
- **回傳值**: `{success: boolean, results: array, totalCount: number}`

### 2.4 LINE OAuth 整合函數

```javascript
/**
 * 10. 處理LINE OAuth授權
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 處理LINE Login OAuth流程和Token管理
 */
function AM_handleLineOAuth(authCode, state, redirectUri)
```
- **功能**: 完整的LINE OAuth授權處理流程
- **與其他模組互動**:
  - LINE API - OAuth Token 交換
  - `AM_storeTokenSecurely()` - 安全儲存授權Token
  - `DL_log()` - 記錄授權過程
- **回傳值**: `{success: boolean, accessToken: string, refreshToken: string, userProfile: object}`

```javascript
/**
 * 11. 刷新LINE Access Token
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 自動刷新過期的LINE Access Token
 */
function AM_refreshLineToken(UID, refreshToken)
```
- **功能**: Token自動刷新機制，確保服務持續性
- **與其他模組互動**:
  - LINE API - Token 刷新請求
  - `AM_updateStoredToken()` - 更新儲存的Token
- **回傳值**: `{success: boolean, newAccessToken: string, expiresIn: number}`

```javascript
/**
 * 12. 驗證LINE用戶身份
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 透過LINE API驗證用戶身份和權限
 */
function AM_verifyLineIdentity(accessToken, expectedUID)
```
- **功能**: 安全的身份驗證機制，防止身份偽造
- **與其他模組互動**:
  - LINE API - 用戶資訊驗證
  - `DL_warning()` - 記錄驗證失敗嘗試
- **回傳值**: `{verified: boolean, userProfile: object, riskScore: number}`

### 2.5 跨平台資料同步函數

```javascript
/**
 * 13. 同步跨平台用戶資料
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 在LINE、iOS、Android平台間同步用戶資料
 */
function AM_syncCrossPlatformData(UID, syncOptions, targetPlatforms)
```
- **功能**: 智慧跨平台資料同步，支援增量更新
- **與其他模組互動**:
  - **DD模組** `DD_distributeData()` - 分發同步資料
  - `AM_resolveDataConflict()` - 處理資料衝突
  - `DL_info()` - 記錄同步狀態
- **回傳值**: `{success: boolean, syncedPlatforms: array, conflicts: array}`

```javascript
/**
 * 14. 處理平台資料衝突
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 偵測並解決跨平台資料不一致問題
 */
function AM_resolveDataConflict(conflictData, resolutionStrategy)
```
- **功能**: 智慧衝突解決機制，支援多種合併策略
- **與其他模組互動**:
  - **BS模組** - 建立衝突前資料備份
  - `DL_warning()` - 記錄衝突解決過程
- **回傳值**: `{resolved: boolean, finalData: object, appliedStrategy: string}`

### 2.6 錯誤處理與監控函數

```javascript
/**
 * 15. 處理帳號操作錯誤
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 統一處理帳號管理過程中的各種錯誤
 */
function AM_handleAccountError(errorType, errorData, context, retryCount)
```
- **功能**: 標準化錯誤處理與自動重試機制
- **與其他模組互動**:
  - `DL_error()` - 詳細錯誤日誌記錄
  - **LINE OA模組** - 發送錯誤通知
  - `AM_triggerErrorRecovery()` - 啟動錯誤恢復流程
- **回傳值**: `{handled: boolean, errorCode: string, retryScheduled: boolean}`

```javascript
/**
 * 16. 監控帳號系統健康狀態
 * @version 2025-01-09-V1.0.0
 * @date 2025-01-09 00:34:00
 * @description 即時監控帳號管理系統的運行狀態
 */
function AM_monitorSystemHealth()
```
- **功能**: 系統健康狀態監控與預警機制
- **與其他模組互動**:
  - Firestore - 檢查資料庫連線狀態
  - LINE API - 檢查API服務狀態
  - **MRA模組** - 生成系統健康報表
- **回傳值**: `{healthy: boolean, activeUsers: number, apiStatus: object, performance: object}`

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
AM 帳號管理模組
├── LINE API Integration
│   ├── OAuth 2.0 認證流程
│   ├── User Profile API
│   └── Token Management
├── DL模組 (Data Logging)
│   ├── DL_log() - 一般操作日誌
│   ├── DL_error() - 錯誤日誌
│   ├── DL_warning() - 警告日誌
│   └── DL_info() - 資訊日誌
├── DD模組 (Data Distribution)
│   ├── DD_distributeData() - 跨平台資料分發
│   └── 資料同步協調
├── MLS模組 (Multi-Ledger System)
│   ├── 帳本權限同步
│   └── 用戶帳本清單管理
├── CM模組 (Collaboration Management)
│   ├── 協作權限管理
│   └── 成員身份驗證
├── BS模組 (Backup Service)
│   ├── 帳號資料備份
│   └── 註銷前資料保存
├── MRA模組 (Multi-platform Report & Analytics)
│   ├── 用戶行為分析
│   └── 系統健康報表
└── Firestore Database
    ├── users Collection - 主要用戶資料
    ├── account_mappings Collection - 跨平台關聯
    └── auth_tokens Collection - 認證Token儲存
```

### 3.2 資料流向設計
```
用戶操作請求 → AM身份驗證 → 權限檢查 → 資料操作 → 
跨平台同步 → DD資料分發 → DL日誌記錄 → 回應用戶
```

---

## 4.0 資料庫架構設計

### 4.1 Firestore 集合結構
```
users/
├── {UID}/
│   ├── displayName: string
│   ├── userType: "M" | "S" | "J"
│   ├── createdAt: timestamp (UTC+8)
│   ├── lastActive: timestamp (UTC+8)
│   ├── timezone: "Asia/Taipei"
│   ├── linkedAccounts: object
│   │   ├── LINE_UID: string
│   │   ├── iOS_UID: string
│   │   └── Android_UID: string
│   ├── settings: object
│   │   ├── notifications: boolean
│   │   └── language: "zh-TW"
│   ├── joined_ledgers: array
│   └── metadata: object

account_mappings/
├── {mapping_id}/
│   ├── primary_UID: string
│   ├── platform_accounts: object
│   │   ├── LINE: string
│   │   ├── iOS: string
│   │   └── Android: string
│   ├── created_at: timestamp (UTC+8)
│   ├── updated_at: timestamp (UTC+8)
│   └── status: "active" | "suspended" | "deactivated"

auth_tokens/
├── {UID}/
│   ├── line_access_token: string (encrypted)
│   ├── line_refresh_token: string (encrypted)
│   ├── token_expires_at: timestamp (UTC+8)
│   ├── last_refresh: timestamp (UTC+8)
│   └── token_scope: array
```

### 4.2 用戶類型權限設計
```javascript
userTypePermissions: {
  M: { // Merged ledger admin
    level: 3,
    actions: ["create_multiple_ledgers", "merge_data", "admin_functions", "invite_users"],
    max_ledgers: -1 // unlimited
  },
  S: { // Single ledger
    level: 2,
    actions: ["create_single_ledger", "manage_own_data", "basic_reports"],
    max_ledgers: 1
  },
  J: { // Join other ledger
    level: 1,
    actions: ["join_ledgers", "view_data", "basic_input"],
    max_ledgers: 0 // can only join, not create
  }
}
```

---

## 5.0 API 介面規格

### 5.1 REST API 端點
```
POST   /api/v2/accounts/create           - 建立新帳號
PUT    /api/v2/accounts/{uid}/update     - 更新帳號資訊
DELETE /api/v2/accounts/{uid}/delete     - 註銷帳號
GET    /api/v2/accounts/{uid}            - 查詢帳號資訊
POST   /api/v2/accounts/link             - 跨平台帳號關聯
DELETE /api/v2/accounts/unlink           - 解除帳號關聯
GET    /api/v2/accounts/search           - 帳號搜尋
POST   /api/v2/auth/line/oauth           - LINE OAuth授權
POST   /api/v2/auth/line/refresh         - 刷新LINE Token
POST   /api/v2/auth/verify               - 驗證身份
POST   /api/v2/accounts/sync             - 跨平台資料同步
GET    /api/v2/accounts/health           - 系統健康檢查
```

### 5.2 WebSocket 事件
```javascript
// 即時帳號事件
'account:created'        - 帳號建立
'account:updated'        - 帳號更新
'account:linked'         - 跨平台關聯
'account:deactivated'    - 帳號停用
'auth:token_refreshed'   - Token刷新
'sync:data_updated'      - 資料同步完成
'error:auth_failed'      - 認證失敗
'system:health_alert'    - 系統健康警示
```

---

## 6.0 安全性設計

### 6.1 身份認證安全
- LINE OAuth 2.0 標準流程
- Token 加密儲存機制
- 自動Token刷新與過期處理
- 多重身份驗證支援

### 6.2 資料保護措施
- 敏感資料加密儲存
- 跨平台資料傳輸加密
- 帳號操作審計日誌
- 權限分級存取控制

### 6.3 錯誤處理安全
- 不洩露敏感資訊的錯誤訊息
- 失敗嘗試限制與監控
- 異常行為自動告警機制

---

## 7.0 效能與擴展性考量

### 7.1 快取策略
- 用戶基本資訊快取 (15分鐘)
- 跨平台關聯快取 (30分鐘)
- 權限資訊快取 (10分鐘)
- Token狀態快取 (5分鐘)

### 7.2 批次處理優化
- 大量帳號操作批次處理
- 跨平台同步分批執行
- Token刷新批次排程
- 資料衝突批次解決

### 7.3 平台擴展性
- 新平台整合框架設計
- 統一UID生成機制
- 可配置的平台特性支援
- 動態權限擴展能力

---

## 8.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-01-09 00:34:00 +08:00 | AustinLiao69 | 初版建立，完整技術設計，符合LCAS 2.0架構 |

---

**文件結束**
*此文件為 LCAS 2.0 AM 帳號管理模組的完整技術設計規格，所有函數設計均基於 PRD 需求並整合跨平台統一管理架構。*
