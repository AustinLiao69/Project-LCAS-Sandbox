# 5011. TDD_MLS_多帳本模組_v1.0

## 文件資訊
- **文件標題**: MLS 多帳本管理模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-07-07 14:12:13 +08:00 (台灣時間)
- **創建者**: AustinLiao69
- **對應需求文件**: 1011. MLS_多帳本管理模組.md
- **模組代碼**: MLS (Multi-Ledger System)

---

## 1.0 技術架構概述

### 1.1 模組定位
MLS 多帳本管理模組作為 LCAS 2.0 的核心支柱模組，負責管理不同類型的帳本（專案、分類、共享），提供完整的帳本生命週期管理功能。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **資料庫**: Firestore
- **日誌系統**: DL 模組
- **權限管理**: 協作管理模組
- **資料同步**: DD 資料分發模組

### 1.3 模組架構
```javascript
/**
 * MLS_多帳本管理模組_1.0.0
 * @module MLS模組 
 * @description 多帳本管理系統 - 支援專案、分類、共享帳本的建立與管理
 * @update 2025-07-07: 初版建立，實現多帳本類型支援與權限管理
 */
```

---

## 2.0 核心函數設計

### 2.1 帳本類型管理函數

#### 2.1.1 專案帳本管理
```javascript
/**
 * 01. 建立專案帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 針對特定專案/事件建立專案帳本
 */
function MLS_createProjectLedger(userId, projectName, projectDescription, startDate, endDate, budget)
```
- **功能**: 建立專案導向的帳本，支援時間範圍和預算設定
- **與其他模組互動**:
  - `DL_log()` - 記錄建立操作日誌
  - Firestore - 建立 ledgers collection 文件
  - **預算管理模組** `budgetManager.js` - 設定專案預算
- **回傳值**: `{success: boolean, ledgerId: string, message: string}`

```javascript
/**
 * 02. 建立分類帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 依用途/主題（如旅遊、餐飲）建立分類帳本
 */
function MLS_createCategoryLedger(userId, categoryName, categoryType, tags, defaultSubjects)
```
- **功能**: 建立主題分類帳本，支援標籤和預設科目
- **與其他模組互動**:
  - `DD_distributeData()` - 進行資料分發
  - **MRA模組** `reportTemplates.js` - 設定分類報表模板
- **回傳值**: `{success: boolean, ledgerId: string, categoryId: string}`

```javascript
/**
 * 03. 建立共享帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 支援多用戶協作的共享帳本
 */
function MLS_createSharedLedger(ownerId, ledgerName, memberList, permissionSettings)
```
- **功能**: 建立多人協作帳本，支援權限分級
- **與其他模組互動**:
  - **協作管理模組** `permissionController.js` - 設定成員權限
  - `syncService.js` - 啟動即時同步服務
- **回傳值**: `{success: boolean, ledgerId: string, memberCount: number}`

### 2.2 帳本基本操作函數

```javascript
/**
 * 04. 編輯帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 修改帳本基本資訊、屬性設定
 */
function MLS_editLedger(ledgerId, userId, updateData, permission)
```
- **功能**: 安全編輯帳本資訊，含權限驗證
- **與其他模組互動**:
  - `BK_processBookkeeping()` - 更新相關記帳資料
  - **協作管理模組** - 驗證編輯權限

```javascript
/**
 * 05. 刪除帳本（含二次確認）
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 安全刪除帳本，防止誤刪
 */
function MLS_deleteLedger(ledgerId, userId, confirmationToken)
```
- **功能**: 二次確認刪除機制，確保資料安全
- **與其他模組互動**:
  - **備份服務模組** `backupManager.js` - 建立刪除前備份
  - `DL_error()` - 記錄刪除操作日誌

```javascript
/**
 * 06. 歸檔帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 將不常用的帳本進行歸檔
 */
function MLS_archiveLedger(ledgerId, userId, archiveOptions)
```
- **功能**: 帳本歸檔管理，釋放活躍空間
- **與其他模組互動**:
  - **備份服務模組** - 進行資料歸檔
  - **MRA模組** - 生成歸檔前的最終報表

### 2.3 權限與成員管理函數

```javascript
/**
 * 07. 設定帳本權限
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 設定帳本擁有者、管理員、一般成員、僅檢視者
 */
function MLS_setLedgerPermissions(ledgerId, userId, memberPermissions)
```
- **功能**: 完整的帳本權限管理系統
- **與其他模組互動**:
  - **協作管理模組** `permissionController.js` - 核心權限控制
  - `syncService.js` - 同步權限變更

```javascript
/**
 * 08. 邀請協作成員
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 邀請新成員加入共享帳本
 */
function MLS_inviteMember(ledgerId, inviterId, inviteeInfo, permissionLevel)
```
- **功能**: 成員邀請機制，支援權限預設
- **與其他模組互動**:
  - **AM模組** `userProfileManager.js` - 驗證使用者
  - **LINE OA模組** - 發送邀請通知

```javascript
/**
 * 09. 移除協作成員
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 從共享帳本移除成員
 */
function MLS_removeMember(ledgerId, removerId, targetUserId, removeReason)
```
- **功能**: 安全的成員移除機制
- **與其他模組互動**:
  - **協作管理模組** - 驗證移除權限
  - `DL_warning()` - 記錄成員移除日誌

### 2.4 帳本切換與路由函數

```javascript
/**
 * 10. 切換當前帳本
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 用戶在介面流暢切換不同帳本
 */
function MLS_switchLedger(userId, targetLedgerId, platform)
```
- **功能**: 跨平台帳本切換支援
- **與其他模組互動**:
  - `WH_formatDateTime()` - 記錄切換時間
  - **AM模組** - 更新使用者活動狀態

```javascript
/**
 * 11. 取得使用者帳本清單
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 查詢當前用戶可見的所有帳本
 */
function MLS_getLedgerList(userId, filterOptions, sortOrder)
```
- **功能**: 智慧帳本清單管理
- **與其他模組互動**:
  - **協作管理模組** - 檢查帳本可見權限
  - **MRA模組** - 提供帳本統計資訊

```javascript
/**
 * 12. 驗證帳本存取權限
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description API 支援帳本查詢、切換、權限檢查
 */
function MLS_validateLedgerAccess(userId, ledgerId, operationType)
```
- **功能**: 統一的權限驗證機制
- **與其他模組互動**:
  - **協作管理模組** - 核心權限檢查機制
  - `DL_warning()` - 記錄權限拒絕事件

### 2.5 帳本屬性與設定函數

```javascript
/**
 * 13. 設定帳本屬性
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 自訂帳本名稱、封面、標籤、分類規則
 */
function MLS_setLedgerAttributes(ledgerId, userId, attributeData)
```
- **功能**: 完整的帳本個人化設定
- **與其他模組互動**:
  - `DD_distributeData()` - 分發屬性更新
  - **備份服務模組** - 備份設定變更

```javascript
/**
 * 14. 配置帳本類型特殊設定
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 針對不同帳本類型配置專屬設定
 */
function MLS_configureLedgerType(ledgerId, ledgerType, typeSpecificConfig)
```
- **功能**: 帳本類型專屬功能配置
- **與其他模組互動**:
  - **預算管理模組** `budgetManager.js` - 配置預算規則
  - **MRA模組** - 設定報表產出規則

### 2.6 錯誤處理與監控函數

```javascript
/**
 * 15. 處理權限錯誤
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 統一處理權限不足的錯誤情況
 */
function MLS_handlePermissionError(userId, ledgerId, attemptedOperation, errorDetails)
```
- **功能**: 標準化權限錯誤處理
- **與其他模組互動**:
  - `DL_error()` - 記錄權限錯誤詳情
  - **LINE OA模組** - 發送錯誤通知

```javascript
/**
 * 16. 檢測重複帳本名稱
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:12:13
 * @description 防止用戶建立重複名稱的帳本
 */
function MLS_detectDuplicateName(userId, proposedName, ledgerType)
```
- **功能**: 帳本名稱唯一性驗證
- **與其他模組互動**:
  - Firestore - 查詢驗證名稱唯一性
  - `DL_warning()` - 記錄重複名稱嘗試

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
MLS 多帳本管理模組
├── 協作管理模組 (Collaboration)
│   ├── permissionController.js - 權限驗證與管理
│   └── syncService.js - 即時資料同步
├── 預算管理模組 (Budget Management)
│   ├── budgetManager.js - 帳本預算設定與追蹤
│   └── budgetAlertService.js - 預算警示整合
├── DL模組 (Data Logging)
│   ├── DL_log() - 一般操作日誌
│   ├── DL_error() - 錯誤日誌
│   └── DL_warning() - 警告日誌
├── BK模組 (Bookkeeping)
│   └── BK_processBookkeeping() - 記帳資料處理
├── DD模組 (Data Distribution)
│   └── DD_distributeData() - 帳本資料分發
├── MRA模組 (Multi-platform Report & Analytics)
│   ├── reportGenerator.js - 帳本報表產出
│   └── reportTemplates.js - 報表模板管理
└── 備份服務模組 (Backup Service)
    └── backupManager.js - 帳本資料備份與恢復
```

### 3.2 資料流向設計
```
使用者請求 → MLS權限驗證 → 協作模組權限檢查 → 
資料操作 → DD資料分發 → DL日誌記錄 → 回應使用者
```

---

## 4.0 資料庫架構設計

### 4.1 Firestore 集合結構
```
ledgers/
├── {ledger_id}/
│   ├── type: "project" | "category" | "shared"
│   ├── name: string
│   ├── description: string
│   ├── owner_id: string
│   ├── members: array
│   ├── permissions: object
│   ├── attributes: object
│   ├── created_at: timestamp
│   ├── updated_at: timestamp
│   ├── archived: boolean
│   └── metadata: object
```

### 4.2 權限結構設計
```javascript
permissions: {
  owner: userId,
  admins: [userId1, userId2],
  members: [userId3, userId4],
  viewers: [userId5, userId6],
  settings: {
    allow_invite: boolean,
    allow_edit: boolean,
    allow_delete: boolean
  }
}
```

---

## 5.0 API 介面規格

### 5.1 REST API 端點
```
POST   /api/v2/ledgers/create          - 建立新帳本
GET    /api/v2/ledgers/list            - 取得帳本清單
PUT    /api/v2/ledgers/{id}/edit       - 編輯帳本
DELETE /api/v2/ledgers/{id}/delete     - 刪除帳本
POST   /api/v2/ledgers/{id}/archive    - 歸檔帳本
POST   /api/v2/ledgers/{id}/copy       - 複製帳本
POST   /api/v2/ledgers/migrate         - 資料遷移
PUT    /api/v2/ledgers/{id}/switch     - 切換帳本
```

### 5.2 WebSocket 事件
```javascript
// 即時同步事件
'ledger:member_added'    - 成員加入
'ledger:permission_changed' - 權限變更
'ledger:data_updated'    - 資料更新
'ledger:archived'        - 帳本歸檔
```

---

## 6.0 效能與擴展性考量

### 6.1 快取策略
- 帳本基本資訊快取 (5分鐘)
- 權限資訊快取 (10分鐘)
- 成員清單快取 (15分鐘)

### 6.2 批次處理
- 大量帳本操作批次處理
- 資料遷移分批執行
- 權限更新批次同步

---

## 7.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-07-07 14:12:13 +08:00 | AustinLiao69 | 初版建立，完整技術設計 |

---

**文件結束**
*此文件為 LCAS 2.0 MLS 多帳本管理模組的完整技術設計規格，所有函數設計均基於 PRD 需求並整合現有系統架構。*