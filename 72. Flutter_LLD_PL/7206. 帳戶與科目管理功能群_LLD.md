# 7206. 帳戶與科目管理功能群_LLD

## 1. 文件概述

### 1.1 文件目的
為PG提供帳戶與科目管理功能群的完整編程介面規格，定義Phase 3業務邏輯函數表頭，專注於PL層實作規範。

### 1.2 適用範圍
- **功能範圍**: S-304帳戶管理、S-305科目管理、S-306餘額查詢
- **技術範圍**: Flutter Dart業務邏輯層(PL)
- **版本範圍**: Phase 3 MVP核心需求

### 1.3 文件版本
- **版本**: V1.1.0
- **建立日期**: 2025-11-17
- **更新紀錄**: 階段二功能範圍擴展，新增多個函數介面

## 2. 架構設計

### 2.1 術語對應關係

本模組採用領域驅動設計，各層級使用最適合的術語：

| 層級 | 術語 | 說明 | 對應關係 |
|------|------|------|----------|
| **PL層(業務邏輯)** | `wallet` | 錢包/帳戶容器，存放資金 | 業務語義正確 |
| **APL層(API端點)** | `accounts` | API技術規範路徑 | `/api/v1/accounts` |
| **BL層(WCM模組)** | `wallet` | 統一業務邏輯處理 | WCM_createWallet等函數 |

**轉換對應邏輯**：
```dart
// PL層業務邏輯調用
getWalletList() 
  ↓ APL.dart Gateway
  POST /api/v1/accounts 
  ↓ ASL.js轉發
  WCM_createWallet()
```

### 2.2 模組架構
```
7306. 帳戶與科目管理功能群.dart
├── WalletProvider (帳戶狀態管理)
├── CategoryProvider (科目狀態管理) 
├── BalanceProvider (餘額狀態管理)
├── DataSyncProvider (資料同步管理)
└── 工具函數
```

### 2.2 依賴關係
- **上層依賴**: UI Widget (S-304, S-305, S-306)
- **下層依賴**: APL.dart Gateway → WCM.js模組
- **平行依賴**: 其他PL功能群模組

### 2.3 資料流向
```
UI層 → PL業務邏輯 → APL.dart(Gateway) → ASL.js → BL模組(WCM.js) → Firebase
```

## 3. 資料模型定義

### 3.1 帳戶資料模型
```dart
class walletModel {
  final String walletId;
  final String walletName;
  final String walletType;
  final double balance;
  final String currency;
  final bool isActive;
  final String ledgerId;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.2 科目資料模型
```dart
class CategoryModel {
  final String categoryId;
  final String categoryName;
  final String categoryType;
  final String? parentId;
  final int level;
  final String ledgerId;
  final bool isActive;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.3 餘額資料模型
```dart
class BalanceModel {
  final String walletId;
  final double currentBalance;
  final double availableBalance;
  final String currency;
  final DateTime lastUpdated;
}
```

### 3.4 API回應模型
```dart
class ApiResponse<T> {
  final bool success;
  final T? data;
  final String? message;
  final int? errorCode;
  final DateTime timestamp;
}
```

## 4. 函數介面規格

### 4.1 帳戶管理函數

#### 4.1.1 取得帳戶清單
```dart
/**
 * 01. 取得帳戶清單
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<List<walletModel>>> getWalletList(String ledgerId, String walletType);
```

#### 4.1.2 建立新帳戶
```dart
/**
 * 02. 建立新帳戶
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<walletModel>> createWallet(String ledgerId, String walletName, String walletType, String currency);
```

#### 4.1.3 更新帳戶資訊
```dart
/**
 * 03. 更新帳戶資訊
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<walletModel>> updateWallet(String walletId, String walletName, bool isActive);
```

#### 4.1.4 刪除帳戶
```dart
/**
 * 04. 刪除帳戶
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<bool>> deleteWallet(String walletId);
```

### 4.2 科目管理函數

#### 4.2.1 取得科目樹狀結構
```dart
/**
 * 05. 取得科目樹狀結構
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<List<CategoryModel>>> getCategoryTree(String ledgerId, String categoryType);
```

#### 4.2.2 建立新科目
```dart
/**
 * 06. 建立新科目
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<CategoryModel>> createCategory(String ledgerId, String categoryName, String categoryType, String? parentId);
```

#### 4.2.3 更新科目資訊
```dart
/**
 * 07. 更新科目資訊
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<CategoryModel>> updateCategory(String categoryId, String categoryName, bool isActive);
```

#### 4.2.4 刪除科目
```dart
/**
 * 08. 刪除科目
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<bool>> deleteCategory(String categoryId);
```

### 4.3 餘額管理函數

#### 4.3.1 取得帳戶餘額
```dart
/**
 * 09. 取得帳戶餘額
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<BalanceModel>> getWalletBalance(String walletId);
```

#### 4.3.2 取得多帳戶餘額
```dart
/**
 * 10. 取得多帳戶餘額
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<List<BalanceModel>>> getMultipleWalletBalances(List<String> walletIds);
```

#### 4.3.3 計算帳本總餘額
```dart
/**
 * 11. 計算帳本總餘額
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<Map<String, double>>> calculateLedgerTotalBalance(String ledgerId);
```

### 4.4 狀態管理函數

#### 4.4.1 重新整理帳戶狀態
```dart
/**
 * 12. 重新整理帳戶狀態
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<void> refreshWalletState(String ledgerId);
```

#### 4.4.2 重新整理科目狀態
```dart
/**
 * 13. 重新整理科目狀態
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<void> refreshCategoryState(String ledgerId);
```

#### 4.4.3 同步資料狀態
```dart
/**
 * 14. 同步資料狀態
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<bool>> syncDataState(String ledgerId);
```

### 4.5 基礎驗證函數

#### 4.5.1 驗證帳戶名稱
```dart
/**
 * 15. 驗證帳戶名稱
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
bool validateWalletName(String walletName);
```

#### 4.5.2 驗證科目階層
```dart
/**
 * 16. 驗證科目階層
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
bool validateCategoryHierarchy(String parentId, String categoryType);
```

#### 4.5.3 驗證科目使用統計
```dart
/**
 * 17. 驗證科目使用統計
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
ApiResponse<Map<String, int>> getCategoryUsageStatistics(String ledgerId);
```

#### 4.5.4 驗證科目名稱唯一性
```dart
/**
 * 18. 驗證科目名稱唯一性
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
Future<ApiResponse<bool>> validateCategoryNameUniqueness(String ledgerId, String categoryName, String? excludeCategoryId);
```

#### 4.5.5 驗證帳戶餘額一致性
```dart
/**
 * 19. 驗證帳戶餘額一致性
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
Future<ApiResponse<bool>> validateWalletBalanceConsistency(String walletId);
```

### 4.6 工具函數

#### 4.6.1 格式化餘額顯示
```dart
/**
 * 20. 格式化餘額顯示
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二重新編號
 */
String formatBalanceDisplay(double balance, String currency);
```

#### 4.6.2 轉換API回應格式
```dart
/**
 * 21. 轉換API回應格式
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二重新編號
 */
ApiResponse<T> parseApiResponse<T>(Map<String, dynamic> response, T Function(Map<String, dynamic>) fromJson);
```

#### 4.6.3 生成科目代碼
```dart
/**
 * 22. 生成科目代碼
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
String generateCategoryCode(String categoryType, String parentId, int sequence);
```

#### 4.6.4 計算科目深度
```dart
/**
 * 23. 計算科目深度
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
Future<ApiResponse<int>> calculateCategoryDepth(String categoryId);
```

### 4.7 錯誤處理與重試機制

#### 4.7.1 API重試機制
```dart
/**
 * 24. API重試機制
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二重新編號
 */
Future<ApiResponse<T>> retryApiCall<T>(Future<ApiResponse<T>> Function() apiCall, int maxRetries);
```

#### 4.7.2 記錄錯誤日誌
```dart
/**
 * 25. 記錄錯誤日誌
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
Future<void> logError(String functionName, String errorType, String errorMessage, Map<String, dynamic>? context);
```

#### 4.7.3 處理網路異常
```dart
/**
 * 26. 處理網路異常
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
ApiResponse<T> handleNetworkException<T>(Exception exception);
```

#### 4.7.4 驗證API回應完整性
```dart
/**
 * 27. 驗證API回應完整性
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
bool validateApiResponseIntegrity(Map<String, dynamic> response, List<String> requiredFields);
```

### 4.8 擴展驗證函數

#### 4.8.1 驗證餘額格式
```dart
/**
 * 28. 驗證餘額格式
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二新增
 */
bool validateBalanceFormat(String balanceInput, String currency);
```

## 5. 錯誤處理策略

### 5.1 錯誤分類
- **網路錯誤**: 連線逾時、網路中斷
- **驗證錯誤**: 輸入格式不正確、必填欄位缺失
- **業務錯誤**: 帳戶不存在、科目階層衝突
- **系統錯誤**: Firebase異常、API服務異常

### 5.2 錯誤碼對應
```dart
enum ErrorCode {
  NETWORK_ERROR = 1001,
  VALIDATION_ERROR = 1002,
  BUSINESS_ERROR = 1003,
  SYSTEM_ERROR = 1004,
  UNAUTHORIZED = 1005,
  DATA_NOT_FOUND = 1006
}
```

### 5.3 錯誤處理流程
1. **捕獲異常**: try-catch包裝所有API調用
2. **錯誤分類**: 根據異常類型分配錯誤碼
3. **錯誤記錄**: 記錄錯誤詳情至DL模組
4. **用戶提示**: 返回用戶友善的錯誤訊息
5. **狀態恢復**: 確保UI狀態一致性

### 5.4 重試機制
```dart
/**
 * 29. API重試機制
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<T>> retryApiCall<T>(Future<ApiResponse<T>> Function() apiCall, int maxRetries);
```

## 6. 效能優化策略

### 6.1 資料快取
- **帳戶清單**: 記憶體快取30分鐘
- **科目樹**: 記憶體快取60分鐘
- **餘額資料**: 即時更新，快取5分鐘

### 6.2 分頁載入
```dart
/**
 * 30. 分頁載入帳戶
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<List<walletModel>>> getWalletListWithPagination(String ledgerId, int page, int pageSize);
```

### 6.3 批次處理
```dart
/**
 * 31. 批次更新帳戶狀態
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<ApiResponse<List<walletModel>>> batchUpdateWalletStatus(List<String> walletIds, bool isActive);
```

## 7. 刪除

## 8. 整合規範

### 8.1 APL Gateway整合
- 統一使用APL.dart作為API調用入口
- 遵循8088文件的API設計規範
- 標準化錯誤處理與回應格式

### 8.2 WCM模組對接
- 對接1350.WCM.js的帳戶與科目管理功能
- 確保資料結構一致性
- 維護API合約穩定性

### 8.3 狀態管理整合
- 使用Provider模式統一狀態管理
- 與其他PL模組狀態協調
- 確保資料同步一致性

## 9. 安全性規範

### 9.1 資料驗證
- 所有輸入參數進行格式驗證
- 防止SQL注入與XSS攻擊
- 敏感資料加密處理

### 9.2 存取控制
```dart
/**
 * 32. 驗證使用者權限
 * @version 2025-11-17-V1.1.0
 * @date 2025-11-17
 * @update: 階段二擴展
 */
Future<bool> validateUserPermission(String userId, String ledgerId, String operation);
```

## 10. 刪除

## 11. 函數清單

### 11.1 函數索引表
| 序號 | 函數名稱 | 分類 | 用途說明 |
|------|----------|------|----------|
| 01 | getWalletList | 帳戶管理 | 取得帳戶清單 |
| 02 | createWallet | 帳戶管理 | 建立新帳戶 |
| 03 | updateWallet | 帳戶管理 | 更新帳戶資訊 |
| 04 | deleteWallet | 帳戶管理 | 刪除帳戶 |
| 05 | getCategoryTree | 科目管理 | 取得科目樹狀結構 |
| 06 | createCategory | 科目管理 | 建立新科目 |
| 07 | updateCategory | 科目管理 | 更新科目資訊 |
| 08 | deleteCategory | 科目管理 | 刪除科目 |
| 09 | getWalletBalance | 餘額管理 | 取得帳戶餘額 |
| 10 | getMultipleWalletBalances | 餘額管理 | 取得多帳戶餘額 |
| 11 | calculateLedgerTotalBalance | 餘額管理 | 計算帳本總餘額 |
| 12 | refreshWalletState | 狀態管理 | 重新整理帳戶狀態 |
| 13 | refreshCategoryState | 狀態管理 | 重新整理科目狀態 |
| 14 | syncDataState | 狀態管理 | 同步資料狀態 |
| 15 | validateWalletName | 基礎驗證 | 驗證帳戶名稱 |
| 16 | validateCategoryHierarchy | 基礎驗證 | 驗證科目階層 |
| 17 | getCategoryUsageStatistics | 基礎驗證 | 驗證科目使用統計 |
| 18 | validateCategoryNameUniqueness | 基礎驗證 | 驗證科目名稱唯一性 |
| 19 | validateWalletBalanceConsistency | 基礎驗證 | 驗證帳戶餘額一致性 |
| 20 | formatBalanceDisplay | 工具函數 | 格式化餘額顯示 |
| 21 | parseApiResponse | 工具函數 | 轉換API回應格式 |
| 22 | generateCategoryCode | 工具函數 | 生成科目代碼 |
| 23 | calculateCategoryDepth | 工具函數 | 計算科目深度 |
| 24 | retryApiCall | 錯誤處理 | API重試機制 |
| 25 | logError | 錯誤處理 | 記錄錯誤日誌 |
| 26 | handleNetworkException | 錯誤處理 | 處理網路異常 |
| 27 | validateApiResponseIntegrity | 錯誤處理 | 驗證API回應完整性 |
| 28 | validateBalanceFormat | 擴展驗證 | 驗證餘額格式 |
| 29 | retryApiCall | 錯誤處理 | API重試機制 |
| 30 | getWalletListWithPagination | 效能優化 | 分頁載入帳戶 |
| 31 | batchUpdateWalletStatus | 效能優化 | 批次更新帳戶狀態 |
| 32 | validateUserPermission | 安全性 | 驗證使用者權限 |

### 11.2 函數分類統計
- **帳戶管理**: 4個函數 (01-04)
- **科目管理**: 4個函數 (05-08)
- **餘額管理**: 3個函數 (09-11)
- **狀態管理**: 3個函數 (12-14)
- **基礎驗證**: 5個函數 (15-19)
- **工具函數**: 4個函數 (20-23)
- **錯誤處理**: 4個函數 (24-27)
- **擴展驗證**: 1個函數 (28)
- **效能優化**: 2個函數 (30-31)
- **安全性**: 1個函數 (32)

### 11.3 核心API調用順序
```dart
// 典型的帳戶管理流程
1. validateUserPermission() → 驗證權限
2. getWalletList() → 取得現有帳戶
3. createWallet() / updateWallet() → 建立或更新帳戶
4. refreshWalletState() → 更新狀態
5. getWalletBalance() → 取得最新餘額

// 典型的科目管理流程
1. validateUserPermission() → 驗證權限
2. getCategoryTree() → 取得科目結構
3. validateCategoryHierarchy() → 驗證階層關係
4. createCategory() / updateCategory() → 建立或更新科目
5. refreshCategoryState() → 更新狀態
```

### 11.4 刪除

## 12. 附錄

### 12.1 變更歷程
| 版本 | 日期 | 變更內容 | 修改者 |
|------|------|----------|--------|
| V1.0.0 | 2025-11-17 | 初版建立 | SA |
| V1.1.0 | 2025-11-17 | 階段二功能範圍擴展，新增多個函數介面 | SA |

### 12.2 相關文件
- 7106. 帳戶與科目管理功能群_SRS.md
- 8088. API設計規範.md
- 0098. The Constitution.md
- DCN-0023. 創建WCM模組並整合帳戶與科目管理功能.md