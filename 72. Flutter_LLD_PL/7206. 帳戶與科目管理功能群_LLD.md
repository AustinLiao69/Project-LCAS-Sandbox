# 7206. 帳戶與科目管理功能群_LLD

## 1. 文件概述

### 1.1 文件目的
為PG提供帳戶與科目管理功能群的MVP階段編程介面規格，專注於Phase 3核心業務邏輯。

### 1.2 適用範圍
- **功能範圍**: S-304帳戶管理、S-305科目管理、S-306餘額查詢（MVP核心功能）
- **技術範圍**: Flutter Dart業務邏輯層(PL)
- **版本範圍**: Phase 3 MVP階段

### 1.3 文件版本
- **版本**: V1.2.0
- **建立日期**: 2025-11-17
- **更新紀錄**: MVP簡化重構，函數數量從32個精簡至12個

## 2. 架構設計

### 2.1 術語對應關係

| 層級 | 術語 | 說明 | 對應關係 |
|------|------|------|----------|
| **PL層(業務邏輯)** | `wallet` | 錢包/帳戶容器 | 業務語義正確 |
| **APL層(API端點)** | `accounts` | API技術規範路徑 | `/api/v1/accounts` |
| **BL層(WCM模組)** | `wallet` | 統一業務邏輯處理 | WCM_createWallet等函數 |

### 2.2 MVP模組架構
```
7306. 帳戶與科目管理功能群.dart
├── 基本帳戶管理
├── 基本科目管理
├── 基本餘額查詢
└── 簡單狀態管理
```

### 2.3 資料流向
```
UI層 → PL業務邏輯 → APL.dart(Gateway) → ASL.js → BL模組(WCM.js) → Firebase
```

## 3. 資料模型定義

### 3.1 帳戶資料模型
```dart
class WalletModel {
  final String walletId;
  final String walletName;
  final String walletType;
  final double balance;
  final String currency;
  final bool isActive;
  final String ledgerId;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.2 科目資料模型
```dart
class CategoryModel {
  final String categoryId;
  final String categoryName;
  final String categoryType;
  final String? parentId;
  final int level;
  final String ledgerId;
  final bool isActive;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.3 API回應模型
```dart
class ApiResponse<T> {
  final bool success;
  final T? data;
  final String? message;
  final int? errorCode;
}
```

## 4. MVP函數介面規格（12個核心函數）

### 4.1 帳戶管理函數（4個）

#### 4.1.1 取得帳戶清單
```dart
/**
 * 01. 取得帳戶清單
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本帳戶清單載入
 */
Future<ApiResponse<List<WalletModel>>> getWalletList(String ledgerId);
```

#### 4.1.2 建立新帳戶
```dart
/**
 * 02. 建立新帳戶
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本帳戶建立功能
 */
Future<ApiResponse<WalletModel>> createWallet(String ledgerId, String walletName, String walletType, String currency);
```

#### 4.1.3 更新帳戶資訊
```dart
/**
 * 03. 更新帳戶資訊
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本帳戶資訊更新
 */
Future<ApiResponse<WalletModel>> updateWallet(String walletId, String walletName);
```

#### 4.1.4 取得帳戶餘額
```dart
/**
 * 04. 取得帳戶餘額
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本餘額查詢
 */
Future<ApiResponse<double>> getWalletBalance(String walletId);
```

### 4.2 科目管理函數（4個）

#### 4.2.1 取得科目清單
```dart
/**
 * 05. 取得科目清單
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本科目清單載入
 */
Future<ApiResponse<List<CategoryModel>>> getCategoryList(String ledgerId, String categoryType);
```

#### 4.2.2 建立新科目
```dart
/**
 * 06. 建立新科目
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本科目建立功能
 */
Future<ApiResponse<CategoryModel>> createCategory(String ledgerId, String categoryName, String categoryType, String? parentId);
```

#### 4.2.3 更新科目資訊
```dart
/**
 * 07. 更新科目資訊
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本科目資訊更新
 */
Future<ApiResponse<CategoryModel>> updateCategory(String categoryId, String categoryName);
```

#### 4.2.4 驗證科目階層
```dart
/**
 * 08. 驗證科目階層
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：基本階層關係檢查
 */
bool validateCategoryHierarchy(String parentId, String categoryType);
```

### 4.3 狀態管理函數（2個）

#### 4.3.1 重新整理帳戶狀態
```dart
/**
 * 09. 重新整理帳戶狀態
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：清除快取重新載入
 */
Future<void> refreshWalletState(String ledgerId);
```

#### 4.3.2 重新整理科目狀態
```dart
/**
 * 10. 重新整理科目狀態
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：清除快取重新載入
 */
Future<void> refreshCategoryState(String ledgerId);
```

### 4.4 工具函數（2個）

#### 4.4.1 基本資料驗證
```dart
/**
 * 11. 基本資料驗證
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：必填欄位檢查
 */
bool validateBasicData(String data, String type);
```

#### 4.4.2 轉換API回應格式
```dart
/**
 * 12. 轉換API回應格式
 * @version 2025-11-17-V1.2.0
 * @description MVP版本：標準API回應處理
 */
ApiResponse<T> parseApiResponse<T>(Map<String, dynamic> response, T Function(Map<String, dynamic>) fromJson);
```

## 5. MVP錯誤處理策略

### 5.1 基本錯誤分類
```dart
enum ErrorType {
  NETWORK_ERROR,      // 網路問題
  VALIDATION_ERROR,   // 資料驗證錯誤
  BUSINESS_ERROR,     // 業務邏輯錯誤
  UNKNOWN_ERROR       // 未知錯誤
}
```

### 5.2 基本錯誤處理
- **顯示錯誤訊息**：給使用者看得懂的提示
- **基本驗證**：必填欄位檢查
- **簡單重試**：網路失敗時重試一次

## 6. MVP快取策略

### 6.1 基本快取機制
- **帳戶清單**：載入後暫存在記憶體
- **科目清單**：載入後暫存在記憶體
- **操作後重新載入**：任何新增、修改、刪除後清除快取

### 6.2 簡單同步邏輯
- **主動刷新**：使用者手動重新載入
- **操作後同步**：CRUD操作完成後自動重新載入

## 7. 整合規範

### 7.1 APL Gateway整合
- 使用APL.dart作為統一API調用入口
- 標準化錯誤處理與回應格式
- 對應`/api/v1/accounts`和`/api/v1/categories`端點

### 7.2 WCM模組對接
- 對接1350.WCM.js的帳戶與科目管理功能
- 確保資料結構一致性
- 維護API合約穩定性

## 8. 函數清單總覽

| 序號 | 函數名稱 | 分類 | MVP用途 |
|------|----------|------|---------|
| 01 | getWalletList | 帳戶管理 | 基本帳戶清單載入 |
| 02 | createWallet | 帳戶管理 | 基本帳戶建立 |
| 03 | updateWallet | 帳戶管理 | 基本帳戶更新 |
| 04 | getWalletBalance | 帳戶管理 | 基本餘額查詢 |
| 05 | getCategoryList | 科目管理 | 基本科目清單載入 |
| 06 | createCategory | 科目管理 | 基本科目建立 |
| 07 | updateCategory | 科目管理 | 基本科目更新 |
| 08 | validateCategoryHierarchy | 科目管理 | 基本階層檢查 |
| 09 | refreshWalletState | 狀態管理 | 重新載入帳戶 |
| 10 | refreshCategoryState | 狀態管理 | 重新載入科目 |
| 11 | validateBasicData | 工具函數 | 基本驗證 |
| 12 | parseApiResponse | 工具函數 | API回應處理 |

## 9. 附錄

### 9.1 變更歷程
| 版本 | 日期 | 變更內容 | 修改者 |
|------|------|----------|--------|
| V1.0.0 | 2025-11-17 | 初版建立 | SA |
| V1.1.0 | 2025-11-17 | 階段二功能範圍擴展 | SA |
| V1.2.0 | 2025-11-17 | MVP簡化重構，函數精簡至12個 | SA |

### 9.2 相關文件
- 7106. 帳戶與科目管理功能群_SRS.md
- 8088. API設計規範.md
- 1350. WCM.js模組