
# 7206. 帳戶與科目管理功能群_LLD

## 1. 文件概述

### 1.1 文件目的
為PG提供帳戶與科目管理功能群的完整編程介面規格，定義Phase 3業務邏輯函數表頭，專注於PL層實作規範。

### 1.2 適用範圍
- **功能範圍**: S-304帳戶管理、S-305科目管理、S-306餘額查詢
- **技術範圍**: Flutter Dart業務邏輯層(PL)
- **版本範圍**: Phase 3 MVP核心需求

### 1.3 文件版本
- **版本**: V1.0.0
- **建立日期**: 2025-11-17
- **更新紀錄**: 初版建立

## 2. 架構設計

### 2.1 模組架構
```
7306. 帳戶與科目管理功能群.dart
├── AccountProvider (帳戶狀態管理)
├── CategoryProvider (科目狀態管理) 
├── BalanceProvider (餘額狀態管理)
├── DataSyncProvider (資料同步管理)
└── 工具函數
```

### 2.2 依賴關係
- **上層依賴**: UI Widget (S-304, S-305, S-306)
- **下層依賴**: APL.dart Gateway → WCM.js模組
- **平行依賴**: 其他PL功能群模組

### 2.3 資料流向
```
UI層 → PL業務邏輯 → APL Gateway → BL模組(WCM.js) → Firebase
```

## 3. 資料模型定義

### 3.1 帳戶資料模型
```dart
class AccountModel {
  final String accountId;
  final String accountName;
  final String accountType;
  final double balance;
  final String currency;
  final bool isActive;
  final String ledgerId;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.2 科目資料模型
```dart
class CategoryModel {
  final String categoryId;
  final String categoryName;
  final String categoryType;
  final String? parentId;
  final int level;
  final String ledgerId;
  final bool isActive;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

### 3.3 餘額資料模型
```dart
class BalanceModel {
  final String accountId;
  final double currentBalance;
  final double availableBalance;
  final String currency;
  final DateTime lastUpdated;
}
```

### 3.4 API回應模型
```dart
class ApiResponse<T> {
  final bool success;
  final T? data;
  final String? message;
  final int? errorCode;
  final DateTime timestamp;
}
```

## 4. 函數介面規格

### 4.1 帳戶管理函數

#### 4.1.1 取得帳戶清單
```dart
/**
 * 01. 取得帳戶清單
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<List<AccountModel>>> getAccountList(String ledgerId, String accountType);
```

#### 4.1.2 建立新帳戶
```dart
/**
 * 02. 建立新帳戶
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<AccountModel>> createAccount(String ledgerId, String accountName, String accountType, String currency);
```

#### 4.1.3 更新帳戶資訊
```dart
/**
 * 03. 更新帳戶資訊
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<AccountModel>> updateAccount(String accountId, String accountName, bool isActive);
```

#### 4.1.4 刪除帳戶
```dart
/**
 * 04. 刪除帳戶
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<bool>> deleteAccount(String accountId);
```

### 4.2 科目管理函數

#### 4.2.1 取得科目樹狀結構
```dart
/**
 * 05. 取得科目樹狀結構
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<List<CategoryModel>>> getCategoryTree(String ledgerId, String categoryType);
```

#### 4.2.2 建立新科目
```dart
/**
 * 06. 建立新科目
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<CategoryModel>> createCategory(String ledgerId, String categoryName, String categoryType, String? parentId);
```

#### 4.2.3 更新科目資訊
```dart
/**
 * 07. 更新科目資訊
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<CategoryModel>> updateCategory(String categoryId, String categoryName, bool isActive);
```

#### 4.2.4 刪除科目
```dart
/**
 * 08. 刪除科目
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<bool>> deleteCategory(String categoryId);
```

### 4.3 餘額管理函數

#### 4.3.1 取得帳戶餘額
```dart
/**
 * 09. 取得帳戶餘額
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<BalanceModel>> getAccountBalance(String accountId);
```

#### 4.3.2 取得多帳戶餘額
```dart
/**
 * 10. 取得多帳戶餘額
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<List<BalanceModel>>> getMultipleAccountBalances(List<String> accountIds);
```

#### 4.3.3 計算帳本總餘額
```dart
/**
 * 11. 計算帳本總餘額
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<Map<String, double>>> calculateLedgerTotalBalance(String ledgerId);
```

### 4.4 狀態管理函數

#### 4.4.1 重新整理帳戶狀態
```dart
/**
 * 12. 重新整理帳戶狀態
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<void> refreshAccountState(String ledgerId);
```

#### 4.4.2 重新整理科目狀態
```dart
/**
 * 13. 重新整理科目狀態
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<void> refreshCategoryState(String ledgerId);
```

#### 4.4.3 同步資料狀態
```dart
/**
 * 14. 同步資料狀態
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<bool>> syncDataState(String ledgerId);
```

### 4.5 工具函數

#### 4.5.1 驗證帳戶名稱
```dart
/**
 * 15. 驗證帳戶名稱
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
bool validateAccountName(String accountName);
```

#### 4.5.2 驗證科目階層
```dart
/**
 * 16. 驗證科目階層
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
bool validateCategoryHierarchy(String parentId, String categoryType);
```

#### 4.5.3 格式化餘額顯示
```dart
/**
 * 17. 格式化餘額顯示
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
String formatBalanceDisplay(double balance, String currency);
```

#### 4.5.4 轉換API回應格式
```dart
/**
 * 18. 轉換API回應格式
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
ApiResponse<T> parseApiResponse<T>(Map<String, dynamic> response, T Function(Map<String, dynamic>) fromJson);
```

## 5. 錯誤處理策略

### 5.1 錯誤分類
- **網路錯誤**: 連線逾時、網路中斷
- **驗證錯誤**: 輸入格式不正確、必填欄位缺失
- **業務錯誤**: 帳戶不存在、科目階層衝突
- **系統錯誤**: Firebase異常、API服務異常

### 5.2 錯誤碼對應
```dart
enum ErrorCode {
  NETWORK_ERROR = 1001,
  VALIDATION_ERROR = 1002,
  BUSINESS_ERROR = 1003,
  SYSTEM_ERROR = 1004,
  UNAUTHORIZED = 1005,
  DATA_NOT_FOUND = 1006
}
```

### 5.3 錯誤處理流程
1. **捕獲異常**: try-catch包裝所有API調用
2. **錯誤分類**: 根據異常類型分配錯誤碼
3. **錯誤記錄**: 記錄錯誤詳情至DL模組
4. **用戶提示**: 返回用戶友善的錯誤訊息
5. **狀態恢復**: 確保UI狀態一致性

### 5.4 重試機制
```dart
/**
 * 19. API重試機制
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<T>> retryApiCall<T>(Future<ApiResponse<T>> Function() apiCall, int maxRetries);
```

## 6. 效能優化策略

### 6.1 資料快取
- **帳戶清單**: 記憶體快取30分鐘
- **科目樹**: 記憶體快取60分鐘
- **餘額資料**: 即時更新，快取5分鐘

### 6.2 分頁載入
```dart
/**
 * 20. 分頁載入帳戶
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<List<AccountModel>>> getAccountListWithPagination(String ledgerId, int page, int pageSize);
```

### 6.3 批次處理
```dart
/**
 * 21. 批次更新帳戶狀態
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<ApiResponse<List<AccountModel>>> batchUpdateAccountStatus(List<String> accountIds, bool isActive);
```

## 7. 四模式差異化處理

### 7.1 模式識別
```dart
/**
 * 22. 取得當前操作模式
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
String getCurrentOperationMode();
```

### 7.2 差異化邏輯
- **基本模式**: 標準帳戶與科目管理
- **進階模式**: 增加自訂科目分類
- **專家模式**: 支援複雜科目階層
- **企業模式**: 多帳本整合管理

## 8. 整合規範

### 8.1 APL Gateway整合
- 統一使用APL.dart作為API調用入口
- 遵循8088文件的API設計規範
- 標準化錯誤處理與回應格式

### 8.2 WCM模組對接
- 對接1350.WCM.js的帳戶與科目管理功能
- 確保資料結構一致性
- 維護API合約穩定性

### 8.3 狀態管理整合
- 使用Provider模式統一狀態管理
- 與其他PL模組狀態協調
- 確保資料同步一致性

## 9. 安全性規範

### 9.1 資料驗證
- 所有輸入參數進行格式驗證
- 防止SQL注入與XSS攻擊
- 敏感資料加密處理

### 9.2 存取控制
```dart
/**
 * 23. 驗證使用者權限
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
Future<bool> validateUserPermission(String userId, String ledgerId, String operation);
```

## 10. 測試介面規範

### 10.1 單元測試介面
```dart
/**
 * 24. 測試資料工廠
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
class TestDataFactory {
  static AccountModel createTestAccount();
  static CategoryModel createTestCategory();
  static BalanceModel createTestBalance();
}
```

### 10.2 模擬服務介面
```dart
/**
 * 25. Mock API服務切換
 * @version 2025-11-17-V1.0.0
 * @date 2025-11-17
 * @update: 初版建立
 */
void enableMockMode(bool enabled);
```

## 11. 附錄

### 11.1 變更歷程
| 版本 | 日期 | 變更內容 | 修改者 |
|------|------|----------|--------|
| V1.0.0 | 2025-11-17 | 初版建立 | SA |

### 11.2 相關文件
- 7106. 帳戶與科目管理功能群_SRS.md
- 8088. API設計規範.md
- 0098. The Constitution.md
- DCN-0023. 創建WCM模組並整合帳戶與科目管理功能.md
