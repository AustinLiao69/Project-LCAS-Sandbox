
# Dart 測試代碼開發規範 v1.0.0

## 1. Mockito null safety 兼容性規範

### 1.1 禁用項目
❌ **絕對禁止使用** `any` 匹配器
❌ **避免使用** 泛型 `any<T>()` (在複雜情況下)

### 1.2 推薦用法
✅ **必須使用** 具體類型匹配器：
```dart
// ❌ 錯誤用法
when(mockService.processData(any))

// ✅ 正確用法  
when(mockService.processData(argThat(isA<RequestType>())))
```

### 1.3 常用匹配器對照表
| 舊用法 | 新用法 | 適用場景 |
|--------|--------|----------|
| `any` | `argThat(isA<String>())` | 字串參數 |
| `any` | `argThat(isA<int>())` | 數字參數 |
| `any` | `argThat(isA<RegisterRequest>())` | 自定義類別 |
| `any` | `argThat(isA<Map<String, dynamic>>())` | Map 類型 |
| `any` | `argThat(isA<List<String>>())` | 列表類型 |

## 2. 測試結構標準化

### 2.1 必要的 import 順序
```dart
// 1. Dart 核心庫
import 'dart:async';
import 'dart:convert';

// 2. 第三方測試庫
import 'package:test/test.dart';
import 'package:mockito/mockito.dart';
import 'package:mockito/annotations.dart';

// 3. 專案模組
import '../83. Flutter_Module code(API route)_APL/8301. 認證服務.dart';

// 4. Mock 生成檔案 (必須放最後)
import '檔名.mocks.dart';
```

### 2.2 Mock 服務定義規範
```dart
@GenerateMocks([
  AuthService,
  TokenService,
  // 按字母順序排列
])
```

## 3. 測試案例撰寫標準

### 3.1 測試方法命名規範
```dart
/// TC-XX: 測試案例簡述
/// @version 2025-XX-XX-VX.X.X
/// @date 2025-XX-XX XX:XX:XX
/// @update: 更新說明
test('XX. 測試案例完整描述', () async {
```

### 3.2 AAA 模式強制要求
```dart
test('測試案例', () async {
  // Arrange - 準備測試資料
  final request = TestUtils.createTestRequest();
  when(mockService.method(argThat(isA<RequestType>())))
      .thenAnswer((_) async => expectedResult);

  // Act - 執行測試行為
  final response = await controller.method(request);

  // Assert - 驗證結果
  expect(response.success, isTrue);
  verify(mockService.method(argThat(isA<RequestType>()))).called(1);
});
```

## 4. 版本控制規範

### 4.1 版本號升級規則
- **主版本 (Major)**：架構性變更、不兼容更新
- **次版本 (Minor)**：新增功能、相容性更新  
- **修訂版本 (Patch)**：Bug 修復、小幅改善

### 4.2 變更記錄格式
```dart
/**
 * 檔名_測試程式碼_v2.3.1
 * @testFile 測試程式碼
 * @description 完整測試實作
 * @version 2025-XX-XX-V2.3.1
 * @update 2025-XX-XX: 升級到v2.3.1版本，修復 null safety 問題
 */
```

## 5. 程式碼檢查 (Pre-commit 檢查項目)

### 5.1 強制檢查項目
- [ ] 無 `any` 匹配器使用
- [ ] 所有 Mock 方法使用正確的類型匹配器
- [ ] Import 順序正確
- [ ] 版本號已更新
- [ ] 測試案例遵循 AAA 模式

### 5.2 建議檢查項目  
- [ ] 測試覆蓋率 > 90%
- [ ] 每個測試方法有完整註解
- [ ] Mock 服務按字母順序排列
- [ ] 錯誤處理測試完整

## 6. 工具配置建議

### 6.1 推薦的 pubspec.yaml 依賴版本
```yaml
dev_dependencies:
  test: ^1.24.0
  mockito: ^5.4.0
  build_runner: ^2.4.0
```

### 6.2 建議的 IDE 設定
- 啟用 null safety 檢查
- 自動格式化代碼
- 顯示類型註解

## 7. 團隊協作規範

### 7.1 代碼審查檢查點
1. Mockito 用法是否正確
2. 測試邏輯是否清晰
3. 邊界案例是否涵蓋
4. 錯誤處理是否完整

### 7.2 持續改善流程
- 定期更新此規範文件
- 收集常見問題並補充解決方案
- 建立測試代碼模板庫
