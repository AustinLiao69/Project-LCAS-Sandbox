# 1205. SR_æ’ç¨‹æé†’æ¨¡çµ„

## æ–‡ä»¶è³‡è¨Š
- **æ–‡ä»¶æ¨™é¡Œ**: SR æ’ç¨‹æé†’æ¨¡çµ„æŠ€è¡“è¨­è¨ˆæ–‡ä»¶
- **æ–‡ä»¶ç‰ˆæœ¬**: v1.2
- **å‰µå»ºæ—¥æœŸ**: 2025-07-19 
- **å‰µå»ºè€…**: LCAS SA Team
- **æœ€å¾Œæ›´æ–°**: 2025-08-02 
- **å°æ‡‰éœ€æ±‚æ–‡ä»¶**: 1005. SR_æ’ç¨‹æé†’æ¨¡çµ„.md
- **æ¨¡çµ„ä»£ç¢¼**: SR (Scheduled Reminder)

---

## ğŸ“‘ ç›®æ¬¡ (Table of Contents)

1. æŠ€è¡“æ¶æ§‹æ¦‚è¿°
   - 1.1 æ¨¡çµ„å®šä½
   - 1.2 æŠ€è¡“å †ç–Š
   - 1.3 æ¨¡çµ„æ¶æ§‹

2. å‡½æ•¸æ¸…å–®
   - 2.1 å®Œæ•´å‡½æ•¸ç´¢å¼•è¡¨
   - 2.2 å‡½æ•¸åˆ†å±¤æ¶æ§‹

3. æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ
   - 3.1 æ’ç¨‹ç®¡ç†å±¤å‡½æ•¸
   - 3.2 ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤å‡½æ•¸
   - 3.3 æ¨æ’­æœå‹™å±¤å‡½æ•¸
   - 3.4 æ•¸æ“šæ•´åˆå±¤å‡½æ•¸
   - 3.5 Quick Reply å°ˆç”¨å±¤å‡½æ•¸

4. Quick Reply æ¶æ§‹è¨­è¨ˆ
   - 4.1 Quick Reply æŠ€è¡“å¯¦ä½œæ¶æ§‹
   - 4.2 WH-SR Quick Reply å”ä½œå”è­°
   - 4.3 ä»˜è²»åŠŸèƒ½åœ¨ Quick Reply çš„æ•´åˆ

5. æ¨¡çµ„é–“äº’å‹•æ¶æ§‹
   - 5.1 æ ¸å¿ƒä¾è³´é—œä¿‚
   - 5.2 è³‡æ–™æµå‘è¨­è¨ˆ

6. è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ
   - 6.1 FSæ¨¡çµ„é›†åˆçµæ§‹éœ€æ±‚
   - 6.2 ä»˜è²»åŠŸèƒ½æ¬Šé™è¨­è¨ˆ
   - 6.3 Quick Reply è³‡æ–™çµæ§‹

7. API ä»‹é¢è¦æ ¼
   - 7.1 REST API ç«¯é»
   - 7.2 Cron è¡¨é”å¼è¨­è¨ˆ

8. æ’ç¨‹å¼•æ“è¨­è¨ˆ
   - 8.1 æ’ç¨‹ä»»å‹™ç®¡ç†
   - 8.2 æ™‚å€å’Œå‡æ—¥è™•ç†

9. ä»˜è²»åŠŸèƒ½æ§åˆ¶æ©Ÿåˆ¶
   - 9.1 åŠŸèƒ½æ¬Šé™é©—è­‰æµç¨‹
   - 9.2 åŠŸèƒ½é™ç´šè™•ç†

10. éŒ¯èª¤è™•ç†èˆ‡ç›£æ§
    - 10.1 éŒ¯èª¤é¡å‹å®šç¾©
    - 10.2 é‡è©¦æ©Ÿåˆ¶è¨­è¨ˆ
    - 10.3 å¥åº·ç›£æ§æ©Ÿåˆ¶

11. æ•ˆèƒ½æœ€ä½³åŒ–
    - 11.1 å¿«å–ç­–ç•¥
    - 11.2 æ‰¹æ¬¡è™•ç†å„ªåŒ–

12. æ¸¬è©¦ç­–ç•¥
    - 12.1 å–®å…ƒæ¸¬è©¦è¦†è“‹
    - 12.2 æ•´åˆæ¸¬è©¦å ´æ™¯
    - 12.3 æ•ˆèƒ½æ¸¬è©¦æŒ‡æ¨™

## 13. æ–‡ä»¶ç¶­è­·è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹è€… | ä¿®æ”¹å…§å®¹ |
|------|------|--------|----------|
| v1.2 | 2025-07-19 15:30:00 +08:00 | LCAS SA Team | æ–°å¢Quick ReplyåŠŸèƒ½æ¶æ§‹ï¼Œæ“´å……ä»˜è²»åŠŸèƒ½æ•´åˆæ©Ÿåˆ¶ |
| v2.0 | 2025-08-02 10:00:00 +08:00 | LCAS SA Team | æ·»åŠ å®Œæ•´ç›®æ¬¡çµæ§‹ï¼Œå„ªåŒ–æ–‡ä»¶çµæ§‹ |

---

## 1.0 æŠ€è¡“æ¶æ§‹æ¦‚è¿°

### 1.1 æ¨¡çµ„å®šä½
SR æ’ç¨‹æé†’æ¨¡çµ„ä½œç‚º LCAS 2.0 çš„æ™ºæ…§è¨˜å¸³è‡ªå‹•åŒ–æ ¸å¿ƒï¼Œè² è²¬è™•ç†å®šæœŸè¨˜å¸³æé†’ã€è‡ªå‹•è¨˜å¸³åŸ·è¡Œã€è²¡å‹™çµ±è¨ˆæ¨æ’­ã€Quick Reply äº’å‹•ç­‰åŠŸèƒ½ã€‚æœ¬æ¨¡çµ„å°ˆæ³¨æ–¼æ’ç¨‹é‚è¼¯å’Œæ¥­å‹™è¦å‰‡ï¼Œé€éå…¶ä»–æ¨¡çµ„æä¾›çš„æ¨™æº–åŒ–ä»‹é¢é€²è¡Œè³‡æ–™åº«æ“ä½œå’Œå¤–éƒ¨æœå‹™æ•´åˆã€‚

### 1.2 æŠ€è¡“å †ç–Š
- **å¾Œç«¯æ¡†æ¶**: Node.js/Express
- **æ’ç¨‹å¼•æ“**: Node-cron
- **è³‡æ–™åº«**: Firestore (é€éFSæ¨¡çµ„)
- **æ¨æ’­æœå‹™**: LINE Push API (é€éWHæ¨¡çµ„)
- **æ™‚å€è™•ç†**: moment-timezone
- **æ—¥èªŒç³»çµ±**: DL æ¨¡çµ„
- **è³‡æ–™åˆ†ç™¼**: DD æ¨¡çµ„
- **Quick Reply è™•ç†**: LINE Messaging API

### 1.3 æ¨¡çµ„æ¶æ§‹
```javascript
/**
 * SR_æ’ç¨‹æé†’æ¨¡çµ„_1.2.0
 * @module SRæ¨¡çµ„
 * @description æ™ºæ…§è¨˜å¸³è‡ªå‹•åŒ–æ ¸å¿ƒ - æ’ç¨‹æé†’ã€è‡ªå‹•è¨˜å¸³ã€è²¡å‹™çµ±è¨ˆæ¨æ’­ã€Quick Reply äº’å‹•
 * @update 2025-01-09: å‡ç´šè‡³v1.2ç‰ˆæœ¬ï¼Œæ–°å¢Quick ReplyåŠŸèƒ½æ¶æ§‹ï¼Œæ“´å……ä»˜è²»åŠŸèƒ½æ•´åˆæ©Ÿåˆ¶
 */
```

---

## 2.0 å‡½æ•¸æ¸…å–®

### 2.1 å®Œæ•´å‡½æ•¸ç´¢å¼•è¡¨

| # | å‡½æ•¸åç¨± | ç‰ˆæœ¬ | æ‰€å±¬å±¤ç´š | åŠŸèƒ½æè¿° | ç›¸ä¾æ¨¡çµ„ |
|---|----------|------|----------|----------|----------|
| 01 | SR_createScheduledReminder | V1.2.0 | æ’ç¨‹ç®¡ç†å±¤ | å»ºç«‹æ–°çš„æ’ç¨‹æé†’è¨­å®š | AMã€FSã€DL |
| 02 | SR_updateScheduledReminder | V1.2.0 | æ’ç¨‹ç®¡ç†å±¤ | ä¿®æ”¹ç¾æœ‰æ’ç¨‹æé†’è¨­å®š | FSã€SRã€DL |
| 03 | SR_deleteScheduledReminder | V1.2.0 | æ’ç¨‹ç®¡ç†å±¤ | å®‰å…¨åˆªé™¤æ’ç¨‹æé†’ | FSã€SRã€DL |
| 04 | SR_executeScheduledTask | V1.2.0 | æ’ç¨‹ç®¡ç†å±¤ | åŸ·è¡Œåˆ°æœŸçš„æ’ç¨‹ä»»å‹™ | FSã€WHã€BKã€DL |
| 05 | SR_processHolidayLogic | V1.2.0 | æ’ç¨‹ç®¡ç†å±¤ | è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯ | FSã€SRã€DL |
| 07 | SR_validatePremiumFeature | V1.2.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™ | AMã€DL |
| 08 | SR_checkSubscriptionStatus | V1.2.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | æª¢æŸ¥è¨‚é–±ç‹€æ…‹ | FSã€AMã€DL |
| 09 | SR_enforceFreeUserLimits | V1.2.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶ | FSã€WHã€DL |
| 10 | SR_upgradeFeatureAccess | V1.2.0 | ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ | å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™ | FSã€AMã€DDã€DL |
| 11 | SR_sendDailyFinancialSummary | V1.2.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦ | SRã€MRAã€WHã€DL |
| 12 | SR_sendBudgetWarning | V1.2.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€é ç®—è­¦å‘Š | BMã€SRã€WHã€DL |
| 13 | SR_sendMonthlyReport | V1.2.0 | æ¨æ’­æœå‹™å±¤ | ç™¼é€æœˆåº¦å ±å‘Š | MRAã€SRã€WHã€DL |
| 14 | SR_processQuickReplyStatistics | V1.2.0 | æ¨æ’­æœå‹™å±¤ | è™•ç†Quick Replyçµ±è¨ˆ | FSã€DDã€WHã€DL |
| 15 | SR_syncWithAccountModule | V1.2.0 | æ•¸æ“šæ•´åˆå±¤ | èˆ‡AMæ¨¡çµ„åŒæ­¥ | AMã€FSã€DL |
| 16 | SR_syncWithDataDistribution | V1.2.0 | æ•¸æ“šæ•´åˆå±¤ | èˆ‡DDæ¨¡çµ„åŒæ­¥ | DDã€FSã€DL |
| 17 | SR_logScheduledActivity | V1.2.0 | æ•¸æ“šæ•´åˆå±¤ | è¨˜éŒ„æ’ç¨‹æ´»å‹• | DLã€FS |
| 18 | SR_handleSchedulerError | V1.2.0 | æ•¸æ“šæ•´åˆå±¤ | è™•ç†æ’ç¨‹å™¨éŒ¯èª¤ | DLã€WHã€SR |
| 19 | SR_handleQuickReplyInteraction | V1.2.0 | Quick Reply å°ˆç”¨å±¤ | çµ±ä¸€è™•ç†Quick Replyäº’å‹• | WHã€AMã€DDã€DL |
| 20 | SR_generateQuickReplyOptions | V1.2.0 | Quick Reply å°ˆç”¨å±¤ | å‹•æ…‹ç”ŸæˆQuick Replyé¸é … | AMã€SRã€DL |
| 21 | SR_handlePaywallQuickReply | V1.2.0 | Quick Reply å°ˆç”¨å±¤ | è™•ç†ä»˜è²»åŠŸèƒ½ç‰†Quick Reply | AMã€WHã€SRã€DL |

### 2.2 å‡½æ•¸åˆ†å±¤æ¶æ§‹

```
SRæ’ç¨‹æé†’æ¨¡çµ„ (v1.2.0)
â”œâ”€â”€ æ’ç¨‹ç®¡ç†å±¤ (5å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_createScheduledReminder() - å»ºç«‹æ’ç¨‹æé†’
â”‚   â”œâ”€â”€ SR_updateScheduledReminder() - æ›´æ–°æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ SR_deleteScheduledReminder() - åˆªé™¤æ’ç¨‹æé†’
â”‚   â”œâ”€â”€ SR_executeScheduledTask() - åŸ·è¡Œæ’ç¨‹ä»»å‹™
â”‚   â””â”€â”€ SR_processHolidayLogic() - è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯
â”œâ”€â”€ ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤ (4å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_validatePremiumFeature() - é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™
â”‚   â”œâ”€â”€ SR_checkSubscriptionStatus() - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
â”‚   â”œâ”€â”€ SR_enforceFreeUserLimits() - å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶
â”‚   â””â”€â”€ SR_upgradeFeatureAccess() - å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™
â”œâ”€â”€ æ¨æ’­æœå‹™å±¤ (4å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_sendDailyFinancialSummary() - ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦
â”‚   â”œâ”€â”€ SR_sendBudgetWarning() - ç™¼é€é ç®—è­¦å‘Š
â”‚   â”œâ”€â”€ SR_sendMonthlyReport() - ç™¼é€æœˆåº¦å ±å‘Š
â”‚   â””â”€â”€ SR_processQuickReplyStatistics() - è™•ç†Quick Replyçµ±è¨ˆï¼ˆé‡å¤§å‡ç´šï¼‰
â”œâ”€â”€ æ•¸æ“šæ•´åˆå±¤ (4å€‹å‡½æ•¸)
â”‚   â”œâ”€â”€ SR_syncWithAccountModule() - èˆ‡AMæ¨¡çµ„åŒæ­¥
â”‚   â”œâ”€â”€ SR_syncWithDataDistribution() - èˆ‡DDæ¨¡çµ„åŒæ­¥
â”‚   â”œâ”€â”€ SR_logScheduledActivity() - è¨˜éŒ„æ’ç¨‹æ´»å‹•
â”‚   â””â”€â”€ SR_handleSchedulerError() - è™•ç†æ’ç¨‹å™¨éŒ¯èª¤
â””â”€â”€ Quick Reply å°ˆç”¨å±¤ (3å€‹æ–°å¢å‡½æ•¸)
    â”œâ”€â”€ SR_handleQuickReplyInteraction() - çµ±ä¸€è™•ç†Quick Replyäº’å‹•
    â”œâ”€â”€ SR_generateQuickReplyOptions() - å‹•æ…‹ç”ŸæˆQuick Replyé¸é …
    â””â”€â”€ SR_handlePaywallQuickReply() - è™•ç†ä»˜è²»åŠŸèƒ½ç‰†Quick Reply
```

---

## 3.0 æ ¸å¿ƒå‡½æ•¸è¨­è¨ˆ

### 3.1 æ’ç¨‹ç®¡ç†å±¤å‡½æ•¸

```javascript
/**
 * 01. å»ºç«‹æ’ç¨‹æé†’
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description å»ºç«‹æ–°çš„æ’ç¨‹æé†’è¨­å®šï¼Œæ”¯æ´é€±æœŸæ€§æé†’å’Œæ¢ä»¶åˆ¤æ–·
 */
function SR_createScheduledReminder(userId, reminderConfig, userType)
```
- **åŠŸèƒ½**: å»ºç«‹æ–°çš„æ’ç¨‹æé†’ï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œé…é¡é™åˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_validateUserType()` - é©—è­‰ç”¨æˆ¶é¡å‹å’Œæ¬Šé™
  - **FSæ¨¡çµ„** `FS_createDocument()` - å»ºç«‹æ’ç¨‹è¨­å®šæ–‡ä»¶
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„å»ºç«‹æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, reminderId: string, nextExecution: timestamp, quotaUsed: number}`

```javascript
/**
 * 02. æ›´æ–°æ’ç¨‹è¨­å®š
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description ä¿®æ”¹ç¾æœ‰æ’ç¨‹æé†’çš„è¨­å®šåƒæ•¸
 */
function SR_updateScheduledReminder(reminderId, updateData, userId)
```
- **åŠŸèƒ½**: å®‰å…¨æ›´æ–°æ’ç¨‹è¨­å®šï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œè¡çªæª¢æŸ¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°æ’ç¨‹è¨­å®š
  - **SRæ¨¡çµ„** `SR_recalculateNextExecution()` - é‡æ–°è¨ˆç®—åŸ·è¡Œæ™‚é–“
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ›´æ–°æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, updatedFields: array, nextExecution: timestamp}`

```javascript
/**
 * 03. åˆªé™¤æ’ç¨‹æé†’
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description å®‰å…¨åˆªé™¤æ’ç¨‹æé†’ä¸¦æ¸…ç†ç›¸é—œè³‡æ–™
 */
function SR_deleteScheduledReminder(reminderId, userId, reason)
```
- **åŠŸèƒ½**: å®Œæ•´çš„æ’ç¨‹åˆªé™¤æµç¨‹ï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œè³‡æ–™æ¸…ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_deleteDocument()` - åˆªé™¤æ’ç¨‹è¨­å®š
  - **SRæ¨¡çµ„** `SR_cleanupRelatedData()` - æ¸…ç†ç›¸é—œè³‡æ–™
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„åˆªé™¤æ“ä½œ
- **å›å‚³å€¼**: `{success: boolean, deletedId: string, cleanupStatus: object}`

```javascript
/**
 * 04. åŸ·è¡Œæ’ç¨‹ä»»å‹™
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description åŸ·è¡Œåˆ°æœŸçš„æ’ç¨‹ä»»å‹™ï¼Œè™•ç†æé†’å’Œè‡ªå‹•è¨˜å¸³
 */
function SR_executeScheduledTask(reminderId, executionContext)
```
- **åŠŸèƒ½**: æ ¸å¿ƒæ’ç¨‹åŸ·è¡Œé‚è¼¯ï¼ŒåŒ…å«æ¢ä»¶åˆ¤æ–·å’ŒéŒ¯èª¤è™•ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getDocument()` - å–å¾—æ’ç¨‹è¨­å®š
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€æé†’è¨Šæ¯
  - **BKæ¨¡çµ„** `BK_processAutoBookkeeping()` - è™•ç†è‡ªå‹•è¨˜å¸³
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„åŸ·è¡Œçµæœ
- **å›å‚³å€¼**: `{success: boolean, executionResult: object, nextExecution: timestamp}`

```javascript
/**
 * 05. è™•ç†åœ‹å®šå‡æ—¥é‚è¼¯
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è™•ç†åœ‹å®šå‡æ—¥å’Œé€±æœ«çš„æ’ç¨‹èª¿æ•´é‚è¼¯
 */
function SR_processHolidayLogic(scheduledDate, holidayHandling, userId)
```
- **åŠŸèƒ½**: æ™ºæ…§å‡æ—¥è™•ç†æ©Ÿåˆ¶ï¼Œæ”¯æ´è·³éã€æå‰ã€å»¶å¾Œä¸‰ç¨®ç­–ç•¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getHolidayList()` - å–å¾—åœ‹å®šå‡æ—¥æ¸…å–®
  - **SRæ¨¡çµ„** `SR_calculateAdjustedDate()` - è¨ˆç®—èª¿æ•´å¾Œæ—¥æœŸ
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„å‡æ—¥èª¿æ•´
- **å›å‚³å€¼**: `{adjustedDate: timestamp, adjustmentType: string, reason: string}`

### 3.2 ä»˜è²»åŠŸèƒ½æ§åˆ¶å±¤å‡½æ•¸

```javascript
/**
 * 07. é©—è­‰ä»˜è²»åŠŸèƒ½æ¬Šé™
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™ä½¿ç”¨ç‰¹å®šä»˜è²»åŠŸèƒ½
 */
function SR_validatePremiumFeature(userId, featureName, operationContext)
```
- **åŠŸèƒ½**: çµ±ä¸€çš„ä»˜è²»åŠŸèƒ½æ¬Šé™é©—è­‰æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—ä½¿ç”¨è€…è³‡è¨Š
  - **AMæ¨¡çµ„** `AM_checkSubscriptionStatus()` - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„æ¬Šé™é©—è­‰å¤±æ•—
- **å›å‚³å€¼**: `{hasPermission: boolean, subscriptionLevel: string, limitExceeded: boolean}`

```javascript
/**
 * 08. æª¢æŸ¥è¨‚é–±ç‹€æ…‹
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description æª¢æŸ¥ä½¿ç”¨è€…è¨‚é–±ç‹€æ…‹å’ŒåŠŸèƒ½å¯ç”¨æ€§
 */
function SR_checkSubscriptionStatus(userId)
```
- **åŠŸèƒ½**: è©³ç´°çš„è¨‚é–±ç‹€æ…‹æª¢æŸ¥ï¼ŒåŒ…å«éæœŸå’Œé™ç´šè™•ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getDocument()` - å–å¾—è¨‚é–±è³‡è¨Š
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—ä½¿ç”¨è€…åŸºæœ¬è³‡è¨Š
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„ç‹€æ…‹æª¢æŸ¥
- **å›å‚³å€¼**: `{isActive: boolean, expiryDate: timestamp, availableFeatures: array}`

```javascript
/**
 * 09. å¼·åˆ¶å…è²»ç”¨æˆ¶é™åˆ¶
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description å°å…è²»ç”¨æˆ¶å¼·åˆ¶åŸ·è¡ŒåŠŸèƒ½é™åˆ¶å’Œé…é¡æ§åˆ¶
 */
function SR_enforceFreeUserLimits(userId, operationType, currentUsage)
```
- **åŠŸèƒ½**: å…è²»ç”¨æˆ¶é™åˆ¶åŸ·è¡Œæ©Ÿåˆ¶ï¼ŒåŒ…å«è»Ÿé™åˆ¶å’Œç¡¬é™åˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_getUserQuota()` - å–å¾—ä½¿ç”¨è€…é…é¡è³‡è¨Š
  - **WHæ¨¡çµ„** `WH_sendUpgradePrompt()` - ç™¼é€å‡ç´šæç¤º
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„é™åˆ¶åŸ·è¡Œ
- **å›å‚³å€¼**: `{allowed: boolean, remainingQuota: number, upgradePromptSent: boolean}`

```javascript
/**
 * 10. å‡ç´šåŠŸèƒ½å­˜å–æ¬Šé™
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è™•ç†ä½¿ç”¨è€…å‡ç´šå¾Œçš„åŠŸèƒ½æ¬Šé™æ›´æ–°
 */
function SR_upgradeFeatureAccess(userId, newSubscriptionLevel, effectiveDate)
```
- **åŠŸèƒ½**: è¨‚é–±å‡ç´šå¾Œçš„åŠŸèƒ½æ¬Šé™å³æ™‚æ›´æ–°
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°ä½¿ç”¨è€…æ¬Šé™
  - **AMæ¨¡çµ„** `AM_updateAccountInfo()` - æ›´æ–°å¸³è™Ÿè³‡è¨Š
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼æ¬Šé™æ›´æ–°
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ¬Šé™å‡ç´š
- **å›å‚³å€¼**: `{success: boolean, activatedFeatures: array, syncStatus: object}`

### 3.3 æ¨æ’­æœå‹™å±¤å‡½æ•¸

```javascript
/**
 * 11. ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è‡ªå‹•ç™¼é€æ¯æ—¥è²¡å‹™æ‘˜è¦æ¨æ’­ï¼ˆä»˜è²»åŠŸèƒ½ï¼‰
 */
function SR_sendDailyFinancialSummary(userId, summaryData, pushTime)
```
- **åŠŸèƒ½**: æ™ºæ…§è²¡å‹™æ‘˜è¦ç”Ÿæˆå’Œæ¨æ’­æœå‹™
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **MRAæ¨¡çµ„** `MRA_generateFinancialSummary()` - ç”Ÿæˆè²¡å‹™æ‘˜è¦
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€æ¨æ’­è¨Šæ¯
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„æ¨æ’­çµæœ
- **å›å‚³å€¼**: `{success: boolean, messageId: string, deliveryStatus: object}`

```javascript
/**
 * 12. ç™¼é€é ç®—è­¦å‘Š
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è‡ªå‹•ç™¼é€é ç®—è¶…æ”¯è­¦å‘Šé€šçŸ¥
 */
function SR_sendBudgetWarning(userId, budgetData, thresholdReached)
```
- **åŠŸèƒ½**: æ™ºæ…§é ç®—ç›£æ§å’Œè­¦å‘Šæ¨æ’­ç³»çµ±
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **BMæ¨¡çµ„** `BM_getBudgetStatus()` - å–å¾—é ç®—ç‹€æ…‹
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€è­¦å‘Šè¨Šæ¯
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„é ç®—è­¦å‘Š
- **å›å‚³å€¼**: `{success: boolean, warningLevel: string, actionRequired: boolean}`

```javascript
/**
 * 13. ç™¼é€æœˆåº¦å ±å‘Š
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è‡ªå‹•ç”Ÿæˆä¸¦ç™¼é€æœˆåº¦è²¡å‹™å ±å‘Š
 */
function SR_sendMonthlyReport(userId, reportMonth, reportData)
```
- **åŠŸèƒ½**: å®Œæ•´çš„æœˆåº¦è²¡å‹™å ±å‘Šç”Ÿæˆå’Œæ¨æ’­
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **MRAæ¨¡çµ„** `MRA_generateMonthlyReport()` - ç”Ÿæˆæœˆåº¦å ±å‘Š
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰ä»˜è²»åŠŸèƒ½
  - **WHæ¨¡çµ„** `WH_sendPushMessage()` - ç™¼é€å ±å‘Šè¨Šæ¯
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„å ±å‘Šç™¼é€
- **å›å‚³å€¼**: `{success: boolean, reportId: string, deliveryTimestamp: timestamp}`

```javascript
/**
 * 14. è™•ç†Quick Replyçµ±è¨ˆ - é‡å¤§åŠŸèƒ½æ“´å……
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @update: æ–°å¢å®Œæ•´Quick Replyçµ±è¨ˆè™•ç†é‚è¼¯ï¼Œæ”¯æ´ä¸‰ç¨®çµ±è¨ˆé¡å‹å’Œå‹•æ…‹é¸é …ç”Ÿæˆ
 */
function SR_processQuickReplyStatistics(userId, statisticType, queryParams)
```
- **åŠŸèƒ½**: å…¨é¢å‡ç´šçš„Quick Replyçµ±è¨ˆè™•ç†ï¼Œæ”¯æ´ä»Šæ—¥ã€æœ¬é€±ã€æœ¬æœˆçµ±è¨ˆï¼Œæ•´åˆä»˜è²»åŠŸèƒ½æª¢æŸ¥
- **æ–°å¢åŠŸèƒ½**: 
  - æ”¯æ´ä¸‰ç¨®çµ±è¨ˆé¡å‹çš„å®Œæ•´è™•ç†é‚è¼¯
  - å‹•æ…‹ç”Ÿæˆå°æ‡‰çš„Quick Replyé¸é …
  - æ•´åˆä»˜è²»åŠŸèƒ½æª¢æŸ¥æ©Ÿåˆ¶
  - èˆ‡DDæ¨¡çµ„æ·±åº¦æ•´åˆé€²è¡Œæ•¸æ“šè™•ç†
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **FSæ¨¡çµ„** `FS_queryUserData()` - æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™
  - **DDæ¨¡çµ„** `DD_processDataQuery()` - è™•ç†è³‡æ–™æŸ¥è©¢
  - **WHæ¨¡çµ„** `WH_sendQuickReply()` - ç™¼é€Quick Replyå›æ‡‰
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„çµ±è¨ˆæŸ¥è©¢
  - **AMæ¨¡çµ„** `AM_checkSubscriptionStatus()` - æª¢æŸ¥è¨‚é–±ç‹€æ…‹ï¼ˆæ–°å¢ï¼‰
  - **SRæ¨¡çµ„** `SR_generateQuickReplyOptions()` - ç”Ÿæˆå‹•æ…‹é¸é …ï¼ˆæ–°å¢ï¼‰
- **å›å‚³å€¼**: `{success: boolean, statisticData: object, quickReplyOptions: array, hasPaywall: boolean}`

### 3.4 æ•¸æ“šæ•´åˆå±¤å‡½æ•¸

```javascript
/**
 * 15. èˆ‡AMæ¨¡çµ„åŒæ­¥
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description èˆ‡å¸³è™Ÿç®¡ç†æ¨¡çµ„åŒæ­¥ä½¿ç”¨è€…è³‡è¨Šå’Œæ¬Šé™
 */
function SR_syncWithAccountModule(userId, syncType, syncData)
```
- **åŠŸèƒ½**: ç¢ºä¿ä½¿ç”¨è€…è³‡è¨Šå’Œæ¬Šé™çš„ä¸€è‡´æ€§åŒæ­¥
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—æœ€æ–°ä½¿ç”¨è€…è³‡è¨Š
  - **FSæ¨¡çµ„** `FS_updateDocument()` - æ›´æ–°æœ¬åœ°å¿«å–è³‡è¨Š
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„åŒæ­¥ç‹€æ…‹
- **å›å‚³å€¼**: `{success: boolean, syncedFields: array, conflictResolved: boolean}`

```javascript
/**
 * 16. èˆ‡DDæ¨¡çµ„åŒæ­¥
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description èˆ‡è³‡æ–™åˆ†ç™¼æ¨¡çµ„åŒæ­¥æ’ç¨‹ç›¸é—œè³‡æ–™
 */
function SR_syncWithDataDistribution(userId, distributionData, targetModules)
```
- **åŠŸèƒ½**: è·¨æ¨¡çµ„è³‡æ–™åˆ†ç™¼å’ŒåŒæ­¥æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DDæ¨¡çµ„** `DD_distributeData()` - åˆ†ç™¼æ’ç¨‹è³‡æ–™
  - **FSæ¨¡çµ„** `FS_batchUpdate()` - æ‰¹æ¬¡æ›´æ–°è³‡æ–™
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„åˆ†ç™¼çµæœ
- **å›å‚³å€¼**: `{success: boolean, distributedModules: array, syncTimestamp: timestamp}`

```javascript
/**
 * 17. è¨˜éŒ„æ’ç¨‹æ´»å‹•
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è¨˜éŒ„æ’ç¨‹ç›¸é—œçš„æ‰€æœ‰æ´»å‹•å’Œæ“ä½œ
 */
function SR_logScheduledActivity(userId, activityType, activityData, result)
```
- **åŠŸèƒ½**: æ¨™æº–åŒ–çš„æ’ç¨‹æ´»å‹•æ—¥èªŒè¨˜éŒ„
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„ä¸€èˆ¬æ´»å‹•
  - **DLæ¨¡çµ„** `DL_error()` - è¨˜éŒ„éŒ¯èª¤æ´»å‹•
  - **FSæ¨¡çµ„** `FS_createDocument()` - å»ºç«‹æ´»å‹•è¨˜éŒ„
- **å›å‚³å€¼**: `{success: boolean, logId: string, logLevel: string}`

```javascript
/**
 * 18. è™•ç†æ’ç¨‹å™¨éŒ¯èª¤
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description çµ±ä¸€è™•ç†æ’ç¨‹å™¨é‹è¡Œéç¨‹ä¸­çš„å„ç¨®éŒ¯èª¤
 */
function SR_handleSchedulerError(errorType, errorData, context, retryCount)
```
- **åŠŸèƒ½**: æ¨™æº–åŒ–éŒ¯èª¤è™•ç†èˆ‡è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **DLæ¨¡çµ„** `DL_error()` - è©³ç´°éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
  - **WHæ¨¡çµ„** `WH_sendErrorNotification()` - ç™¼é€éŒ¯èª¤é€šçŸ¥
  - **SRæ¨¡çµ„** `SR_scheduleRetry()` - å®‰æ’é‡è©¦åŸ·è¡Œ
- **å›å‚³å€¼**: `{handled: boolean, errorCode: string, retryScheduled: boolean}`

### 3.5 Quick Reply å°ˆç”¨å±¤å‡½æ•¸

```javascript
/**
 * 19. çµ±ä¸€è™•ç†Quick Replyäº’å‹•äº‹ä»¶
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description çµ±ä¸€è™•ç†æ‰€æœ‰Quick Replyäº’å‹•äº‹ä»¶ï¼ŒåŒ…å«è·¯ç”±åˆ†ç™¼å’Œå›æ‡‰ç”Ÿæˆ
 */
function SR_handleQuickReplyInteraction(userId, interactionType, interactionData, contextData)
```
- **åŠŸèƒ½**: ä½œç‚ºQuick Replyäº’å‹•çš„ä¸­å¤®è™•ç†å™¨ï¼Œè² è²¬è·¯ç”±åˆ†ç™¼å’Œçµ±ä¸€å›æ‡‰æ ¼å¼
- **æ ¸å¿ƒé‚è¼¯**: 
  - è§£æQuick Replyäº’å‹•é¡å‹ï¼ˆçµ±è¨ˆæŸ¥è©¢ã€ä»˜è²»åŠŸèƒ½ã€è¨­å®šè®Šæ›´ï¼‰
  - æ ¹æ“šç”¨æˆ¶æ¬Šé™å’Œä¸Šä¸‹æ–‡æ±ºå®šè™•ç†è·¯å¾‘
  - çµ±ä¸€ç”Ÿæˆç¬¦åˆLINE Messaging APIæ ¼å¼çš„å›æ‡‰
  - ç®¡ç†äº’å‹•æœƒè©±ç‹€æ…‹å’ŒéæœŸæ©Ÿåˆ¶
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **WHæ¨¡çµ„** `WH_sendQuickReply()` - ç™¼é€Quick Replyå›æ‡‰
  - **AMæ¨¡çµ„** `AM_getUserInfo()` - å–å¾—ä½¿ç”¨è€…è³‡è¨Š
  - **DDæ¨¡çµ„** `DD_processDataQuery()` - è™•ç†è³‡æ–™æŸ¥è©¢
  - **DLæ¨¡çµ„** `DL_log()` - è¨˜éŒ„äº’å‹•äº‹ä»¶
  - **SRæ¨¡çµ„** `SR_generateQuickReplyOptions()` - ç”Ÿæˆå‹•æ…‹é¸é …
- **å›å‚³å€¼**: `{success: boolean, responseData: object, quickReplyOptions: array, sessionId: string}`

```javascript
/**
 * 20. å‹•æ…‹ç”ŸæˆQuick Replyé¸é …
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description æ ¹æ“šç”¨æˆ¶é¡å‹å’ŒåŠŸèƒ½æ¬Šé™å‹•æ…‹ç”ŸæˆQuick Replyé¸é …
 */
function SR_generateQuickReplyOptions(userId, contextType, currentFeature)
```
- **åŠŸèƒ½**: æ™ºæ…§åŒ–Quick Replyé¸é …ç”Ÿæˆå™¨ï¼Œæ ¹æ“šä½¿ç”¨è€…ç‹€æ…‹å’Œæ¬Šé™å‹•æ…‹èª¿æ•´å¯ç”¨é¸é …
- **æ ¸å¿ƒé‚è¼¯**: 
  - åˆ†æä½¿ç”¨è€…è¨‚é–±ç‹€æ…‹å’Œå¯ç”¨åŠŸèƒ½
  - æ ¹æ“šä¸Šä¸‹æ–‡é¡å‹ç”Ÿæˆé©ç•¶çš„é¸é …æ¸…å–®
  - è™•ç†ä»˜è²»åŠŸèƒ½çš„å‡ç´šæç¤ºé¸é …
  - ç”Ÿæˆç¬¦åˆLINEè¦æ ¼çš„Quick ReplyæŒ‰éˆ•é…ç½®
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_checkSubscriptionStatus()` - æª¢æŸ¥è¨‚é–±ç‹€æ…‹
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - é©—è­‰åŠŸèƒ½æ¬Šé™
  - **DLæ¨¡çµ„** `DL_info()` - è¨˜éŒ„é¸é …ç”Ÿæˆ
  - **FSæ¨¡çµ„** `FS_getUserPreferences()` - å–å¾—ä½¿ç”¨è€…åå¥½è¨­å®š
- **å›å‚³å€¼**: `{options: array, hasPaywall: boolean, contextData: object, maxOptions: number}`

```javascript
/**
 * 21. è™•ç†ä»˜è²»åŠŸèƒ½ç‰†Quick Replyäº’å‹•
 * @version 2025-01-09-V1.2.0
 * @date 2025-01-09 20:00:00
 * @description è™•ç†å…è²»ç”¨æˆ¶è§¸ç™¼ä»˜è²»åŠŸèƒ½æ™‚çš„Quick Replyäº’å‹•æµç¨‹
 */
function SR_handlePaywallQuickReply(userId, blockedFeature, userContext, interactionData)
```
- **åŠŸèƒ½**: å°ˆé–€è™•ç†ä»˜è²»åŠŸèƒ½ç‰†çš„Quick Replyäº’å‹•æ©Ÿåˆ¶ï¼Œæä¾›å‹å–„çš„å‡ç´šå¼•å°æµç¨‹
- **æ ¸å¿ƒé‚è¼¯**: 
  - åµæ¸¬å…è²»ç”¨æˆ¶å°ä»˜è²»åŠŸèƒ½çš„å­˜å–å˜—è©¦
  - æ ¹æ“šç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºä»˜è²»ç‰†
  - ç”ŸæˆåŒ…å«å‡ç´šã€è©¦ç”¨ã€äº†è§£æ›´å¤šçš„Quick Replyé¸é …
  - è¨˜éŒ„ç”¨æˆ¶å°ä»˜è²»åŠŸèƒ½çš„èˆˆè¶£åº¦ä¾›å¾ŒçºŒè¡ŒéŠ·åƒè€ƒ
  - èˆ‡è¨ˆè²»ç³»çµ±é€£å‹•è™•ç†å‡ç´šæµç¨‹
- **èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•**:
  - **AMæ¨¡çµ„** `AM_checkSubscriptionStatus()` - é©—è­‰ç”¨æˆ¶è¨‚é–±ç‹€æ…‹
  - **WHæ¨¡çµ„** `WH_sendUpgradePrompt()` - ç™¼é€å‡ç´šæç¤ºè¨Šæ¯
  - **SRæ¨¡çµ„** `SR_validatePremiumFeature()` - æª¢æŸ¥åŠŸèƒ½æ¬Šé™
  - **DLæ¨¡çµ„** `DL_warning()` - è¨˜éŒ„ä»˜è²»åŠŸèƒ½å­˜å–å˜—è©¦
  - **FSæ¨¡çµ„** `FS_createUserInteraction()` - è¨˜éŒ„ä½¿ç”¨è€…äº’å‹•
- **å›å‚³å€¼**: `{upgradePrompt: boolean, trialOffered: boolean, redirectUrl: string, quickReplyOptions: array}`

---

## 4.0 Quick Reply æ¶æ§‹è¨­è¨ˆ

### 4.1 Quick Reply æŠ€è¡“å¯¦ä½œæ¶æ§‹

#### 4.1.1 æŠ€è¡“æ¶æ§‹åœ–
```
Quick Reply è™•ç†æµç¨‹ï¼š
ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ• â†’ WHæ¨¡çµ„æ¥æ”¶äº‹ä»¶ â†’ SR_handleQuickReplyInteraction() â†’ 
æ ¹æ“šé¡å‹è·¯ç”± â†’ è³‡æ–™è™•ç† â†’ SR_generateQuickReplyOptions() â†’ å›æ‡‰ç”Ÿæˆ â†’ 
WHæ¨¡çµ„ç™¼é€å›æ‡‰ â†’ ä½¿ç”¨è€…æ¥æ”¶
```

#### 4.1.2 Quick Reply é¡å‹åˆ†é¡
```javascript
const QuickReplyTypes = {
  STATISTICS: {
    TODAY: "today_stats",
    WEEK: "week_stats", 
    MONTH: "month_stats"
  },
  PAYWALL: {
    UPGRADE: "upgrade",
    TRIAL: "trial",
    LEARN_MORE: "learn_more"
  },
  SETTINGS: {
    REMINDER_CONFIG: "reminder_config",
    NOTIFICATION_SETTINGS: "notification_settings"
  }
};
```

### 4.2 WH-SR Quick Reply å”ä½œå”è­°

#### 4.2.1 è³‡æ–™äº¤æ›æ ¼å¼
```javascript
// WH â†’ SR æ¨™æº–æ ¼å¼
const quickReplyRequest = {
  userId: "string",
  interactionType: "statistics|paywall|settings",
  postbackData: "string", 
  timestamp: "ISO8601",
  replyToken: "string",
  contextData: {
    previousAction: "string",
    sessionId: "string",
    userPreferences: "object"
  }
};

// SR â†’ WH æ¨™æº–æ ¼å¼  
const quickReplyResponse = {
  success: "boolean",
  responseMessage: "string",
  quickReplyOptions: [
    {
      type: "action",
      action: {
        type: "postback",
        label: "string",
        data: "string",
        displayText: "string"
      }
    }
  ],
  sessionId: "string"
};
```

### 4.3 ä»˜è²»åŠŸèƒ½åœ¨ Quick Reply çš„æ•´åˆ

#### 4.3.1 å…è²»åŠŸèƒ½ Quick Reply é…ç½®
```javascript
const freeFeatureQuickReplies = {
  statistics: {
    today: {label: "ä»Šæ—¥çµ±è¨ˆ", action: "today_stats", paywall: false},
    week: {label: "æœ¬é€±çµ±è¨ˆ", action: "week_stats", paywall: false},
    month: {label: "æœ¬æœˆçµ±è¨ˆ", action: "month_stats", paywall: false}
  },
  basic_reminder: {
    create: {label: "æ–°å¢æé†’", action: "create_reminder", paywall: false, quota: true}
  }
};
```

#### 4.3.2 ä»˜è²»åŠŸèƒ½æ¨å»£ Quick Reply é…ç½®
```javascript
const paywallQuickReplies = {
  upgrade_options: [
    {label: "ç«‹å³å‡ç´š", action: "upgrade", url: "payment_url", priority: 1},
    {label: "å…è²»è©¦ç”¨", action: "trial", paywall: false, priority: 2},
    {label: "äº†è§£æ›´å¤š", action: "learn_more", paywall: false, priority: 3}
  ],
  trial_conditions: {
    max_trial_days: 7,
    trial_features: ["daily_summary", "budget_warning"],
    trial_quota: {reminders: 5, reports: 2}
  }
};
```

---

## 5.0 æ¨¡çµ„é–“äº’å‹•æ¶æ§‹

### 5.1 æ ¸å¿ƒä¾è³´é—œä¿‚
```
SR æ’ç¨‹æé†’æ¨¡çµ„ (v1.2)
â”œâ”€â”€ FSæ¨¡çµ„ (Firestore Service)
â”‚   â”œâ”€â”€ FS_createDocument() - å»ºç«‹æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_updateDocument() - æ›´æ–°æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_deleteDocument() - åˆªé™¤æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_getDocument() - å–å¾—æ’ç¨‹è¨­å®š
â”‚   â”œâ”€â”€ FS_queryUserData() - æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™
â”‚   â”œâ”€â”€ FS_batchUpdate() - æ‰¹æ¬¡æ›´æ–°è³‡æ–™
â”‚   â”œâ”€â”€ FS_getUserPreferences() - å–å¾—ä½¿ç”¨è€…åå¥½ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ FS_createUserInteraction() - è¨˜éŒ„ä½¿ç”¨è€…äº’å‹•ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ WHæ¨¡çµ„ (Webhookè™•ç†)
â”‚   â”œâ”€â”€ WH_sendPushMessage() - ç™¼é€æ¨æ’­è¨Šæ¯
â”‚   â”œâ”€â”€ WH_sendQuickReply() - ç™¼é€Quick Replyå›æ‡‰ï¼ˆæ“´å……ï¼‰
â”‚   â”œâ”€â”€ WH_sendUpgradePrompt() -### 5.2 è³‡æ–™æµå‘è¨­è¨ˆ
```
æ¨™æº–æ’ç¨‹è§¸ç™¼ â†’ SRæ’ç¨‹é©—è­‰ â†’ ä»˜è²»åŠŸèƒ½æª¢æŸ¥ â†’ æ¢ä»¶åˆ¤æ–· â†’ 
åŸ·è¡Œå‹•ä½œ â†’ çµæœè™•ç† â†’ è·¨æ¨¡çµ„åŒæ­¥ â†’ æ—¥èªŒè¨˜éŒ„ â†’ å®Œæˆå›æ‡‰

Quick Replyè™•ç† â†’ WHäº‹ä»¶æ¥æ”¶ â†’ SR_handleQuickReplyInteraction() â†’ 
é¡å‹åˆ¤æ–· â†’ æ¬Šé™æª¢æŸ¥ â†’ è³‡æ–™è™•ç† â†’ SR_generateQuickReplyOptions() â†’ 
å›æ‡‰ç”Ÿæˆ â†’ WHç™¼é€å›æ‡‰ â†’ ä½¿ç”¨è€…æ¥æ”¶
```

---

## 6.0 è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ

### 6.1 FSæ¨¡çµ„é›†åˆçµæ§‹éœ€æ±‚
```
scheduled_reminders/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {reminder_id}/
â”‚   â”œâ”€â”€ userId: string (ç´¢å¼•)
â”‚   â”œâ”€â”€ reminderType: "daily" | "weekly" | "monthly" | "custom"
â”‚   â”œâ”€â”€ cronExpression: string
â”‚   â”œâ”€â”€ timezone: "Asia/Taipei"
â”‚   â”œâ”€â”€ isActive: boolean
â”‚   â”œâ”€â”€ reminderData: object
â”‚   â”‚   â”œâ”€â”€ subjectCode: string
â”‚   â”‚   â”œâ”€â”€ amount: number
â”‚   â”‚   â”œâ”€â”€ paymentMethod: string
â”‚   â”‚   â””â”€â”€ message: string
â”‚   â”œâ”€â”€ conditions: object
â”‚   â”‚   â”œâ”€â”€ skipWeekends: boolean
â”‚   â”‚   â”œâ”€â”€ holidayHandling: "skip" | "advance" | "delay"
â”‚   â”‚   â””â”€â”€ customConditions: array
â”‚   â”œâ”€â”€ execution: object
â”‚   â”‚   â”œâ”€â”€ lastExecuted: timestamp (UTC+8)
â”‚   â”‚   â”œâ”€â”€ nextExecution: timestamp (UTC+8)
â”‚   â”‚   â”œâ”€â”€ executionCount: number
â”‚   â”‚   â””â”€â”€ failureCount: number
â”‚   â”œâ”€â”€ createdAt: timestamp (UTC+8)
â”‚   â”œâ”€â”€ updatedAt: timestamp (UTC+8)
â”‚   â””â”€â”€ metadata: object

user_quotas/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {user_id}/
â”‚   â”œâ”€â”€ reminderQuota: number
â”‚   â”œâ”€â”€ usedReminders: number
â”‚   â”œâ”€â”€ subscriptionLevel: "free" | "premium"
â”‚   â”œâ”€â”€ lastQuotaReset: timestamp (UTC+8)
â”‚   â””â”€â”€ quotaHistory: array

holiday_calendar/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {year}/
â”‚   â”œâ”€â”€ holidays: array
â”‚   â”‚   â”œâ”€â”€ date: string (YYYY-MM-DD)
â”‚   â”‚   â”œâ”€â”€ name: string
â”‚   â”‚   â””â”€â”€ type: "national" | "religious" | "custom"
â”‚   â”œâ”€â”€ updatedAt: timestamp (UTC+8)
â”‚   â””â”€â”€ source: string

scheduler_logs/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {log_id}/
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ reminderId: string
â”‚   â”œâ”€â”€ activityType: string
â”‚   â”œâ”€â”€ activityData: object
â”‚   â”œâ”€â”€ result: object
â”‚   â”œâ”€â”€ timestamp: timestamp (UTC+8)
â”‚   â””â”€â”€ logLevel: "info" | "warning" | "error"
```

### 6.2 ä»˜è²»åŠŸèƒ½æ¬Šé™è¨­è¨ˆ
```javascript
premiumFeatures: {
  dailyFinancialSummary: {
    level: "premium",
    quotaLimited: false,
    description: "æ¯æ—¥è²¡å‹™æ‘˜è¦æ¨æ’­"
  },
  budgetWarning: {
    level: "premium", 
    quotaLimited: false,
    description: "é ç®—è­¦å‘Šé€šçŸ¥"
  },
  monthlyReport: {
    level: "premium",
    quotaLimited: false,
    description: "æœˆåº¦è²¡å‹™å ±å‘Š"
  },
  unlimitedReminders: {
    level: "premium",
    quotaLimited: false,
    description: "ç„¡é™åˆ¶æé†’è¨­å®š"
  }
}

freeFeatures: {
  basicReminder: {
    level: "free",
    quotaLimited: true,
    maxCount: 2,
    description: "åŸºç¤æé†’è¨­å®š"
  },
  quickReplyStatistics: {
    level: "free",
    quotaLimited: false,
    description: "Quick Replyçµ±è¨ˆæŸ¥è©¢"
  },
  manualStatistics: {
    level: "free",
    quotaLimited: false,
    description: "æ‰‹å‹•çµ±è¨ˆæŸ¥è©¢"
  }
}
```

### 6.3 Quick Reply è³‡æ–™çµæ§‹

```
quick_reply_sessions/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {session_id}/
â”‚   â”œâ”€â”€ userId: string (ç´¢å¼•)
â”‚   â”œâ”€â”€ sessionType: "statistics" | "paywall" | "settings"
â”‚   â”œâ”€â”€ contextData: object
â”‚   â”‚   â”œâ”€â”€ currentFeature: string
â”‚   â”‚   â”œâ”€â”€ previousAction: string
â”‚   â”‚   â”œâ”€â”€ userPreferences: object
â”‚   â”‚   â””â”€â”€ interactionHistory: array
â”‚   â”œâ”€â”€ availableOptions: array
â”‚   â”‚   â”œâ”€â”€ optionId: string
â”‚   â”‚   â”œâ”€â”€ label: string
â”‚   â”‚   â”œâ”€â”€ action: string
â”‚   â”‚   â”œâ”€â”€ paywall: boolean
â”‚   â”‚   â””â”€â”€ priority: number
â”‚   â”œâ”€â”€ lastInteraction: timestamp (UTC+8)
â”‚   â”œâ”€â”€ expiryTime: timestamp (UTC+8)
â”‚   â”œâ”€â”€ isActive: boolean
â”‚   â””â”€â”€ metadata: object

user_interactions/ (é€éFSæ¨¡çµ„ç®¡ç†)
â”œâ”€â”€ {interaction_id}/
â”‚   â”œâ”€â”€ userId: string (ç´¢å¼•)
â”‚   â”œâ”€â”€ interactionType: "quick_reply" | "paywall" | "upgrade"
â”‚   â”œâ”€â”€ featureName: string
â”‚   â”œâ”€â”€ actionTaken: string
â”‚   â”œâ”€â”€ subscriptionLevel: "free" | "premium"
â”‚   â”œâ”€â”€ conversionResult: boolean
â”‚   â”œâ”€â”€ timestamp: timestamp (UTC+8)
â”‚   â””â”€â”€ contextData: object
```

---

## 7.0 API ä»‹é¢è¦æ ¼

### 7.1 REST API ç«¯é»
```
POST   /api/v2/scheduler/reminder/create      - å»ºç«‹æ’ç¨‹æé†’
PUT    /api/v2/scheduler/reminder/{id}/update - æ›´æ–°æ’ç¨‹è¨­å®š
DELETE /api/v2/scheduler/reminder/{id}/delete - åˆªé™¤æ’ç¨‹æé†’
GET    /api/v2/scheduler/reminder/{id}        - æŸ¥è©¢æ’ç¨‹è¨­å®š
GET    /api/v2/scheduler/reminders/user/{uid} - æŸ¥è©¢ä½¿ç”¨è€…æ’ç¨‹æ¸…å–®
POST   /api/v2/scheduler/execute/{id}         - æ‰‹å‹•åŸ·è¡Œæ’ç¨‹
GET    /api/v2/scheduler/statistics/quick     - Quick Replyçµ±è¨ˆ
POST   /api/v2/scheduler/push/daily           - æ¯æ—¥æ¨æ’­è¨­å®š
POST   /api/v2/scheduler/push/budget          - é ç®—è­¦å‘Šè¨­å®š
POST   /api/v2/scheduler/push/monthly         - æœˆåº¦å ±å‘Šè¨­å®š
GET    /api/v2/scheduler/quota/user/{uid}     - æŸ¥è©¢ä½¿ç”¨è€…é…é¡
GET    /api/v2/scheduler/health               - æ’ç¨‹å™¨å¥åº·æª¢æŸ¥
POST   /api/v2/scheduler/quickreply/handle    - è™•ç†Quick Replyäº’å‹•ï¼ˆæ–°å¢ï¼‰
GET    /api/v2/scheduler/quickreply/options   - å–å¾—Quick Replyé¸é …ï¼ˆæ–°å¢ï¼‰
POST   /api/v2/scheduler/paywall/interact     - è™•ç†ä»˜è²»åŠŸèƒ½ç‰†äº’å‹•ï¼ˆæ–°å¢ï¼‰
```

### 7.2 Cron è¡¨é”å¼è¨­è¨ˆ
```javascript
cronExpressions: {
  daily: "0 21 * * *",           // æ¯æ—¥21:00
  weekly: "0 21 * * 0",          // æ¯é€±æ—¥21:00
  monthly: "0 21 1 * *",         // æ¯æœˆ1æ—¥21:00
  custom: "0 {hour} {day} {month} {weekday}" // è‡ªè¨‚æ™‚é–“
}

timezoneHandling: {
  default: "Asia/Taipei",
  format: "UTC+8",
  holidayCheck: true,
  weekendCheck: true
}
```

---

## 8.0 æ’ç¨‹å¼•æ“è¨­è¨ˆ

### 8.1 æ’ç¨‹ä»»å‹™ç®¡ç†
```javascript
const cron = require('node-cron');

// ä¸»è¦æ’ç¨‹ä»»å‹™
const schedulerTasks = {
  // æ¯åˆ†é˜æª¢æŸ¥åˆ°æœŸçš„æ’ç¨‹
  minutelyCheck: cron.schedule('* * * * *', () => {
    SR_checkPendingReminders();
  }),

  // æ¯æ—¥21:00åŸ·è¡Œä»˜è²»ç”¨æˆ¶æ¨æ’­
  dailyPush: cron.schedule('0 21 * * *', () => {
    SR_processDailyPushNotifications();
  }),

  // æ¯é€±æ—¥21:00åŸ·è¡Œé€±å ±
  weeklyReport: cron.schedule('0 21 * * 0', () => {
    SR_processWeeklyReports();
  }),

  // æ¯æœˆ1æ—¥21:00åŸ·è¡Œæœˆå ±
  monthlyReport: cron.schedule('0 21 1 * *', () => {
    SR_processMonthlyReports();
  }),

  // æ¯æ—¥å‡Œæ™¨2:00æ¸…ç†éæœŸè³‡æ–™
  dailyCleanup: cron.schedule('0 2 * * *', () => {
    SR_cleanupExpiredData();
  }),

  // æ¯10åˆ†é˜æ¸…ç†éæœŸQuick Replyæœƒè©±ï¼ˆæ–°å¢ï¼‰
  quickReplyCleanup: cron.schedule('*/10 * * * *', () => {
    SR_cleanupExpiredQuickReplySessions();
  })
};
```

### 8.2 æ™‚å€å’Œå‡æ—¥è™•ç†
```javascript
const moment = require('moment-timezone');

// æ™‚å€è½‰æ›
function convertToUserTimezone(timestamp, timezone = 'Asia/Taipei') {
  return moment(timestamp).tz(timezone);
}

// å‡æ—¥æª¢æŸ¥
function isHoliday(date) {
  // é€éFSæ¨¡çµ„æŸ¥è©¢å‡æ—¥è³‡æ–™
  return FS_checkHolidayCalendar(date);
}

// é€±æœ«æª¢æŸ¥
function isWeekend(date) {
  const dayOfWeek = moment(date).day();
  return dayOfWeek === 0 || dayOfWeek === 6; // 0=é€±æ—¥, 6=é€±å…­
}
```

---

## 9.0 ä»˜è²»åŠŸèƒ½æ§åˆ¶æ©Ÿåˆ¶

### 9.1 åŠŸèƒ½æ¬Šé™é©—è­‰æµç¨‹
```javascript
async function validateFeatureAccess(userId, featureName) {
  // 1. å–å¾—ä½¿ç”¨è€…è³‡è¨Š
  const userInfo = await AM_getUserInfo(userId);

  // 2. æª¢æŸ¥è¨‚é–±ç‹€æ…‹
  const subscription = await AM_checkSubscriptionStatus(userId);

  // 3. é©—è­‰åŠŸèƒ½æ¬Šé™
  const hasPermission = subscription.level === 'premium' || 
                       freeFeatures[featureName];

  // 4. æª¢æŸ¥é…é¡é™åˆ¶
  if (hasPermission && freeFeatures[featureName]?.quotaLimited) {
    const quota = await FS_getUserQuota(userId);
    hasPermission = quota.usedReminders < freeFeatures[featureName].maxCount;
  }

  return {
    hasPermission,
    subscriptionLevel: subscription.level,
    quotaExceeded: !hasPermission && freeFeatures[featureName]?.quotaLimited
  };
}
```

### 9.2 åŠŸèƒ½é™ç´šè™•ç†
```javascript
async function handleFeatureDowngrade(userId, expiredFeatures) {
  // 1. åœç”¨ä»˜è²»åŠŸèƒ½
  await SR_disablePremiumFeatures(userId, expiredFeatures);

  // 2. èª¿æ•´æ’ç¨‹è¨­å®š
  await SR_adjustSchedulesForFreeUser(userId);

  // 3. ç™¼é€é™ç´šé€šçŸ¥
  await WH_sendFeatureDowngradeNotification(userId, expiredFeatures);

  // 4. è¨˜éŒ„é™ç´šæ“ä½œ
  await DL_log(`åŠŸèƒ½é™ç´šåŸ·è¡Œå®Œæˆ`, 'FEATURE_DOWNGRADE', userId);
}
```

---

## 10.0 éŒ¯èª¤è™•ç†èˆ‡ç›£æ§

### 10.1 éŒ¯èª¤é¡å‹å®šç¾©
```javascript
const ErrorTypes = {
  SCHEDULER_TIMEOUT: 'scheduler_timeout',
  PERMISSION_DENIED: 'permission_denied',
  QUOTA_EXCEEDED: 'quota_exceeded',
  EXTERNAL_API_ERROR: 'external_api_error',
  DATABASE_ERROR: 'database_error',
  VALIDATION_ERROR: 'validation_error',
  HOLIDAY_PROCESSING_ERROR: 'holiday_processing_error',
  QUICK_REPLY_SESSION_EXPIRED: 'qr_session_expired', // æ–°å¢
  QUICK_REPLY_INVALID_OPTION: 'qr_invalid_option', // æ–°å¢
  PAYWALL_BLOCKED: 'paywall_blocked', // æ–°å¢
  RATE_LIMITED: 'rate_limited' // æ–°å¢
};
```

### 10.2 é‡è©¦æ©Ÿåˆ¶è¨­è¨ˆ
```javascript
async function executeWithRetry(operation, maxRetries = 3, delay = 1000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      if (attempt === maxRetries) {
        throw error;
      }

      await new Promise(resolve => setTimeout(resolve, delay * attempt));
      await DL_warning(`é‡è©¦ç¬¬ ${attempt} æ¬¡: ${error.message}`);
    }
  }
}
```

### 10.3 å¥åº·ç›£æ§æ©Ÿåˆ¶
```javascript
async function SR_monitorSystemHealth() {
  const healthMetrics = {
    activeReminders: await FS_countActiveReminders(),
    pendingExecutions: await FS_countPendingExecutions(),
    failedExecutions: await FS_countFailedExecutions(),
    quickReplySessions: await FS_countActiveQuickReplySessions(), // æ–°å¢
    paywallInteractions: await FS_countPaywallInteractions(), // æ–°å¢
    systemUptime: process.uptime(),
    memoryUsage: process.memoryUsage(),
    cronJobsStatus: getCronJobsStatus()
  };

  // æª¢æŸ¥å¥åº·ç‹€æ…‹
  const isHealthy = healthMetrics.failedExecutions < 10 && 
                   healthMetrics.memoryUsage.heapUsed < 500 * 1024 * 1024 &&
                   healthMetrics.quickReplySessions < 1000; // æ–°å¢æª¢æŸ¥

  if (!isHealthy) {
    await DL_error('æ’ç¨‹ç³»çµ±å¥åº·ç‹€æ…‹ç•°å¸¸', 'SYSTEM_HEALTH_ALERT', 'SYSTEM');
  }

  return { healthy: isHealthy, metrics: healthMetrics };
}
```

---

## 11.0 æ•ˆèƒ½æœ€ä½³åŒ–

### 11.1 å¿«å–ç­–ç•¥
```javascript
const NodeCache = require('node-cache');

const cacheConfig = {
  userPermissions: new NodeCache({ stdTTL: 600 }), // 10åˆ†é˜
  holidayCalendar: new NodeCache({ stdTTL: 86400 }), // 24å°æ™‚
  userQuotas: new NodeCache({ stdTTL: 300 }), // 5åˆ†é˜
  schedulerStatus: new NodeCache({ stdTTL: 60 }), // 1åˆ†é˜
  quickReplyOptions: new NodeCache({ stdTTL: 180 }), // 3åˆ†é˜ï¼ˆæ–°å¢ï¼‰
  paywallConfig: new NodeCache({ stdTTL: 1800 }) // 30åˆ†é˜ï¼ˆæ–°å¢ï¼‰
};
```

### 11.2 æ‰¹æ¬¡è™•ç†å„ªåŒ–
```javascript
async function processBatchReminders(reminders) {
  const batchSize = 50;
  const batches = [];

  for (let i = 0; i < reminders.length; i += batchSize) {
    batches.push(reminders.slice(i, i + batchSize));
  }

  for (const batch of batches) {
    await Promise.all(batch.map(reminder => 
      SR_executeScheduledTask(reminder.id, reminder.context)
    ));

    // æ‰¹æ¬¡é–“å»¶é²ï¼Œé¿å…ç³»çµ±éè¼‰
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

// Quick Reply æ‰¹æ¬¡è™•ç†å„ªåŒ–ï¼ˆæ–°å¢ï¼‰
async function processBatchQuickReplies(interactions) {
  const batchSize = 20;
  const batches = [];

  for (let i = 0; i < interactions.length; i += batchSize) {
    batches.push(interactions.slice(i, i + batchSize));
  }

  for (const batch of batches) {
    await Promise.all(batch.map(interaction => 
      SR_handleQuickReplyInteraction(
        interaction.userId, 
        interaction.type, 
        interaction.data, 
        interaction.context
      )
    ));

    // æ‰¹æ¬¡é–“å»¶é²
    await new Promise(resolve => setTimeout(resolve, 50));
  }
}