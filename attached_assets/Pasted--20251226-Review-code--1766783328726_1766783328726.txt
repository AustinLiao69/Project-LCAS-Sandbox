------------------------------------------
20251226.科目與支付方式歸類邏輯一次性互動方案(Review中)

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

根據你的回覆，我重新分析並更新提案：
Debug分析報告更新版

A. 快速摘要（≤3句）
•	同義詞學習機制失敗：支付方式確認後，系統無法正確學習並儲存同義詞（如"富邦"→"信用卡"，"中信"→現金/信用卡等），導致重複輸入時仍觸發歧義消除。
•	Pending Record狀態管理錯誤：完成記帳時，系統錯誤檢查科目選擇狀態，明明只需要錢包確認的流程卻要求科目資訊，違反了0098規範。
•	錯誤處理不當：LBK模組返回的錯誤訊息格式不符合統一標準，導致用戶看到技術性錯誤而非友好提示。
________________________________________
B. Root causes（最多 6 條）
1. 同義詞學習功能完全失效
證據：
[2025-12-26T09:02:38.346Z] [WARNING] [DL] 無法匹配輸入格式: "中信" [42366a6b] [Code: WARNING] [Location: LBK_parseInputFormat]
[2025-12-26T09:02:38.348Z] [WARNING] [DL] 階段一修復：無法從原始輸入中提取支付方式名稱: "中信"，跳過同義詞學習 [42366a6b]
發生機率：100%
解決方案：修復LBK_executeWalletSynonymsUpdate函數，確保能正確處理單獨的支付方式關鍵字（如"中信"、"富邦"）並更新到wallets子集合的synonyms欄位。

2. Pending Record狀態檢查邏輯錯誤
證據：
[2025-12-26T09:02:38.357Z] [ERROR] [DL] 階段一修復：科目選擇狀態檢查失敗 - electedCategory存在: false, categorySelected: false
[2025-12-26T09:02:38.358Z] [ERROR] [DL] 階段四：完成Pending Record失敗: Error: 階段一修復：Pending Record 缺少科目資訊，electedCategory: false, categorySelected: false (違反0098規範)
發生機率：100%
解決方案：修復LBK_completePendingRecord函數的狀態檢查邏輯，當processingStage為PENDING_WALLET且walletSelected為true時，應該直接進行記帳，不需要檢查科目狀態。
你的推斷基本正確，但需要澄清：Pending Record建立時機確實是在用戶輸入解析後，但重點是科目歸類邏輯完成後，系統未正確更新Pending Record的stageData，導致categorySelected仍為false。問題不在synonyms配對，而在狀態更新機制失效。

3. 記憶體Session與Firestore資料不一致
證據：
[2025-12-26T09:02:35.505Z] [INFO] [DL] 階段三：記憶體Pending Session創建成功: 1766739755505 (不寫入Firestore)
發生機率：100%
解決方案：檢查LBK_createPendingRecord函數，確保Pending Record在記憶體中創建後，相關的科目和錢包資訊能正確傳遞到後續處理階段。
澄清記憶體創建機制：從LBK模組代碼中可看出，階段三優化採用了記憶體Session快取機制（LBK_CONFIG.MEMORY_SESSIONS），Pending Record首先在記憶體中創建並處理，只有完成後才寫入Firestore的transactions子集合。這是為了減少Firestore寫入量的優化策略，但導致狀態同步問題。

4. 錯誤訊息格式化不當
證據：控制台顯示"記帳完成失敗，請稍後再試"這種通用錯誤訊息，不符合LBK統一回應標準
發生機率：100%
解決方案：修復LBK_formatReplyMessage函數，確保所有錯誤情況都返回符合0070規範的7行詳細錯誤格式。

5. 科目解析狀態未正確保存
證據：從日誌看出，"尿布"科目應該在首次解析時已確定，但Pending Record中categorySelected始終為false
發生機率：90%
解決方案：檢查LBK_parseUserMessage和LBK_createPendingRecord的整合，確保科目解析成功時正確設置stageData.categorySelected = true。

________________________________________
核心Insight
真正的問題是狀態機轉換邏輯不完整：
1.	**首次輸入"尿布55555富邦"**時，科目"尿布"被正確識別並完成科目歸類，但系統未正確更新Pending Record的categorySelected狀態。
2.	再次輸入相同內容時，系統誤判為需要重新進行歧義消除，因為記憶體Session中的狀態資訊丟失或未正確保存。
3.	核心問題：記憶體Session優化機制與Firestore持久化之間的狀態同步機制有缺陷，導致科目確認後的狀態更新無法正確傳遞到完成記帳階段。
這不是單純的同義詞學習問題，而是整個Pending Record生命週期管理機制的設計缺陷。