------------------------------------------
20251028. userId生成

不要寫code，請根據我的回覆更新提案。現在是MVP階段，提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

=>7598不應該預設userId，而是預設一個email，然後啟動使用者註冊流程，遵照0098規範的dataflow傳到AM去產生一個userId。
=>請根據你下面的解釋，結合上面我說的7598，去生成一個解決方案。


根據您提到的用戶註冊和跨平台映射問題，我來分析目前的架構和提出解決方案：

1. Email註冊用戶的UID映射機制
目前在 1309. AM.js 中，Email註冊時動態生成的 userId 會透過以下機制進行映射：
// 在 AM_processAPIRegister 中
const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
// 建立用戶資料
const userData = {
  email: requestData.email,  // 這是關鍵的映射字段
  displayName: requestData.displayName || '',
  // ... 其他資料
};
// 同時建立帳號映射記錄
const mappingData = {
  primary_UID: userId,
  platform_accounts: {
    LINE: "",
    iOS: "",
    Android: "",
  },
  email: requestData.email,  // Email作為查詢索引
  created_at: admin.firestore.Timestamp.now(),
};
await db.collection("account_mappings").doc(userId).set(mappingData);
映射邏輯：
•	主鍵：動態生成的 userId
•	映射索引：用戶的 email 地址
•	查詢方式：透過 AM_validateAccountExists(email, "email") 查詢

2. LINE ID的跨平台映射機制
當同一用戶使用LINE記帳時，系統會透過 AM_processAPIBindLine 進行帳號綁定：
// 在 AM_processAPIBindLine 中
const bindResult = await AM_linkCrossPlatformAccounts(requestData.userId, {
  LINE_UID: lineProfile.userId,  // LINE提供的用戶ID
});
// AM_linkCrossPlatformAccounts 會更新兩個地方：
// 1. users collection
await db.collection("users").doc(primaryUID).update({
  linkedAccounts: {
    ...userData.linkedAccounts,
    LINE_UID: lineProfile.userId
  }
});
// 2. account_mappings collection  
await db.collection("account_mappings").doc(primaryUID).update({
  platform_accounts: {
    LINE: lineProfile.userId,
    iOS: "",
    Android: ""
  }
});

3. 完整的用戶識別架構
13. Replit_Module code_BL/1309. AM.js
強化用戶映射機制說明註解

4. 實際的映射流程
用戶註冊流程：
Email註冊 → 生成userId → 建立users/{userId} → 建立account_mappings/{userId}
                ↓
        email作為查詢索引
LINE綁定流程：
LINE OAuth → 取得LINE_UID → 查詢existing user by email → 更新linkedAccounts
                ↓
    users/{userId}.linkedAccounts.LINE_UID = LINE_UID
    account_mappings/{userId}.platform_accounts.LINE = LINE_UID
查詢流程：
輸入：Email或LINE_UID → AM_validateAccountExists() → 返回：primary_UID
                            ↓
               查詢account_mappings collection
               支援多種平台ID反查到同一個用戶
               
5. 資料結構範例
Firebase 資料結構：
// users/{primary_UID}
{
  "email": "user@example.com",
  "displayName": "張三",
  "linkedAccounts": {
    "LINE_UID": "U1234567890abcdef",
    "iOS_UID": "",
    "Android_UID": ""
  }
}
// account_mappings/{primary_UID}  
{
  "primary_UID": "user_1698123456789_abc123def",
  "email": "user@example.com",
  "platform_accounts": {
    "LINE": "U1234567890abcdef",
    "iOS": "",
    "Android": ""
  }
}
這個設計確保了：
1.	Email註冊用戶透過email能查詢到對應的userId
2.	LINE用戶透過LINE_UID能查詢到相同的userId
3.	跨平台統一：不同平台都映射到同一個primary_UID
4.	資料一致性：透過account_mappings維護所有平台的映射關係

