[WH 2.0.16 LOG] WH 2.0.7: 收到LINE Webhook請求 [f0ae927f] (INFO)
檢測到需要回覆的訊息，啟用同步處理 [f0ae927f]
[WH 2.0.16 LOG] WH 2.0.16: 檢測到需要回覆的訊息，啟用同步處理 [f0ae927f] (INFO)
開始非同步處理請求 [f0ae927f]
[WH 2.0.16 LOG] WH 2.0.7: 開始非同步處理請求 [f0ae927f] (INFO)
[WH 2.0.16 LOG] WH 2.0.3: 開始處理事件: message [f0ae927f] (INFO)
處理消息事件: text [f0ae927f]
收到文本消息: "馬戲團" [f0ae927f]
[WH 2.0.16 LOG] WH 2.0.3: 收到文本消息: "馬戲團" [f0ae927f] (INFO)
準備訊息數據: {"text":"馬戲團","userId":"Uae47d9d496e4596d70ed724a7d6e2948","timestamp":1752473089501,"replyToken":"9d4f667c83354a11b7a6c6bfc35b8c51"} [f0ae927f]
使用標準路徑處理複雜訊息 [f0ae927f]
[WH 2.0.16 LOG] WH 2.0.17: 使用標準路徑調用DD_distributeData [f0ae927f] (INFO)
=== DD_distributeData執行初始檢查 ===
DD_MAX_RETRIES: 3
DD_RETRY_DELAY: 1000
DD_TARGET_MODULE_BK: BK
DD_TARGET_MODULE_WH: WH
DD_distributeData被調用，數據源: LINE, 用戶ID: Uae47d9d496e4596d70ed724a7d6e2948, 時間: 2025-07-14T06:04:50.462Z
處理ID: b634a4dc
[INFO] [DD] 開始處理數據 [b634a4dc]
標準化用戶ID: userId -> user_id = Uae47d9d496e4596d70ed724a7d6e2948
調整數據來源從「LINE」到「使用者訊息」
處理數據: {"text":"馬戲團","userId":"Uae47d9d496e4596d70ed724a7d6e2948","timestamp":1752473089501,"replyToken":"9..., 來源: 使用者訊息
處理時間戳: 1752473089501
開始轉換時間戳: 1752473089501 [fcee4929]
時間戳轉換結果: 2025/7/14 06:04 [fcee4929]
時間戳轉換結果: 2025/7/14 06:04
處理用戶訊息: "馬戲團"
[INFO] [DD] 處理用戶訊息: "馬戲團"
[INFO] [DD] 處理用戶消息: "馬戲團" (帳本: user_Uae47d9d496e4596d70ed724a7d6e2948)
DD_processUserMessage: 開始處理用戶訊息 "馬戲團" [c30aae85]
DD2模組配置初始化 - Firestore版本
DD_processUserMessage: 清理後訊息: "馬戲團" [c30aae85]
DD_parseInputFormat: 開始解析文本「馬戲團」[c30aae85]
DD_parseInputFormat: 無法解析格式 [c30aae85]
DD_processUserMessage: DD_parseInputFormat回傳結果: {"_formatError":true,"_errorDetail":"無法識別輸入格式","errorData":{"success":false,"error":"無法識別輸入格式","errorType":"UNRECOGNIZED_FORMAT","partialData":{"subject":"馬戲團","amount":0,"rawAmount":"0","paymentMethod":"預設"}}} [c30aae85]
DD_processUserMessage: 成功解析基本資訊 - 科目="undefined", 金額=undefined, 支付方式=未指定 [c30aae85]
DD_processUserMessage: 科目為空 [c30aae85]
DD_processUserMessage返回: {"type":"記帳","processed":false,"reason":"未指定科目","processId":"c30aae85","errorType":"MISSING_SUBJECT","errorData":{"success":false,"error":"未指定科目","errorType":"MISSING_SUBJECT","message":"記帳失敗: 未指定科目","errorDetails":{"processId":"c30aae85","errorType":"VALIDATION_ERROR","module":"DD2"},"isRetryable":true,"partialData":{"subject":"","rawAmount":"undefined","timestamp":1752473090751}}}
訊息解析失敗: 未指定科目
[WARNING] [DD] 訊息解析失敗: 未指定科目
DD_distributeData處理完成，結果預覽: {"success":false,"hasResponseMessage":true,"responseMsgLength":78,"errorType":"MESSAGE_PARSE_ERROR","moduleCode":"DD","hasPartialData":true} [f0ae927f]
partialData內容: {} [f0ae927f]
檢測到未格式化的結果，強制使用 BK_formatSystemReplyMessage [f0ae927f]
[2025-07-14T06:04:50.881Z] [DEBUG] [BK] 開始格式化訊息 [f0ae927f], 模組: WH | 訊息格式化 | Uae47d9d496e4596d70ed724a7d6e2948 | BK_formatSystemReplyMessage
[2025-07-14T06:04:50.881Z] [DEBUG] [BK] 使用現有回覆訊息 [f0ae927f] | 訊息格式化 | Uae47d9d496e4596d70ed724a7d6e2948 | BK_formatSystemReplyMessage
[WH 2.0.16 LOG] WH 2.0.17: 強制格式化未驗證的訊息 [f0ae927f] (WARNING)
準備回覆已驗證的訊息 [f0ae927f]
WH_replyMessage: 拒絕未經 BK_formatSystemReplyMessage 格式化的訊息
[WH 2.0.16 LOG] WH 2.0.19: 拒絕未經格式化的訊息，moduleCode=WH, module=未定義 (ERROR)
訊息回覆結果: {"success":false,"error":"訊息格式不符合規範"} [f0ae927f]
非同步處理完成，已清理數據 [f0ae927f]
[WH 2.0.16 LOG] WH 2.0.7: 非同步處理完成 [f0ae927f] (INFO)