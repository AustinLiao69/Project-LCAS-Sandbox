📊 SR模組架構問題分析與改善計劃
我將針對您提出的關鍵問題進行詳細分析和改善建議：

🛡■ 1. 假日處理API依賴風險強化計劃
現況問題分析
單點故障風險：完全依賴政府開放資料API，網路中斷或API服務異常時整個假日處理功能失效
回應時間不穩定：外部API調用增加延遲，影響排程執行效能
資料同步問題：假日資料更新時機不可控，可能出現資料不一致
強化離線備案機制計劃
多層級備案架構

第一層：政府開放資料API（主要來源）
第二層：Firestore快取資料（24小時有效期）
第三層：內建假日清單（硬編碼備案）
第四層：智慧推算機制（基於歷史規律）

預載入機制

系統啟動時預先載入當年度和次年度假日資料
設定定時任務每週自動更新假日快取
建立假日資料驗證機制，確保資料完整性

降級策略

API失敗時自動切換到快取資料
快取過期時使用內建清單
完全離線時採用保守策略（僅處理週末）
=>目前先不要改變



🧠 2. Cron Job記憶體洩漏風險分析與解決方案
現有狀況問題
記憶體累積：每次建立新的cron job都會在SR_INIT_STATUS.activeSchedules Map中添加記錄，但刪除或更新時可能清理不完全
模組重啟風險：服務重啟時舊的cron job實例仍在記憶體中運行，但新的模組實例無法管理這些舊job
資源洩漏：長期運行下來會累積大量無效的cron job實例，消耗系統資源
具體問題場景
用戶刪除提醒時，cron job停止了但Map記錄可能殘留
服務異常重啟時，記憶體中的activeSchedules被清空，但底層cron job可能仍在運行
更新提醒設定時，舊job停止但新job創建失敗，導致狀態不一致
修改計劃
生命週期管理強化

實作cron job註冊表，追蹤所有活躍的job狀態
增加job健康檢查機制，定期驗證job是否正常運行
建立job清理機制，定期清理無效或過期的job

模組重啟恢復機制

啟動時檢查Firestore中的活躍提醒，重新建立對應的cron job
實作job狀態同步機制，確保記憶體狀態與資料庫一致
增加優雅關閉流程，模組關閉時正確停止所有cron job
記憶體監控機制

定期監控activeSchedules Map的大小
實作記憶體洩漏偵測，當Map大小異常時觸發清理
增加效能監控，追蹤cron job的執行狀況和資源使用
=>目前先不要改變




🏗■ 3. 架構層面改善：依賴注入與配置管理
現有狀況問題
硬編碼依賴：使用require()直接載入模組，造成強耦合
配置分散：SR_CONFIG.MAX_FREE_REMINDERS、時區設定等散落各處
測試困難：硬依賴使得單元測試難以進行模組隔離
發生的問題
模組替換困難：無法輕易替換依賴模組進行測試或升級
配置管理混亂：相同類型的配置參數散落在不同函數中
環境適應性差：開發、測試、生產環境難以使用不同配置

修改計劃
依賴注入容器設計

建立SR模組依賴注入容器，統一管理所有外部依賴
實作介面抽象層，讓各模組依賴介面而非具體實作
支援依賴的動態注入和替換

統一配置管理

建立SR_Config類別，集中管理所有配置參數
支援環境變數和配置檔案兩種配置方式
實作配置驗證和預設值機制
模組初始化重構
改善模組啟動流程，支援依賴檢查和降級啟動
實作模組健康檢查機制
增加模組狀態監控和異常恢復
=>這個OK，請下去實行

■ 4. 效能層面：快取機制強化
現有狀況問題
重複查詢：每次驗證權限都要查詢資料庫，造成不必要的I/O負擔
假日資料查詢：相同日期的假日檢查可能在短時間內重複執行
用戶權限檢查：同一用戶的訂閱狀態在短時間內可能被多次查詢
發生的問題
響應時間延長：頻繁的資料庫查詢影響函數執行速度
資源浪費：大量重複查詢消耗資料庫連接和網路資源
併發瓶頸：多個排程同時執行時造成資料庫壓力
修改計劃
多層級快取架構

記憶體快取：用戶權限、假日資料等熱點資料
本地快取：配置資訊、系統參數
分散式快取：跨實例共享的資料
智慧快取策略

實作LRU快取淘汰機制，管理記憶體使用
設定差異化TTL，根據資料更新頻率調整快取時間
建立快取預熱機制，提前載入常用資料
快取一致性保證

實作快取失效機制，資料更新時自動清理相關快取
建立快取版本控制，避免過期資料問題
增加快取命中率監控，優化快取策略
🔄 5. 可靠性層面：重試機制統一化
現有狀況問題
重試策略不一致：SR_executeScheduledTask有重試機制，但其他函數沒有
錯誤處理分散：每個函數都有自己的錯誤處理邏輯
恢復能力弱：暫時性失敗沒有統一的重試和恢復策略
發生的問題
可靠性差異：不同功能在面對相同錯誤時表現不一致
維護困難：錯誤處理邏輯分散，難以統一優化
用戶體驗不佳：暫時性故障可能導致功能完全失效
修改計劃
統一重試框架

建立通用重試函數，支援指數退避、最大重試次數等策略
實作重試條件判斷，區分可重試和不可重試的錯誤類型
支援重試間隔自訂和重試回調機制
錯誤分類與處理

建立錯誤類型分類體系，明確各種錯誤的處理策略
實作錯誤恢復機制，針對不同錯誤類型採用適當的恢復策略
增加錯誤統計和分析，持續優化錯誤處理效果
斷路器模式實作

對外部依賴實作斷路器保護，避免級聯失敗
支援快速失敗和服務降級
實作健康檢查和自動恢復機制
=>目前先不要改變



🎯 總結
這些改善計劃將顯著提升SR模組的：

穩定性：多層備案和錯誤恢復機制
效能：快取策略和資源管理優化
可維護性：統一的架構設計和配置管理
可擴展性：模組化設計和依賴注入
建議按優先級分階段實施，首先處理記憶體洩漏和假日處理風險，再逐步改善架構設計。

您希望我針對哪個特定問題提供更詳細的技術實作規劃？

* 我的方向是要先做MVP出來，然後再去優化。我只要基本功能，之後再來優化效能、重試機制、強化功能等等
* 請整理我們前述的討論，將我認為可以實行的項目列出來

