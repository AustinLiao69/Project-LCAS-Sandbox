------------------------------------------
20251226. firestore寫入資料量問題

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

根據9909 SA角色文件和您的要求，我將基於現有代碼結構分析，將Firestore寫入資料量問題分成數個區塊，並預估每筆記帳產生的寫入量：
Firestore寫入資料量分析 - 區塊預估

🔴 區塊A：重複初始化寫入（預估：150-200筆/記帳）
1. 帳本結構重複初始化 (80-100筆)
•	來源: 1301. BK.js + 1309. AM.js的AM_getUserDefaultLedger
•	簡單概念: 就像每次記帳都要重新建立整個帳本框架，而不是使用已存在的框架
•	寫入內容: ledger文檔、基本設定、metadata等
•	Insight: AM_getUserDefaultLedger缺乏"已初始化"檢查，每次都觸發完整初始化流程

2. WCM模組科目/帳戶重複建立 (50-70筆)
•	來源: 1350. WCM.js的創建預設帳戶和科目功能
•	簡單概念: 就像每次記帳都要重新建立所有錢包種類和支出分類，即使之前已經建立過
•	寫入內容: 從0302.json和0099.json重複載入預設資料
•	Insight: WCM_createWallet和WCM_createCategory缺乏"已存在"判斷邏輯

3. 配置檔案重複寫入 (20-30筆)
•	來源: 0301-0305配置檔案內容被複製至用戶空間
•	簡單概念: 每次都把公司規章手冊複印一份放到員工個人檔案夾，而不是讓他們共享參考
•	寫入內容: 預設配置、貨幣設定、評估資料等
•	Insight: 應採用「指標引用」而非「實體複製」模式

🟡 區塊B：過度日誌記錄（預估：150-180筆/記帳）
4. DL模組詳細日誌 (80-100筆)
•	來源: 1310. DL.js每個操作步驟的Firestore寫入
•	簡單概念: 就像拍電影時把每個鏡頭、每次NG、每個走位都詳細記錄，而不只記錄最終成品
•	寫入內容: DEBUG、INFO、WARNING等各級別日誌
•	Insight: 開發階段的詳細日誌未在正式環境中精簡

5. WH模組處理狀態記錄 (40-50筆)
•	來源: 1320. WH.js處理LINE webhook的中間狀態
•	簡單概念: 就像快遞配送每經過一個路口都要拍照記錄，而不只記錄起點和終點
•	寫入內容: webhook接收、處理中、路由狀態等
•	Insight: 中間處理狀態記錄過於詳細，只需記錄關鍵節點

6. LBK模組調試記錄 (30-40筆)
•	來源: 1315. LBK.js快速記帳過程的偵錯資訊
•	簡單概念: 就像做菜時把每個調味步驟都寫成食譜，而不只記錄最終的菜品
•	寫入內容: 解析過程、驗證步驟、歸類邏輯等
•	Insight: 快速記帳流程的偵錯記錄應該在正式環境中簡化

🟠 區塊C：狀態追蹤機制（預估：60-80筆/記帳）

7. PendingTransactions多階段記錄 (30-40筆)
•	來源: LBK模組的科目與支付方式歧義消除過程
•	簡單概念: 就像買東西猶豫不決時，把每次考慮的選項都寫下來，而不只記錄最終決定
•	寫入內容: PENDING_CATEGORY、PENDING_WALLET等狀態變更
•	Insight: 歧義消除過程應該在記憶體中處理，只在最終確定時寫入

8. Metadata完整記錄 (20-30筆)
•	來源: 各模組為每筆交易寫入完整元數據
•	簡單概念: 就像買一支筆，不只記錄「買筆10元」，還記錄店家GPS座標、天氣、心情等無關資訊
•	寫入內容: 處理時間、模組版本、來源平台、設備資訊等
•	Insight: 元數據記錄過於詳盡，應區分「核心資料」與「輔助資料」

9. 事務狀態變更記錄 (10-15筆)
•	來源: 各階段處理的狀態變更記錄
•	簡單概念: 就像文件審核每個關卡都要蓋章記錄，而不只記錄「已審核完成」
•	寫入內容: processing、validation、completed等狀態
•	Insight: 狀態追蹤應採用「最終狀態」記錄，減少中間狀態

🟢 區塊D：實際記帳資料（預估：5-10筆/記帳）

10. 核心交易記錄 (2-3筆)
•	來源: 真正的記帳資料寫入
•	簡單概念: 這才是真正的記帳本體，像「午餐100元現金」這樣的核心資訊
•	寫入內容: transaction文檔、金額、科目、日期等
•	Insight: 這是唯一「必要」的寫入，其他都是「額外成本」

11. 關聯資料更新 (3-7筆)
•	來源: 帳戶餘額、統計資料等關聯更新
•	簡單概念: 就像記帳後更新錢包餘額和月度統計，這是合理的連鎖反應
•	寫入內容: wallet balance、ledger statistics等
•	Insight: 這些是合理的業務邏輯寫入

總計分析
當前狀況: 365-470筆寫入/記帳
•	🔴 重複初始化: 150-200筆 (40-43%)
•	🟡 過度日誌: 150-180筆 (41-38%)
•	🟠 狀態追蹤: 60-80筆 (16-17%)
•	🟢 實際記帳: 5-10筆 (1-2%)
理想狀況: 5-10筆寫入/記帳
•	只保留區塊D的核心記帳資料
建議優先處理順序
1.	立即處理（區塊A）: 建立初始化狀態檢查機制，避免重複初始化
2.	次要處理（區塊B）: 將開發環境詳細日誌改為簡化版本
3.	後續處理（區塊C）: 優化狀態管理，減少中間狀態記錄
核心Insight: 目前98-99%的寫入都是「非必要」的，只有1-2%是真正的記帳資料。這就像為了寫一封信，卻把整個郵政系統的作業流程都記錄下來一樣不合理。


