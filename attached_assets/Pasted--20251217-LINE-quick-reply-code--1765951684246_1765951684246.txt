------------------------------------------
20251217. 支付方式導入LINE quick reply
不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

根據您的指示，我已經理解需要修正的核心問題，並根據9909 SA角色文件重新分析和更新解決方案提案。
🔍 問題分析
核心問題識別
從Console輸出和您的需求描述，我識別出關鍵問題：
1.	帳本初始化缺少預設支付方式 - 系統在建立帳本時只初始化了categories和wallets，但沒有建立預設的支付方式記錄
2.	缺乏支付方式驗證機制 - LBK模組在處理記帳時沒有檢查支付方式是否存在於用戶的已知支付方式清單中
根本原因分析
技術層面原因：
1.	AM模組初始化職責混亂 - AM模組試圖直接處理wallets子集合內容，違反了模組職責分離原則，應該調用WCM模組進行初始化
2.	資料欄位不統一 - transaction中使用paymentMethod，但實際應該與wallets子集合連動，造成資料一致性問題
3.	LBK模組驗證邏輯缺失 - 沒有與Firebase中的用戶支付方式進行比對驗證
業務流程問題：
就像公司的財務部門(LBK)在處理報銷時，沒有檢查員工提出的支付方式是否在公司認可的支付方式清單中，導致可能出現未授權的支付方式被記錄。
💡 SA Insight
這個問題反映了模組職責邊界不清晰和資料模型不一致的架構缺陷。從系統設計角度看，這是典型的「資料標準化」問題：
1.	職責分離原則違反 - AM模組越界處理WCM模組的職責
2.	資料模型不統一 - paymentMethod與wallets概念重複但命名不一致
3.	驗證機制缺失 - 缺乏referential integrity檢查
正確的架構應該是：AM專注帳本基礎結構 → WCM負責wallets初始化 → LBK驗證wallet存在性 → WH提供用戶互動介面。

🎯 更新後解決方案
階段一：修正AM模組職責邊界並統一資料模型
修改目標： 修正AM模組職責，統一paymentMethod與wallets的概念
修改檔案：
•	00. Master_Project document/0070. DB schema.md
•	13. Replit_Module code_BL/1309. AM.js
修改內容：
1.	修改0070文件，將所有paymentMethod欄位統一改為wallet，確保與wallets子集合內的支付方式連動
2.	修改AM_initializeUserLedger函數，確保調用WCM模組進行wallets子集合初始化，而非自行處理
3.	升級AM模組版本至v8.1.0
Before/After行為差異：
•	Before: AM模組直接處理wallets內容，paymentMethod與wallets概念分離
•	After: AM調用WCM進行wallets初始化，統一使用wallet概念
影響範圍： 影響整個資料模型一致性，確保wallet概念統一
用途： 解決模組職責混亂和資料不一致問題


階段二：建立LBK模組wallet驗證機制
修改目標： 在記帳處理前驗證wallet是否存在於用戶的wallets子集合中
修改檔案： 13. Replit_Module code_BL/1315. LBK.js
修改內容：
1.	修改LBK_parseUserMessage函數，在解析完成後進行wallet驗證
2.	新增LBK_handleNewWallet函數，處理未知wallet的用戶選擇流程
3.	升級LBK模組版本至v1.4.4
Before/After行為差異：
•	Before: 直接接受任何支付方式進行記帳
•	After: 先驗證wallet存在性，未知wallet時觸發用戶確認流程
影響範圍： 影響LINE記帳流程，新增wallet驗證步驟
用途： 確保記帳時使用的wallet都是用戶已定義的方式

階段三：建立WH模組新wallet Quick Reply處理
修改目標： 處理用戶對新wallet的確認回應，支援Quick Reply按鈕互動
修改檔案： 13. Replit_Module code_BL/1320. WH.js
修改內容：
1.	在WH_processEventAsync中新增wallet postback事件處理
2.	建立新wallet確認的Quick Reply按鈕格式
3.	處理用戶選擇「是」時新增wallet到wallets子集合
4.	處理用戶選擇「否」時取消記帳操作
=>用戶選擇「否」時，則回覆記帳失敗的訊息，原因是非指定支付方式。
請你把系統內記帳失敗的訊息列出來我檢查。

5.	升級WH模組版本至v2.5.2
Before/After行為差異：
•	Before: 無法處理wallet相關的postback事件
•	After: 能識別並處理新wallet確認的postback事件，完成wallet新增和記帳流程
影響範圍： 影響LINE Webhook事件處理，新增wallet管理功能
用途： 提供友好的用戶介面讓用戶確認是否新增未知wallet



📋 實施計畫
階段一實施細節
•	資料模型修改： 統一paymentMethod為wallet概念
•	函數修改： AM_initializeUserLedger調用WCM而非自行處理
•	版本標註： v2025-12-17-V8.1.0
•	測試方式： 檢查資料模型一致性和WCM調用正確性
階段二實施細節
•	函數修改： LBK_parseUserMessage
•	新增函數： LBK_handleNewWallet
•	版本標註： v2025-12-17-V1.4.4
•	測試方式： 輸入未知wallet觸發確認流程
階段三實施細節
•	修改範圍： postback事件處理邏輯
•	新增功能： wallet postback識別和處理
•	版本標註： v2025-12-17-V2.5.2
•	測試方式： 點擊Quick Reply按鈕完成操作
🚀 預期效果
修復後，當用戶透過LINE進行記帳時：
1.	新用戶： 通過WCM自動建立完整的wallets結構
2.	已知wallet： 正常記帳流程，無額外步驟
3.	未知wallet： 系統提示確認訊息，提供Quick Reply按鈕選擇
4.	用戶確認後： 新增wallet並完成記帳，或取消記帳操作
概念解釋
這個改進就像是為公司建立完整的財務管理制度：
•	組織架構部門(AM)： 建立基礎框架，委託專業部門處理具體事務
•	財務工具管理部門(WCM)： 專責管理支付工具和帳戶設定
•	報銷審核部門(LBK)： 檢查使用的支付工具是否在認可清單中
•	客服部門(WH)： 當發現未知支付工具時，提供用戶友好的處理流程
請確認是否Approve此更新後提案，我將依序進行三階段實施。
