------------------------------------------
20251218. 支付方式導入LINE quick reply
不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

Debug分析報告更新
A. 快速摘要（≤3句）
1.	支付方式synonyms查詢邏輯存在但有缺陷：LBK_parsePaymentMethod確實調用了LBK_getWalletByName，但查詢失敗後直接返回預設現金，未觸發歧義消除流程。
=>
1. 查詢失敗不可以返回預設現金，查詢失敗直接由系統回覆系統錯誤。
2. LBK不可以有hard coding現金、刷卡等支付方式，一切要以user帳本的wallets子集合為準，如果沒有的話就回覆系統錯誤。
3. 請用簡單概念解釋歧義消除流程。


2.	支付方式歧義消除機制已存在但未正確觸發：系統已有LBK_handleNewWallet、LBK_handleWalletConfirmationPostback等完整的wallet歸類邏輯，但LBK_validateWalletExists錯誤地將查找失敗判定為「驗證成功」。

3.	wallet驗證邏輯錯誤：當「國泰世華」無法在synonyms中找到匹配時，LBK_validateWalletExists應該觸發requiresUserConfirmation流程，但實際上返回了success=true。

B. Root causes（最多 6 條）
1. LBK_parsePaymentMethod的synonyms查詢邏輯正確，但回退邏輯有問題
•	證據：log顯示LBK_getWalletByName被正確調用，查詢了3個錢包的synonyms，但都返回空陣列
•	信心度：95%
•	Insight：查詢機制正常運作，但當查詢無結果時直接使用預設現金，跳過了歧義消除流程

2. LBK_validateWalletExists錯誤判定wallet存在性
•	證據：log顯示「wallet驗證成功: 現金 (cash)」，但實際上「國泰世華」並不等於「現金」
•	信心度：90%
•	Insight：驗證函數將「找到預設錢包」誤判為「找到匹配錢包」，應該要檢查是否為真正的匹配

3. 支付方式歧義消除機制已完整實作但未被觸發
•	證據：代碼中已存在完整的wallet歧義消除流程：
o	LBK_handleNewWallet - 處理新wallet確認
o	LBK_handleWalletConfirmationPostback - 處理Quick Reply選擇
o	LBK_isWalletTypePostback - 識別wallet類型選擇
•	信心度：100%
•	Insight：機制完整但觸發條件判斷錯誤，需要修正觸發邏輯而非重新實作

現有支付方式歧義消除功能盤點
已存在的函數：
•	✅ LBK_handleNewWallet - 生成支付方式類型選擇Quick Reply
•	✅ LBK_handleWalletConfirmationPostback - 處理用戶選擇並完成歸類
•	✅ LBK_isWalletTypePostback - 識別wallet類型postback事件
•	✅ LBK_updateWalletSynonyms - 更新wallet同義詞
•	✅ LBK_getWalletByName - 通過synonyms查詢錢包
缺失的環節：
•	❌ LBK_validateWalletExists的觸發邏輯錯誤
•	❌ LBK_parsePaymentMethod未正確傳遞「需要歧義消除」的信號

解決方案階段規劃（修正版）
階段一：修正LBK_parsePaymentMethod的回退邏輯（1小時）
目標：當synonyms查詢無結果時，返回「需要歧義消除」標記而非直接使用預設錢包
修改檔案：13. Replit_Module code_BL/1315. LBK.js
修改內容：
1.	修正LBK_parsePaymentMethod函數，當LBK_getWalletByName返回null時，應該返回特殊標記
2.	新增requiresWalletConfirmation標記，讓上層邏輯知道需要觸發歧義消除
3.	升級LBK模組版本至v1.4.12

階段二：修正LBK_validateWalletExists的判斷邏輯（1小時）
目標：正確判斷wallet是否真正匹配，而非找到預設錢包就判定成功
修改檔案：13. Replit_Module code_BL/1315. LBK.js
修改內容：
1.	修正LBK_validateWalletExists函數，區分「找到匹配錢包」和「使用預設錢包」
2.	當使用預設錢包時，返回requiresUserConfirmation: true
3.	確保觸發已存在的LBK_handleNewWallet流程
=>目前狀況下user帳本wallets子集合下的錢包都是初次建立帳本時WCM建立的預設錢包，不需要找到匹配錢包這個問題，重點是找到個錢包下面的synonyms