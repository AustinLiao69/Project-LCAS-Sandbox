------------------------------------------
20251007 SIT 階段二 Debug

不要寫code，請根據我的回覆更新提案。現在是MVP階段，提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

作為資深SQA，基於你的回覆和重新檢視Console日誌，我更新以下結構化分析：
A. 快速摘要（≤3句）
•	最可能問題：多個API端點存在統一回應格式驗證問題（90%評分）和Firebase索引缺失導致查詢失敗
•	優先度：中 - TC-SIT-003已通過，主要問題集中在API回應格式一致性和查詢功能

B. Root causes
1. API回應格式不符合DCN-0015統一規範
•	證據：
✅ 統一回應格式驗證 /api/v1/users/profile: A (Score: 90.0%)
   - 錯誤詳情: Layer 1: Missing required field - data
•	信心度：95%
•	最小可行修正：
// 在AM.js的AM_processAPIGetProfile函數中確保data欄位存在
return { success: true, data: userData, message: "取得成功" };
•	失敗的測試案例：TC-SIT-020 (UserProfileAPI)


=>此案例是通過的請刪除


2. Firebase索引配置缺失導致查詢降級
•	證據：
🔄 標準查詢失敗，嘗試降級查詢: 9 FAILED_PRECONDITION: The query requires an index
🔄 查詢完成，使用degraded方法，返回0筆交易
•	信心度：90%
•	最小可行修正：
# 根據Firebase Console提示建立複合索引
# 或在BK.js中調整查詢邏輯避免需要索引
•	失敗的測試案例：TC-SIT-042 




(TransactionRecent)
3. Firestore資料更新時undefined值處理錯誤
•	證據：
[ERROR] Cannot use "undefined" as a Firestore value (found in field "avatar")
If you want to ignore undefined values, enable `ignoreUndefinedProperties`
•	信心度：85%
•	最小可行修正：
// 在AM_processAPIUpdateProfile中過濾undefined值
const cleanData = Object.fromEntries(Object.entries(updateData).filter(([k,v]) => v !== undefined));
•	失敗的測試案例：TC-SIT-033 (UpdateUserProfile)

=>此案例是通過的請刪除

4. 交易ID驗證邏輯錯誤導致更新/刪除失敗
•	證據：
📤 PUT /api/v1/transactions/test-transaction-002 - 400 (130ms)
📤 DELETE /api/v1/transactions/test-transaction-003 - 400 (128ms)
•	信心度：80%
•	最小可行修正：
// 在BK.js中加強交易ID存在性檢查
if (!transactionExists) return BK_formatErrorResponse("NOT_FOUND", "交易記錄不存在");
•	失敗的測試案例：TC-SIT-039 (UpdateTransactionById), TC-SIT-040 (DeleteTransactionById)

C. 最小重現步驟
# Commands
cd "06. SIT_Test code"
node "0603. SIT_TC_P1.js" --phase=all
# Environment variables (如果需要)
export API_BASE_URL=http://0.0.0.0:5000
export NODE_ENV=test
# Input example
# 執行TC-SIT-020時會觸發data欄位缺失問題
# 執行TC-SIT-042時會觸發Firebase索引問題

D. 優先修正建議
1. 修復API回應格式一致性問題（中優先）
•	風險：90%評分表示格式基本正確，僅需微調data欄位
•	修正範圍：AM.js中AM_processAPIGetProfile函數
•	回退計畫：評分已達A級，影響較小
2. 解決Firebase索引配置問題（中優先）
•	風險：查詢使用降級方法仍能運作，僅影響效能
•	修正範圍：Firebase Console索引配置
•	回退計畫：系統已有降級查詢機制
3. 處理Firestore undefined值問題（低優先）
•	風險：錯誤已被捕獲，不影響系統運作
•	修正範圍：AM.js用戶資料更新相關函數
•	回退計畫：在更新前進行資料清理
E. SQA Insight
核心發現：TC-SIT-003已通過，表示Firebase Auth整合基本正常。主要問題是：
1.	格式問題輕微：90%評分顯示統一回應格式基本達標，僅需微調
2.	查詢降級機制有效：Firebase索引問題已有降級處理，系統仍可運作
3.	MVP階段容忍度：當前問題不影響核心功能，可延後處理
建議：MVP階段重點應放在功能完整性而非格式完美性，當前問題可納入後續優化計畫。
