------------------------------------------
20251127. 修改協作帳本資料結構

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

SA系統分析報告 - 協作帳本資料結構重構提案
根據您的需求，我已深入分析協作帳本資料結構問題並提出解決方案。

🔍 問題識別與分析
核心問題
目前協作帳本的Firestore資料結構設計不一致，造成功能完整性缺失：
現狀問題：
•	協作帳本（collaborations集合）僅有members子集合
•	一般帳本（ledgers集合）擁有完整子集合：transactions、wallets、budgets、categories
•	這導致協作帳本無法進行完整的記帳、預算管理等核心功能

真實原因：
1.	架構設計不一致：CM模組設計時專注於協作管理功能，忽略了帳本的完整性需求
2.	職責邊界模糊：collaborations與ledgers集合的關係定義不清
3.	資料隔離問題：協作記帳資料無適當儲存位置

簡單概念解釋：
就像公司組織架構，個人部門（ledgers）有完整的預算、人員、專案管理功能，但跨部門協作小組（collaborations）卻只有成員名單，缺乏實際運作所需的預算和專案管理功能。

💡 My Insight
架構設計核心洞察：
1.	功能完整性原則：協作帳本本質上仍是帳本，應具備完整記帳功能
2.	資料結構統一性：不同類型的帳本應採用相同的子集合結構
3.	模組職責邊界：需要明確定義CM、BK、BM、WCM模組在協作帳本中的職責
業務邏輯洞察：
協作帳本不應該是特殊類型，而是具有協作功能的完整帳本。目前的設計違背了"帳本即服務"的核心理念。

🎯 解決方案架構
階段一：協作帳本子集合結構建立
目標：為collaborations集合建立完整的子集合架構
實施計畫：
collaborations/{collaborationId}/
├── members/           # 現有，保持不變
├── transactions/      # 新增：協作交易記錄
├── wallets/          # 新增：協作帳戶管理  
├── budgets/          # 新增：協作預算管理
└── categories/       # 新增：協作科目管理

修改檔案與內容：
1.	1313. CM.js - 版本升級至v2.4.0
•	新增協作子集合初始化函數
=>請檢查1313是否已有相同功能函數，若有責修改該函數，且勿新增函數。

•	修改現有協作帳本建立流程
•	Before：只建立members子集合
•	After：建立完整子集合架構

階段二：跨模組整合調整
目標：調整相關模組支援協作帳本的完整功能
實施計畫：
1.	1301. BK.js - 版本升級至v3.3.3
•	修改記帳路徑邏輯
•	Before：僅支援ledgers/{ledgerId}/transactions
•	After：支援collaborations/{collaborationId}/transactions
2.	1312. BM.js - 版本升級至v2.3.1
•	擴展預算管理至協作帳本
•	Before：僅支援ledgers/{ledgerId}/budgets
•	After：支援collaborations/{collaborationId}/budgets
3.	1350. WCM.js - 版本升級至v1.2.1
•	擴展帳戶科目管理至協作帳本
•	Before：僅支援ledgers子集合
•	After：支援collaborations子集合

階段三：API端點路由更新
目標：更新ASL.js路由邏輯，支援協作帳本API調用
實施計畫：
1.	ASL.js - 版本升級至v2.2.1
•	新增協作帳本路由識別
•	修改API轉發邏輯
•	Before：固定轉發至ledgers集合
•	After：根據帳本類型動態轉發

📋 詳細階段實施計畫
階段一實施詳情
影響範圍：Firebase資料結構、CM模組
測試驗證點：協作帳本建立後可查看到完整子集合結構
修改內容：
•	CM模組新增CM_initializeCollaborationSubcollections()函數
•	修改CM_createSharedLedger()函數整合子集合初始化
•	更新協作帳本建立流程

階段二實施詳情
影響範圍：BK、BM、WCM三個核心業務模組
測試驗證點：協作帳本可正常進行記帳、預算、帳戶管理操作
修改內容：
•	各模組新增協作帳本路徑支援
•	統一路徑解析邏輯
•	保持API介面不變，內部邏輯調整

階段三實施詳情
影響範圍：API路由層
測試驗證點：前端可透過現有API對協作帳本進行完整操作
修改內容：
•	ASL.js新增帳本類型識別邏輯
•	動態路由轉發機制
•	錯誤處理邏輯統一