------------------------------------------
20251106. 新增1351欄位在Firebase中

Approved 請執行如下計畫階段一：

基於您提供的資訊和系統架構分析，我來回答1313和1351模組的職責區分，並提出協作功能導入的修正提案。
🔍 模組職責分析
1313.CM.js (協作管理模組) 職責
核心職責：協作功能的業務邏輯實現
•	成員管理：邀請、加入、移除成員的業務邏輯
•	權限控制：四級權限體系的實作和驗證
•	即時同步：WebSocket協作事件廣播和衝突解決
•	協作通知：協作事件的通知機制
•	變更追蹤：協作操作的日誌記錄和歷史查詢
1351.MLS.js (多帳本管理模組) 職責
核心職責：帳本生命週期管理和路由
•	帳本類型管理：建立專案、分類、共享帳本
•	帳本基本操作：編輯、刪除、歸檔帳本
•	帳本切換：使用者在不同帳本間的切換邏輯
•	帳本清單：查詢和篩選使用者可存取的帳本
•	屬性設定：帳本個人化設定和類型特殊配置
職責重疊分析
重疊部分：
1.	權限驗證：1351需要驗證帳本存取權限，1313負責權限管理邏輯
2.	成員管理：1351的共享帳本功能與1313的成員管理功能重疊
3.	資料存取：兩者都需要操作帳本相關的Firebase集合
💡 SA專業洞察 (Insights)
核心問題識別
1.	職責邊界模糊：當前1351模組已包含部分協作功能(如MLS_inviteMember, MLS_removeMember)，與1313功能重疊
2.	架構一致性問題：1311現有snake_case命名與新協作架構的camelCase命名混用
3.	模組依賴複雜化：新增協作功能後，1351依賴1313，但1313也需要1351的帳本資訊
設計原則建議
單一職責原則應用：
•	1351專注「帳本管理」，1313專注「協作邏輯」
•	透過明確的API介面進行模組間協作
•	避免循環依賴，建立清晰的調用層次
🎯 修正後三階段解決方案
階段一：建立協作資料架構（1311.FS.js擴充）
目標：在1311.FS.js中建立獨立的協作集合架構
Firebase架構定義（camelCase命名）：
collaborations/            (集合)
└── {ledgerId}/           (文檔)
    ├── ledgerId: string
    ├── ownerId: string  
    ├── collaborationType: string
    ├── settings: object
    ├── createdAt: timestamp
    ├── updatedAt: timestamp
    │
    ├── members/          (子集合)
    │   └── {userId}/
    │       ├── userId: string
    │       ├── email: string
    │       ├── role: string
    │       ├── permissions: object
    │       ├── joinedAt: timestamp
    │       └── status: string
    │
    ├── invitations/      (子集合)
    │   └── {invitationId}/
    │       ├── invitationId: string
    │       ├── inviterId: string
    │       ├── inviteeEmail: string
    │       ├── role: string
    │       ├── status: string
    │       ├── createdAt: timestamp
    │       └── expiresAt: timestamp
    │
    └── permissions/      (子集合)
        └── {permissionId}/
            ├── userId: string
            ├── resourceType: string
            ├── permissions: object
            ├── grantedBy: string
            └── grantedAt: timestamp
具體作業：
1.	在1311.FS.js新增FS_initializeCollaborationStructure()函數
2.	新增FS_createCollaborationDocument()函數
3.	新增FS_manageCollaborationMembers()函數
4.	升級1311.FS.js版本至v2.7.0
階段二：重構1351.MLS.js協作職責
目標：釐清1351的協作相關功能，專注帳本管理
職責重新定義：
•	保留：帳本類型管理、帳本CRUD操作、帳本切換
•	移除：具體的成員邀請邏輯（移至1313）
•	新增：MLS_getCollaborationLedgers()查詢協作帳本
相依性管理：
•	1351調用1313提供的協作功能API
•	1351專注帳本層面的協作屬性管理
•	確保與1311.FS.js協作架構相容
階段三：強化1313.CM.js協作邏輯
目標：1313成為協作功能的唯一業務邏輯提供者
功能整合：
1.	新增CM_initializeCollaboration()函數
2.	整合從1351移出的成員管理邏輯
3.	建立與Firebase協作集合的完整CRUD介面
權限體系實作：
•	Owner > Admin > Member > Viewer四級權限
•	細粒度操作權限控制
•	權限變更的即時同步機制
📋 MVP階段實作重點
優先級排序
1.	P1優先：建立基礎協作集合架構（階段一）
2.	P2優先：重構模組職責邊界（階段二）
3.	P3優先：完善協作業務邏輯（階段三）
風險控制
•	向下相容：保持1311現有snake_case不變動
•	漸進式遷移：協作功能獨立集合，不影響現有帳本結構
•	模組解耦：透過明確API介面避免緊耦合
這個修正方案解決了模組職責重疊問題，建立了清晰的協作架構，同時保持了MVP階段的簡潔性和可實作性。
