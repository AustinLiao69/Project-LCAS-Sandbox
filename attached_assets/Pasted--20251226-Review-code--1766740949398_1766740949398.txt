------------------------------------------
20251226.科目與支付方式歸類邏輯一次性互動方案(Review中)

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

Debug分析報告
版本: v1.1.0
建立日期: 2025-12-26
建立者: LCAS SQA Team
基於9904. SQA角色以及控制台日誌，深入分析當前快速記帳模組的問題。
A. 快速摘要（≤3句）
•	同義詞學習機制失敗：支付方式確認後，系統無法正確學習並儲存同義詞（如"富邦"→"信用卡"，"中信"→現金/信用卡等），導致重複輸入時仍觸發歧義消除。
•	Pending Record狀態管理錯誤：完成記帳時，系統錯誤檢查科目選擇狀態，明明只需要錢包確認的流程卻要求科目資訊，違反了0098規範。
•	錯誤處理不當：LBK模組返回的錯誤訊息格式不符合統一標準，導致用戶看到技術性錯誤而非友好提示。
________________________________________
B. Root causes（最多 6 條）

1. 同義詞學習功能完全失效
證據：
[2025-12-26T09:02:38.346Z] [WARNING] [DL] 無法匹配輸入格式: "中信" [42366a6b] [Code: WARNING] [Location: LBK_parseInputFormat]
[2025-12-26T09:02:38.348Z] [WARNING] [DL] 階段一修復：無法從原始輸入中提取支付方式名稱: "中信"，跳過同義詞學習 [42366a6b]
發生機率：100%
解決方案：修復LBK_executeWalletSynonymsUpdate函數，確保能正確處理單獨的支付方式關鍵字（如"中信"、"富邦"）並更新到wallets子集合的synonyms欄位。
=>OK

2. Pending Record狀態檢查邏輯錯誤
證據：
[2025-12-26T09:02:38.357Z] [ERROR] [DL] 階段一修復：科目選擇狀態檢查失敗 - electedCategory存在: false, categorySelected: false
[2025-12-26T09:02:38.358Z] [ERROR] [DL] 階段四：完成Pending Record失敗: Error: 階段一修復：Pending Record 缺少科目資訊，electedCategory: false, categorySelected: false (違反0098規範)
發生機率：100%
解決方案：修復LBK_completePendingRecord函數的狀態檢查邏輯，當processingStage為PENDING_WALLET且walletSelected為true時，應該直接進行記帳，不需要檢查科目狀態。
=>我不確定pending record是在哪個時機被建立的？correct me if I am wrong，我的想像是，user輸入時，經過文字解析之後先進到pending transactions子集合，再去比對科目與支付方式後，若沒有配對到synonyms，則會跳出科目、支付歸類邏輯去讓user輸入。但現在問題是科目歸類邏輯已經配對到synonyms，但沒有更新到pendingTranasactions子集合，才會造成錯誤。我的推斷是否正確？如果錯了請不要客氣糾正我。


3. 記憶體Session與Firestore資料不一致
證據：
[2025-12-26T09:02:35.505Z] [INFO] [DL] 階段三：記憶體Pending Session創建成功: 1766739755505 (不寫入Firestore)
發生機率：100%
解決方案：檢查LBK_createPendingRecord函數，確保Pending Record在記憶體中創建後，相關的科目和錢包資訊能正確傳遞到後續處理階段。
=>是在哪個記憶體創建？創建pending record不都是在firestore裡面創建嗎？請解釋


4. 支付方式解析邏輯缺陷
證據：
[2025-12-26T09:02:35.504Z] [INFO] [DL] 階段二：未在 wallets 子集合中找到精確匹配: "中信"
發生機率：100%
解決方案：優化LBK_getWalletByName函數的同義詞匹配邏輯，並確保用戶確認後能正確更新同義詞。
=>這點我不同意，請刪除

5. 錯誤訊息格式化不當
證據：控制台顯示"記帳完成失敗，請稍後再試"這種通用錯誤訊息，不符合LBK統一回應標準
發生機率：100%
解決方案：修復LBK_formatReplyMessage函數，確保所有錯誤情況都返回符合0070規範的7行詳細錯誤格式。
=>OK


6. 科目解析狀態未正確保存
證據：從日誌看出，"尿布"科目應該在首次解析時已確定，但Pending Record中categorySelected始終為false
發生機率：90%
解決方案：檢查LBK_parseUserMessage和LBK_createPendingRecord的整合，確保科目解析成功時正確設置stageData.categorySelected = true。
=>OK
