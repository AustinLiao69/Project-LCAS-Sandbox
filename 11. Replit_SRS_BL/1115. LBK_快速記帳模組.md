
# PRD_LBK_快速記帳模組

**文件編號**: 1115  
**版本**: 1.1.0  
**建立日期**: 2025-07-15  
**建立者**: LCAS PM Team  
**最後更新**: 2025-08-09   

---

## 📑 目次 (Table of Contents)

1. [產品概述 (Product Overview)](#1-產品概述-product-overview)
   - 1.1 產品定位
   - 1.2 核心價值主張
   - 1.3 目標使用者

2. [技術架構調整](#2-技術架構調整)
   - 2.1 現有架構 vs 新架構
   - 2.2 資料流分離設計

3. [功能需求 (Functional Requirements)](#3-功能需求-functional-requirements)
   - 3.1 核心功能
   - 3.2 從BK模組繼承的功能

4. [非功能需求 (Non-Functional Requirements)](#4-非功能需求-non-functional-requirements)
   - 4.1 效能需求
   - 4.2 相容性需求
   - 4.3 可維護性需求

5. [介面規格 (Interface Specifications)](#5-介面規格-interface-specifications)
   - 5.1 WH 模組介面
   - 5.2 Firestore 介面

6. [使用者體驗 (User Experience)](#6-使用者體驗-user-experience)
   - 6.1 使用者流程
   - 6.2 回覆訊息範本

7. [開發規範 (Development Guidelines)](#7-開發規範-development-guidelines)
   - 7.1 程式碼規範
   - 7.2 測試需求

8. [部署計畫 (Deployment Plan)](#8-部署計畫-deployment-plan)
   - 8.1 開發階段
   - 8.2 風險控制

9. [成功指標 (Success Metrics)](#9-成功指標-success-metrics)
   - 9.1 效能指標
   - 9.2 使用者體驗指標
   - 9.3 技術指標

10. [驗收標準 (Acceptance Criteria)](#10-驗收標準-acceptance-criteria)
    - 10.1 功能驗收
    - 10.2 效能驗收
    - 10.3 相容性驗收

11. [後續規劃 (Future Enhancements)](#11-後續規劃-future-enhancements)
    - 11.1 短期規劃
    - 11.2 中期規劃
    - 11.3 長期規劃

12. [文件狀態與變更歷史](#文件狀態與變更歷史)

---

## 1. 產品概述 (Product Overview)

### 1.1 產品定位
LBK (LINE Bookkeeping) 是專門為 LINE OA 快速記帳設計的獨立模組，從原有的 BK 模組中分離出來，專注於處理 LINE OA 用戶的快速記帳需求，提供更簡化且高效的資料處理流程。

### 1.2 核心價值主張
- **極速處理**: 簡化資料流路徑，降低 Reply Token 60秒限制風險
- **專門設計**: 針對 LINE OA 文字記帳場景優化
- **高可靠性**: 獨立模組避免複雜功能相互影響
- **智慧解析**: 自然語言文字記帳解析

### 1.3 目標使用者
- **LINE OA 用戶**: 使用 LINE OA 進行快速記帳的個人用戶
- **基礎記帳需求**: 需要簡單、快速記錄收支的用戶

---

## 2. 技術架構調整

### 2.1 現有架構 vs 新架構

#### 現有架構 (WH -> DD -> BK)
```
LINE OA 文字輸入 → WH 模組 → DD 模組 → BK 模組 → Firestore
處理時間: ~5-8秒 | 經過模組數: 4個 | 函數調用: ~26個
```

#### 新架構 (WH -> LBK)
```
LINE OA 文字輸入 → WH 模組 → LBK 模組 → Firestore
處理時間: <2秒 | 經過模組數: 3個 | 函數調用: ~8個
```

### 2.2 資料流分離設計

```
┌─────────────────┐    ┌─────────────────┐
│   LINE OA       │    │   Rich Menu     │
│   (快速記帳)     │    │   & APP         │
└─────────┬───────┘    └─────────┬───────┘
          │                      │
          │ 簡化路徑              │ 標準路徑
          │                      │
          ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│  WH → LBK       │    │   WH → DD → BK  │
│  (快速記帳)      │    │   (完整功能)     │
└─────────┬───────┘    └─────────┬───────┘
          │                      │
          └──────────┬───────────┘
                     │
          ┌─────────────────────┐
          │  Firestore Database │
          └─────────────────────┘
```

---

## 3. 功能需求 (Functional Requirements)

### 3.1 核心功能

#### 3.1.1 文字記帳解析
- **自然語言解析**: 支援「午餐-100」、「薪水+50000」等格式
- **金額識別**: 自動識別正負號和數字
- **科目匹配**: 基於關鍵字的科目代碼匹配
- **模糊匹配**: 支援近似詞彙的科目識別

#### 3.1.2 快速記帳處理
- **即時處理**: 收到訊息後立即處理，避免超時
- **資料驗證**: 基本的資料格式和邏輯驗證
- **錯誤處理**: 完善的錯誤處理和用戶回饋機制
- **自動補全**: 自動補全時間、日期等資訊

#### 3.1.3 回覆訊息生成
- **確認訊息**: 記帳成功後的確認回覆
- **錯誤提示**: 清楚的錯誤說明和建議
- **格式統一**: 與現有系統一致的回覆格式

### 3.2 從BK模組繼承的功能

基於現有 BK 模組的成功實現，LBK 將繼承以下核心函數：

#### 3.2.1 文字解析相關
- `BK_removeAmountFromText()`: 從文字中移除金額
- `BK_extractAmountFromText()`: 從文字中提取金額
- `BK_parseUserMessage()`: 解析用戶訊息
- `BK_identifyIncomeOrExpense()`: 識別收入或支出

#### 3.2.2 科目處理相關
- `BK_getSubjectCode()`: 獲取科目代碼
- `BK_getSubjectByKeyword()`: 關鍵字科目匹配
- `BK_fuzzyMatchSubject()`: 模糊匹配科目

#### 3.2.3 記帳處理相關
- `BK_processBookkeeping()`: 記帳處理核心函數
- `BK_saveToFirestore()`: 儲存至 Firestore
- `BK_formatSystemReplyMessage()`: 格式化系統回覆

---

## 4. 非功能需求 (Non-Functional Requirements)

### 4.1 效能需求
- **回應時間**: LINE OA 文字記帳處理時間 < 2秒
- **吞吐量**: 支援每秒 100+ 並發記帳請求
- **可靠性**: 系統可用性 > 99.5%

### 4.2 相容性需求
- **Firestore 相容**: 與現有 Firestore 資料庫完全相容
- **格式相容**: 記帳資料格式與 BK 模組一致
- **API 相容**: 與 WH 模組的介面保持一致

### 4.3 可維護性需求
- **模組化設計**: 獨立模組，避免與其他功能耦合
- **錯誤日誌**: 完整的錯誤日誌和除錯資訊
- **版本控制**: 清楚的版本控制和更新機制

---

## 5. 介面規格 (Interface Specifications)

### 5.1 WH 模組介面

#### 5.1.1 輸入介面
```javascript
LBK_processQuickBookkeeping(inputData)
```

**輸入參數**:
```javascript
{
  userId: "LINE_UID",
  messageText: "午餐-100",
  replyToken: "REPLY_TOKEN",
  timestamp: "2025-07-15T09:00:00Z"
}
```

#### 5.1.2 輸出介面
```javascript
{
  success: true/false,
  message: "記帳成功/錯誤訊息",
  data: {
    amount: 100,
    type: "expense",
    subject: "餐飲",
    recordId: "RECORD_ID"
  },
  processingTime: 1.2, // 秒
  moduleVersion: "1.0.0"
}
```

### 5.2 Firestore 介面

#### 5.2.1 資料結構
```
ledgers/{LEDGER_ID}/entries/{ENTRY_ID}
├── 日期: "2025-07-15"
├── 時間: "09:00:00"
├── 大項代碼: "4001"
├── 子項代碼: "4001001"
├── 子項名稱: "餐飲"
├── 支付方式: "現金"
├── 收入: 0
├── 支出: 100
├── 備註: "午餐"
├── UID: "LINE_UID"
├── timestamp: Firestore.Timestamp
└── 處理模組: "LBK"
```

---

## 6. 使用者體驗 (User Experience)

### 6.1 使用者流程

#### 6.1.1 成功流程
```
1. 用戶在 LINE OA 輸入: "午餐-100"
2. WH 模組接收並轉發至 LBK
3. LBK 解析文字並識別: 支出100元，科目為餐飲
4. LBK 儲存至 Firestore
5. 回覆用戶: "✅ 記帳成功！支出 100 元 (餐飲)"
```

#### 6.1.2 錯誤處理流程
```
1. 用戶輸入無法解析的文字: "今天天氣真好"
2. LBK 無法識別金額或科目
3. 回覆用戶: "❌ 無法識別記帳資訊，請使用格式如：午餐-100"
```

### 6.2 回覆訊息範本

#### 6.2.1 成功訊息
```
✅ 記帳成功！
📊 支出 100 元 (餐飲)
🕒 時間: 2025-07-15 09:00
💳 支付: 現金
📝 備註: 午餐
```

#### 6.2.2 錯誤訊息
```
❌ 記帳失敗
🔍 原因: 無法識別金額
💡 建議: 請使用格式如「午餐-100」或「薪水+50000」
```

---

## 7. 開發規範 (Development Guidelines)

### 7.1 程式碼規範

#### 7.1.1 模組架構
```javascript
/**
 * LBK_快速記帳模組_1.0.0
 * @module 快速記帳模組
 * @description LINE OA 專用快速記帳處理模組
 * @update 2025-07-15: 初版建立，專門處理 LINE OA 快速記帳
 */
```

#### 7.1.2 函數命名規範
- 模組前綴: `LBK_`
- 駝峰命名: `LBK_processQuickBookkeeping`
- 描述性命名: 函數名稱需清楚表達功能

#### 7.1.3 錯誤處理規範
```javascript
try {
  // 處理邏輯
} catch (error) {
  LBK_logError(`函數執行失敗: ${error.toString()}`, "操作類型", userId, "ERROR_CODE", error.toString(), "函數名稱");
  throw new Error(`處理失敗: ${error.toString()}`);
}
```

### 7.2 測試需求

#### 7.2.1 單元測試
- 文字解析功能測試
- 科目匹配功能測試
- 資料儲存功能測試
- 錯誤處理測試

#### 7.2.2 整合測試
- WH -> LBK 介面測試
- LBK -> Firestore 介面測試
- 端到端流程測試

---

## 8. 部署計畫 (Deployment Plan)

### 8.1 開發階段

#### Phase 1: 基礎功能開發 (Week 1-2)
- [ ] 從 BK 模組分離核心函數
- [ ] 建立 LBK 模組架構
- [ ] 實作文字解析功能
- [ ] 基本錯誤處理

#### Phase 2: 整合測試 (Week 3)
- [ ] WH 模組整合
- [ ] Firestore 介面測試
- [ ] 效能測試和優化

#### Phase 3: 上線部署 (Week 4)
- [ ] 生產環境部署
- [ ] A/B 測試配置
- [ ] 監控和日誌設置

### 8.2 風險控制

#### 8.2.1 技術風險
- **模組分離風險**: 確保從 BK 分離的函數功能完整
- **效能風險**: 監控處理時間是否達到 <2秒 目標
- **相容性風險**: 確保與現有系統的資料格式相容

#### 8.2.2 緩解措施
- 完整的單元測試和整合測試
- 階段性部署，先小流量測試
- 保留回滾機制，可快速切回原有流程

---

## 9. 成功指標 (Success Metrics)

### 9.1 效能指標
- **處理時間**: LINE OA 記帳處理時間 < 2秒 (目標)
- **成功率**: 記帳處理成功率 > 95%
- **錯誤率**: 系統錯誤率 < 1%

### 9.2 使用者體驗指標
- **回應及時性**: Reply Token 超時率 < 0.1%
- **解析準確性**: 文字解析準確率 > 90%
- **用戶滿意度**: 透過 LINE OA 回饋收集

### 9.3 技術指標
- **資源使用率**: CPU 使用率 < 70%
- **記憶體使用**: 記憶體使用率 < 80%
- **併發處理**: 支援 100+ 併發請求

---

## 10. 驗收標準 (Acceptance Criteria)

### 10.1 功能驗收
- [ ] 能正確解析「項目-金額」格式的文字輸入
- [ ] 能正確識別收入（+）和支出（-）
- [ ] 能匹配正確的科目代碼
- [ ] 能儲存完整的記帳資料至 Firestore
- [ ] 能回覆正確格式的確認訊息

### 10.2 效能驗收
- [ ] 處理時間 < 2秒（90% 的請求）
- [ ] 支援 100+ 併發請求
- [ ] 記憶體使用率 < 80%

### 10.3 相容性驗收
- [ ] 與現有 WH 模組介面相容
- [ ] Firestore 資料格式與 BK 模組一致
- [ ] 不影響現有 Rich Menu 和 APP 功能

---

## 11. 後續規劃 (Future Enhancements)

### 11.1 短期規劃 (3個月內)
- 增加更多自然語言解析格式
- 優化科目匹配演算法
- 增加批次記帳功能

### 11.2 中期規劃 (6個月內)
- 整合機器學習進行智慧科目分類
- 增加語音記帳支援
- 個人化科目推薦

### 11.3 長期規劃 (1年內)
- 跨平台資料同步優化
- 進階分析報表功能
- 多語言支援

---

**文件狀態**: Draft  
**下一步行動**:
1. 技術團隊審核技術可行性
2. 開發團隊確認開發時程
3. 測試團隊制定測試計畫
4. PM 追蹤開發進度

---

**文件狀態與變更歷史**

**文件狀態**: Draft  
**下一步行動**:
1. 技術團隊審核技術可行性
2. 開發團隊確認開發時程
3. 測試團隊制定測試計畫
4. PM 追蹤開發進度

**變更歷史**:
- v1.0.0 (2025-07-15): 初版建立，定義 LBK 模組完整需求規格
- v1.1.0 (2025-08-09): 新增完整目次結構，優化文件可讀性和導航功能

