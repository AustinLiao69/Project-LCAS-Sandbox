
# PRD_Flutter_Presentation Layer

**文件編號**: 9005  
**版本**: 3.0.0  
**建立日期**: 2025-08-01  
**建立者**: LCAS PM Team  
**最後更新**: 2025-08-01 11:00:00 UTC+8

---

## 目次

1. [模組概述](#10-模組概述module-overview)
2. [展示層簡介](#20-展示層簡介presentation-layer-introduction)
3. [設計原則與規範](#30-設計原則與規範design-principles-and-guidelines)
4. [四模式差異化設計](#40-四模式差異化設計four-mode-design)
5. [畫面清單與流程關聯](#50-畫面清單與流程關聯screen-list-and-flow)
6. [各畫面需求詳述](#60-各畫面需求詳述screen-requirements)
7. [畫面切換與導航邏輯](#70-畫面切換與導航邏輯navigation-logic)
8. [響應與錯誤處理](#80-響應與錯誤處理response-and-error-handling)
9. [Loading與狀態呈現](#90-loading與狀態呈現loading-and-state-presentation)
10. [輔助與無障礙需求](#100-輔助與無障礙需求accessibility-requirements)
11. [API呼叫對應表](#110-api呼叫對應表api-mapping)
12. [版本升級計畫](#120-版本升級計畫version-upgrade)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Flutter Presentation Layer（展示層）是LCAS 2.0系統的使用者介面層，負責呈現資料與收集用戶輸入，透過AP Layer與business layer溝通，支援四種操作模式的差異化使用者體驗。

### 1.2 核心職責
- **資料呈現**: 以清晰、直觀的方式呈現業務資料
- **用戶輸入收集**: 收集用戶操作與輸入，進行前端驗證
- **四模式適配**: 支援Standard、Simplified、Advanced、Enterprise四種操作模式
- **響應式設計**: 適配不同螢幕尺寸和裝置類型
- **無障礙支援**: 提供完整的無障礙使用體驗
- **狀態管理**: 管理UI狀態，提供流暢的使用者體驗

### 1.3 技術架構概覽
```
Flutter Presentation Layer Architecture
├── UI Components (元件層)
│   ├── Common Widgets → 共用元件
│   ├── Form Widgets → 表單元件
│   ├── Display Widgets → 展示元件
│   └── Navigation Widgets → 導航元件
├── Screen Layer (畫面層)
│   ├── Authentication Screens → 認證畫面
│   ├── Entry Management Screens → 記帳管理畫面
│   ├── Project Screens → 專案畫面
│   ├── Budget Screens → 預算畫面
│   ├── Collaboration Screens → 協作畫面
│   ├── Report Screens → 報表畫面
│   └── System Screens → 系統畫面
├── State Management (狀態管理層)
│   ├── Provider/Riverpod → 狀態管理
│   ├── Screen States → 畫面狀態
│   └── Global States → 全域狀態
└── Theme & Style (主題樣式層)
    ├── Mode-specific Themes → 模式主題
    ├── Color Schemes → 色彩配置
    └── Typography → 字型系統
```

---

## 2.0 展示層簡介（Presentation Layer Introduction）

### 2.1 目標與角色
展示層在LCAS 2.0架構中扮演使用者介面的角色，專門負責：
- **純展示職責**: 只負責呈現資料與收集用戶輸入
- **API層溝通**: 透過AP Layer的API與business layer溝通
- **使用者體驗**: 提供直觀、高效的操作介面
- **跨平台一致性**: 確保Android和iOS平台的一致體驗

### 2.2 涉及平台
- **主要平台**: Flutter for Android/iOS
- **支援技術**: 
  - Material Design 3.0 (Android)
  - Cupertino Design (iOS)
  - 自訂設計系統 (品牌一致性)
- **響應式支援**: 手機、平板、摺疊螢幕

### 2.3 架構層級定位
```
LCAS 2.0 三層架構
┌─────────────────────────────────────┐
│     Presentation Layer (展示層)      │ ← 9005文件範圍
│     - Flutter UI Components        │
│     - Screen Management            │
│     - User Interaction             │
├─────────────────────────────────────┤
│     AP Layer (應用邏輯層)            │ ← 9006文件範圍
│     - API Integration              │
│     - State Management             │
│     - Business Logic               │
├─────────────────────────────────────┤
│     Business Layer (商業邏輯層)      │ ← 2XXX模組
│     - Core Business Logic          │
│     - Data Processing              │
│     - External Integrations        │
└─────────────────────────────────────┘
```

---

## 3.0 設計原則與規範（Design Principles and Guidelines）

### 3.1 設計語言系統

#### 3.1.1 基礎設計原則
- **Material Design 3.0**: Android平台主要設計語言
- **Cupertino Design**: iOS平台原生體驗
- **LCAS品牌設計**: 跨平台一致的品牌體驗
- **無障礙優先**: 遵循WCAG 2.1 AA標準

#### 3.1.2 色彩系統設計
```dart
// 主色彩配置
class LCASColors {
  // 品牌主色
  static const Color primary = Color(0xFF1976D2);
  static const Color primaryVariant = Color(0xFF1565C0);
  static const Color secondary = Color(0xFF03DAC6);
  
  // 功能色彩
  static const Color income = Color(0xFF4CAF50);    // 收入綠
  static const Color expense = Color(0xFFF44336);   // 支出紅
  static const Color transfer = Color(0xFF2196F3);  // 轉帳藍
  static const Color budget = Color(0xFFFF9800);    // 預算橙
  
  // 系統色彩
  static const Color error = Color(0xFFB00020);
  static const Color warning = Color(0xFFFF9800);
  static const Color success = Color(0xFF4CAF50);
  static const Color info = Color(0xFF2196F3);
}
```

#### 3.1.3 字型系統規範
```dart
// 字型系統
class LCASTextStyles {
  // 標題字型
  static const TextStyle headline1 = TextStyle(
    fontSize: 32,
    fontWeight: FontWeight.w300,
    letterSpacing: -1.5,
  );
  
  static const TextStyle headline2 = TextStyle(
    fontSize: 24,
    fontWeight: FontWeight.w300,
    letterSpacing: -0.5,
  );
  
  // 內文字型
  static const TextStyle body1 = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w400,
    letterSpacing: 0.5,
  );
  
  static const TextStyle body2 = TextStyle(
    fontSize: 14,
    fontWeight: FontWeight.w400,
    letterSpacing: 0.25,
  );
  
  // 按鈕字型
  static const TextStyle button = TextStyle(
    fontSize: 14,
    fontWeight: FontWeight.w500,
    letterSpacing: 1.25,
  );
}
```

### 3.2 使用者體驗目標（UX Goals）

#### 3.2.1 核心UX原則
- **清楚明瞭**: 資訊架構清晰，操作路徑明確
- **快速高效**: 常用功能可在3次點擊內完成
- **避免誤操作**: 重要操作需要二次確認
- **一致性體驗**: 跨功能模組的操作模式一致
- **即時回饋**: 操作後立即提供視覺或觸覺回饋

#### 3.2.2 操作效率目標
| 操作類型 | 目標時間 | 點擊次數 | 錯誤率 |
|----------|----------|----------|--------|
| 快速記帳 | < 10秒 | ≤ 3次 | < 2% |
| 查看帳本 | < 5秒 | ≤ 2次 | < 1% |
| 切換帳本 | < 3秒 | ≤ 2次 | < 1% |
| 新建預算 | < 30秒 | ≤ 5次 | < 5% |
| 查看報表 | < 8秒 | ≤ 3次 | < 2% |

### 3.3 間距與佈局規範

#### 3.3.1 間距系統
```dart
// 標準間距系統
class LCASSpacing {
  static const double xs = 4.0;    // 極小間距
  static const double sm = 8.0;    // 小間距
  static const double md = 16.0;   // 中等間距
  static const double lg = 24.0;   // 大間距
  static const double xl = 32.0;   // 超大間距
  static const double xxl = 48.0;  // 極大間距
}
```

#### 3.3.2 元件規範
```dart
// 標準元件尺寸
class LCASComponentSizes {
  // 按鈕高度
  static const double buttonHeight = 48.0;
  static const double smallButtonHeight = 36.0;
  static const double largeButtonHeight = 56.0;
  
  // 輸入欄位
  static const double inputHeight = 56.0;
  static const double inputBorderRadius = 8.0;
  
  // 卡片元件
  static const double cardBorderRadius = 12.0;
  static const double cardElevation = 2.0;
}
```

---

## 4.0 四模式差異化設計（Four Mode Design）

### 4.1 模式概覽

#### 4.1.1 Standard模式 (S)
**目標用戶**: 一般個人用戶  
**設計特點**: 簡潔直觀，功能完整但不複雜  
**主要功能**: 基礎記帳、簡單報表、預算管理

#### 4.1.2 Simplified模式 (I)
**目標用戶**: 初學者或年長者  
**設計特點**: 最簡化介面，大按鈕，少選項  
**主要功能**: 基本收支記錄、簡易查詢

#### 4.1.3 Advanced模式 (A)
**目標用戶**: 專業個人用戶  
**設計特點**: 豐富功能，專業工具  
**主要功能**: 詳細分析、多帳本、進階報表

#### 4.1.4 Enterprise模式 (E)
**目標用戶**: 企業或團隊用戶  
**設計特點**: 協作功能，權限管理  
**主要功能**: 團隊協作、權限控制、企業報表

### 4.2 模式差異化UI設計

#### 4.2.1 首頁設計差異
```dart
// Standard模式首頁
class StandardHomeScreen extends StatelessWidget {
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('我的帳本')),
      body: Column(
        children: [
          // 快速記帳區塊
          QuickEntryCard(),
          // 本月統計
          MonthlyStatsCard(),
          // 最近記錄
          RecentEntriesList(),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => Navigator.pushNamed(context, '/add-entry'),
        child: Icon(Icons.add),
      ),
    );
  }
}

// Simplified模式首頁
class SimplifiedHomeScreen extends StatelessWidget {
  Widget build(BuildContext context) {
    return Scaffold(
      body: Padding(
        padding: EdgeInsets.all(LCASSpacing.lg),
        children: [
          // 大按鈕：記錄支出
          LargeActionButton(
            title: '記錄支出',
            icon: Icons.remove_circle,
            color: LCASColors.expense,
            onPressed: () => _addExpense(context),
          ),
          SizedBox(height: LCASSpacing.lg),
          // 大按鈕：記錄收入
          LargeActionButton(
            title: '記錄收入',
            icon: Icons.add_circle,
            color: LCASColors.income,
            onPressed: () => _addIncome(context),
          ),
          SizedBox(height: LCASSpacing.lg),
          // 大按鈕：查看記錄
          LargeActionButton(
            title: '查看記錄',
            icon: Icons.list,
            color: LCASColors.primary,
            onPressed: () => _viewEntries(context),
          ),
        ],
      ),
    );
  }
}
```

#### 4.2.2 記帳表單差異化
| 模式 | 表單欄位數 | 必填欄位 | 進階選項 | 預設值策略 |
|------|------------|----------|----------|------------|
| **Simplified** | 3個 | 金額、類型 | 無 | 智慧預設 |
| **Standard** | 6個 | 金額、類型、科目 | 部分 | 使用習慣 |
| **Advanced** | 10個 | 金額、類型、科目、帳本 | 完整 | 個人化 |
| **Enterprise** | 12個 | 金額、類型、科目、帳本、專案 | 完整+協作 | 企業規則 |

### 4.3 模式間切換機制

#### 4.3.1 切換流程設計
```dart
// 模式切換元件
class ModeSwitchDialog extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text('選擇操作模式'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          ModeOptionTile(
            mode: UserMode.simplified,
            title: '簡化模式',
            subtitle: '適合初學者，介面簡潔',
            icon: Icons.sentiment_satisfied,
          ),
          ModeOptionTile(
            mode: UserMode.standard,
            title: '標準模式',
            subtitle: '功能完整，操作直觀',
            icon: Icons.person,
          ),
          ModeOptionTile(
            mode: UserMode.advanced,
            title: '進階模式',
            subtitle: '專業功能，詳細分析',
            icon: Icons.trending_up,
          ),
          ModeOptionTile(
            mode: UserMode.enterprise,
            title: '企業模式',
            subtitle: '團隊協作，權限管理',
            icon: Icons.business,
          ),
        ],
      ),
    );
  }
}
```

---

## 5.0 畫面清單與流程關聯（Screen List and Flow）

### 5.1 畫面分類架構

#### 5.1.1 認證流程畫面 (P001-P005)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P001 | 歡迎引導頁 | 初始流程 | - | All |
| P002 | 登入畫面 | 認證流程 | F002 | All |
| P003 | 註冊畫面 | 認證流程 | F001 | All |
| P004 | 忘記密碼 | 認證流程 | F005 | All |
| P005 | 個人設定 | 設定流程 | F003, F004 | All |

#### 5.1.2 記帳管理畫面 (P010-P019)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P010 | 首頁儀表板 | 主流程 | F007 | All |
| P011 | 快速記帳 | 記帳流程 | F006 | S,I,A |
| P012 | 詳細記帳 | 記帳流程 | F006 | S,A,E |
| P013 | 記帳歷史 | 查詢流程 | F007 | All |
| P014 | 記帳編輯 | 編輯流程 | F008 | S,A,E |
| P015 | 記帳刪除確認 | 刪除流程 | F009 | S,A,E |
| P016 | 批量操作 | 批量流程 | F008, F009 | A,E |
| P017 | 智慧分類建議 | 輔助流程 | - | A,E |
| P018 | 範本記帳 | 快速流程 | F006 | S,A,E |
| P019 | 記帳統計概覽 | 分析流程 | F007 | All |

#### 5.1.3 多帳本管理畫面 (P020-P029)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P020 | 帳本清單 | 帳本流程 | F011 | A,E |
| P021 | 帳本建立 | 建立流程 | F010 | A,E |
| P022 | 帳本設定 | 設定流程 | F012 | A,E |
| P023 | 帳本刪除 | 刪除流程 | F013 | A,E |
| P024 | 帳本成員管理 | 協作流程 | F014 | E |
| P025 | 帳本切換器 | 切換流程 | F015 | A,E |
| P026 | 帳本統計 | 分析流程 | F011 | A,E |
| P027 | 帳本匯入匯出 | 資料流程 | - | A,E |
| P028 | 帳本權限設定 | 權限流程 | F014 | E |
| P029 | 帳本邀請連結 | 分享流程 | F014 | E |

#### 5.1.4 預算管理畫面 (P030-P039)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P030 | 預算總覽 | 預算流程 | F017 | S,A,E |
| P031 | 預算建立 | 建立流程 | F016 | S,A,E |
| P032 | 預算編輯 | 編輯流程 | F016 | S,A,E |
| P033 | 預算進度 | 監控流程 | F017 | S,A,E |
| P034 | 預算警示設定 | 警示流程 | F018 | S,A,E |
| P035 | 預算分析 | 分析流程 | F017 | A,E |
| P036 | 預算範本 | 範本流程 | F016 | A,E |
| P037 | 預算比較 | 比較流程 | F017 | A,E |
| P038 | 預算匯出 | 匯出流程 | - | A,E |
| P039 | 預算歷史 | 歷史流程 | F017 | A,E |

#### 5.1.5 協作功能畫面 (P040-P049)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P040 | 協作首頁 | 協作流程 | - | E |
| P041 | 建立共享帳本 | 建立流程 | F019 | E |
| P042 | 成員權限管理 | 權限流程 | F020 | E |
| P043 | 即時同步狀態 | 同步流程 | F021 | E |
| P044 | 成員邀請 | 邀請流程 | F020 | E |
| P045 | 權限申請 | 申請流程 | F020 | E |
| P046 | 協作記錄 | 記錄流程 | - | E |
| P047 | 衝突解決 | 衝突流程 | F021 | E |
| P048 | 團隊統計 | 統計流程 | - | E |
| P049 | 協作設定 | 設定流程 | F020 | E |

#### 5.1.6 報表功能畫面 (P050-P059)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P050 | 報表中心 | 報表流程 | F022 | All |
| P051 | 基礎報表 | 查看流程 | F022 | All |
| P052 | 自訂報表 | 自訂流程 | F023 | A,E |
| P053 | 報表匯出 | 匯出流程 | F024 | S,A,E |
| P054 | 趨勢分析 | 分析流程 | F022 | A,E |
| P055 | 分類統計 | 統計流程 | F022 | All |
| P056 | 比較分析 | 比較流程 | F022 | A,E |
| P057 | 圖表設定 | 設定流程 | F023 | A,E |
| P058 | 報表排程 | 排程流程 | F023 | E |
| P059 | 報表分享 | 分享流程 | F024 | A,E |

#### 5.1.7 系統管理畫面 (P060-P069)
| 畫面ID | 畫面名稱 | 所屬流程 | 對應API | 支援模式 |
|--------|----------|----------|---------|----------|
| P060 | 系統設定 | 設定流程 | - | All |
| P061 | 備份管理 | 備份流程 | F025, F026, F027 | S,A,E |
| P062 | 同步狀態 | 同步流程 | F028 | All |
| P063 | 系統健康 | 監控流程 | F029 | A,E |
| P064 | 錯誤日誌 | 日誌流程 | F030 | A,E |
| P065 | 提醒設定 | 提醒流程 | F031, F032 | All |
| P066 | 主題設定 | 主題流程 | - | All |
| P067 | 語言設定 | 語言流程 | - | All |
| P068 | 關於應用 | 資訊流程 | - | All |
| P069 | 意見回饋 | 回饋流程 | - | All |

### 5.2 主要使用者流程圖

#### 5.2.1 核心記帳流程
```
[首頁P010] → [快速記帳P011] → [確認儲存] → [返回首頁P010]
     ↓
[詳細記帳P012] → [填寫表單] → [儲存] → [記帳歷史P013]
     ↓
[智慧建議P017] → [選擇建議] → [確認] → [儲存完成]
```

#### 5.2.2 帳本管理流程
```
[帳本清單P020] → [建立帳本P021] → [設定P022] → [邀請成員P024] → [完成]
     ↓
[切換帳本P025] → [確認切換] → [更新介面] → [新帳本首頁P010]
```

#### 5.2.3 預算設定流程
```
[預算總覽P030] → [建立預算P031] → [設定金額] → [警示設定P034] → [完成]
     ↓
[進度監控P033] → [查看詳情] → [調整設定P032] → [更新完成]
```

---

## 6.0 各畫面需求詳述（Screen Requirements）

### 6.1 認證流程畫面

#### 6.1.1 P002 - 登入畫面
**功能元件**:
- LINE Login按鈕（主要登入方式）
- Email輸入欄位（備用登入）
- 密碼輸入欄位
- 記住我切換開關
- 登入按鈕（disabled until valid）
- 忘記密碼連結
- 註冊帳號連結

**行為說明**:
- 點擊LINE Login → 呼叫 LINE OAuth API
- 點擊Email登入 → 呼叫 API F002: `POST /auth/login`
- 顯示loading spinner during authentication
- 自動儲存登入狀態（if 記住我 enabled）

**回饋設計**:
- 成功登入 → 導向首頁P010，顯示歡迎訊息
- 錯誤時 → 紅字提示錯誤原因，震動回饋
- 網路錯誤 → 顯示離線模式選項

**模式差異**:
```dart
// Simplified模式 - 只顯示LINE Login
Widget _buildSimplifiedLogin() {
  return Column(
    children: [
      LargeLINELoginButton(),
      SizedBox(height: LCASSpacing.lg),
      Text('使用LINE帳號快速登入', style: LCASTextStyles.body1),
    ],
  );
}

// Standard/Advanced/Enterprise模式 - 完整選項
Widget _buildFullLogin() {
  return Column(
    children: [
      LINELoginButton(),
      Divider(text: '或'),
      EmailInputField(),
      PasswordInputField(),
      RememberMeSwitch(),
      LoginButton(),
      ForgotPasswordLink(),
      RegisterAccountLink(),
    ],
  );
}
```

#### 6.1.2 P003 - 註冊畫面
**功能元件**:
- 顯示名稱輸入欄位
- Email輸入欄位（可選）
- 密碼輸入欄位（可選）
- 確認密碼欄位
- 服務條款同意勾選
- 註冊按鈕
- 返回登入連結

**驗證規則**:
- 顯示名稱：2-20字元，不能為空
- Email：有效email格式（如果填寫）
- 密碼：至少8字元，包含英數字（如果填寫）
- 確認密碼：與密碼欄位一致
- 服務條款：必須同意才能註冊

**API整合**:
- 註冊成功 → 呼叫 API F001: `POST /auth/register`
- 自動取得使用者UID和基本資料
- 建立預設帳本和初始設定

### 6.2 記帳管理畫面

#### 6.2.1 P010 - 首頁儀表板
**Standard模式設計**:
```dart
Widget build(BuildContext context) {
  return Scaffold(
    appBar: AppBar(
      title: Text('我的帳本'),
      actions: [
        NotificationButton(),
        LedgerSwitchButton(), // 如果有多個帳本
      ],
    ),
    body: RefreshIndicator(
      onRefresh: _refreshData,
      child: CustomScrollView(
        slivers: [
          // 快速記帳區塊
          SliverToBoxAdapter(
            child: QuickEntrySection(),
          ),
          // 本月統計卡片
          SliverToBoxAdapter(
            child: MonthlyStatsCard(
              income: _monthlyIncome,
              expense: _monthlyExpense,
              balance: _monthlyBalance,
            ),
          ),
          // 最近記錄列表
          SliverList(
            delegate: SliverChildBuilderDelegate(
              (context, index) => EntryListTile(_recentEntries[index]),
              childCount: _recentEntries.length,
            ),
          ),
        ],
      ),
    ),
    floatingActionButton: FloatingActionButton(
      onPressed: () => _quickAddEntry(),
      child: Icon(Icons.add),
      tooltip: '快速記帳',
    ),
  );
}
```

**Simplified模式設計**:
```dart
Widget build(BuildContext context) {
  return Scaffold(
    appBar: AppBar(
      title: Text('記帳本'),
      centerTitle: true,
    ),
    body: Padding(
      padding: EdgeInsets.all(LCASSpacing.xl),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          // 本月餘額顯示
          BalanceDisplayCard(balance: _currentBalance),
          
          // 三個大按鈕
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              LargeActionButton(
                title: '支出',
                icon: Icons.remove_circle,
                color: LCASColors.expense,
                onPressed: () => _addExpense(),
              ),
              LargeActionButton(
                title: '收入',
                icon: Icons.add_circle,
                color: LCASColors.income,
                onPressed: () => _addIncome(),
              ),
            ],
          ),
          
          LargeActionButton(
            title: '查看記錄',
            icon: Icons.list,
            color: LCASColors.primary,
            onPressed: () => _viewEntries(),
          ),
        ],
      ),
    ),
  );
}
```

#### 6.2.2 P011 - 快速記帳
**功能元件**:
- 金額輸入（數字鍵盤）
- 收入/支出切換按鈕
- 常用科目快選網格
- 備註輸入欄位（可選）
- 儲存按鈕
- 取消按鈕

**行為說明**:
- 預設金額欄位focus，顯示數字鍵盤
- 點擊科目 → 自動填入科目代碼和名稱
- 儲存時呼叫 API F006: `POST /entries/quick`
- 支援離線記帳，網路恢復後自動同步

**模式差異**:
| 模式 | 科目選擇 | 必填欄位 | 進階選項 |
|------|----------|----------|----------|
| Simplified | 預設6個 | 金額、收支類型 | 無 |
| Standard | 常用12個 | 金額、收支類型、科目 | 備註 |
| Advanced | 自訂最愛 | 金額、收支類型、科目 | 備註、標籤、地點 |

#### 6.2.3 P012 - 詳細記帳
**功能元件**:
- 收支類型選擇（收入/支出/轉帳）
- 金額輸入
- 科目選擇器（階層選單）
- 日期時間選擇器
- 帳本選擇器（多帳本模式）
- 專案選擇器（Enterprise模式）
- 備註輸入
- 標籤輸入（Advanced/Enterprise）
- 地點選擇（GPS/手動）
- 附件上傳（收據照片）
- 儲存按鈕

**表單驗證**:
```dart
String? _validateAmount(String? value) {
  if (value == null || value.isEmpty) {
    return '請輸入金額';
  }
  final amount = double.tryParse(value);
  if (amount == null || amount <= 0) {
    return '請輸入有效金額';
  }
  if (amount > 999999999) {
    return '金額過大';
  }
  return null;
}

String? _validateSubject(String? value) {
  if (value == null || value.isEmpty) {
    return '請選擇科目';
  }
  return null;
}
```

#### 6.2.4 P013 - 記帳歷史
**功能元件**:
- 搜尋列（金額、備註、科目）
- 日期範圍篩選器
- 分類篩選器
- 排序選項（日期、金額、科目）
- 記帳列表（分頁載入）
- 統計摘要（總收入、總支出、結餘）
- 批量選擇（Advanced/Enterprise）

**列表項目設計**:
```dart
class EntryListTile extends StatelessWidget {
  final Entry entry;
  
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        leading: CircleAvatar(
          backgroundColor: _getTypeColor(entry.entryType),
          child: Icon(_getTypeIcon(entry.entryType)),
        ),
        title: Text(entry.subjectName),
        subtitle: Text('${entry.description ?? ''} • ${_formatDate(entry.entryDate)}'),
        trailing: Text(
          _formatAmount(entry.amount),
          style: TextStyle(
            color: _getAmountColor(entry.entryType),
            fontWeight: FontWeight.bold,
          ),
        ),
        onTap: () => _editEntry(entry),
        onLongPress: () => _showEntryOptions(entry),
      ),
    );
  }
}
```

### 6.3 多帳本管理畫面

#### 6.3.1 P020 - 帳本清單
**功能元件**:
- 預設帳本（無法刪除）
- 個人帳本列表
- 共享帳本列表（Enterprise）
- 新增帳本按鈕
- 帳本搜尋
- 排序選項（名稱、建立時間、最後使用）

**帳本卡片設計**:
```dart
class LedgerCard extends StatelessWidget {
  final ProjectModel ledger;
  
  Widget build(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: () => _switchToLedger(ledger),
        child: Padding(
          padding: EdgeInsets.all(LCASSpacing.md),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(ledger.projectName, style: LCASTextStyles.headline2),
                  if (ledger.isShared) Icon(Icons.people),
                ],
              ),
              SizedBox(height: LCASSpacing.sm),
              Text(ledger.description ?? '', style: LCASTextStyles.body2),
              SizedBox(height: LCASSpacing.sm),
              Row(
                children: [
                  Chip(
                    label: Text(ledger.currency),
                    avatar: Icon(Icons.monetization_on),
                  ),
                  SizedBox(width: LCASSpacing.sm),
                  Text('${_getEntryCount(ledger.projectId)} 筆記錄'),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 6.3.2 P021 - 帳本建立
**功能元件**:
- 帳本名稱輸入
- 帳本描述輸入
- 幣別選擇
- 帳本類型選擇（個人/共享）
- 起始金額設定
- 預算設定（可選）
- 建立按鈕

**驗證規則**:
- 帳本名稱：2-50字元，不能與現有帳本重複
- 描述：最多200字元
- 幣別：必須選擇
- 起始金額：可為負數，但不能超過限制

### 6.4 預算管理畫面

#### 6.4.1 P030 - 預算總覽
**功能元件**:
- 本月預算進度環狀圖
- 預算類別卡片列表
- 超支警示區域
- 新增預算按鈕
- 預算歷史連結

**進度顯示設計**:
```dart
class BudgetProgressCard extends StatelessWidget {
  final BudgetModel budget;
  
  Widget build(BuildContext context) {
    final progress = budget.spent / budget.amount;
    final isOverBudget = progress > 1.0;
    
    return Card(
      color: isOverBudget ? LCASColors.error.withOpacity(0.1) : null,
      child: Padding(
        padding: EdgeInsets.all(LCASSpacing.md),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(budget.categoryName, style: LCASTextStyles.headline3),
                if (isOverBudget) Icon(Icons.warning, color: LCASColors.error),
              ],
            ),
            SizedBox(height: LCASSpacing.sm),
            LinearProgressIndicator(
              value: progress.clamp(0.0, 1.0),
              backgroundColor: Colors.grey[300],
              valueColor: AlwaysStoppedAnimation<Color>(
                isOverBudget ? LCASColors.error : LCASColors.success,
              ),
            ),
            SizedBox(height: LCASSpacing.sm),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text('已用 ${_formatAmount(budget.spent)}'),
                Text('預算 ${_formatAmount(budget.amount)}'),
              ],
            ),
            if (isOverBudget)
              Text(
                '超支 ${_formatAmount(budget.spent - budget.amount)}',
                style: TextStyle(color: LCASColors.error),
              ),
          ],
        ),
      ),
    );
  }
}
```

### 6.5 報表功能畫面

#### 6.5.1 P050 - 報表中心
**功能元件**:
- 快速報表按鈕（本月、本年、自訂期間）
- 圖表類型選擇（圓餅圖、柱狀圖、折線圖）
- 報表範本庫
- 自訂報表按鈕（Advanced/Enterprise）
- 已儲存報表列表

**報表卡片設計**:
```dart
class ReportCard extends StatelessWidget {
  final ReportTemplate template;
  
  Widget build(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: () => _generateReport(template),
        child: Padding(
          padding: EdgeInsets.all(LCASSpacing.md),
          child: Column(
            children: [
              Icon(template.icon, size: 48),
              SizedBox(height: LCASSpacing.sm),
              Text(template.name, style: LCASTextStyles.headline3),
              Text(template.description, style: LCASTextStyles.body2),
            ],
          ),
        ),
      ),
    );
  }
}
```

---

## 7.0 畫面切換與導航邏輯（Navigation Logic）

### 7.1 導航架構設計

#### 7.1.1 主導航結構
```dart
// 主要導航使用Bottom Navigation Bar
class MainNavigation extends StatefulWidget {
  @override
  _MainNavigationState createState() => _MainNavigationState();
}

class _MainNavigationState extends State<MainNavigation> {
  int _currentIndex = 0;
  
  final List<Widget> _screens = [
    HomeScreen(),        // P010 - 首頁
    EntriesScreen(),     // P013 - 記帳歷史  
    BudgetScreen(),      // P030 - 預算管理
    ReportsScreen(),     // P050 - 報表中心
    SettingsScreen(),    // P060 - 系統設定
  ];
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: _screens[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        type: BottomNavigationBarType.fixed,
        currentIndex: _currentIndex,
        onTap: (index) => setState(() => _currentIndex = index),
        items: [
          BottomNavigationBarItem(icon: Icon(Icons.home), label: '首頁'),
          BottomNavigationBarItem(icon: Icon(Icons.receipt_long), label: '記錄'),
          BottomNavigationBarItem(icon: Icon(Icons.account_balance_wallet), label: '預算'),
          BottomNavigationBarItem(icon: Icon(Icons.analytics), label: '報表'),
          BottomNavigationBarItem(icon: Icon(Icons.settings), label: '設定'),
        ],
      ),
    );
  }
}
```

#### 7.1.2 模式差異導航
| 模式 | 主要Tab數 | 顯示Tab | 特殊導航 |
|------|-----------|---------|----------|
| **Simplified** | 3個 | 首頁、記錄、設定 | 大按鈕導航 |
| **Standard** | 5個 | 首頁、記錄、預算、報表、設定 | 標準Tab導航 |
| **Advanced** | 5個+Drawer | 全功能+側邊選單 | Tab+Drawer |
| **Enterprise** | 6個+Drawer | 增加協作Tab | Tab+Drawer+權限 |

### 7.2 路由管理策略

#### 7.2.1 命名路由定義
```dart
// 路由常數定義
class AppRoutes {
  // 認證相關
  static const String welcome = '/welcome';
  static const String login = '/login';
  static const String register = '/register';
  static const String forgotPassword = '/forgot-password';
  
  // 主要功能
  static const String home = '/home';
  static const String quickEntry = '/quick-entry';
  static const String detailEntry = '/detail-entry';
  static const String entryHistory = '/entry-history';
  static const String editEntry = '/edit-entry';
  
  // 帳本管理
  static const String ledgerList = '/ledger-list';
  static const String createLedger = '/create-ledger';
  static const String ledgerSettings = '/ledger-settings';
  
  // 預算管理
  static const String budgetOverview = '/budget-overview';
  static const String createBudget = '/create-budget';
  static const String budgetProgress = '/budget-progress';
  
  // 報表功能
  static const String reportCenter = '/report-center';
  static const String customReport = '/custom-report';
  static const String reportViewer = '/report-viewer';
  
  // 系統設定
  static const String settings = '/settings';
  static const String profile = '/profile';
  static const String backup = '/backup';
}
```

#### 7.2.2 路由守衛機制
```dart
class RouteGuard {
  static Route<dynamic> generateRoute(RouteSettings settings) {
    // 檢查登入狀態
    if (!AuthService.isLoggedIn && !_publicRoutes.contains(settings.name)) {
      return MaterialPageRoute(builder: (_) => LoginScreen());
    }
    
    // 檢查模式權限
    if (!_checkModePermission(settings.name)) {
      return MaterialPageRoute(builder: (_) => UnauthorizedScreen());
    }
    
    // 路由分發
    switch (settings.name) {
      case AppRoutes.home:
        return MaterialPageRoute(builder: (_) => HomeScreen());
      case AppRoutes.quickEntry:
        return MaterialPageRoute(
          builder: (_) => QuickEntryScreen(),
          settings: settings,
        );
      // ... 其他路由
      default:
        return MaterialPageRoute(builder: (_) => NotFoundScreen());
    }
  }
  
  static bool _checkModePermission(String? routeName) {
    final currentMode = UserService.currentMode;
    final routePermissions = _routePermissionMap[routeName];
    
    return routePermissions?.contains(currentMode) ?? true;
  }
}
```

### 7.3 畫面轉場動畫

#### 7.3.1 標準轉場動畫
```dart
class AppPageTransitions {
  // 滑動進入動畫（主要使用）
  static PageTransitionsBuilder slideTransition = const PageTransitionsBuilder(
    builders: {
      TargetPlatform.android: CupertinoPageTransitionsBuilder(),
      TargetPlatform.iOS: CupertinoPageTransitionsBuilder(),
    },
  );
  
  // 淡入淡出動畫（模態對話框）
  static Route<T> fadeRoute<T extends Object?>(
    Widget child,
    RouteSettings settings,
  ) {
    return PageRouteBuilder<T>(
      settings: settings,
      pageBuilder: (context, animation, _) => child,
      transitionsBuilder: (context, animation, _, child) {
        return FadeTransition(opacity: animation, child: child);
      },
      transitionDuration: Duration(milliseconds: 300),
    );
  }
  
  // 底部彈出動畫（Action Sheet）
  static Route<T> bottomSheetRoute<T extends Object?>(
    Widget child,
    RouteSettings settings,
  ) {
    return PageRouteBuilder<T>(
      settings: settings,
      pageBuilder: (context, animation, _) => child,
      transitionsBuilder: (context, animation, _, child) {
        final tween = Tween(begin: Offset(0.0, 1.0), end: Offset.zero);
        final offsetAnimation = animation.drive(tween);
        return SlideTransition(position: offsetAnimation, child: child);
      },
    );
  }
}
```

#### 7.3.2 模式差異動畫
| 模式 | 主要動畫 | 動畫時長 | 特殊效果 |
|------|----------|----------|----------|
| **Simplified** | 無動畫 | 0ms | 即時切換 |
| **Standard** | 滑動 | 200ms | 標準滑動 |
| **Advanced** | 滑動+縮放 | 300ms | 視覺層次 |
| **Enterprise** | 自訂 | 250ms | 品牌動畫 |

---

## 8.0 響應與錯誤處理（Response and Error Handling）

### 8.1 錯誤分類與處理策略

#### 8.1.1 錯誤類型定義
```dart
enum ErrorType {
  network,          // 網路連線錯誤
  server,           // 伺服器錯誤
  validation,       // 資料驗證錯誤
  authentication,   // 認證錯誤
  authorization,    // 權限錯誤
  storage,          // 本地儲存錯誤
  unknown,          // 未知錯誤
}

class AppError {
  final ErrorType type;
  final String message;
  final String? details;
  final int? code;
  
  const AppError({
    required this.type,
    required this.message,
    this.details,
    this.code,
  });
}
```

#### 8.1.2 錯誤顯示規則
```dart
class ErrorDisplayManager {
  static void showError(BuildContext context, AppError error) {
    switch (error.type) {
      case ErrorType.network:
        _showNetworkError(context, error);
        break;
      case ErrorType.validation:
        _showValidationError(context, error);
        break;
      case ErrorType.authentication:
        _showAuthError(context, error);
        break;
      default:
        _showGenericError(context, error);
    }
  }
  
  static void _showNetworkError(BuildContext context, AppError error) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(Icons.wifi_off, color: Colors.white),
            SizedBox(width: LCASSpacing.sm),
            Expanded(child: Text('網路連線異常，請檢查網路設定')),
          ],
        ),
        backgroundColor: LCASColors.error,
        action: SnackBarAction(
          label: '重試',
          textColor: Colors.white,
          onPressed: () => _retryLastAction(context),
        ),
        duration: Duration(seconds: 5),
      ),
    );
  }
  
  static void _showValidationError(BuildContext context, AppError error) {
    // 表單驗證錯誤 - 直接在欄位下方顯示
    // 已在各表單元件中實作
  }
  
  static void _showAuthError(BuildContext context, AppError error) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        icon: Icon(Icons.lock_outline, color: LCASColors.error),
        title: Text('認證失敗'),
        content: Text(error.message),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: Text('確定'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.of(context).pop();
              Navigator.pushNamedAndRemoveUntil(
                context,
                AppRoutes.login,
                (route) => false,
              );
            },
            child: Text('重新登入'),
          ),
        ],
      ),
    );
  }
}
```

### 8.2 表單驗證規則

#### 8.2.1 統一驗證框架
```dart
class FormValidators {
  // 金額驗證
  static String? validateAmount(String? value) {
    if (value == null || value.isEmpty) {
      return '請輸入金額';
    }
    
    final amount = double.tryParse(value);
    if (amount == null) {
      return '請輸入有效數字';
    }
    
    if (amount <= 0) {
      return '金額必須大於0';
    }
    
    if (amount > 999999999) {
      return '金額不能超過999,999,999';
    }
    
    return null;
  }
  
  // Email驗證
  static String? validateEmail(String? value) {
    if (value == null || value.isEmpty) {
      return null; // Email為可選欄位
    }
    
    final emailRegex = RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$');
    if (!emailRegex.hasMatch(value)) {
      return '請輸入有效的Email地址';
    }
    
    return null;
  }
  
  // 帳本名稱驗證
  static String? validateLedgerName(String? value) {
    if (value == null || value.isEmpty) {
      return '請輸入帳本名稱';
    }
    
    if (value.length < 2) {
      return '帳本名稱至少需要2個字元';
    }
    
    if (value.length > 50) {
      return '帳本名稱不能超過50個字元';
    }
    
    return null;
  }
}
```

#### 8.2.2 即時驗證機制
```dart
class ValidatedTextField extends StatefulWidget {
  final String? Function(String?) validator;
  final void Function(String) onChanged;
  final String labelText;
  
  @override
  _ValidatedTextFieldState createState() => _ValidatedTextFieldState();
}

class _ValidatedTextFieldState extends State<ValidatedTextField> {
  final TextEditingController _controller = TextEditingController();
  String? _errorText;
  bool _hasBeenTouched = false;
  
  @override
  Widget build(BuildContext context) {
    return TextFormField(
      controller: _controller,
      decoration: InputDecoration(
        labelText: widget.labelText,
        errorText: _errorText,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(LCASComponentSizes.inputBorderRadius),
        ),
        suffixIcon: _hasBeenTouched
            ? (_errorText == null 
                ? Icon(Icons.check_circle, color: LCASColors.success)
                : Icon(Icons.error, color: LCASColors.error))
            : null,
      ),
      onChanged: (value) {
        setState(() {
          _hasBeenTouched = true;
          _errorText = widget.validator(value);
        });
        widget.onChanged(value);
      },
      validator: widget.validator,
    );
  }
}
```

### 8.3 空狀態設計

#### 8.3.1 無資料狀態
```dart
class EmptyStateWidget extends StatelessWidget {
  final String title;
  final String subtitle;
  final IconData icon;
  final String? actionText;
  final VoidCallback? onAction;
  
  const EmptyStateWidget({
    required this.title,
    required this.subtitle,
    required this.icon,
    this.actionText,
    this.onAction,
  });
  
  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: EdgeInsets.all(LCASSpacing.xl),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon,
              size: 80,
              color: Colors.grey[400],
            ),
            SizedBox(height: LCASSpacing.lg),
            Text(
              title,
              style: LCASTextStyles.headline2.copyWith(
                color: Colors.grey[600],
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: LCASSpacing.sm),
            Text(
              subtitle,
              style: LCASTextStyles.body1.copyWith(
                color: Colors.grey[500],
              ),
              textAlign: TextAlign.center,
            ),
            if (actionText != null && onAction != null) ...[
              SizedBox(height: LCASSpacing.lg),
              ElevatedButton(
                onPressed: onAction,
                child: Text(actionText!),
              ),
            ],
          ],
        ),
      ),
    );
  }
}
```

#### 8.3.2 網路異常狀態
```dart
class NetworkErrorWidget extends StatelessWidget {
  final VoidCallback? onRetry;
  
  @override
  Widget build(BuildContext context) {
    return EmptyStateWidget(
      icon: Icons.wifi_off,
      title: '網路連線異常',
      subtitle: '請檢查網路設定後重試',
      actionText: '重試',
      onAction: onRetry,
    );
  }
}
```

---

## 9.0 Loading與狀態呈現（Loading and State Presentation）

### 9.1 Loading狀態設計

#### 9.1.1 Skeleton UI實作
```dart
class SkeletonLoader extends StatefulWidget {
  final Widget child;
  final bool isLoading;
  
  const SkeletonLoader({
    required this.child,
    required this.isLoading,
  });
  
  @override
  _SkeletonLoaderState createState() => _SkeletonLoaderState();
}

class _SkeletonLoaderState extends State<SkeletonLoader>
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;
  late Animation<double> _animation;
  
  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      duration: Duration(milliseconds: 1000),
      vsync: this,
    );
    _animation = Tween<double>(begin: 0.3, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );
    _animationController.repeat(reverse: true);
  }
  
  @override
  Widget build(BuildContext context) {
    if (!widget.isLoading) {
      return widget.child;
    }
    
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Opacity(
          opacity: _animation.value,
          child: Container(
            decoration: BoxDecoration(
              color: Colors.grey[300],
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
      },
    );
  }
}

// 記帳歷史列表的Skeleton
class EntryListSkeleton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: 10,
      itemBuilder: (context, index) {
        return Card(
          child: ListTile(
            leading: SkeletonLoader(
              isLoading: true,
              child: CircleAvatar(),
            ),
            title: SkeletonLoader(
              isLoading: true,
              child: Container(height: 16, width: double.infinity),
            ),
            subtitle: SkeletonLoader(
              isLoading: true,
              child: Container(height: 12, width: 200),
            ),
            trailing: SkeletonLoader(
              isLoading: true,
              child: Container(height: 16, width: 80),
            ),
          ),
        );
      },
    );
  }
}
```

#### 9.1.2 Shimmer效果實作
```dart
class ShimmerEffect extends StatefulWidget {
  final Widget child;
  final Color? baseColor;
  final Color? highlightColor;
  
  const ShimmerEffect({
    required this.child,
    this.baseColor,
    this.highlightColor,
  });
  
  @override
  _ShimmerEffectState createState() => _ShimmerEffectState();
}

class _ShimmerEffectState extends State<ShimmerEffect>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: Duration(milliseconds: 1500),
      vsync: this,
    );
    _animation = Tween<double>(begin: -1.0, end: 2.0).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOutSine),
    );
    _controller.repeat();
  }
  
  @override
  Widget build(BuildContext context) {
    final baseColor = widget.baseColor ?? Colors.grey[300]!;
    final highlightColor = widget.highlightColor ?? Colors.grey[100]!;
    
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return ShaderMask(
          blendMode: BlendMode.srcATop,
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.centerRight,
              stops: [
                _animation.value - 0.3,
                _animation.value,
                _animation.value + 0.3,
              ],
              colors: [baseColor, highlightColor, baseColor],
            ).createShader(bounds);
          },
          child: widget.child,
        );
      },
    );
  }
}
```

### 9.2 非同步狀態管理

#### 9.2.1 統一非同步狀態封裝
```dart
enum AsyncStatus { initial, loading, success, error }

class AsyncValue<T> {
  final AsyncStatus status;
  final T? data;
  final String? error;
  
  const AsyncValue._({
    required this.status,
    this.data,
    this.error,
  });
  
  const AsyncValue.initial() : this._(status: AsyncStatus.initial);
  const AsyncValue.loading() : this._(status: AsyncStatus.loading);
  const AsyncValue.success(T data) : this._(status: AsyncStatus.success, data: data);
  const AsyncValue.error(String error) : this._(status: AsyncStatus.error, error: error);
  
  bool get isLoading => status == AsyncStatus.loading;
  bool get isSuccess => status == AsyncStatus.success;
  bool get isError => status == AsyncStatus.error;
  bool get hasData => data != null;
}

// 非同步Widget建構器
class AsyncBuilder<T> extends StatelessWidget {
  final AsyncValue<T> asyncValue;
  final Widget Function(BuildContext, T) builder;
  final Widget Function(BuildContext)? loadingBuilder;
  final Widget Function(BuildContext, String)? errorBuilder;
  final Widget Function(BuildContext)? emptyBuilder;
  
  const AsyncBuilder({
    required this.asyncValue,
    required this.builder,
    this.loadingBuilder,
    this.errorBuilder,
    this.emptyBuilder,
  });
  
  @override
  Widget build(BuildContext context) {
    if (asyncValue.isLoading) {
      return loadingBuilder?.call(context) ?? 
             Center(child: CircularProgressIndicator());
    }
    
    if (asyncValue.isError) {
      return errorBuilder?.call(context, asyncValue.error!) ??
             ErrorDisplayWidget(error: asyncValue.error!);
    }
    
    if (asyncValue.hasData) {
      return builder(context, asyncValue.data!);
    }
    
    return emptyBuilder?.call(context) ??
           EmptyStateWidget(
             icon: Icons.inbox,
             title: '暫無資料',
             subtitle: '目前沒有任何記錄',
           );
  }
}
```

### 9.3 資料載入失敗重試設計

#### 9.3.1 重試機制實作
```dart
class RetryableWidget extends StatefulWidget {
  final Future<void> Function() onRetry;
  final Widget child;
  final String? errorMessage;
  
  const RetryableWidget({
    required this.onRetry,
    required this.child,
    this.errorMessage,
  });
  
  @override
  _RetryableWidgetState createState() => _RetryableWidgetState();
}

class _RetryableWidgetState extends State<RetryableWidget> {
  bool _isRetrying = false;
  
  @override
  Widget build(BuildContext context) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        if (widget.errorMessage != null) ...[
          Icon(Icons.error_outline, size: 48, color: LCASColors.error),
          SizedBox(height: LCASSpacing.md),
          Text(widget.errorMessage!, textAlign: TextAlign.center),
          SizedBox(height: LCASSpacing.lg),
        ],
        widget.child,
        SizedBox(height: LCASSpacing.md),
        ElevatedButton.icon(
          onPressed: _isRetrying ? null : _retry,
          icon: _isRetrying 
              ? SizedBox(
                  width: 16,
                  height: 16,
                  child: CircularProgressIndicator(strokeWidth: 2),
                )
              : Icon(Icons.refresh),
          label: Text(_isRetrying ? '重試中...' : '重試'),
        ),
      ],
    );
  }
  
  void _retry() async {
    setState(() => _isRetrying = true);
    try {
      await widget.onRetry();
    } finally {
      if (mounted) {
        setState(() => _isRetrying = false);
      }
    }
  }
}
```

### 9.4 資料異步更新UI表現

#### 9.4.1 樂觀更新策略
```dart
class OptimisticUpdateManager {
  static void performOptimisticUpdate<T>({
    required List<T> dataList,
    required T newItem,
    required Future<T> Function() apiCall,
    required void Function() onSuccess,
    required void Function(String error) onError,
    required void Function() onRollback,
  }) async {
    // 1. 樂觀更新 - 立即更新UI
    dataList.insert(0, newItem);
    onSuccess();
    
    try {
      // 2. 執行API請求
      final result = await apiCall();
      
      // 3. 更新為伺服器返回的資料
      final index = dataList.indexOf(newItem);
      if (index != -1) {
        dataList[index] = result;
        onSuccess();
      }
    } catch (error) {
      // 4. 失敗時回滾
      dataList.remove(newItem);
      onRollback();
      onError(error.toString());
    }
  }
}

// 使用範例：記帳記錄新增
class EntryProvider extends ChangeNotifier {
  List<Entry> _entries = [];
  
  Future<void> addEntryOptimistic(CreateEntryParams params) async {
    final tempEntry = Entry.fromParams(params, tempId: 'temp_${DateTime.now().millisecondsSinceEpoch}');
    
    OptimisticUpdateManager.performOptimisticUpdate(
      dataList: _entries,
      newItem: tempEntry,
      apiCall: () => _entryService.createEntry(params),
      onSuccess: () => notifyListeners(),
      onError: (error) {
        _showError(error);
        notifyListeners();
      },
      onRollback: () => notifyListeners(),
    );
  }
}
```

---

## 10.0 輔助與無障礙需求（Accessibility Requirements）

### 10.1 無障礙設計原則

#### 10.1.1 WCAG 2.1 AA標準遵循
```dart
class AccessibilityHelper {
  // 色彩對比度檢查
  static bool checkColorContrast(Color foreground, Color background) {
    final ratio = _calculateContrastRatio(foreground, background);
    return ratio >= 4.5; // WCAG AA標準
  }
  
  // 觸控目標大小檢查
  static bool checkTouchTargetSize(double width, double height) {
    return width >= 44.0 && height >= 44.0; // iOS/Android最小觸控大小
  }
  
  // 文字大小調整支援
  static double getScaledFontSize(double baseFontSize, BuildContext context) {
    final mediaQuery = MediaQuery.of(context);
    return baseFontSize * mediaQuery.textScaleFactor.clamp(0.8, 2.0);
  }
}
```

#### 10.1.2 語義化標籤實作
```dart
class AccessibleButton extends StatelessWidget {
  final String text;
  final VoidCallback? onPressed;
  final String? semanticLabel;
  final String? hint;
  
  const AccessibleButton({
    required this.text,
    this.onPressed,
    this.semanticLabel,
    this.hint,
  });
  
  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: semanticLabel ?? text,
      hint: hint,
      button: true,
      enabled: onPressed != null,
      child: ElevatedButton(
        onPressed: onPressed,
        child: Text(text),
      ),
    );
  }
}

class AccessibleTextField extends StatelessWidget {
  final String labelText;
  final String? hintText;
  final TextEditingController? controller;
  final String? Function(String?)? validator;
  
  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: labelText,
      hint: hintText,
      textField: true,
      child: TextFormField(
        controller: controller,
        validator: validator,
        decoration: InputDecoration(
          labelText: labelText,
          hintText: hintText,
        ),
      ),
    );
  }
}
```

### 10.2 VoiceOver / TalkBack支援

#### 10.2.1 螢幕閱讀器優化
```dart
class ScreenReaderOptimizedWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Semantics(
      explicitChildNodes: true,
      child: Column(
        children: [
          // 帳戶餘額 - 重要資訊優先朗讀
          Semantics(
            label: '帳戶餘額',
            value: '新台幣 12,345 元',
            hint: '點擊查看詳細資訊',
            sortKey: OrdinalSortKey(1),
            child: BalanceCard(),
          ),
          
          // 快速記帳按鈕 - 主要操作
          Semantics(
            label: '快速記帳',
            hint: '點擊開始記錄收支',
            button: true,
            sortKey: OrdinalSortKey(2),
            child: QuickEntryButton(),
          ),
          
          // 記帳歷史列表 - 次要內容
          Semantics(
            label: '記帳歷史',
            hint: '最近的記帳記錄',
            sortKey: OrdinalSortKey(3),
            child: EntryHistoryList(),
          ),
        ],
      ),
    );
  }
}
```

#### 10.2.2 語音提示與回饋
```dart
class VoiceAssistanceManager {
  static void announceSuccess(String message) {
    SemanticsService.announce(
      message,
      TextDirection.ltr,
      Assertiveness.polite,
    );
  }
  
  static void announceError(String message) {
    SemanticsService.announce(
      '錯誤：$message',
      TextDirection.ltr,
      Assertiveness.assertive,
    );
  }
  
  static void announceProgress(String message) {
    SemanticsService.announce(
      message,
      TextDirection.ltr,
      Assertiveness.polite,
    );
  }
}

// 使用範例
class EntryFormScreen extends StatefulWidget {
  void _saveEntry() async {
    VoiceAssistanceManager.announceProgress('正在儲存記帳資料');
    
    try {
      await _entryService.createEntry(_formData);
      VoiceAssistanceManager.announceSuccess('記帳資料已成功儲存');
      Navigator.pop(context);
    } catch (e) {
      VoiceAssistanceManager.announceError('儲存失敗，請重試');
    }
  }
}
```

### 10.3 字型放大支援

#### 10.3.1 響應式字型系統
```dart
class ResponsiveTextStyles {
  static TextStyle getResponsiveStyle({
    required BuildContext context,
    required TextStyle baseStyle,
    double? maxScale,
  }) {
    final mediaQuery = MediaQuery.of(context);
    final textScale = (mediaQuery.textScaleFactor).clamp(0.8, maxScale ?? 2.0);
    
    return baseStyle.copyWith(
      fontSize: (baseStyle.fontSize ?? 14.0) * textScale,
    );
  }
  
  // 標題字型 - 允許較大縮放
  static TextStyle headline1(BuildContext context) {
    return getResponsiveStyle(
      context: context,
      baseStyle: LCASTextStyles.headline1,
      maxScale: 1.5, // 標題不需要過度放大
    );
  }
  
  // 內文字型 - 支援完整縮放
  static TextStyle body1(BuildContext context) {
    return getResponsiveStyle(
      context: context,
      baseStyle: LCASTextStyles.body1,
      maxScale: 2.0,
    );
  }
  
  // 按鈕字型 - 限制縮放避免按鈕過大
  static TextStyle button(BuildContext context) {
    return getResponsiveStyle(
      context: context,
      baseStyle: LCASTextStyles.button,
      maxScale: 1.3,
    );
  }
}
```

#### 10.3.2 適應性佈局調整
```dart
class AdaptiveLayout extends StatelessWidget {
  final Widget child;
  
  @override
  Widget build(BuildContext context) {
    final mediaQuery = MediaQuery.of(context);
    final isLargeText = mediaQuery.textScaleFactor > 1.5;
    
    return Padding(
      padding: EdgeInsets.all(
        isLargeText ? LCASSpacing.lg : LCASSpacing.md,
      ),
      child: child,
    );
  }
}

class AdaptiveButtonSize extends StatelessWidget {
  final Widget child;
  final VoidCallback? onPressed;
  
  @override
  Widget build(BuildContext context) {
    final mediaQuery = MediaQuery.of(context);
    final isLargeText = mediaQuery.textScaleFactor > 1.5;
    
    return SizedBox(
      height: isLargeText ? 64.0 : LCASComponentSizes.buttonHeight,
      child: ElevatedButton(
        onPressed: onPressed,
        child: child,
      ),
    );
  }
}
```

### 10.4 其他輔助功能

#### 10.4.1 高對比度模式支援
```dart
class HighContrastTheme {
  static ThemeData getHighContrastTheme() {
    return ThemeData(
      brightness: Brightness.dark,
      primaryColor: Colors.white,
      colorScheme: ColorScheme.dark(
        primary: Colors.white,
        secondary: Colors.yellow,
        surface: Colors.black,
        background: Colors.black,
        error: Colors.red[300]!,
      ),
      textTheme: TextTheme(
        bodyText1: TextStyle(color: Colors.white, fontSize: 18),
        bodyText2: TextStyle(color: Colors.white, fontSize: 16),
      ),
    );
  }
}

class ThemeManager extends ChangeNotifier {
  bool _isHighContrast = false;
  
  bool get isHighContrast => _isHighContrast;
  
  void toggleHighContrast() {
    _isHighContrast = !_isHighContrast;
    notifyListeners();
  }
  
  ThemeData getCurrentTheme() {
    return _isHighContrast 
        ? HighContrastTheme.getHighContrastTheme()
        : _getStandardTheme();
  }
}
```

#### 10.4.2 觸覺回饋支援
```dart
class HapticFeedbackManager {
  static void lightImpact() {
    HapticFeedback.lightImpact();
  }
  
  static void mediumImpact() {
    HapticFeedback.mediumImpact();
  }
  
  static void heavyImpact() {
    HapticFeedback.heavyImpact();
  }
  
  static void selectionClick() {
    HapticFeedback.selectionClick();
  }
  
  // 成功操作回饋
  static void success() {
    HapticFeedback.lightImpact();
  }
  
  // 錯誤操作回饋
  static void error() {
    HapticFeedback.heavyImpact();
  }
  
  // 按鈕點擊回饋
  static void buttonPress() {
    HapticFeedback.selectionClick();
  }
}

// 在按鈕中整合觸覺回饋
class HapticButton extends StatelessWidget {
  final Widget child;
  final VoidCallback? onPressed;
  
  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: onPressed == null ? null : () {
        HapticFeedbackManager.buttonPress();
        onPressed!();
      },
      child: child,
    );
  }
}
```

---

## 11.0 API呼叫對應表（API Mapping）

### 11.1 展示層API呼叫關係

#### 11.1.1 認證流程API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P002登入 | 點擊LINE登入 | F002 | POST | `/auth/login` | 儲存Token，導向首頁 |
| P002登入 | Email登入 | F002 | POST | `/auth/login` | 儲存Token，導向首頁 |
| P003註冊 | 提交註冊表單 | F001 | POST | `/auth/register` | 自動登入，導向首頁 |
| P005設定 | 查看個人資料 | F003 | GET | `/auth/user` | 顯示用戶資訊 |
| P005設定 | 更新個人資料 | F004 | PUT | `/auth/user` | 更新本地資料 |
| P005設定 | 登出帳號 | F005 | POST | `/auth/logout` | 清除Token，導向登入 |

#### 11.1.2 記帳管理API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P010首頁 | 載入首頁資料 | F007 | GET | `/entries?limit=10` | 顯示最近記錄 |
| P011快速記帳 | 儲存記帳記錄 | F006 | POST | `/entries/quick` | 樂觀更新列表 |
| P012詳細記帳 | 儲存記帳記錄 | F006 | POST | `/entries` | 返回列表頁面 |
| P013記帳歷史 | 查詢記錄 | F007 | GET | `/entries` | 分頁載入記錄 |
| P013記帳歷史 | 搜尋記錄 | F007 | GET | `/entries?search=xxx` | 過濾顯示結果 |
| P014記帳編輯 | 更新記錄 | F008 | PUT | `/entries/{id}` | 更新列表項目 |
| P015刪除確認 | 刪除記錄 | F009 | DELETE | `/entries/{id}` | 從列表移除 |

#### 11.1.3 多帳本管理API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P020帳本清單 | 載入帳本列表 | F011 | GET | `/projects` | 顯示帳本卡片 |
| P021帳本建立 | 建立新帳本 | F010 | POST | `/projects` | 加入帳本列表 |
| P022帳本設定 | 更新帳本設定 | F012 | PUT | `/projects/{id}` | 更新帳本資訊 |
| P023帳本刪除 | 刪除帳本 | F013 | DELETE | `/projects/{id}` | 從列表移除 |
| P024成員管理 | 查看成員列表 | F014 | GET | `/projects/{id}/members` | 顯示成員資訊 |
| P024成員管理 | 設定成員權限 | F014 | PUT | `/projects/{id}/members` | 更新權限顯示 |
| P025帳本切換 | 切換帳本 | F015 | GET | `/ledgers/switch` | 更新全域狀態 |

#### 11.1.4 預算管理API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P030預算總覽 | 查看預算進度 | F017 | GET | `/budgets/{id}/progress` | 更新進度圖表 |
| P031預算建立 | 建立預算 | F016 | POST | `/budgets` | 加入預算列表 |
| P032預算編輯 | 更新預算 | F016 | PUT | `/budgets/{id}` | 更新預算資訊 |
| P033預算進度 | 查看詳細進度 | F017 | GET | `/budgets/{id}/progress` | 顯示詳細統計 |
| P034警示設定 | 設定預算警示 | F018 | PUT | `/budgets/{id}/alerts` | 更新警示狀態 |

#### 11.1.5 協作功能API對應（Enterprise模式）
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P041建立共享帳本 | 建立共享帳本 | F019 | POST | `/shared/ledgers` | 建立協作空間 |
| P042權限管理 | 設定成員權限 | F020 | PUT | `/shared/ledgers/{id}/permissions` | 更新權限介面 |
| P043同步狀態 | 即時同步 | F021 | WebSocket | `/sync/realtime` | 即時更新資料 |

#### 11.1.6 報表功能API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P050報表中心 | 生成基礎報表 | F022 | POST | `/reports/generate` | 顯示圖表 |
| P052自訂報表 | 建立自訂報表 | F023 | POST | `/reports/custom` | 儲存報表設定 |
| P053報表匯出 | 匯出報表 | F024 | GET | `/reports/{id}/export` | 下載檔案 |

#### 11.1.7 系統管理API對應
| 畫面 | 使用者操作 | 呼叫API | HTTP方法 | 參數 | 回應處理 |
|------|------------|---------|----------|------|----------|
| P061備份管理 | 排程備份 | F025 | POST | `/system/backup/schedule` | 更新備份設定 |
| P061備份管理 | 手動備份 | F026 | POST | `/backups/manual` | 顯示備份進度 |
| P061備份管理 | 查看備份列表 | F027 | GET | `/backups` | 顯示備份歷史 |
| P062同步狀態 | 檢查同步狀態 | F028 | GET | `/system/sync/status` | 更新同步指示器 |
| P063系統健康 | 查看系統狀態 | F029 | GET | `/system/health` | 顯示健康狀態 |
| P064錯誤日誌 | 查看錯誤日誌 | F030 | GET | `/system/logs/errors` | 顯示日誌列表 |
| P065提醒設定 | 建立提醒 | F031 | POST | `/reminders` | 更新提醒列表 |
| P065提醒設定 | 執行提醒 | F032 | POST | `/reminders/execute` | 觸發提醒通知 |

### 11.2 API呼叫策略

#### 11.2.1 快取策略對應
```dart
class APICallStrategy {
  static const Map<String, CacheStrategy> apiCacheStrategies = {
    // 使用者資料 - 中期快取
    'GET:/auth/user': CacheStrategy.cacheFirst,
    
    // 記帳歷史 - 短期快取，優先網路
    'GET:/entries': CacheStrategy.networkFirst,
    
    // 帳本列表 - 中期快取
    'GET:/projects': CacheStrategy.cacheFirst,
    
    // 預算進度 - 短期快取
    'GET:/budgets/{id}/progress': CacheStrategy.networkFirst,
    
    // 報表資料 - 長期快取
    'GET:/reports': CacheStrategy.cacheFirst,
    
    // 即時資料 - 不快取
    'POST:/entries': CacheStrategy.networkOnly,
    'PUT:/entries/{id}': CacheStrategy.networkOnly,
    'DELETE:/entries/{id}': CacheStrategy.networkOnly,
    
    // 系統狀態 - 極短期快取
    'GET:/system/health': CacheStrategy.networkFirst,
    'GET:/system/sync/status': CacheStrategy.networkFirst,
  };
}
```

#### 11.2.2 錯誤處理對應
```dart
class APIErrorHandler {
  static void handleAPIError(
    BuildContext context,
    String apiEndpoint,
    dynamic error,
  ) {
    switch (apiEndpoint) {
      case '/auth/login':
      case '/auth/register':
        _handleAuthError(context, error);
        break;
        
      case '/entries':
      case '/entries/quick':
        _handleEntryError(context, error);
        break;
        
      case '/projects':
        _handleLedgerError(context, error);
        break;
        
      case '/budgets':
        _handleBudgetError(context, error);
        break;
        
      default:
        _handleGenericError(context, error);
    }
  }
  
  static void _handleAuthError(BuildContext context, dynamic error) {
    if (error.code == 'INVALID_CREDENTIALS') {
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: Text('登入失敗'),
          content: Text('帳號或密碼錯誤，請重新輸入'),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('確定'),
            ),
          ],
        ),
      );
    }
  }
  
  static void _handleEntryError(BuildContext context, dynamic error) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('記帳操作失敗：${error.message}'),
        action: SnackBarAction(
          label: '重試',
          onPressed: () => _retryLastOperation(),
        ),
      ),
    );
  }
}
```

---

## 12.0 版本升級計畫（Version Upgrade）

### 12.1 模組版本規劃

| 模組名稱 | 當前版本 | 目標版本 | 升級內容 | 相依性 |
|----------|----------|----------|----------|--------|
| **Flutter_Presentation_Layer** | 舊版 | v3.0.0 | 重構為標準PRD格式，四模式差異化設計 | AP Layer v2.0.0 |
| **UI Components** | - | v3.0.0 | 統一元件庫，支援四模式 | Material Design 3.0 |
| **Navigation System** | - | v3.0.0 | 路由管理，模式差異導航 | Flutter Router v2 |
| **Theme System** | - | v3.0.0 | 多主題支援，無障礙優化 | Material Theming |
| **State Management** | - | v3.0.0 | Provider/Riverpod整合 | AP Layer v2.0.0 |

### 12.2 畫面版本升級計畫

#### 12.2.1 認證流程畫面 (P001-P005)
| 畫面ID | 當前狀態 | 目標版本 | 升級重點 | 完成時程 |
|--------|----------|----------|----------|----------|
| P001 | 新建 | v3.0.0 | 歡迎引導頁，模式選擇 | Week 1 |
| P002 | 重構 | v3.0.0 | LINE登入整合，多模式UI | Week 1 |
| P003 | 重構 | v3.0.0 | 註冊流程優化 | Week 1 |
| P004 | 新建 | v3.0.0 | 忘記密碼流程 | Week 1 |
| P005 | 新建 | v3.0.0 | 個人設定頁面 | Week 2 |

#### 12.2.2 記帳管理畫面 (P010-P019)
| 畫面ID | 當前狀態 | 目標版本 | 升級重點 | 完成時程 |
|--------|----------|----------|----------|----------|
| P010 | 重構 | v3.0.0 | 四模式差異化首頁 | Week 2 |
| P011 | 重構 | v3.0.0 | 快速記帳優化 | Week 2 |
| P012 | 重構 | v3.0.0 | 詳細記帳表單 | Week 3 |
| P013 | 重構 | v3.0.0 | 記帳歷史列表，分頁載入 | Week 3 |
| P014-P019 | 新建 | v3.0.0 | 編輯、刪除、批量操作等 | Week 4 |

#### 12.2.3 多帳本管理畫面 (P020-P029)
| 畫面ID | 當前狀態 | 目標版本 | 升級重點 | 完成時程 |
|--------|----------|----------|----------|----------|
| P020-P029 | 新建 | v3.0.0 | 完整多帳本管理功能 | Week 5-6 |

#### 12.2.4 其他功能畫面升級
| 功能群組 | 畫面數量 | 目標版本 | 完成時程 |
|----------|----------|----------|----------|
| 預算管理 (P030-P039) | 10個 | v3.0.0 | Week 7-8 |
| 協作功能 (P040-P049) | 10個 | v3.0.0 | Week 9-10 |
| 報表功能 (P050-P059) | 10個 | v3.0.0 | Week 11-12 |
| 系統管理 (P060-P069) | 10個 | v3.0.0 | Week 13-14 |

### 12.3 開發里程碑

#### 12.3.1 Phase 1: 基礎架構與認證 (Week 1-2)
- ✅ 設計系統建立
- ✅ 四模式主題系統
- ✅ 路由管理架構
- 🔄 認證流程畫面實作
- 🔄 無障礙基礎設施

#### 12.3.2 Phase 2: 核心記帳功能 (Week 3-4)
- ⏳ 首頁四模式差異化
- ⏳ 快速記帳優化
- ⏳ 記帳歷史管理
- ⏳ 表單驗證系統

#### 12.3.3 Phase 3: 進階功能 (Week 5-8)
- ⏳ 多帳本管理系統
- ⏳ 預算管理功能
- ⏳ 狀態管理整合
- ⏳ API層整合

#### 12.3.4 Phase 4: 協作與報表 (Week 9-12)
- ⏳ 企業協作功能
- ⏳ 報表視覺化
- ⏳ 即時同步機制
- ⏳ 進階分析功能

#### 12.3.5 Phase 5: 系統功能與優化 (Week 13-14)
- ⏳ 系統管理介面
- ⏳ 效能優化
- ⏳ 測試完善
- ⏳ 文件整理

### 12.4 向後相容性保證

#### 12.4.1 模式相容性策略
```dart
class ModeCompatibilityManager {
  static Widget buildCompatibleWidget({
    required UserMode currentMode,
    required Widget simplifiedWidget,
    required Widget standardWidget,
    required Widget advancedWidget,
    required Widget enterpriseWidget,
  }) {
    switch (currentMode) {
      case UserMode.simplified:
        return simplifiedWidget;
      case UserMode.standard:
        return standardWidget;
      case UserMode.advanced:
        return advancedWidget;
      case UserMode.enterprise:
        return enterpriseWidget;
      default:
        return standardWidget; // 預設回退
    }
  }
}
```

#### 12.4.2 API版本相容
```dart
class UIVersionManager {
  static const String currentUIVersion = 'v3.0.0';
  static const List<String> supportedAPIVersions = ['v1.0.0', 'v2.0.0'];
  
  static bool isAPIVersionSupported(String apiVersion) {
    return supportedAPIVersions.contains(apiVersion);
  }
  
  static Widget buildAPICompatibleUI(String apiVersion) {
    if (apiVersion == 'v1.0.0') {
      return LegacyUIWrapper();
    }
    return ModernUIWrapper();
  }
}
```

---

## 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| **v3.0.0** | **2025-01-24** | **LCAS PM Team** | **完整重構：參考9006文件格式，建立標準PRD結構，新增四模式差異化設計、69個畫面規格、完整無障礙支援、API呼叫對應表等** |

---

## 備註

- **版本3.0.0重大特色**: 從技術導向轉為產品需求導向的標準PRD文件
- **四模式差異化**: Simplified、Standard、Advanced、Enterprise四種使用者模式
- **69個畫面完整規格**: 涵蓋認證、記帳、多帳本、預算、協作、報表、系統等7大功能群組
- **完整無障礙支援**: 遵循WCAG 2.1 AA標準，支援VoiceOver/TalkBack
- **API整合對應**: 完整的32個API端點與UI操作對應關係
- **模式權限控制**: 不同模式支援不同功能集合
- **響應式設計**: 支援不同螢幕尺寸和字型縮放
- **錯誤處理機制**: 統一的錯誤處理和用戶友善提示
- **Loading狀態設計**: Skeleton UI、Shimmer效果、樂觀更新
- **導航系統**: 支援四模式差異化導航和路由守衛
- **技術實作**: 請參考91資料夾中的具體程式碼實作
- **AP Layer整合**: 配合9006. Flutter_AP layer.md進行後端整合
- **專案文件**: 配合92資料夾中的User Story、Wireflow等文件
