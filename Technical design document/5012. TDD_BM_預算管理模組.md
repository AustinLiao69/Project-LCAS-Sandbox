# 5012. TDD_BM_預算管理模組_v1.0

## 文件資訊
- **文件標題**: BM 預算管理模組技術設計文件
- **文件版本**: v1.0
- **創建日期**: 2025-07-07 14:15:41 +08:00 (台灣時間)
- **創建者**: AustinLiao69
- **對應需求文件**: 1012. BM_預算管理模組.md
- **模組代碼**: BM (Budget Management)

---

## 1.0 技術架構概述

### 1.1 模組定位
BM 預算管理模組作為 LCAS 2.0 的核心支柱模組，負責為不同類型帳本提供預算設定、追蹤、警示等完整的預算管理功能，與多帳本管理模組緊密整合。

### 1.2 技術堆疊
- **後端框架**: Node.js/Express
- **資料庫**: Firestore
- **日誌系統**: DL 模組
- **通知系統**: LINE OA模組
- **資料同步**: DD 資料分發模組

### 1.3 模組架構
```javascript
/**
 * BM_預算管理模組_1.0.0
 * @module BM模組 
 * @description 預算管理系統 - 支援預算設定、追蹤、警示與分析
 * @update 2025-07-07: 初版建立，實現多帳本預算管理與智慧警示
 */
```

---

## 2.0 核心函數設計

### 2.1 預算設定函數

```javascript
/**
 * 01. 建立帳本預算
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 為指定帳本建立預算計畫
 */
function BM_createBudget(ledgerId, userId, budgetData, budgetType)
```
- **功能**: 建立月度/年度/專案預算，支援分類預算
- **與其他模組互動**:
  - `DL_log()` - 記錄預算建立日誌
  - **MLS模組** - 驗證帳本存取權限
  - Firestore - 建立 budgets collection 文件
- **回傳值**: `{success: boolean, budgetId: string, message: string}`

```javascript
/**
 * 02. 編輯預算設定
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 修改現有預算的金額、期間、分類設定
 */
function BM_editBudget(budgetId, userId, updateData)
```
- **功能**: 安全編輯預算設定，含歷史記錄
- **與其他模組互動**:
  - **協作管理模組** - 驗證編輯權限
  - `DD_distributeData()` - 分發預算變更
- **回傳值**: `{success: boolean, updatedFields: array, message: string}`

```javascript
/**
 * 03. 刪除預算
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 刪除預算設定（含二次確認）
 */
function BM_deleteBudget(budgetId, userId, confirmationToken)
```
- **功能**: 安全刪除預算，保留歷史資料
- **與其他模組互動**:
  - **備份服務模組** - 建立刪除前備份
  - `DL_warning()` - 記錄刪除操作日誌

### 2.2 預算追蹤函數

```javascript
/**
 * 04. 計算預算執行進度
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 即時計算預算使用率和剩餘金額
 */
function BM_calculateBudgetProgress(budgetId, dateRange)
```
- **功能**: 即時預算執行狀況分析
- **與其他模組互動**:
  - **BK模組** `BK_processBookkeeping()` - 取得記帳資料
  - **MRA模組** - 生成預算分析報表
- **回傳值**: `{progress: number, remaining: number, status: string}`

```javascript
/**
 * 05. 更新預算使用記錄
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 當有新記帳時自動更新預算使用狀況
 */
function BM_updateBudgetUsage(ledgerId, transactionData)
```
- **功能**: 自動同步記帳與預算追蹤
- **與其他模組互動**:
  - **BK模組** - 監聽記帳事件
  - `BM_checkBudgetAlert()` - 觸發警示檢查
- **回傳值**: `{updated: boolean, newUsage: number, alertTriggered: boolean}`

```javascript
/**
 * 06. 取得預算執行報告
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 生成指定期間的預算執行報告
 */
function BM_getBudgetReport(budgetId, reportType, dateRange)
```
- **功能**: 多維度預算執行分析報告
- **與其他模組互動**:
  - **MRA模組** `reportGenerator.js` - 生成視覺化報表
  - **DD模組** - 資料彙整分析
- **回傳值**: `{reportData: object, charts: array, summary: object}`

### 2.3 預算警示函數

```javascript
/**
 * 07. 檢查預算警示條件
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 檢查是否觸發預算警示條件
 */
function BM_checkBudgetAlert(budgetId, currentUsage)
```
- **功能**: 智慧預算警示條件檢查
- **與其他模組互動**:
  - `BM_triggerBudgetAlert()` - 觸發警示通知
  - `DL_info()` - 記錄警示檢查日誌
- **回傳值**: `{alertRequired: boolean, alertLevel: string, message: string}`

```javascript
/**
 * 08. 觸發預算警示通知
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 發送預算超支或接近上限的警示通知
 */
function BM_triggerBudgetAlert(budgetId, alertType, recipientList)
```
- **功能**: 多管道預算警示通知
- **與其他模組互動**:
  - **LINE OA模組** - 發送 LINE 通知
  - **協作管理模組** - 取得通知對象清單
- **回傳值**: `{sent: boolean, recipients: array, alertId: string}`

```javascript
/**
 * 09. 設定預算警示規則
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 自訂預算警示觸發條件和通知方式
 */
function BM_setBudgetAlertRules(budgetId, alertRules)
```
- **功能**: 彈性的警示規則設定
- **與其他模組互動**:
  - `DD_distributeData()` - 分發警示規則設定
  - Firestore - 儲存警示規則配置
- **回傳值**: `{success: boolean, rulesCount: number, message: string}`

### 2.4 預算分析函數

```javascript
/**
 * 10. 預算趨勢分析
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 分析預算使用趨勢和預測
 */
function BM_analyzeBudgetTrend(budgetId, analysisType, timeRange)
```
- **功能**: 預算趨勢分析與預測
- **與其他模組互動**:
  - **MRA模組** `reportGenerator.js` - 生成趨勢圖表
  - **BK模組** - 取得歷史記帳資料
- **回傳值**: `{trendData: array, prediction: object, insights: array}`

```javascript
/**
 * 11. 跨帳本預算比較
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 比較不同帳本的預算執行效率
 */
function BM_compareBudgetAcrossLedgers(ledgerIds, comparisonType)
```
- **功能**: 多帳本預算效率比較分析
- **與其他模組互動**:
  - **MLS模組** - 驗證多帳本存取權限
  - **MRA模組** - 生成比較分析報表
- **回傳值**: `{comparisonData: object, ranking: array, recommendations: array}`

### 2.5 預算分類管理函數

```javascript
/**
 * 12. 建立預算分類
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 建立預算分類（如生活、娛樂、交通）
 */
function BM_createBudgetCategory(ledgerId, categoryData)
```
- **功能**: 靈活的預算分類管理
- **與其他模組互動**:
  - **MLS模組** - 整合帳本分類設定
  - `DD_distributeData()` - 分發分類配置
- **回傳值**: `{success: boolean, categoryId: string, message: string}`

```javascript
/**
 * 13. 分配預算至分類
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 將總預算分配至各個分類
 */
function BM_allocateBudgetToCategories(budgetId, allocationData)
```
- **功能**: 智慧預算分配與調整
- **與其他模組互動**:
  - `BM_validateAllocation()` - 驗證分配邏輯
  - `DL_log()` - 記錄分配操作
- **回傳值**: `{success: boolean, allocations: array, totalAllocated: number}`

### 2.6 錯誤處理與監控函數

```javascript
/**
 * 14. 處理預算設定錯誤
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 統一處理預算設定相關錯誤
 */
function BM_handleBudgetError(errorType, errorData, userId)
```
- **功能**: 標準化預算錯誤處理
- **與其他模組互動**:
  - `DL_error()` - 記錄錯誤詳情
  - **LINE OA模組** - 發送錯誤通知
- **回傳值**: `{handled: boolean, errorCode: string, message: string}`

```javascript
/**
 * 15. 驗證預算數據完整性
 * @version 2025-07-07-V1.0.0
 * @date 2025-07-07 14:15:41
 * @description 檢查預算資料的邏輯正確性
 */
function BM_validateBudgetData(budgetData, validationType)
```
- **功能**: 預算資料驗證與修復
- **與其他模組互動**:
  - Firestore - 查詢相關資料驗證
  - `DL_warning()` - 記錄驗證警告
- **回傳值**: `{valid: boolean, errors: array, suggestions: array}`

---

## 3.0 模組間互動架構

### 3.1 核心依賴關係
```
BM 預算管理模組
├── MLS模組 (Multi-Ledger System)
│   ├── MLS_validateLedgerAccess() - 帳本權限驗證
│   └── MLS_getLedgerList() - 取得帳本資訊
├── BK模組 (Bookkeeping)
│   ├── BK_processBookkeeping() - 記帳資料整合
│   └── 記帳事件監聽 - 自動更新預算使用
├── DL模組 (Data Logging)
│   ├── DL_log() - 一般操作日誌
│   ├── DL_error() - 錯誤日誌
│   └── DL_warning() - 警告日誌
├── DD模組 (Data Distribution)
│   └── DD_distributeData() - 預算資料分發
├── MRA模組 (Multi-platform Report & Analytics)
│   ├── reportGenerator.js - 預算報表產出
│   └── 趨勢分析與視覺化
├── 協作管理模組 (Collaboration)
│   └── permissionController.js - 預算編輯權限
└── LINE OA模組
    └── 預算警示通知發送
```

### 3.2 資料流向設計
```
記帳事件 → BM預算更新 → 警示檢查 → 通知發送
預算設定 → 權限驗證 → 資料儲存 → 分發同步
預算查詢 → 資料計算 → 報表生成 → 結果回傳
```

---

## 4.0 資料庫架構設計

### 4.1 Firestore 集合結構
```
budgets/
├── {budget_id}/
│   ├── ledger_id: string
│   ├── name: string
│   ├── type: "monthly" | "yearly" | "project" | "category"
│   ├── amount: number
│   ├── used_amount: number
│   ├── currency: string
│   ├── start_date: timestamp
│   ├── end_date: timestamp
│   ├── categories: array
│   ├── alert_rules: object
│   ├── created_by: string
│   ├── created_at: timestamp
│   ├── updated_at: timestamp
│   └── status: "active" | "completed" | "archived"

budget_alerts/
├── {alert_id}/
│   ├── budget_id: string
│   ├── alert_type: "warning" | "critical" | "exceeded"
│   ├── trigger_condition: object
│   ├── triggered_at: timestamp
│   ├── notification_sent: boolean
│   └── recipients: array
```

### 4.2 預算分類結構設計
```javascript
categories: [
  {
    id: "category_001",
    name: "生活費",
    allocated_amount: 15000,
    used_amount: 8500,
    percentage: 30,
    alert_threshold: 80
  }
]
```

---

## 5.0 API 介面規格

### 5.1 REST API 端點
```
POST   /api/v2/budgets/create           - 建立新預算
GET    /api/v2/budgets/list             - 取得預算清單
PUT    /api/v2/budgets/{id}/edit        - 編輯預算
DELETE /api/v2/budgets/{id}/delete      - 刪除預算
GET    /api/v2/budgets/{id}/progress    - 取得預算進度
POST   /api/v2/budgets/{id}/alert       - 設定預算警示
GET    /api/v2/budgets/{id}/report      - 生成預算報告
POST   /api/v2/budgets/categories       - 建立預算分類
```

### 5.2 WebSocket 事件
```javascript
// 即時預算事件
'budget:updated'        - 預算使用更新
'budget:alert_triggered' - 警示觸發
'budget:threshold_reached' - 閾值達成
'budget:completed'      - 預算週期完成
```

---

## 6.0 效能與擴展性考量

### 6.1 快取策略
- 預算基本資訊快取 (10分鐘)
- 預算使用進度快取 (5分鐘)
- 警示規則快取 (30分鐘)

### 6.2 即時處理
- 記帳事件即時預算更新
- 警示條件即時檢查
- 進度計算優化演算法

---

## 7.0 文件維護記錄

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-07-07 14:15:41 +08:00 | AustinLiao69 | 初版建立，完整技術設計 |

---

**文件結束**
*此文件為 LCAS 2.0 BM 預算管理模組的完整技術設計規格，所有函數設計均基於預算管理需求並整合多帳本系統架構。*