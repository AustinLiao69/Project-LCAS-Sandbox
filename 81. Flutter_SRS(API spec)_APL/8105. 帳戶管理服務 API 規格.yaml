
openapi: 3.0.3
info:
  title: 帳戶管理服務 API 規格
  description: LCAS 帳戶管理服務API規格，提供帳戶CRUD、餘額管理和類型分類功能
  version: 2.0.0
  contact:
    name: LCAS SA Team
    email: sa@lcas.com

servers:
  - url: https://api.lcas.com/v2
    description: Production server
  - url: https://staging-api.lcas.com/v2
    description: Staging server

tags:
  - name: Account Management
    description: 帳戶管理相關操作
  - name: Balance Management
    description: 餘額管理功能
  - name: Account Types
    description: 帳戶類型管理

paths:
  /accounts:
    get:
      tags:
        - Account Management
      summary: 取得帳戶列表
      description: 取得用戶可存取的帳戶列表，支援分頁和篩選
      operationId: getAccounts
      parameters:
        - name: userId
          in: query
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
        - name: ledgerId
          in: query
          description: 帳本ID篩選
          schema:
            type: string
            example: "user_Uae47d9d496e4596d70ed724a7d6e2948"
        - name: userMode
          in: query
          description: 用戶模式（影響回應內容）
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
            default: Expert
            example: "Expert"
        - name: type
          in: query
          description: 帳戶類型篩選
          schema:
            type: string
            enum: [cash, bank, credit_card, investment, loan, other]
            example: "bank"
        - name: status
          in: query
          description: 帳戶狀態篩選
          schema:
            type: string
            enum: [active, inactive, closed]
            default: active
            example: "active"
        - name: keyword
          in: query
          description: 關鍵字搜尋（帳戶名稱、描述）
          schema:
            type: string
            example: "台新銀行"
        - name: includeBalance
          in: query
          description: 是否包含餘額資訊
          schema:
            type: boolean
            default: true
            example: true
        - name: page
          in: query
          description: 頁碼
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: sort
          in: query
          description: 排序方式
          schema:
            type: string
            enum: [createdAt_desc, createdAt_asc, name_asc, name_desc, balance_desc, balance_asc]
            default: createdAt_desc
            example: "name_asc"
        - name: filter
          in: query
          description: 進階篩選條件（JSON格式）
          schema:
            type: string
            example: '{"hasTransactions":true,"balanceRange":{"min":0,"max":100000}}'
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accounts:
                        type: array
                        items:
                          type: object
                          properties:
                            accountId:
                              type: string
                              description: 帳戶ID
                              example: "account_12345"
                            name:
                              type: string
                              description: 帳戶名稱
                              example: "台新銀行支票帳戶"
                            description:
                              type: string
                              description: 帳戶描述
                              example: "主要往來銀行帳戶"
                            type:
                              type: string
                              enum: [cash, bank, credit_card, investment, loan, other]
                              description: 帳戶類型
                              example: "bank"
                            subtype:
                              type: string
                              description: 帳戶子類型
                              example: "checking"
                            ledgerId:
                              type: string
                              description: 所屬帳本ID
                              example: "user_Uae47d9d496e4596d70ed724a7d6e2948"
                            ownerId:
                              type: string
                              description: 擁有者ID
                              example: "Uae47d9d496e4596d70ed724a7d6e2948"
                            status:
                              type: string
                              enum: [active, inactive, closed]
                              description: 帳戶狀態
                              example: "active"
                            currency:
                              type: string
                              description: 幣別
                              example: "NTD"
                            balance:
                              type: object
                              description: 餘額資訊（根據includeBalance參數）
                              properties:
                                current:
                                  type: number
                                  example: 15678.90
                                available:
                                  type: number
                                  example: 15678.90
                                lastUpdated:
                                  type: string
                                  format: date-time
                                  example: "2025-08-22T12:00:00Z"
                            bankInfo:
                              type: object
                              description: 銀行資訊（bank類型特有）
                              properties:
                                bankCode:
                                  type: string
                                  example: "812"
                                branchCode:
                                  type: string
                                  example: "0001"
                                accountNumber:
                                  type: string
                                  example: "****1234"
                            creditInfo:
                              type: object
                              description: 信用卡資訊（credit_card類型特有）
                              properties:
                                creditLimit:
                                  type: number
                                  example: 100000.00
                                availableCredit:
                                  type: number
                                  example: 84321.10
                                lastFour:
                                  type: string
                                  example: "1234"
                            settings:
                              type: object
                              description: 帳戶設定（Expert模式顯示）
                              properties:
                                isDefault:
                                  type: boolean
                                  example: false
                                includeInNetWorth:
                                  type: boolean
                                  example: true
                                autoSync:
                                  type: boolean
                                  example: false
                            statistics:
                              type: object
                              description: 帳戶統計（根據用戶模式顯示不同詳細程度）
                              properties:
                                transactionCount:
                                  type: integer
                                  example: 45
                                lastTransaction:
                                  type: string
                                  format: date-time
                                  example: "2025-08-22T10:30:00Z"
                                monthlyAverage:
                                  type: number
                                  example: 2500.00
                            createdAt:
                              type: string
                              format: date-time
                              description: 創建時間
                              example: "2025-08-22T12:00:00Z"
                            updatedAt:
                              type: string
                              format: date-time
                              description: 最後更新時間
                              example: "2025-08-22T12:00:00Z"
                  metadata:
                    type: object
                    properties:
                      pagination:
                        type: object
                        properties:
                          currentPage:
                            type: integer
                            example: 1
                          totalPages:
                            type: integer
                            example: 2
                          totalCount:
                            type: integer
                            example: 25
                          hasNext:
                            type: boolean
                            example: true
                          hasPrevious:
                            type: boolean
                            example: false
                          pageSize:
                            type: integer
                            example: 20
                      filters:
                        type: object
                        properties:
                          appliedFilters:
                            type: object
                            example: {"type": "bank", "status": "active"}
                          userMode:
                            type: string
                            example: "Expert"
                          includeBalance:
                            type: boolean
                            example: true
                      summary:
                        type: object
                        properties:
                          totalAccounts:
                            type: integer
                            example: 25
                          totalBalance:
                            type: number
                            description: 總餘額（includeBalance=true時）
                            example: 156789.50
                          accountTypes:
                            type: object
                            properties:
                              bank:
                                type: integer
                                example: 8
                              cash:
                                type: integer
                                example: 12
                              credit_card:
                                type: integer
                                example: 5

    post:
      tags:
        - Account Management
      summary: 創建新帳戶
      description: 創建新的記帳帳戶
      operationId: createAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - type
                - ledgerId
                - ownerId
              properties:
                name:
                  type: string
                  description: 帳戶名稱
                  example: "台新銀行支票帳戶"
                description:
                  type: string
                  description: 帳戶描述
                  example: "主要往來銀行帳戶"
                type:
                  type: string
                  enum: [cash, bank, credit_card, investment, loan, other]
                  description: 帳戶類型
                  example: "bank"
                subtype:
                  type: string
                  description: 帳戶子類型
                  example: "checking"
                ledgerId:
                  type: string
                  description: 所屬帳本ID
                  example: "user_Uae47d9d496e4596d70ed724a7d6e2948"
                ownerId:
                  type: string
                  description: 擁有者ID
                  example: "Uae47d9d496e4596d70ed724a7d6e2948"
                currency:
                  type: string
                  description: 幣別
                  default: "NTD"
                  example: "NTD"
                initialBalance:
                  type: number
                  description: 初始餘額
                  default: 0
                  example: 10000.00
                bankInfo:
                  type: object
                  description: 銀行資訊（bank類型需要）
                  properties:
                    bankCode:
                      type: string
                      example: "812"
                    branchCode:
                      type: string
                      example: "0001"
                    accountNumber:
                      type: string
                      example: "123456789012"
                creditInfo:
                  type: object
                  description: 信用卡資訊（credit_card類型需要）
                  properties:
                    creditLimit:
                      type: number
                      example: 100000.00
                    lastFour:
                      type: string
                      example: "1234"
                    issuer:
                      type: string
                      example: "台新銀行"
                settings:
                  type: object
                  description: 帳戶設定
                  properties:
                    isDefault:
                      type: boolean
                      default: false
                      example: false
                    includeInNetWorth:
                      type: boolean
                      default: true
                      example: true
                    autoSync:
                      type: boolean
                      default: false
                      example: false
      responses:
        '201':
          description: 創建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        description: 帳戶ID
                        example: "account_1692700800000"
                      name:
                        type: string
                        description: 帳戶名稱
                        example: "台新銀行支票帳戶"
                      type:
                        type: string
                        description: 帳戶類型
                        example: "bank"
                      ledgerId:
                        type: string
                        description: 所屬帳本ID
                        example: "user_Uae47d9d496e4596d70ed724a7d6e2948"
                      balance:
                        type: number
                        description: 初始餘額
                        example: 10000.00
                      createdAt:
                        type: string
                        format: date-time
                        description: 創建時間
                        example: "2025-08-22T12:00:00Z"
                  metadata:
                    type: object
                    properties:
                      settings:
                        type: object
                        properties:
                          currency:
                            type: string
                            example: "NTD"
                          isDefault:
                            type: boolean
                            example: false

  /accounts/{accountId}:
    get:
      tags:
        - Account Management
      summary: 取得帳戶詳細資訊
      description: 取得指定帳戶的詳細資訊
      operationId: getAccountDetails
      parameters:
        - name: accountId
          in: path
          required: true
          description: 帳戶ID
          schema:
            type: string
            example: "account_12345"
        - name: userId
          in: query
          required: true
          description: 請求用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
        - name: userMode
          in: query
          description: 用戶模式（影響回應內容細節）
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
            default: Expert
            example: "Expert"
        - name: includeTransactions
          in: query
          description: 是否包含最近交易
          schema:
            type: boolean
            default: false
            example: true
        - name: includeStatistics
          in: query
          description: 是否包含統計資訊
          schema:
            type: boolean
            default: true
            example: true
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        description: 帳戶ID
                        example: "account_12345"
                      name:
                        type: string
                        description: 帳戶名稱
                        example: "台新銀行支票帳戶"
                      description:
                        type: string
                        description: 帳戶描述
                        example: "主要往來銀行帳戶"
                      type:
                        type: string
                        description: 帳戶類型
                        example: "bank"
                      subtype:
                        type: string
                        description: 帳戶子類型
                        example: "checking"
                      ledgerId:
                        type: string
                        description: 所屬帳本ID
                        example: "user_Uae47d9d496e4596d70ed724a7d6e2948"
                      ownerId:
                        type: string
                        description: 擁有者ID
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      status:
                        type: string
                        description: 帳戶狀態
                        example: "active"
                      currency:
                        type: string
                        description: 幣別
                        example: "NTD"
                      balance:
                        type: object
                        description: 餘額資訊
                        properties:
                          current:
                            type: number
                            example: 15678.90
                          available:
                            type: number
                            example: 15678.90
                          pending:
                            type: number
                            example: 0.00
                          lastUpdated:
                            type: string
                            format: date-time
                            example: "2025-08-22T12:00:00Z"
                      bankInfo:
                        type: object
                        description: 銀行資訊（bank類型）
                        properties:
                          bankCode:
                            type: string
                            example: "812"
                          bankName:
                            type: string
                            example: "台新銀行"
                          branchCode:
                            type: string
                            example: "0001"
                          accountNumber:
                            type: string
                            example: "****1234"
                      creditInfo:
                        type: object
                        description: 信用卡資訊（credit_card類型）
                        properties:
                          creditLimit:
                            type: number
                            example: 100000.00
                          availableCredit:
                            type: number
                            example: 84321.10
                          usedCredit:
                            type: number
                            example: 15678.90
                          lastFour:
                            type: string
                            example: "1234"
                          issuer:
                            type: string
                            example: "台新銀行"
                      settings:
                        type: object
                        description: 帳戶設定
                        properties:
                          isDefault:
                            type: boolean
                            example: false
                          includeInNetWorth:
                            type: boolean
                            example: true
                          autoSync:
                            type: boolean
                            example: false
                          notifications:
                            type: boolean
                            example: true
                      statistics:
                        type: object
                        description: 帳戶統計
                        properties:
                          transactionCount:
                            type: integer
                            example: 156
                          totalInflow:
                            type: number
                            example: 50000.00
                          totalOutflow:
                            type: number
                            example: 34321.10
                          averageBalance:
                            type: number
                            example: 18000.00
                          lastTransaction:
                            type: string
                            format: date-time
                            example: "2025-08-22T10:30:00Z"
                          monthlyAverage:
                            type: object
                            properties:
                              inflow:
                                type: number
                                example: 8333.33
                              outflow:
                                type: number
                                example: 5720.18
                      recentTransactions:
                        type: array
                        description: 最近交易（需要includeTransactions=true）
                        items:
                          type: object
                          properties:
                            transactionId:
                              type: string
                              example: "txn_123"
                            amount:
                              type: number
                              example: -500.00
                            description:
                              type: string
                              example: "便利商店購物"
                            date:
                              type: string
                              format: date-time
                              example: "2025-08-22T10:30:00Z"
                      permissions:
                        type: object
                        description: 用戶權限
                        properties:
                          canRead:
                            type: boolean
                            example: true
                          canWrite:
                            type: boolean
                            example: true
                          canDelete:
                            type: boolean
                            example: true
                          canModifySettings:
                            type: boolean
                            example: true
                      createdAt:
                        type: string
                        format: date-time
                        description: 創建時間
                        example: "2025-08-22T12:00:00Z"
                      updatedAt:
                        type: string
                        format: date-time
                        description: 最後更新時間
                        example: "2025-08-22T12:00:00Z"
                  metadata:
                    type: object
                    properties:
                      userMode:
                        type: string
                        example: "Expert"
                      includeTransactions:
                        type: boolean
                        example: true
                      includeStatistics:
                        type: boolean
                        example: true

    put:
      tags:
        - Account Management
      summary: 更新帳戶資訊
      description: 更新帳戶的基本資訊和設定
      operationId: updateAccount
      parameters:
        - name: accountId
          in: path
          required: true
          description: 帳戶ID
          schema:
            type: string
            example: "account_12345"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: 帳戶名稱
                  example: "更新後的帳戶名稱"
                description:
                  type: string
                  description: 帳戶描述
                  example: "更新後的帳戶描述"
                status:
                  type: string
                  enum: [active, inactive, closed]
                  description: 帳戶狀態
                  example: "active"
                bankInfo:
                  type: object
                  description: 銀行資訊更新
                  properties:
                    branchCode:
                      type: string
                      example: "0002"
                    accountNumber:
                      type: string
                      example: "new_account_number"
                creditInfo:
                  type: object
                  description: 信用卡資訊更新
                  properties:
                    creditLimit:
                      type: number
                      example: 150000.00
                settings:
                  type: object
                  description: 帳戶設定
                  properties:
                    isDefault:
                      type: boolean
                      example: true
                    includeInNetWorth:
                      type: boolean
                      example: true
                    autoSync:
                      type: boolean
                      example: true
                    notifications:
                      type: boolean
                      example: false
                userId:
                  type: string
                  description: 操作用戶ID
                  example: "Uae47d9d496e4596d70ed724a7d6e2948"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        example: "account_12345"
                      updatedFields:
                        type: array
                        items:
                          type: string
                        example: ["name", "description", "settings"]
                      updatedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

    delete:
      tags:
        - Account Management
      summary: 刪除帳戶
      description: 刪除指定的帳戶（需要權限驗證）
      operationId: deleteAccount
      parameters:
        - name: accountId
          in: path
          required: true
          description: 帳戶ID
          schema:
            type: string
            example: "account_12345"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - confirmationToken
                - userId
              properties:
                confirmationToken:
                  type: string
                  description: 確認刪除的令牌
                  example: "confirm_delete_account_12345"
                userId:
                  type: string
                  description: 操作用戶ID
                  example: "Uae47d9d496e4596d70ed724a7d6e2948"
                transferTransactions:
                  type: string
                  description: 交易轉移到的帳戶ID（可選）
                  example: "target_account_id"
                deleteTransactions:
                  type: boolean
                  description: 是否同時刪除相關交易
                  default: false
                  example: false
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        example: "account_12345"
                      transferredTransactions:
                        type: integer
                        description: 轉移的交易數量
                        example: 25
                      deletedTransactions:
                        type: integer
                        description: 刪除的交易數量
                        example: 0
                      deletedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /accounts/{accountId}/balance:
    get:
      tags:
        - Balance Management
      summary: 取得帳戶餘額
      description: 取得指定帳戶的即時餘額資訊
      operationId: getAccountBalance
      parameters:
        - name: accountId
          in: path
          required: true
          description: 帳戶ID
          schema:
            type: string
            example: "account_12345"
        - name: userId
          in: query
          required: true
          description: 請求用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
        - name: includeHistory
          in: query
          description: 是否包含餘額歷史
          schema:
            type: boolean
            default: false
            example: true
        - name: period
          in: query
          description: 歷史期間（天數）
          schema:
            type: integer
            minimum: 1
            maximum: 365
            default: 30
            example: 30
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        example: "account_12345"
                      balance:
                        type: object
                        properties:
                          current:
                            type: number
                            example: 15678.90
                          available:
                            type: number
                            example: 15678.90
                          pending:
                            type: number
                            example: 0.00
                          reserved:
                            type: number
                            example: 0.00
                      currency:
                        type: string
                        example: "NTD"
                      lastUpdated:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"
                      history:
                        type: array
                        description: 餘額歷史（需要includeHistory=true）
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date
                              example: "2025-08-22"
                            balance:
                              type: number
                              example: 15678.90
                            change:
                              type: number
                              example: -1000.00
                  metadata:
                    type: object
                    properties:
                      includeHistory:
                        type: boolean
                        example: true
                      period:
                        type: integer
                        example: 30

    patch:
      tags:
        - Balance Management
      summary: 調整帳戶餘額
      description: 手動調整帳戶餘額（需要高權限）
      operationId: adjustAccountBalance
      parameters:
        - name: accountId
          in: path
          required: true
          description: 帳戶ID
          schema:
            type: string
            example: "account_12345"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - adjustmentType
                - amount
                - reason
                - userId
              properties:
                adjustmentType:
                  type: string
                  enum: [set_balance, add_amount, subtract_amount]
                  description: 調整類型
                  example: "set_balance"
                amount:
                  type: number
                  description: 調整金額
                  example: 20000.00
                reason:
                  type: string
                  description: 調整原因
                  example: "初始餘額設定"
                userId:
                  type: string
                  description: 操作用戶ID
                  example: "Uae47d9d496e4596d70ed724a7d6e2948"
                reference:
                  type: string
                  description: 參考編號
                  example: "ADJ_20250822_001"
                createTransaction:
                  type: boolean
                  description: 是否創建對應交易記錄
                  default: true
                  example: true
      responses:
        '200':
          description: 調整成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountId:
                        type: string
                        example: "account_12345"
                      previousBalance:
                        type: number
                        example: 15678.90
                      newBalance:
                        type: number
                        example: 20000.00
                      adjustmentAmount:
                        type: number
                        example: 4321.10
                      transactionId:
                        type: string
                        description: 對應交易ID（如果有創建）
                        example: "txn_adjustment_123"
                      adjustedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /account-types:
    get:
      tags:
        - Account Types
      summary: 取得帳戶類型列表
      description: 取得系統支援的帳戶類型和子類型
      operationId: getAccountTypes
      parameters:
        - name: userMode
          in: query
          description: 用戶模式（影響回應內容細節）
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
            default: Expert
            example: "Expert"
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accountTypes:
                        type: array
                        items:
                          type: object
                          properties:
                            type:
                              type: string
                              example: "bank"
                            displayName:
                              type: string
                              example: "銀行帳戶"
                            description:
                              type: string
                              example: "銀行存款帳戶"
                            subtypes:
                              type: array
                              items:
                                type: object
                                properties:
                                  subtype:
                                    type: string
                                    example: "checking"
                                  displayName:
                                    type: string
                                    example: "支票帳戶"
                                  description:
                                    type: string
                                    example: "一般往來帳戶"
                            requiredFields:
                              type: array
                              items:
                                type: string
                              example: ["bankCode", "accountNumber"]
                            optionalFields:
                              type: array
                              items:
                                type: string
                              example: ["branchCode"]
                            balanceType:
                              type: string
                              enum: [asset, liability]
                              example: "asset"
                  metadata:
                    type: object
                    properties:
                      userMode:
                        type: string
                        example: "Expert"

components:
  schemas:
    Account:
      type: object
      properties:
        accountId:
          type: string
          description: 帳戶ID
          example: "account_12345"
        name:
          type: string
          description: 帳戶名稱
          example: "台新銀行支票帳戶"
        type:
          type: string
          enum: [cash, bank, credit_card, investment, loan, other]
          description: 帳戶類型
          example: "bank"
        ledgerId:
          type: string
          description: 所屬帳本ID
          example: "user_Uae47d9d496e4596d70ed724a7d6e2948"

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "ERROR_CODE"
            message:
              type: string
              example: "錯誤訊息"
            details:
              type: string
              example: "詳細錯誤說明"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []
