openapi: 3.0.3
info:
  title: 記帳交易服務 API 規格
  description: LCAS 2.0 記帳交易服務 API，符合0020和0088設計規範
  version: 1.1.0
  contact:
    name: LCAS SA Team
    email: sa@lcas.app

servers:
  - url: https://api.lcas.app/v1
    description: Production server
  - url: https://api-dev.lcas.app/v1
    description: Development server

paths:
  /transactions:
    get:
      summary: 取得交易列表
      description: 查詢交易記錄列表，支援分頁和篩選（對應畫面 S-209）
      operationId: getTransactions
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: 頁碼（從1開始）
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: 每頁筆數
          example: 20
        - name: sort
          in: query
          schema:
            type: string
            default: "date:desc"
          description: 排序格式 {field}:{asc|desc}
          example: "date:desc"
        - name: filter
          in: query
          schema:
            type: string
          description: 過濾條件 {field}:{value}
          example: "type:expense"
        - name: ledgerId
          in: query
          schema:
            type: string
            format: uuid
          description: 帳本ID篩選
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: 開始日期
          example: "2025-01-01"
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: 結束日期
          example: "2025-01-31"
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Transaction'
                      pagination:
                        $ref: '#/components/schemas/PaginationResponse'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: 新增交易記錄
      description: 建立新的交易記錄（對應畫面 S-203）
      operationId: createTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    ledgerId:
                      type: string
                      format: uuid
                      description: 帳本ID
                      example: "550e8400-e29b-41d4-a716-446655440000"
                    accountId:
                      type: string
                      format: uuid
                      description: 帳戶ID
                      example: "550e8400-e29b-41d4-a716-446655440001"
                    categoryId:
                      type: string
                      format: uuid
                      description: 科目ID
                      example: "550e8400-e29b-41d4-a716-446655440002"
                    amount:
                      type: number
                      minimum: 0.01
                      description: 金額
                      example: 500.00
                    type:
                      type: string
                      enum: [income, expense]
                      description: 收支類型
                      example: "expense"
                    description:
                      type: string
                      maxLength: 255
                      description: 描述
                      example: "晚餐聚會"
                    date:
                      type: string
                      format: date
                      description: 交易日期
                      example: "2025-01-27"
                    time:
                      type: string
                      format: time
                      description: 交易時間
                      example: "19:30"
                    paymentMethod:
                      type: string
                      description: 支付方式
                      example: "信用卡"
                    notes:
                      type: string
                      maxLength: 500
                      description: 備註
                      example: "與朋友聚餐"
                    tags:
                      type: array
                      items:
                        type: string
                      description: 標籤
                      example: ["聚餐", "朋友"]
                  required:
                    - ledgerId
                    - accountId
                    - categoryId
                    - amount
                    - type
                    - description
                    - date
      responses:
        '201':
          description: 交易建立成功（四模式差異化回應）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/TransactionResponseExpert'
                      - $ref: '#/components/schemas/TransactionResponseGuiding'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          description: 請求錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transactions/{id}:
    get:
      summary: 取得交易詳情
      description: 取得特定交易記錄詳情（對應畫面 S-210）
      operationId: getTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 交易ID
          example: "550e8400-e29b-41d4-a716-446655440003"
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Transaction'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '404':
          description: 交易不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: 更新交易記錄
      description: 完整更新交易記錄
      operationId: updateTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 交易ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/TransactionUpdateData'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Transaction'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

    delete:
      summary: 刪除交易記錄
      description: 刪除指定的交易記錄
      operationId: deleteTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 交易ID
      responses:
        '204':
          description: 刪除成功
        '404':
          description: 交易不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transactions/quick:
    post:
      summary: LINE OA 快速記帳
      description: LINE OA 快速記帳功能（對應畫面 S-201）
      operationId: quickTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    input:
                      type: string
                      description: 自然語言輸入
                      example: "午餐 150"
                    userId:
                      type: string
                      format: uuid
                      description: 使用者ID
                      example: "550e8400-e29b-41d4-a716-446655440000"
                    ledgerId:
                      type: string
                      format: uuid
                      description: 帳本ID（可選，使用預設帳本）
                      example: "550e8400-e29b-41d4-a716-446655440001"
                  required:
                    - input
                    - userId
      responses:
        '200':
          description: 快速記帳成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      transactionId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440003"
                      parsed:
                        type: object
                        properties:
                          amount:
                            type: number
                            example: 150
                          type:
                            type: string
                            example: "expense"
                          category:
                            type: string
                            example: "食物"
                          description:
                            type: string
                            example: "午餐"
                      confirmation:
                        type: string
                        example: "✅ 已記錄支出 NT$150 - 午餐（食物）"
                      balance:
                        type: object
                        properties:
                          today:
                            type: number
                            example: -450
                          month:
                            type: number
                            example: -12500

  /transactions/dashboard:
    get:
      summary: 記帳主頁數據
      description: 取得記帳主頁所需的統計數據（對應畫面 S-202）
      operationId: getTransactionDashboard
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: ledgerId
          in: query
          schema:
            type: string
            format: uuid
          description: 帳本ID
        - name: dateRange
          in: query
          schema:
            type: string
            enum: [7d, 30d, 90d, 1y]
            default: "30d"
          description: 日期範圍
      responses:
        '200':
          description: 主頁數據（四模式差異化）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/DashboardExpert'
                      - $ref: '#/components/schemas/DashboardGuiding'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

  /transactions/recent:
    get:
      summary: 最近交易
      description: 取得最近的交易記錄
      operationId: getRecentTransactions
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: 取得筆數
      responses:
        '200':
          description: 最近交易列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Transaction'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

  /transactions/statistics:
    get:
      summary: 統計數據
      description: 取得交易統計資料（對應畫面 S-211）
      operationId: getTransactionStatistics
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly, yearly]
            default: "monthly"
          description: 統計週期
        - name: ledgerId
          in: query
          schema:
            type: string
            format: uuid
          description: 帳本ID
      responses:
        '200':
          description: 統計數據
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      summary:
                        type: object
                        properties:
                          totalIncome:
                            type: number
                            example: 50000
                          totalExpense:
                            type: number
                            example: 35000
                          balance:
                            type: number
                            example: 15000
                          transactionCount:
                            type: integer
                            example: 156
                      categories:
                        type: array
                        items:
                          type: object
                          properties:
                            categoryId:
                              type: string
                              format: uuid
                            name:
                              type: string
                            amount:
                              type: number
                            percentage:
                              type: number

  /transactions/charts:
    get:
      summary: 圖表數據
      description: 取得圖表展示用的數據
      operationId: getTransactionCharts
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: chartType
          in: query
          schema:
            type: string
            enum: [pie, bar, line, trend]
          description: 圖表類型
        - name: period
          in: query
          schema:
            type: string
            enum: [weekly, monthly, yearly]
            default: "monthly"
          description: 統計週期
      responses:
        '200':
          description: 圖表數據
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      chartData:
                        type: array
                        items:
                          type: object
                          properties:
                            label:
                              type: string
                            value:
                              type: number
                            color:
                              type: string

  /transactions/batch:
    post:
      summary: 批次新增交易
      description: 批次建立多筆交易記錄
      operationId: createBatchTransactions
      tags:
        - Transactions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    transactions:
                      type: array
                      items:
                        $ref: '#/components/schemas/TransactionCreateData'
                      maxItems: 100
                  required:
                    - transactions
      responses:
        '201':
          description: 批次建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      created:
                        type: array
                        items:
                          type: string
                          format: uuid
                      failed:
                        type: array
                        items:
                          type: object
                          properties:
                            index:
                              type: integer
                            error:
                              type: string
                      totalCreated:
                        type: integer
                        example: 15
                      totalFailed:
                        type: integer
                        example: 0

  /transactions/recurring:
    get:
      summary: 查詢重複記帳
      description: 取得重複記帳規則列表
      operationId: getRecurringTransactions
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/RecurringTransaction'
                      pagination:
                        $ref: '#/components/schemas/PaginationResponse'

    post:
      summary: 建立重複記帳
      description: 建立重複記帳規則
      operationId: createRecurringTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/RecurringTransactionCreateData'
      responses:
        '201':
          description: 建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/RecurringTransaction'

  /transactions/recurring/{recurringId}:
    put:
      summary: 更新重複記帳
      description: 更新重複記帳規則
      operationId: updateRecurringTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: recurringId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/RecurringTransactionUpdateData'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/RecurringTransaction'

    delete:
      summary: 刪除重複記帳
      description: 刪除重複記帳規則
      operationId: deleteRecurringTransaction
      tags:
        - Transactions
      security:
        - bearerAuth: []
      parameters:
        - name: recurringId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 刪除成功

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Transaction:
      type: object
      properties:
        transactionId:
          type: string
          format: uuid
          description: 交易唯一識別符
          example: "550e8400-e29b-41d4-a716-446655440003"
        ledgerId:
          type: string
          format: uuid
          description: 帳本ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        accountId:
          type: string
          format: uuid
          description: 帳戶ID
          example: "550e8400-e29b-41d4-a716-446655440001"
        categoryId:
          type: string
          format: uuid
          description: 科目ID
          example: "550e8400-e29b-41d4-a716-446655440002"
        amount:
          type: number
          description: 金額
          example: 500.00
        type:
          type: string
          enum: [income, expense]
          description: 收支類型
          example: "expense"
        description:
          type: string
          description: 描述
          example: "晚餐聚會"
        date:
          type: string
          format: date
          description: 交易日期
          example: "2025-01-27"
        time:
          type: string
          format: time
          description: 交易時間
          example: "19:30"
        paymentMethod:
          type: string
          description: 支付方式
          example: "信用卡"
        notes:
          type: string
          description: 備註
          example: "與朋友聚餐"
        tags:
          type: array
          items:
            type: string
          description: 標籤
          example: ["聚餐", "朋友"]
        createdAt:
          type: string
          format: date-time
          description: 建立時間
          example: "2025-01-27T12:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 更新時間
          example: "2025-01-27T12:00:00Z"

    TransactionCreateData:
      type: object
      properties:
        ledgerId:
          type: string
          format: uuid
        accountId:
          type: string
          format: uuid
        categoryId:
          type: string
          format: uuid
        amount:
          type: number
          minimum: 0.01
        type:
          type: string
          enum: [income, expense]
        description:
          type: string
          maxLength: 255
        date:
          type: string
          format: date
        time:
          type: string
          format: time
        paymentMethod:
          type: string
        notes:
          type: string
          maxLength: 500
        tags:
          type: array
          items:
            type: string
      required:
        - ledgerId
        - accountId
        - categoryId
        - amount
        - type
        - description
        - date

    TransactionUpdateData:
      type: object
      properties:
        accountId:
          type: string
          format: uuid
        categoryId:
          type: string
          format: uuid
        amount:
          type: number
          minimum: 0.01
        type:
          type: string
          enum: [income, expense]
        description:
          type: string
          maxLength: 255
        date:
          type: string
          format: date
        time:
          type: string
          format: time
        paymentMethod:
          type: string
        notes:
          type: string
          maxLength: 500
        tags:
          type: array
          items:
            type: string

    TransactionResponseExpert:
      allOf:
        - $ref: '#/components/schemas/Transaction'
        - type: object
          properties:
            大項代碼:
              type: string
              example: "100"
            子項代碼:
              type: string
              example: "10001"
            analytics:
              type: object
              properties:
                monthlySpending:
                  type: number
                categoryPercentage:
                  type: number

    TransactionResponseGuiding:
      type: object
      properties:
        transactionId:
          type: string
          format: uuid
        amount:
          type: number
        description:
          type: string
        message:
          type: string
          example: "記帳成功"

    DashboardExpert:
      type: object
      properties:
        summary:
          type: object
          properties:
            todayIncome:
              type: number
              example: 0
            todayExpense:
              type: number
              example: 450
            monthIncome:
              type: number
              example: 50000
            monthExpense:
              type: number
              example: 35000
            balance:
              type: number
              example: 15000
        recentTransactions:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/Transaction'
            pagination:
              $ref: '#/components/schemas/PaginationResponse'
        charts:
          type: object
          properties:
            weeklyTrend:
              type: array
              items:
                type: object
            categoryDistribution:
              type: array
              items:
                type: object
        budgetStatus:
          type: array
          items:
            type: object
        quickActions:
          type: array
          items:
            type: object
            properties:
              action:
                type: string
              label:
                type: string

    DashboardGuiding:
      type: object
      properties:
        todayExpense:
          type: number
          example: 450
        quickAddButton:
          type: boolean
          example: true
        simpleMessage:
          type: string
          example: "今天已花費 NT$450"

    PaginationResponse:
      type: object
      properties:
        page:
          type: integer
          description: 當前頁碼
          example: 1
        limit:
          type: integer
          description: 每頁筆數
          example: 20
        total:
          type: integer
          description: 總筆數
          example: 156
        totalPages:
          type: integer
          description: 總頁數
          example: 8
        hasNext:
          type: boolean
          description: 是否有下一頁
          example: true
        hasPrev:
          type: boolean
          description: 是否有上一頁
          example: false
        nextPage:
          type: integer
          nullable: true
          description: 下一頁頁碼
          example: 2
        prevPage:
          type: integer
          nullable: true
          description: 上一頁頁碼
          example: null

    ResponseMetadata:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: 回應時間戳
          example: "2025-01-27T12:00:00Z"
        requestId:
          type: string
          format: uuid
          description: 請求唯一識別符
          example: "550e8400-e29b-41d4-a716-446655440001"
        userMode:
          type: string
          enum: [Expert, Inertial, Cultivation, Guiding]
          description: 使用者模式
          example: "Expert"

    RecurringTransaction:
      type: object
      properties:
        recurringId:
          type: string
          format: uuid
          description: 重複記帳規則ID
        name:
          type: string
          description: 規則名稱
        frequency:
          type: string
          enum: [daily, weekly, monthly, yearly]
          description: 重複頻率
        amount:
          type: number
          description: 金額
        type:
          type: string
          enum: [income, expense]
          description: 收支類型
        categoryId:
          type: string
          format: uuid
          description: 科目ID
        accountId:
          type: string
          format: uuid
          description: 帳戶ID
        description:
          type: string
          description: 描述
        isActive:
          type: boolean
          description: 是否啟用
        nextExecuteDate:
          type: string
          format: date
          description: 下次執行日期
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    RecurringTransactionCreateData:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        frequency:
          type: string
          enum: [daily, weekly, monthly, yearly]
        amount:
          type: number
          minimum: 0.01
        type:
          type: string
          enum: [income, expense]
        categoryId:
          type: string
          format: uuid
        accountId:
          type: string
          format: uuid
        description:
          type: string
          maxLength: 255
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
      required:
        - name
        - frequency
        - amount
        - type
        - categoryId
        - accountId
        - startDate

    RecurringTransactionUpdateData:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        frequency:
          type: string
          enum: [daily, weekly, monthly, yearly]
        amount:
          type: number
          minimum: 0.01
        description:
          type: string
          maxLength: 255
        isActive:
          type: boolean
        endDate:
          type: string
          format: date

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: 錯誤訊息
              example: "金額必須大於 0"
            field:
              type: string
              description: 錯誤欄位
              example: "amount"
            timestamp:
              type: string
              format: date-time
              example: "2025-01-27T12:00:00Z"
            requestId:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440001"
            details:
              type: object
              description: 詳細錯誤資訊

tags:
  - name: Transactions
    description: 記帳交易相關 API