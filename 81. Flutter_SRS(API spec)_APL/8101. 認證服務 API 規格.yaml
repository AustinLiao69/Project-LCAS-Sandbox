
openapi: 3.0.3
info:
  title: 認證服務 API 規格
  description: LCAS 2.0 認證服務 API，符合0020和0088設計規範
  version: 1.1.0
  contact:
    name: LCAS SA Team
    email: sa@lcas.app

servers:
  - url: https://api.lcas.app/v1
    description: Production server
  - url: https://api-dev.lcas.app/v1
    description: Development server

paths:
  /auth/register:
    post:
      summary: 使用者註冊
      description: 新使用者註冊功能（對應畫面 S-103）
      operationId: registerUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    email:
                      type: string
                      format: email
                      description: 使用者電子郵件
                      example: "user@example.com"
                    password:
                      type: string
                      minLength: 8
                      description: 密碼（最少8位）
                      example: "securePassword123"
                    confirmPassword:
                      type: string
                      description: 確認密碼
                      example: "securePassword123"
                    acceptTerms:
                      type: boolean
                      description: 同意條款
                      example: true
                  required:
                    - email
                    - password
                    - confirmPassword
                    - acceptTerms
                metadata:
                  type: object
                  properties:
                    source:
                      type: string
                      description: 請求來源
                      example: "app"
                    version:
                      type: string
                      description: 版本號
                      example: "1.0.0"
      responses:
        '201':
          description: 註冊成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        format: uuid
                        description: 使用者唯一識別符
                        example: "550e8400-e29b-41d4-a716-446655440000"
                      email:
                        type: string
                        format: email
                        example: "user@example.com"
                      verificationSent:
                        type: boolean
                        example: true
                      needsAssessment:
                        type: boolean
                        example: true
                  metadata:
                    type: object
                    properties:
                      timestamp:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
                      requestId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440001"
        '400':
          description: 請求錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 電子郵件已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: 使用者登入
      description: 使用者登入功能（對應畫面 S-104）
      operationId: loginUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    email:
                      type: string
                      format: email
                      description: 使用者電子郵件
                      example: "user@example.com"
                    password:
                      type: string
                      description: 密碼
                      example: "securePassword123"
                    rememberMe:
                      type: boolean
                      description: 記住我
                      example: true
                  required:
                    - email
                    - password
                metadata:
                  type: object
                  properties:
                    source:
                      type: string
                      example: "app"
                    userAgent:
                      type: string
                      example: "LCAS-App/1.0.0"
      responses:
        '200':
          description: 登入成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                        description: JWT access token
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      refreshToken:
                        type: string
                        description: JWT refresh token
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      expiresAt:
                        type: string
                        format: date-time
                        example: "2025-01-28T00:00:00Z"
                      user:
                        type: object
                        properties:
                          userId:
                            type: string
                            format: uuid
                            example: "550e8400-e29b-41d4-a716-446655440000"
                          email:
                            type: string
                            format: email
                            example: "user@example.com"
                          userMode:
                            type: string
                            enum: [Expert, Inertial, Cultivation, Guiding]
                            example: "Expert"
                          hasCompletedAssessment:
                            type: boolean
                            example: true
                  metadata:
                    type: object
                    properties:
                      timestamp:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"
                      requestId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440001"
                      userMode:
                        type: string
                        example: "Expert"
        '401':
          description: 登入失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: 帳戶被鎖定
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/google-login:
    post:
      summary: Google 登入
      description: 使用 Google 帳戶登入
      operationId: googleLogin
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    googleToken:
                      type: string
                      description: Google ID token
                      example: "eyJhbGciOiJSUzI1NiIsImtpZCI6..."
                  required:
                    - googleToken
      responses:
        '200':
          description: Google 登入成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      refreshToken:
                        type: string
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      user:
                        type: object
                        properties:
                          userId:
                            type: string
                            format: uuid
                            example: "550e8400-e29b-41d4-a716-446655440000"
                          email:
                            type: string
                            format: email
                            example: "user@gmail.com"
                          userMode:
                            type: string
                            enum: [Expert, Inertial, Cultivation, Guiding]
                            example: "Expert"
                          isNewUser:
                            type: boolean
                            example: false

  /auth/logout:
    post:
      summary: 使用者登出
      description: 登出並撤銷 token
      operationId: logoutUser
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 登出成功
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      summary: 刷新 Token
      description: 使用 refresh token 獲取新的 access token
      operationId: refreshToken
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    refreshToken:
                      type: string
                      description: Refresh token
                      example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  required:
                    - refreshToken
      responses:
        '200':
          description: Token 刷新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                      expiresAt:
                        type: string
                        format: date-time
                        example: "2025-01-28T00:00:00Z"

  /auth/forgot-password:
    post:
      summary: 忘記密碼
      description: 發送密碼重設連結到電子郵件（對應畫面 S-105）
      operationId: forgotPassword
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    email:
                      type: string
                      format: email
                      description: 註冊電子郵件
                      example: "user@example.com"
                  required:
                    - email
      responses:
        '200':
          description: 密碼重設連結已發送
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "密碼重設連結已發送至您的電子郵件"
                      emailSent:
                        type: boolean
                        example: true

  /auth/verify-reset-token:
    get:
      summary: 驗證重設 Token
      description: 驗證密碼重設連結的有效性
      operationId: verifyResetToken
      tags:
        - Authentication
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: 重設密碼 token
          example: "abc123def456"
      responses:
        '200':
          description: Token 有效
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      valid:
                        type: boolean
                        example: true
                      expiresAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T15:00:00Z"

  /auth/reset-password:
    post:
      summary: 重設密碼
      description: 使用重設 token 更新密碼
      operationId: resetPassword
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    token:
                      type: string
                      description: 重設密碼 token
                      example: "abc123def456"
                    newPassword:
                      type: string
                      minLength: 8
                      description: 新密碼
                      example: "newSecurePassword123"
                    confirmPassword:
                      type: string
                      description: 確認新密碼
                      example: "newSecurePassword123"
                  required:
                    - token
                    - newPassword
                    - confirmPassword
      responses:
        '200':
          description: 密碼重設成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "密碼已成功重設"

  /auth/bind-line:
    post:
      summary: LINE 帳號綁定
      description: 綁定 LINE 帳號與 APP 帳號（對應畫面 S-107）
      operationId: bindLineAccount
      tags:
        - Authentication
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    lineUserId:
                      type: string
                      description: LINE 使用者 ID
                      example: "Uae47d9d496e4596d70ed724a7d6e2948"
                    verificationCode:
                      type: string
                      description: 驗證碼
                      example: "123456"
                  required:
                    - lineUserId
                    - verificationCode
      responses:
        '200':
          description: 綁定成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      bindingId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440002"
                      lineUserId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      status:
                        type: string
                        example: "active"

  /auth/bind-status:
    get:
      summary: 綁定狀態查詢
      description: 查詢 LINE 帳號綁定狀態
      operationId: getBindStatus
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 綁定狀態
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      isBound:
                        type: boolean
                        example: true
                      lineUserId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      boundAt:
                        type: string
                        format: date-time
                        example: "2025-01-20T10:00:00Z"

  /auth/verify-email:
    post:
      summary: 電子郵件驗證
      description: 驗證使用者電子郵件地址
      operationId: verifyEmail
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    token:
                      type: string
                      description: 驗證 token
                      example: "abc123def456"
                    email:
                      type: string
                      format: email
                      description: 電子郵件
                      example: "user@example.com"
                  required:
                    - token
                    - email
      responses:
        '200':
          description: 驗證成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      verified:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: "電子郵件驗證成功"
                      verifiedAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"

  /auth/user-mode:
    get:
      summary: 取得用戶模式
      description: 取得當前用戶的使用模式
      operationId: getUserMode
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 成功取得用戶模式
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userMode:
                        type: string
                        enum: [Expert, Inertial, Cultivation, Guiding]
                        example: "Expert"
                      hasCompletedAssessment:
                        type: boolean
                        example: true
                      lastUpdated:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: 錯誤訊息
              example: "Email format invalid"
            field:
              type: string
              description: 錯誤欄位
              example: "email"
            timestamp:
              type: string
              format: date-time
              example: "2025-01-27T12:00:00Z"
            requestId:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440001"
            details:
              type: object
              description: 詳細錯誤資訊
              properties:
                validation:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                        example: "email"
                      message:
                        type: string
                        example: "Email format invalid"
                      value:
                        type: string
                        example: "invalid-email"

tags:
  - name: Authentication
    description: 認證相關 API
