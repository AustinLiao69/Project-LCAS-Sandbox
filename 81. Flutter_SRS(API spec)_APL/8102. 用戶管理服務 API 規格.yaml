openapi: 3.0.3
info:
  title: 用戶管理服務 API 規格
  description: LCAS 用戶管理服務API規格，提供用戶帳號管理、權限控制和跨平台帳號關聯功能
  version: 2.0.0
  contact:
    name: LCAS SA Team
    email: sa@lcas.com

servers:
  - url: https://api.lcas.com/v2
    description: Production server
  - url: https://staging-api.lcas.com/v2
    description: Staging server

tags:
  - name: Account Management
    description: 帳號管理相關操作
  - name: User Profile
    description: 用戶資料管理
  - name: Cross Platform
    description: 跨平台帳號關聯

paths:
  /users:
    post:
      tags:
        - Account Management
      summary: 創建新用戶帳號
      description: 創建新的用戶帳號，支援LINE、iOS、Android等平台
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - platform
                - userProfile
              properties:
                platform:
                  type: string
                  enum: [LINE, iOS, Android]
                  description: 用戶平台
                  example: "LINE"
                userProfile:
                  type: object
                  properties:
                    displayName:
                      type: string
                      description: 顯示名稱
                      example: "張三"
                    platformUID:
                      type: string
                      description: 平台專屬用戶ID
                      example: "Uae47d9d496e4596d70ed724a7d6e2948"
                    email:
                      type: string
                      format: email
                      description: 電子郵件
                      example: "user@example.com"
                    pictureUrl:
                      type: string
                      format: uri
                      description: 頭像URL
                      example: "https://profile.line-scdn.net/..."
                userType:
                  type: string
                  enum: [S, M, J]
                  description: 用戶類型 (S=個人, M=管理者, J=聯名)
                  example: "S"
                userMode:
                  type: string
                  enum: [Expert, Inertial, Cultivation, Guiding]
                  description: 用戶使用模式
                  example: "Expert"
                deviceInfo:
                  type: object
                  description: 設備資訊（APP平台需要）
                  properties:
                    deviceId:
                      type: string
                      description: 設備ID
                    platform:
                      type: string
                      description: 設備平台
                    version:
                      type: string
                      description: APP版本
      responses:
        '201':
          description: 用戶創建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        format: uuid
                        description: 用戶ID
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      accountId:
                        type: string
                        description: 帳號ID
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      userType:
                        type: string
                        description: 用戶類型
                        example: "S"
                      userMode:
                        type: string
                        description: 用戶模式
                        example: "Expert"
                      createdAt:
                        type: string
                        format: date-time
                        description: 創建時間
                        example: "2025-08-22T12:00:00Z"
                      subjectInitialized:
                        type: boolean
                        description: 科目是否已初始化
                        example: true
                      subjectCount:
                        type: integer
                        description: 初始化科目數量
                        example: 156
                  metadata:
                    type: object
                    properties:
                      responseTime:
                        type: string
                        example: "2025-08-22T12:00:00Z"
                      version:
                        type: string
                        example: "2.0.0"
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "INVALID_REQUEST"
                      message:
                        type: string
                        example: "缺少必要參數"
                      details:
                        type: string
                        example: "platform 欄位為必填"
        '409':
          description: 帳號已存在
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "ACCOUNT_EXISTS"
                      message:
                        type: string
                        example: "帳號已存在"
                      details:
                        type: string
                        example: "該平台用戶已註冊"

    get:
      tags:
        - Account Management
      summary: 搜尋用戶帳號
      description: 支援多條件搜尋用戶帳號
      operationId: searchUsers
      parameters:
        - name: userType
          in: query
          description: 用戶類型篩選
          schema:
            type: string
            enum: [S, M, J]
            example: "S"
        - name: userMode
          in: query
          description: 用戶模式篩選
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
            example: "Expert"
        - name: status
          in: query
          description: 帳號狀態篩選
          schema:
            type: string
            enum: [active, inactive, suspended]
            default: active
            example: "active"
        - name: keyword
          in: query
          description: 關鍵字搜尋（顯示名稱、郵件）
          schema:
            type: string
            example: "張三"
        - name: page
          in: query
          description: 頁碼
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: sort
          in: query
          description: 排序方式
          schema:
            type: string
            enum: [createdAt_desc, createdAt_asc, displayName_asc, displayName_desc]
            default: createdAt_desc
            example: "createdAt_desc"
      responses:
        '200':
          description: 搜尋成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      users:
                        type: array
                        items:
                          type: object
                          properties:
                            userId:
                              type: string
                              description: 用戶ID
                              example: "Uae47d9d496e4596d70ed724a7d6e2948"
                            displayName:
                              type: string
                              description: 顯示名稱
                              example: "張三"
                            userType:
                              type: string
                              description: 用戶類型
                              example: "S"
                            userMode:
                              type: string
                              description: 用戶模式
                              example: "Expert"
                            status:
                              type: string
                              description: 帳號狀態
                              example: "active"
                            createdAt:
                              type: string
                              format: date-time
                              description: 創建時間
                              example: "2025-08-22T12:00:00Z"
                            lastActive:
                              type: string
                              format: date-time
                              description: 最後活動時間
                              example: "2025-08-22T12:00:00Z"
                  metadata:
                    type: object
                    properties:
                      pagination:
                        type: object
                        properties:
                          currentPage:
                            type: integer
                            example: 1
                          totalPages:
                            type: integer
                            example: 5
                          totalCount:
                            type: integer
                            example: 100
                          hasNext:
                            type: boolean
                            example: true
                          hasPrevious:
                            type: boolean
                            example: false
                      filters:
                        type: object
                        properties:
                          userType:
                            type: string
                            example: "S"
                          status:
                            type: string
                            example: "active"

  /users/{id}:
    get:
      tags:
        - User Profile
      summary: 取得用戶資訊
      description: 取得指定用戶的詳細資訊
      operationId: getUserInfo
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
        - name: includeLinkedAccounts
          in: query
          description: 是否包含關聯帳號資訊
          schema:
            type: boolean
            default: false
            example: true
        - name: userMode
          in: query
          description: 請求的用戶模式（影響回應內容細節）
          schema:
            type: string
            enum: [Expert, Inertial, Cultivation, Guiding]
            example: "Expert"
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        description: 用戶ID
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      displayName:
                        type: string
                        description: 顯示名稱
                        example: "張三"
                      userType:
                        type: string
                        description: 用戶類型
                        example: "S"
                      userMode:
                        type: string
                        description: 當前用戶模式
                        example: "Expert"
                      supportedModes:
                        type: array
                        items:
                          type: string
                        description: 支援的使用模式
                        example: ["Expert", "Inertial", "Cultivation", "Guiding"]
                      createdAt:
                        type: string
                        format: date-time
                        description: 創建時間
                        example: "2025-08-22T12:00:00Z"
                      lastActive:
                        type: string
                        format: date-time
                        description: 最後活動時間
                        example: "2025-08-22T12:00:00Z"
                      timezone:
                        type: string
                        description: 時區設定
                        example: "Asia/Taipei"
                      settings:
                        type: object
                        description: 用戶設定
                        properties:
                          notifications:
                            type: boolean
                            example: true
                          language:
                            type: string
                            example: "zh-TW"
                          theme:
                            type: string
                            example: "light"
                      linkedAccounts:
                        type: object
                        description: 關聯帳號（需要權限）
                        properties:
                          lineUID:
                            type: string
                            example: "Uae47d9d496e4596d70ed724a7d6e2948"
                          iosUID:
                            type: string
                            example: "iOS_1234567890"
                          androidUID:
                            type: string
                            example: "Android_9876543210"
                  metadata:
                    type: object
                    properties:
                      requestMode:
                        type: string
                        example: "Expert"
                      includeLinkedAccounts:
                        type: boolean
                        example: true
        '404':
          description: 用戶不存在
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "USER_NOT_FOUND"
                      message:
                        type: string
                        example: "用戶不存在"

    put:
      tags:
        - User Profile
      summary: 更新用戶資訊
      description: 更新用戶的基本資訊和設定
      operationId: updateUserInfo
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayName:
                  type: string
                  description: 顯示名稱
                  example: "張三"
                userMode:
                  type: string
                  enum: [Expert, Inertial, Cultivation, Guiding]
                  description: 用戶模式
                  example: "Expert"
                timezone:
                  type: string
                  description: 時區設定
                  example: "Asia/Taipei"
                settings:
                  type: object
                  description: 用戶設定
                  properties:
                    notifications:
                      type: boolean
                      example: true
                    language:
                      type: string
                      example: "zh-TW"
                    theme:
                      type: string
                      example: "light"
                subscription:
                  type: object
                  description: 訂閱資訊
                  properties:
                    type:
                      type: string
                      enum: [free, premium, trial]
                      example: "premium"
                    features:
                      type: array
                      items:
                        type: string
                      example: ["unlimited_reminders", "auto_push_notifications"]
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      updatedFields:
                        type: array
                        items:
                          type: string
                        example: ["displayName", "userMode", "settings"]
                      syncStatus:
                        type: object
                        properties:
                          completed:
                            type: boolean
                            example: true
                  metadata:
                    type: object
                    properties:
                      updatedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

    delete:
      tags:
        - Account Management
      summary: 停用用戶帳號
      description: 停用用戶帳號並處理相關資料清理
      operationId: deactivateUser
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - confirmationToken
                - reason
              properties:
                confirmationToken:
                  type: string
                  description: 確認令牌
                  example: "confirm_deactivate_Uae47d9d496e4596d70ed724a7d6e2948"
                reason:
                  type: string
                  description: 停用原因
                  example: "用戶申請刪除帳號"
                transferData:
                  type: object
                  description: 資料轉移設定
                  properties:
                    transferToUserId:
                      type: string
                      example: "target_user_id"
                    backupData:
                      type: boolean
                      example: true
      responses:
        '200':
          description: 停用成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      backupId:
                        type: string
                        description: 備份ID
                        example: "backup_Uae47d9d496e4596d70ed724a7d6e2948_1692700800000"
                      transferredLedgers:
                        type: array
                        items:
                          type: string
                        description: 已轉移的帳本列表
                        example: ["ledger_1", "ledger_2"]
                      deactivatedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /users/{id}/type:
    patch:
      tags:
        - Account Management
      summary: 變更用戶類型
      description: 變更用戶類型 (M/S/J) 和相關權限
      operationId: changeUserType
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newUserType
                - reason
              properties:
                newUserType:
                  type: string
                  enum: [S, M, J]
                  description: 新的用戶類型
                  example: "M"
                reason:
                  type: string
                  description: 變更原因
                  example: "升級為管理者"
                operatorId:
                  type: string
                  description: 操作者ID
                  example: "admin_user_id"
      responses:
        '200':
          description: 變更成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      oldType:
                        type: string
                        example: "S"
                      newType:
                        type: string
                        example: "M"
                      affectedLedgers:
                        type: array
                        items:
                          type: string
                        description: 受影響的帳本列表
                        example: ["ledger_1", "ledger_2"]
                      changedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /users/{id}/mode:
    patch:
      tags:
        - User Profile
      summary: 切換用戶模式
      description: 切換用戶的使用模式 (Expert/Inertial/Cultivation/Guiding)
      operationId: switchUserMode
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - targetMode
              properties:
                targetMode:
                  type: string
                  enum: [Expert, Inertial, Cultivation, Guiding]
                  description: 目標模式
                  example: "Expert"
                preferences:
                  type: object
                  description: 模式偏好設定
                  properties:
                    showAdvancedFeatures:
                      type: boolean
                      example: true
                    enableAutoSuggestions:
                      type: boolean
                      example: false
                    simplifiedUI:
                      type: boolean
                      example: false
      responses:
        '200':
          description: 切換成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      previousMode:
                        type: string
                        example: "Inertial"
                      currentMode:
                        type: string
                        example: "Expert"
                      modeFeatures:
                        type: object
                        description: 當前模式可用功能
                        properties:
                          advancedReports:
                            type: boolean
                            example: true
                          bulkOperations:
                            type: boolean
                            example: true
                          customWorkflows:
                            type: boolean
                            example: true
                      switchedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /users/link-accounts:
    post:
      tags:
        - Cross Platform
      summary: 關聯跨平台帳號
      description: 將LINE、iOS、Android帳號進行關聯綁定
      operationId: linkCrossPlatformAccounts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - primaryUserId
                - linkedAccountInfo
              properties:
                primaryUserId:
                  type: string
                  description: 主要帳號的用戶ID
                  example: "Uae47d9d496e4596d70ed724a7d6e2948"
                linkedAccountInfo:
                  type: object
                  description: 要關聯的帳號資訊
                  properties:
                    lineUID:
                      type: string
                      description: LINE用戶ID
                      example: "Uae47d9d496e4596d70ed724a7d6e2948"
                    iosUID:
                      type: string
                      description: iOS用戶ID
                      example: "iOS_1234567890"
                    androidUID:
                      type: string
                      description: Android用戶ID
                      example: "Android_9876543210"
                verificationData:
                  type: object
                  description: 驗證資料
                  properties:
                    verificationMethod:
                      type: string
                      enum: [email, phone, oauth]
                      example: "oauth"
                    verificationToken:
                      type: string
                      example: "verification_token_12345"
      responses:
        '200':
          description: 關聯成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      mappingId:
                        type: string
                        description: 映射ID
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      linkedAccounts:
                        type: object
                        description: 已關聯的帳號
                        properties:
                          lineUID:
                            type: string
                            example: "Uae47d9d496e4596d70ed724a7d6e2948"
                          iosUID:
                            type: string
                            example: "iOS_1234567890"
                          androidUID:
                            type: string
                            example: "Android_9876543210"
                      linkedAt:
                        type: string
                        format: date-time
                        example: "2025-08-22T12:00:00Z"

  /users/{id}/validate:
    get:
      tags:
        - Account Management
      summary: 驗證帳號存在性
      description: 快速驗證帳號是否存在且有效
      operationId: validateAccountExists
      parameters:
        - name: id
          in: path
          required: true
          description: 用戶ID或平台識別符
          schema:
            type: string
            example: "Uae47d9d496e4596d70ed724a7d6e2948"
        - name: platform
          in: query
          description: 指定平台
          schema:
            type: string
            enum: [LINE, iOS, Android]
            default: LINE
            example: "LINE"
      responses:
        '200':
          description: 驗證結果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      exists:
                        type: boolean
                        description: 帳號是否存在
                        example: true
                      userId:
                        type: string
                        description: 用戶ID（如果存在）
                        example: "Uae47d9d496e4596d70ed724a7d6e2948"
                      accountStatus:
                        type: string
                        enum: [active, inactive, suspended, not_found]
                        description: 帳號狀態
                        example: "active"
                      platform:
                        type: string
                        description: 驗證的平台
                        example: "LINE"

  /auth/line/oauth:
    post:
      tags:
        - Cross Platform
      summary: 處理LINE OAuth授權
      description: 處理LINE Login OAuth流程和Token管理
      operationId: handleLineOAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - authCode
                - state
                - redirectUri
              properties:
                authCode:
                  type: string
                  description: 授權碼
                  example: "auth_code_12345"
                state:
                  type: string
                  description: 狀態參數
                  example: "random_state_value"
                redirectUri:
                  type: string
                  format: uri
                  description: 重導向URI
                  example: "https://app.lcas.com/auth/callback"
      responses:
        '200':
          description: 授權成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                        description: 存取權杖
                        example: "access_token_12345"
                      refreshToken:
                        type: string
                        description: 重新整理權杖
                        example: "refresh_token_67890"
                      expiresIn:
                        type: integer
                        description: 權杖有效期（秒）
                        example: 3600
                      userProfile:
                        type: object
                        description: 用戶資料
                        properties:
                          userId:
                            type: string
                            example: "Uae47d9d496e4596d70ed724a7d6e2948"
                          displayName:
                            type: string
                            example: "張三"
                          pictureUrl:
                            type: string
                            example: "https://profile.line-scdn.net/..."

components:
  schemas:
    User:
      type: object
      properties:
        userId:
          type: string
          description: 用戶ID
          example: "Uae47d9d496e4596d70ed724a7d6e2948"
        displayName:
          type: string
          description: 顯示名稱
          example: "張三"
        userType:
          type: string
          enum: [S, M, J]
          description: 用戶類型
          example: "S"
        userMode:
          type: string
          enum: [Expert, Inertial, Cultivation, Guiding]
          description: 用戶模式
          example: "Expert"
        status:
          type: string
          enum: [active, inactive, suspended]
          description: 帳號狀態
          example: "active"

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "ERROR_CODE"
            message:
              type: string
              example: "錯誤訊息"
            details:
              type: string
              example: "詳細錯誤說明"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []