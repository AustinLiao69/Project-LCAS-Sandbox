
openapi: 3.0.3
info:
  title: 用戶管理服務 API 規格
  description: LCAS 2.0 用戶管理服務 API，符合0020和0088設計規範
  version: 1.1.0
  contact:
    name: LCAS SA Team
    email: sa@lcas.app

servers:
  - url: https://api.lcas.app/v1
    description: Production server
  - url: https://api-dev.lcas.app/v1
    description: Development server

paths:
  /users:
    get:
      summary: 取得使用者列表
      description: 查詢使用者列表，支援分頁和篩選（管理員功能）
      operationId: getUsers
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: 頁碼（從1開始）
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: 每頁筆數
          example: 20
        - name: sort
          in: query
          schema:
            type: string
            default: "createdAt:desc"
          description: 排序格式 {field}:{asc|desc}
          example: "email:asc"
        - name: filter
          in: query
          schema:
            type: string
          description: 過濾條件 {field}:{value}
          example: "status:active"
        - name: search
          in: query
          schema:
            type: string
          description: 搜尋關鍵字（姓名或Email）
          example: "john"
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      pagination:
                        $ref: '#/components/schemas/PaginationResponse'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: 權限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{userId}:
    get:
      summary: 取得使用者詳情
      description: 取得特定使用者的詳細資訊（對應畫面 S-106）
      operationId: getUser
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 使用者ID
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: 查詢成功（四模式差異化回應）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/UserResponseExpert'
                      - $ref: '#/components/schemas/UserResponseGuiding'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '404':
          description: 使用者不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: 更新使用者資料
      description: 完整更新使用者資料
      operationId: updateUser
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 使用者ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/UserUpdateData'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
        '400':
          description: 請求錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/profile:
    get:
      summary: 取得個人資料
      description: 取得當前使用者的個人資料（對應畫面 S-106）
      operationId: getUserProfile
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 個人資料（四模式差異化）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/UserProfileExpert'
                      - $ref: '#/components/schemas/UserProfileGuiding'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

    patch:
      summary: 更新個人資料
      description: 部分更新當前使用者的個人資料
      operationId: updateUserProfile
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    displayName:
                      type: string
                      maxLength: 50
                      description: 顯示名稱
                      example: "張小明"
                    avatar:
                      type: string
                      format: uri
                      description: 頭像URL
                      example: "https://example.com/avatar.jpg"
                    phone:
                      type: string
                      pattern: '^[0-9+\-\s()]+$'
                      description: 電話號碼
                      example: "0912345678"
                    dateOfBirth:
                      type: string
                      format: date
                      description: 生日
                      example: "1990-01-01"
                    gender:
                      type: string
                      enum: [male, female, other, prefer_not_to_say]
                      description: 性別
                      example: "male"
                    timezone:
                      type: string
                      description: 時區
                      example: "Asia/Taipei"
                    language:
                      type: string
                      description: 語言偏好
                      example: "zh-TW"
                    currency:
                      type: string
                      description: 預設貨幣
                      example: "TWD"
                    userMode:
                      type: string
                      enum: [Expert, Inertial, Cultivation, Guiding]
                      description: 使用者模式
                      example: "Expert"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/User'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

  /users/change-password:
    post:
      summary: 變更密碼
      description: 使用者變更密碼功能
      operationId: changePassword
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    currentPassword:
                      type: string
                      description: 目前密碼
                      example: "currentPassword123"
                    newPassword:
                      type: string
                      minLength: 8
                      description: 新密碼
                      example: "newPassword123"
                    confirmPassword:
                      type: string
                      description: 確認新密碼
                      example: "newPassword123"
                  required:
                    - currentPassword
                    - newPassword
                    - confirmPassword
      responses:
        '200':
          description: 密碼變更成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "密碼已成功變更"
                      passwordChangedAt:
                        type: string
                        format: date-time
                        example: "2025-01-27T12:00:00Z"

  /users/assessment:
    get:
      summary: 取得模式評估結果
      description: 取得使用者的四模式評估結果（對應畫面 S-101, S-102）
      operationId: getUserAssessment
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 評估結果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      assessmentId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440001"
                      recommendedMode:
                        type: string
                        enum: [Expert, Inertial, Cultivation, Guiding]
                        example: "Expert"
                      currentMode:
                        type: string
                        enum: [Expert, Inertial, Cultivation, Guiding]
                        example: "Expert"
                      scores:
                        type: object
                        properties:
                          Expert:
                            type: number
                            example: 85
                          Inertial:
                            type: number
                            example: 45
                          Cultivation:
                            type: number
                            example: 60
                          Guiding:
                            type: number
                            example: 30
                      completedAt:
                        type: string
                        format: date-time
                        example: "2025-01-20T10:00:00Z"
                      isValid:
                        type: boolean
                        example: true

    post:
      summary: 提交模式評估
      description: 提交四模式評估問卷結果
      operationId: submitAssessment
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    answers:
                      type: array
                      items:
                        type: object
                        properties:
                          questionId:
                            type: string
                            example: "Q001"
                          answer:
                            type: integer
                            minimum: 1
                            maximum: 5
                            example: 4
                      description: 問卷答案陣列
                      example: 
                        - questionId: "Q001"
                          answer: 4
                        - questionId: "Q002"
                          answer: 3
                  required:
                    - answers
      responses:
        '201':
          description: 評估提交成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      assessmentId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440001"
                      recommendedMode:
                        type: string
                        enum: [Expert, Inertial, Cultivation, Guiding]
                        example: "Expert"
                      analysis:
                        type: object
                        properties:
                          strengths:
                            type: array
                            items:
                              type: string
                            example: ["專業分析能力", "數據敏感度"]
                          recommendations:
                            type: array
                            items:
                              type: string
                            example: ["建議使用專家模式", "可考慮進階功能"]

  /users/preferences:
    get:
      summary: 取得使用者偏好設定
      description: 取得使用者的系統偏好設定
      operationId: getUserPreferences
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 偏好設定
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/UserPreferences'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

    patch:
      summary: 更新使用者偏好設定
      description: 部分更新使用者的系統偏好設定
      operationId: updateUserPreferences
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/UserPreferencesUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/UserPreferences'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

  /users/statistics:
    get:
      summary: 取得使用者統計資料
      description: 取得使用者的使用統計和成就資料
      operationId: getUserStatistics
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 統計資料（四模式差異化）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/UserStatisticsExpert'
                      - $ref: '#/components/schemas/UserStatisticsGuiding'
                  metadata:
                    $ref: '#/components/schemas/ResponseMetadata'

  /users/delete-account:
    post:
      summary: 申請刪除帳戶
      description: 使用者申請刪除帳戶（需要額外驗證）
      operationId: requestAccountDeletion
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  properties:
                    reason:
                      type: string
                      description: 刪除原因
                      example: "不再使用"
                    password:
                      type: string
                      description: 確認密碼
                      example: "userPassword123"
                    confirmDeletion:
                      type: boolean
                      description: 確認刪除
                      example: true
                  required:
                    - reason
                    - password
                    - confirmDeletion
      responses:
        '202':
          description: 刪除申請已受理
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      requestId:
                        type: string
                        format: uuid
                        example: "550e8400-e29b-41d4-a716-446655440002"
                      scheduledDeletionAt:
                        type: string
                        format: date-time
                        example: "2025-02-26T12:00:00Z"
                      cancellationDeadline:
                        type: string
                        format: date-time
                        example: "2025-02-25T12:00:00Z"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        userId:
          type: string
          format: uuid
          description: 使用者唯一識別符
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          description: 電子郵件
          example: "user@example.com"
        displayName:
          type: string
          description: 顯示名稱
          example: "張小明"
        avatar:
          type: string
          format: uri
          description: 頭像URL
          example: "https://example.com/avatar.jpg"
        phone:
          type: string
          description: 電話號碼
          example: "0912345678"
        dateOfBirth:
          type: string
          format: date
          description: 生日
          example: "1990-01-01"
        gender:
          type: string
          enum: [male, female, other, prefer_not_to_say]
          description: 性別
          example: "male"
        userMode:
          type: string
          enum: [Expert, Inertial, Cultivation, Guiding]
          description: 使用者模式
          example: "Expert"
        status:
          type: string
          enum: [active, inactive, suspended, pending_deletion]
          description: 帳戶狀態
          example: "active"
        emailVerified:
          type: boolean
          description: 電子郵件已驗證
          example: true
        hasCompletedAssessment:
          type: boolean
          description: 是否已完成模式評估
          example: true
        timezone:
          type: string
          description: 時區
          example: "Asia/Taipei"
        language:
          type: string
          description: 語言偏好
          example: "zh-TW"
        currency:
          type: string
          description: 預設貨幣
          example: "TWD"
        createdAt:
          type: string
          format: date-time
          description: 建立時間
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 更新時間
          example: "2025-01-27T12:00:00Z"
        lastLoginAt:
          type: string
          format: date-time
          description: 最後登入時間
          example: "2025-01-27T11:30:00Z"

    UserUpdateData:
      type: object
      properties:
        displayName:
          type: string
          maxLength: 50
        avatar:
          type: string
          format: uri
        phone:
          type: string
          pattern: '^[0-9+\-\s()]+$'
        dateOfBirth:
          type: string
          format: date
        gender:
          type: string
          enum: [male, female, other, prefer_not_to_say]
        timezone:
          type: string
        language:
          type: string
        currency:
          type: string
        userMode:
          type: string
          enum: [Expert, Inertial, Cultivation, Guiding]

    UserResponseExpert:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            statistics:
              type: object
              properties:
                totalTransactions:
                  type: integer
                  example: 1250
                totalLedgers:
                  type: integer
                  example: 5
                avgDailyTransactions:
                  type: number
                  example: 4.2
            achievements:
              type: array
              items:
                type: object
                properties:
                  achievementId:
                    type: string
                  name:
                    type: string
                  unlockedAt:
                    type: string
                    format: date-time
            preferences:
              $ref: '#/components/schemas/UserPreferences'

    UserResponseGuiding:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        displayName:
          type: string
        avatar:
          type: string
          format: uri
        userMode:
          type: string
          example: "Guiding"
        simpleStats:
          type: object
          properties:
            accountAge:
              type: integer
              example: 30
            basicMessage:
              type: string
              example: "您已使用 LCAS 30 天了！"

    UserProfileExpert:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            detailedStats:
              type: object
              properties:
                loginStreak:
                  type: integer
                  example: 15
                totalSessions:
                  type: integer
                  example: 245
                avgSessionDuration:
                  type: number
                  example: 12.5
            recentActivity:
              type: array
              items:
                type: object

    UserProfileGuiding:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        displayName:
          type: string
        avatar:
          type: string
          format: uri
        userMode:
          type: string
        encouragement:
          type: string
          example: "今天也要加油記帳喔！"

    UserPreferences:
      type: object
      properties:
        notifications:
          type: object
          properties:
            email:
              type: boolean
              example: true
            push:
              type: boolean
              example: true
            dailyReminder:
              type: boolean
              example: true
            weeklyReport:
              type: boolean
              example: false
        privacy:
          type: object
          properties:
            profileVisibility:
              type: string
              enum: [public, friends, private]
              example: "friends"
            shareStatistics:
              type: boolean
              example: false
        display:
          type: object
          properties:
            theme:
              type: string
              enum: [light, dark, auto]
              example: "auto"
            dateFormat:
              type: string
              example: "YYYY-MM-DD"
            timeFormat:
              type: string
              enum: ["12h", "24h"]
              example: "24h"
            numberFormat:
              type: string
              example: "1,000.00"

    UserPreferencesUpdate:
      type: object
      properties:
        notifications:
          type: object
          properties:
            email:
              type: boolean
            push:
              type: boolean
            dailyReminder:
              type: boolean
            weeklyReport:
              type: boolean
        privacy:
          type: object
          properties:
            profileVisibility:
              type: string
              enum: [public, friends, private]
            shareStatistics:
              type: boolean
        display:
          type: object
          properties:
            theme:
              type: string
              enum: [light, dark, auto]
            dateFormat:
              type: string
            timeFormat:
              type: string
              enum: ["12h", "24h"]
            numberFormat:
              type: string

    UserStatisticsExpert:
      type: object
      properties:
        overview:
          type: object
          properties:
            totalTransactions:
              type: integer
              example: 1250
            totalAmount:
              type: number
              example: 125000.50
            avgTransactionAmount:
              type: number
              example: 100.00
            categoriesUsed:
              type: integer
              example: 25
        trends:
          type: object
          properties:
            monthlyGrowth:
              type: number
              example: 5.2
            categoryDistribution:
              type: array
              items:
                type: object
        achievements:
          type: array
          items:
            type: object
            properties:
              achievementId:
                type: string
              name:
                type: string
              progress:
                type: number
        goals:
          type: array
          items:
            type: object

    UserStatisticsGuiding:
      type: object
      properties:
        simpleStats:
          type: object
          properties:
            daysUsed:
              type: integer
              example: 30
            recordsCreated:
              type: integer
              example: 45
        encouragement:
          type: string
          example: "您已經連續記帳 7 天了！"

    PaginationResponse:
      type: object
      properties:
        page:
          type: integer
          description: 當前頁碼
          example: 1
        limit:
          type: integer
          description: 每頁筆數
          example: 20
        total:
          type: integer
          description: 總筆數
          example: 156
        totalPages:
          type: integer
          description: 總頁數
          example: 8
        hasNext:
          type: boolean
          description: 是否有下一頁
          example: true
        hasPrev:
          type: boolean
          description: 是否有上一頁
          example: false
        nextPage:
          type: integer
          nullable: true
          description: 下一頁頁碼
          example: 2
        prevPage:
          type: integer
          nullable: true
          description: 上一頁頁碼
          example: null

    ResponseMetadata:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: 回應時間戳
          example: "2025-01-27T12:00:00Z"
        requestId:
          type: string
          format: uuid
          description: 請求唯一識別符
          example: "550e8400-e29b-41d4-a716-446655440001"
        userMode:
          type: string
          enum: [Expert, Inertial, Cultivation, Guiding]
          description: 使用者模式
          example: "Expert"

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: 錯誤訊息
              example: "使用者名稱已存在"
            field:
              type: string
              description: 錯誤欄位
              example: "displayName"
            timestamp:
              type: string
              format: date-time
              example: "2025-01-27T12:00:00Z"
            requestId:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440001"
            details:
              type: object
              description: 詳細錯誤資訊

tags:
  - name: Users
    description: 使用者管理相關 API
