openapi: 3.0.3
info:
  title: LCAS 2.0 - 科目管理服務 API 規格
  description: |
    **LCAS 2.0 科目管理服務 API 規格**

    負責記帳科目分類管理、階層結構設定與智慧分類功能的完整 API 規格。
    支援自訂科目建立、樹狀結構管理與四模式差異化體驗。

    **服務範圍**:
    - 科目 CRUD 管理（新增、查詢、更新、刪除科目）
    - 科目階層管理（父子關係、樹狀結構、層級控制）
    - 智慧科目建議（AI 推薦、使用頻率分析）
    - 科目統計分析（使用次數、金額統計、趨勢分析）

    **四模式差異化策略**:
    - **Expert**: 完整科目管理、自訂階層、進階統計分析
    - **Inertial**: 標準科目操作、預設分類、基本統計
    - **Cultivation**: 引導式科目設定、目標分類、使用建議
    - **Guiding**: 簡化科目選擇、智慧預設、最少選項

  version: 1.1.0
  contact:
    name: LCAS 開發團隊
    email: dev@lcas.com.tw

servers:
  - url: https://api.lcas.com.tw/v1
    description: 正式環境
  - url: https://staging-api.lcas.com.tw/v1
    description: 測試環境

security:
  - bearerAuth: []

paths:
  /categories:
    get:
      tags:
        - Category Management
      summary: 取得科目列表
      description: |
        取得科目分類列表，支援階層查詢與篩選。
        四模式差異：
        - Expert: 完整階層結構、詳細統計資訊、自訂篩選
        - Inertial: 標準分類列表、基本資訊、固定篩選
        - Cultivation: 常用分類優先、使用建議、目標相關
        - Guiding: 簡化分類、智慧推薦、最少選項
      parameters:
        - name: page
          in: query
          description: 頁碼
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
        - name: type
          in: query
          description: 科目類型篩選
          schema:
            type: string
            enum: [income, expense, both]
            default: both
        - name: parentId
          in: query
          description: 父科目ID（查詢子科目）
          schema:
            type: string
            format: uuid
        - name: level
          in: query
          description: 階層等級篩選
          schema:
            type: integer
            minimum: 1
            maximum: 5
        - name: includeInactive
          in: query
          description: 是否包含停用科目
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 成功取得科目列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryListResponse'

    post:
      tags:
        - Category Management
      summary: 建立科目
      description: 建立新的科目分類
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCategoryRequest'
      responses:
        '201':
          description: 科目建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'

  /categories/{categoryId}:
    get:
      tags:
        - Category Management
      summary: 取得科目詳情
      description: 取得指定科目的詳細資訊
      parameters:
        - name: categoryId
          in: path
          required: true
          description: 科目ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 成功取得科目詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'

    put:
      tags:
        - Category Management
      summary: 更新科目
      description: 更新科目資訊
      parameters:
        - name: categoryId
          in: path
          required: true
          description: 科目ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCategoryRequest'
      responses:
        '200':
          description: 科目更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'

    delete:
      tags:
        - Category Management
      summary: 刪除科目
      description: 刪除指定科目（需確認無使用記錄）
      parameters:
        - name: categoryId
          in: path
          required: true
          description: 科目ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 科目刪除成功
        '409':
          description: 科目仍有使用記錄，無法刪除
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /categories/tree:
    get:
      tags:
        - Category Management
      summary: 取得科目樹狀結構
      description: 取得完整的科目階層樹狀結構
      parameters:
        - name: type
          in: query
          description: 科目類型篩選
          schema:
            type: string
            enum: [income, expense, both]
            default: both
        - name: maxDepth
          in: query
          description: 最大階層深度
          schema:
            type: integer
            minimum: 1
            maximum: 5
            default: 3
      responses:
        '200':
          description: 成功取得科目樹狀結構
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryTreeResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    CategoryListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            categories:
              type: array
              items:
                $ref: '#/components/schemas/Category'
            pagination:
              $ref: '#/components/schemas/Pagination'

    Category:
      type: object
      properties:
        categoryId:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
          enum: [income, expense]
        parentId:
          type: string
          format: uuid
          nullable: true
        level:
          type: integer
          minimum: 1
        path:
          type: string
          description: 完整路徑（如：食物 > 外食 > 中式餐廳）
        icon:
          type: string
          description: 科目圖示
        color:
          type: string
          description: 科目顏色代碼
        isActive:
          type: boolean
          default: true
        isSystem:
          type: boolean
          description: 是否為系統預設科目
        statistics:
          type: object
          properties:
            usageCount:
              type: integer
              description: 使用次數
            totalAmount:
              type: number
              description: 總金額
            lastUsed:
              type: string
              format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateCategoryRequest:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          maxLength: 50
        type:
          type: string
          enum: [income, expense]
        parentId:
          type: string
          format: uuid
          nullable: true
        icon:
          type: string
        color:
          type: string
        description:
          type: string
          maxLength: 200

    UpdateCategoryRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 50
        parentId:
          type: string
          format: uuid
          nullable: true
        icon:
          type: string
        color:
          type: string
        description:
          type: string
          maxLength: 200
        isActive:
          type: boolean

    CategoryResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Category'

    CategoryTreeResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            tree:
              $ref: '#/components/schemas/CategoryNode'

    CategoryNode:
      type: object
      properties:
        categoryId:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
          enum: [income, expense]
        level:
          type: integer
        icon:
          type: string
        color:
          type: string
        children:
          type: array
          items:
            $ref: '#/components/schemas/CategoryNode'

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer
        hasNext:
          type: boolean
        hasPrev:
          type: boolean

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            timestamp:
              type: string
              format: date-time
            requestId:
              type: string
              format: uuid

tags:
  - name: Category Management
    description: 科目管理相關 API
info:
  title: 科目管理服務 API
  description: |
    科目管理服務提供會計科目的新增、查詢、修改和刪除功能。
    支援階層式科目結構，包括大項科目和子項科目。

    四模式差異化設計：
    - Expert: 完整科目管理、自訂科目、進階分類功能
    - Inertial: 基本科目選擇、常用科目快速存取
    - Cultivation: 科目學習模式、使用頻率追蹤
    - Guiding: 科目推薦、簡化分類介面
  version: 1.0.0
  contact:
    name: LCAS 開發團隊
    email: dev@lcas.com

servers:
  - url: https://api.lcas.com/v1
    description: 生產環境
  - url: https://api-staging.lcas.com/v1
    description: 測試環境

paths:
  /subjects:
    get:
      tags:
        - 科目管理
      summary: 查詢科目清單
      description: |
        取得科目清單，支援階層查詢和分頁。
        四模式差異：
        - Expert: 顯示完整科目樹狀結構、使用統計
        - Inertial: 顯示常用科目清單
        - Cultivation: 顯示學習進度、推薦科目
        - Guiding: 顯示簡化科目分類、使用指引
      parameters:
        - name: ledgerId
          in: query
          required: true
          schema:
            type: string
          description: 帳本ID
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: 頁碼
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: 每頁筆數
        - name: sort
          in: query
          schema:
            type: string
            enum: [code, name, usageCount, createdAt]
            default: code
          description: 排序欄位
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
          description: 排序方向
        - name: parentCode
          in: query
          schema:
            type: string
          description: 父科目代碼，查詢子科目時使用
        - name: level
          in: query
          schema:
            type: integer
            enum: [1, 2]
          description: 科目層級（1=大項，2=子項）
        - name: active
          in: query
          schema:
            type: boolean
            default: true
          description: 是否僅查詢啟用的科目
        - name: type
          in: query
          schema:
            type: string
            enum: [income, expense, asset, liability, equity]
          description: 科目類型篩選
        - name: search
          in: query
          schema:
            type: string
          description: 科目名稱搜尋關鍵字
        - name: includeChildren
          in: query
          schema:
            type: boolean
            default: false
          description: 是否包含子科目
      responses:
        '200':
          description: 成功取得科目清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subject'
                  metadata:
                    type: object
                    properties:
                      pagination:
                        $ref: '#/components/schemas/PaginationInfo'
                      hierarchy:
                        type: object
                        description: 科目階層統計
                        properties:
                          majorSubjects:
                            type: integer
                          subSubjects:
                            type: integer
                      usageStats:
                        type: object
                        description: 使用統計
                        properties:
                          mostUsed:
                            type: array
                            items:
                              type: object
                          recentlyUsed:
                            type: array
                            items:
                              type: object
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - 科目管理
      summary: 新增科目
      description: |
        建立新的科目。
        四模式差異：
        - Expert: 支援完整科目設定、自訂分類
        - Inertial: 基本科目建立
        - Cultivation: 學習導向科目建立
        - Guiding: 引導式科目建立、推薦設定
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubjectRequest'
      responses:
        '201':
          description: 科目建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Subject'
                  metadata:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "科目建立成功"
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 科目代碼已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /subjects/{subjectId}:
    get:
      tags:
        - 科目管理
      summary: 查詢單一科目
      description: |
        根據科目ID查詢特定科目。
        四模式差異：
        - Expert: 顯示完整科目資訊、使用統計、相關交易
        - Inertial: 顯示基本科目資訊
        - Cultivation: 顯示學習狀態、使用建議
        - Guiding: 顯示簡化資訊、使用說明
      parameters:
        - name: subjectId
          in: path
          required: true
          schema:
            type: string
          description: 科目ID
        - name: ledgerId
          in: query
          required: true
          schema:
            type: string
          description: 帳本ID
        - name: includeChildren
          in: query
          schema:
            type: boolean
            default: false
          description: 是否包含子科目
        - name: includeStats
          in: query
          schema:
            type: boolean
            default: false
          description: 是否包含使用統計
      responses:
        '200':
          description: 成功取得科目資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Subject'
                  metadata:
                    type: object
                    properties:
                      children:
                        type: array
                        items:
                          $ref: '#/components/schemas/Subject'
                        description: 子科目清單（若包含）
                      stats:
                        type: object
                        description: 使用統計（若包含）
        '404':
          description: 科目不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - 科目管理
      summary: 更新科目
      description: |
        更新科目資訊。
        四模式差異：
        - Expert: 支援完整科目設定修改
        - Inertial: 基本資訊修改
        - Cultivation: 學習狀態調整
        - Guiding: 引導式設定修改
      parameters:
        - name: subjectId
          in: path
          required: true
          schema:
            type: string
          description: 科目ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubjectRequest'
      responses:
        '200':
          description: 科目更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Subject'
                  metadata:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "科目更新成功"
                      changedFields:
                        type: array
                        items:
                          type: string
                        description: 異動欄位清單
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 科目不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - 科目管理
      summary: 刪除科目
      description: |
        刪除指定的科目。僅允許刪除無交易記錄的科目。
        四模式差異：
        - Expert: 支援強制刪除選項、數據轉移
        - Inertial: 基本刪除功能
        - Cultivation: 刪除前影響評估
        - Guiding: 引導式刪除確認
      parameters:
        - name: subjectId
          in: path
          required: true
          schema:
            type: string
          description: 科目ID
        - name: ledgerId
          in: query
          required: true
          schema:
            type: string
          description: 帳本ID
        - name: cascade
          in: query
          schema:
            type: boolean
            default: false
          description: 是否連同子科目一起刪除
      responses:
        '200':
          description: 科目刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      deletedSubjectId:
                        type: string
                        description: 已刪除的科目ID
                      cascadeDeleted:
                        type: array
                        items:
                          type: string
                        description: 連帶刪除的子科目ID
                  metadata:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "科目已成功刪除"
        '404':
          description: 科目不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 科目仍有交易記錄，無法刪除
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /subjects/tree:
    get:
      tags:
        - 科目管理
      summary: 查詢科目樹狀結構
      description: |
        取得完整的科目階層樹狀結構。
        四模式差異：
        - Expert: 完整樹狀結構、使用統計
        - Inertial: 簡化樹狀結構
        - Cultivation: 學習導向樹狀結構
        - Guiding: 基礎樹狀結構、推薦科目
      parameters:
        - name: ledgerId
          in: query
          required: true
          schema:
            type: string
          description: 帳本ID
        - name: activeOnly
          in: query
          schema:
            type: boolean
            default: true
          description: 是否僅包含啟用科目
        - name: includeStats
          in: query
          schema:
            type: boolean
            default: false
          description: 是否包含使用統計
      responses:
        '200':
          description: 成功取得科目樹狀結構
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      tree:
                        type: array
                        items:
                          $ref: '#/components/schemas/SubjectTreeNode'
                  metadata:
                    type: object
                    properties:
                      totalMajorSubjects:
                        type: integer
                        description: 大項科目總數
                      totalSubSubjects:
                        type: integer
                        description: 子項科目總數
                      lastUpdated:
                        type: string
                        format: date-time
                        description: 最後更新時間
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 未授權
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    Subject:
      type: object
      properties:
        subjectId:
          type: string
          description: 科目ID
        ledgerId:
          type: string
          description: 帳本ID
        majorCode:
          type: string
          description: 大項科目代碼
        majorName:
          type: string
          description: 大項科目名稱
        subCode:
          type: string
          description: 子項科目代碼
        subName:
          type: string
          description: 子項科目名稱
        fullCode:
          type: string
          description: 完整科目代碼（大項_子項）
        level:
          type: integer
          enum: [1, 2]
          description: 科目層級（1=大項，2=子項）
        type:
          type: string
          enum: [income, expense, asset, liability, equity]
          description: 科目類型
        isActive:
          type: boolean
          description: 是否啟用
        isDefault:
          type: boolean
          description: 是否為系統預設科目
        synonyms:
          type: string
          description: 同義詞（逗號分隔）
        usageCount:
          type: integer
          description: 使用次數
        lastUsed:
          type: string
          format: date-time
          description: 最後使用時間
        sortOrder:
          type: integer
          description: 排序順序
        description:
          type: string
          description: 科目說明
        icon:
          type: string
          description: 科目圖示
        color:
          type: string
          description: 科目顏色
        createdAt:
          type: string
          format: date-time
          description: 建立時間
        updatedAt:
          type: string
          format: date-time
          description: 更新時間

    SubjectTreeNode:
      type: object
      properties:
        subjectId:
          type: string
          description: 科目ID
        majorCode:
          type: string
          description: 大項科目代碼
        majorName:
          type: string
          description: 大項科目名稱
        type:
          type: string
          description: 科目類型
        children:
          type: array
          items:
            $ref: '#/components/schemas/Subject'
          description: 子科目清單
        stats:
          type: object
          description: 使用統計
          properties:
            totalUsage:
              type: integer
            childrenCount:
              type: integer

    CreateSubjectRequest:
      type: object
      required:
        - majorCode
        - majorName
        - subCode
        - subName
        - ledgerId
        - type
      properties:
        majorCode:
          type: string
          description: 大項科目代碼
          pattern: '^[0-9]{1,2}$'
        majorName:
          type: string
          description: 大項科目名稱
          maxLength: 50
        subCode:
          type: string
          description: 子項科目代碼
          pattern: '^[0-9]{1,3}$'
        subName:
          type: string
          description: 子項科目名稱
          maxLength: 50
        ledgerId:
          type: string
          description: 帳本ID
        type:
          type: string
          enum: [income, expense, asset, liability, equity]
          description: 科目類型
        synonyms:
          type: string
          description: 同義詞（逗號分隔）
          maxLength: 200
        description:
          type: string
          description: 科目說明
          maxLength: 500
        icon:
          type: string
          description: 科目圖示
        color:
          type: string
          description: 科目顏色
        sortOrder:
          type: integer
          description: 排序順序

    UpdateSubjectRequest:
      type: object
      properties:
        majorName:
          type: string
          description: 大項科目名稱
          maxLength: 50
        subName:
          type: string
          description: 子項科目名稱
          maxLength: 50
        isActive:
          type: boolean
          description: 是否啟用
        synonyms:
          type: string
          description: 同義詞（逗號分隔）
          maxLength: 200
        description:
          type: string
          description: 科目說明
          maxLength: 500
        icon:
          type: string
          description: 科目圖示
        color:
          type: string
          description: 科目顏色
        sortOrder:
          type: integer
          description: 排序順序

    PaginationInfo:
      type: object
      properties:
        page:
          type: integer
          description: 當前頁碼
        limit:
          type: integer
          description: 每頁筆數
        total:
          type: integer
          description: 總筆數
        totalPages:
          type: integer
          description: 總頁數
        hasNext:
          type: boolean
          description: 是否有下一頁
        hasPrev:
          type: boolean
          description: 是否有上一頁

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
            message:
              type: string
              description: 錯誤訊息
            field:
              type: string
              description: 錯誤欄位
            timestamp:
              type: string
              format: date-time
              description: 錯誤發生時間
            requestId:
              type: string
              description: 請求 ID
            details:
              type: object
              description: 詳細錯誤資訊
              properties:
                validation:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                      message:
                        type: string
                      value:
                        type: string