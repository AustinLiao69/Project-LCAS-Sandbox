
# 3010. DL_診斷與日誌模組 測試計畫

**版本**: 1.0.0  
**建立日期**: 2025-07-24  
**建立者**: LCAS SQA Team  
**最後更新**: 2025-07-24   
**對應模組**: 1310. DL.js (v3.0.6)

---

## 1. 測試概覽

### 1.1 測試範圍
本測試計畫涵蓋DL_診斷與日誌模組的完整功能驗證，包含：
- **日誌記錄功能**：5個級別的日誌記錄機制
- **系統診斷功能**：完整的系統健康檢查和錯誤分析
- **模式管理功能**：正常/緊急模式的切換和持久化
- **緩衝機制功能**：智能緩衝區和批次寫入機制

### 1.2 測試目標
- **功能完整性**：驗證12個核心函數的功能正確性
- **效能要求**：日誌寫入時間<100ms，批次處理<2秒
- **穩定性驗證**：大量日誌處理和異常情況的容錯能力
- **整合性測試**：與所有模組（WH、BK、DD等）的協作驗證

### 1.3 風險評估
**高風險項目**：
- 日誌緩衝區的資料完整性（斷電或異常時可能丟失日誌）
- Firestore批次寫入的效能瓶頸（大量日誌同時寫入）
- 模組自動檢測邏輯的準確性（錯誤的來源模組識別）
- 緊急模式切換的可靠性（環境變數持久化限制）

---

## 2. 測試環境與準備

### 2.1 測試環境需求
**基礎環境**：
- Node.js 16+ 執行環境
- Firebase Admin SDK 完整權限
- Firestore 資料庫連接
- 測試專用 Firestore 集合

**相依模組**：
- Firebase Admin SDK
- moment-timezone 庫
- uuid 產生器
- 完整的 serviceAccount 權限

### 2.2 測試資料準備
**Firestore測試集合**：
```javascript
// 測試用日誌集合結構
test_log_collection: {
  documentId: {
    時間: Timestamp,
    訊息: String,
    操作類型: String,
    UID: String,
    錯誤代碼: String,
    來源: String,
    錯誤詳情: String,
    重試次數: Number,
    程式碼位置: String,
    嚴重等級: String
  }
}
```

**環境變數設定**：
```bash
DL_MODE=NORMAL
DL_EMERGENCY_REASON=""
FIRESTORE_ENABLED=true
```

---

## 3. 功能測試範圍

### 3.1 日誌記錄層測試
**核心功能**：
- DL_initialize() - 模組初始化
- DL_log() - 統一日誌記錄
- DL_debug/info/warning/error/critical() - 五級日誌函數

**測試重點**：
- 日誌級別過濾機制
- Firestore批次寫入正確性
- 控制台日誌格式化
- 模組來源自動檢測

### 3.2 系統診斷層測試
**核心功能**：
- DL_diagnose() - 完整系統診斷
- DL_getModeStatus() - 模式狀態查詢
- DL_detectCallerModule() - 調用者識別

**測試重點**：
- 診斷報告完整性
- 效能指標準確性
- 錯誤統計正確性
- 模組識別準確性

### 3.3 模式管理層測試
**核心功能**：
- DL_enableNormalMode() - 開啟普通模式
- DL_enableEmergencyMode() - 開啟緊急模式
- DL_resetEmergencyMode() - 強制重置緊急模式

**測試重點**：
- 模式切換即時性
- 環境變數持久化
- 緊急模式過濾繞過
- 模式狀態一致性

### 3.4 緩衝機制層測試
**核心功能**：
- DL_checkAndFlushBuffer() - 緩衝區檢查
- DL_flushLogBuffer() - 強制刷新緩衝區
- DL_writeToFirestore() - 直接寫入Firestore

**測試重點**：
- 緩衝區大小控制（10條限制）
- 時間間隔觸發（30秒）
- 批次寫入性能
- 緊急直寫機制

---

## 4. 詳細測試案例

### 4.1 日誌記錄功能測試

#### TC-DL-001: 模組初始化測試
**測試目標**：驗證DL模組正確初始化  
**前置條件**：Firestore連接正常  
**測試步驟**：
1. 調用 `DL_initialize()`
2. 檢查 Firestore 連接狀態
3. 驗證初始化日誌記錄
4. 確認緩衝區重置

**預期結果**：
- 函數返回 true
- Firestore 連接成功
- 產生初始化日誌記錄
- 緩衝區為空陣列

#### TC-DL-002: 五級日誌記錄測試
**測試目標**：驗證DEBUG、INFO、WARNING、ERROR、CRITICAL五個級別  
**前置條件**：DL模組已初始化  
**測試步驟**：
1. 設定日誌級別為 DEBUG
2. 依序調用五個級別的日誌函數
3. 檢查控制台輸出格式
4. 驗證Firestore記錄正確性

**預期結果**：
- 所有級別日誌正常記錄
- 控制台格式符合規範
- Firestore資料結構正確
- 時間戳記為台灣時區

#### TC-DL-003: 日誌級別過濾測試
**測試目標**：驗證日誌級別過濾機制  
**前置條件**：DL模組已初始化  
**測試步驟**：
1. 設定控制台級別為 WARNING
2. 設定Firestore級別為 ERROR
3. 記錄各級別日誌
4. 檢查過濾結果

**預期結果**：
- 控制台僅顯示 WARNING 以上
- Firestore僅記錄 ERROR 以上
- DEBUG、INFO 被正確過濾
- 過濾邏輯準確無誤

### 4.2 緩衝機制測試

#### TC-DL-004: 緩衝區大小觸發測試
**測試目標**：驗證10條日誌觸發緩衝區刷新  
**前置條件**：DL模組已初始化，緩衝區為空  
**測試步驟**：
1. 連續記錄9條日誌
2. 檢查緩衝區狀態
3. 記錄第10條日誌
4. 驗證自動刷新觸發

**預期結果**：
- 前9條日誌存於緩衝區
- 第10條觸發自動刷新
- Firestore正確接收10條記錄
- 緩衝區清空重置

#### TC-DL-005: 時間間隔觸發測試
**測試目標**：驗證30秒間隔觸發緩衝區刷新  
**前置條件**：DL模組已初始化  
**測試步驟**：
1. 記錄5條日誌（未達10條限制）
2. 等待30秒時間間隔
3. 記錄第6條日誌
4. 檢查自動刷新觸發

**預期結果**：
- 時間間隔正確觸發刷新
- 前5條日誌正確寫入Firestore
- 緩衝區重置為新的時間戳記
- 第6條日誌進入新的緩衝週期

#### TC-DL-006: 批次寫入效能測試
**測試目標**：驗證Firestore批次寫入效能  
**前置條件**：DL模組已初始化  
**測試步驟**：
1. 準備100條測試日誌
2. 快速連續記錄觸發多次刷新
3. 測量每次批次寫入時間
4. 統計總體寫入效能

**預期結果**：
- 單次批次寫入時間 < 2秒
- 平均寫入時間 < 1秒
- 無寫入失敗或遺失
- 記憶體使用穩定

### 4.3 系統診斷測試

#### TC-DL-007: 完整系統診斷測試
**測試目標**：驗證系統診斷功能完整性  
**前置條件**：系統運行一段時間，有足夠日誌資料  
**測試步驟**：
1. 調用 `DL_diagnose()`
2. 檢查診斷報告結構
3. 驗證各項統計數據
4. 確認診斷執行時間

**預期結果**：
- 診斷報告結構完整
- 包含配置、連接、統計資訊
- 嚴重程度分布正確
- 診斷時間 < 5秒

#### TC-DL-008: 模組錯誤統計測試
**測試目標**：驗證各模組錯誤統計準確性  
**前置條件**：已有各模組的錯誤日誌  
**測試步驟**：
1. 預先記錄已知模組錯誤
2. 執行系統診斷
3. 比對錯誤統計結果
4. 驗證模組識別準確性

**預期結果**：
- 模組錯誤統計數量正確
- 模組識別準確無誤
- 常見錯誤統計正確
- 無漏計或重複計算

### 4.4 模式管理測試

#### TC-DL-009: 緊急模式切換測試
**測試目標**：驗證緊急模式正確切換和過濾繞過  
**前置條件**：DL模組處於正常模式  
**測試步驟**：
1. 調用 `DL_enableEmergencyMode("測試原因")`
2. 檢查模式狀態變更
3. 驗證環境變數持久化
4. 測試過濾機制繞過

**預期結果**：
- 模式成功切換至 EMERGENCY
- 緊急原因正確記錄
- 環境變數正確設定
- 所有日誌繞過過濾機制

#### TC-DL-010: 模式持久化測試
**測試目標**：驗證模式設定的持久化機制  
**前置條件**：DL模組已切換至緊急模式  
**測試步驟**：
1. 重新初始化DL模組
2. 檢查模式狀態恢復
3. 驗證緊急原因保持
4. 測試持久化一致性

**預期結果**：
- 模式狀態正確恢復
- 緊急原因保持一致
- 環境變數讀取正確
- 無狀態不一致問題

### 4.5 整合性測試

#### TC-DL-011: 跨模組日誌記錄測試
**測試目標**：驗證其他模組透過DL記錄日誌  
**前置條件**：DL、WH、BK、DD模組已初始化  
**測試步驟**：
1. WH模組記錄webhook日誌
2. BK模組記錄記帳處理日誌
3. DD模組記錄資料分配日誌
4. 檢查來源模組識別

**預期結果**：
- 各模組日誌正確記錄
- 來源模組識別準確
- 日誌格式統一一致
- 無跨模組衝突

#### TC-DL-012: 模組自動檢測測試
**測試目標**：驗證調用者模組自動檢測機制  
**前置條件**：多個模組同時運行  
**測試步驟**：
1. 各模組調用DL日誌函數
2. 檢查堆疊分析結果
3. 驗證模組前綴識別
4. 測試邊界情況處理

**預期結果**：
- 模組前綴正確識別（BK_, WH_, DD_）
- 函數名稱正確提取
- 檔案路徑備援機制有效
- 預設值處理正確

---

## 5. 效能與壓力測試

### 5.1 日誌寫入效能測試

#### TC-DL-P001: 高頻日誌記錄測試
**測試目標**：驗證高頻日誌記錄效能  
**測試條件**：1000條日誌/分鐘  
**效能指標**：
- 單條日誌處理時間 < 10ms
- 緩衝區響應時間 < 5ms
- 記憶體使用增長 < 100MB
- CPU使用率 < 50%

#### TC-DL-P002: 大量資料批次處理測試
**測試目標**：驗證大量日誌批次處理能力  
**測試條件**：10,000條日誌批次處理  
**效能指標**：
- 批次處理完成時間 < 30秒
- Firestore寫入成功率 > 99.9%
- 記憶體峰值 < 500MB
- 無記憶體洩漏現象

### 5.2 併發處理測試

#### TC-DL-P003: 多模組併發日誌測試
**測試目標**：驗證多模組同時記錄日誌的處理能力  
**測試條件**：5個模組同時記錄日誌  
**效能指標**：
- 日誌記錄順序正確
- 無資料競爭問題
- 緩衝區管理正確
- 模組識別準確

---

## 6. 異常處理與容錯測試

### 6.1 網路異常測試

#### TC-DL-E001: Firestore連接中斷測試
**測試目標**：驗證Firestore連接中斷時的處理機制  
**測試步驟**：
1. 正常記錄日誌建立基準
2. 模擬Firestore連接中斷
3. 繼續記錄日誌測試緩衝機制
4. 恢復連接驗證資料補償

**預期結果**：
- 連接中斷時控制台日誌正常
- 緩衝區暫存待寫入資料
- 連接恢復後自動補償
- 無資料遺失現象

#### TC-DL-E002: 批次寫入失敗測試
**測試目標**：驗證批次寫入失敗的錯誤處理  
**測試步驟**：
1. 填滿緩衝區觸發批次寫入
2. 模擬Firestore寫入權限錯誤
3. 檢查錯誤處理機制
4. 驗證緩衝區清理行為

**預期結果**：
- 寫入錯誤被正確捕獲
- 錯誤資訊記錄至控制台
- 緩衝區清空避免累積
- 系統繼續正常運行

### 6.2 資源限制測試

#### TC-DL-E003: 記憶體限制測試
**測試目標**：驗證記憶體不足時的處理機制  
**測試條件**：模擬記憶體不足環境  
**預期結果**：
- 緩衝區大小限制有效
- 記憶體使用可控制
- 緊急清理機制啟動
- 系統不會崩潰

---

## 7. 安全性測試

### 7.1 日誌敏感資料測試

#### TC-DL-S001: 敏感資料過濾測試
**測試目標**：確保日誌不記錄敏感資料  
**測試步驟**：
1. 記錄包含疑似密碼的日誌
2. 記錄包含API金鑰的日誌
3. 記錄包含用戶隱私的日誌
4. 檢查實際記錄內容

**預期結果**：
- 敏感資料不被記錄
- 或者已進行適當遮罩
- 日誌內容符合隱私規範
- 無資料洩漏風險

### 7.2 權限控制測試

#### TC-DL-S002: Firestore權限測試
**測試目標**：驗證Firestore存取權限控制  
**測試條件**：使用限制權限的服務帳號  
**預期結果**：
- 權限不足時優雅處理
- 錯誤訊息不洩漏系統資訊
- 降級至控制台日誌模式
- 系統安全性維持

---

## 8. 執行與驗收標準

### 8.1 測試執行階段

**第一階段 - 基礎功能驗證**（預計2天）：
- TC-DL-001 至 TC-DL-006：日誌記錄和緩衝機制
- 通過標準：所有測試案例 100% 通過

**第二階段 - 系統診斷與模式管理**（預計1天）：
- TC-DL-007 至 TC-DL-010：診斷功能和模式管理
- 通過標準：診斷準確性 > 95%，模式切換成功率 100%

**第三階段 - 整合與效能測試**（預計2天）：
- TC-DL-011 至 TC-DL-P003：跨模組整合和效能測試
- 通過標準：整合功能 100% 正常，效能指標達標

**第四階段 - 異常與安全測試**（預計1天）：
- TC-DL-E001 至 TC-DL-S002：異常處理和安全測試
- 通過標準：容錯機制 100% 有效，無安全漏洞

### 8.2 品質門檻

**功能完整性**：
- 核心功能測試通過率：100%
- 整合測試通過率：100%
- 邊界條件處理：100%

**效能標準**：
- 日誌寫入時間：< 100ms
- 批次處理時間：< 2秒
- 系統診斷時間：< 5秒
- 記憶體使用：< 500MB 峰值

**穩定性標準**：
- 連續運行24小時無異常
- 高負載測試無記憶體洩漏
- 異常恢復成功率：100%
- 資料完整性：100%

### 8.3 驗收條件

**必要條件**：
1. 所有功能測試案例通過
2. 效能指標全部達標
3. 安全測試無漏洞發現
4. 與其他模組整合無衝突

**品質指標**：
1. 代碼覆蓋率 > 90%
2. 文件完整性 100%
3. 日誌格式規範性 100%
4. 錯誤處理完備性 100%

---

## 9. 風險管控與應變方案

### 9.1 技術風險

**風險1：Firestore配額限制**
- 影響：批次寫入可能達到配額上限
- 應變：實作寫入頻率控制機制
- 監控：配額使用率即時監控

**風險2：環境變數持久化限制**  
- 影響：模式設定可能無法跨重啟保持
- 應變：考慮使用Firestore存儲模式狀態
- 監控：模式狀態一致性檢查

### 9.2 效能風險

**風險3：大量日誌記憶體消耗**
- 影響：長時間運行可能記憶體不足
- 應變：實作記憶體使用監控和清理
- 監控：記憶體使用趨勢分析

### 9.3 整合風險

**風險4：模組識別準確性**
- 影響：日誌來源模組可能識別錯誤
- 應變：提供手動來源指定機制
- 監控：模組識別準確率統計

---

## 10. 測試報告與追蹤

### 10.1 測試報告格式
- **執行摘要**：整體測試結果概述
- **詳細結果**：每個測試案例的執行結果
- **缺陷報告**：發現的問題和建議修復方案
- **效能分析**：效能指標達成情況
- **風險評估**：識別的風險和應對措施

### 10.2 持續監控
- **日常監控**：系統運行狀態和效能指標
- **週期性檢查**：診斷功能和日誌品質
- **異常告警**：錯誤率異常和效能下降

---

**版本歷史**：
- v1.0.0 (2025-01-24)：初版測試計畫，涵蓋DL模組v3.0.6全部功能

**核准簽署**：
- SQA負責人：待簽署
- 開發負責人：待簽署  
- 專案經理：待簽署

---

**備註**：本測試計畫針對DL_診斷與日誌模組v3.0.6版本制定，後續版本更新需相應調整測試內容。所有測試執行需詳細記錄並存檔，以供後續分析和改進。
