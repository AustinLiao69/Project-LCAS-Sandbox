# PRD_Business_Layer

**文件編號**: 1001  
**版本**: 2.0.1  
**建立日期**: 2025-08-01  
**建立者**: LCAS PM Team  
**最後更新**: 2025-08-01  

---

## 目次
1. [模組概述](#10-模組概述module-overview)
2. [功能需求](#20-功能需求functional-requirements)
3. [架構設計](#30-架構設計architecture-design)
4. [模組群詳細規格](#40-模組群詳細規格module-groups-specification)
5. [RESTful API 介面](#50-restful-api-介面restful-api-interface)
6. [資料流設計](#60-資料流設計data-flow-design)
7. [版本管理策略](#70-版本管理策略version-management-strategy)
8. [測試計畫](#80-測試計畫testing-plan)
9. [部署策略](#90-部署策略deployment-strategy)
10. [風險管控](#100-風險管控risk-management)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Business Layer（商業邏輯層）是 LCAS 2.0 系統的核心處理層，負責所有業務邏輯處理、資料操作和介面整合。作為 LCAS 2.0 三層架構中的關鍵層級，連接應用邏輯層與資料層，確保業務規則的一致性和系統的可維護性。

### 1.2 核心價值主張
- **模組化設計**: 採用高內聚、低耦合的模組化架構
- **多介面支援**: 同時支援 LINE OA 和 APP 兩種介面
- **統一資料處理**: 透過共用模組群確保資料一致性
- **可擴展架構**: 支援未來功能擴展和系統升級

### 1.3 目標使用者
- **展示層開發者**: 透過標準化 API 存取業務功能
- **應用邏輯層**: 整合多個業務模組提供複合功能
- **系統維護人員**: 進行業務邏輯維護和效能優化

---

## 2.0 功能需求（Functional Requirements）

### 2.1 LINE OA 介面功能
- **Webhook 請求處理**: 接收並解析 LINE 平台的 Webhook 請求
- **使用者指令分析**: 智慧解析記帳、查帳、統計等使用者指令
- **即時回應處理**: 快速處理並回覆 LINE 使用者
- **Rich Menu 互動**: 支援 Quick Reply 和 Rich Menu 操作

### 2.2 APP 介面功能
- **RESTful API 提供**: 實作標準化的 RESTful API 端點
- **身份驗證處理**: Firebase Token 和 JWT 驗證機制
- **標準化回應**: 統一的 JSON 格式回應
- **錯誤處理機制**: 完善的錯誤處理和日誌記錄

### 2.3 共用業務功能
- **記帳核心功能**: 記帳、查帳、分類管理
- **多帳本管理**: 個人帳本、群組帳本、協作管理
- **預算管理**: 預算設定、監控、警示
- **排程提醒**: 自動記帳、定期提醒、統計推播
- **報表分析**: 資料分析、報表生成、趨勢分析
- **備份服務**: 資料備份、還原、同步

---

## 3.0 架構設計（Architecture Design）

### 3.1 整體架構
Business Layer 採用三個模組群的分層架構：

```
LCAS 2.0 Business Logic Layer Architecture
├── LINE OA模組群 (LINE OA Module Group)
│   └── WH.js v2.1.0 - Webhook處理模組
├── APP模組群 (APP Module Group)
│   ├── BK.js v2.1.0 - 記帳核心模組
│   ├── AM.js v1.1.0 - 帳號管理模組
│   ├── MLS.js v2.1.0 - 多帳本管理模組
│   ├── BM.js v1.1.0 - 預算管理模組
│   ├── CM.js v1.1.0 - 協作管理模組
│   ├── SR.js v2.1.0 - 排程提醒模組
│   ├── MRA.js v1.1.0 - 報表分析模組
│   ├── BS.js v1.1.0 - 備份服務模組
│   └── LBK.js v1.1.0 - 快速記帳模組
└── 共用模組群 (Shared Module Group)
    ├── DD1.js v2.1.0 - 核心協調模組
    ├── DD2.js v2.1.0 - 智慧處理模組
    ├── DD3.js v1.1.0 - 資料服務模組
    ├── FS.js v1.1.0 - Firestore操作模組
    ├── DL.js v1.1.0 - 診斷日誌模組
    ├── GR.js v1.1.0 - 通用工具模組
    └── firebase-config.js v1.1.0 - Firebase配置模組
```

### 3.2 模組群關係設計

#### 3.2.1 LINE OA模組群
- **獨立處理**: 專門處理 LINE 平台的 Webhook 請求
- **即時回應**: 確保 LINE 平台的快速回應要求
- **共用依賴**: 呼叫共用模組群進行資料處理

#### 3.2.2 APP模組群
- **API 端點**: 提供 RESTful API 給應用邏輯層
- **業務邏輯**: 實作各項業務功能的核心邏輯
- **共用依賴**: 透過共用模組群進行資料操作

#### 3.2.3 共用模組群
- **資料管理**: 統一的 Firestore 資料操作
- **工具函數**: 日期處理、金額格式、分類解析等
- **系統支援**: 日誌記錄、錯誤處理、設定管理

---

## 4.0 模組群詳細規格（Module Groups Specification）

### 4.1 LINE OA模組群

#### 4.1.1 WH.js - Webhook處理模組 v2.1.0
**功能職責**：
- 接收 LINE 平台 Webhook 請求
- 驗證 LINE 簽章安全性
- 解析使用者指令和互動事件
- 呼叫共用模組群處理業務邏輯
- 格式化回應訊息給 LINE 平台

**技術堆疊**：Node.js + Express + Firebase Admin SDK

### 4.2 APP模組群

#### 4.2.1 BK.js - 記帳核心模組 v2.1.0
**功能職責**：
- 記帳資料的建立、修改、刪除
- 記帳分類管理和驗證
- 記帳查詢和篩選功能
- API 端點：`/api/ledger/*`

#### 4.2.2 AM.js - 帳號管理模組 v1.1.0
**功能職責**：
- 使用者註冊、登入、登出
- 使用者資料管理和設定
- 身份驗證和權限控制
- API 端點：`/api/auth/*`

#### 4.2.3 MLS.js - 多帳本管理模組 v2.1.0
**功能職責**：
- 個人帳本和群組帳本管理
- 帳本權限和成員管理
- 帳本間的資料轉移和同步
- API 端點：`/api/projects/*`

#### 4.2.4 BM.js - 預算管理模組 v1.1.0
**功能職責**：
- 預算設定和類別管理
- 預算執行監控和警示
- 預算報表和分析
- API 端點：`/api/budgets/*`

#### 4.2.5 CM.js - 協作管理模組 v1.1.0
**功能職責**：
- 協作邀請和成員管理
- 權限設定和存取控制
- 協作活動記錄和通知
- API 端點：`/api/collaborate/*`

#### 4.2.6 SR.js - 排程提醒模組 v2.1.0
**功能職責**：
- 定期記帳提醒設定
- 自動記帳執行
- 財務統計自動推播
- API 端點：`/api/schedules/*`

#### 4.2.7 MRA.js - 報表分析模組 v1.1.0
**功能職責**：
- 財務報表生成和分析
- 資料視覺化和圖表
- 趨勢分析和預測
- API 端點：`/api/reports/*`

#### 4.2.8 BS.js - 備份服務模組 v1.1.0
**功能職責**：
- 資料備份和還原
- 備份排程管理
- 資料匯出和匯入
- API 端點：`/api/backup/*`

#### 4.2.9 LBK.js - 快速記帳模組 v1.1.0
**功能職責**：
- 簡化記帳流程
- 常用記帳模板
- 快速記帳介面
- API 端點：`/api/quick-ledger/*`

**技術堆疊**：Node.js + Express + Firebase SDK

### 4.3 共用模組群

#### 4.3.1 DD1.js - 核心協調模組 v2.1.0
**功能職責**：
- 模組間的協調和通訊
- 業務流程的編排和控制
- 系統狀態管理

#### 4.3.2 DD2.js - 智慧處理模組 v2.1.0
**功能職責**：
- 智慧資料分析和處理
- 自動分類和標籤
- 異常檢測和處理

#### 4.3.3 DD3.js - 資料服務模組 v1.1.0
**功能職責**：
- 資料格式轉換和驗證
- 資料快取管理
- 資料同步協調

#### 4.3.4 FS.js - Firestore操作模組 v1.1.0
**功能職責**：
- Firestore 資料的 CRUD 操作
- 查詢最佳化和效能調整
- 交易處理和資料一致性

#### 4.3.5 DL.js - 診斷日誌模組 v1.1.0
**功能職責**：
- 系統日誌記錄和管理
- 錯誤追蹤和診斷
- 效能監控和分析

#### 4.3.6 GR.js - 通用工具模組 v1.1.0
**功能職責**：
- 日期時間處理工具
- 金額格式化和計算
- 字串處理和驗證

#### 4.3.7 firebase-config.js - Firebase配置模組 v1.1.0
**功能職責**：
- Firebase 服務初始化
- 連線設定和憑證管理
- 環境配置管理

**技術堆疊**：Firebase Admin SDK + 工具函數庫

---

## 5.0 RESTful API 介面（RESTful API Interface）

### 5.1 API 設計原則
- **RESTful 標準**: 遵循 REST 架構原則和 HTTP 方法
- **統一回應格式**: 標準化的成功和錯誤回應結構
- **版本控制**: 支援 API 版本管理和向下相容
- **安全認證**: Firebase Token 和 JWT 雙重認證機制
- **時間格式**: 統一使用 UTC+8 時區格式

### 5.2 標準回應格式
```json
{
  "status": "success|error",
  "code": "string",
  "message": "string",
  "data": {},
  "timestamp": "2025-07-23T16:30:00+08:00"
}
```

#### 5.2.1 錯誤代碼標準
- **2xx**: 成功狀態碼（如：200, 201）
- **4xx**: 客戶端錯誤（如：400, 401, 404）
- **5xx**: 伺服器錯誤（如：500, 503）

### 5.3 API 端點架構
```
/api/v1/
├── auth/*          - AM 模組：使用者認證
├── ledger/*        - BK 模組：記帳功能
├── projects/*      - MLS 模組：多帳本管理
├── budgets/*       - BM 模組：預算管理
├── collaborate/*   - CM 模組：協作管理
├── schedules/*     - SR 模組：排程提醒
├── reports/*       - MRA 模組：報表分析
├── backup/*        - BS 模組：備份服務
└── quick-ledger/*  - LBK 模組：快速記帳
```

### 5.4 32個API端點對接列表

#### 5.4.1 認證與帳戶管理群組 (F001-F005) - AM 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F001 | `POST /auth/register` | POST | 使用者註冊 | 2009. AM.js |
| F002 | `POST /auth/login` | POST | 使用者登入 | 2009. AM.js |
| F003 | `POST /auth/logout` | POST | 使用者登出 | 2009. AM.js |
| F004 | `DELETE /auth/account` | DELETE | 帳號刪除 | 2009. AM.js |
| F005 | `POST /auth/reset-password` | POST | 密碼重設 | 2009. AM.js |

#### 5.4.2 基礎記帳功能群組 (F006-F009) - BK 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F006 | `POST /app/ledger/entry` | POST | APP記帳功能 | 2001. BK.js |
| F007 | `GET /app/ledger/query` | GET | APP記錄查詢 | 2001. BK.js |
| F008 | `GET /app/subjects/list` | GET | 科目代碼管理 | 2031. DD1.js |
| F009 | `PUT /app/user/settings` | PUT | 使用者設定管理 | 2009. AM.js |

#### 5.4.3 多帳本管理群組 (F010-F015) - MLS 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F010 | `POST /app/projects/create` | POST | 專案帳本建立 | 2051. MLS.js |
| F011 | `PUT /app/projects/manage` | PUT | 專案帳本管理 | 2051. MLS.js |
| F012 | `DELETE /app/projects/delete` | DELETE | 專案帳本刪除 | 2051. MLS.js |
| F013 | `POST /app/categories/create` | POST | 分類帳本建立 | 2051. MLS.js |
| F014 | `PUT /app/categories/manage` | PUT | 分類帳本管理 | 2051. MLS.js |
| F015 | `GET /app/ledgers/switch` | GET | 多帳本切換 | 2051. MLS.js |

#### 5.4.4 預算管理群組 (F016-F018) - BM 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F016 | `POST /app/budgets/create` | POST | 預算設定建立 | 2012. BM.js |
| F017 | `GET /app/budgets/monitor` | GET | 预算追蹤監控 | 2012. BM.js |
| F018 | `PUT /app/budgets/alerts` | PUT | 預算警示設定 | 2012. BM.js |

#### 5.4.5 協作功能群組 (F019-F021) - CM 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F019 | `POST /app/shared/create` | POST | 共享帳本建立 | 2013. CM.js |
| F020 | `PUT /app/shared/permissions` | PUT | 多人協作權限 | 2013. CM.js |
| F021 | `WebSocket /app/sync/realtime` | WebSocket | 即時協作同步 | 2013. CM.js |

#### 5.4.6 報表功能群組 (F022-F024) - MRA 模組
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F022 | `POST /app/reports/generate` | POST | 標準報表產出 | 2041. MRA.js |
| F023 | `POST /app/reports/custom` | POST | 自定義報表設計 | 2041. MRA.js |
| F024 | `GET /app/reports/export` | GET | 報表匯出功能 | 2041. MRA.js |

#### 5.4.7 系統管理功能群組 (F025-F032) - 多模組整合
| 端點編號 | API端點 | HTTP方法 | 功能描述 | 對應模組 |
|----------|---------|----------|----------|----------|
| F025 | `POST /system/backup/schedule` | POST | 定期自動備份 | 2014. BS.js |
| F026 | `POST /app/backup/manual` | POST | 手動備份還原 | 2014. BS.js |
| F027 | `GET /app/backup/list` | GET | 備份檔案管理 | 2014. BS.js |
| F028 | `GET /system/sync/status` | GET | 資料同步檢查 | 2033. DD3.js |
| F029 | `GET /system/health/check` | GET | 系統健康監控 | 2010. DL.js |
| F030 | `GET /system/logs/errors` | GET | 錯誤日誌管理 | 2010. DL.js |
| F031 | `POST /schedule/reminder` | POST | 排程提醒設定 | 2005. SR.js |
| F032 | `POST /schedule/execute` | POST | 排程提醒執行 | 2005. SR.js |

---

## 6.0 資料流設計（Data Flow Design）

### 6.1 LINE OA 資料流
```
LINE 平台 → WH 模組 → 共用模組群 → Firestore → 回應處理 → LINE 平台
```

### 6.2 APP 資料流
```
Flutter App → 應用邏輯層 → APP模組群 → 共用模組群 → Firestore → JSON 回應 → Flutter App
```

### 6.3 模組間協作流程
1. **請求接收**: WH 模組或 APP 模組群接收請求
2. **身份驗證**: 驗證使用者身份和權限
3. **業務處理**: 呼叫相應的業務邏輯處理
4. **資料操作**: 透過共用模組群進行 Firestore 操作
5. **回應格式化**: 格式化回應資料
6. **結果回傳**: 回傳處理結果給請求方

---

## 7.0 版本管理策略（Version Management Strategy）

### 7.1 版本號規範
採用語義化版本號 (Semantic Versioning)：
- **主版本號**: 不相容的 API 修改
- **次版本號**: 向下相容的功能新增
- **修訂版本號**: 向下相容的問題修正

### 7.2 模組版本升級計畫
#### 7.2.1 LINE OA模組群
- **WH.js**: 維持 v2.1.0（版本穩定）

#### 7.2.2 APP模組群
- **BK.js**: v2.0.x → v2.1.0（RESTful API 整合）
- **AM.js**: v1.0.x → v1.1.0（API 端點新增）
- **MLS.js**: v2.0.x → v2.1.0（協作功能增強）
- **其他模組**: v1.0.x → v1.1.0（API 標準化）

#### 7.2.3 共用模組群
- **DD1.js**: v2.0.x → v2.1.0（協調機制優化）
- **DD2.js**: v2.0.x → v2.1.0（智慧處理增強）
- **其他模組**: 維持現有版本，功能穩定

### 7.3 函數版本管理
- **新增函數**: 從 v1.0.0 開始
- **修改函數**: 版本號遞增
- **棄用函數**: 標記 @deprecated，保留兩個版本週期

---

## 8.0 測試計畫（Testing Plan）

### 8.1 單元測試
- **模組測試**: 每個模組的核心函數測試
- **API 測試**: RESTful API 端點功能測試
- **工具函數測試**: 共用工具函數的邊界測試

### 8.2 整合測試
- **模組間協作**: 驗證模組間的協作流程
- **資料流測試**: 完整資料流的端到端測試
- **介面整合**: LINE OA 和 APP 介面的整合測試

### 8.3 效能測試
- **回應時間**: API 回應時間 < 200ms
- **並發處理**: 支援 500+ 並發請求
- **記憶體使用**: 系統記憶體穩定性測試

### 8.4 安全性測試
- **身份驗證**: Firebase Token 和 JWT 安全性
- **權限控制**: API 存取權限驗證
- **資料安全**: 敏感資料保護測試

---

## 9.0 部署策略（Deployment Strategy）

### 9.1 環境管理
- **開發環境**: 開發和測試使用
- **暫存環境**: 預生產驗證
- **生產環境**: 正式服務運行

### 9.2 部署流程
1. **程式碼審查**: Git Pull Request 審查
2. **自動測試**: CI/CD 自動測試執行
3. **暫存部署**: 暫存環境驗證
4. **生產部署**: 零停機部署策略
5. **監控驗證**: 部署後健康檢查

### 9.3 Replit 部署配置
- **主程式**: index.js 作為應用程式入口
- **環境變數**: Secrets 管理敏感資訊
- **監控**: 透過 DL 模組進行系統監控

---

## 10.0 風險管控（Risk Management）

### 10.1 技術風險
- **風險**: 大規模模組重構可能影響系統穩定性
- **緩解**: 採用漸進式升級，保持向下相容性

### 10.2 整合風險
- **風險**: 模組間依賴關係複雜化
- **緩解**: 建立清楚的介面規範和依賴圖

### 10.3 效能風險
- **風險**: RESTful API 可能增加系統延遲
- **緩解**: API 回應時間監控和效能最佳化

### 10.4 維護風險
- **風險**: 模組數量增加導致維護複雜度上升
- **緩解**: 建立完整的文件和自動化測試

---

**文件維護記錄**

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v2.0 | 2025-01-26 | LCAS PM Team | 建立完整的 Business Layer PRD，修正架構設計，移除不適當的第三方整合內容，採用正確的三層模組群架構 |

---

**備註**：
* 本文件遵循 LCAS 2.0 實際架構設計
* 所有模組群分工明確，職責清楚
* API 設計遵循 RESTful 標準
* 版本管理策略確保系統穩定性