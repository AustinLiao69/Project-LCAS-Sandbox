# PRD_Business_Layer

**文件編號**: 1001  
**版本**: 2.0.1  
**建立日期**: 2025-08-01  
**建立者**: LCAS PM Team  
**最後更新**: 2025-08-01  

---

## 目次
1. [模組概述](#10-模組概述module-overview)
2. [功能需求](#20-功能需求functional-requirements)
3. [架構設計](#30-架構設計architecture-design)
4. [模組群詳細規格](#40-模組群詳細規格module-groups-specification)
5. [RESTful API 介面](#50-restful-api-介面restful-api-interface)
6. [資料流設計](#60-資料流設計data-flow-design)


---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Business Layer（商業邏輯層）是 LCAS 2.0 系統的核心處理層，負責所有業務邏輯處理、資料操作和介面整合。作為 LCAS 2.0 三層架構中的關鍵層級，連接應用邏輯層與資料層，確保業務規則的一致性和系統的可維護性。

### 1.2 核心價值主張
- **模組化設計**: 採用高內聚、低耦合的模組化架構
- **多介面支援**: 同時支援 LINE OA 和 APP 兩種介面
- **統一資料處理**: 透過共用模組群確保資料一致性
- **可擴展架構**: 支援未來功能擴展和系統升級

### 1.3 目標使用者
- **展示層開發者**: 透過標準化 API 存取業務功能
- **應用邏輯層**: 整合多個業務模組提供複合功能
- **系統維護人員**: 進行業務邏輯維護和效能優化

---

## 2.0 功能需求（Functional Requirements）

### 2.1 LINE OA 介面功能
- **Webhook 請求處理**: 接收並解析 LINE 平台的 Webhook 請求
- **使用者指令分析**: 智慧解析記帳、查帳、統計等使用者指令
- **即時回應處理**: 快速處理並回覆 LINE 使用者
- **Rich Menu 互動**: 支援 Quick Reply 和 Rich Menu 操作

### 2.2 APP 介面功能
- **RESTful API 提供**: 實作標準化的 RESTful API 端點
- **身份驗證處理**: Firebase Token 和 JWT 驗證機制
- **標準化回應**: 統一的 JSON 格式回應
- **錯誤處理機制**: 完善的錯誤處理和日誌記錄

### 2.3 共用業務功能
- **記帳核心功能**: 記帳、查帳、分類管理
- **多帳本管理**: 個人帳本、群組帳本、協作管理
- **預算管理**: 預算設定、監控、警示
- **排程提醒**: 自動記帳、定期提醒、統計推播
- **報表分析**: 資料分析、報表生成、趨勢分析
- **備份服務**: 資料備份、還原、同步

---

## 3.0 架構設計（Architecture Design）

### 3.1 整體架構
Business Layer 採用三個模組群的分層架構，支援132個API端點的完整功能：

```
LCAS 2.0 Business Logic Layer Architecture (132 API Endpoints)
├── LINE OA模組群 (LINE OA Module Group) - 1個模組
│   └── WH.js v2.1.0 - Webhook處理模組 (與快速記帳API整合)
├── APP模組群 (APP Module Group) - 11個模組
│   ├── BK.js v2.1.0 - 記帳核心模組 (28個API端點)
│   ├── AM.js v1.1.0 - 帳號管理模組 (22個API端點)
│   ├── MLS.js v2.1.0 - 多帳本管理模組 (14個API端點)
│   ├── BM.js v1.1.0 - 預算管理模組 (8個API端點)
│   ├── CM.js v1.1.0 - 協作管理模組 (8個API端點)
│   ├── SR.js v2.1.0 - 排程提醒模組 (11個API端點)
│   ├── MRA.js v1.1.0 - 報表分析模組 (15個API端點)
│   ├── BS.js v1.1.0 - 備份服務模組 (6個API端點)
│   ├── LBK.js v1.1.0 - 快速記帳模組 (1個API端點)
│   ├── IM.js v1.0.0 - 激勵系統模組 (6個API端點) ⭐ 新增
│   └── NM.js v1.0.0 - 通知管理模組 (4個API端點) ⭐ 新增
└── 共用模組群 (Shared Module Group) - 7個模組
    ├── DD1.js v2.1.0 - 核心協調模組 (18個API端點)
    ├── DD2.js v2.1.0 - 智慧處理模組 (12個API端點)
    ├── DD3.js v1.1.0 - 資料服務模組 (9個API端點)
    ├── FS.js v1.1.0 - Firestore操作模組 (2個API端點)
    ├── DL.js v1.1.0 - 診斷日誌模組 (8個API端點)
    ├── GR.js v1.1.0 - 通用工具模組 (13個API端點)
    └── firebase-config.js v1.1.0 - Firebase配置模組 (1個API端點)

總計：132個API端點覆蓋13個服務分類
```

### 3.2 模組群關係設計

#### 3.2.1 LINE OA模組群
- **獨立處理**: 專門處理 LINE 平台的 Webhook 請求
- **即時回應**: 確保 LINE 平台的快速回應要求
- **共用依賴**: 呼叫共用模組群進行資料處理

#### 3.2.2 APP模組群
- **API 端點**: 提供 RESTful API 給應用邏輯層
- **業務邏輯**: 實作各項業務功能的核心邏輯
- **共用依賴**: 透過共用模組群進行資料操作

#### 3.2.3 共用模組群
- **資料管理**: 統一的 Firestore 資料操作
- **工具函數**: 日期處理、金額格式、分類解析等
- **系統支援**: 日誌記錄、錯誤處理、設定管理

---

## 4.0 模組群詳細規格（Module Groups Specification）

### 4.1 LINE OA模組群

#### 4.1.1 WH.js - Webhook處理模組 v2.1.0
**功能職責**：
- 接收 LINE 平台 Webhook 請求
- 驗證 LINE 簽章安全性
- 解析使用者指令和互動事件
- 呼叫共用模組群處理業務邏輯
- 格式化回應訊息給 LINE 平台

**技術堆疊**：Node.js + Express + Firebase Admin SDK

### 4.2 APP模組群

#### 4.2.1 BK.js - 記帳核心模組 v2.1.0
**功能職責**：
- 記帳交易的CRUD操作（建立、查詢、修改、刪除）
- 帳戶管理和餘額計算
- 科目分類管理和驗證
- 批次操作和匯入功能
- 交易附件管理
- 儀表板和統計數據
- **API 端點**：`/api/transactions/*`, `/api/accounts/*`, `/api/categories/*` (28個端點)
  - 交易服務：20個端點（包含批次操作、重複交易、附件管理）
  - 帳戶服務：8個端點（包含轉帳功能）
  - 科目服務：6個端點（包含樹狀結構）

#### 4.2.2 AM.js - 帳號管理模組 v1.1.0
**功能職責**：
- 使用者認證（註冊、登入、登出、重設密碼）
- 個人資料和偏好設定管理
- 四模式切換和評估問卷
- 安全設定和PIN碼驗證
- 使用行為追蹤和模式優化
- LINE綁定和多平台整合
- **API 端點**：`/api/auth/*`, `/api/users/*` (22個端點)
  - 認證服務：11個端點（包含Google登入、LINE綁定）
  - 用戶管理：11個端點（包含模式切換、行為分析）

#### 4.2.3 MLS.js - 多帳本管理模組 v2.1.0
**功能職責**：
- 個人帳本和群組帳本管理
- 帳本類型和權限設定
- 協作者邀請和管理
- 帳本間資料轉移和同步
- 操作審計日誌記錄
- **API 端點**：`/api/ledgers/*` (14個端點)
  - 基本管理：6個端點
  - 協作功能：6個端點（權限、衝突處理）
  - 進階功能：2個端點（審計日誌、類型管理）

#### 4.2.4 BM.js - 預算管理模組 v1.1.0
**功能職責**：
- 預算設定和類別管理
- 預算執行監控和警示
- 預算模板和狀況分析
- 與SR模組整合的預算警示
- **API 端點**：`/api/budgets/*` (8個端點)
  - 包含預算模板、執行狀況、警示設定

#### 4.2.5 CM.js - 協作管理模組 v1.1.0
**功能職責**：
- 協作邀請和成員管理
- 權限設定和存取控制
- 協作衝突檢測和解決
- 協作活動記錄和通知
- 報表分享功能
- **API 端點**：與MLS.js共用 `/api/ledgers/{id}/collaborators/*` 等 (8個端點)
  - 進階協作衝突處理和權限管理

#### 4.2.6 SR.js - 排程提醒模組 v2.1.0
**功能職責**：
- 重複交易設定和執行
- 記帳提醒規則管理
- 定期報表排程
- 財務統計自動推播
- 提醒模板管理
- **API 端點**：`/api/transactions/recurring/*`, `/api/notifications/reminders/*` (11個端點)
  - 重複交易：4個端點
  - 提醒系統：4個端點
  - 排程服務：3個端點

#### 4.2.7 MRA.js - 報表分析模組 v1.1.0
**功能職責**：
- 報表生成和狀態管理
- 多格式匯出（PDF、Excel、CSV）
- 深度分析和趨勢預測
- 自定義分析和圖表
- 報表分享和下載
- **API 端點**：`/api/reports/*`, `/api/analytics/*` (15個端點)
  - 報表服務：9個端點（生成、匯出、分享）
  - 分析服務：6個端點（洞察、趨勢、自定義）

#### 4.2.8 BS.js - 備份服務模組 v1.1.0
**功能職責**：
- 資料備份和還原管理
- 備份狀態監控
- 資料匯出和匯入
- 與報表系統整合的匯出功能
- **API 端點**：`/api/backup/*`, `/api/data/*` (6個端點)
  - 備份管理：4個端點
  - 資料處理：2個端點

#### 4.2.9 LBK.js - 快速記帳模組 v1.1.0
**功能職責**：
- 簡化記帳流程
- 常用記帳模板
- 快速記帳介面
- API 端點：`/api/transactions/quick`

#### 4.2.10 IM.js - 激勵系統模組 v1.0.0 ⭐ 新增
**功能職責**：
- 成就系統管理和進度追蹤
- 挑戰活動設計和參與機制
- 獎勵發放和領取管理
- 排行榜計算和顯示
- 個人化激勵策略
- 社群互動和競賽功能
- **API 端點**：`/api/gamification/*` (6個端點)
  - `/achievements` - 成就管理
  - `/challenges` - 挑戰系統
  - `/claim-reward` - 獎勵領取
  - `/leaderboard` - 排行榜
  - `/join-challenge` - 參與挑戰
  - `/progress` - 進度查詢

#### 4.2.11 NM.js - 通知管理模組 v1.0.0 ⭐ 新增
**功能職責**：
- 通知設定和偏好管理
- 多渠道通知發送（APP推播、EMAIL、LINE）
- 通知列表和狀態管理
- 提醒規則設定和執行
- 通知模板管理
- 通知歷史記錄和分析
- **API 端點**：`/api/notifications/*` (8個端點)
  - `/settings` - 通知設定
  - `/list` - 通知列表
  - `/{id}/read` - 標記已讀
  - `/reminders` - 記帳提醒
  - `/reminders/{id}` - 提醒管理
  - `/reminder-templates` - 提醒模板

**技術堆疊**：Node.js + Express + Firebase SDK + FCM

### 4.3 共用模組群

#### 4.3.1 DD1.js - 核心協調模組 v2.1.0
**功能職責**：
- 模組間的協調和通訊
- 業務流程的編排和控制
- 四模式差異化邏輯處理
- 預設值和配置管理
- 科目和帳戶類型定義
- **支援API端點**：18個端點
  - 用戶模式切換和預設值：4個端點
  - 科目樹狀結構：2個端點
  - 帳戶類型管理：2個端點
  - 預算模板：2個端點
  - 報表模板：2個端點
  - 提醒模板：1個端點
  - 帳本類型：1個端點
  - 其他協調功能：4個端點

#### 4.3.2 DD2.js - 智慧處理模組 v2.1.0
**功能職責**：
- AI智慧分析和處理
- 自動分類和標籤建議
- 異常檢測和風險分析
- 用戶行為分析和模式優化
- 協作衝突檢測和解決
- 深度分析和預測模型
- **支援API端點**：12個端點
  - AI助理服務：6個端點（分類、建議、預算建議、異常檢測、洞察、推薦）
  - 用戶行為分析：2個端點
  - 協作衝突處理：2個端點
  - 智慧交易處理：2個端點

#### 4.3.3 DD3.js - 資料服務模組 v1.1.0
**功能職責**：
- 資料格式轉換和驗證
- 批次操作處理和優化
- 資料快取管理
- 離線同步協調
- 報表生成狀態管理
- **支援API端點**：9個端點
  - 批次操作：3個端點
  - 備份狀態：2個端點
  - 報表狀態：2個端點
  - 系統同步：2個端點

#### 4.3.4 FS.js - Firestore操作模組 v1.1.0
**功能職責**：
- Firestore 資料的 CRUD 操作
- 查詢最佳化和效能調整
- 交易處理和資料一致性
- 安全規則驗證
- **支援API端點**：2個端點
  - 系統同步：1個端點
  - 基礎配置：1個端點

#### 4.3.5 DL.js - 診斷日誌模組 v1.1.0
**功能職責**：
- 系統日誌記錄和管理
- 錯誤追蹤和診斷
- 效能監控和分析
- 安全事件記錄
- 操作審計追蹤
- **支援API端點**：8個端點
  - 系統狀態：4個端點
  - 問題回報：1個端點
  - 客服聯繫：1個端點
  - 重試機制：1個端點
  - 安全日誌：1個端點

#### 4.3.6 GR.js - 通用工具模組 v1.1.0
**功能職責**：
- 日期時間處理工具
- 金額格式化和計算
- 字串處理和驗證
- 系統資訊和配置
- 檔案處理和工具函數
- **支援API端點**：13個端點
  - 系統服務：8個端點（APP資訊、歡迎、推廣、配置、幫助）
  - 問題回報：1個端點
  - 客服聯繫：1個端點
  - 圖表工具：1個端點
  - 附件處理：2個端點

#### 4.3.7 firebase-config.js - Firebase配置模組 v1.1.0
**功能職責**：
- Firebase 服務初始化
- 連線設定和憑證管理
- 環境配置管理
- 服務端點配置
- **支援API端點**：1個端點
  - 基礎配置：1個端點

**技術堆疊**：Firebase Admin SDK + AI/ML 工具庫 + 工具函數庫

---

## 5.0 RESTful API 介面（RESTful API Interface）

### 5.1 API 設計原則
- **RESTful 標準**: 遵循 REST 架構原則和 HTTP 方法
- **統一回應格式**: 標準化的成功和錯誤回應結構
- **版本控制**: 支援 API 版本管理和向下相容
- **安全認證**: Firebase Token 和 JWT 雙重認證機制
- **時間格式**: 統一使用 UTC+8 時區格式

### 5.2 標準回應格式
```json
{
  "status": "success|error",
  "code": "string",
  "message": "string",
  "data": {},
  "timestamp": "2025-07-23T16:30:00+08:00"
}
```

#### 5.2.1 錯誤代碼標準
- **2xx**: 成功狀態碼（如：200, 201）
- **4xx**: 客戶端錯誤（如：400, 401, 404）
- **5xx**: 伺服器錯誤（如：500, 503）

### 5.3 API 端點架構
```
/api/v1/
├── auth/*          - AM 模組：使用者認證
├── ledger/*        - BK 模組：記帳功能
├── projects/*      - MLS 模組：多帳本管理
├── budgets/*       - BM 模組：預算管理
├── collaborate/*   - CM 模組：協作管理
├── schedules/*     - SR 模組：排程提醒
├── reports/*       - MRA 模組：報表分析
├── backup/*        - BS 模組：備份服務
└── quick-ledger/*  - LBK 模組：快速記帳
```

### 5.4 完整API端點架構（基於8020和8088文件的132個端點）

#### 5.4.1 認證服務 (Authentication Services) - 11個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/auth/register` | POST | 使用者註冊 | AM.js | ✅ 全模式 |
| `/api/v1/auth/login` | POST | 使用者登入 | AM.js | ✅ 全模式 |
| `/api/v1/auth/google-login` | POST | Google登入 | AM.js | ✅ 全模式 |
| `/api/v1/auth/logout` | POST | 使用者登出 | AM.js | ✅ 全模式 |
| `/api/v1/auth/refresh` | POST | 刷新token | AM.js | ✅ 全模式 |
| `/api/v1/auth/forgot-password` | POST | 忘記密碼 | AM.js | ✅ 全模式 |
| `/api/v1/auth/verify-reset-token` | GET | 驗證重設連結 | AM.js | ✅ 全模式 |
| `/api/v1/auth/reset-password` | POST | 重設密碼 | AM.js | ✅ 全模式 |
| `/api/v1/auth/verify-email` | POST | 驗證Email | AM.js | ✅ 全模式 |
| `/api/v1/auth/bind-line` | POST | LINE綁定 | AM.js + WH.js | ✅ 全模式 |
| `/api/v1/auth/bind-status` | GET | 綁定狀態查詢 | AM.js | ✅ 全模式 |

#### 5.4.2 用戶管理服務 (User Management Services) - 11個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/users/profile` | GET | 取得個人資料 | AM.js | ✅ 全模式 |
| `/api/v1/users/profile` | PUT | 更新個人資料 | AM.js | ✅ 全模式 |
| `/api/v1/users/assessment-questions` | GET | 取得評估問卷 | AM.js + DD2.js | ✅ 全模式 |
| `/api/v1/users/assessment` | POST | 提交評估結果 | AM.js + DD2.js | ✅ 全模式 |
| `/api/v1/users/preferences` | PUT | 更新偏好設定 | AM.js | ✅ 全模式 |
| `/api/v1/users/security` | PUT | 安全設定 | AM.js + DL.js | ✅ 全模式 |
| `/api/v1/users/verify-pin` | POST | PIN碼驗證 | AM.js | ✅ 全模式 |
| `/api/v1/users/mode` | PUT | 切換使用者模式 | AM.js + DD1.js | ✅ 全模式 |
| `/api/v1/users/mode-defaults` | GET | 取得模式預設值 | AM.js + DD1.js | ✅ 全模式 |
| `/api/v1/users/behavior-tracking` | POST | 使用行為追蹤 | AM.js + DD2.js | ✅ 全模式 |
| `/api/v1/users/mode-recommendations` | GET | 模式優化建議 | AM.js + DD2.js | ✅ 全模式 |

#### 5.4.3 記帳交易服務 (Transaction Services) - 20個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/transactions` | GET | 查詢交易列表 | BK.js + DD1.js | 🔄 差異化 |
| `/api/v1/transactions` | POST | 新增交易 | BK.js + DD2.js | 🔄 差異化 |
| `/api/v1/transactions/{id}` | GET | 取得交易詳情 | BK.js | ✅ 全模式 |
| `/api/v1/transactions/{id}` | PUT | 更新交易 | BK.js + DL.js | ✅ 全模式 |
| `/api/v1/transactions/{id}` | DELETE | 刪除交易 | BK.js + DL.js | ✅ 全模式 |
| `/api/v1/transactions/batch` | POST | 批次新增交易 | BK.js + DD3.js | 🔄 進階模式 |
| `/api/v1/transactions/batch` | PUT | 批次更新交易 | BK.js + DD3.js | 🔄 進階模式 |
| `/api/v1/transactions/batch` | DELETE | 批次刪除交易 | BK.js + DD3.js | 🔄 進階模式 |
| `/api/v1/transactions/quick` | POST | 快速記帳(LINE OA) | LBK.js + WH.js | ✅ 全模式 |
| `/api/v1/transactions/dashboard` | GET | 儀表板數據 | BK.js + MRA.js | 🔄 差異化 |
| `/api/v1/transactions/recent` | GET | 最近交易 | BK.js | ✅ 全模式 |
| `/api/v1/transactions/statistics` | GET | 統計數據 | BK.js + MRA.js | 🔄 差異化 |
| `/api/v1/transactions/charts` | GET | 圖表數據 | BK.js + MRA.js | 🔄 差異化 |
| `/api/v1/transactions/recurring` | GET | 查詢重複交易 | SR.js | 🔄 進階模式 |
| `/api/v1/transactions/recurring` | POST | 建立重複交易 | SR.js | 🔄 進階模式 |
| `/api/v1/transactions/recurring/{id}` | PUT | 更新重複交易 | SR.js | 🔄 進階模式 |
| `/api/v1/transactions/recurring/{id}` | DELETE | 刪除重複交易 | SR.js | 🔄 進階模式 |
| `/api/v1/transactions/{id}/attachments` | POST | 上傳附件 | BK.js + GR.js | 🔄 進階模式 |
| `/api/v1/transactions/{id}/attachments/{attachmentId}` | DELETE | 刪除附件 | BK.js + GR.js | 🔄 進階模式 |
| `/api/v1/transactions/import` | POST | 匯入交易 | BK.js + BS.js | 🔄 進階模式 |

#### 5.4.4 帳本管理服務 (Ledger Management Services) - 14個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/ledgers` | GET | 取得帳本列表 | MLS.js | ✅ 全模式 |
| `/api/v1/ledgers` | POST | 建立帳本 | MLS.js + DD1.js | ✅ 全模式 |
| `/api/v1/ledgers/{id}` | GET | 取得帳本詳情 | MLS.js | ✅ 全模式 |
| `/api/v1/ledgers/{id}` | PUT | 更新帳本 | MLS.js + DL.js | ✅ 全模式 |
| `/api/v1/ledgers/{id}` | DELETE | 刪除帳本 | MLS.js + DL.js | ✅ 全模式 |
| `/api/v1/ledgers/types` | GET | 取得帳本類型 | MLS.js + DD1.js | ✅ 全模式 |
| `/api/v1/ledgers/{id}/collaborators` | GET | 取得協作者 | CM.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/invitations` | POST | 邀請協作者 | CM.js + SR.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/collaborators/{userId}` | PUT | 更新協作者權限 | CM.js + DL.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/collaborators/{userId}` | DELETE | 移除協作者 | CM.js + DL.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/permissions` | GET | 取得權限狀態 | CM.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/conflicts` | GET | 檢測協作衝突 | CM.js + DD2.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/resolve-conflict` | POST | 解決協作衝突 | CM.js + DD2.js | 🔄 協作模式 |
| `/api/v1/ledgers/{id}/audit-log` | GET | 取得操作審計日誌 | DL.js + MLS.js | 🔄 進階模式 |

#### 5.4.5 帳戶管理服務 (Account Management Services) - 8個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/accounts` | GET | 取得帳戶列表 | BK.js | ✅ 全模式 |
| `/api/v1/accounts` | POST | 建立帳戶 | BK.js + DD1.js | ✅ 全模式 |
| `/api/v1/accounts/{id}` | GET | 取得帳戶詳情 | BK.js | ✅ 全模式 |
| `/api/v1/accounts/{id}` | PUT | 更新帳戶 | BK.js + DL.js | ✅ 全模式 |
| `/api/v1/accounts/{id}` | DELETE | 刪除帳戶 | BK.js + DL.js | ✅ 全模式 |
| `/api/v1/accounts/{id}/balance` | GET | 取得帳戶餘額 | BK.js + MRA.js | ✅ 全模式 |
| `/api/v1/accounts/types` | GET | 取得帳戶類型 | BK.js + DD1.js | ✅ 全模式 |
| `/api/v1/accounts/transfer` | POST | 帳戶轉帳 | BK.js + DL.js | 🔄 進階模式 |

#### 5.4.6 科目管理服務 (Category Management Services) - 6個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/categories` | GET | 取得科目列表 | DD1.js + BK.js | ✅ 全模式 |
| `/api/v1/categories` | POST | 建立科目 | DD1.js + BK.js | 🔄 進階模式 |
| `/api/v1/categories/{id}` | GET | 取得科目詳情 | DD1.js + BK.js | ✅ 全模式 |
| `/api/v1/categories/{id}` | PUT | 更新科目 | DD1.js + BK.js | 🔄 進階模式 |
| `/api/v1/categories/{id}` | DELETE | 刪除科目 | DD1.js + BK.js | 🔄 進階模式 |
| `/api/v1/categories/tree` | GET | 取得科目樹狀結構 | DD1.js + DD2.js | ✅ 全模式 |

#### 5.4.7 預算管理服務 (Budget Management Services) - 8個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/budgets` | GET | 取得預算列表 | BM.js | 🔄 預算模式 |
| `/api/v1/budgets` | POST | 建立預算 | BM.js + DD1.js | 🔄 預算模式 |
| `/api/v1/budgets/{id}` | GET | 取得預算詳情 | BM.js | 🔄 預算模式 |
| `/api/v1/budgets/{id}` | PUT | 更新預算 | BM.js + DL.js | 🔄 預算模式 |
| `/api/v1/budgets/{id}` | DELETE | 刪除預算 | BM.js + DL.js | 🔄 預算模式 |
| `/api/v1/budgets/status` | GET | 取得預算執行狀況 | BM.js + MRA.js | 🔄 預算模式 |
| `/api/v1/budgets/templates` | GET | 取得預算模板 | BM.js + DD1.js | 🔄 預算模式 |
| `/api/v1/budgets/alert` | POST | 預算警示設定 | BM.js + SR.js | 🔄 預算模式 |

#### 5.4.8 報表分析服務 (Report & Analytics Services) - 15個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/reports` | GET | 取得報表列表 | MRA.js | 🔄 差異化 |
| `/api/v1/reports/generate` | POST | 生成報表 | MRA.js + DD3.js | 🔄 差異化 |
| `/api/v1/reports/{id}` | GET | 取得報表詳情 | MRA.js | 🔄 差異化 |
| `/api/v1/reports/{id}/status` | GET | 查詢報表生成進度 | MRA.js + DD3.js | 🔄 差異化 |
| `/api/v1/reports/{id}/cancel` | DELETE | 取消報表生成 | MRA.js + DD3.js | 🔄 差異化 |
| `/api/v1/reports/{id}/charts` | GET | 取得報表圖表 | MRA.js + GR.js | 🔄 差異化 |
| `/api/v1/reports/{id}/export` | GET | 匯出報表 | MRA.js + BS.js | 🔄 進階模式 |
| `/api/v1/reports/{id}/download` | POST | 下載報表 | MRA.js + BS.js | 🔄 進階模式 |
| `/api/v1/reports/{id}/share` | POST | 分享報表 | MRA.js + CM.js | 🔄 協作模式 |
| `/api/v1/reports/templates` | GET | 取得報表模板 | MRA.js + DD1.js | 🔄 差異化 |
| `/api/v1/reports/config-options` | GET | 取得報表配置選項 | MRA.js + DD1.js | 🔄 進階模式 |
| `/api/v1/analytics/insights` | GET | 深度分析洞察 | MRA.js + DD2.js | 🔄 進階模式 |
| `/api/v1/analytics/trends` | GET | 趨勢分析 | MRA.js + DD2.js | 🔄 進階模式 |
| `/api/v1/analytics/custom` | POST | 自定義分析 | MRA.js + DD2.js | 🔄 進階模式 |
| `/api/v1/analytics/scheduled` | GET | 定期報表排程 | MRA.js + SR.js | 🔄 進階模式 |

#### 5.4.9 AI助理服務 (AI Assistant Services) - 6個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/ai/categorize` | POST | AI智慧分類 | DD2.js + BK.js | ✅ 全模式 |
| `/api/v1/ai/suggestions` | GET | AI建議 | DD2.js + AM.js | ✅ 全模式 |
| `/api/v1/ai/budget-advice` | POST | AI預算建議 | DD2.js + BM.js | 🔄 預算模式 |
| `/api/v1/ai/anomaly-detection` | POST | 異常檢測 | DD2.js + DL.js | 🔄 進階模式 |
| `/api/v1/ai/spending-insights` | POST | AI支出洞察 | DD2.js + MRA.js | 🔄 進階模式 |
| `/api/v1/ai/recommendations` | GET | AI個人化推薦 | DD2.js + AM.js | ✅ 全模式 |

#### 5.4.10 激勵系統服務 (Gamification Services) - 6個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/gamification/achievements` | GET | 取得成就 | IM.js (新增) | ✅ 全模式 |
| `/api/v1/gamification/challenges` | GET | 取得挑戰 | IM.js (新增) | ✅ 全模式 |
| `/api/v1/gamification/claim-reward` | POST | 領取獎勵 | IM.js (新增) | ✅ 全模式 |
| `/api/v1/gamification/leaderboard` | GET | 排行榜 | IM.js (新增) | 🔄 協作模式 |
| `/api/v1/gamification/join-challenge` | POST | 加入挑戰 | IM.js (新增) | ✅ 全模式 |
| `/api/v1/gamification/progress` | GET | 挑戰進度查詢 | IM.js (新增) | ✅ 全模式 |

#### 5.4.11 系統服務 (System Services) - 13個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/system/app-info` | GET | APP資訊 | GR.js | ✅ 全模式 |
| `/api/v1/system/welcome` | GET | 歡迎資訊 | GR.js + AM.js | ✅ 全模式 |
| `/api/v1/system/status` | GET | 系統狀態 | DL.js | ✅ 全模式 |
| `/api/v1/system/health` | GET | 健康檢查 | DL.js + GR.js | ✅ 全模式 |
| `/api/v1/system/app-promotion` | GET | APP推廣資訊 | GR.js | ✅ 全模式 |
| `/api/v1/system/config` | GET | 系統配置 | GR.js + AM.js | 🔄 進階模式 |
| `/api/v1/system/config` | PUT | 更新系統配置 | GR.js + DL.js | 🔄 進階模式 |
| `/api/v1/system/maintenance` | GET | 維護狀態 | DL.js | ✅ 全模式 |
| `/api/v1/feedback/report` | POST | 問題回報 | DL.js + GR.js | ✅ 全模式 |
| `/api/v1/help/articles` | GET | 幫助文章 | GR.js | ✅ 全模式 |
| `/api/v1/help/contact` | POST | 聯繫客服 | GR.js + DL.js | ✅ 全模式 |
| `/api/v1/system/retry` | POST | 重試機制 | DD3.js + DL.js | 🔄 進階模式 |
| `/api/v1/system/sync` | POST | 離線同步 | DD3.js + FS.js | 🔄 進階模式 |

#### 5.4.12 備份與資料管理服務 (Backup & Data Management Services) - 6個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/backup/create` | POST | 建立備份 | BS.js + DD3.js | 🔄 進階模式 |
| `/api/v1/backup/list` | GET | 備份列表 | BS.js | 🔄 進階模式 |
| `/api/v1/backup/restore` | POST | 還原備份 | BS.js + DL.js | 🔄 進階模式 |
| `/api/v1/backup/status` | GET | 備份狀態 | BS.js + DD3.js | 🔄 進階模式 |
| `/api/v1/data/export` | POST | 匯出資料 | BS.js + MRA.js | 🔄 進階模式 |
| `/api/v1/data/import` | POST | 匯入資料 | BS.js + BK.js | 🔄 進階模式 |

#### 5.4.13 通知管理服務 (Notification Management Services) - 8個端點
| API端點 | HTTP方法 | 功能描述 | 對應模組 | 四模式支援 |
|---------|----------|----------|----------|-----------|
| `/api/v1/notifications/settings` | GET | 取得通知設定 | NM.js (新增) | ✅ 全模式 |
| `/api/v1/notifications/settings` | PUT | 更新通知設定 | NM.js (新增) | ✅ 全模式 |
| `/api/v1/notifications/list` | GET | 通知列表 | NM.js (新增) | ✅ 全模式 |
| `/api/v1/notifications/{id}/read` | PUT | 標記已讀 | NM.js (新增) | ✅ 全模式 |
| `/api/v1/notifications/reminders` | POST | 建立記帳提醒 | SR.js + NM.js | ✅ 全模式 |
| `/api/v1/notifications/reminders/{id}` | PUT | 更新提醒規則 | SR.js + NM.js | ✅ 全模式 |
| `/api/v1/notifications/reminders/{id}` | DELETE | 刪除提醒 | SR.js + NM.js | ✅ 全模式 |
| `/api/v1/notifications/reminder-templates` | GET | 取得提醒模板 | SR.js + DD1.js | ✅ 全模式 |

### 5.5 四模式差異化API設計

#### 5.5.1 模式標識符 (Mode Identifiers)
- **✅ 全模式**: 所有模式均可使用
- **🔄 差異化**: 不同模式返回不同內容或功能
- **🔄 協作模式**: 僅協作模式可用
- **🔄 預算模式**: 僅預算模式可用 
- **🔄 進階模式**: 僅進階模式可用

#### 5.5.2 模式差異化回應範例
```json
// 簡化模式 - 交易列表
{
  "status": "success",
  "data": {
    "transactions": [
      {
        "id": "trans_001",
        "amount": 100,
        "description": "午餐",
        "date": "2025-08-01T12:00:00+08:00"
      }
    ],
    "mode": "simple"
  }
}

// 進階模式 - 交易列表 (包含更多欄位和分析)
{
  "status": "success", 
  "data": {
    "transactions": [
      {
        "id": "trans_001",
        "amount": 100,
        "description": "午餐",
        "category": "餐飲",
        "account": "現金",
        "tags": ["工作餐"],
        "location": "台北市",
        "attachment_count": 1,
        "date": "2025-08-01T12:00:00+08:00",
        "created_at": "2025-08-01T12:00:00+08:00",
        "updated_at": "2025-08-01T12:00:00+08:00"
      }
    ],
    "statistics": {
      "total_amount": 100,
      "category_breakdown": {...}
    },
    "mode": "advanced"
  }
}
```

### 5.6 API端點-模組對應統計

#### 5.6.1 完整對應關係矩陣
```
總計：132個API端點
├── 完全對應：115個端點 (87.1%)
├── 需新增模組：17個端點 (12.9%)
│   ├── IM.js (激勵系統模組)：6個端點
│   └── NM.js (通知管理模組)：4個端點
└── 模組使用頻率排序：
    1. BK.js (記帳模組)：28個端點
    2. DD1.js (核心協調)：18個端點  
    3. AM.js (帳號管理)：22個端點
    4. MRA.js (報表分析)：15個端點
    5. DD2.js (智慧處理)：12個端點
```

#### 5.6.2 新增模組需求
- **IM.js - 激勵系統模組**: 負責成就、挑戰、獎勵、排行榜功能
- **NM.js - 通知管理模組**: 負責通知設定、列表、狀態管理功能

---

## 6.0 資料流設計（Data Flow Design）

### 6.1 LINE OA 資料流
```
LINE 平台 → WH 模組 → 共用模組群 → Firestore → 回應處理 → LINE 平台
```

### 6.2 APP 資料流
```
Flutter App → 應用邏輯層 → APP模組群 → 共用模組群 → Firestore → JSON 回應 → Flutter App
```

### 6.3 模組間協作流程
1. **請求接收**: WH 模組或 APP 模組群接收請求
2. **身份驗證**: 驗證使用者身份和權限
3. **業務處理**: 呼叫相應的業務邏輯處理
4. **資料操作**: 透過共用模組群進行 Firestore 操作
5. **回應格式化**: 格式化回應資料
6. **結果回傳**: 回傳處理結果給請求方

---

