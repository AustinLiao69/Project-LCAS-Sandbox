# 0020. API list (優化版)

**版本**: 1.1.0  
**建立日期**: 2025-08-21  
**最後更新**: 2025-08-21  
**建立者**: AustinLiao69  

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [API 架構設計](#2-api-架構設計)
   - 2.1 [四模式支援策略](#21-四模式支援策略)

### 3. [API 清單 (55 個端點)](#3-api-清單-55-個端點)
   - 3.1 [認證服務 (8 個)](#31-認證服務-8-個)
   - 3.2 [記帳核心 (12 個)](#32-記帳核心-12-個)
   - 3.3 [基礎管理 (10 個)](#33-基礎管理-10-個)
   - 3.4 [協作管理 (8 個)](#34-協作管理-8-個)
   - 3.5 [預算報表 (8 個)](#35-預算報表-8-個)
   - 3.6 [系統服務 (9 個)](#36-系統服務-9-個)

### 4. [API 契約規格](#4-api-契約規格)
### 5. [四模式差異化設計](#5-四模式差異化設計)

---

## 1. 簡介

基於 [0021. Screen list.md](./0021.%20Screen%20list.md) 的 40 個畫面功能需求，本文件設計55 個端點，採用 RESTful 設計原則，大幅簡化開發維護複雜度，同時保持功能完整性。

---

## 2. API 架構設計

### 2.1 四模式支援策略

```javascript
// 統一端點，Header 區分模式
GET /transactions/dashboard
Header: X-User-Mode: Expert|Inertial|Cultivation|Guiding

// 回應根據模式調整內容深度
Expert: 完整數據 + 進階分析
Inertial: 標準數據 + 固定格式  
Cultivation: 引導數據 + 進度追蹤
Guiding: 簡化數據 + 基本資訊
```

---

## 3. API 清單 (55 個端點)

### 3.1 認證服務 (8 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/auth/register` | POST | 使用者註冊 | S-103 | 整合 Email 驗證流程 |
| `/auth/login` | POST | 使用者登入 | S-104 | 支援多種登入方式 |
| `/auth/refresh` | POST | 刷新 Token | - | 自動 Token 管理 |
| `/auth/forgot-password` | POST | 忘記密碼 | S-105 | 整合重設流程 |
| `/auth/reset-password` | POST | 重設密碼 | S-105 | 安全重設機制 |
| `/auth/bind-line` | POST | LINE 綁定 | S-107 | 跨平台整合 |
| `/auth/bind-status` | GET | 綁定狀態 | S-107 | 狀態查詢 |
| `/users/assessment` | POST | 模式評估 | S-106 | 四模式判定 |

### 3.2 記帳核心 (12 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/transactions` | GET | 查詢交易 | S-209 | 支援複雜篩選參數 |
| `/transactions` | POST | 新增交易 | S-203 | 完整記帳功能 |
| `/transactions/{id}` | GET | 交易詳情 | S-210 | 單筆查詢 |
| `/transactions/{id}` | PUT | 更新交易 | S-210 | 編輯功能 |
| `/transactions/{id}` | DELETE | 刪除交易 | S-209 | 安全刪除 |
| `/transactions/quick` | POST | 快速記帳 | S-201 | LINE OA 專用 |
| `/transactions/dashboard` | GET | 儀表板 | S-202 | 四模式差異化 |
| `/transactions/batch` | POST | 批次操作 | S-209 | 統一批次處理 |
| `/transactions/recurring` | GET | 重複交易管理 | S-208 | 查詢重複設定 |
| `/transactions/recurring` | POST | 建立重複交易 | S-208 | 排程設定 |
| `/transactions/recurring/{id}` | PUT | 更新重複交易 | S-208 | 修改排程 |
| `/transactions/recurring/{id}` | DELETE | 刪除重複交易 | S-208 | 取消排程 |

### 3.3 基礎管理 (10 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/categories` | GET | 科目管理 | S-204, S-306 | 樹狀結構查詢 |
| `/categories` | POST | 新增科目 | S-306 | 建立科目 |
| `/categories/{id}` | PUT | 更新科目 | S-306 | 編輯科目 |
| `/categories/{id}` | DELETE | 刪除科目 | S-306 | 安全刪除 |
| `/accounts` | GET | 帳戶管理 | S-205, S-304 | 餘額查詢 |
| `/accounts` | POST | 新增帳戶 | S-305 | 建立帳戶 |
| `/accounts/{id}` | PUT | 更新帳戶 | S-305 | 編輯帳戶 |
| `/accounts/{id}` | DELETE | 刪除帳戶 | S-304 | 安全刪除 |
| `/ledgers` | GET | 帳本列表 | S-301 | 權限篩選 |
| `/ledgers` | POST | 新增帳本 | S-302 | 建立帳本 |

### 3.4 協作管理 (8 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/ledgers/{id}/collaborators` | GET | 協作者管理 | S-303 | 成員列表 |
| `/ledgers/{id}/invitations` | POST | 邀請協作者 | S-303 | 邀請功能 |
| `/ledgers/{id}/collaborators/{userId}` | PUT | 更新權限 | S-303 | 權限管理 |
| `/ledgers/{id}/collaborators/{userId}` | DELETE | 移除協作者 | S-303 | 移除成員 |
| `/ledgers/{id}/permissions` | GET | 權限狀態 | S-303 | 權限查詢 |
| `/ledgers/{id}/conflicts` | GET | 衝突檢測 | S-303 | 同步衝突 |
| `/ledgers/{id}/resolve-conflict` | POST | 解決衝突 | S-303 | 衝突處理 |
| `/ledgers/{id}/audit-log` | GET | 操作日誌 | S-303 | 審計追蹤 |

### 3.5 預算報表 (8 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/budgets` | GET | 預算管理 | S-307 | 預算列表 |
| `/budgets` | POST | 建立預算 | S-308 | 預算設定 |
| `/budgets/{id}` | PUT | 更新預算 | S-308 | 編輯預算 |
| `/budgets/{id}` | DELETE | 刪除預算 | S-307 | 刪除預算 |
| `/reports` | GET | 報表管理 | S-401 | 報表列表 |
| `/reports/generate` | POST | 生成報表 | S-402 | 自訂報表 |
| `/reports/{id}` | GET | 報表內容 | S-403 | 查看報表 |
| `/reports/{id}/export` | POST | 匯出報表 | S-404 | 多格式匯出 |

### 3.6 系統服務 (9 個)

| API 端點 | 方法 | 描述 | 對應畫面 | 優化說明 |
|----------|------|------|----------|----------|
| `/system/health` | GET | 健康檢查 | - | 系統監控 |
| `/users/profile` | GET | 個人資料 | S-505 | 用戶資訊 |
| `/users/profile` | PUT | 更新資料 | S-505 | 資料編輯 |
| `/backup/create` | POST | 建立備份 | S-502 | 資料備份 |
| `/backup/status` | GET | 備份狀態 | S-502 | 備份查詢 |
| `/notifications/settings` | GET | 通知設定 | S-504 | 設定查詢 |
| `/notifications/settings` | PUT | 更新通知 | S-504 | 設定更新 |
| `/help/articles` | GET | 幫助文章 | S-506 | 幫助內容 |
| `/feedback/report` | POST | 問題回報 | S-507 | 回報功能 |

---

## 4. API 契約規格

### 4.1 統一記帳端點範例

#### `POST /transactions`
**描述**: 統一記帳功能
```json
// Request
{
  "amount": 1500,
  "type": "expense",
  "categoryId": "uuid",
  "accountId": "uuid", 
  "ledgerId": "uuid",
  "date": "2025-01-27",
  "description": "晚餐聚會",
  "tags": ["聚會", "餐廳"],
  "attachments": ["image-uuid"],
  "recurring": {
    "enabled": true,
    "frequency": "weekly",
    "endDate": "2025-12-31"
  }
}

// Response (四模式差異化)
{
  "success": true,
  "data": {
    "transactionId": "uuid",
    "amount": 1500,
    "type": "expense",

    // Expert Mode: 詳細資訊
    "accountBalance": 25000,
    "categoryBudget": {
      "used": 8000,
      "total": 12000,
      "remaining": 4000
    },
    "monthlyAnalysis": {...},

    // Cultivation Mode: 激勵資訊  
    "achievement": {
      "type": "streak",
      "message": "連續記帳 7 天！",
      "progress": 70
    },

    // Guiding Mode: 簡化確認
    "message": "記帳成功"
  }
}
```

#### `GET /transactions`
**描述**: 統一查詢端點
```json
// Request Parameters
?page=1
&pageSize=20
&type=expense
&categoryIds=uuid1,uuid2
&accountIds=uuid3
&dateStart=2025-01-01
&dateEnd=2025-01-31
&tags=餐廳,聚會
&include=statistics,charts,budget

// Response (根據 include 參數動態組合)
{
  "success": true,
  "data": {
    "transactions": [...],
    "pagination": {...},

    // 根據 include 參數包含
    "statistics": {...},     // include=statistics
    "charts": {...},         // include=charts  
    "budgetStatus": {...}    // include=budget
  }
}
```

### 4.2 批次操作統一端點

#### `POST /transactions/batch`
**描述**: 統一批次操作
```json
// Request
{
  "action": "create|update|delete",
  "transactions": [
    {
      "id": "uuid", // update/delete 時需要
      "amount": 100,
      "type": "expense",
      // ... 其他欄位
    }
  ]
}

// Response
{
  "success": true,
  "data": {
    "processed": 10,
    "succeeded": 9,
    "failed": 1,
    "errors": [
      {
        "index": 5,
        "error": "Invalid category ID"
      }
    ]
  }
}
```

---

## 5. 四模式差異化設計

### 模式判斷機制
```javascript
// API 請求標頭
{
  "Authorization": "Bearer jwt-token",
  "X-User-Mode": "Expert|Inertial|Cultivation|Guiding",
  "Content-Type": "application/json"
}
```

### 回應差異化範例

#### `GET /transactions/dashboard`

**Expert Mode - 專業完整**
```json
{
  "summary": {
    "todayIncome": 0,
    "todayExpense": 450,
    "monthIncome": 50000,
    "monthExpense": 35000,
    "balance": 15000,
    "yearToDateSummary": {...}
  },
  "recentTransactions": [...],
  "charts": {
    "weeklyTrend": [...],
    "categoryDistribution": [...],
    "accountBalance": [...]
  },
  "budgetAnalysis": [...],
  "quickActions": [
    {"action": "addTransaction", "label": "快速記帳"},
    {"action": "batchImport", "label": "批次匯入"},
    {"action": "generateReport", "label": "生成報表"}
  ]
}
```

**Guiding Mode - 極簡引導**
```json
{
  "todayExpense": 450,
  "simpleMessage": "今天已花費 NT$450",
  "quickAddButton": true,
  "suggestedCategory": "食物"
}
```
