
# P017_搜尋頁面_SRS

**文件編號**: P017_SRS  
**版本**: v1.0.0  
**建立日期**: 2025-01-26  
**建立者**: LCAS PM Team  
**最後更新**: 2025-01-26 17:00:00 UTC+8

---

## 1. 功能目的（Purpose）

搜尋頁面提供使用者強大的記帳記錄搜尋功能，支援多維度條件搜尋、智能篩選、歷史搜尋記錄，以及搜尋結果的分析與匯出功能。

### 核心功能
- **關鍵字搜尋**: 支援記帳記錄全文搜尋
- **進階篩選**: 日期、科目、金額、標籤等多維度篩選
- **智能建議**: 搜尋關鍵字自動完成與建議
- **結果分析**: 搜尋結果統計與分析圖表
- **歷史記錄**: 搜尋歷史與常用篩選條件

---

## 2. 使用者故事（User Story）

**主要使用者故事**:
```
作為一個經常記帳的使用者
我想要快速找到特定的記帳記錄
以便檢視、編輯或分析我的財務資料

作為一個需要分析消費的使用者
我想要透過多種條件篩選記帳記錄
以便了解我的消費模式和趨勢
```

**具體場景**:
- 搜尋上個月的餐飲消費記錄
- 找出所有超過1000元的支出記錄
- 搜尋包含特定關鍵字的記帳備註
- 篩選特定科目的收入記錄
- 查看搜尋結果的統計分析

---

## 3. 前置條件（Preconditions）

### 使用者狀態
- [x] 使用者已完成登入驗證
- [x] 使用者具備帳本存取權限
- [x] 系統已載入使用者記帳資料

### 系統狀態  
- [x] 網路連線正常（雲端搜尋時）
- [x] 本地資料索引已建立
- [x] 搜尋服務可用

### 資料前置條件
- [x] 存在可搜尋的記帳記錄
- [x] 科目資料完整載入
- [x] 搜尋索引已建立

---

## 4. 功能流程（User Flow / Functional Flow）

### 4.1 主要搜尋流程
```
搜尋頁面流程:
使用者進入 → 輸入搜尋條件 → 執行搜尋 → 檢視結果 → 操作記錄

詳細步驟:
1. 使用者點擊搜尋入口（主頁搜尋框或選單）
2. 進入搜尋頁面，顯示搜尋框與篩選選項
3. 使用者輸入搜尋條件：
   - 關鍵字搜尋：輸入文字關鍵字
   - 進階篩選：設定日期範圍、科目、金額等
   - 組合條件：同時使用多個篩選條件
4. 系統執行搜尋並顯示結果
5. 使用者檢視搜尋結果清單
6. 可對結果進行操作：
   - 點擊查看詳情
   - 編輯記帳記錄
   - 批量操作
   - 匯出結果
7. 儲存搜尋條件為常用篩選（可選）
```

### 4.2 進階篩選流程
```
進階篩選流程:
1. 點擊「進階篩選」按鈕
2. 展開篩選條件面板
3. 設定各項篩選條件：
   - 日期範圍（開始日期、結束日期）
   - 記帳類型（收入、支出、轉帳）
   - 科目選擇（單選或多選）
   - 金額範圍（最小值、最大值）
   - 標籤篩選
   - 備註關鍵字
4. 即時預覽篩選結果數量
5. 確認並執行篩選
6. 顯示篩選結果與統計資訊
```

---

## 5. 輸入項目（Inputs）

### 5.1 搜尋條件
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| keyword | String | 否 | 搜尋關鍵字 |
| startDate | Date | 否 | 開始日期 |
| endDate | Date | 否 | 結束日期 |
| entryType | Enum | 否 | income/expense/transfer |
| categoryIds | Array<String> | 否 | 科目ID列表 |
| minAmount | Number | 否 | 最小金額 |
| maxAmount | Number | 否 | 最大金額 |
| tags | Array<String> | 否 | 標籤列表 |

### 5.2 搜尋參數
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| ledgerId | String | 是 | 帳本ID |
| page | Integer | 否 | 頁碼，預設1 |
| limit | Integer | 否 | 每頁筆數，預設20 |
| sortBy | String | 否 | 排序欄位 |
| sortOrder | Enum | 否 | asc/desc |

### 5.3 篩選快捷選項
- **時間快捷**: 今天、本週、本月、上月、今年
- **金額快捷**: <100、100-500、500-1000、>1000
- **科目快捷**: 餐飲、交通、購物、娛樂等常用科目

---

## 6. 輸出項目（Outputs / Responses）

### 6.1 搜尋結果回應
```json
{
  "success": true,
  "data": {
    "entries": [
      {
        "entryId": "ENT001",
        "date": "2025-01-25",
        "amount": 350,
        "type": "expense",
        "categoryName": "餐飲費",
        "categoryIcon": "restaurant",
        "description": "午餐 - 日式料理",
        "tags": ["外食", "工作日"],
        "location": "台北市信義區"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalCount": 98,
      "hasNext": true
    },
    "statistics": {
      "totalAmount": 15680,
      "averageAmount": 160,
      "entryCount": 98,
      "categoryBreakdown": {
        "餐飲費": 8500,
        "交通費": 3200,
        "購物": 3980
      }
    }
  },
  "message": "搜尋完成"
}
```

### 6.2 搜尋建議回應
```json
{
  "success": true,
  "data": {
    "suggestions": [
      {
        "type": "keyword",
        "text": "午餐",
        "count": 15
      },
      {
        "type": "category", 
        "text": "餐飲費",
        "count": 45
      }
    ]
  }
}
```

---

## 7. 驗證規則（Validation Rules）

### 7.1 輸入驗證
- **關鍵字**: 最大50字元，支援中英文與數字
- **日期範圍**: 結束日期不可早於開始日期
- **金額範圍**: 最小值不可大於最大值，不可為負數
- **頁碼**: 必須為正整數
- **每頁筆數**: 範圍1-100

### 7.2 搜尋邏輯驗證  
- **關鍵字匹配**: 支援部分匹配與全文搜尋
- **日期篩選**: 基於記帳日期進行篩選
- **金額比較**: 支援範圍搜尋與精確匹配
- **組合條件**: AND邏輯組合多個篩選條件

### 7.3 權限驗證
- **帳本權限**: 僅搜尋有權限存取的帳本記錄
- **資料範圍**: 依據使用者權限限制搜尋範圍
- **敏感資訊**: 過濾無權限查看的記錄欄位

---

## 8. 錯誤處理（Error Handling）

### 8.1 輸入錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| SR001 | 搜尋關鍵字過長 | 提示最大長度限制 |
| SR002 | 日期範圍無效 | 自動調整或提示重新選擇 |
| SR003 | 金額範圍無效 | 提示正確的金額格式 |

### 8.2 搜尋錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| SR101 | 搜尋結果過多 | 建議縮小搜尋範圍 |
| SR102 | 無搜尋結果 | 提供搜尋建議與範例 |
| SR103 | 搜尋超時 | 提供重試選項或離線搜尋 |

### 8.3 系統錯誤
- **網路錯誤**: 切換至本地搜尋模式
- **索引損壞**: 重建搜尋索引
- **權限過期**: 引導重新登入

---

## 9. UI 元件與排版需求（UI Requirements）

### 9.1 頁面佈局
```
搜尋頁面佈局:
┌─────────────────────────────┐
│ [← 返回]  搜尋              │
├─────────────────────────────┤
│ 🔍 [請輸入搜尋關鍵字...    ] │
│ [進階篩選 ▼] [清除]        │
├─────────────────────────────┤
│ 📊 找到 98 筆記錄 ($15,680) │
├─────────────────────────────┤
│ 01/25 🍽️ 午餐-日式    $350 │
│ 01/24 🚗 捷運通勤      $30  │
│ 01/24 🛍️ 日用品購物   $280  │
├─────────────────────────────┤
│ [載入更多...]               │
└─────────────────────────────┘
```

### 9.2 進階篩選面板
```
進階篩選面板:
┌─────────────────────────────┐
│ 📅 日期範圍                 │
│ [2025/01/01] 至 [2025/01/31]│
├─────────────────────────────┤
│ 💰 金額範圍                 │
│ $ [最小值] 至 $ [最大值]     │
├─────────────────────────────┤
│ 📂 科目類別                 │
│ ☑️餐飲費 ☑️交通費 ☐購物     │
├─────────────────────────────┤
│ 🏷️ 標籤                    │
│ [#外食] [#工作] [#娛樂]     │
├─────────────────────────────┤
│ [重設] [確定篩選]           │
└─────────────────────────────┘
```

### 9.3 關鍵UI元件
- **搜尋框**: 支援自動完成與歷史記錄
- **篩選標籤**: 顯示已啟用的篩選條件
- **結果卡片**: 記帳記錄摘要資訊
- **統計資訊**: 搜尋結果總計與分析
- **載入更多**: 分頁載入機制

---

## 10. API 規格（API Specification）

### 10.1 執行搜尋
```http
POST /api/v1/entries/search
Headers: Authorization: Bearer {token}
Body: {
  "ledgerId": "string",
  "keyword": "string",
  "filters": {
    "startDate": "2025-01-01",
    "endDate": "2025-01-31", 
    "entryType": "expense",
    "categoryIds": ["CAT001", "CAT002"],
    "minAmount": 100,
    "maxAmount": 1000,
    "tags": ["外食", "工作"]
  },
  "pagination": {
    "page": 1,
    "limit": 20
  },
  "sort": {
    "field": "date",
    "order": "desc"
  }
}
```

### 10.2 獲取搜尋建議
```http
GET /api/v1/entries/search/suggestions
Headers: Authorization: Bearer {token}
Query Parameters:
  - q: string (搜尋關鍵字)
  - ledgerId: string (帳本ID)
  - limit: number (建議數量)
```

### 10.3 儲存搜尋條件
```http
POST /api/v1/entries/search/save
Headers: Authorization: Bearer {token}
Body: {
  "name": "上月餐飲支出",
  "filters": { ... },
  "isDefault": false
}
```

### 10.4 匯出搜尋結果
```http
POST /api/v1/entries/search/export
Headers: Authorization: Bearer {token}
Body: {
  "searchId": "string",
  "format": "csv|excel|pdf",
  "includeCharts": boolean
}
```

---

## 11. 狀態與畫面切換（State Handling）

### 11.1 頁面狀態管理
```typescript
interface SearchState {
  searchQuery: SearchQuery;
  searchResults: SearchResult[];
  isSearching: boolean;
  hasMore: boolean;
  selectedFilters: FilterCondition[];
  searchHistory: SearchHistory[];
  statistics: SearchStatistics;
}
```

### 11.2 搜尋狀態流程
- **初始狀態**: 顯示空搜尋頁面與搜尋歷史
- **搜尋中**: 顯示載入指示器與進度
- **結果顯示**: 展示搜尋結果與統計資訊
- **無結果**: 顯示建議與幫助資訊

### 11.3 篩選狀態管理
- **篩選展開**: 顯示進階篩選面板
- **條件變更**: 即時更新結果預覽
- **篩選套用**: 執行搜尋並收合面板
- **篩選清除**: 重設所有篩選條件

---

## 12. 安全性與權限檢查（Security / Access Control）

### 12.1 搜尋權限
- **帳本權限**: 僅搜尋有權限的帳本記錄
- **資料範圍**: 依據使用者角色限制搜尋範圍
- **欄位權限**: 過濾無權限查看的記錄欄位

### 12.2 資料安全
- **搜尋注入**: 防範搜尋條件注入攻擊
- **敏感資訊**: 搜尋結果中隱藏敏感資訊
- **搜尋日誌**: 記錄搜尋活動（合規要求）

### 12.3 效能安全
- **搜尋頻率**: 限制搜尋請求頻率
- **資源控制**: 限制搜尋結果數量與複雜度
- **快取機制**: 搜尋結果適當快取

---

## 13. 其他補充需求（Others）

### 13.1 效能需求
- **搜尋回應時間**: < 2秒
- **建議回應時間**: < 500ms
- **分頁載入**: < 1秒
- **匯出處理**: < 30秒

### 13.2 搜尋體驗
- **自動完成**: 輸入過程中提供建議
- **搜尋歷史**: 記錄常用搜尋條件
- **智能建議**: 基於搜尋行為提供建議
- **語音搜尋**: 支援語音輸入搜尋（可選）

### 13.3 離線支援
- **本地搜尋**: 離線時搜尋本地快取資料
- **索引同步**: 上線後同步搜尋索引
- **結果快取**: 本地快取搜尋結果

### 13.4 分析功能
- **搜尋統計**: 提供搜尋結果統計分析
- **趨勢圖表**: 搜尋結果的時間趨勢
- **分類分析**: 按科目、標籤等維度分析
- **匯出功能**: 支援多種格式匯出結果

---

**文件狀態**: ✅ 已完成  
**下一階段**: P018_統計頁面_SRS.md  
**相關文件**: P013_記帳歷史頁面_SRS.md、P018_統計頁面_SRS.md
