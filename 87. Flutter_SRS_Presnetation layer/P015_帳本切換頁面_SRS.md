
# P019_帳本切換頁面_SRS

**文件編號**: P019_SRS  
**版本**: v1.0.0  
**建立日期**: 2025-01-26  
**建立者**: LCAS PM Team  
**最後更新**: 2025-01-26 17:30:00 UTC+8

---

## 1. 功能目的（Purpose）

帳本切換頁面提供使用者快速切換不同帳本的功能，支援個人帳本、協作帳本、專案帳本的統一管理，以及帳本間的快速切換與狀態同步。

### 核心功能
- **帳本列表**: 顯示所有可存取的帳本清單
- **快速切換**: 一鍵切換當前工作帳本
- **帳本狀態**: 顯示帳本類型、成員狀態、同步狀態
- **搜尋篩選**: 快速查找特定帳本
- **最近使用**: 智能排序常用帳本

---

## 2. 使用者故事（User Story）

**主要使用者故事**:
```
作為一個多帳本使用者
我想要快速切換不同的帳本
以便管理不同用途的財務記錄

作為一個協作帳本成員
我想要查看我參與的所有協作帳本
以便選擇適當的帳本進行記帳
```

**具體場景**:
- 從個人帳本切換到家庭共同帳本
- 查看所有參與的專案帳本
- 搜尋特定名稱的帳本
- 查看帳本的成員和權限狀態
- 快速存取最近使用的帳本

---

## 3. 前置條件（Preconditions）

### 使用者狀態
- [x] 使用者已完成登入驗證
- [x] 使用者至少擁有一個帳本的存取權限
- [x] 系統已載入使用者帳本清單

### 系統狀態  
- [x] 網路連線正常
- [x] 帳本資料已同步
- [x] 權限資料已更新

### 資料前置條件
- [x] 存在可存取的帳本資料
- [x] 帳本權限資料完整
- [x] 帳本成員資料已載入

---

## 4. 功能流程（User Flow / Functional Flow）

### 4.1 主要切換流程
```
帳本切換流程:
使用者觸發 → 顯示帳本清單 → 選擇目標帳本 → 切換確認 → 更新全域狀態

詳細步驟:
1. 使用者觸發帳本切換：
   - 點擊頂部帳本名稱
   - 從主選單選擇「切換帳本」
   - 長按首頁帳本區域
2. 系統顯示帳本選擇介面
3. 載入並顯示所有可存取的帳本：
   - 個人帳本
   - 協作帳本
   - 專案帳本
4. 使用者瀏覽帳本清單：
   - 查看帳本基本資訊
   - 檢視成員和權限狀態
   - 使用搜尋功能（可選）
5. 選擇目標帳本並確認切換
6. 系統執行帳本切換：
   - 保存切換紀錄
   - 更新全域帳本狀態
   - 重新載入相關頁面資料
7. 返回主要功能頁面
```

### 4.2 帳本狀態檢查流程
```
帳本狀態檢查:
1. 顯示帳本清單前檢查權限
2. 驗證各帳本的存取權限
3. 檢查帳本同步狀態
4. 更新帳本成員資訊
5. 標記離線/無權限的帳本
6. 排序並顯示可用帳本
```

---

## 5. 輸入項目（Inputs）

### 5.1 帳本查詢參數
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| userId | String | 是 | 當前使用者ID |
| includeArchived | Boolean | 否 | 是否包含已歸檔帳本 |
| ledgerType | Enum | 否 | personal/shared/project |
| searchKeyword | String | 否 | 搜尋關鍵字 |

### 5.2 切換操作參數
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| targetLedgerId | String | 是 | 目標帳本ID |
| previousLedgerId | String | 是 | 當前帳本ID |
| switchReason | String | 否 | 切換原因記錄 |

### 5.3 篩選條件
- **帳本類型**: 個人、協作、專案帳本
- **權限等級**: 擁有者、管理員、成員、唯讀
- **同步狀態**: 已同步、同步中、離線
- **使用頻率**: 最近使用、常用、很少使用

---

## 6. 輸出項目（Outputs / Responses）

### 6.1 帳本清單回應
```json
{
  "success": true,
  "data": {
    "currentLedger": {
      "ledgerId": "LED001",
      "name": "個人帳本",
      "type": "personal"
    },
    "availableLedgers": [
      {
        "ledgerId": "LED001",
        "name": "個人帳本",
        "type": "personal",
        "role": "owner",
        "memberCount": 1,
        "lastUsed": "2025-01-26T10:30:00Z",
        "syncStatus": "synced",
        "isArchived": false,
        "currency": "TWD",
        "totalEntries": 156,
        "lastEntryDate": "2025-01-25T18:45:00Z"
      },
      {
        "ledgerId": "LED002", 
        "name": "家庭共同帳本",
        "type": "shared",
        "role": "admin",
        "memberCount": 3,
        "members": [
          {
            "userId": "USER001",
            "name": "張小明",
            "role": "owner"
          }
        ],
        "lastUsed": "2025-01-24T15:20:00Z",
        "syncStatus": "syncing",
        "isArchived": false,
        "currency": "TWD",
        "totalEntries": 89,
        "lastEntryDate": "2025-01-24T20:15:00Z"
      }
    ],
    "recentLedgers": ["LED001", "LED002"],
    "totalCount": 5
  },
  "message": "帳本清單載入成功"
}
```

### 6.2 切換結果回應
```json
{
  "success": true,
  "data": {
    "newCurrentLedger": {
      "ledgerId": "LED002",
      "name": "家庭共同帳本",
      "type": "shared",
      "role": "admin"
    },
    "switchTime": "2025-01-26T17:30:00Z",
    "dataReloadRequired": true
  },
  "message": "帳本切換成功"
}
```

---

## 7. 驗證規則（Validation Rules）

### 7.1 權限驗證
- **存取權限**: 驗證使用者對目標帳本的存取權限
- **角色檢查**: 確認使用者在帳本中的角色
- **狀態驗證**: 檢查帳本是否為活躍狀態
- **成員資格**: 驗證協作帳本的成員資格

### 7.2 資料完整性
- **帳本存在性**: 目標帳本必須存在且可存取
- **同步狀態**: 檢查帳本資料同步狀態
- **版本相容**: 確保帳本資料版本相容性

### 7.3 操作限制
- **切換頻率**: 限制短時間內的切換次數
- **同時操作**: 防止同時切換多個帳本
- **資料載入**: 確保切換前資料已正確載入

---

## 8. 錯誤處理（Error Handling）

### 8.1 權限錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| LS001 | 無權限存取該帳本 | 隱藏帳本或顯示申請權限選項 |
| LS002 | 帳本已被歸檔 | 提示帳本狀態並建議聯繫擁有者 |
| LS003 | 成員資格已被撤銷 | 移除帳本並通知使用者 |

### 8.2 系統錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| LS101 | 帳本資料載入失敗 | 提供重試選項或使用快取資料 |
| LS102 | 切換操作超時 | 回復至原帳本並提示重試 |
| LS103 | 同步衝突 | 顯示衝突解決選項 |

### 8.3 網路錯誤
- **離線模式**: 顯示本地快取的帳本清單
- **同步失敗**: 標記未同步帳本並提供手動同步
- **連線中斷**: 保存操作並在恢復連線後執行

---

## 9. UI 元件與排版需求（UI Requirements）

### 9.1 頁面佈局
```
帳本切換頁面佈局:
┌─────────────────────────────┐
│ [✕ 關閉]  選擇帳本  [搜尋🔍] │
├─────────────────────────────┤
│ 🏠 個人帳本 ✓              │
│    156筆記錄 • 擁有者        │
│    最後使用: 剛剛            │
├─────────────────────────────┤
│ 👨‍👩‍👧‍👦 家庭共同帳本        │
│    89筆記錄 • 管理員  🔄     │
│    3位成員 • 1小時前         │
├─────────────────────────────┤
│ 💼 專案帳本A                │
│    45筆記錄 • 成員           │
│    5位成員 • 昨天            │
├─────────────────────────────┤
│ [+ 建立新帳本]              │
└─────────────────────────────┘
```

### 9.2 帳本卡片設計
```
帳本卡片:
┌─────────────────────────────┐
│ 📚 [圖示] 帳本名稱     [✓/○] │
│ └─ 帳本類型標籤              │
├─────────────────────────────┤
│ 📊 156筆記錄 • 擁有者        │
│ 👥 3位成員 • 最後使用: 1小時前│
│ 🔄 同步狀態指示              │
└─────────────────────────────┘
```

### 9.3 關鍵UI元件
- **帳本卡片**: 顯示帳本基本資訊與狀態
- **選中指示**: 當前帳本的視覺標示
- **搜尋框**: 快速篩選帳本功能
- **狀態圖示**: 同步、權限、類型狀態指示
- **操作按鈕**: 建立新帳本、重新整理

---

## 10. API 規格（API Specification）

### 10.1 獲取帳本清單
```http
GET /api/v1/ledgers/accessible
Headers: Authorization: Bearer {token}
Query Parameters:
  - includeArchived: boolean
  - type: string (personal/shared/project)
  - search: string
```

### 10.2 切換帳本
```http
POST /api/v1/user/switch-ledger
Headers: Authorization: Bearer {token}
Body: {
  "targetLedgerId": "string",
  "previousLedgerId": "string",
  "switchTime": "2025-01-26T17:30:00Z"
}
```

### 10.3 獲取帳本狀態
```http
GET /api/v1/ledgers/{ledgerId}/status
Headers: Authorization: Bearer {token}
Response: {
  "syncStatus": "synced|syncing|offline",
  "memberCount": number,
  "lastActivity": "datetime",
  "userRole": "owner|admin|member|viewer"
}
```

### 10.4 更新最近使用
```http
PUT /api/v1/user/recent-ledgers
Headers: Authorization: Bearer {token}
Body: {
  "ledgerId": "string",
  "accessTime": "datetime"
}
```

---

## 11. 狀態與畫面切換（State Handling）

### 11.1 頁面狀態管理
```typescript
interface LedgerSwitchState {
  availableLedgers: Ledger[];
  currentLedger: Ledger;
  isLoading: boolean;
  isSwitching: boolean;
  searchKeyword: string;
  selectedLedger: Ledger | null;
  filterType: LedgerType | 'all';
}
```

### 11.2 同步狀態管理
- **載入狀態**: 帳本清單載入中
- **切換狀態**: 正在執行帳本切換
- **同步狀態**: 各帳本的資料同步狀態
- **錯誤狀態**: 載入或切換失敗的錯誤處理

### 11.3 全域狀態更新
- **當前帳本**: 全域當前帳本狀態更新
- **使用記錄**: 更新帳本使用歷史
- **權限刷新**: 重新驗證帳本權限
- **資料重載**: 切換後觸發相關資料重新載入

---

## 12. 安全性與權限檢查（Security / Access Control）

### 12.1 權限驗證
- **帳本存取**: 驗證使用者對各帳本的存取權限
- **角色檢查**: 確認使用者在協作帳本中的角色
- **動態權限**: 即時檢查權限變更

### 12.2 資料安全
- **敏感資訊**: 不在清單中顯示詳細財務資料
- **權限過濾**: 僅顯示有權限存取的帳本
- **操作記錄**: 記錄帳本切換操作日誌

### 12.3 會話安全
- **會話驗證**: 切換前驗證使用者會話有效性
- **權限更新**: 切換後更新會話權限資訊
- **安全登出**: 權限不足時引導重新登入

---

## 13. 其他補充需求（Others）

### 13.1 效能需求
- **清單載入時間**: < 2秒
- **切換執行時間**: < 1秒
- **搜尋回應時間**: < 300ms
- **狀態更新時間**: < 500ms

### 13.2 使用體驗
- **智能排序**: 依據使用頻率和時間排序
- **快速存取**: 提供最近使用帳本快捷入口
- **視覺回饋**: 清楚的切換狀態指示
- **手勢支援**: 支援滑動切換等手勢操作

### 13.3 離線支援
- **本地快取**: 快取帳本清單資料
- **離線切換**: 支援離線模式下的帳本切換
- **同步恢復**: 上線後同步切換操作

### 13.4 可擴展性
- **大量帳本**: 支援大量帳本的效能優化
- **分頁載入**: 帳本過多時採用分頁載入
- **分類組織**: 支援帳本分類和標籤功能
- **批量操作**: 支援批量帳本管理操作

---

**文件狀態**: ✅ 已完成  
**下一階段**: P020_帳本清單頁面_SRS.md（Phase 2開始）  
**相關文件**: P010_首頁儀表板_SRS.md、P020_帳本清單頁面_SRS.md

## 🎉 Phase 1 完成通知

**Phase 1: 核心認證與基礎功能頁面群組已全部完成！**

✅ **已完成的SRS文件 (15個)**:
- P001-P005: 認證流程頁面群組 (5個)
- P010-P019: 主要功能頁面群組 (10個)

📊 **目前進度統計**:
- 已完成: 15個SRS文件
- 總計劃: 69個SRS文件  
- 完成率: **21.7%**

🎯 **下一步**: 準備進入Phase 2 - 多帳本管理頁面群組 (P020-P029)
