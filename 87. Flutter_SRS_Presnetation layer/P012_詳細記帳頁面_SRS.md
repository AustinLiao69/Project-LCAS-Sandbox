
# P012_詳細記帳頁面_SRS

**文件編號**: P012_SRS  
**文件版本**: v1.0.0  
**建立日期**: 2025-01-26  
**建立者**: LCAS PM Team  
**最後更新**: 2025-01-26 14:35:00 UTC+8

---

## 1. 功能目的（Purpose）

詳細記帳頁面提供完整的記帳功能，支援多項目分割、附件上傳、定位資訊、重複交易設定等進階功能，滿足精確控制者和專業使用者的詳細記帳需求。

## 2. 使用者故事（User Story）

**主要使用者故事:**
- 作為一位精準控制者，我希望能詳細記錄每筆交易的完整資訊，包括地點、附件、分類等
- 作為一位專案管理者，我希望能將一筆交易分割到多個項目或類別中
- 作為一位重複消費的使用者，我希望能設定定期交易，系統自動記帳

**次要使用者故事:**
- 作為一位報銷需求的使用者，我希望能上傳收據照片並自動識別資訊
- 作為一位多帳本使用者，我希望能在記帳時選擇不同帳本
- 作為一位群組協作者，我希望能標註交易的分攤對象

## 3. 前置條件（Preconditions）

- 使用者已完成登入驗證
- 使用者至少擁有一個有效帳本
- 裝置具備網路連線
- 相機/相簿權限（上傳附件時）
- 定位權限（記錄地點時，可選）

## 4. 功能流程（User Flow / Functional Flow）

### 4.1 主要流程
1. **進入頁面** → 顯示詳細記帳表單
2. **填寫基本資訊** → 金額、項目、類別、日期
3. **選擇進階功能**:
   - 附件上傳與OCR識別
   - 地點記錄
   - 分割交易
   - 定期交易設定
4. **預覽確認** → 檢視完整記帳資訊
5. **提交記帳** → 儲存至資料庫
6. **成功回饋** → 顯示記帳結果

### 4.2 附件OCR流程
1. 選擇照片來源（相機/相簿）
2. 拍攝或選擇收據照片
3. OCR自動識別金額、商家、日期
4. 使用者確認或修正識別結果
5. 附件與資訊一併儲存

### 4.3 分割交易流程
1. 啟用分割功能
2. 新增分割項目
3. 分配金額和類別
4. 確認總金額一致
5. 儲存多筆分割記錄

## 5. 輸入項目（Inputs）

### 5.1 基本必填欄位
- **金額** (amount): 數字型別，支援小數點
- **項目名稱** (item): 文字型別，最多100字元
- **收支類型** (type): 選擇型別（支出/收入/轉帳）

### 5.2 基本選填欄位
- **類別** (category): 下拉選單，支援多層級分類
- **子類別** (subcategory): 二級分類選單
- **帳本** (ledger): 下拉選單，預設當前帳本
- **日期時間** (datetime): 日期時間選擇器
- **備註** (note): 文字型別，最多500字元

### 5.3 進階欄位
- **附件** (attachments): 圖片檔案，最多5張
- **地點** (location): GPS座標或手動輸入地址
- **標籤** (tags): 多選標籤，支援自訂
- **分攤對象** (split_members): 多選成員清單
- **付款方式** (payment_method): 現金/信用卡/電子支付等
- **匯率** (exchange_rate): 外幣交易時使用

### 5.4 定期交易設定
- **重複頻率** (repeat_frequency): 無/每日/每週/每月/每年
- **重複結束** (repeat_end): 永不結束/特定日期/次數
- **自動執行** (auto_execute): 是否自動記帳

## 6. 輸出項目（Outputs / Responses）

### 6.1 成功回應
```json
{
  "success": true,
  "data": {
    "entry_id": "ENT_20250126_002",
    "amount": 1250.00,
    "item": "團隊聚餐",
    "category": "餐飲",
    "subcategory": "聚餐",
    "type": "expense",
    "date": "2025-01-26",
    "attachments": [
      {
        "id": "ATT_001",
        "filename": "receipt_001.jpg",
        "ocr_data": {
          "merchant": "ABC餐廳",
          "amount": 1250.00,
          "date": "2025-01-26"
        }
      }
    ],
    "location": {
      "address": "台北市信義區信義路五段7號",
      "coordinates": [121.5654, 25.0330]
    },
    "split_details": [
      {
        "member": "User_A",
        "amount": 625.00
      },
      {
        "member": "User_B", 
        "amount": 625.00
      }
    ],
    "created_at": "2025-01-26T18:30:00+08:00"
  },
  "message": "詳細記帳成功！"
}
```

### 6.2 OCR識別回應
```json
{
  "success": true,
  "ocr_result": {
    "merchant": "ABC餐廳",
    "amount": 1250.00,
    "date": "2025-01-26",
    "items": [
      "主餐 x2",
      "飲料 x2",
      "服務費"
    ],
    "confidence": 0.95
  }
}
```

## 7. 驗證規則（Validation Rules）

### 7.1 基本驗證
- **金額**: 必須為正數，最大999,999,999，小數點最多2位
- **項目名稱**: 1-100字元，不可包含特殊符號
- **日期**: 不可超過當前日期3天，不可早於帳本建立日期

### 7.2 進階驗證
- **附件**: 檔案格式限制(jpg, png, pdf)，單檔最大10MB
- **分割金額**: 分割總額必須等於原始金額
- **地點**: GPS座標格式驗證，地址長度最多200字元
- **標籤**: 每個標籤最多20字元，最多10個標籤

### 7.3 定期交易驗證
- **重複結束日期**: 必須晚於開始日期
- **重複次數**: 最多999次
- **頻率設定**: 每日重複不可超過365天

## 8. 錯誤處理（Error Handling）

### 8.1 輸入驗證錯誤
- **E012001**: 金額超出範圍 → "金額不可超過999,999,999"
- **E012002**: 項目名稱過長 → "項目名稱不可超過100字元"
- **E012003**: 日期無效 → "請選擇有效的日期"

### 8.2 檔案處理錯誤
- **E012101**: 檔案格式不支援 → "僅支援jpg, png, pdf格式"
- **E012102**: 檔案過大 → "檔案大小不可超過10MB"
- **E012103**: OCR識別失敗 → "無法識別收據內容，請手動輸入"

### 8.3 功能操作錯誤
- **E012201**: 分割金額不符 → "分割金額總計必須等於原始金額"
- **E012202**: 地點獲取失敗 → "無法獲取位置資訊，請手動輸入"
- **E012203**: 定期設定無效 → "定期交易設定參數錯誤"

## 9. UI 元件與排版需求（UI Requirements）

### 9.1 頁面佈局
```
┌─────────────────────────────────┐
│ ← 詳細記帳              ✓ 儲存   │
├─────────────────────────────────┤
│ 📷 附件上傳   📍 地點   🔄 定期  │
├─────────────────────────────────┤
│ 金額: _________________ 元       │
│ 項目: _________________         │
│ 類別: [餐飲 ▼] 子類別: [聚餐 ▼] │
│ 帳本: [個人帳本 ▼]              │
│ 日期: [2025-01-26 ▼] 時間: [18:30] │
│ 付款: [信用卡 ▼]                │ 
├─────────────────────────────────┤
│ 📎 附件 (2)                     │
│ [receipt1.jpg] [receipt2.jpg]   │
├─────────────────────────────────┤
│ 📍 地點: ABC餐廳                │
│ 台北市信義區信義路五段7號        │
├─────────────────────────────────┤
│ 🏷️ 標籤: [工作] [聚餐] [+新增]   │
├─────────────────────────────────┤
│ 👥 分攤 (2人)                   │
│ User_A: 625元  User_B: 625元    │
├─────────────────────────────────┤
│ 📝 備註: ___________________    │
│ _________________________________│
├─────────────────────────────────┤
│        [預覽] [儲存記帳]         │
└─────────────────────────────────┘
```

### 9.2 色彩與視覺設計
- **主色調**: 深藍色 (#1B365D)
- **輔助色**: 橙色 (#FF9500)
- **成功色**: 綠色 (#34C759)
- **警告色**: 黃色 (#FFCC00)
- **錯誤色**: 紅色 (#FF3B30)

### 9.3 互動設計
- **展開式區塊**: 進階功能可摺疊收起
- **拖拽上傳**: 支援拖拽上傳附件
- **智慧建議**: 輸入時顯示歷史記錄建議
- **即時預覽**: 填寫時即時顯示預覽效果

## 10. API 規格（API Specification）

### 10.1 詳細記帳 API
```http
POST /api/v1/entries/detailed
Content-Type: multipart/form-data
Authorization: Bearer {token}

Form Data:
- entry_data: {json格式記帳資料}
- attachments[]: {檔案陣列}
```

### 10.2 OCR識別 API
```http
POST /api/v1/entries/ocr
Content-Type: multipart/form-data
Authorization: Bearer {token}

Form Data:
- image: {圖片檔案}
- language: "zh-TW"
```

### 10.3 地點搜尋 API
```http
GET /api/v1/location/search?q={keyword}&lat={lat}&lng={lng}
Authorization: Bearer {token}
```

### 10.4 定期交易 API
```http
POST /api/v1/entries/recurring
Content-Type: application/json
Authorization: Bearer {token}

{
  "entry_template": {...},
  "recurring_settings": {
    "frequency": "monthly",
    "end_date": "2025-12-31",
    "auto_execute": true
  }
}
```

## 11. 狀態與畫面切換（State Handling）

### 11.1 頁面狀態
- **editing**: 編輯填寫中
- **uploading**: 檔案上傳中
- **ocr_processing**: OCR處理中
- **location_loading**: 地點獲取中
- **validating**: 資料驗證中
- **submitting**: 提交處理中
- **success**: 提交成功
- **error**: 錯誤狀態

### 11.2 表單狀態管理
- **自動儲存**: 每30秒自動儲存草稿
- **離開確認**: 未儲存時離開頁面提示確認
- **復原機制**: 意外關閉時可復原未儲存內容

### 11.3 附件狀態
- **pending**: 待上傳
- **uploading**: 上傳中
- **processing**: OCR處理中
- **completed**: 處理完成
- **failed**: 處理失敗

## 12. 安全性與權限檢查（Security / Access Control）

### 12.1 檔案安全
- 檔案類型白名單檢查
- 檔案內容病毒掃描
- 檔案儲存加密
- 存取權限控制

### 12.2 地點隱私
- 地點資訊可選擇性儲存
- 精確度等級設定
- 地點歷史記錄管理

### 12.3 分攤權限
- 僅能分攤給有權限的成員
- 分攤通知與確認機制
- 分攤記錄追蹤

## 13. 其他補充需求（Others）

### 13.1 效能需求
- 頁面載入時間 < 3秒
- 檔案上傳進度顯示
- OCR處理時間 < 10秒
- 大量資料分頁載入

### 13.2 離線功能
- 表單資料本地暫存
- 附件離線排隊上傳
- 網路恢復時自動同步

### 13.3 無障礙支援
- 螢幕閱讀器相容
- 鍵盤完整操作支援
- 顏色對比度符合WCAG標準
- 表單錯誤清楚提示

### 13.4 分析統計
- 記錄功能使用頻率
- OCR識別準確率統計
- 使用者操作路徑分析
- 錯誤發生統計

---

**文件維護記錄**

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0.0 | 2025-01-26 | LCAS PM Team | 初始版本建立 |
