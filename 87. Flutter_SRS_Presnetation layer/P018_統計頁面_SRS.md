
# P018_統計頁面_SRS

**文件編號**: P018_SRS  
**版本**: v1.0.0  
**建立日期**: 2025-01-26  
**建立者**: LCAS PM Team  
**最後更新**: 2025-01-26 17:15:00 UTC+8

---

## 1. 功能目的（Purpose）

統計頁面提供使用者全方位的財務數據視覺化分析功能，包含收支統計、趨勢分析、科目分布、預算執行狀況，以及個人化的財務洞察報告。

### 核心功能
- **收支統計**: 收入、支出、結餘的統計分析
- **趨勢圖表**: 時間序列的財務趨勢分析
- **科目分析**: 各科目的支出分布與排名
- **預算追蹤**: 預算執行進度與警示
- **比較分析**: 不同時期的對比分析
- **洞察報告**: AI驅動的財務建議與洞察

---

## 2. 使用者故事（User Story）

**主要使用者故事**:
```
作為一個關注財務健康的使用者
我想要查看我的收支統計和趨勢分析
以便了解我的財務狀況並做出更好的決策

作為一個預算管理者
我想要追蹤我的預算執行狀況
以便及時調整我的消費行為
```

**具體場景**:
- 查看本月收支統計與上月對比
- 分析最大支出科目和消費趨勢
- 檢視預算執行進度與剩餘額度
- 了解每日平均支出與異常消費
- 獲得個人化的財務建議

---

## 3. 前置條件（Preconditions）

### 使用者狀態
- [x] 使用者已完成登入驗證
- [x] 使用者具備帳本存取權限
- [x] 系統已載入使用者記帳資料

### 系統狀態  
- [x] 網路連線正常（雲端分析時）
- [x] 統計資料已計算完成
- [x] 圖表渲染組件可用

### 資料前置條件
- [x] 存在足夠的記帳資料進行統計
- [x] 預算資料已設定（預算分析時）
- [x] 科目資料完整

---

## 4. 功能流程（User Flow / Functional Flow）

### 4.1 主要瀏覽流程
```
統計頁面流程:
使用者進入 → 載入統計資料 → 選擇分析維度 → 查看詳細分析 → 獲取洞察

詳細步驟:
1. 使用者點擊「統計」入口（底部導航或主選單）
2. 系統載入預設時間範圍的統計資料
3. 顯示總覽統計儀表板
4. 使用者可選擇不同分析維度：
   - 時間範圍：今日、本週、本月、自訂範圍
   - 帳本範圍：當前帳本或全部帳本
   - 科目篩選：特定科目或科目群組
5. 系統重新計算並顯示統計圖表
6. 使用者深入查看特定分析：
   - 點擊圖表查看詳細數據
   - 切換不同圖表類型
   - 查看趨勢預測
7. 獲取AI洞察建議（如可用）
8. 匯出統計報告（可選）
```

### 4.2 預算追蹤流程
```
預算追蹤流程:
1. 切換至「預算追蹤」分頁
2. 顯示所有有效預算項目
3. 展示各預算的執行進度：
   - 已使用金額 / 預算總額
   - 剩餘天數與平均可用額度
   - 超支警示與建議
4. 點擊特定預算查看詳細分析
5. 顯示預算歷史趨勢
6. 提供預算調整建議
```

---

## 5. 輸入項目（Inputs）

### 5.1 統計查詢參數
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| ledgerId | String | 是 | 帳本ID |
| startDate | Date | 是 | 統計開始日期 |
| endDate | Date | 是 | 統計結束日期 |
| groupBy | Enum | 否 | day/week/month/year |
| categoryIds | Array<String> | 否 | 指定科目ID |
| includeTransfers | Boolean | 否 | 是否包含轉帳 |

### 5.2 比較分析參數
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| compareStartDate | Date | 否 | 比較期間開始日期 |
| compareEndDate | Date | 否 | 比較期間結束日期 |
| compareType | Enum | 否 | previous_period/same_period_last_year |

### 5.3 圖表設定
| 欄位名稱 | 資料型別 | 必填 | 說明 |
|----------|----------|------|------|
| chartType | Enum | 否 | line/bar/pie/donut |
| showTrend | Boolean | 否 | 是否顯示趨勢線 |
| showAverage | Boolean | 否 | 是否顯示平均線 |

---

## 6. 輸出項目（Outputs / Responses）

### 6.1 統計總覽回應
```json
{
  "success": true,
  "data": {
    "summary": {
      "totalIncome": 45000,
      "totalExpense": 38500,
      "netIncome": 6500,
      "transactionCount": 156,
      "averageDaily": 1283,
      "period": {
        "startDate": "2025-01-01",
        "endDate": "2025-01-31"
      }
    },
    "trends": {
      "incomeGrowth": 5.2,
      "expenseGrowth": -2.1,
      "savingsRate": 14.4
    },
    "categoryBreakdown": {
      "餐飲費": {
        "amount": 12500,
        "percentage": 32.5,
        "transactionCount": 45,
        "averageAmount": 278
      },
      "交通費": {
        "amount": 3200,
        "percentage": 8.3,
        "transactionCount": 23,
        "averageAmount": 139
      }
    }
  }
}
```

### 6.2 趨勢分析回應
```json
{
  "success": true,
  "data": {
    "timeSeries": [
      {
        "date": "2025-01-01",
        "income": 1500,
        "expense": 1200,
        "balance": 300,
        "cumulativeBalance": 300
      }
    ],
    "predictions": {
      "nextMonthExpense": 39200,
      "confidence": 85,
      "factors": ["季節性消費", "歷史趨勢"]
    },
    "insights": [
      {
        "type": "warning",
        "message": "本月餐飲支出較上月增加25%",
        "suggestion": "建議控制外食頻率"
      }
    ]
  }
}
```

---

## 7. 驗證規則（Validation Rules）

### 7.1 參數驗證
- **日期範圍**: 結束日期不可早於開始日期
- **時間跨度**: 最大查詢範圍不超過2年
- **帳本權限**: 驗證使用者對指定帳本的存取權限
- **科目有效性**: 檢查指定科目ID是否存在

### 7.2 資料完整性
- **最小資料量**: 至少需要3筆記錄才能進行趨勢分析
- **資料品質**: 檢查資料完整性與一致性
- **計算精確度**: 金額計算保留小數點後2位

### 7.3 效能限制
- **查詢範圍**: 限制單次查詢的資料量
- **並發限制**: 限制同時進行的統計查詢數量
- **快取有效性**: 檢查統計快取的有效性

---

## 8. 錯誤處理（Error Handling）

### 8.1 參數錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| ST001 | 日期範圍無效 | 自動調整為有效範圍 |
| ST002 | 查詢範圍過大 | 建議縮小查詢範圍 |
| ST003 | 科目不存在 | 移除無效科目並繼續查詢 |

### 8.2 資料錯誤
| 錯誤碼 | 錯誤訊息 | 處理方式 |
|--------|----------|----------|
| ST101 | 資料不足無法分析 | 顯示資料收集建議 |
| ST102 | 統計計算失敗 | 使用預設統計或重試 |
| ST103 | 預算資料缺失 | 隱藏預算相關功能 |

### 8.3 系統錯誤
- **計算超時**: 切換至近似計算或快取結果
- **記憶體不足**: 分批處理大量資料
- **網路錯誤**: 使用本地快取資料

---

## 9. UI 元件與排版需求（UI Requirements）

### 9.1 頁面佈局
```
統計頁面佈局:
┌─────────────────────────────┐
│ [← 返回]  統計分析   [範圍▼] │
├─────────────────────────────┤
│ 💰 本月收支總覽              │
│ 收入 $45,000  支出 $38,500  │
│ 結餘 $6,500   (↑14.4%)     │
├─────────────────────────────┤
│ 📈 [收支趨勢圖表]           │
├─────────────────────────────┤
│ 🍕 餐飲費 $12,500 (32.5%)   │
│ ████████░░                  │
│ 🚗 交通費 $3,200 (8.3%)     │
│ ███░░░░░░░                  │
├─────────────────────────────┤
│ [總覽] [趨勢] [科目] [預算] │
└─────────────────────────────┘
```

### 9.2 圖表組件
```
趨勢圖表:
┌─────────────────────────────┐
│ 收支趨勢 - 2025年1月         │
├─────────────────────────────┤
│    ▲                        │
│ 2k │     ●●●                │
│    │   ●     ●              │
│ 1k │ ●         ●            │
│    │              ●●        │
│  0 └─────────────────────── │
│    1/1  1/10  1/20  1/31    │
│ ── 收入  ── 支出             │
└─────────────────────────────┘
```

### 9.3 關鍵UI元件
- **統計卡片**: 顯示關鍵財務指標
- **圖表組件**: 多種圖表類型支援
- **分頁標籤**: 不同分析維度切換
- **時間選擇器**: 靈活的日期範圍選擇
- **篩選控制**: 科目與條件篩選

---

## 10. API 規格（API Specification）

### 10.1 獲取統計總覽
```http
GET /api/v1/statistics/overview
Headers: Authorization: Bearer {token}
Query Parameters:
  - ledgerId: string
  - startDate: date
  - endDate: date
  - groupBy: string
```

### 10.2 獲取趨勢分析
```http
GET /api/v1/statistics/trends
Headers: Authorization: Bearer {token}
Query Parameters:
  - ledgerId: string
  - startDate: date
  - endDate: date
  - chartType: string
  - includePrediction: boolean
```

### 10.3 獲取科目分析
```http
GET /api/v1/statistics/categories
Headers: Authorization: Bearer {token}
Query Parameters:
  - ledgerId: string
  - startDate: date
  - endDate: date
  - limit: number
  - minAmount: number
```

### 10.4 獲取預算統計
```http
GET /api/v1/statistics/budget
Headers: Authorization: Bearer {token}
Query Parameters:
  - ledgerId: string
  - budgetId: string (optional)
  - includeProjection: boolean
```

---

## 11. 狀態與畫面切換（State Handling）

### 11.1 頁面狀態管理
```typescript
interface StatisticsState {
  dateRange: DateRange;
  selectedLedger: string;
  activeTab: 'overview' | 'trends' | 'categories' | 'budget';
  statistics: StatisticsData;
  isLoading: boolean;
  chartConfig: ChartConfig;
  filters: StatisticsFilters;
}
```

### 11.2 載入狀態管理
- **初始載入**: 顯示骨架屏與載入指示器
- **資料更新**: 部分重新載入與載入狀態
- **圖表渲染**: 圖表載入動畫與過渡效果
- **錯誤狀態**: 錯誤提示與重試機制

### 11.3 互動狀態
- **圖表選擇**: 圖表元素點擊與高亮
- **時間切換**: 時間範圍變更與資料刷新
- **篩選器**: 篩選條件變更與即時更新
- **分頁切換**: 不同分析視圖切換

---

## 12. 安全性與權限檢查（Security / Access Control）

### 12.1 資料存取權限
- **帳本權限**: 僅統計有權限的帳本資料
- **成員權限**: 協作帳本依據成員權限顯示資料
- **時間範圍**: 限制可查詢的歷史資料範圍

### 12.2 資料隱私
- **敏感資訊**: 統計結果中不顯示具體交易詳情
- **資料脫敏**: 在必要時對金額進行模糊化處理
- **匯出控制**: 限制統計資料的匯出權限

### 12.3 系統安全
- **查詢限制**: 防範大量統計查詢攻擊
- **資源控制**: 限制統計計算的系統資源使用
- **快取安全**: 統計快取資料的安全存儲

---

## 13. 其他補充需求（Others）

### 13.1 效能需求
- **統計計算時間**: < 3秒
- **圖表渲染時間**: < 1秒
- **互動回應時間**: < 500ms
- **資料重新整理**: < 2秒

### 13.2 視覺化需求
- **圖表類型**: 支援折線圖、柱狀圖、圓餅圖、環狀圖
- **色彩設計**: 使用一致的色彩主題
- **動畫效果**: 平滑的資料變更動畫
- **響應式**: 適配不同螢幕尺寸

### 13.3 智能分析
- **趨勢預測**: 基於歷史資料預測未來趨勢
- **異常檢測**: 識別異常消費模式
- **個人化洞察**: 提供個人化的財務建議
- **比較分析**: 與平均水準或目標的比較

### 13.4 匯出功能
- **報表格式**: 支援PDF、Excel、PNG格式匯出
- **自訂報表**: 使用者可自訂匯出內容
- **定期報表**: 支援定期自動生成統計報表
- **分享功能**: 支援統計結果分享（去敏感化）

---

**文件狀態**: ✅ 已完成  
**下一階段**: P019_帳本切換頁面_SRS.md  
**相關文件**: P010_首頁儀表板_SRS.md、P030_預算總覽頁面_SRS.md
