# PRD_Flutter_AP_Layer

**文件編號**: 8001  
**版本**: v1.0.1  
**建立日期**: 2025-09-09  
**建立者**: LCAS PM Team  
**最後更新**: 2025-09-09  

---

## 目次
1. [模組概述](#10-模組概述module-overview)
2. [功能需求](#20-功能需求functional-requirements)
3. [架構設計](#30-架構設計architecture-design)
4. [模組群詳細規格](#40-模組群詳細規格module-groups-specification)
5. [RESTful API 介面](#50-restful-api-介面restful-api-interface)
6. [資料流設計](#60-資料流設計data-flow-design)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Flutter AP layer（應用邏輯層）是 LCAS 2.0 系統的中介層，位於 Presentation Layer 與 Business Layer 之間，負責提供標準化的 RESTful API 介面。作為 Flutter APP 與後端商業邏輯的橋樑，確保前後端分離架構的穩定性與擴展性。

### 1.2 核心價值主張
- **統一介面標準**：提供一致性的 RESTful API 規格
- **四模式支援**：支援 Expert、Inertial、Cultivation、Guiding 四種使用者模式
- **前後端分離**：清晰的職責分工與解耦設計
- **擴展性架構**：支援未來功能擴展與版本升級

### 1.3 目標使用者
- **Flutter APP 開發者**：透過標準化 API 呼叫後端服務
- **Business Layer**：接收 AP layer 請求並處理商業邏輯
- **系統整合人員**：負責 AP layer 與各層級的整合與維護

### 1.4 技術定位
AP layer 採用 RESTful 架構原則，基於 HTTP 協議提供標準化的 API 端點，支援：
- JSON 格式的資料交換
- 統一的錯誤處理機制
- JWT 認證與授權
- 四模式差異化回應

---

## 2.0 功能需求（Functional Requirements）

基於8020文件第7章所示的13個功能群組，AP layer提供完整的應用邏輯處理：

### 2.1 認證服務（Authentication Services）
- **使用者認證**：註冊、登入、登出、Google登入
- **密碼管理**：忘記密碼、重設密碼、Email驗證
- **跨平台綁定**：LINE綁定、綁定狀態查詢
- **Token管理**：JWT驗證、Token刷新機制

### 2.2 用戶管理（User Management）
- **個人資料管理**：個人資料CRUD、偏好設定
- **模式管理**：使用者模式評估、模式切換、模式優化建議
- **安全設定**：應用鎖、隱私模式、PIN碼驗證
- **行為追蹤**：使用行為記錄和分析

### 2.3 記帳交易（Transaction Management）
- **交易管理**：記帳資料的建立、修改、刪除、查詢
- **快速記帳**：支援LINE OA文字解析記帳
- **批次操作**：批次記帳、匯入交易、批次更新
- **附件管理**：交易附件上傳、刪除
- **重複交易**：定期記帳設定、重複交易CRUD

### 2.4 帳本管理（Ledger Management）
- **帳本CRUD**：個人帳本和群組帳本管理
- **帳本類型**：不同帳本類型管理和配置
- **協作管理**：協作者管理、邀請機制、權限控制
- **衝突處理**：協作衝突檢測與解決
- **審計日誌**：操作記錄和審計追蹤

### 2.5 帳戶管理（Account Management）
- **帳戶CRUD**：帳戶建立、更新、刪除
- **餘額管理**：帳戶餘額查詢、餘額統計
- **帳戶轉帳**：帳戶間轉帳功能
- **帳戶類型**：現金、銀行、信用卡等類型管理

### 2.6 科目管理（Category Management）
- **科目CRUD**：收支科目建立、修改、刪除
- **科目樹狀結構**：分層科目管理
- **科目統計**：科目使用統計和分析
- **智慧分類**：AI輔助科目分類

### 2.7 預算管理（Budget Management）
- **預算CRUD**：預算建立、更新、刪除
- **預算監控**：預算執行狀況、警示設定
- **預算模板**：預設預算模板管理
- **預算分析**：預算vs實際支出分析

### 2.8 報表分析（Report Analytics）
- **報表生成**：動態報表生成、報表模板管理
- **圖表分析**：數據視覺化、圖表配置
- **深度分析**：趨勢分析、洞察報告
- **報表管理**：報表下載、分享、排程
- **自定義分析**：用戶自定義分析需求

### 2.9 AI助理（AI Assistant）
- **智慧分類**：AI自動分類記帳資料
- **預算建議**：AI提供預算設定建議
- **異常檢測**：支出異常模式檢測
- **支出洞察**：AI分析支出模式提供洞察
- **個人化推薦**：基於用戶行為的個人化建議

### 2.10 激勵系統（Gamification System）
- **成就系統**：記帳成就、徽章管理
- **挑戰機制**：記帳挑戰、目標設定
- **積分管理**：用戶積分累積和兌換
- **排行榜**：用戶排名和競爭機制
- **進度追蹤**：習慣養成進度追蹤

### 2.11 系統服務（System Services）
- **系統配置**：APP資訊、系統配置管理
- **健康檢查**：系統狀態監控、健康檢查
- **維護狀態**：系統維護狀態管理
- **推廣管理**：APP推廣資訊管理
- **幫助功能**：幫助文章、客服聯繫

### 2.12 備份與資料管理（Backup & Data Management）
- **備份管理**：資料備份建立、還原、狀態監控
- **資料匯出入**：多格式資料匯出、匯入
- **備份排程**：自動備份排程管理
- **備份驗證**：備份完整性檢查

### 2.13 通知管理（Notification Management）
- **通知設定**：通知類型、時間設定、頻率管理
- **通知列表**：通知訊息列表、已讀狀態管理
- **記帳提醒**：記帳提醒建立、更新、刪除
- **提醒模板**：提醒模板管理
- **推播通知**：自動推播、財務統計推播

---

## 3.0 架構設計（Architecture Design）

### 3.1 整體架構
Flutter AP layer 採用13層服務架構設計，基於8025 API-BL mapping關係：

```
LCAS 2.0 Application Logic Layer Architecture
├── Flutter APP (Presentation Layer)
│   └── HTTP Requests (RESTful API Calls)
├── AP Layer (Application Logic Layer) - 13層服務架構
│   ├── 01. 認證服務層 (Authentication Services)
│   ├── 02. 用戶管理層 (User Management)
│   ├── 03. 記帳交易層 (Transaction Management)
│   ├── 04. 帳本管理層 (Ledger Management)
│   ├── 05. 帳戶管理層 (Account Management)
│   ├── 06. 科目管理層 (Category Management)
│   ├── 07. 預算管理層 (Budget Management)
│   ├── 08. 報表分析層 (Report Analytics)
│   ├── 09. AI助理層 (AI Assistant)
│   ├── 10. 激勵系統層 (Gamification System)
│   ├── 11. 系統服務層 (System Services)
│   ├── 12. 備份管理層 (Backup & Data Management)
│   └── 13. 通知管理層 (Notification Management)
├── Business Layer (Replit Backend)
│   └── 16個Business Logic模組
└── Data Layer (Firebase Firestore)
```

### 3.2 API架構原則
嚴格遵循8088 API設計規範：

#### 3.2.1 RESTful設計標準
- **統一URL格式**：`https://api.lcas.app/v1/{service}/{resource}/{id?}/{action?}`
- **HTTP方法標準**：GET（查詢）、POST（建立）、PUT（更新）、DELETE（刪除）
- **狀態碼規範**：2xx成功、4xx客戶端錯誤、5xx伺服器錯誤

#### 3.2.2 資料格式標準
- **請求格式**：application/json; charset=utf-8
- **回應格式**：統一的success/error結構
- **時間格式**：ISO 8601 UTC時間格式
- **ID命名**：一致性的ID欄位命名規範

#### 3.2.3 四模式支援機制
- **Header識別**：X-User-Mode: Expert|Inertial|Cultivation|Guiding
- **差異化回應**：根據模式調整資料深度與複雜度
- **功能過濾**：進階功能僅在適當模式提供

### 3.3 服務分層設計

#### 3.3.1 認證服務層（Authentication Services）
- **職責範圍**：用戶認證、授權、跨平台綁定、Token管理
- **對應BL模組**：AM.js（帳號管理模組）
- **API端點**：11個（/auth/*）

#### 3.3.2 用戶管理層（User Management Services）
- **職責範圍**：個人資料管理、模式評估、安全設定、行為追蹤
- **對應BL模組**：AM.js（帳號管理模組）
- **API端點**：11個（/users/*）

#### 3.3.3 記帳交易層（Transaction Services）
- **職責範圍**：記帳交易CRUD、重複交易、統計分析、附件管理
- **對應BL模組**：BK.js、LBK.js（記帳核心模組）
- **API端點**：20個（/transactions/*）

#### 3.3.4 帳本管理層（Ledger Management Services）
- **職責範圍**：帳本管理、協作功能、權限控制、審計日誌
- **對應BL模組**：MLS.js、CM.js（多帳本管理模組）
- **API端點**：14個（/ledgers/*）

#### 3.3.5 帳戶管理層（Account Management Services）
- **職責範圍**：帳戶CRUD、餘額管理、轉帳功能
- **對應BL模組**：BK.js（記帳核心模組）
- **API端點**：8個（/accounts/*）

#### 3.3.6 科目管理層（Category Management Services）
- **職責範圍**：科目CRUD、樹狀結構、自定義分類
- **對應BL模組**：DD1.js（核心協調模組）
- **API端點**：6個（/categories/*）

#### 3.3.7 預算管理層（Budget Management Services）
- **職責範圍**：預算CRUD、執行監控、警示設定、模板管理
- **對應BL模組**：BM.js（預算管理模組）
- **API端點**：8個（/budgets/*）

#### 3.3.8 報表分析層（Report Analytics Services）
- **職責範圍**：報表生成、圖表展示、深度分析、趨勢分析
- **對應BL模組**：MRA.js（報表分析模組）
- **API端點**：15個（/reports/*, /analytics/*）

#### 3.3.9 AI助理層（AI Assistant Services）
- **職責範圍**：智慧分類、預算建議、異常檢測、個人化推薦
- **對應BL模組**：DD2.js（智慧處理模組）
- **API端點**：6個（/ai/*）

#### 3.3.10 激勵系統層（Gamification Services）
- **職責範圍**：成就系統、挑戰機制、排行榜、獎勵管理
- **對應BL模組**：DD2.js（智慧處理模組）
- **API端點**：6個（/gamification/*）

#### 3.3.11 系統服務層（System Services）
- **職責範圍**：系統狀態、APP資訊、幫助支援、同步服務
- **對應BL模組**：DL.js、GR.js、DD3.js（診斷日誌、通用工具、資料服務模組）
- **API端點**：13個（/system/*, /help/*, /feedback/*）

#### 3.3.12 備份與資料管理層（Backup & Data Management Services）
- **職責範圍**：備份服務、資料匯出入、狀態監控
- **對應BL模組**：BS.js（備份服務模組）
- **API端點**：6個（/backup/*, /data/*）

#### 3.3.13 通知管理層（Notification Management Services）
- **職責範圍**：通知設定、提醒服務、通知列表管理
- **對應BL模組**：SR.js（排程提醒模組）
- **API端點**：8個（/notifications/*）

---

## 4.0 模組群詳細規格（Module Groups Specification）

基於8025 API-BL mapping關係，定義AP layer模組架構與Business layer的完整對應關係：

### 4.1 認證與用戶管理模組群

#### 4.1.1 認證服務模組
- **對應BL模組**: AM.js (帳號管理模組)
- **API端點數量**: 11個
- **功能職責**: 
  - 使用者註冊、登入、登出處理
  - Google OAuth整合
  - 密碼重設與Email驗證
  - LINE平台綁定功能
  - JWT Token管理與刷新
- **核心方法**:
  - `registerUser(email, password)` - 使用者註冊
  - `loginUser(credentials)` - 使用者登入
  - `googleLogin(token)` - Google登入
  - `bindLineAccount(lineId, userId)` - LINE綁定
  - `refreshToken(refreshToken)` - Token刷新

#### 4.1.2 用戶管理模組
- **對應BL模組**: AM.js (帳號管理模組)
- **API端點數量**: 11個
- **功能職責**:
  - 個人資料CRUD操作
  - 使用者模式評估與切換
  - 安全設定與PIN碼驗證
  - 使用行為追蹤與分析
  - 偏好設定管理
- **核心方法**:
  - `getUserProfile(userId)` - 取得個人資料
  - `updateUserProfile(userId, profileData)` - 更新個人資料
  - `assessUserMode(answers)` - 模式評估
  - `switchUserMode(userId, mode)` - 模式切換
  - `trackUserBehavior(userId, behaviorData)` - 行為追蹤

### 4.2 記帳核心模組群

#### 4.2.1 記帳交易模組
- **對應BL模組**: BK.js + LBK.js (記帳核心 + 快速記帳)
- **API端點數量**: 20個
- **功能職責**:
  - 交易記錄完整生命週期管理
  - LINE OA快速記帳支援
  - 批次操作與匯入功能
  - 交易附件管理
  - 重複交易規則設定
- **核心方法**:
  - `createTransaction(transactionData)` - 建立交易
  - `quickRecord(inputText, userId)` - 快速記帳
  - `batchCreateTransactions(transactions)` - 批次建立
  - `uploadAttachment(transactionId, file)` - 附件上傳
  - `createRecurringRule(ruleData)` - 建立重複規則

#### 4.2.2 帳戶管理模組
- **對應BL模組**: BK.js (記帳核心模組的帳戶功能)
- **API端點數量**: 8個
- **功能職責**:
  - 帳戶資訊CRUD操作
  - 帳戶餘額管理與查詢
  - 帳戶間轉帳功能
  - 帳戶類型管理
- **核心方法**:
  - `createAccount(accountData)` - 建立帳戶
  - `getAccountBalance(accountId)` - 查詢餘額
  - `transferBetweenAccounts(fromId, toId, amount)` - 轉帳
  - `getAccountTypes()` - 取得帳戶類型

### 4.3 管理功能模組群

#### 4.3.1 帳本管理模組
- **對應BL模組**: MLS.js + CM.js (多帳本管理 + 協作管理)
- **API端點數量**: 14個
- **功能職責**:
  - 多帳本架構管理
  - 協作帳本邀請與權限控制
  - 協作衝突檢測與解決
  - 帳本操作審計日誌
- **核心方法**:
  - `createLedger(ledgerData)` - 建立帳本
  - `inviteCollaborator(ledgerId, email, role)` - 邀請協作者
  - `detectConflicts(ledgerId)` - 檢測衝突
  - `resolveConflict(conflictId, resolution)` - 解決衝突
  - `getAuditLog(ledgerId)` - 取得審計日誌

#### 4.3.2 科目管理模組
- **對應BL模組**: DD1.js + DD2.js (核心協調 + 智慧處理)
- **API端點數量**: 6個
- **功能職責**:
  - 收支科目分類管理
  - 科目樹狀結構維護
  - AI智慧分類建議
  - 科目使用統計分析
- **核心方法**:
  - `createCategory(categoryData)` - 建立科目
  - `getCategoryTree()` - 取得樹狀結構
  - `aiCategorySuggestion(description)` - AI分類建議
  - `getCategoryStatistics(categoryId)` - 科目統計

#### 4.3.3 預算管理模組
- **對應BL模組**: BM.js (預算管理模組)
- **API端點數量**: 8個
- **功能職責**:
  - 預算設定與執行監控
  - 預算模板管理
  - 預算警示設定
  - 預算vs實際支出分析
- **核心方法**:
  - `createBudget(budgetData)` - 建立預算
  - `getBudgetStatus(budgetId)` - 查詢執行狀況
  - `setBudgetAlert(budgetId, alertConfig)` - 設定警示
  - `getBudgetTemplates()` - 取得模板

### 4.4 分析與智慧模組群

#### 4.4.1 報表分析模組
- **對應BL模組**: MRA.js + GR.js (報表分析 + 通用工具)
- **API端點數量**: 15個
- **功能職責**:
  - 動態報表生成與管理
  - 數據視覺化與圖表配置
  - 深度分析與趨勢洞察
  - 自定義分析需求支援
- **核心方法**:
  - `generateReport(reportConfig)` - 生成報表
  - `getReportCharts(reportId)` - 取得圖表
  - `getInsights(analysisConfig)` - 深度分析
  - `customAnalysis(customConfig)` - 自定義分析

#### 4.4.2 AI助理模組
- **對應BL模組**: DD2.js (智慧處理模組)
- **API端點數量**: 6個
- **功能職責**:
  - AI智慧分類與標籤處理
  - 預算建議與財務建議
  - 異常檢測與模式識別
  - 個人化推薦與洞察
- **核心方法**:
  - `aiCategorize(transactionData)` - AI分類
  - `getBudgetAdvice(userId, spendingData)` - 預算建議
  - `detectAnomaly(transactionHistory)` - 異常檢測
  - `getPersonalizedRecommendations(userId)` - 個人化推薦

#### 4.4.3 激勵系統模組
- **對應BL模組**: DD2.js (智慧處理模組的激勵功能)
- **API端點數量**: 6個
- **功能職責**:
  - 成就系統與徽章管理
  - 挑戰機制與目標設定
  - 積分系統與排行榜
  - 習慣養成進度追蹤
- **核心方法**:
  - `getAchievements(userId)` - 取得成就
  - `joinChallenge(userId, challengeId)` - 加入挑戰
  - `claimReward(userId, rewardId)` - 領取獎勵
  - `getLeaderboard(category)` - 排行榜

### 4.5 系統支援模組群

#### 4.5.1 系統服務模組
- **對應BL模組**: GR.js + DL.js (通用工具 + 診斷日誌)
- **API端點數量**: 13個
- **功能職責**:
  - 系統配置與維護狀態管理
  - 系統健康檢查與監控
  - 幫助文章與客服功能
  - APP推廣資訊管理
- **核心方法**:
  - `getSystemStatus()` - 系統狀態
  - `healthCheck()` - 健康檢查
  - `getAppInfo()` - APP資訊
  - `getHelpArticles()` - 幫助文章

#### 4.5.2 備份管理模組
- **對應BL模組**: BS.js (備份服務模組)
- **API端點數量**: 6個
- **功能職責**:
  - 資料備份建立與還原
  - 多格式資料匯出入
  - 備份排程與狀態監控
  - 備份完整性檢查
- **核心方法**:
  - `createBackup(userId, backupConfig)` - 建立備份
  - `restoreBackup(userId, backupId)` - 還原備份
  - `exportData(userId, format)` - 匯出資料
  - `getBackupStatus(backupId)` - 備份狀態

#### 4.5.3 通知管理模組
- **對應BL模組**: SR.js (排程提醒模組)
- **API端點數量**: 8個
- **功能職責**:
  - 通知設定與推播管理
  - 記帳提醒規則設定
  - 提醒模板管理
  - 通知列表與已讀狀態
- **核心方法**:
  - `getNotificationSettings(userId)` - 通知設定
  - `createReminder(userId, reminderData)` - 建立提醒
  - `markAsRead(userId, notificationId)` - 標記已讀
  - `getReminderTemplates()` - 提醒模板

### 4.6 模組間協調機制

#### 4.6.1 資料流協調
- **橫向協調**: 13個服務層間的資料共享與同步
- **縱向協調**: 與Business Layer的API調用與回應處理
- **快取機制**: 高頻資料的快取策略與失效管理

#### 4.6.2 錯誤處理協調
- **統一錯誤格式**: 所有模組使用相同的錯誤回應格式
- **錯誤傳播**: 錯誤在模組間的傳播與處理機制
- **降級策略**: 服務異常時的功能降級與恢復

#### 4.6.3 四模式支援協調
- **模式判斷**: 統一的使用者模式判斷與傳遞機制
- **回應調整**: 根據模式調整API回應的詳細程度
- **功能過濾**: 不同模式下功能可用性的統一控制

---

## 5.0 RESTful API 介面（RESTful API Interface）

### 5.1 API 設計原則
嚴格遵循8088 API設計規範的格式標準：

- **RESTful 標準**: 遵循 REST 架構原則和 HTTP 方法
- **統一URL格式**: 所有API端點使用 `https://api.lcas.app/v1/` 作為基礎URL
- **統一回應格式**: 標準化的成功和錯誤回應結構
- **版本控制**: 支援 API 版本管理和向下相容
- **安全認證**: Firebase Token 和 JWT 雙重認證機制
- **時間格式**: 統一使用 UTC+8 時區格式
- **四模式支援**: 根據使用者模式（Expert/Inertial/Cultivation/Guiding）提供差異化回應

### 5.2 API端點總覽（132個端點）

基於8020 API list的完整132個端點規格：

#### 5.2.1 認證服務 (11個端點)
```
POST /auth/register              - 使用者註冊
POST /auth/login                 - 使用者登入
POST /auth/google-login          - Google登入
POST /auth/logout                - 使用者登出
POST /auth/refresh               - 刷新token
POST /auth/forgot-password       - 忘記密碼
GET  /auth/verify-reset-token    - 驗證重設連結
POST /auth/reset-password        - 重設密碼
POST /auth/verify-email          - 驗證Email
POST /auth/bind-line             - LINE綁定
GET  /auth/bind-status           - 綁定狀態查詢
```

#### 5.2.2 用戶管理 (11個端點)
```
GET  /users/profile              - 取得個人資料
PUT  /users/profile              - 更新個人資料
GET  /users/assessment-questions - 取得評估問卷
POST /users/assessment           - 提交評估結果
PUT  /users/preferences          - 更新偏好設定
PUT  /users/security             - 安全設定
POST /users/verify-pin           - PIN碼驗證
PUT  /users/mode                 - 切換使用者模式
GET  /users/mode-defaults        - 取得模式預設值
POST /users/behavior-tracking    - 使用行為追蹤
GET  /users/mode-recommendations - 模式優化建議
```

#### 5.2.3 記帳交易 (20個端點)
```
GET    /transactions                    - 查詢交易列表
POST   /transactions                    - 新增交易
GET    /transactions/{id}               - 取得交易詳情
PUT    /transactions/{id}               - 更新交易
DELETE /transactions/{id}               - 刪除交易
POST   /transactions/batch              - 批次新增交易
PUT    /transactions/batch              - 批次更新交易
DELETE /transactions/batch              - 批次刪除交易
POST   /transactions/quick              - 快速記帳(LINE OA)
GET    /transactions/dashboard          - 儀表板數據
GET    /transactions/recent             - 最近交易
GET    /transactions/statistics         - 統計數據
GET    /transactions/charts             - 圖表數據
GET    /transactions/recurring          - 查詢重複交易
POST   /transactions/recurring          - 建立重複交易
PUT    /transactions/recurring/{id}     - 更新重複交易
DELETE /transactions/recurring/{id}     - 刪除重複交易
POST   /transactions/{id}/attachments   - 上傳附件
DELETE /transactions/{id}/attachments/{attachmentId} - 刪除附件
POST   /transactions/import             - 匯入交易
```

#### 5.2.4 帳本管理 (14個端點)
```
GET    /ledgers                           - 取得帳本列表
POST   /ledgers                           - 建立帳本
GET    /ledgers/{id}                      - 取得帳本詳情
PUT    /ledgers/{id}                      - 更新帳本
DELETE /ledgers/{id}                      - 刪除帳本
GET    /ledgers/types                     - 取得帳本類型
GET    /ledgers/{id}/collaborators        - 取得協作者
POST   /ledgers/{id}/invitations          - 邀請協作者
PUT    /ledgers/{id}/collaborators/{userId} - 更新協作者權限
DELETE /ledgers/{id}/collaborators/{userId} - 移除協作者
GET    /ledgers/{id}/permissions          - 取得權限狀態
GET    /ledgers/{id}/conflicts            - 檢測協作衝突
POST   /ledgers/{id}/resolve-conflict     - 解決協作衝突
GET    /ledgers/{id}/audit-log            - 取得操作審計日誌
```

#### 5.2.5 帳戶管理 (8個端點)
```
GET    /accounts           - 取得帳戶列表
POST   /accounts           - 建立帳戶
GET    /accounts/{id}      - 取得帳戶詳情
PUT    /accounts/{id}      - 更新帳戶
DELETE /accounts/{id}      - 刪除帳戶
GET    /accounts/{id}/balance - 取得帳戶餘額
GET    /accounts/types     - 取得帳戶類型
POST   /accounts/transfer  - 帳戶轉帳
```

#### 5.2.6 科目管理 (6個端點)
```
GET    /categories       - 取得科目列表
POST   /categories       - 建立科目
GET    /categories/{id}  - 取得科目詳情
PUT    /categories/{id}  - 更新科目
DELETE /categories/{id}  - 刪除科目
GET    /categories/tree  - 取得科目樹狀結構
```

#### 5.2.7 預算管理 (8個端點)
```
GET  /budgets           - 取得預算列表
POST /budgets           - 建立預算
GET  /budgets/{id}      - 取得預算詳情
PUT  /budgets/{id}      - 更新預算
DELETE /budgets/{id}    - 刪除預算
GET  /budgets/status    - 取得預算執行狀況
GET  /budgets/templates - 取得預算模板
POST /budgets/alert     - 預算警示設定
```

#### 5.2.8 報表分析 (15個端點)
```
GET    /reports                 - 取得報表列表
POST   /reports/generate        - 生成報表
GET    /reports/{id}            - 取得報表詳情
GET    /reports/{id}/status     - 查詢報表生成進度
DELETE /reports/{id}/cancel     - 取消報表生成
GET    /reports/{id}/charts     - 取得報表圖表
GET    /reports/{id}/export     - 匯出報表
POST   /reports/{id}/download   - 下載報表
POST   /reports/{id}/share      - 分享報表
GET    /reports/templates       - 取得報表模板
GET    /reports/config-options  - 取得報表配置選項
GET    /analytics/insights      - 深度分析洞察
GET    /analytics/trends        - 趨勢分析
POST   /analytics/custom        - 自定義分析
GET    /analytics/scheduled     - 定期報表排程
```

#### 5.2.9 AI助理 (6個端點)
```
POST /ai/categorize        - AI智慧分類
GET  /ai/suggestions       - AI建議
POST /ai/budget-advice     - AI預算建議
POST /ai/anomaly-detection - 異常檢測
POST /ai/spending-insights - AI支出洞察
GET  /ai/recommendations   - AI個人化推薦
```

#### 5.2.10 激勵系統 (6個端點)
```
GET  /gamification/achievements  - 取得成就
GET  /gamification/challenges    - 取得挑戰
POST /gamification/claim-reward  - 領取獎勵
GET  /gamification/leaderboard   - 排行榜
POST /gamification/join-challenge - 加入挑戰
GET  /gamification/progress      - 挑戰進度查詢
```

#### 5.2.11 系統服務 (13個端點)
```
GET  /system/app-info     - APP資訊
GET  /system/welcome      - 歡迎資訊
GET  /system/status       - 系統狀態
GET  /system/health       - 健康檢查
GET  /system/app-promotion - APP推廣資訊
GET  /system/config       - 系統配置
PUT  /system/config       - 更新系統配置
GET  /system/maintenance  - 維護狀態
POST /feedback/report     - 問題回報
GET  /help/articles       - 幫助文章
POST /help/contact        - 聯繫客服
POST /system/retry        - 重試機制
POST /system/sync         - 離線同步
```

#### 5.2.12 備份與資料管理 (6個端點)
```
POST /backup/create  - 建立備份
GET  /backup/list    - 備份列表
POST /backup/restore - 還原備份
GET  /backup/status  - 備份狀態
POST /data/export    - 匯出資料
POST /data/import    - 匯入資料
```

#### 5.2.13 通知管理 (8個端點)
```
GET    /notifications/settings         - 取得通知設定
PUT    /notifications/settings         - 更新通知設定
GET    /notifications/list             - 通知列表
PUT    /notifications/{id}/read        - 標記已讀
POST   /notifications/reminders       - 建立記帳提醒
PUT    /notifications/reminders/{id}  - 更新提醒規則
DELETE /notifications/reminders/{id}  - 刪除提醒
GET    /notifications/reminder-templates - 取得提醒模板
```

### 5.3 標準回應格式

#### 5.3.1 成功回應格式
```json
{
  "success": true,
  "data": {
    // 實際資料內容
  },
  "metadata": {
    "timestamp": "2025-09-09T12:00:00+08:00",
    "requestId": "uuid",
    "userMode": "Expert|Inertial|Cultivation|Guiding"
  }
}
```

#### 5.3.2 錯誤回應格式
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "詳細錯誤描述",
    "field": "相關欄位(如適用)",
    "timestamp": "2025-09-09T12:00:00+08:00",
    "requestId": "uuid"
  }
}
```

#### 5.3.3 四模式差異化回應
根據用戶模式（Expert/Inertial/Cultivation/Guiding）提供不同詳細程度的回應：
- **Expert模式**: 完整詳細資訊、進階選項
- **Inertial模式**: 標準資訊、固定選項
- **Cultivation模式**: 引導資訊、進度追蹤、激勵內容
- **Guiding模式**: 極簡資訊、最少選項

### 5.4 錯誤處理與回應格式

#### 5.4.1 HTTP狀態碼標準
- **2xx**: 成功狀態碼（200, 201, 204）
- **4xx**: 客戶端錯誤（400, 401, 403, 404, 422）
- **5xx**: 伺服器錯誤（500, 502, 503）

#### 5.4.2 詳細錯誤代碼分類
- **AUTH_xxxx**: 認證相關錯誤
- **VALIDATION_xxxx**: 資料驗證錯誤
- **BUSINESS_xxxx**: 業務邏輯錯誤
- **SYSTEM_xxxx**: 系統錯誤

---

## 6.0 資料流設計（Data Flow Design）

### 6.1 整體資料流架構

基於8019 User Flow的40個畫面核心流程，設計Flutter APP與RESTful API的完整資料流向：

```
Flutter APP (Presentation Layer)
    ↓ HTTP Requests (RESTful API Calls)
AP Layer (Application Logic Layer)
    ├── 認證驗證 (JWT Token Validation)
    ├── 請求解析 (Request Parsing & Validation)  
    ├── 模式判斷 (User Mode Detection)
    ├── 業務邏輯呼叫 (Business Logic Invocation)
    ↓ 標準化API呼叫
Business Layer (Replit Backend)
    ├── 16個Business Logic模組處理
    ├── 資料驗證與處理
    ├── Firestore資料操作
    ↓ 處理結果回傳
AP Layer (Application Logic Layer)
    ├── 回應格式化 (Response Formatting)
    ├── 四模式差異化調整 (Mode-based Response Adjustment)
    ├── 錯誤處理 (Error Handling)
    ↓ 標準化JSON回應
Flutter APP (Presentation Layer)
```

### 6.2 核心資料流程

#### 6.2.1 認證流程
```
1. Flutter APP → POST /auth/login → AP Layer
2. AP Layer → AM.js (帳號管理模組) → Business Layer
3. Business Layer → Firebase驗證 → JWT Token生成
4. Business Layer → AP Layer → 標準化回應格式
5. AP Layer → Flutter APP → 認證成功回應
```

#### 6.2.2 記帳交易流程（基於8019 User Flow）
```
1. Flutter APP → POST /transactions → AP Layer
2. AP Layer → 解析X-User-Mode Header → 模式判斷
3. AP Layer → BK.js (記帳核心模組) → Business Layer
4. Business Layer → 資料驗證 → Firestore寫入
5. Business Layer → 科目分類處理 → DD1.js
6. Business Layer → AI智慧建議 → DD2.js (如Expert/Cultivation模式)
7. Business Layer → AP Layer → 結果整合
8. AP Layer → 四模式差異化回應調整
9. AP Layer → Flutter APP → 記帳成功回應
```

#### 6.2.3 報表分析流程
```
1. Flutter APP → POST /reports/generate → AP Layer
2. AP Layer → MRA.js (報表分析模組) → Business Layer
3. Business Layer → 資料查詢 → Firestore
4. Business Layer → 報表計算與圖表生成
5. Business Layer → 根據用戶模式調整詳細度
6. Business Layer → AP Layer → 報表資料回傳
7. AP Layer → Flutter APP → 報表展示
```

### 6.3 四模式差異化資料流

#### 6.3.1 Expert模式 (專業模式)
- **資料深度**：完整詳細資訊、所有可用欄位
- **處理流程**：標準完整流程，包含進階功能
- **回應特色**：完整API回應、詳細錯誤資訊、進階分析數據

#### 6.3.2 Inertial模式 (慣性模式)  
- **資料深度**：標準資訊、固定常用欄位
- **處理流程**：簡化流程，降低選擇複雜度
- **回應特色**：標準API回應、簡化選項、常用功能優先

#### 6.3.3 Cultivation模式 (培養模式)
- **資料深度**：引導資訊、學習提示、進度追蹤
- **處理流程**：包含激勵系統處理、成就檢查
- **回應特色**：包含引導提示、學習建議、成就進度

#### 6.3.4 Guiding模式 (引導模式)
- **資料深度**：極簡資訊、最少必要欄位
- **處理流程**：最簡化流程、智慧預設
- **回應特色**：精簡回應、智慧建議、一鍵操作

### 6.4 模式判斷與回應調整機制

#### 6.4.1 模式識別流程
```
1. 解析HTTP Header: X-User-Mode
2. 查詢用戶設定檔: GET /users/profile 
3. 確定當前模式: Expert|Inertial|Cultivation|Guiding
4. 設定回應處理策略
```

#### 6.4.2 回應差異化處理
```javascript
// 模式差異化回應範例
function adjustResponseByMode(data, userMode) {
  switch(userMode) {
    case 'Expert':
      return {
        ...data,
        advancedOptions: true,
        detailedAnalytics: true,
        debugInfo: true
      };
    case 'Inertial': 
      return {
        ...data,
        standardOptions: true,
        commonFeatures: true
      };
    case 'Cultivation':
      return {
        ...data,
        guidanceHints: true,
        progressTracking: true,
        achievements: true
      };
    case 'Guiding':
      return {
        essentialData: data.essential,
        smartDefaults: true,
        oneClickActions: true
      };
  }
}
```

### 6.5 錯誤處理與復原機制

#### 6.5.1 錯誤分類處理
```
認證錯誤 (4xx):
- 401: Token過期 → 自動重新導向登入
- 403: 權限不足 → 降級功能或提示升級

驗證錯誤 (4xx):
- 400: 參數錯誤 → 詳細欄位錯誤提示
- 422: 業務邏輯錯誤 → 業務規則說明

系統錯誤 (5xx):
- 500: 伺服器錯誤 → 重試機制
- 503: 服務暫停 → 離線模式切換
```

#### 6.5.2 降級與復原策略
```
網路異常:
1. 啟用離線模式
2. 本地資料快取
3. 同步佇列機制

服務降級:
1. 核心功能優先
2. 進階功能暫停
3. 用戶友善提示

資料同步:
1. 衝突檢測
2. 合併策略
3. 用戶選擇權
```

### 6.6 效能優化與快取策略

#### 6.6.1 資料快取層級
```
AP Layer快取:
- 用戶模式設定
- 常用科目分類
- 帳本基本資訊

Business Layer快取:
- 計算結果快取
- 報表資料快取
- AI分析結果快取
```

#### 6.6.2 請求優化機制
```
批次處理:
- 交易批次新增/更新
- 報表資料批次查詢

預載機制:
- 首頁關鍵資料預載
- 常用功能資料預載

壓縮傳輸:
- JSON資料壓縮
- 圖片資源優化
```

### 6.7 安全性與資料保護

#### 6.7.1 資料傳輸安全
```
加密傳輸:
- HTTPS強制加密
- API Token加密存放
- 敏感資料遮罩

存取控制:
- JWT Token驗證
- API Rate Limiting
- 權限分級控制
```

#### 6.7.2 資料隱私保護
```
資料最小化:
- 四模式差異化資料
- 敏感資料過濾
- 日誌脫敏處理

用戶控制:
- 資料匯出權利
- 帳戶刪除權利
- 資料修正權利
```

---

## 文件合規性確認

### ✅ 參考文件遵守檢查

1. **8019 User Flow** ✅
   - 已基於40個畫面流程設計資料流
   - 支援四模式差異化體驗
   - 涵蓋核心使用流程

2. **8020 API list** ✅  
   - 嚴格按照132個端點規格
   - 13個功能群組完整對應
   - 禁止自創API端點

3. **8021 Screen list** ✅
   - 對應40個畫面功能需求
   - Epic分組功能整合
   - UI/UX差異化支援

4. **8025 API-BL mapping** ✅
   - 完整模組對應關係
   - Business Layer整合
   - 16個BL模組對應

5. **8088 API設計規範** ✅
   - RESTful標準格式
   - 統一回應格式
   - 錯誤處理規範

6. **0015 產品規格** ✅
   - LCAS 2.0架構遵循
   - 功能範圍限制
   - 技術規格符合

### 📋 文件完整性驗證

- **文件編號**: 8001 ✅
- **版本**: v1.0.0 ✅  
- **建立日期**: 2025-09-09 ✅
- **格式**: 嚴格遵循1001文件大綱 ✅
- **內容範圍**: 未超出任何參考文件規範 ✅

### 🎯 階段三完成交付物

1. **資料流設計章節** ✅ - 完整的Flutter APP與RESTful API資料流設計
2. **完整的8001. Flutter_AP layer.md文件** ✅ - 涵蓋6個主要章節的完整PRD文件  
3. **文件合規性檢查報告** ✅ - 確認所有參考文件規範遵守

**✨ 第三階段執行完成！8001. Flutter_AP layer.md PRD文件已完整撰寫完成，所有內容嚴格遵守參考文件規範，並支援LCAS 2.0系統的四模式差異化需求。**