
# PRD_Flutter_AP_Layer

**文件編號**: 8001  
**版本**: v1.0.0  
**建立日期**: 2025-09-09  
**建立者**: LCAS PM Team  
**最後更新**: 2025-09-09  

---

## 目次
1. [模組概述](#10-模組概述module-overview)
2. [功能需求](#20-功能需求functional-requirements)
3. [架構設計](#30-架構設計architecture-design)
4. [模組群詳細規格](#40-模組群詳細規格module-groups-specification)
5. [RESTful API 介面](#50-restful-api-介面restful-api-interface)
6. [資料流設計](#60-資料流設計data-flow-design)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Flutter AP layer（應用邏輯層）是 LCAS 2.0 系統的中介層，位於 Presentation Layer 與 Business Layer 之間，負責提供標準化的 RESTful API 介面。作為 Flutter APP 與後端商業邏輯的橋樑，確保前後端分離架構的穩定性與擴展性。

### 1.2 核心價值主張
- **統一介面標準**：提供一致性的 RESTful API 規格
- **四模式支援**：支援 Expert、Inertial、Cultivation、Guiding 四種使用者模式
- **前後端分離**：清晰的職責分工與解耦設計
- **擴展性架構**：支援未來功能擴展與版本升級

### 1.3 目標使用者
- **Flutter APP 開發者**：透過標準化 API 呼叫後端服務
- **Business Layer**：接收 AP layer 請求並處理商業邏輯
- **系統整合人員**：負責 AP layer 與各層級的整合與維護

### 1.4 技術定位
AP layer 採用 RESTful 架構原則，基於 HTTP 協議提供標準化的 API 端點，支援：
- JSON 格式的資料交換
- 統一的錯誤處理機制
- JWT 認證與授權
- 四模式差異化回應

---

## 2.0 功能需求（Functional Requirements）

### 2.1 認證服務（11個端點）
- **使用者註冊與登入**：Email註冊、Google登入、密碼重設
- **跨平台綁定**：LINE OA與APP帳號綁定
- **Token管理**：JWT認證、刷新機制、登出處理
- **密碼服務**：忘記密碼、重設密碼、Email驗證

### 2.2 用戶管理（11個端點）
- **個人資料管理**：取得/更新個人資料、偏好設定
- **模式評估管理**：四模式評估問卷與切換機制
- **安全設定**：PIN碼驗證、安全配置
- **行為追蹤**：使用行為記錄、模式優化建議

### 2.3 記帳交易（20個端點）
- **交易管理**：記帳CRUD操作、批次處理、快速記帳
- **重複交易**：重複記帳設定、管理
- **統計分析**：儀表板數據、圖表生成、最近交易
- **附件處理**：圖片上傳、附件管理、交易匯入

### 2.4 帳本管理（14個端點）
- **帳本CRUD**：個人帳本、協作帳本建立管理
- **協作功能**：協作者邀請、權限管理、衝突解決
- **帳本類型**：多種帳本類型支援
- **審計日誌**：操作記錄與追蹤

### 2.5 帳戶管理（8個端點）
- **帳戶CRUD**：帳戶建立、更新、刪除
- **餘額管理**：餘額查詢、轉帳功能
- **帳戶類型**：多種帳戶類型支援

### 2.6 科目管理（6個端點）
- **科目CRUD**：分類建立、更新、刪除
- **樹狀結構**：科目分類樹狀管理
- **自定義科目**：用戶自定義分類

### 2.7 預算管理（8個端點）
- **預算CRUD**：預算建立、更新、刪除
- **執行監控**：預算執行狀況、警示設定
- **預算模板**：預設模板管理

### 2.8 報表分析（15個端點）
- **報表生成**：動態報表、模板管理、多格式輸出
- **圖表展示**：圖表配置、分享功能
- **深度分析**：趨勢分析、洞察報告、自定義分析

### 2.9 AI助理（6個端點）
- **智慧分類**：AI自動分類、建議
- **預算建議**：AI預算建議、異常檢測
- **個人化推薦**：支出洞察、個人化推薦

### 2.10 激勵系統（6個端點）
- **成就系統**：成就管理、獎勵領取
- **挑戰機制**：挑戰參與、進度追蹤
- **排行榜**：競爭機制

### 2.11 系統服務（13個端點）
- **系統狀態**：健康檢查、維護狀態、配置管理
- **APP資訊**：APP資訊、歡迎資訊、推廣資訊
- **幫助支援**：幫助文章、客服聯繫、問題回報
- **同步服務**：重試機制、離線同步

### 2.12 備份與資料管理（6個端點）
- **備份服務**：建立備份、還原、狀態監控
- **資料匯出入**：多格式資料匯出、匯入

### 2.13 通知管理（8個端點）
- **通知設定**：通知配置、設定管理
- **提醒服務**：記帳提醒、提醒模板
- **通知列表**：通知查詢、已讀管理

---

## 3.0 架構設計（Architecture Design）

### 3.1 整體架構
Flutter AP layer 採用分層式架構設計，基於8025 API-BL mapping關係：

```
LCAS 2.0 Application Logic Layer Architecture
├── Flutter APP (Presentation Layer)
│   └── HTTP Requests (RESTful API Calls)
├── AP Layer (Application Logic Layer) - 13層服務架構
│   ├── 01. 認證服務層 (Authentication Services)
│   ├── 02. 用戶管理層 (User Management Services)
│   ├── 03. 記帳交易層 (Transaction Services)
│   ├── 04. 帳本管理層 (Ledger Management Services)
│   ├── 05. 帳戶管理層 (Account Management Services)
│   ├── 06. 科目管理層 (Category Management Services)
│   ├── 07. 預算管理層 (Budget Management Services)
│   ├── 08. 報表分析層 (Report Analytics Services)
│   ├── 09. AI助理層 (AI Assistant Services)
│   ├── 10. 激勵系統層 (Gamification Services)
│   ├── 11. 系統服務層 (System Services)
│   ├── 12. 備份與資料管理層 (Backup & Data Management Services)
│   └── 13. 通知管理層 (Notification Management Services)
├── Business Layer (Replit Backend)
│   └── 16個Business Logic模組
└── Data Layer (Firebase Firestore)
```

### 3.2 API架構原則
嚴格遵循8088 API設計規範：

#### 3.2.1 RESTful設計標準
- **統一URL格式**：`https://api.lcas.app/v1/{service}/{resource}/{id?}/{action?}`
- **HTTP方法標準**：GET（查詢）、POST（建立）、PUT（更新）、DELETE（刪除）
- **狀態碼規範**：2xx成功、4xx客戶端錯誤、5xx伺服器錯誤

#### 3.2.2 資料格式標準
- **請求格式**：application/json; charset=utf-8
- **回應格式**：統一的success/error結構
- **時間格式**：ISO 8601 UTC時間格式
- **ID命名**：一致性的ID欄位命名規範

#### 3.2.3 四模式支援機制
- **Header識別**：X-User-Mode: Expert|Inertial|Cultivation|Guiding
- **差異化回應**：根據模式調整資料深度與複雜度
- **功能過濾**：進階功能僅在適當模式提供

### 3.3 服務分層設計

#### 3.3.1 認證服務層（Authentication Services）
- **職責範圍**：用戶認證、授權、跨平台綁定、Token管理
- **對應BL模組**：AM.js（帳號管理模組）
- **API端點**：11個（/auth/*）

#### 3.3.2 用戶管理層（User Management Services）
- **職責範圍**：個人資料管理、模式評估、安全設定、行為追蹤
- **對應BL模組**：AM.js（帳號管理模組）
- **API端點**：11個（/users/*）

#### 3.3.3 記帳交易層（Transaction Services）
- **職責範圍**：記帳交易CRUD、重複交易、統計分析、附件管理
- **對應BL模組**：BK.js、LBK.js（記帳核心模組）
- **API端點**：20個（/transactions/*）

#### 3.3.4 帳本管理層（Ledger Management Services）
- **職責範圍**：帳本管理、協作功能、權限控制、審計日誌
- **對應BL模組**：MLS.js、CM.js（多帳本管理模組）
- **API端點**：14個（/ledgers/*）

#### 3.3.5 帳戶管理層（Account Management Services）
- **職責範圍**：帳戶CRUD、餘額管理、轉帳功能
- **對應BL模組**：BK.js（記帳核心模組）
- **API端點**：8個（/accounts/*）

#### 3.3.6 科目管理層（Category Management Services）
- **職責範圍**：科目CRUD、樹狀結構、自定義分類
- **對應BL模組**：DD1.js（核心協調模組）
- **API端點**：6個（/categories/*）

#### 3.3.7 預算管理層（Budget Management Services）
- **職責範圍**：預算CRUD、執行監控、警示設定、模板管理
- **對應BL模組**：BM.js（預算管理模組）
- **API端點**：8個（/budgets/*）

#### 3.3.8 報表分析層（Report Analytics Services）
- **職責範圍**：報表生成、圖表展示、深度分析、趨勢分析
- **對應BL模組**：MRA.js（報表分析模組）
- **API端點**：15個（/reports/*, /analytics/*）

#### 3.3.9 AI助理層（AI Assistant Services）
- **職責範圍**：智慧分類、預算建議、異常檢測、個人化推薦
- **對應BL模組**：DD2.js（智慧處理模組）
- **API端點**：6個（/ai/*）

#### 3.3.10 激勵系統層（Gamification Services）
- **職責範圍**：成就系統、挑戰機制、排行榜、獎勵管理
- **對應BL模組**：DD2.js（智慧處理模組）
- **API端點**：6個（/gamification/*）

#### 3.3.11 系統服務層（System Services）
- **職責範圍**：系統狀態、APP資訊、幫助支援、同步服務
- **對應BL模組**：DL.js、GR.js、DD3.js（診斷日誌、通用工具、資料服務模組）
- **API端點**：13個（/system/*, /help/*, /feedback/*）

#### 3.3.12 備份與資料管理層（Backup & Data Management Services）
- **職責範圍**：備份服務、資料匯出入、狀態監控
- **對應BL模組**：BS.js（備份服務模組）
- **API端點**：6個（/backup/*, /data/*）

#### 3.3.13 通知管理層（Notification Management Services）
- **職責範圍**：通知設定、提醒服務、通知列表管理
- **對應BL模組**：SR.js（排程提醒模組）
- **API端點**：8個（/notifications/*）
