# PRD_APL

**文件編號**: 8001  
**版本**: v1.2.0  
**建立日期**: 2025-09-09  
**建立者**: LCAS PM Team  
**最後更新**: 2025-10-23  

---

## 目次
1. [模組概述](#10-模組概述module-overview)
2. [功能需求](#20-功能需求functional-requirements)
3. [架構設計](#30-架構設計architecture-design)
4. [API轉發規格](#40-api轉發規格api-forwarding-specification)
5. [RESTful API 介面](#50-restful-api-介面restful-api-interface)
6. [資料流設計](#60-資料流設計data-flow-design)

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
Flutter APL（Application Presentation Layer）是 LCAS 2.0 系統的純API Gateway轉發窗口，專門負責Flutter APP與ASL層之間的API請求轉發。作為標準化的API轉發中介層，確保前後端分離架構的一致性與穩定性。

### 1.2 核心價值主張
- **純轉發機制**：專職API請求轉發，不包含業務邏輯處理
- **統一介面標準**：提供一致性的RESTful API轉發規格
- **四模式支援**：支援Expert、Inertial、Cultivation、Guiding四種使用者模式的差異化轉發
- **架構統一性**：與ASL層採用相同的Gateway設計模式

### 1.3 目標使用者
- **Flutter APP開發者**：透過統一的API Gateway呼叫後端服務
- **PL層模組**：透過APL層轉發API請求至ASL層
- **系統整合人員**：負責APL層與各層級的整合與維護

### 1.4 技術定位
APL層採用純API Gateway架構原則，基於HTTP協議提供標準化的API轉發端點：
- 目標服務器：ASL.js (Port 5000)
- 轉發協定：HTTP/HTTPS
- 資料格式：JSON
- 認證機制：JWT Token透傳
- 回應格式：DCN-0015統一格式解析

---

## 2.0 功能需求（Functional Requirements）

基於當前APL層轉型為純API Gateway的職責重新定義，移除所有業務邏輯處理需求：

### 2.1 API轉發服務（API Forwarding Services）
- **HTTP請求轉發**：GET、POST、PUT、DELETE方法轉發
- **請求參數透傳**：完整轉發請求參數至ASL層
- **認證Token透傳**：JWT Token安全透傳機制
- **回應格式解析**：解析ASL層回應並轉換為統一格式

### 2.2 統一回應格式處理（Unified Response Processing）
- **DCN-0015格式解析**：解析success/data/error統一格式
- **錯誤處理機制**：統一錯誤代碼轉換與處理
- **四模式差異化**：根據userMode調整回應內容深度
- **Metadata處理**：時間戳、請求ID、處理時間等元數據管理

### 2.3 連線管理（Connection Management）
- **HTTP客戶端管理**：維護與ASL層的HTTP連線
- **超時處理機制**：請求超時檢測與重試邏輯
- **錯誤重試機制**：網路異常自動重試策略
- **連線池管理**：優化HTTP連線資源使用

### 2.4 安全性轉發（Security Forwarding）
- **Token驗證透傳**：JWT Token完整性檢查與轉發
- **HTTPS加密轉發**：確保資料傳輸安全性
- **請求驗證**：基礎請求格式驗證
- **存取日誌記錄**：API轉發日誌追蹤

---

## 3.0 架構設計（Architecture Design）

### 3.1 整體架構
Flutter APL層採用純API Gateway轉發架構，基於統一轉發窗口設計：

```
LCAS 2.0 Application Presentation Layer Gateway Architecture
├── Flutter APP (Presentation Layer)
│   └── HTTP Requests → APL Gateway
├── APL Layer (Pure API Gateway) - 統一轉發窗口
│   ├── HTTP請求接收與驗證
│   ├── 目標路由映射與轉發
│   ├── ASL層API調用
│   ├── 統一回應格式解析
│   └── 四模式差異化處理
├── ASL Layer (API Service Layer)
│   └── Port 5000 RESTful API服務
└── Business Layer → Data Layer
```

### 3.2 轉發架構原則
嚴格遵循純Gateway設計模式：

#### 3.2.1 單一職責原則
- **專職轉發**：僅負責API請求轉發，不處理業務邏輯
- **無狀態設計**：不維護業務狀態，僅處理轉發狀態
- **透明轉發**：完整轉發請求內容，不修改業務資料

#### 3.2.2 統一轉發標準
- **目標服務器**：統一轉發至ASL.js (http://0.0.0.0:5000)
- **路由映射**：API端點路由映射表管理
- **參數透傳**：請求參數完整透傳
- **回應轉換**：ASL回應格式統一轉換

#### 3.2.3 四模式支援機制
- **模式識別**：從Header或查詢參數識別使用者模式
- **模式透傳**：將模式資訊透傳至ASL層
- **差異化處理**：根據ASL回應進行模式特定處理

### 3.3 轉發服務設計

#### 3.3.1 認證服務轉發（Authentication Forwarding）
- **轉發目標**：ASL.js認證相關API
- **主要端點**：11個認證API端點轉發
- **特殊處理**：JWT Token生成與驗證結果轉發

#### 3.3.2 用戶管理轉發（User Management Forwarding）
- **轉發目標**：ASL.js用戶管理API
- **主要端點**：11個用戶管理API端點轉發
- **特殊處理**：用戶偏好設定與模式切換轉發

#### 3.3.3 記帳交易轉發（Transaction Forwarding）
- **轉發目標**：ASL.js記帳核心API
- **主要端點**：20個記帳交易API端點轉發
- **特殊處理**：快速記帳與統計資料轉發

#### 3.3.4 帳本管理轉發（Ledger Management Forwarding）
- **轉發目標**：ASL.js帳本管理API
- **主要端點**：14個帳本管理API端點轉發
- **特殊處理**：協作權限與衝突處理轉發

#### 3.3.5 其他服務轉發（Other Services Forwarding）
- **帳戶管理**：8個端點轉發
- **預算管理**：8個端點轉發
- **系統服務**：系統狀態與健康檢查轉發

---

## 4.0 API轉發規格（API Forwarding Specification）

### 4.1 轉發機制設計

#### 4.1.1 統一轉發方法實作
```dart
Future<UnifiedApiResponse<T>> forwardRequest<T>(
  String method,           // HTTP方法：GET, POST, PUT, DELETE
  String endpoint,         // API端點路徑
  Map<String, dynamic>? body,      // 請求體（POST/PUT使用）
  Map<String, String>? queryParams, // 查詢參數（GET使用）
  T Function(dynamic) dataParser,   // 資料解析器
  {String? pathParam}      // 路徑參數（用於{id}替換）
)
```

#### 4.1.2 P2階段API端點實作狀態
- ✅ **帳本管理服務 (8104)**：14個端點完整實作
- ✅ **帳戶管理服務 (8105)**：8個端點完整實作  
- ✅ **預算管理服務 (8107)**：8個端點完整實作
- **總計**：30個P2 API端點轉發功能已完成

#### 4.1.2 目標服務器配置
- **基礎URL**：`http://0.0.0.0:5000`
- **超時設定**：30秒
- **重試機制**：網路錯誤時最多重試3次
- **錯誤處理**：統一錯誤代碼轉換

#### 4.1.3 路由映射表
```dart
final Map<String, String> apiRouteMapping = {
  // 認證服務轉發路由
  'auth.register': '/api/v1/auth/register',
  'auth.login': '/api/v1/auth/login',
  'auth.logout': '/api/v1/auth/logout',

  // 記帳交易轉發路由  
  'transactions.create': '/api/v1/transactions',
  'transactions.list': '/api/v1/transactions',
  'transactions.detail': '/api/v1/transactions/{id}',

  // 帳本管理轉發路由
  'ledgers.list': '/api/v1/ledgers',
  'ledgers.create': '/api/v1/ledgers',
  'ledgers.detail': '/api/v1/ledgers/{id}',

  // 其他服務轉發路由
  // ...總計132個API端點路由映射
};
```

### 4.2 統一回應格式處理

#### 4.2.1 DCN-0015格式解析
```dart
class UnifiedApiResponse<T> {
  final bool success;      // 成功/失敗標識
  final T? data;           // 業務資料（成功時）
  final String message;    // 回應訊息
  final Map<String, dynamic>? metadata; // 元數據
  final ApiError? error;   // 錯誤資訊（失敗時）

  // 從ASL回應解析為統一格式
  factory UnifiedApiResponse.fromJson(
    Map<String, dynamic> json, 
    T Function(dynamic) dataParser
  ) {
    return UnifiedApiResponse<T>(
      success: json['success'] ?? false,
      data: json['data'] != null ? dataParser(json['data']) : null,
      message: json['message'] ?? '',
      metadata: json['metadata'],
      error: json['error'] != null ? ApiError.fromJson(json['error']) : null,
    );
  }
}
```

#### 4.2.2 錯誤處理標準
```dart
class ApiError {
  final String code;       // 錯誤代碼
  final String message;    // 錯誤訊息
  final Map<String, dynamic>? details; // 錯誤詳情

  // 網路層錯誤處理
  static UnifiedApiResponse<T> handleNetworkError<T>(Exception e) {
    if (e is SocketException) {
      return UnifiedApiResponse<T>(
        success: false,
        message: '網路連線錯誤',
        error: ApiError(code: 'NETWORK_ERROR', message: '無法連接到服務器'),
      );
    }
    // 其他錯誤類型處理...
  }
}
```

---

## 5.0 RESTful API 介面（RESTful API Interface）

### 5.1 API轉發標準
嚴格遵循RESTful設計原則進行轉發：

- **轉發原則**：完整轉發請求至ASL層，不修改API語義
- **URL格式**：維持ASL層的URL格式標準
- **HTTP方法**：完整支援GET、POST、PUT、DELETE轉發
- **參數處理**：查詢參數、請求體、路徑參數完整透傳

### 5.2 轉發端點總覽（132個端點轉發）

基於8020 API list的完整132個端點轉發規格：

#### 5.2.1 認證服務轉發 (11個端點)
```dart
// 轉發至 ASL.js 認證服務API
AuthenticationService get auth => AuthenticationService(this);

Future<UnifiedApiResponse<Map<String, dynamic>>> register(Map<String, dynamic> userData)
Future<UnifiedApiResponse<Map<String, dynamic>>> login(Map<String, dynamic> credentials)  
Future<UnifiedApiResponse<Map<String, dynamic>>> logout()
// ...其他8個認證API轉發方法
```

#### 5.2.2 用戶管理轉發 (11個端點)
```dart
// 轉發至 ASL.js 用戶管理API
UserManagementService get user => UserManagementService(this);

Future<UnifiedApiResponse<Map<String, dynamic>>> getProfile()
Future<UnifiedApiResponse<Map<String, dynamic>>> updateProfile(Map<String, dynamic> profileData)
Future<UnifiedApiResponse<List<Map<String, dynamic>>>> getAssessmentQuestions()
// ...其他8個用戶管理API轉發方法
```

#### 5.2.3 記帳交易轉發 (20個端點)
```dart
// 轉發至 ASL.js 記帳交易API
TransactionService get transaction => TransactionService(this);

Future<UnifiedApiResponse<Map<String, dynamic>>> createTransaction(Map<String, dynamic> transactionData)
Future<UnifiedApiResponse<Map<String, dynamic>>> quickRecord(String input)
Future<UnifiedApiResponse<List<Map<String, dynamic>>>> getTransactions({Map<String, String>? queryParams})
// ...其他17個記帳交易API轉發方法
```

#### 5.2.4 帳本管理轉發 (14個端點)
```dart
// 轉發至 ASL.js 帳本管理API
LedgerService get ledger => LedgerService(this);

Future<UnifiedApiResponse<List<Map<String, dynamic>>>> getLedgers({Map<String, String>? queryParams})
Future<UnifiedApiResponse<Map<String, dynamic>>> createLedger(Map<String, dynamic> ledgerData)
Future<UnifiedApiResponse<List<Map<String, dynamic>>>> getCollaborators(String ledgerId)
// ...其他11個帳本管理API轉發方法
```

### 5.3 四模式差異化轉發

#### 5.3.1 模式識別與透傳
```dart
// 模式識別邏輯
String detectUserMode(Map<String, String>? headers, Map<String, String>? queryParams) {
  // 1. 從Header識別：X-User-Mode
  if (headers?['X-User-Mode'] != null) {
    return normalizeMode(headers!['X-User-Mode']!);
  }

  // 2. 從查詢參數識別：userMode
  if (queryParams?['userMode'] != null) {
    return normalizeMode(queryParams!['userMode']!);
  }

  // 3. 預設模式
  return 'Expert';
}

// 模式正規化
String normalizeMode(String mode) {
  switch (mode.toLowerCase()) {
    case 'expert': return 'Expert';
    case 'inertial': return 'Inertial';
    case 'cultivation': return 'Cultivation';
    case 'guiding': return 'Guiding';
    default: return 'Expert';
  }
}
```

#### 5.3.2 差異化轉發處理
- **Expert模式**：完整轉發所有API參數，解析完整回應資料
- **Inertial模式**：標準轉發處理，解析基礎回應資料
- **Cultivation模式**：轉發時加入progress tracking參數，解析激勵相關資料
- **Guiding模式**：簡化參數轉發，解析簡化回應資料

---

## 6.0 資料流設計（Data Flow Design）

### 6.1 整體轉發資料流架構

基於純API Gateway轉發的資料流設計：

```
Flutter APP (Presentation Layer)
    ↓ API請求 (Dart HTTP請求)
APL Gateway (Pure API Forwarding)
    ├── 請求接收與基礎驗證
    ├── 路由映射與參數轉換
    ├── 使用者模式識別與透傳
    ├── HTTP請求轉發至ASL層
    ↓ 標準化HTTP轉發
ASL Layer (API Service Layer - Port 5000)
    ├── API端點處理
    ├── BL層函數調用
    ├── 統一回應格式生成
    ↓ DCN-0015標準回應
APL Gateway (Response Processing)
    ├── ASL回應接收
    ├── DCN-0015格式解析
    ├── 四模式差異化處理
    ├── 錯誤處理與轉換
    ↓ 統一格式回應
Flutter APP (Presentation Layer)
```

### 6.2 核心轉發流程

#### 6.2.1 請求轉發流程
```
1. Flutter APP → HTTP請求 → APL Gateway
2. APL Gateway → 請求驗證 → 路由映射
3. APL Gateway → 模式識別 → 參數透傳
4. APL Gateway → HTTP轉發 → ASL.js (Port 5000)
5. ASL.js → 業務處理 → DCN-0015標準回應
6. APL Gateway → 回應解析 → 四模式處理
7. APL Gateway → 統一回應 → Flutter APP
```

#### 6.2.2 記帳轉發流程範例
```
1. Flutter APP → createTransaction請求 → APL Gateway
2. APL Gateway → 解析transactionData → 模式透傳
3. APL Gateway → POST /api/v1/transactions → ASL.js
4. ASL.js → BK_createTransaction → 業務邏輯處理
5. ASL.js → 統一回應格式 → 成功/失敗結果
6. APL Gateway → 解析success/data/error → 四模式調整
7. APL Gateway → UnifiedApiResponse → Flutter APP
```

### 6.3 四模式差異化轉發處理

#### 6.3.1 模式轉發策略
- **Expert模式轉發**：
  - 完整參數轉發，包含進階選項
  - 解析完整回應資料，包含詳細analytics
  - 錯誤處理包含技術細節

- **Inertial模式轉發**：
  - 標準參數轉發，使用預設選項
  - 解析基礎回應資料，穩定介面
  - 錯誤處理簡化用戶友善

- **Cultivation模式轉發**：
  - 加入進度追蹤參數轉發
  - 解析激勵相關資料，包含achievements
  - 錯誤處理包含鼓勵訊息

- **Guiding模式轉發**：
  - 簡化參數轉發，智慧預設值
  - 解析極簡回應資料，最少必要資訊
  - 錯誤處理包含指導建議

### 6.4 錯誤處理與復原機制

#### 6.4.1 網路層錯誤處理
```dart
try {
  final response = await _httpClient.post(uri, headers: headers, body: body)
      .timeout(Duration(seconds: 30));

  // 解析ASL回應
  final responseData = jsonDecode(response.body);
  return UnifiedApiResponse.fromJson(responseData, dataParser);

} on SocketException catch (e) {
  return UnifiedApiResponse<T>(
    success: false,
    message: '網路連線錯誤',
    error: ApiError(code: 'NETWORK_ERROR', message: '無法連接到ASL服務器'),
  );
} on TimeoutException catch (e) {
  return UnifiedApiResponse<T>(
    success: false,
    message: '請求超時',
    error: ApiError(code: 'TIMEOUT_ERROR', message: '服務器回應超時'),
  );
} catch (e) {
  return UnifiedApiResponse<T>(
    success: false,
    message: '轉發錯誤',
    error: ApiError(code: 'FORWARDING_ERROR', message: e.toString()),
  );
}
```

#### 6.4.2 ASL層錯誤轉發
```dart
// ASL層回應錯誤直接轉發，不修改錯誤語義
if (!responseData['success']) {
  return UnifiedApiResponse<T>(
    success: false,
    message: responseData['message'] ?? '操作失敗',
    error: responseData['error'] != null 
        ? ApiError.fromJson(responseData['error'])
        : null,
    metadata: responseData['metadata'],
  );
}
```

### 6.5 效能最佳化機制

#### 6.5.1 HTTP連線最佳化
- **連線重用**：維持與ASL層的HTTP連線池
- **請求壓縮**：支援GZIP壓縮傳輸
- **並發控制**：合理控制並發請求數量
- **超時管理**：適當的超時設定與重試機制

#### 6.5.2 回應處理最佳化
- **JSON解析最佳化**：高效的JSON序列化/反序列化
- **記憶體管理**：避免大型回應資料的記憶體洩漏
- **快取策略**：適當的本地快取機制（如四模式設定）

### 6.6 安全性考量

#### 6.6.1 轉發安全
- **Token透傳安全**：JWT Token完整性檢查後安全轉發
- **HTTPS支援**：支援HTTPS加密轉發
- **參數驗證**：基礎參數格式驗證，防止惡意請求
- **存取日誌**：完整的API轉發日誌記錄

#### 6.6.2 資料保護
- **敏感資料處理**：不在APL層儲存敏感業務資料
- **錯誤資訊過濾**：避免在錯誤回應中洩露系統內部資訊
- **請求限制**：基礎的請求頻率限制機制

---

## 附錄A：轉發端點對照表

### A.1 認證服務轉發對照
| APL Gateway方法 | ASL端點 | 轉發說明 |
|----------------|---------|----------|
| auth.register() | POST /api/v1/auth/register | 用戶註冊轉發 |
| auth.login() | POST /api/v1/auth/login | 用戶登入轉發 |
| auth.logout() | POST /api/v1/auth/logout | 用戶登出轉發 |

### A.2 記帳交易轉發對照  
| APL Gateway方法 | ASL端點 | 轉發說明 |
|----------------|---------|----------|
| transaction.create() | POST /api/v1/transactions | 新增交易轉發 |
| transaction.quickRecord() | POST /api/v1/transactions/quick | 快速記帳轉發 |
| transaction.getList() | GET /api/v1/transactions | 查詢交易列表轉發 |

**總計**：132個API端點完整轉發支援

---

## 附錄B：版本升級記錄

| 版本 | 日期 | 修改內容 | 修改者 |
|------|------|----------|--------|
| v1.1.0 | 2025-10-23 | 階段一：重新定位APL層為純API Gateway轉發窗口 | LCAS PM Team |
| v1.0.1 | 2025-09-09 | 初版建立，完整APL層業務邏輯規範 | LCAS PM Team |

---

**文件狀態**：✅ 階段二完成 - APL Gateway統一模組實作完成  
**下階段目標**：階段三 - 整合驗證與P3-P7基礎建立  
**相關文件**：
- [DCN-0010 PL與APL層邏輯重構.md](../07.%20DCN/DCN-0010%20PL與APL層邏輯重構.md)
- [DCN-0017 重構APL層.md](../07.%20DCN/DCN-0017%20重構APL層.md)
- [8020. API list.md](./8020.%20API%20list.md) - API端點轉發清單