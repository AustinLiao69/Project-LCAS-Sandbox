
# 0088. API設計規範

**版本**: 1.0.0  
**建立日期**: 2025-01-27  
**最後更新**: 2025-01-27  
**建立者**: SA  
**來源文件**: 0020. API list.md

---

## 目次 (Table of Contents)

### 1. [總體設計原則](#1-總體設計原則)
### 2. [URL設計規範](#2-url設計規範)
### 3. [HTTP方法使用規範](#3-http方法使用規範)
### 4. [請求格式規範](#4-請求格式規範)
### 5. [回應格式規範](#5-回應格式規範)
### 6. [錯誤處理規範](#6-錯誤處理規範)
### 7. [分頁設計規範](#7-分頁設計規範)
### 8. [ID命名規範](#8-id命名規範)
### 9. [日期時間格式規範](#9-日期時間格式規範)
### 10. [四模式支援規範](#10-四模式支援規範)
### 11. [安全性規範](#11-安全性規範)
### 12. [版本控制規範](#12-版本控制規範)
### 13. [文件撰寫規範](#13-文件撰寫規範)

---

## 1. 總體設計原則

### 1.1 RESTful架構原則
- **資源導向**：每個URL代表一個資源
- **無狀態**：每個請求包含完整的處理資訊
- **統一介面**：使用標準HTTP方法
- **分層系統**：明確的分層架構設計

### 1.2 設計哲學
- **一致性優先**：所有API遵循統一標準
- **開發者友善**：直觀易懂的設計
- **擴展性考量**：支援未來功能擴展
- **效能導向**：最佳化回應時間與資料量

### 1.3 相容性原則
- **向後相容**：新版本不破壞現有功能
- **漸進式升級**：支援版本間平滑遷移
- **明確廢棄**：提前通知API廢棄計畫

---

## 2. URL設計規範

### 2.1 URL結構標準
```
https://api.lcas.app/v1/{service}/{resource}/{id?}/{action?}
```

**組成元素說明**：
- `service`: 服務模組名稱（auth, transactions, ledgers等）
- `resource`: 資源名稱（複數形式）
- `id`: 資源唯一識別符（可選）
- `action`: 特殊操作（可選）

### 2.2 命名慣例

#### ✅ 正確範例
```
GET  /auth/profile
POST /transactions
GET  /transactions/{id}
PUT  /transactions/{id}
DELETE /transactions/{id}
GET  /ledgers/{id}/collaborators
POST /transactions/quick
GET  /reports/{id}/export
```

#### ❌ 錯誤範例
```
GET  /getUser                    # 動詞不應出現在URL
POST /transaction               # 資源應使用複數
GET  /Transaction/{id}          # 首字母不應大寫
PUT  /ledgers/{id}/updateName   # 不需要動詞前綴
```

### 2.3 特殊操作命名
- **批次操作**：`/batch`
- **搜尋操作**：`/search`
- **統計操作**：`/statistics`
- **匯出操作**：`/export`
- **快速操作**：`/quick`

---

## 3. HTTP方法使用規範

### 3.1 標準方法對應

| HTTP方法 | 用途 | 範例 | 冪等性 |
|----------|------|------|--------|
| GET | 查詢資源 | `GET /transactions` | ✅ |
| POST | 建立資源 | `POST /transactions` | ❌ |
| PUT | 完整更新 | `PUT /transactions/{id}` | ✅ |
| PATCH | 部分更新 | `PATCH /transactions/{id}` | ❌ |
| DELETE | 刪除資源 | `DELETE /transactions/{id}` | ✅ |

### 3.2 特殊操作方法選擇
- **複雜查詢**：`POST /transactions/search`
- **批次操作**：`POST /transactions/batch`
- **資源轉換**：`POST /reports/generate`
- **狀態切換**：`PATCH /transactions/{id}/status`

---

## 4. 請求格式規範

### 4.1 Content-Type標準
```http
Content-Type: application/json; charset=utf-8
```

### 4.2 請求標頭規範
```http
Authorization: Bearer {jwt-token}
X-User-Mode: Expert|Inertial|Cultivation|Guiding
X-Request-ID: {uuid}
Accept: application/json
```

### 4.3 請求體格式
```json
{
  "data": {
    "amount": 1500,
    "type": "expense",
    "categoryId": "uuid",
    "description": "晚餐聚會"
  },
  "metadata": {
    "source": "app",
    "version": "1.0.0"
  }
}
```

### 4.4 查詢參數規範
```
GET /transactions?page=1&limit=20&sort=date:desc&filter=type:expense
```

**參數命名規則**：
- 使用camelCase
- 布林值：`true`/`false`
- 日期範圍：`startDate`/`endDate`
- 排序：`sort={field}:{asc|desc}`

---

## 5. 回應格式規範

### 5.1 成功回應標準格式
```json
{
  "success": true,
  "data": {
    // 實際資料內容
  },
  "metadata": {
    "timestamp": "2025-01-27T12:00:00Z",
    "requestId": "uuid",
    "userMode": "Expert"
  }
}
```

### 5.2 列表回應格式（含分頁）
```json
{
  "success": true,
  "data": {
    "items": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 156,
      "totalPages": 8,
      "hasNext": true,
      "hasPrev": false
    }
  },
  "metadata": {
    "timestamp": "2025-01-27T12:00:00Z",
    "requestId": "uuid"
  }
}
```

### 5.3 HTTP狀態碼標準

| 狀態碼 | 說明 | 使用場景 |
|--------|------|----------|
| 200 | OK | 成功查詢/更新 |
| 201 | Created | 成功建立資源 |
| 204 | No Content | 成功刪除 |
| 400 | Bad Request | 請求參數錯誤 |
| 401 | Unauthorized | 未授權 |
| 403 | Forbidden | 權限不足 |
| 404 | Not Found | 資源不存在 |
| 409 | Conflict | 資源衝突 |
| 422 | Unprocessable Entity | 業務邏輯錯誤 |
| 500 | Internal Server Error | 系統錯誤 |

---

## 6. 錯誤處理規範

### 6.1 錯誤回應標準格式
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "金額必須大於 0",
    "field": "amount",
    "timestamp": "2025-01-27T12:00:00Z",
    "requestId": "uuid",
    "details": {
      "validation": [
        {
          "field": "amount",
          "message": "金額必須大於 0",
          "value": -100
        }
      ]
    }
  }
}
```

### 6.2 錯誤碼分類

#### 客戶端錯誤（4xx）
```
VALIDATION_ERROR          # 參數驗證失敗
UNAUTHORIZED             # 未授權存取
INSUFFICIENT_PERMISSIONS # 權限不足
RESOURCE_NOT_FOUND       # 資源不存在
DUPLICATE_RESOURCE       # 資源已存在
RATE_LIMIT_EXCEEDED      # 請求頻率超限
```

#### 業務邏輯錯誤（422）
```
BUSINESS_LOGIC_ERROR     # 一般業務邏輯錯誤
INSUFFICIENT_BALANCE     # 餘額不足
BUDGET_EXCEEDED          # 超出預算
INVALID_OPERATION        # 無效操作
CONFLICT_DETECTED        # 協作衝突
```

#### 伺服器錯誤（5xx）
```
INTERNAL_SERVER_ERROR    # 內部伺服器錯誤
SERVICE_UNAVAILABLE      # 服務暫時不可用
TIMEOUT_ERROR            # 請求超時
DATABASE_ERROR           # 資料庫錯誤
EXTERNAL_SERVICE_ERROR   # 外部服務錯誤
```

---

## 7. 分頁設計規範

### 7.1 分頁參數標準
```
GET /transactions?page=1&limit=20&sort=date:desc
```

**參數說明**：
- `page`: 頁碼（從1開始）
- `limit`: 每頁筆數（預設20，最大100）
- `sort`: 排序欄位與方向

### 7.2 分頁回應格式
```json
{
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 156,
    "totalPages": 8,
    "hasNext": true,
    "hasPrev": false,
    "nextPage": 2,
    "prevPage": null
  }
}
```

### 7.3 分頁連結標頭
```http
Link: <https://api.lcas.app/v1/transactions?page=2&limit=20>; rel="next",
      <https://api.lcas.app/v1/transactions?page=8&limit=20>; rel="last"
```

---

## 8. ID命名規範

### 8.1 ID欄位命名標準

| 資源類型 | ID欄位名稱 | 範例 |
|----------|------------|------|
| 使用者 | `userId` | `"userId": "uuid"` |
| 交易記錄 | `transactionId` | `"transactionId": "uuid"` |
| 帳本 | `ledgerId` | `"ledgerId": "uuid"` |
| 帳戶 | `accountId` | `"accountId": "uuid"` |
| 科目 | `categoryId` | `"categoryId": "uuid"` |
| 預算 | `budgetId` | `"budgetId": "uuid"` |
| 報表 | `reportId` | `"reportId": "uuid"` |

### 8.2 複合ID命名
```json
{
  "collaborationId": "uuid",          // 協作關係ID
  "invitationId": "uuid",            // 邀請ID
  "attachmentId": "uuid",            // 附件ID
  "recurringRuleId": "uuid"          // 重複規則ID
}
```

### 8.3 關聯ID命名
- **父資源ID**: 使用完整名稱（如`ledgerId`）
- **外鍵關聯**: 明確標示關聯（如`parentCategoryId`）
- **多對多關聯**: 使用描述性名稱（如`collaboratorUserId`）

---

## 9. 日期時間格式規範

### 9.1 統一時間格式：ISO 8601
```json
{
  "createdAt": "2025-01-27T12:00:00Z",
  "updatedAt": "2025-01-27T12:30:00Z",
  "date": "2025-01-27T00:00:00Z",
  "expiresAt": "2025-01-28T00:00:00Z"
}
```

### 9.2 時區處理
- **儲存格式**：UTC時間（Z後綴）
- **顯示格式**：根據用戶時區轉換
- **輸入格式**：接受多種格式，統一轉換為UTC

### 9.3 日期欄位命名
```json
{
  "createdAt": "建立時間",
  "updatedAt": "更新時間", 
  "deletedAt": "刪除時間",
  "startDate": "開始日期",
  "endDate": "結束日期",
  "dueDate": "到期日期",
  "reminderDate": "提醒日期"
}
```

---

## 10. 四模式支援規範

### 10.1 模式判斷機制
```http
X-User-Mode: Expert|Inertial|Cultivation|Guiding
```

### 10.2 各模式回應特性

#### Expert Mode（專家模式）
```json
{
  "data": {
    // 完整詳細資料
    "advancedOptions": [...],
    "detailedAnalytics": {...},
    "customizationSettings": {...}
  }
}
```

#### Inertial Mode（慣性模式）
```json
{
  "data": {
    // 標準資料
    "standardOptions": [...],
    "basicAnalytics": {...}
  }
}
```

#### Cultivation Mode（培育模式）
```json
{
  "data": {
    // 引導式資料
    "guidedOptions": [...],
    "progressTracking": {...},
    "achievements": {...},
    "motivationalContent": "..."
  }
}
```

#### Guiding Mode（引導模式）
```json
{
  "data": {
    // 極簡資料
    "simpleMessage": "...",
    "basicActions": [...]
  }
}
```

### 10.3 模式適配策略
- **資料深度調整**：根據模式提供不同詳細程度
- **功能選項過濾**：進階功能僅在Expert模式顯示
- **UI提示差異化**：不同模式提供對應的用戶指導

---

## 11. 安全性規範

### 11.1 認證機制
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 11.2 資料驗證
```javascript
// 輸入驗證範例
{
  "amount": {
    "type": "number",
    "minimum": 0.01,
    "maximum": 999999.99,
    "required": true
  },
  "description": {
    "type": "string",
    "maxLength": 255,
    "sanitize": true
  }
}
```

### 11.3 敏感資料處理
- **遮罩顯示**：帳戶號碼、信用卡號等
- **加密儲存**：個人識別資訊
- **存取日誌**：記錄敏感資料存取

### 11.4 CORS設定
```http
Access-Control-Allow-Origin: https://app.lcas.app
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type, X-User-Mode
```

---

## 12. 版本控制規範

### 12.1 版本號規則
```
/v{major}.{minor}
例：/v1.0, /v1.1, /v2.0
```

### 12.2 相容性策略
- **主版本升級**：可包含breaking changes
- **次版本升級**：向後相容的新功能
- **修訂版本**：bug修復和小幅改善

### 12.3 廢棄流程
```http
Deprecation: version="v1.0", date="2025-06-01", link="https://docs.lcas.app/migration"
```

---

## 13. 文件撰寫規範

### 13.1 API文件結構
```markdown
## API名稱
**描述**: 簡短描述API功能
**對應畫面**: S-XXX

### 請求格式
### 回應格式  
### 錯誤處理
### 範例
```

### 13.2 範例要求
- **完整範例**：包含請求和回應
- **多種情境**：成功、失敗、邊界情況
- **四模式差異**：展示不同模式的回應差異

### 13.3 變更記錄
```markdown
| 版本 | 日期 | 變更內容 | 影響範圍 |
|------|------|----------|----------|
| 1.1.0 | 2025-01-27 | 新增分頁支援 | 所有列表API |
```

---

## 附錄A：檢查清單

### API設計檢查清單
- [ ] URL符合RESTful規範
- [ ] HTTP方法使用正確
- [ ] 回應格式統一
- [ ] 錯誤處理完整
- [ ] 分頁設計合理
- [ ] ID命名一致
- [ ] 日期格式統一
- [ ] 四模式支援
- [ ] 安全性考量
- [ ] 文件完整

### 發布前檢查清單
- [ ] API測試通過
- [ ] 文件同步更新
- [ ] 版本號正確
- [ ] 相容性確認
- [ ] 效能測試完成

---

## 附錄B：常見問題

### Q1: 何時使用POST而非GET？
A: 當請求參數複雜、包含敏感資訊、或會產生副作用時使用POST。

### Q2: 如何處理大量資料的分頁？
A: 使用cursor-based分頁，提供更穩定的分頁體驗。

### Q3: 四模式如何影響API效能？
A: 通過資料過濾和快取策略，確保不同模式都有最佳效能表現。

---

**文件版本**: 1.0.0  
**最後更新**: 2025-01-27  
**維護者**: LCAS SA Team
