
# 7106. 帳戶與科目管理功能群_SRS.md

**文件編號**: 7106  
**版本**: v1.0.0  
**建立日期**: 2025-11-17  
**建立者**: LCAS PM Team  
**最後更新**: 2025-11-17  

---

## 📑 目次 (Table of Contents)

1. [模組概述 (Module Overview)](#10-模組概述module-overview)

2. [功能需求 (Functional Requirements)](#20-功能需求functional-requirements)
   - 2.1 帳戶資料管理邏輯
   - 2.2 科目階層管理邏輯
   - 2.3 帳戶餘額計算邏輯
   - 2.4 科目使用統計邏輯
   - 2.5 四模式差異化業務邏輯處理
   - 2.6 本地資料快取與同步邏輯

3. [輸入/輸出規格 (Input & Output Specifications)](#30-輸入輸出規格input--output-specifications)
   - 3.1 輸入規格引用
   - 3.2 輸出規格引用
   - 3.3 PL層特殊處理需求

4. [錯誤處理與例外狀況 (Error Handling & Edge Cases)](#40-錯誤處理與例外狀況error-handling--edge-cases)
   - 4.1 帳戶管理相關錯誤
   - 4.2 科目管理相關錯誤
   - 4.3 網路連線錯誤
   - 4.4 業務邏輯層特殊處理

---

## 1.0 模組概述（Module Overview）

### 1.1 模組定位與職責

**帳戶與科目管理功能群**是LCAS 2.0專案Presentation Layer的關鍵業務邏輯模組群，負責處理帳戶與科目管理的完整業務邏輯流程。本功能群對應0090 Sprint計畫的**Phase 3**範圍，專注於PL層的**功能群業務邏輯**，而非UI頁面群。

**核心職責範圍**：
- 🏦 **帳戶管理邏輯**：API調用、資料驗證、狀態管理
- 📂 **科目管理邏輯**：階層結構處理、樹狀同步
- 💰 **餘額計算邏輯**：即時計算、快取更新
- 📊 **使用統計邏輯**：頻率分析、智慧推薦
- 🎯 **四模式適配**：差異化業務邏輯處理
- 💾 **資料同步**：本地快取與API同步機制

### 1.2 功能群範圍定義

本功能群專注於**業務邏輯層**，不涉及UI畫面群，對應7302記帳核心功能群的架構模式：

| 職責層級 | 功能範圍 | 對應模組 | 備註 |
|----------|----------|----------|------|
| **業務邏輯處理** | API調用、狀態管理、資料轉換 | 7106 | 本模組核心 |
| **API服務對接** | 8105帳戶管理、8106科目管理服務 | APL層 | 介面依賴 |
| **BL層整合** | 1350. WCM.js模組 | BL層 | 後端服務 |
| **UI頁面群** | S-304、S-305、S-306頁面 | 頁面群模組 | 非本模組範圍 |

### 1.3 四模式差異化策略

基於0015文件的四模式理論，本功能群實現以下**業務邏輯層**差異化策略：

#### 1.3.1 Expert模式（專家模式）業務邏輯
- **資料處理**：完整API參數、詳細驗證邏輯、進階篩選條件
- **快取策略**：全量資料快取、複雜查詢緩存、即時同步
- **狀態管理**：多維度狀態追蹤、操作歷史記錄

#### 1.3.2 Inertial模式（慣性模式）業務邏輯  
- **資料處理**：標準化API調用、基本驗證邏輯、固定篩選
- **快取策略**：標準快取機制、定期同步
- **狀態管理**：穩定狀態維護、一致性優先

#### 1.3.3 Cultivation模式（養成模式）業務邏輯
- **資料處理**：引導式資料準備、智慧推薦邏輯、行為分析
- **快取策略**：習慣資料優先、使用頻率分析
- **狀態管理**：成長追蹤狀態、進度計算

#### 1.3.4 Guiding模式（引導模式）業務邏輯
- **資料處理**：極簡資料處理、自動預設值、最少選項
- **快取策略**：預設資料快取、簡化同步
- **狀態管理**：簡化狀態結構、自動化處理

### 1.4 技術架構整合

#### 1.4.1 與1350. WCM.js模組整合關係

本功能群作為PL層業務邏輯，與BL層1350. WCM.js模組建立清晰的介面定義：

```
7106功能群 (PL業務邏輯層)
    ↓ API調用
APL層 (8105、8106 API服務)
    ↓ 轉發
ASL層 (API服務轉發)
    ↓ 呼叫
1350. WCM.js (BL層模組)
    ↓ 存取
Firebase (DL層)
```

**核心整合點**：
- **帳戶管理**：7106調用8105 API → WCM_createWallet、WCM_getWalletList等函數
- **科目管理**：7106調用8106 API → WCM_createCategory、WCM_getCategoryList等函數
- **餘額查詢**：7106調用8105 API → WCM_getWalletBalance函數
- **資料驗證**：7106調用API → WCM_validateWalletExists、WCM_validateCategoryExists函數

#### 1.4.2 API服務對應規範

基於8020文件API規格，本功能群**嚴格對應**以下API服務：

| 業務邏輯功能 | 對應API服務 | 主要端點 | WCM.js函數 |
|-------------|------------|----------|------------|
| 帳戶資料管理 | 8105帳戶管理服務 | `/accounts` | WCM_createWallet, WCM_getWalletList |
| 科目階層管理 | 8106科目管理服務 | `/categories` | WCM_createCategory, WCM_getCategoryList |
| 帳戶餘額計算 | 8105帳戶管理服務 | `/accounts/{id}/balance` | WCM_getWalletBalance |
| 帳戶驗證邏輯 | 8105帳戶管理服務 | `/accounts/{id}` | WCM_validateWalletExists |
| 科目驗證邏輯 | 8106科目管理服務 | `/categories/{id}` | WCM_validateCategoryExists |

#### 1.4.3 狀態管理架構

```dart
// 帳戶與科目管理狀態結構
AccountCategoryStateManager/
├── AccountState           // 帳戶資料狀態
│   ├── accountList        // 帳戶列表
│   ├── selectedAccount    // 選中帳戶
│   ├── accountBalance     // 餘額快取
│   └── loadingState       // 載入狀態
├── CategoryState          // 科目資料狀態
│   ├── categoryTree       // 科目樹狀結構
│   ├── selectedCategory   // 選中科目
│   ├── frequentCategories // 常用科目快取
│   └── syncState          // 同步狀態
├── CacheState            // 快取管理狀態
│   ├── cacheTimestamp     // 快取時間戳
│   ├── syncStatus         // 同步狀態
│   └── offlineData        // 離線資料
└── ModeState             // 四模式狀態
    ├── currentMode        // 當前模式
    ├── modeConfig         // 模式配置
    └── adaptiveData       // 適配資料
```

### 1.5 品質與安全要求

#### 1.5.1 業務邏輯效能要求
- **API響應處理**：≤ 500ms（API調用處理）、≤ 200ms（本地狀態更新）
- **快取機制**：≤ 100ms（快取讀取）、≤ 300ms（快取更新）
- **四模式切換**：≤ 200ms（模式適配邏輯）

#### 1.5.2 資料一致性要求  
- **狀態同步**：API回應與本地狀態即時同步
- **快取一致性**：定期校驗本地快取與遠端資料一致性
- **模式適配**：確保四模式間資料結構一致

#### 1.5.3 錯誤處理機制
- **API異常處理**：網路中斷、服務異常的優雅降級
- **資料驗證**：前端業務邏輯驗證，防止無效資料傳送
- **重試機制**：失敗操作的自動重試與手動重試選項

### 1.6 與其他功能群的協作

#### 1.6.1 功能群介面依賴
- **← 系統進入功能群**：接收認證狀態、用戶模式配置
- **→ 記帳核心功能群**：提供帳戶與科目選擇邏輯、驗證服務
- **→ 帳本協作功能群**：帳本權限驗證、協作狀態管理
- **→ 預算管理功能群**：帳戶科目關聯、預算執行邏輯

#### 1.6.2 業務邏輯資料流
```
API請求準備 → 四模式適配 → API調用 → 回應處理 → 狀態更新 → 快取同步
    ↓                                                              ↑
錯誤處理 ←  資料驗證  ←  業務邏輯處理  ←  模式差異化  ←  本地快取
```

---

