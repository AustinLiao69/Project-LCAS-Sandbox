# 7106. 帳戶與科目管理功能群_SRS.md

**文件編號**: 7106  
**版本**: v1.0.0  
**建立日期**: 2025-11-17  
**建立者**: LCAS PM Team  
**最後更新**: 2025-11-17  

---

## 📑 目次 (Table of Contents)

1. [模組概述 (Module Overview)](#10-模組概述module-overview)

2. [功能需求 (Functional Requirements)](#20-功能需求functional-requirements)
   - 2.1 帳戶資料管理邏輯
   - 2.2 科目階層管理邏輯
   - 2.3 帳戶餘額計算邏輯
   - 2.4 科目使用統計邏輯
   - 2.5 四模式差異化業務邏輯處理
   - 2.6 本地資料快取與同步邏輯

3. [輸入/輸出規格 (Input & Output Specifications)](#30-輸入輸出規格input--output-specifications)
   - 3.1 輸入規格引用
   - 3.2 輸出規格引用
   - 3.3 PL層特殊處理需求

4. [錯誤處理與例外狀況 (Error Handling & Edge Cases)](#40-錯誤處理與例外狀況error-handling--edge-cases)
   - 4.1 帳戶管理相關錯誤
   - 4.2 科目管理相關錯誤
   - 4.3 網路連線錯誤
   - 4.4 業務邏輯層特殊處理

---

## 1.0 模組概述（Module Overview）

### 1.1 模組定位與職責

**帳戶與科目管理功能群**是LCAS 2.0專案Presentation Layer的關鍵業務邏輯模組群，負責處理帳戶與科目管理的完整業務邏輯流程。本功能群對應0090 Sprint計畫的**Phase 3**範圍，專注於PL層的**功能群業務邏輯**，而非UI頁面群。

**核心職責範圍**：
- 🏦 **帳戶管理邏輯**：API調用、資料驗證、狀態管理
- 📂 **科目管理邏輯**：階層結構處理、樹狀同步
- 💰 **餘額計算邏輯**：即時計算、快取更新
- 📊 **使用統計邏輯**：頻率分析、智慧推薦
- 🎯 **四模式適配**：差異化業務邏輯處理
- 💾 **資料同步**：本地快取與API同步機制

### 1.2 功能群範圍定義

本功能群專注於**業務邏輯層**，不涉及UI畫面群，對應7302記帳核心功能群的架構模式：

| 職責層級 | 功能範圍 | 對應模組 | 備註 |
|----------|----------|----------|------|
| **業務邏輯處理** | API調用、狀態管理、資料轉換 | 7106 | 本模組核心 |
| **API服務對接** | 8105帳戶管理、8106科目管理服務 | APL層 | 介面依賴 |
| **BL層整合** | 1350. WCM.js模組 | BL層 | 後端服務 |
| **UI頁面群** | S-304、S-305、S-306頁面 | 頁面群模組 | 非本模組範圍 |

### 1.3 四模式差異化策略

基於0015文件的四模式理論，本功能群實現以下**業務邏輯層**差異化策略：

#### 1.3.1 Expert模式（專家模式）業務邏輯
- **資料處理**：完整API參數、詳細驗證邏輯、進階篩選條件
- **快取策略**：全量資料快取、複雜查詢緩存、即時同步
- **狀態管理**：多維度狀態追蹤、操作歷史記錄

#### 1.3.2 Inertial模式（慣性模式）業務邏輯  
- **資料處理**：標準化API調用、基本驗證邏輯、固定篩選
- **快取策略**：標準快取機制、定期同步
- **狀態管理**：穩定狀態維護、一致性優先

#### 1.3.3 Cultivation模式（養成模式）業務邏輯
- **資料處理**：引導式資料準備、智慧推薦邏輯、行為分析
- **快取策略**：習慣資料優先、使用頻率分析
- **狀態管理**：成長追蹤狀態、進度計算

#### 1.3.4 Guiding模式（引導模式）業務邏輯
- **資料處理**：極簡資料處理、自動預設值、最少選項
- **快取策略**：預設資料快取、簡化同步
- **狀態管理**：簡化狀態結構、自動化處理

### 1.4 技術架構整合

#### 1.4.1 與APL.dart Gateway及WCM.js模組整合關係

本功能群作為PL層業務邏輯，透過APL.dart統一Gateway與BL層1350. WCM.js模組建立清晰的整合架構：

```
7106功能群 (PL業務邏輯層)
    ↓ 統一API調用
APL.dart Gateway (統一API轉發窗口)
    ↓ RESTful轉發
ASL.js (API服務層)
    ↓ 業務邏輯調用
1350. WCM.js (BL層模組)
    ↓ 資料存取
Firebase (DL層)
```

**核心整合點**：
- **帳戶管理**：7106 → APL.account → ASL.js → WCM_createWallet、WCM_getWalletList等函數
- **科目管理**：7106 → APL.category（P3） → ASL.js → WCM_createCategory、WCM_getCategoryList等函數
- **餘額查詢**：7106 → APL.account → ASL.js → WCM_getWalletBalance函數
- **資料驗證**：7106 → APL統一Gateway → ASL.js → WCM_validateWalletExists、WCM_validateCategoryExists函數

**架構優勢**：
- **統一管理**：透過APL.dart單一窗口管理所有API請求
- **標準化**：遵循RESTful API標準，提供一致的介面規範
- **可擴展性**：APL Gateway為P3-P7階段預留擴展基礎

#### 1.4.2 API服務對應規範

基於8020文件API規格與APL.dart統一Gateway架構，本功能群**嚴格對應**以下API服務：

| 業務邏輯功能 | APL.dart Gateway服務 | API端點路徑 | WCM.js函數 |
|-------------|---------------------|------------|------------|
| 帳戶資料管理 | APL.account服務 | `/api/v1/accounts` | WCM_createWallet, WCM_getWalletList |
| 科目階層管理 | APL.category服務（P3預留） | `/api/v1/categories` | WCM_createCategory, WCM_getCategoryList |
| 帳戶餘額計算 | APL.account服務 | `/api/v1/accounts/{id}/balance` | WCM_getWalletBalance |
| 帳戶驗證邏輯 | APL.account服務 | `/api/v1/accounts/{id}` | WCM_validateWalletExists |
| 科目驗證邏輯 | APL.category服務（P3預留） | `/api/v1/categories/{id}` | WCM_validateCategoryExists |

**APL Gateway整合說明**：
- **統一入口**：所有API請求透過APL.dart統一Gateway處理
- **服務分組**：APL.account、APL.category等服務類別封裝相關API
- **標準化路徑**：遵循`/api/v1/*`標準RESTful路徑規範
- **P3階段預留**：科目管理服務將在Phase 3階段完整實現

#### 1.4.3 狀態管理架構

```dart
// 帳戶與科目管理狀態結構
AccountCategoryStateManager/
├── AccountState           // 帳戶資料狀態
│   ├── accountList        // 帳戶列表
│   ├── selectedAccount    // 選中帳戶
│   ├── accountBalance     // 餘額快取
│   └── loadingState       // 載入狀態
├── CategoryState          // 科目資料狀態
│   ├── categoryTree       // 科目樹狀結構
│   ├── selectedCategory   // 選中科目
│   ├── frequentCategories // 常用科目快取
│   └── syncState          // 同步狀態
├── CacheState            // 快取管理狀態
│   ├── cacheTimestamp     // 快取時間戳
│   ├── syncStatus         // 同步狀態
│   └── offlineData        // 離線資料
└── ModeState             // 四模式狀態
    ├── currentMode        // 當前模式
    ├── modeConfig         // 模式配置
    └── adaptiveData       // 適配資料
```

### 1.5 品質與安全要求

#### 1.5.1 業務邏輯效能要求
- **API響應處理**：≤ 500ms（API調用處理）、≤ 200ms（本地狀態更新）
- **快取機制**：≤ 100ms（快取讀取）、≤ 300ms（快取更新）
- **四模式切換**：≤ 200ms（模式適配邏輯）

#### 1.5.2 資料一致性要求  
- **狀態同步**：API回應與本地狀態即時同步
- **快取一致性**：定期校驗本地快取與遠端資料一致性
- **模式適配**：確保四模式間資料結構一致

#### 1.5.3 錯誤處理機制
- **API異常處理**：網路中斷、服務異常的優雅降級
- **資料驗證**：前端業務邏輯驗證，防止無效資料傳送
- **重試機制**：失敗操作的自動重試與手動重試選項

### 1.6 與其他功能群的協作

#### 1.6.1 功能群介面依賴
- **← 系統進入功能群**：接收認證狀態、用戶模式配置
- **→ 記帳核心功能群**：提供帳戶與科目選擇邏輯、驗證服務
- **→ 帳本協作功能群**：帳本權限驗證、協作狀態管理
- **→ 預算管理功能群**：帳戶科目關聯、預算執行邏輯

#### 1.6.2 業務邏輯資料流
```
API請求準備 → 四模式適配 → API調用 → 回應處理 → 狀態更新 → 快取同步
    ↓                                                              ↑
錯誤處理 ←  資料驗證  ←  業務邏輯處理  ←  模式差異化  ←  本地快取
```

---

## 2.0 功能需求（Functional Requirements）

### 2.1 帳戶資料管理邏輯

#### 2.1.1 帳戶資料創建邏輯
**業務邏輯職責**：處理帳戶創建的完整業務流程，包含API調用、資料驗證與狀態管理。

**核心處理流程**：
```
用戶輸入 → 前端驗證 → 格式化處理 → APL.account調用 → BL層處理 → 回應解析 → 狀態更新 → UI反饋
```

**具體功能需求**：
- **FR-2.1.1-01**：接收使用者輸入的帳戶基本資訊（名稱、類型、初始餘額、幣別、描述）
- **FR-2.1.1-02**：執行前端業務邏輯驗證：
  - 帳戶名稱：1-50字元，不可重複
  - 帳戶類型：從預定義清單選擇（現金、銀行卡、信用卡、電子錢包）
  - 初始餘額：數值格式驗證，允許負值（信用卡）
  - 幣別：支援多幣別選擇，預設TWD
- **FR-2.1.1-03**：調用APL.account.createAccount()進行後端創建
- **FR-2.1.1-04**：處理創建回應並更新本地狀態：
  - 成功：更新帳戶清單、顯示成功訊息、跳轉至帳戶詳情頁
  - 失敗：顯示錯誤訊息、保留表單資料、提供重試選項

**四模式差異化處理**：
- **Expert模式**：完整表單欄位、進階設定選項、多幣別支援
- **Inertial模式**：標準欄位組合、預設值填充、固定幣別
- **Cultivation模式**：引導式填寫、預設建議、進度提示
- **Guiding模式**：極簡欄位（僅名稱與類型）、自動預設值

#### 2.1.2 帳戶資料更新邏輯
**業務邏輯職責**：處理帳戶資訊修改的業務流程，確保資料一致性與同步。

**核心處理流程**：
```
編輯觸發 → 載入現有資料 → 修改處理 → 變更驗證 → APL調用 → 狀態同步 → 快取更新
```

**具體功能需求**：
- **FR-2.1.2-01**：載入現有帳戶資料並填入編輯表單
- **FR-2.1.2-02**：偵測資料變更並執行差異驗證
- **FR-2.1.2-03**：調用APL.account.updateAccount()執行更新
- **FR-2.1.2-04**：處理更新結果並同步相關狀態：
  - 帳戶清單狀態更新
  - 相關交易記錄的帳戶資訊更新
  - 快取資料同步

#### 2.1.3 帳戶資料驗證邏輯
**業務邏輯職責**：確保帳戶資料的正確性與完整性，防止無效資料進入系統。

**具體功能需求**：
- **FR-2.1.3-01**：即時驗證機制：
  - 帳戶名稱重複性檢查（本地快取 + API驗證）
  - 餘額格式與範圍驗證
  - 必填欄位完整性檢查
- **FR-2.1.3-02**：調用APL.account服務進行後端驗證
- **FR-2.1.3-03**：驗證錯誤處理：
  - 即時顯示驗證錯誤訊息
  - 阻止無效資料提交
  - 提供修正建議

#### 2.1.4 帳戶資料快取邏輯
**業務邏輯職責**：管理帳戶資料的本地快取，提升使用者體驗與離線能力。

**具體功能需求**：
- **FR-2.1.4-01**：快取策略實施：
  - 帳戶清單：載入後快取60分鐘
  - 帳戶詳情：載入後快取30分鐘
  - 餘額資訊：載入後快取10分鐘（高頻更新）
- **FR-2.1.4-02**：快取更新觸發條件：
  - 主動刷新：使用者下拉刷新
  - 自動更新：背景定時同步（15分鐘）
  - 事件更新：帳戶相關操作後立即更新
- **FR-2.1.4-03**：離線支援：
  - 離線模式下顯示快取資料
  - 離線操作佇列機制
  - 網路恢復後自動同步

#### 2.1.5 帳戶資料同步邏輯
**業務邏輯職責**：確保本地資料與遠端資料的一致性。

**具體功能需求**：
- **FR-2.1.5-01**：同步觸發機制：
  - APP前景時自動檢查更新
  - 使用者主動刷新
  - 重要操作後強制同步
- **FR-2.1.5-02**：衝突解決策略：
  - 遠端優先：一般資料更新
  - 本地優先：使用者正在編輯的資料
  - 合併策略：非衝突欄位個別處理
- **FR-2.1.5-03**：同步狀態管理：
  - 同步進度指示器
  - 同步狀態資訊顯示
  - 同步失敗重試機制

### 2.2 科目階層管理邏輯

#### 2.2.1 科目樹狀結構處理邏輯  
**業務邏輯職責**：處理科目的階層關係，維護樹狀結構的完整性與一致性。

**核心處理流程**：
```
科目資料載入 → 階層關係解析 → 樹狀結構建構 → 展開/收合邏輯 → 搜尋/篩選處理
```

**具體功能需求**：
- **FR-2.2.1-01**：樹狀結構建構：
  - 從平面科目資料建立父子關係
  - 支援最多3層階層深度
  - 自動排序：預設科目優先，自訂科目其次，按使用頻率排序
- **FR-2.2.1-02**：樹狀互動邏輯：
  - 展開/收合狀態記憶
  - 父節點選擇時顯示子科目選項
  - 子科目反向導航至父科目
- **FR-2.2.1-03**：搜尋與篩選：
  - 科目名稱模糊搜尋
  - 收支類型篩選
  - 使用頻率篩選
  - 搜尋結果階層路徑顯示

**四模式差異化處理**：
- **Expert模式**：完整樹狀結構、自訂排序、進階篩選
- **Inertial模式**：常用科目平鋪顯示、固定排序
- **Cultivation模式**：智慧推薦優先、使用引導
- **Guiding模式**：基本科目清單、最簡選擇

#### 2.2.2 科目階層同步邏輯
**業務邏輯職責**：確保科目階層資料的同步性，處理階層關係變更。

**具體功能需求**：
- **FR-2.2.2-01**：階層同步策略：
  - 完整樹狀結構重建：初次載入或重大變更
  - 增量更新：單一科目變更
  - 關係修復：發現資料不一致時的自動修復
- **FR-2.2.2-02**：同步衝突處理：
  - 階層迴圈檢測與修復
  - 孤兒科目的重新歸類
  - 重複科目的合併處理
- **FR-2.2.2-03**：同步效能優化：
  - 差異比較演算法
  - 批量更新處理
  - 背景同步機制

#### 2.2.3 科目關係驗證邏輯
**業務邏輯職責**：驗證科目階層關係的邏輯正確性。

**具體功能需求**：
- **FR-2.2.3-01**：階層關係驗證：
  - 父子關係合理性檢查
  - 迴圈引用檢測
  - 深度限制驗證（最多3層）
- **FR-2.2.3-02**：業務邏輯驗證：
  - 收支類型一致性：子科目必須與父科目類型相同
  - 科目名稱唯一性：同層級科目名稱不可重複
  - 預設科目保護：系統預設科目不可刪除或修改階層

#### 2.2.4 科目資料快取邏輯
**業務邏輯職責**：管理科目樹狀結構的快取與更新策略。

**具體功能需求**：
- **FR-2.2.4-01**：分層快取策略：
  - 完整科目樹：快取120分鐘
  - 常用科目清單：快取60分鐘  
  - 使用統計資料：快取30分鐘
- **FR-2.2.4-02**：智慧預載機制：
  - 記帳頁面預載常用科目
  - 背景預載完整科目樹
  - 預測性載入：基於使用習慣預載可能使用的科目

### 2.3 帳戶餘額計算邏輯

#### 2.3.1 即時餘額計算邏輯
**業務邏輯職責**：提供準確的帳戶餘額計算與顯示功能。

**核心處理流程**：
```
餘額查詢觸發 → 快取檢查 → APL調用 → 計算處理 → 格式化顯示 → 快取更新
```

**具體功能需求**：
- **FR-2.3.1-01**：餘額計算模式：
  - 即時計算：調用APL.account.getAccountBalance()取得最新餘額
  - 快速顯示：優先顯示快取餘額，背景更新最新值
  - 差異提示：快取與最新值差異超過閾值時的提示機制
- **FR-2.3.1-02**：多幣別處理：
  - 原幣別顯示：顯示帳戶原始幣別餘額
  - 換算顯示：提供主要幣別（TWD）換算金額
  - 匯率更新：定期更新匯率資料
- **FR-2.3.1-03**：餘額顯示邏輯：
  - 格式化顯示：千分位符號、小數點處理
  - 負值顯示：紅色顯示負餘額，特殊標示
  - 隱私模式：支援餘額隱藏功能

#### 2.3.2 餘額快取更新邏輯
**業務邏輯職責**：管理帳戶餘額的快取策略，平衡準確性與效能。

**具體功能需求**：
- **FR-2.3.2-01**：快取更新觸發：
  - 交易完成後立即更新相關帳戶餘額
  - 定時背景更新（每10分鐘）
  - 使用者主動刷新
- **FR-2.3.2-02**：快取策略：
  - 短期快取：5分鐘內直接使用快取值
  - 中期快取：5-15分鐘顯示快取值但背景更新
  - 長期快取：超過15分鐘強制重新載入
- **FR-2.3.2-03**：更新優先級：
  - 高優先級：當前檢視的帳戶
  - 中優先級：最近使用的帳戶
  - 低優先級：其他所有帳戶

#### 2.3.3 餘額一致性檢查邏輯
**業務邏輯職責**：確保餘額資料的準確性與一致性。

**具體功能需求**：
- **FR-2.3.3-01**：一致性檢查機制：
  - 定期校驗：每日背景檢查餘額一致性
  - 即時檢查：重要操作後的即時校驗
  - 異常偵測：餘額異常變動的自動偵測
- **FR-2.3.3-02**：不一致處理：
  - 自動修復：小額差異的自動調整
  - 警示提醒：大額差異的使用者提醒
  - 手動確認：重大不一致的手動確認機制

### 2.4 科目使用統計邏輯

#### 2.4.1 使用頻率分析邏輯
**業務邏輯職責**：分析使用者的科目使用模式，提供個人化體驗。

**核心處理流程**：
```
交易記錄 → 科目使用追蹤 → 頻率統計計算 → 排序排名 → 推薦邏輯 → 顯示優化
```

**具體功能需求**：
- **FR-2.4.1-01**：統計資料收集：
  - 記錄每次科目選擇行為
  - 追蹤科目使用的時間分布
  - 統計科目與金額的關聯性
- **FR-2.4.1-02**：頻率計算演算法：
  - 時間加權：近期使用給予更高權重
  - 頻次統計：計算絕對使用次數
  - 金額權重：高金額交易給予額外權重
- **FR-2.4.1-03**：統計週期管理：
  - 短期統計：最近7天的使用模式
  - 中期統計：最近30天的使用模式
  - 長期統計：最近180天的使用模式

#### 2.4.2 智慧推薦邏輯
**業務邏輯職責**：基於使用統計提供智慧科目推薦功能。

**具體功能需求**：
- **FR-2.4.2-01**：推薦演算法：
  - 時間模式：基於記帳時間推薦常用科目
  - 金額模式：基於交易金額推薦相似科目
  - 組合模式：基於科目組合使用模式推薦
- **FR-2.4.2-02**：推薦顯示邏輯：
  - 快速選擇：在科目選擇頁面頂部顯示推薦科目
  - 智慧預填：基於金額或描述自動推薦科目
  - 學習適應：根據使用者接受度調整推薦策略
- **FR-2.4.2-03**：四模式差異化推薦：
  - **Expert模式**：複雜推薦演算法、多維度分析
  - **Inertial模式**：固定推薦清單、穩定排序
  - **Cultivation模式**：引導式推薦、習慣養成建議
  - **Guiding模式**：單一最佳推薦、極簡選擇

#### 2.4.3 統計資料快取邏輯
**業務邏輯職責**：管理統計資料的快取與更新策略。

**具體功能需求**：
- **FR-2.4.3-01**：統計快取策略：
  - 頻率統計：快取30分鐘，背景更新
  - 推薦結果：快取60分鐘，交易後更新
  - 使用模式：快取24小時，定時更新
- **FR-2.4.3-02**：增量更新機制：
  - 新交易記錄時增量更新統計
  - 避免全量重算，提升效能
  - 批量處理多筆交易的統計更新

### 2.5 四模式差異化業務邏輯處理

#### 2.5.1 Expert模式業務邏輯
**目標使用者**：需要完整功能控制的進階使用者
**業務邏輯特色**：完整功能、深度設定、專業分析

**具體業務邏輯需求**：
- **FR-2.5.1-01**：完整資料處理：
  - 帳戶管理：支援所有帳戶類型、多幣別、詳細設定
  - 科目管理：完整階層結構、自訂分類、進階篩選
  - 統計分析：詳細使用統計、趨勢分析、個人化洞察
- **FR-2.5.1-02**：進階功能啟用：
  - 批量操作：批量建立、編輯、刪除功能
  - 匯入匯出：支援資料匯入匯出功能
  - 自訂規則：自訂分類規則、自動化邏輯
- **FR-2.5.1-03**：效能最佳化：
  - 預載機制：預載所有相關資料
  - 並行處理：支援多工處理複雜操作
  - 快取策略：長時間快取以支援快速存取

#### 2.5.2 Inertial模式業務邏輯
**目標使用者**：習慣固定流程的穩定使用者
**業務邏輯特色**：固定流程、一致體驗、穩定介面

**具體業務邏輯需求**：
- **FR-2.5.2-01**：標準化處理流程：
  - 固定操作流程：標準化的操作步驟，避免變化
  - 預設值優先：大量使用預設值，減少選擇
  - 一致性保證：介面與流程保持高度一致性
- **FR-2.5.2-02**：穩定功能集合：
  - 核心功能：僅提供核心帳戶與科目管理功能
  - 簡化選項：減少設定選項，提供標準配置
  - 經典介面：使用傳統、穩定的介面設計
- **FR-2.5.2-03**：可預測行為：
  - 固定排序：帳戶與科目使用固定排序邏輯
  - 穩定推薦：推薦結果保持穩定，避免頻繁變化
  - 一致回饋：操作回饋保持一致的格式與內容

#### 2.5.3 Cultivation模式業務邏輯
**目標使用者**：需要習慣養成與激勵機制的成長使用者
**業務邏輯特色**：引導學習、進度追蹤、激勵回饋

**具體業務邏輯需求**：
- **FR-2.5.3-01**：引導式學習邏輯：
  - 步驟引導：分步驟引導複雜操作
  - 提示系統：適時提供操作提示與建議
  - 學習追蹤：追蹤使用者學習進度與熟練度
- **FR-2.5.3-02**：習慣養成機制：
  - 目標設定：設定帳戶與科目管理目標
  - 進度追蹤：視覺化顯示目標達成進度
  - 成就系統：完成特定任務獲得成就獎勵
- **FR-2.5.3-03**：智慧建議系統：
  - 個人化建議：基於使用習慣提供改善建議
  - 最佳實務：推薦業界最佳實務做法
  - 週期回顧：定期提供使用情況回顧與建議

#### 2.5.4 Guiding模式業務邏輯
**目標使用者**：需要極簡介面與自動化處理的入門使用者
**業務邏輯特色**：極簡操作、自動處理、被動引導

**具體業務邏輯需求**：
- **FR-2.5.4-01**：極簡操作邏輯：
  - 最少輸入：僅要求必要資訊輸入
  - 自動預設：大量使用智慧預設值
  - 單步操作：避免複雜的多步驟操作流程
- **FR-2.5.4-02**：自動化處理：
  - 智慧分類：自動推薦最佳科目選擇
  - 預設帳戶：自動選擇最常用帳戶
  - 自動完成：自動完成重複性操作
- **FR-2.5.4-03**：被動引導系統：
  - 上下文提示：在適當時機提供必要提示
  - 錯誤預防：預防性檢查避免使用者犯錯
  - 簡化回饋：提供簡潔明確的操作回饋

### 2.6 本地資料快取與同步邏輯

#### 2.6.1 本地快取機制
**業務邏輯職責**：提供高效的本地資料快取策略，確保良好的使用者體驗。

**核心快取架構**：
```
記憶體快取層 (Hot Cache) → 持久化快取層 (Warm Cache) → 遠端資料層 (Cold Data)
```

**具體功能需求**：
- **FR-2.6.1-01**：多層快取策略：
  - **L1記憶體快取**：存放當前頁面資料，APP生命週期內有效
  - **L2本地儲存快取**：存放常用資料，跨APP啟動有效
  - **L3離線快取**：存放關鍵資料，支援離線操作
- **FR-2.6.1-02**：快取資料分級：
  - **熱點資料**：帳戶清單、常用科目（記憶體快取）
  - **溫資料**：完整科目樹、餘額資訊（本地儲存快取）
  - **冷資料**：歷史統計、詳細設定（離線快取）
- **FR-2.6.1-03**：快取生命週期管理：
  - 自動過期：根據資料類型設定不同過期時間
  - 主動清理：記憶體不足時的快取清理機制
  - 手動刷新：使用者觸發的強制更新機制

#### 2.6.2 資料同步策略
**業務邏輯職責**：確保本地資料與遠端資料的一致性與同步性。

**同步觸發機制**：
- **即時同步**：關鍵操作（建立、修改、刪除）後立即同步
- **定時同步**：背景定時檢查與同步（15分鐘間隔）
- **事件同步**：APP啟動、網路恢復、使用者主動刷新觸發

**具體功能需求**：
- **FR-2.6.2-01**：同步策略分類：
  - **強一致性同步**：帳戶餘額、重要設定變更
  - **最終一致性同步**：使用統計、科目排序
  - **衝突解決同步**：併發修改時的衝突處理
- **FR-2.6.2-02**：增量同步機制：
  - 變更追蹤：追蹤本地資料變更記錄
  - 差異比較：比較本地與遠端資料差異
  - 最小化傳輸：僅同步變更的資料欄位
- **FR-2.6.2-03**：同步狀態管理：
  - 同步進度追蹤：顯示同步進度與狀態
  - 失敗重試機制：網路失敗時的自動重試
  - 衝突通知：資料衝突時的使用者通知

#### 2.6.3 衝突解決機制
**業務邏輯職責**：處理本地與遠端資料衝突，確保資料完整性。

**衝突偵測機制**：
- **時間戳比較**：基於最後修改時間判斷資料新舊
- **版本號控制**：使用版本號追蹤資料變更
- **雜湊比較**：比較資料內容雜湊值偵測變更

**具體功能需求**：
- **FR-2.6.3-01**：自動衝突解決：
  - **遠端優先**：系統設定、帳戶基本資訊優先使用遠端版本
  - **本地優先**：使用者正在編輯的資料優先使用本地版本
  - **時間優先**：根據最後修改時間選擇較新版本
- **FR-2.6.3-02**：手動衝突解決：
  - **衝突提醒**：偵測到衝突時提醒使用者選擇
  - **版本比較**：並列顯示衝突版本供使用者比較
  - **合併選項**：提供欄位級別的合併選擇
- **FR-2.6.3-03**：衝突預防機制：
  - **樂觀鎖定**：使用版本控制預防併發衝突
  - **操作序列化**：關鍵操作採用序列化處理
  - **衝突告警**：預警可能發生衝突的操作

---