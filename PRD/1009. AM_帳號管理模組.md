
# MRD_AM_帳號管理模組_v2.0

## 1.0 模組概述（Module Overview）
帳號管理模組負責管理 LCAS 2.0 系統中 LINE OA 端和 APP 端的使用者帳號，實現跨平台帳號統一管理和資料整合。本模組支援 LINE UID、iOS_UID 和 Android_UID 的統一管理，確保不同平台用戶資料能夠有效串接。

此模組負責帳號的創建、管理、修改和查詢，確保帳號數據的安全性和完整性。由於本系統使用 LINE 官方帳號進行登入，帳號驗證透過 LINE Login OAuth 進行，不需儲存或管理密碼。

## 2.0 功能需求（Functional Requirements）

### 2.1 新增帳號
- 支援新增 LINE OA 用戶帳號（UID）
- 支援新增 APP 端用戶帳號（iOS_UID、Android_UID）
- 帳號種類分成：
  - M: Merged ledger admin（多帳本管理員）
  - S: Single ledger（單一帳本用戶）
  - J: Join other ledger（加入他人帳本）
- 當新增帳號時，自動建立對應的用戶資料結構
- **自動初始化用戶科目數據**：新用戶註冊時自動從預設科目表導入完整科目清單
- 支援跨平台帳號關聯綁定

### 2.2 註銷帳號
- 支援註銷使用者帳號，確保帳號數據被安全刪除
- 處理跨平台帳號解除綁定
- 保留必要的歷史記錄用於審計

### 2.3 帳號修改
- 支援修改使用者帳號信息，如角色等
- 支援更新 LINE 綁定資訊（如名稱等）
- 支援 APP 端用戶資料更新
- 支援跨平台帳號資料同步

### 2.4 帳號查詢
- 支援查詢使用者帳號信息，提供帳號管理的便捷性
- 支援跨平台帳號關聯查詢
- 支援用戶類型和權限查詢

### 2.5 跨平台帳號整合
- LINE OA 端與 APP 端帳號資料串接
- 統一用戶身份識別機制
- 跨平台資料同步與一致性維護

### 2.6 用戶科目初始化管理
- 新用戶註冊時自動初始化預設科目數據
- 支援檢查並補充缺失的科目數據
- 從系統預設科目表（9999. Subject_code.json）導入完整科目清單
- 科目初始化包含：大項代碼、大項名稱、子項代碼、子項名稱、同義詞等完整資訊
- 支援批次導入科目數據以提升效能

### 2.7 錯誤處理與重試機制
- 當帳號操作失敗時，記錄錯誤並啟動重試機制，以確保帳號操作的成功

## 3.0 輸入/輸出規格（Input & Output Specifications）

### 3.1 輸入

#### 3.1.1 LINE OA 端輸入
```javascript
// LINE 用戶資訊
{
  "UID": "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "displayName": "用戶名稱",
  "statusMessage": "用戶狀態訊息",
  "language": "zh-TW"
}
```

#### 3.1.2 APP 端輸入
```javascript
// APP 註冊資料
{
  "email": "user@example.com",
  "displayName": "用戶顯示名稱",
  "platform": "iOS" | "Android",
  "deviceId": "unique_device_identifier",
  "appVersion": "1.0.0"
}
```

#### 3.1.3 帳號管理輸入
```javascript
// 帳號管理資料
{
  "userType": "M" | "S" | "J",
  "permissions": ["read", "write", "admin"],
  "timezone": "Asia/Taipei",
  "preferences": {
    "notifications": true,
    "language": "zh-TW"
  }
}
```

### 3.2 輸出

#### 3.2.1 帳號操作結果
```javascript
// 操作成功回應
{
  "success": true,
  "message": "帳號操作成功",
  "accountId": "generated_account_id",
  "userType": "M" | "S" | "J",
  "createdAt": "2025-01-08T00:00:00+08:00",
  "platform": "LINE" | "iOS" | "Android"
}
```

#### 3.2.2 錯誤回應
```javascript
// 操作失敗回應
{
  "success": false,
  "error": "錯誤描述",
  "errorCode": "AM_ERROR_CODE",
  "retryCount": 0,
  "timestamp": "2025-01-08T00:00:00+08:00"
}
```

#### 3.2.3 帳號查詢結果
```javascript
// 查詢結果
{
  "success": true,
  "userData": {
    "UID": "primary_user_identifier",
    "linkedAccounts": {
      "LINE_UID": "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "iOS_UID": "ios_user_identifier",
      "Android_UID": "android_user_identifier"
    },
    "userType": "M" | "S" | "J",
    "displayName": "用戶名稱",
    "createdAt": "2025-01-08T00:00:00+08:00",
    "lastActive": "2025-01-08T00:00:00+08:00"
  }
}
```

## 4.0 錯誤處理與例外狀況（Error Handling & Edge Cases）

### 4.1 認證相關錯誤
- LINE 授權失敗：若 LINE OAuth 授權失敗，記錄錯誤並提示用戶重新授權
- OAuth Token 過期：當存取權杖過期時，請求使用者重新登入
- APP 端認證失敗：處理 iOS/Android 平台認證問題

### 4.2 操作失敗處理
- 操作失敗：當帳號操作失敗時，記錄錯誤並啟動重試機制，確保操作最終能被成功執行
- 權限不足：當使用者權限不足時，記錄錯誤並拒絕操作
- 資料衝突：處理跨平台帳號資料不一致問題

### 4.3 系統異常處理
- 資料庫連線失敗：建立備用機制確保服務持續性
- 網路異常：實作重試機制和離線處理
- 平台 API 異常：處理 LINE、iOS、Android 平台 API 異常情況

## 5.0 資料庫結構設計

### 5.1 Firestore 集合結構
```javascript
// users 集合
users/{UID} = {
  displayName: string,
  userType: "M" | "S" | "J",
  createdAt: timestamp,
  lastActive: timestamp,
  timezone: "Asia/Taipei",
  linkedAccounts: {
    LINE_UID: string,
    iOS_UID: string,
    Android_UID: string
  },
  settings: {
    notifications: boolean,
    language: string
  },
  joined_ledgers: array
}

// account_mappings 集合
account_mappings/{mapping_id} = {
  primary_UID: string,
  platform_accounts: {
    LINE: "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    iOS: "ios_user_identifier",
    Android: "android_user_identifier"
  },
  created_at: timestamp,
  updated_at: timestamp
}
```

## 6.0 API 介面規格

### 6.1 REST API 端點
```
POST   /api/v2/accounts/create           - 建立新帳號
PUT    /api/v2/accounts/{uid}/update     - 更新帳號資訊
DELETE /api/v2/accounts/{uid}/delete     - 註銷帳號
GET    /api/v2/accounts/{uid}            - 查詢帳號資訊
POST   /api/v2/accounts/link             - 跨平台帳號關聯
POST   /api/v2/accounts/unlink           - 解除帳號關聯
GET    /api/v2/accounts/search           - 帳號搜尋
```

## 7.0 整合測試計畫

### 7.1 單元測試
- 測試各個功能模組，如新增帳號、註銷帳號、帳號修改等，確保其正常運行
- 測試跨平台帳號關聯功能，確保資料正確同步

### 7.2 整合測試
- 測試帳號管理模組與 LINE OAuth 的整合，確保身份驗證流程正常
- 測試帳號管理模組與其他 LCAS 模組的整合，確保數據流轉正確
- 測試與 Firestore 的整合，確保帳號資料能夠正確儲存和查詢

### 7.3 使用者測試
- 邀請使用者進行跨平台功能測試，收集反饋意見，並進行相應的改進

### 7.4 邊界測試
- 測試各種邊界條件，如 LINE 授權失敗、OAuth 過期等，確保系統在這些情況下的穩定性
- 測試跨平台資料同步異常情況，確保錯誤處理機制生效
- 測試大量並發帳號操作，確保系統效能和穩定性

---

**文件維護記錄**

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.2 | 2025-01-08 | 原作者 | 初版建立 |
| v2.0 | 2025-01-08 | AustinLiao69 | 依照LCAS 2.0架構修改，統一UID命名，新增跨平台整合功能 |

---
