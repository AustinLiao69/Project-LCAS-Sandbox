# PRD_SR_排程提醒模組_v1.1

**文件編號**: 1005
**版本**: 1.1.0
**建立日期**: 2025-07-18
**建立者**: LCAS PM Team
**最後更新**: 2025-07-18 12:00:00 UTC+8

---

## 1.0 模組概述（Module Overview）

### 1.1 產品定位
SR (Scheduled Reminder) 排程提醒模組是 LCAS 2.0 系統的智慧記帳自動化核心，負責處理定期記帳提醒、自動記帳執行、財務統計推播等功能。

### 1.2 核心價值主張
- **智慧自動化**: 自動執行重複性記帳任務，減少使用者手動操作
- **個人化提醒**: 基於使用者習慣的智慧提醒系統

### 1.3 目標使用者
- **個人記帳用戶**: 需要定期記帳提醒的個人使用者
- **付費訂閱用戶**: 需要進階統計分析和自動推播的用戶
- **習慣養成用戶**: 希望建立良好財務管理習慣的用戶

---

## 2.0 功能需求（Functional Requirements）

### 2.1 基礎排程功能（免費功能）

#### 2.1.1 自動記帳提醒
- 支援週期性記帳提醒（每日、每週、每月）
- 使用 Quick Reply 按鈕提供快速操作選項
- 基礎條件判斷（週末、國定假日處理）
- 免費用戶限制2個提醒設定，付費用戶無限制

#### 2.1.2 簡單統計查詢
- 提供三種基礎統計查詢：今日收支統計、本週收支統計、本月收支統計
- 使用 Quick Reply 按鈕實作快速操作，按鈕標籤分別為「今日統計」、「本週統計」、「本月統計」
- 對應的回傳文字為「今日統計」、「本週統計」、「本月統計」

### 2.2 進階付費功能

#### 2.2.1 自動推播服務（付費限定）
- 每日財務摘要自動推播（21:00）
- 預算警告自動通知
- 月度財務報告自動生成
- 智慧提醒時間最佳化

---

## 3.0 付費功能開關設計

### 3.1 功能權限矩陣
**免費用戶功能範圍：**
- 推播通知：關閉
- 提醒設定：限制2個
- 可用功能：基礎記帳、手動統計查詢、Quick Reply統計、基礎提醒

**付費用戶功能範圍：**
- 推播通知：開啟
- 提醒設定：無限制
- 可用功能：自動推播、趨勢分析、預算警示、智慧時間最佳化

### 3.2 功能開關實作原則
每個功能在開發時都必須設定是否開放給免費使用者使用：

- **基礎提醒功能**: 免費開放（限制2個設定）
- **手動統計查詢**: 免費開放
- **Quick Reply 操作**: 免費開放
- **自動推播服務**: 付費限定
- **進階時間最佳化**: 付費限定

---

## 4.0 使用者體驗設計

### 4.1 Quick Reply 互動設計
**每日統計功能：**
- 主要文字：「📊 今日財務摘要」
- Quick Reply 選項：
  - 詳細明細（回傳文字：「明細」）
  - 本週比較（回傳文字：「週比較」）
  - 設定提醒（回傳文字：「提醒設定」）

**付費功能推廣：**
- 主要文字：「🔒 此功能需要 Premium 訂閱」
- Quick Reply 選項：
  - 立即升級（連結至升級頁面）
  - 免費試用（回傳文字：「試用」）
  - 了解更多（回傳文字：「功能介紹」）

### 4.2 推播訊息格式設計
**每日財務摘要格式：**
- 包含當日收入、支出金額及淨額
- 顯示收入與支出明細分類
- 提供即將到期的自動記帳提醒
- 引導使用者輸入「統計」查看詳細分析

**預算警告格式：**
- 顯示特定類別當月支出金額
- 標示預算額度及使用率百分比
- 提供節約建議

---

## 5.0 資料庫結構設計

### 5.1 排程設定集合
排程提醒資料儲存於 `scheduled_reminders` 集合，包含：
- 使用者ID與提醒類型（每日/每週/每月/自訂）
- 排程設定：cron表達式、時區、啟用狀態
- 提醒資料：科目代碼、金額、付款方式、訊息
- 條件設定：是否跳過週末、國定假日處理方式
- 時間戳記：建立時間、最後執行時間、下次執行時間

### 5.2 用戶訂閱狀態
使用者訂閱資訊儲存於 `users/{userId}/subscription`，包含：
- 訂閱類型（免費/付費）
- 可用功能清單
- 到期時間與自動續約設定
- 付款方式與計費週期

### 5.3 國定假日處理機制
系統將自動處理國定假日與週末：
- 取得當年度國定假日清單
- 根據使用者設定的規則調整提醒日期
- 支援提前、延後或跳過三種處理方式

---

## 7.0 錯誤處理與例外狀況

### 7.1 排程執行失敗
- 處理排程服務超時問題
- 建立網路連線異常重試機制
- 設計 Firestore 寫入失敗的備援方案

### 7.2 LINE API 限制
- 應對 Reply Token 60秒時效限制
- 管理 Push API 每月配額
- 處理 Rich Menu 更新失敗情況

### 7.3 付費功能驗證
- 處理訂閱狀態過期情況
- 實作功能降級的平滑轉換
- 建立付費驗證失敗的容錯機制

---

## 8.0 測試計畫

### 8.1 功能測試
- 驗證排程執行的準確性
- 測試付費功能開關機制
- 檢驗 Quick Reply 互動流程
- 驗證推播訊息格式正確性

### 8.2 效能測試
- 測試大量使用者並發排程處理能力
- 評估 Firestore 讀寫效能表現
- 監控 LINE API 呼叫頻率限制

### 8.3 商業邏輯測試
- 驗證免費與付費功能邊界
- 測試訂閱狀態轉換流程
- 確認計費邏輯運算正確性

---

**文件維護記錄**

| 版本 | 日期 | 修改者 | 修改內容 |
|------|------|--------|----------|
| v1.0 | 2025-07-18 | LCAS PM Team | 初版建立，整合用戶回饋和商業需求，移除重複記帳檢測、MRA相關功能及獎勵機制，修正時間格式，將程式碼轉換為文字敘述 |
| v1.1 | 2025-07-18 | LCAS PM Team | 移除社群比較功能和成就系統，專注於排程提醒核心價值，簡化功能權限矩陣，升級模組版本 |

---

**備註**：
* 每個功能在開發時都必須設定是否開放給免費使用者
* 本文件專注於模組功能描述，不包含技術實作細節
* 社群比較和成就系統功能已移至其他專門模組處理
* 個人化洞察報告功能移至 MRA 模組處理