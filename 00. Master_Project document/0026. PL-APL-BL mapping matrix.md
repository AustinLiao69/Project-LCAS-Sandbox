
# 0026. PL-APL-BL 三層架構對應表

**文件編號**: 0026  
**版本**: 1.0.0  
**建立日期**: 2025-09-09  
**建立者**: LCAS PM Team  
**最後更新**: 2025-09-09   

---

## 目次 (Table of Contents)

### 1. [簡介](#1-簡介)
### 2. [完整三層對應關係表](#2-完整三層對應關係表)
### 3. [功能域對應分析](#3-功能域對應分析)
### 4. [對應狀態統計](#4-對應狀態統計)
### 5. [關鍵發現與建議](#5-關鍵發現與建議)
### 6. [維護策略](#6-維護策略)

---

## 1. 簡介

本文件建立LCAS 2.0專案完整的三層架構對應關係，涵蓋：
- **PL (Presentation Layer)**: 70資料夾 - 基於7021 Screen list的40個畫面
- **APL (Application Logic Layer)**: 81資料夾 - 13個API SPEC服務  
- **BL (Business Logic Layer)**: 13資料夾 - 16個商業邏輯模組

**建立目標**：
- 提供完整的跨層級功能對應關係
- 支援開發規劃與維護管理
- 確保三層架構完整性
- 建立版本同步機制

---

## 2. 完整三層對應關係表

### 2.1 主要功能域對應矩陣

| 功能域 | PL畫面 | APL服務 | BL模組 | 對應狀態 | 備註 |
|--------|--------|---------|--------|----------|------|
| **使用者認證** | S-103 註冊頁<br>S-104 登入頁<br>S-105 忘記密碼頁 | 8101 認證服務 | 1309 AM.js | ✅ **完全對應** | 跨平台綁定完整 |
| **用戶管理** | S-106 模式評估問卷頁<br>S-505 個人設定頁 | 8102 用戶管理服務 | 1309 AM.js | ✅ **完全對應** | 四模式切換支援 |
| **記帳核心** | S-201 OA記帳對話<br>S-202 記帳主頁<br>S-203 記帳表單頁 | 8103 記帳交易服務 | 1301 BK.js<br>1315 LBK.js | ✅ **完全對應** | 快速記帳整合 |
| **帳本管理** | S-301 帳本管理主頁<br>S-302 建立帳本頁 | 8104 帳本管理服務 | 1351 MLS.js | ✅ **完全對應** | 多帳本支援 |
| **協作管理** | S-303 協作管理頁 | 8104 帳本管理服務 | 1313 CM.js | ✅ **完全對應** | 權限控制完整 |
| **帳戶管理** | S-304 帳戶管理主頁<br>S-305 建立帳戶頁<br>S-205 帳戶選擇頁 | 8105 帳戶管理服務 | 1301 BK.js | ⚠️ **部分對應** | 可考慮獨立模組 |
| **科目管理** | S-306 科目管理主頁<br>S-204 科目選擇頁 | 8106 科目管理服務 | 1332 DD2.js<br>1301 BK.js | ✅ **完全對應** | 智慧推薦功能 |
| **預算管理** | S-307 預算管理主頁<br>S-308 建立預算頁 | 8107 預算管理服務 | 1312 BM.js | ✅ **完全對應** | 預算監控完整 |
| **報表分析** | S-401 報表分析主頁<br>S-402 報表設定頁<br>S-403 圖表展示頁<br>S-404 報表下載頁 | 8108 報表分析服務 | 1341 MRA.js<br>1361 GR.js | ✅ **完全對應** | 多格式匯出支援 |
| **深度分析** | S-405 深度分析頁 | 8108 報表分析服務 | 1341 MRA.js | ✅ **完全對應** | 趨勢分析功能 |
| **AI助理** | S-406 AI助理頁 | 8109 AI助理服務 | 1332 DD2.js | ⚠️ **部分對應** | 需擴展對話功能 |
| **激勵系統** | S-501 激勵系統頁 | 8110 激勵系統服務 | ❌ **無對應模組** | ❌ **缺失** | 需新建模組 |
| **系統服務** | - | 8111 系統服務 | 1310 DL.js<br>1311 FS.js | ✅ **完全對應** | 系統監控完整 |
| **備份管理** | S-502 資料備份頁 | 8112 備份管理服務 | 1314 BS.js | ✅ **完全對應** | 資料匯出入支援 |
| **通知管理** | S-504 通知設定頁 | 8113 通知管理服務 | 1305 SR.js | ⚠️ **部分對應** | 需整合完整通知 |

### 2.2 記帳相關細部對應

| PL畫面 | 主要功能 | APL端點 | BL函數 | 四模式差異 |
|--------|----------|---------|--------|------------|
| **S-201** | LINE OA記帳對話 | POST /transactions/quick | LBK.processQuickEntry | Expert: 複雜指令<br>Others: 簡化指令 |
| **S-203** | APP記帳表單 | POST /transactions | BK.createTransaction | Expert: 完整表單<br>Guiding: 最簡欄位 |
| **S-207** | 圖片附加 | POST /transactions/attachment | BK.addAttachment | Expert: 編輯工具<br>Others: 基本上傳 |
| **S-208** | 重複設定 | POST /transactions/recurring | BK.setRecurring | Expert: 複雜規則<br>Others: 簡化設定 |
| **S-209** | 記錄管理 | GET /transactions<br>PUT /transactions/{id} | BK.getTransactions<br>BK.updateTransaction | Expert: 批次操作<br>Others: 基本編輯 |

### 2.3 管理功能細部對應

| PL畫面 | 主要功能 | APL端點 | BL函數 | 權限等級 |
|--------|----------|---------|--------|----------|
| **S-302** | 建立帳本 | POST /ledgers | MLS.createLedger | 管理員 |
| **S-303** | 協作管理 | GET /ledgers/{id}/collaborators<br>POST /ledgers/{id}/invite | CM.getCollaborators<br>CM.inviteUser | 管理員 |
| **S-305** | 建立帳戶 | POST /accounts | BK.createAccount | 編輯權限 |
| **S-308** | 建立預算 | POST /budgets | BM.createBudget | 編輯權限 |

### 2.4 分析功能細部對應

| PL畫面 | 主要功能 | APL端點 | BL函數 | 計算複雜度 |
|--------|----------|---------|--------|------------|
| **S-401** | 報表主頁 | GET /reports | MRA.getReports | 低 |
| **S-402** | 報表設定 | POST /reports/generate | MRA.generateReport | 中 |
| **S-403** | 圖表展示 | GET /reports/{id} | GR.renderChart | 高 |
| **S-404** | 報表下載 | GET /reports/{id}/export | GR.exportReport | 中 |
| **S-405** | 深度分析 | POST /analysis/trend | MRA.performAnalysis | 高 |

---

## 3. 功能域對應分析

### 3.1 Epic級別對應統計

| Epic | 畫面總數 | API服務數 | BL模組數 | 對應率 |
|------|----------|-----------|----------|--------|
| **Epic 1: 進入階段** | 8個畫面 | 2個服務 | 1個模組 | 100% |
| **Epic 2: 記帳功能** | 11個畫面 | 3個服務 | 3個模組 | 100% |
| **Epic 3-6: 管理功能** | 8個畫面 | 4個服務 | 4個模組 | 87.5% |
| **Epic 7-9: 分析功能** | 6個畫面 | 2個服務 | 2個模組 | 100% |
| **Epic 10-15: 系統功能** | 7個畫面 | 4個服務 | 3個模組 | 75% |

### 3.2 關鍵流程對應驗證

#### 3.2.1 完整記帳流程
```
用戶操作: S-203記帳表單 
→ API調用: POST /transactions (8103)
→ 業務處理: BK.createTransaction (1301)
→ 資料存取: Firestore
```

#### 3.2.2 報表生成流程
```
用戶操作: S-402報表設定
→ API調用: POST /reports/generate (8108) 
→ 業務處理: MRA.generateReport (1341) + GR.renderChart (1361)
→ 資料存取: Firestore聚合查詢
```

#### 3.2.3 協作管理流程
```
用戶操作: S-303協作管理
→ API調用: POST /ledgers/{id}/invite (8104)
→ 業務處理: CM.inviteUser (1313) + MLS.updatePermissions (1351)
→ 資料存取: Firestore權限更新
```

---

## 4. 對應狀態統計

### 4.1 整體對應狀況

| 對應狀態 | 功能域數量 | 比例 | 說明 |
|----------|------------|------|------|
| ✅ **完全對應** | 10個 | 71.4% | 三層功能完整匹配 |
| ⚠️ **部分對應** | 3個 | 21.4% | 功能分散或不完整 |
| ❌ **缺失對應** | 1個 | 7.2% | 某層缺少對應模組 |

### 4.2 各層完整性分析

#### 4.2.1 PL層覆蓋率
- **總畫面數**: 40個畫面
- **有對應API**: 35個畫面 (87.5%)
- **無對應API**: 5個畫面 (12.5%) - 主要為純展示頁面

#### 4.2.2 APL層使用率
- **總API服務**: 13個服務
- **有對應PL**: 11個服務 (84.6%)
- **無對應PL**: 2個服務 (15.4%) - 系統內部服務

#### 4.2.3 BL層使用率
- **總BL模組**: 16個模組
- **有API對應**: 12個模組 (75%)
- **內部協調**: 4個模組 (25%) - DD1, DD3, WH等

### 4.3 四模式差異化完整性

| 功能域 | Expert | Inertial | Cultivation | Guiding | 差異化程度 |
|--------|--------|----------|-------------|---------|------------|
| 記帳功能 | ✅ | ✅ | ✅ | ✅ | 高 |
| 管理功能 | ✅ | ✅ | ⚠️ | ⚠️ | 中 |
| 分析功能 | ✅ | ✅ | ⚠️ | ✅ | 中 |
| 系統功能 | ✅ | ⚠️ | ✅ | ⚠️ | 低 |

---

## 5. 關鍵發現與建議

### 5.1 優勢分析 ✅

1. **核心流程完整**: 記帳、帳本、報表等核心功能三層對應完整
2. **架構設計良好**: 71.4%功能域達到完全對應
3. **模組化清晰**: APL與BL模組邊界明確
4. **版本管理統一**: 三層版本號保持同步

### 5.2 需要改善的問題 ⚠️

#### **高優先級問題**
1. **激勵系統缺失**: S-501畫面 ↔ 8110服務 ↔ ❌無BL模組
2. **通知管理分散**: S-504畫面 ↔ 8113服務 ↔ 1305 SR.js (功能不完整)
3. **帳戶管理獨立性**: 目前帳戶功能散布在BK模組中

#### **中優先級問題** 
1. **AI功能不完整**: S-406畫面需要完整的對話功能支援
2. **四模式差異化**: 部分功能域的模式差異化不夠明確

### 5.3 建議行動計畫 🎯

#### **Phase 1: 立即行動 (1週內)**
1. **新建激勵系統模組**: 建立 1316. IS.js (Incentive System)
2. **評估通知管理**: 決定擴展SR模組或新建通知模組
3. **更新對應表**: 補充缺失的對應關係

#### **Phase 2: 短期優化 (2-4週)**
1. **帳戶管理獨立**: 評估是否從BK模組中獨立帳戶功能
2. **AI功能擴展**: 在DD2模組中增加對話引擎
3. **四模式細化**: 補充模式差異化的具體實作

#### **Phase 3: 中期完善 (1-2個月)**
1. **跨層一致性**: 建立自動化檢查機制
2. **效能優化**: 基於對應關係優化模組間呼叫
3. **文檔同步**: 建立三層文檔自動同步機制

### 5.4 風險評估與緩解 🚨

| 風險項目 | 風險等級 | 影響範圍 | 緩解措施 |
|----------|----------|----------|----------|
| 激勵系統缺失 | 🔴 高 | 用戶體驗、產品競爭力 | 立即新建模組，優先開發 |
| 通知功能不完整 | 🟡 中 | 功能完整性 | 擴展現有SR模組功能 |
| 帳戶管理架構 | 🟢 低 | 程式碼維護性 | 評估後決定重構時機 |
| 版本不同步 | 🟡 中 | 開發效率 | 建立自動檢查機制 |

---

## 6. 維護策略

### 6.1 新增功能檢查清單

#### **PL層新增畫面**
- [ ] 更新S-xxx編號對應
- [ ] 確認四模式差異化設計
- [ ] 檢查與現有畫面的導航關係
- [ ] 更新對應表

#### **APL層新增服務**
- [ ] 更新81xx編號對應  
- [ ] 遵循8088 API設計規範
- [ ] 確認BL模組支援能力
- [ ] 更新對應表

#### **BL層新增模組**
- [ ] 更新13xx編號對應
- [ ] 確認與其他模組的協調關係
- [ ] 檢查API服務需求匹配
- [ ] 更新對應表

### 6.2 版本同步機制

#### **主版本升級 (x.0.0)**
- 三層同步升級，需求文檔同步
- 進行完整回歸測試
- 更新對應關係表

#### **次版本升級 (x.y.0)**
- 相關模組同步升級
- 進行影響範圍測試
- 局部更新對應表

#### **修正版本升級 (x.y.z)**
- 單模組升級，通知相關模組
- 進行相容性檢查
- 記錄修正內容

### 6.3 自動化檢查機制

#### **日常檢查**
- 檢查三層版本一致性
- 驗證API規格與實作一致
- 檢查文檔更新狀態

#### **發布前檢查**
- 完整對應關係驗證
- 跨層功能整合測試
- 文檔同步性確認

### 6.4 文檔更新規範

#### **對應表更新時機**
- 新增/修改/刪除功能時
- 版本升級時
- 架構調整時
- 定期Review (每月)

#### **更新責任歸屬**
- **PM**: 功能對應關係確認
- **SA**: 架構對應關係設計
- **Dev Lead**: 實作對應關係驗證

---

## 附錄

### A. 畫面編號對照表

| 畫面分類 | 編號範圍 | 總數 | 主要功能 |
|----------|----------|------|----------|
| 進入階段 | S-101 ~ S-108 | 8個 | 註冊、登入、模式評估 |
| 記帳功能 | S-201 ~ S-211 | 11個 | 記帳、管理、統計 |
| 管理功能 | S-301 ~ S-308 | 8個 | 帳本、帳戶、科目、預算 |
| 分析功能 | S-401 ~ S-406 | 6個 | 報表、分析、AI |
| 系統功能 | S-501 ~ S-507 | 7個 | 激勵、備份、設定、幫助 |

### B. API服務對照表

| 服務分類 | 編號 | 服務名稱 | 主要端點數 |
|----------|------|----------|------------|
| 核心服務 | 8101-8103 | 認證、用戶、記帳 | 24個 |
| 管理服務 | 8104-8107 | 帳本、帳戶、科目、預算 | 32個 |
| 分析服務 | 8108-8109 | 報表、AI | 16個 |
| 系統服務 | 8110-8113 | 激勵、系統、備份、通知 | 20個 |

### C. BL模組分類表

| 模組分類 | 編號範圍 | 模組數 | 主要職責 |
|----------|----------|--------|----------|
| 核心業務 | 1301, 1309, 1312, 1315 | 4個 | 記帳、帳號、預算、快速記帳 |
| 管理業務 | 1313, 1351 | 2個 | 協作、多帳本 |
| 分析業務 | 1341, 1361 | 2個 | 報表分析、生成 |
| 系統業務 | 1305, 1310, 1311, 1314 | 4個 | 提醒、日誌、檔案、備份 |
| 協調業務 | 1320, 1331, 1332, 1333 | 4個 | Webhook、智慧處理、協調 |

---

**文件版本記錄**:
- v1.0.0 (2025-09-09): 初版建立，基於7021 Screen list、81號資料夾API SPEC、13號資料夾BL模組建立完整三層架構對應關係，包含40個畫面、13個API服務、16個BL模組的完整映射關係，建立版本同步機制與維護策略
