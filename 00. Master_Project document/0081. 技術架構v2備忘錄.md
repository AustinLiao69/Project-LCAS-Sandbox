
# 0081. 技術架構v2備忘錄

**版本**: v1.0.0  
**建立日期**: 2025-09-18  
**建立者**: AustinLiao69  
**狀態**: 概念階段  

---

## 目次 (Table of Contents)

1. [架構概述](#1-架構概述)
2. [v1 vs v2 架構對比](#2-v1-vs-v2-架構對比)
3. [v2 架構設計理念](#3-v2-架構設計理念)
4. [技術架構圖](#4-技術架構圖)
5. [層級職責重新定義](#5-層級職責重新定義)
6. [優勢分析](#6-優勢分析)
7. [挑戰與風險](#7-挑戰與風險)
8. [實作策略建議](#8-實作策略建議)
9. [遷移路徑規劃](#9-遷移路徑規劃)
10. [技術決策記錄](#10-技術決策記錄)

---

## 1. 架構概述

技術架構v2是對當前LCAS 2.0系統架構的重大重新設計，目標是簡化架構層級、提升開發效率，並建立更符合實際業務需求的系統架構。

### 1.1 核心變革
- **移除APL層**：消除APP端的API Gateway中間層
- **業務邏輯統一**：APP端和LINE OA端各自擁有獨立的業務邏輯層
- **直接通信**：APP端直接與後端Express服務器通信
- **職責清晰化**：每層專注於核心職責，減少跨層複雜度

---

## 2. v1 vs v2 架構對比

### 2.1 v1 架構（現有0015規劃）
```
APP端:
├── PL (UI + 業務邏輯)
└── APL (API Gateway)
    │
    └── Express Server
        │
        └── 後端:
            ├── BL (業務邏輯)
            └── DL (認證 + 資料庫)
```

### 2.2 v2 架構（新提案）
```
APP端:
├── PL (UI)
└── BL1 (APP端業務邏輯)
    │
    └── Express Server
        │
        └── 後端:
            ├── BL2 (LINE OA業務邏輯)
            └── DL (認證 + 資料庫)
```

### 2.3 關鍵差異對比表

| 面向 | v1 架構 | v2 架構 |
|------|---------|---------|
| **APP端層級** | PL → APL → Express | PL → BL1 → Express |
| **業務邏輯位置** | 後端BL統一處理 | BL1(APP) + BL2(LINE OA) |
| **API標準化** | APL層統一RESTful | BL1層自定義介面 |
| **開發複雜度** | 高（三層架構） | 中（二層架構） |
| **跨平台一致性** | 高（統一BL） | 中（分離BL） |
| **離線功能** | 需APL層支援 | BL1層原生支援 |

---

## 3. v2 架構設計理念

### 3.1 核心原則
1. **簡化優先**：減少不必要的架構層級
2. **平台特化**：每個平台擁有最適合的業務邏輯
3. **直接通信**：避免中間層的轉換開銷
4. **開發效率**：降低開發和維護成本

### 3.2 設計驅動因素
- **實際使用模式**：APP端需要豐富的離線功能和複雜業務邏輯
- **LINE OA特性**：相對簡單的對話式互動，不需要複雜的前端邏輯
- **開發資源**：減少跨層調試和維護工作
- **效能考量**：減少網路請求和資料轉換

---

## 4. 技術架構圖

### 4.1 v2 完整架構圖
```
┌─────────────────────────────────────────────────────────────┐
│                        LCAS 2.0 v2架構                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────┐    ┌─────────────────────┐
│              APP端                   │    │      LINE OA端      │
│  ┌─────────────────────────────────┐ │    │                     │
│  │         PL (UI層)               │ │    │                     │
│  │  - Flutter UI元件               │ │    │                     │
│  │  - 畫面導航邏輯                  │ │    │                     │
│  │  - 使用者互動處理                │ │    │                     │
│  └─────────────────────────────────┘ │    │                     │
│               │                      │    │                     │
│  ┌─────────────────────────────────┐ │    │                     │
│  │       BL1 (APP業務邏輯)          │ │    │                     │
│  │  - 記帳邏輯處理                  │ │    │                     │
│  │  - 資料驗證與計算                │ │    │                     │
│  │  - 四模式差異化邏輯              │ │    │                     │
│  │  - 本地資料快取                  │ │    │                     │
│  │  - 離線功能支援                  │ │    │                     │
│  │  - HTTP客戶端                   │ │    │                     │
│  └─────────────────────────────────┘ │    │                     │
└─────────────────────────────────────┘    └─────────────────────┘
               │                                       │
               │            HTTP/HTTPS                 │ LINE API
               ▼                                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Express Server                           │
│                   (路由與轉發層)                            │
└─────────────────────────────────────────────────────────────┘
               │                                       │
               ▼                                       ▼
┌─────────────────────────────────────────────────────────────┐
│                        後端層                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │             BL2 (LINE OA業務邏輯)                       │ │
│  │  - LINE訊息處理                                        │ │
│  │  - 簡易記帳邏輯                                        │ │
│  │  - Webhook處理                                         │ │
│  │  - 文字指令解析                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
│               │                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                DL (資料層)                              │ │
│  │  - Firebase Authentication                              │ │
│  │  - Firestore Database                                  │ │
│  │  - Firebase Storage                                    │ │
│  │  - 資料驗證與安全                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 資料流設計
```
APP端資料流:
使用者操作 → PL層UI → BL1業務邏輯 → HTTP客戶端 → Express Server → DL層
                                                              ↓
回應處理 ← PL層更新 ← BL1資料處理 ← HTTP回應 ← Express Server ← DL層回應

LINE OA資料流:
LINE訊息 → LINE API → Express Server → BL2業務邏輯 → DL層
                                                    ↓
LINE回覆 ← LINE API ← Express Server ← BL2回應處理 ← DL層回應
```

---

## 5. 層級職責重新定義

### 5.1 APP端架構

#### 5.1.1 PL層（Presentation Layer）
**核心職責**：
- Flutter UI元件渲染與管理
- 使用者輸入處理與表單驗證
- 畫面導航與狀態管理
- UI/UX互動邏輯

**不包含**：
- 業務規則計算
- 資料持久化邏輯
- 網路通信處理
- 複雜的資料轉換

#### 5.1.2 BL1層（APP Business Logic）
**核心職責**：
- 記帳業務邏輯處理
- 資料驗證與計算
- 四模式差異化邏輯實作
- 本地資料快取管理
- 離線功能支援
- HTTP客戶端與API調用
- 統計分析與報表邏輯

**關鍵特性**：
- 支援離線記帳功能
- 本地業務規則驗證
- 智慧資料同步機制
- 四模式個人化處理

### 5.2 後端架構

#### 5.2.1 BL2層（LINE OA Business Logic）
**核心職責**：
- LINE訊息處理與解析
- 簡易記帳邏輯實作
- Webhook事件處理
- 文字指令識別與回應
- LINE Rich Menu管理

**關鍵特性**：
- 輕量級業務邏輯
- 即時回應機制
- 簡化的記帳流程
- 基本的查詢功能

#### 5.2.2 DL層（Data Layer）
**核心職責**：
- Firebase服務整合
- 資料持久化與檢索
- 使用者認證與授權
- 資料安全與備份
- 跨平台資料同步

---

## 6. 優勢分析

### 6.1 架構優勢
1. **簡化架構**：
   - 減少APP端的中間層（APL）
   - 降低系統複雜度
   - 簡化除錯與維護流程

2. **效能提升**：
   - 減少網路請求層級
   - 降低資料序列化/反序列化開銷
   - 提升APP回應速度

3. **開發效率**：
   - 減少跨層除錯工作
   - 統一的開發模式
   - 降低學習曲線

4. **離線功能強化**：
   - BL1層原生支援離線邏輯
   - 本地資料處理能力
   - 智慧同步機制

### 6.2 業務優勢
1. **平台特化**：
   - APP端：豐富功能與離線支援
   - LINE OA端：簡潔快速的對話式記帳

2. **使用者體驗**：
   - APP端更流暢的操作體驗
   - LINE OA端更即時的回應

3. **功能差異化**：
   - 各平台可獨立演進
   - 特定需求的客製化實作

---

## 7. 挑戰與風險

### 7.1 技術挑戰
1. **業務邏輯同步**：
   - BL1與BL2的邏輯一致性維護
   - 共用業務規則的管理機制
   - 資料模型的統一標準

2. **API標準化問題**：
   - 失去APL層的統一API介面
   - 需要重新設計Express端點
   - 版本控制與相容性管理

3. **代碼重複風險**：
   - BL1與BL2可能存在重複邏輯
   - 維護成本可能增加
   - 需要建立共用函式庫

### 7.2 實作風險
1. **遷移複雜度**：
   - 大量現有代碼需要重構
   - 測試覆蓋範圍重新建立
   - 可能的功能中斷風險

2. **團隊適應**：
   - 開發團隊需要學習新架構
   - 開發流程與規範調整
   - 文件與培訓需求

3. **第三方整合**：
   - 失去標準RESTful API
   - 影響未來第三方系統整合
   - API文件化挑戰

---

## 8. 實作策略建議

### 8.1 分階段實作計劃

#### Phase 1：核心架構建立（4週）
- 建立BL1層基礎架構
- 實作核心記帳邏輯
- 建立HTTP客戶端
- PL層簡化重構

#### Phase 2：業務邏輯遷移（6週）
- 將APL層業務邏輯移至BL1
- 建立離線功能支援
- 實作四模式差異化邏輯
- 資料同步機制建立

#### Phase 3：整合與測試（4週）
- 端到端功能測試
- 效能最佳化
- 安全性驗證
- 使用者驗收測試

### 8.2 技術實作重點

#### 8.2.1 共用邏輯管理
```dart
// 建立共用業務邏輯核心
abstract class CoreBusinessLogic {
  // 通用記帳邏輯
  // 資料驗證規則
  // 計算與統計邏輯
}

// BL1與BL2分別實作平台特定邏輯
class AppBusinessLogic extends CoreBusinessLogic {
  // APP特定邏輯
}

class LineOABusinessLogic extends CoreBusinessLogic {
  // LINE OA特定邏輯
}
```

#### 8.2.2 資料同步機制
- 建立統一的資料模型
- 實作智慧衝突解決
- 建立同步狀態管理
- 提供離線隊列機制

---

## 9. 遷移路徑規劃

### 9.1 從v1到v2的遷移策略

#### 9.1.1 漸進式遷移
1. **並行開發**：
   - 保持v1架構運作
   - 並行開發v2架構
   - 功能逐步遷移驗證

2. **功能驗證**：
   - 核心功能優先遷移
   - 完整測試驗證
   - 使用者反饋收集

3. **切換時機**：
   - 達到功能同等性
   - 效能指標優於v1
   - 使用者接受度驗證

#### 9.1.2 風險控制措施
- 保留v1架構作為備援
- 建立功能開關機制
- 實作資料遷移工具
- 準備快速回滾方案

### 9.2 現有投資保護
1. **代碼重用**：
   - 保留可重用的業務邏輯
   - 轉換資料模型定義
   - 重新包裝現有函式

2. **經驗延續**：
   - 保持開發團隊經驗
   - 延續測試方法論
   - 維持品質標準

---

## 10. 技術決策記錄

### 10.1 核心決策

#### ADR-001：移除APL層
**決策**：在v2架構中完全移除APP端的APL層  
**理由**：簡化架構、提升效能、降低維護成本  
**影響**：需要重新設計PL-BL1-Express通信機制  

#### ADR-002：分離業務邏輯
**決策**：APP端(BL1)與LINE OA端(BL2)分別實作業務邏輯  
**理由**：平台特化、功能差異化、開發效率  
**影響**：需要建立共用邏輯管理機制  

#### ADR-003：直接通信模式
**決策**：APP端直接與Express服務器通信  
**理由**：減少中間層、提升回應速度、簡化除錯  
**影響**：需要重新設計API端點與通信協定  

### 10.2 待決策事項
1. **共用邏輯實作方式**：核心函式庫 vs 服務化
2. **資料同步策略**：即時同步 vs 批次同步
3. **API版本管理**：如何維持第三方整合能力
4. **測試策略調整**：單元測試與整合測試重新設計

---

## 結論

技術架構v2代表了LCAS 2.0系統架構的重大革新，通過簡化層級結構、增強平台特化能力、提升開發效率，期望為使用者提供更優質的產品體驗。

雖然面臨遷移挑戰與技術風險，但透過謹慎的實作策略與分階段執行計劃，v2架構有望成為更適合LCAS 2.0長期發展的技術基礎。

**下一步行動**：
1. 團隊技術可行性評估
2. 詳細實作計劃制定
3. 原型驗證開發
4. 利害關係人決策會議

---

> **備註**：本文件為技術架構v2的概念性設計備忘錄，實際實作前需要進行更詳細的技術評估與利害關係人討論。所有技術決策應基於專案實際需求與資源限制進行調整。
