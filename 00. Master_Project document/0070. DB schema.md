# 0070. DB schema

**版本**: 1.0.3  
**建立日期**: 2025-12-11  
**建立者**: AustinLiao69  
**最後更新**: 2025-12-24 

**修訂筆記：1. 須補transactions子集合
2. UID可以是lineUID、androidUID、email、iosUID
3. 需寫一個隨機UID生成器，使lineUID、androidUID、email、iosUID註冊後在firestore DB隨機生成UID**


________________________________________
## 目次 (Table of Contents)

1. [概述 (Overview)](#1-概述-overview)
   - 1.1 [資料庫類型與架構](#11-資料庫類型與架構)
   - 1.2 [核心模組架構](#12-核心模組架構)
   - 1.3 [架構原則](#13-架構原則)

2. [命名規範 (Naming Conventions)](#2-命名規範-naming-conventions)
   - 2.1 [集合與文檔命名](#21-集合與文檔命名)
   - 2.2 [欄位命名規則](#22-欄位命名規則)
   - 2.3 [參考標識符規範](#23-參考標識符規範)

3. [全域規則 (Global Rules)](#3-全域規則-global-rules)
   - 3.1 [必要欄位規範](#31-必要欄位規範)
   - 3.2 [資料類型規範](#32-資料類型規範)
   - 3.3 [狀態管理規範](#33-狀態管理規範)

4. [集合架構 (Collections Schema)](#4-集合架構-collections-schema)
   - 4.1 [AM模組 - 帳號管理](#41-am模組---帳號管理)
   - 4.2 [核心帳本架構](#42-核心帳本架構)
   - 4.3 [WCM模組 - 帳戶與科目管理](#43-wcm模組---帳戶與科目管理)
   - 4.4 [BM模組 - 預算管理](#44-bm模組---預算管理)
   - 4.5 [CM模組 - 協作管理](#45-cm模組---協作管理)
   - 4.6 [系統配置集合](#46-系統配置集合)

5. [關聯架構 (Relations)](#5-關聯架構-relations)
   - 5.1 [主要關聯關係](#51-主要關聯關係)
   - 5.2 [模組間資料流](#52-模組間資料流)

6. [驗證規則 (Validation Rules)](#6-驗證規則-validation-rules)
   - 6.1 [使用者類型驗證](#61-使用者類型驗證)
   - 6.2 [權限等級驗證](#62-權限等級驗證)
   - 6.3 [業務邏輯驗證](#63-業務邏輯驗證)

7. [資料生命週期 (Lifecycle)](#7-資料生命週期-lifecycle)
   - 7.1 [狀態轉換規則](#71-狀態轉換規則)
   - 7.2 [模組特定週期](#72-模組特定週期)

8. [索引配置 (Indexes)](#8-索引配置-indexes)
   - 8.1 [效能最佳化索引](#81-效能最佳化索引)
   - 8.2 [複合查詢索引](#82-複合查詢索引)

9. [刪除](#9-版本歷程-versioning)

10. [安全考量 (Security Considerations)](#10-安全考量-security-considerations)

---

## 1. 概述 (Overview)

### 1.1 資料庫類型與架構
**Database Type**: Firestore (NoSQL, document-based)  
**Structure Style**: Collections → Documents → Subcollections  
**Version**: v2.0  
**Last Update**: 2025-12-11  
**Maintainers**: LCAS PM Team  

### 1.2 核心模組架構
LCAS 2.0 採用 Firestore 作為主要資料庫，支援四大核心模組：
- **AM** (Account Management) - 帳號管理和帳本基礎結構初始化模組（專注首本帳本）
- **BM** (Budget Management) - 預算管理模組  
- **CM** (Collaboration Management) - 協作與帳本管理模組（整合MLS功能，管理所有後續帳本）
- **WCM** (Wallet and Category Management) - 帳戶與科目管理模組（已整合AM模組的科目初始化功能及預設帳戶建立功能）

### 1.3 架構原則
• 每個主集合都使用自動生成的 ID 或有意義的 ID  
• 嚴格區分主集合與子集合，**完全禁用頂層budgets集合**，強制使用子集合架構  
• 所有時間欄位使用 Firestore Timestamp  
• 所有 module 都必須維護 backward compatibility  
• 支援跨平台帳號統一管理 (LINE/iOS/Android)  
• 動態路徑解析支援獨立帳本和協作帳本  
• 配置來源統一使用03. Default_config資料夾  

________________________________________

## 2. 命名規範 (Naming Conventions)

### 2.1 集合與文檔命名
**Collections**: camelCase  
**Documents**: autoId 或 meaningfulId (如 user_email 格式)  

### 2.2 欄位命名規則
**Fields**: camelCase  
**Timestamps**: createdAt, updatedAt  

### 2.3 參考標識符規範
**User Reference**: userId, UID  
**Ledger Reference**: ledgerId  
**Platform Prefix**: lineUID, iosUID, androidUID  

________________________________________

## 3. 全域規則 (Global Rules)

### 3.1 必要欄位規範
• 所有 document 必須包含 createdAt
• 所有可修改 document 必須包含 updatedAt  

### 3.2 資料類型規範
• Boolean 一律使用 true / false
• 避免 null（使用空字串、空物件、空陣列）

### 3.3 狀態管理規範
• status 欄位必須為 enum：active / archived / deleted / inactive / suspended
• 用戶類型統一使用：M (Master) / S (Single) / J (Joined)
• 所有模組操作必須記錄 module 和 version 資訊

________________________________________

## 4. 集合架構 (Collections Schema)

### 4.1 集合：使用者

### 4.1.1 Collection: users
**Document ID**: UID（來自 Firebase Auth 或統一生成）

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 用戶唯一識別碼 | primary key |
| displayName | string | optional | 用戶顯示名稱 | max 50 chars |
| userType | string | required | 用戶類型 | enum: M/S/J |
?| email | string | optional | 電子郵件 | unique when present |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| lastActive | timestamp | optional | 最後活動時間 | |
| timezone | string | optional | 時區設定 | default: Asia/Taipei |
| linkedAccounts | object | optional | 跨平台帳號關聯 | see below |
| settings | object | optional | 用戶設定 | see below |
| joinedLedgers | array | optional | 參與的帳本清單 | |
| metadata | object | optional | 元數據 | source, profilePicture, etc |
?| ledgerId | string | optional | 預設帳本ID | |
?| accountStatus | string | required | 帳號狀態 | enum: active/suspended/deleted |
?| userMode | string | optional | 用戶模式 | |

**Substructures**:
```javascript
linkedAccounts: {
  lineUID: string,
  iosUID: string,
  androidUID: string
}

settings: {
  notifications: boolean,
  language: string
}

metadata: {
  source: string,        // 來源平台
  profilePicture: string,
  appVersion: string,
  deviceInfo: object
}
```

### 4.2 集合：帳本

#### 4.2.1 Collection: ledgers
**Document ID**: ledgerId（user_UID）
**Collection Path**: `ledgers/{ledgerId}`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 錢包、帳戶
**配置來源**: `0302. Default_wallet.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| id | string | required | 帳本ID | primary key |
| name | string | required | 帳本名稱 | max 50 chars |
| owner | string | required | 擁有者ID | must exist in users |
| type | string | required | 帳本類型 | enum: personal/shared/project/category |
| userId | string | required | 用戶ID | |
| description | string | optional | 描述 | |
| status | string | required | 狀態 | enum: active/archived |
| initializationComplete | boolean | required | 初始化完成標誌 | |
| categoryCount | number | optional | 科目數量 | |
| walletCount | number | optional | 帳戶數量 | |
| settings | object | optional | 設定 | see below |
| metadata | object | optional | 元數據 | see below |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

**Substructures**:
```javascript
settings: {
  currency: string,      // 預設貨幣
  timezone: string,      // 時區
  dateFormat: string,    // 日期格式
  language: string       // 語言
}

metadata: {
  version: string,
  createdBy: string,
  initializationStage: string
}
```

**Subcollections**:
| Subcollection | Description |
|---------------|-------------|
| wallets | 帳戶列表 (WCM模組管理) |
| categories | 科目列表 (WCM模組管理) |
| budgets | 預算設定 (BM模組管理) |
| transactions | 交易記錄 |
| pendingTransactions | 暫存記帳資料 (LBK模組管理) |

#### 4.2.1.1 Subcollection: ledgers/{ledgerId}/wallets
**Document ID**: ledgerId（user_UID）
**Subcollection Path**: `ledgers/{ledgerId}/wallets`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 錢包、帳戶
**配置來源**: `0302. Default_wallet.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| walletId | string | required | 帳戶ID | primary key |
| walletName | string | required | 帳戶名稱 | max 50 chars |
| subWalletId | string | required | 子帳戶ID | default: TWD |
| subWalletName | string | required | 子帳戶名稱 | default: TWD |
| currency | string | required | 貨幣單位 | default: TWD |
| balance | number | required | 帳戶餘額 | |
| synonyms | string | optional | 同義詞 | |
| isDefault | boolean | optional | 是否為預設帳戶 | |
| userId | string | required | 用戶ID | |
| ledgerId | string | required | 帳本ID | |
| status | string | required | 狀態 | enum: active/inactive |
| dataSource | string | optional | 資料來源 | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

#### 4.2.1.2 Subcollection: ledgers/{ledgerId}/categories
**Subcollection Path**: `ledgers/{ledgerId}/categories`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 科目
**配置來源**: `0099. Subject_code.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| id | string | required | 科目ID | primary key |
| subCategoryId | string | required | 子科目代碼 | |
| categoryId | string/number | optional | 父科目ID | |
| categoryName | string | required | 科目名稱 | |
| subCategoryName | string | optional | 子科目名稱 | |
| synonyms | string | optional | 同義詞 | comma separated |
| transactionType | string | required | 科目類型 | enum: income/expense |
| level | number | optional | 科目層級 | |
| color | string | optional | 顏色代碼 | |
| icon | string | optional | 圖示 | |
| description | string | optional | 描述 | |
| isDefault | boolean | optional | 是否為預設科目 | |
| isActive | boolean | required | 是否啟用 | |
| userId | string | required | 用戶ID | |
| ledgerId | string | required | 帳本ID | |
| status | string | required | 狀態 | enum: active/inactive |
| dataSource | string | optional | 資料來源 | 0099. Subject_code.json |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

#### 4.2.1.3 Subcollection: ledgers/{ledgerId}/pendingTransactions
**Subcollection Path**: `ledgers/{ledgerId}/pendingTransactions`
**管理模組**: LBK (快速記帳模組)
**用途**: 暫存多階段處理的記帳資料，支援科目與支付方式歸類邏輯
**配置來源**: `0305. Default_pendingTransaction.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| pendingId | string | required | 暫存記錄唯一識別碼 | primary key, Date.now().toString() |
| userId | string | required | 用戶ID | must exist in users |
| ledgerId | string | required | 帳本ID | must match parent ledger |
| originalInput | string | required | 用戶原始輸入 | max 200 chars, e.g. "火鍋66666新光" |
| parsedData | object | required | 已解析的資料 | see below |
| processingStage | string | required | 處理階段 | enum: PENDING_CATEGORY/PENDING_WALLET/COMPLETED/CANCELLED |
| stageData | object | optional | 階段資料 | see below |
| ambiguityInfo | object | optional | 歸類邏輯資訊 | see below |
| metadata | object | required | 元數據 | see below |
| status | string | required | 記錄狀態 | enum: active/completed/cancelled/expired |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| expiresAt | timestamp | required | 過期時間 | default: createdAt + 30 minutes |
| completedTransactionId | string | optional | 完成後的交易ID | 轉換為正式交易後的ID |
| completedAt | timestamp | optional | 完成時間 | |

**Substructures**:
```javascript
parsedData: {
  amount: number,           // 已解析的金額
  description: string,      // 描述資訊
  rawCategory: string,       // 原始科目關鍵字
  rawWallet: string         // 原始支付方式關鍵字
}

stageData: {
  categorySelected: boolean,     // 科目是否已選擇
  walletSelected: boolean,      // 錢包是否已選擇
  selectedCategory: {            // 已選擇的科目資訊
    categoryId: string,          // 科目ID (主鍵)
    categoryName: string         // 科目名稱
  },
  selectedWallet: {             // 已選擇的錢包資訊
    walletId: string,           // 錢包ID (對應wallets.walletId)
    walletName: string,         // 錢包名稱
  }
}

ambiguityInfo: {
  currentAmbiguity: string,     // 當前歸類類型: category/wallet/none
  categoryOptions: array,        // 科目選項列表
  walletOptions: array          // 支付方式選項列表
}

metadata: {
  source: string,               // 來源平台 (default: LINE)
  module: string,               // 處理模組 (default: LBK)
  version: string,              // 模組版本
  processId: string,            // 處理ID
  pendingId: string,            // Pending Record ID
  completionSource: string      // 完成來源標識
}
```

**State Machine**:
```
PENDING_CATEGORY → PENDING_WALLET → COMPLETED
PENDING_CATEGORY → COMPLETED (直接完成)
任何狀態 → CANCELLED (用戶取消)
```

**Business Rules**:
- 記錄預設30分鐘後過期，最多可延長至120分鐘
- 過期記錄自動清理，保留7天歷史記錄
- 狀態轉換必須符合定義的轉換規則
- COMPLETED 狀態的記錄將轉換為正式交易記錄
- 支援科目與支付方式的歸類邏輯
- 與 wallets 子集合建立 walletId 外鍵關聯
- 與 categories 子集合建立 categoryId 外鍵關聯

**Integration Points**:
- **Reference Collections**: `ledgers/{ledgerId}/categories` (科目解析), `ledgers/{ledgerId}/wallets` (支付方式解析)
- **Target Collection**: `ledgers/{ledgerId}/transactions` (完成後轉換目標)
- **Event Triggers**: onCreate (設定過期時間), onUpdate (驗證狀態轉換), onExpire (清理過期記錄)
- **Synonym Learning**: 支援科目與支付方式的同義詞學習機制

#### 4.2.1.4 Subcollection: ledgers/{ledgerId}/budgets
**Subcollection Path**: `ledgers/{ledgerId}/budgets`
**管理模組**: BM (預算管理)
**用途**: 預算管理
**配置來源**: `無`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| budgetId | string | required | 預算唯一識別碼 | primary key |
| ledgerId | string | required | 帳本ID | |
| budgetName | string | required | 預算名稱 | |
| budgetType | string | required | 預算類型 | enum: monthly/yearly/quarterly/project/category |
| amount | number | required | 預算總金額 | |
| consumedAmount | number | required | 已使用金額 | |
| currency | string | required | 貨幣單位 | default: TWD |
| budgetStartdate | timestamp/date | required | 預算開始時間 | |
| budgetEnddate | timestamp/date | required | 預算結束時間 | |
| budgetCategories | array | optional | 預算分類配置 | |
| alertRules | object | required | 警示規則設定 | see below |
| userId | string | required | 使用者ID | |
| createdBy | string | required | 建立者ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| budgetStatus | string | required | 預算狀態 | enum: active/completed/archived |
| config_source | string | optional | 配置來源 | |
| module | string | required | 模組標識 | default: BM |
| version | string | required | 版本號 | |

**Substructures**:
```javascript
alert_rules: {
  warning_threshold: number,      // 警告閾值 (%)
  critical_threshold: number,     // 嚴重閾值 (%)
  enable_notifications: boolean   // 啟用通知
}

categories: [
  {
    id: string,
    name: string,
    allocated_amount: number,
    used_amount: number,
    percentage: number,
    alert_threshold: number
  }
]
```

#### 4.2.1.5 Subcollection: ledgers/{ledgerId}/transactions(待新增)
**Subcollection Path**: `ledgers/{ledgerId}/transactions`
**管理模組**: LBK (快速記帳模組)
**用途**: 快速記帳模組
**配置來源**: `無`

### 4.3 集合：協作管理

#### 4.3.1 Collection: collaborations
**Document ID**: ledgerId

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| ledgerId | string | required | 帳本ID | primary key |
| ownerId | string | required | 帳本擁有者ID | |
| collaborationType | string | required | 協作類型 | enum: shared/project/category |
| status | string | required | 協作狀態 | enum: active/archived/suspended |
| members | array | required | 成員清單 | see below |
| settings | object | required | 協作設定 | see below |
| permissions | object | optional | 權限配置 | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

**Substructures**:
```javascript
members: [
  {
    memberId: string,
    userId: string,
    permissionLevel: string,    // owner/admin/member/viewer
    joinedAt: timestamp,
    invitedBy: string,
    status: string             // active/invited/suspended
  }
]

settings: {
  allowInvite: boolean,
  allowEdit: boolean,
  allowDelete: boolean,
  requireApproval: boolean,
  maxMembers: number,
  invitationExpireDays: number
}

permissions: {
  owner: string,
  admins: array,
  members: array,
  viewers: array
}
```

**Subcollections**:
| Subcollection | Description |
|---------------|-------------|
| members | 成員管理子集合 |
| invitations | 邀請管理子集合 |

#### 4.3.1.1 Subcollection: collaborations/{ledgerId}/members
**Collection Path**: `collaborations/{ledgerId}/members`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| userId | string | required | 用戶唯一識別碼 | primary key |
| email | string | optional | 用戶電子郵件 | |
| role | string | required | 角色 | enum: owner/admin/member/viewer |
| permissions | object | optional | 權限設定 | |
| joinedAt | timestamp | required | 加入時間 | |
| status | string | required | 成員狀態 | enum: active/invited/suspended |
| createdAt | timestamp | required | 創建時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| createdBy | string | required | 創建者 | |

#### 4.3.1.2 Subcollection: collaborations/{ledgerId}/invitations
**Collection Path**: `collaborations/{ledgerId}/invitations`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| invitationId | string | required | 邀請唯一識別碼 | primary key |
| inviterId | string | required | 邀請者ID | |
| inviteeEmail | string | required | 被邀請者email | |
| role | string | required | 預設角色 | |
| status | string | required | 邀請狀態 | enum: pending/accepted/declined/expired |
| createdAt | timestamp | required | 建立時間 | |
| expiresAt | timestamp | required | 邀請過期時間 | |

#### 4.3.1.3 Subcollection: ledgers/{ledgerId}/wallets
**Subcollection Path**: `ledgers/{ledgerId}/wallets`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 錢包、帳戶
**配置來源**: `0302. Default_wallet.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| walletId | string | required | 帳戶ID | primary key |
| walletName | string | required | 帳戶名稱 | max 50 chars |
| subWalletId | string | required | 子帳戶ID | default: TWD |
| subWalletName | string | required | 子帳戶名稱 | default: TWD |
| currency | string | required | 貨幣單位 | default: TWD |
| balance | number | required | 帳戶餘額 | |
| synonyms | string | optional | 同義詞 | |
| isDefault | boolean | optional | 是否為預設帳戶 | |
| userId | string | required | 用戶ID | |
| ledgerId | string | required | 帳本ID | |
| status | string | required | 狀態 | enum: active/inactive |
| dataSource | string | optional | 資料來源 | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

#### 4.3.1.4 Subcollection: ledgers/{ledgerId}/categories
**Subcollection Path**: `ledgers/{ledgerId}/categories`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 科目
**配置來源**: `0099. Subject_code.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| id | string | required | 科目ID | primary key |
| subCategoryId | string | required | 子科目代碼 | |
| categoryId | string/number | optional | 父科目ID | |
| categoryName | string | required | 科目名稱 | |
| subCategoryName | string | optional | 子科目名稱 | |
| synonyms | string | optional | 同義詞 | comma separated |
| transactionType | string | required | 科目類型 | enum: income/expense |
| level | number | optional | 科目層級 | |
| color | string | optional | 顏色代碼 | |
| icon | string | optional | 圖示 | |
| description | string | optional | 描述 | |
| isDefault | boolean | optional | 是否為預設科目 | |
| isActive | boolean | required | 是否啟用 | |
| userId | string | required | 用戶ID | |
| ledgerId | string | required | 帳本ID | |
| status | string | required | 狀態 | enum: active/inactive |
| dataSource | string | optional | 資料來源 | 0099. Subject_code.json |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

#### 4.3.1.5 Subcollection: ledgers/{ledgerId}/pendingTransactions
**Subcollection Path**: `ledgers/{ledgerId}/pendingTransactions`
**管理模組**: LBK (快速記帳模組)
**用途**: 暫存多階段處理的記帳資料，支援科目與支付方式歸類邏輯
**配置來源**: `0305. Default_pendingTransaction.json`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| pendingId | string | required | 暫存記錄唯一識別碼 | primary key, Date.now().toString() |
| userId | string | required | 用戶ID | must exist in users |
| ledgerId | string | required | 帳本ID | must match parent ledger |
| originalInput | string | required | 用戶原始輸入 | max 200 chars, e.g. "火鍋66666新光" |
| parsedData | object | required | 已解析的資料 | see below |
| processingStage | string | required | 處理階段 | enum: PENDING_CATEGORY/PENDING_WALLET/COMPLETED/CANCELLED |
| stageData | object | optional | 階段資料 | see below |
| ambiguityInfo | object | optional | 歸類邏輯資訊 | see below |
| metadata | object | required | 元數據 | see below |
| status | string | required | 記錄狀態 | enum: active/completed/cancelled/expired |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| expiresAt | timestamp | required | 過期時間 | default: createdAt + 30 minutes |
| completedTransactionId | string | optional | 完成後的交易ID | 轉換為正式交易後的ID |
| completedAt | timestamp | optional | 完成時間 | |

**Substructures**:
```javascript
parsedData: {
  amount: number,           // 已解析的金額
  description: string,      // 描述資訊
  rawCategory: string,       // 原始科目關鍵字
  rawWallet: string         // 原始支付方式關鍵字
}

stageData: {
  categorySelected: boolean,     // 科目是否已選擇
  walletSelected: boolean,      // 錢包是否已選擇
  selectedCategory: {            // 已選擇的科目資訊
    categoryId: string,          // 科目ID (主鍵)
    categoryName: string         // 科目名稱
  },
  selectedWallet: {             // 已選擇的錢包資訊
    walletId: string,           // 錢包ID (對應wallets.walletId)
    walletName: string,         // 錢包名稱
  }
}

ambiguityInfo: {
  currentAmbiguity: string,     // 當前歸類類型: category/wallet/none
  categoryOptions: array,        // 科目選項列表
  walletOptions: array          // 支付方式選項列表
}

metadata: {
  source: string,               // 來源平台 (default: LINE)
  module: string,               // 處理模組 (default: LBK)
  version: string,              // 模組版本
  processId: string,            // 處理ID
  pendingId: string,            // Pending Record ID
  completionSource: string      // 完成來源標識
}
```

**State Machine**:
```
PENDING_CATEGORY → PENDING_WALLET → COMPLETED
PENDING_CATEGORY → COMPLETED (直接完成)
任何狀態 → CANCELLED (用戶取消)
```

**Business Rules**:
- 記錄預設30分鐘後過期，最多可延長至120分鐘
- 過期記錄自動清理，保留7天歷史記錄
- 狀態轉換必須符合定義的轉換規則
- COMPLETED 狀態的記錄將轉換為正式交易記錄
- 支援科目與支付方式的歸類邏輯
- 與 wallets 子集合建立 walletId 外鍵關聯
- 與 categories 子集合建立 categoryId 外鍵關聯

**Integration Points**:
- **Reference Collections**: `ledgers/{ledgerId}/categories` (科目解析), `ledgers/{ledgerId}/wallets` (支付方式解析)
- **Target Collection**: `ledgers/{ledgerId}/transactions` (完成後轉換目標)
- **Event Triggers**: onCreate (設定過期時間), onUpdate (驗證狀態轉換), onExpire (清理過期記錄)
- **Synonym Learning**: 支援科目與支付方式的同義詞學習機制

#### 4.3.1.6 Subcollection: ledgers/{ledgerId}/budgets
**Subcollection Path**: `ledgers/{ledgerId}/budgets`
**管理模組**: BM (預算管理)
**用途**: 預算管理
**配置來源**: `無`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| budgetId | string | required | 預算唯一識別碼 | primary key |
| ledgerId | string | required | 帳本ID | |
| budgetName | string | required | 預算名稱 | |
| budgetType | string | required | 預算類型 | enum: monthly/yearly/quarterly/project/category |
| amount | number | required | 預算總金額 | |
| consumedAmount | number | required | 已使用金額 | |
| currency | string | required | 貨幣單位 | default: TWD |
| budgetStartdate | timestamp/date | required | 預算開始時間 | |
| budgetEnddate | timestamp/date | required | 預算結束時間 | |
| budgetCategories | array | optional | 預算分類配置 | |
| alertRules | object | required | 警示規則設定 | see below |
| userId | string | required | 使用者ID | |
| createdBy | string | required | 建立者ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| budgetStatus | string | required | 預算狀態 | enum: active/completed/archived |
| config_source | string | optional | 配置來源 | |
| module | string | required | 模組標識 | default: BM |
| version | string | required | 版本號 | |

**Substructures**:
```javascript
alert_rules: {
  warning_threshold: number,      // 警告閾值 (%)
  critical_threshold: number,     // 嚴重閾值 (%)
  enable_notifications: boolean   // 啟用通知
}

categories: [
  {
    id: string,
    name: string,
    allocated_amount: number,
    used_amount: number,
    percentage: number,
    alert_threshold: number
  }
]
```

#### 4.3.1.7 Subcollection: ledgers/{ledgerId}/transactions(待新增)
**Subcollection Path**: `ledgers/{ledgerId}/transactions`
**管理模組**: LBK (快速記帳模組)
**用途**: 快速記帳模組
**配置來源**: `無`

### 4.4 集合：系統配置

#### 4.6.1 Collection: _system
**Document ID**: config_name

用於儲存各種系統架構定義、預設設定配置、模組結構配置等文檔。

**重要配置來源**: 所有預設配置來自**03. Default_config資料夾**，包括：
- `0301. Default_config.json` - 系統主要配置
- `0302. Default_wallet.json` - 預設帳戶配置  
- `0303. Default_currency.json` - 預設貨幣配置
- `0304. Default_assessment.json` - 預設評估配置
- `0305. Default_pendingTransaction.json` - Pending Record預設配置
- `0099. Subject_code.json` - 科目代碼配置

**動態路徑解析機制**: 支援WCM和BM模組的動態路徑解析功能，自動識別：
- 獨立帳本路徑：`ledgers/{ledgerId}/wallets` 或 `ledgers/{ledgerId}/budgets`
- 協作帳本路徑：`collaborations/{ledgerId}/members/{memberId}/wallets` 或類似結構

## 5. 關聯架構 (Relations)

### 5.1 主要關聯關係
• **users.UID** → **ledgers.owner**
• **users.UID** → **ledgers.userId**  
• **users.UID** → **collaborations.ownerId**
• **users.UID** → **collaborations.members.userId**
• **ledgers.id** → **collaborations.ledgerId**
• **ledgers.id** → **budgets.ledgerId**
• **ledgers.id** → **wallets.ledgerId**
• **ledgers.id** → **categories.ledgerId**

### 5.2 模組間資料流
```
users (1) ——— (many) ledgers
users (1) ——— (many) collaborations
ledgers (1) ——— (many) wallets
ledgers (1) ——— (many) categories  
ledgers (1) ——— (many) budgets
collaborations (1) ——— (many) members
collaborations (1) ——— (many) invitations
```

________________________________________

## 6. 驗證規則 (Validation Rules)

### 6.1 使用者類型驗證
- userType 必須為 M/S/J 之一
- M 類型：可建立多個帳本，具管理權限
- S 類型：單一帳本用戶
- J 類型：僅可加入他人帳本

### 6.2 權限等級驗證
- owner: level 4, actions: ["all"]
- admin: level 3, actions: ["invite", "remove", "edit", "view", "manage_permissions"]  
- member: level 2, actions: ["edit", "view", "invite_limited"]
- viewer: level 1, actions: ["view"]

### 6.3 業務邏輯驗證
- amount 必須 > 0
- consumedAmount >= 0
- consumedAmount <= amount * 1.5 (允許超支 50%)
- budgetStartdate < budgetEnddate

________________________________________

## 7. 資料生命週期 (Lifecycle)

### 7.1 狀態轉換規則

#### 用戶狀態
```
active → suspended → deleted
active → deleted (直接刪除)
```

#### 帳本狀態  
```
active → archived → deleted
```

### 7.2 模組特定週期

#### 協作狀態
```
active → suspended → archived
active → archived (正常結束)
```

#### 預算狀態
```
active → completed → archived
active → archived (提前結束)
```

________________________________________

## 8. 索引配置 (Indexes)

### 8.1 效能最佳化索引

#### 複合索引
```javascript
// collaborations
{
  "collectionGroup": "collaborations",
  "fields": [
    {"fieldPath": "ledgerId", "order": "ASCENDING"},
    {"fieldPath": "userId", "order": "ASCENDING"}, 
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// budgets
{
  "collectionGroup": "budgets", 
  "fields": [
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "budgetStartdate", "order": "ASCENDING"}
  ]
}
```

### 8.2 複合查詢索引
```javascript
// wallets
{
  "collectionGroup": "wallets",
  "fields": [
    {"fieldPath": "userId", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// categories  
{
  "collectionGroup": "categories",
  "fields": [
    {"fieldPath": "userId", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 基本查詢索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "userId", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "processingStage", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 過期記錄清理索引
{
  "collectionGroup": "pendingTransactions", 
  "fields": [
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "expiresAt", "order": "ASCENDING"}
  ]
}

// pendingTransactions - 狀態機轉換索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "userId", "order": "ASCENDING"},
    {"fieldPath": "processingStage", "order": "ASCENDING"},
    {"fieldPath": "updatedAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 歸類邏輯索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "userId", "order": "ASCENDING"},
    {"fieldPath": "ambiguityInfo.currentAmbiguity", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// users
{
  "collectionGroup": "users",
  "fields": [
    {"fieldPath": "userType", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}
```

________________________________________

## 9. 刪除

## 10. 安全考量 (Security Considerations)

### 10.1 存取權限
- 用戶僅可存取自己的 ledgers 和相關子集合
- 協作帳本依據 members 權限等級控制存取
- 系統管理員可存取 _system 集合

### 10.2 資料隔離
- 每個 ledger 的子集合完全隔離
- 跨平台帳號關聯需要驗證
- 敏感資訊 (如 device info) 需加密儲存

### 10.3 審計追蹤
- 所有重要操作記錄於 collaboration_logs
- 模組操作包含 module 和 version 資訊
- 保留完整的時間戳追蹤

---

**文件狀態**: v2.0 - 生產就緒  
**維護責任**: LCAS 技術團隊  
**更新週期**: 每季 review，重大變更即時更新