# 0070. DB schema

**版本**: 1.0.6  
**建立日期**: 2025-12-11  
**建立者**: AustinLiao69  
**最後更新**: 2025-12-31 

*修訂筆記：*
1. 須補transactions子集合  
2. UID可以是lineUID、androidUID、email、iosUID，需做連結  
3. 需寫一個隨機UID生成器，使lineUID、androidUID、email、iosUID註冊後在firestore DB隨機生成UID
4. 每個document必定要有的欄位是：UID、ledgerId、createdAt、updatedAt、status
________________________________________
# 目次 (Table of Contents)

1. [概述 (Overview)](#1-概述-overview)
   - 1.1 [資料庫類型與架構](#11-資料庫類型與架構)
   - 1.2 [核心模組架構](#12-核心模組架構)
   - 1.3 [架構原則](#13-架構原則)

2. [命名規範 (Naming Conventions)](#2-命名規範-naming-conventions)
   - 2.1 [集合與文檔命名](#21-集合與文檔命名)
   - 2.2 [欄位命名規則](#22-欄位命名規則)
   - 2.3 [參考標識符規範](#23-參考標識符規範)

3. [全域規則 (Global Rules)](#3-全域規則-global-rules)
   - 3.1 [必要欄位規範](#31-必要欄位規範)
   - 3.2 [資料類型規範](#32-資料類型規範)
   - 3.3 [狀態管理規範](#33-狀態管理規範)

4. [集合架構 (Collections Schema)](#4-集合架構-collections-schema)
   - 4.1 [AM模組 - 帳號管理](#41-am模組---帳號管理)
   - 4.2 [核心帳本架構](#42-核心帳本架構)
   - 4.3 [WCM模組 - 帳戶與科目管理](#43-wcm模組---帳戶與科目管理)
   - 4.4 [BM模組 - 預算管理](#44-bm模組---預算管理)
   - 4.5 [CM模組 - 協作管理](#45-cm模組---協作管理)
   - 4.6 [系統配置集合](#46-系統配置集合)

5. [關聯架構 (Relations)](#5-關聯架構-relations)
   - 5.1 [主要關聯關係](#51-主要關聯關係)
   - 5.2 [模組間資料流](#52-模組間資料流)

6. [驗證規則 (Validation Rules)](#6-驗證規則-validation-rules)
   - 6.1 [使用者類型驗證](#61-使用者類型驗證)
   - 6.2 [權限等級驗證](#62-權限等級驗證)
   - 6.3 [業務邏輯驗證](#63-業務邏輯驗證)

7. [資料生命週期 (Lifecycle)](#7-資料生命週期-lifecycle)
   - 7.1 [狀態轉換規則](#71-狀態轉換規則)
   - 7.2 [模組特定週期](#72-模組特定週期)

8. [索引配置 (Indexes)](#8-索引配置-indexes)
   - 8.1 [效能最佳化索引](#81-效能最佳化索引)
   - 8.2 [複合查詢索引](#82-複合查詢索引)

9. [刪除](#9-版本歷程-versioning)

10. [安全考量 (Security Considerations)](#10-安全考量-security-considerations)

---

# 1. (待改)概述 (Overview)

### 1.1 資料庫類型與架構
**Database Type**: Firestore (NoSQL, document-based)  
**Structure Style**: Collections → Documents → Subcollections → Documents 

### 1.2 核心模組架構
LCAS 2.0 採用 Firestore 作為主要資料庫，支援四大核心模組：
- **AM** (Account Management) - 帳號管理和帳本基礎結構初始化模組（專注首本帳本）
- **BM** (Budget Management) - 預算管理模組  
- **CM** (Collaboration Management) - 協作與帳本管理模組（整合MLS功能，管理所有後續帳本）
- **WCM** (Wallet and Category Management) - 帳戶與科目管理模組（已整合AM模組的科目初始化功能及預設帳戶建立功能）

### 1.3 架構原則
• 每個主集合都使用自動生成的 ID 或有意義的 ID  
• 嚴格區分主集合與子集合，**完全禁用頂層budgets集合**，強制使用子集合架構  
• 所有時間欄位使用 Firestore Timestamp  
• 所有 module 都必須維護 backward compatibility  
• 支援跨平台帳號統一管理 (LINE/iOS/Android)  
• 動態路徑解析支援獨立帳本和協作帳本  
• 配置來源統一使用03. Default_config資料夾  

________________________________________

# 2. (待改)命名規範 (Naming Rules)

### 2.1 集合與文檔命名
**Collections**: camelCase  
**Documents**: autoId 或 meaningfulId (如 user_email 格式)  

### 2.2 欄位命名規則
**Fields**: camelCase  
**Timestamps**: createdAt, updatedAt  

### 2.3 參考標識符規範
**User Reference**: UID  
**Ledger Reference**: ledgerId  
**Platform Prefix**: lineUID, iosUID, androidUID  

________________________________________

# 3. (待改)全域規則 (Global Rules)

### 3.1 必要欄位規範
• 所有 document 必須包含 createdAt
• 所有可修改 document 必須包含 updatedAt  

### 3.2 資料類型規範
• Boolean 一律使用 true / false

### 3.3 狀態管理規範
• status 欄位必須為 enum：active / archived / deleted / inactive / suspended
• 使用者類型統一使用：M (Master) / S (Single) / J (Joined)
• 所有模組操作必須記錄 module 和 version 資訊

________________________________________

# 4. (待改)集合架構 (Collections Schema)

## 4.1 集合：使用者

**架構**:
Collection：users
  Documents：{UID}

### 4.1.1 (待改)Document: users
**Document ID**: UID（隨機生成）
**Collection Path**: `users/UID`
**管理模組**: AM (帳號管理)
**用途**: user帳號管理
**配置來源**: `無`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | must exist in users |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| userType | string | required | 使用者類型 | enum: M/S/J |
| userMode | string | optional | 使用者模式 | |
| joinedLedgers | array | optional | 參與的帳本清單 | |
| lastActive | timestamp | optional | 最後活動時間 | |
| linkedAccounts | object | optional | 帳號連結 | see below |
| userSettings | object | optional | 使用者設定 | see below |
| userInfo | object | optional | 使用者資訊 | see below |



**Substructures**:
```javascript
linkedAccounts: {
  lineUID: string,
  iosUID: string,
  androidUID: string,
  email: string
}

userSettings: {
  notifications: boolean,
  profilePicture: string,
  language: string,
  timezone: string
}

userInfo: {
  appVersion: string,
  deviceInfo: object
}
```

## 4.2 (待改)集合：帳本

**架構**:
Collection：ledgers
  Documents：{ledgerId}
    Subcollction：wallets
    Subcollction：categories
    Subcollction：transactions
    Subcollction：budgets
    Subcollction：pendingTransactions

### 4.2.1 Document: ledgers/{ledgerId}
**Document ID**: {ledgerId}
**Document Path**: `ledgers/{ledgerId}`
**管理模組**: AM(帳號管理)
**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | must exist in users |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| ledgerSettings | object | optional | 設定 | see below |

#### 4.2.1.1 Subcollection: wallets
**Subcollection Path**: `ledgers/{ledgerId}/wallets`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 帳戶(錢包)
**配置來源**: `0302. Default_wallet.json`

##### 4.2.1.1.1 Document: ledgers/{ledgerId}/wallets/{walletId}
**Document ID**: {walletId}
**Document Path**: `ledgers/{ledgerId}/wallets/{walletId}`
**管理模組**: WCM (帳戶與科目管理)

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| walletName | string | required | 帳戶名稱 | max 50 chars |
| walletSynonyms | string | required | 同義詞 | |
| walletBalance | number | required | 帳戶餘額 | |
| walletSettings | object | optional | 帳戶設定 | see below |

**Substructures**:
```javascript
walletSettings: {
  walletInitialamount: number,     // 帳起始金額(預設；0)
  currency:string                  // 貨幣單位(預設；NTD)
}
```

#### 4.2.1.2 Subcollection: categories
**Subcollection Path**: `ledgers/{ledgerId}/categories`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 科目
**配置來源**: `0099. Subject_code.json`

##### 4.2.1.2.1 Document: ledgers/{ledgerId}/categories/{categoryId}
**Document ID**: {categoryId}
**Document Path**: `ledgers/{ledgerId}/wallets/{walletId}`
**管理模組**: WCM (帳戶與科目管理)
**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | must exist in users |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| categoryId | string/number | optional | 科目ID | |
| categoryName | string | required | 科目名稱 | |
| categorySynonyms | string | optional | 同義詞 | comma separated |
| categoryType | string | required | 科目收支類型 | enum: income/expense |

#### 4.2.1.3 Subcollection: pendingTransactions
**Subcollection Path**: `ledgers/{ledgerId}/pendingTransactions`
**管理模組**: LBK、BK (記帳管理)
**用途**: 暫存多階段處理的記帳資料，支援科目與支付方式歸類邏輯
**配置來源**: `0305. Default_pendingTransaction.json`

##### 4.2.1.3.1 (待改)Document: ledgers/{ledgerId}/pendingTransactions/{pendingId}
**Document Path**: `ledgers/{ledgerId}/pendingTransactions/{pendingId}`
**管理模組**: LBK、BK (記帳管理)
**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | must exist in users |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| pendingId | string | required | 暫存記錄ID | primary key, Date.now().toString() |
| originalInput | string | required | 使用者原始輸入 | max 200 chars, e.g. "火鍋66666新光" |
| parsedData | object | required | 已解析的資料 | see below |
| processingStage | string | required | 處理階段 | enum: PENDING_CATEGORY/PENDING_WALLET/COMPLETED/CANCELLED |
| stageData | object | optional | 階段資料 | see below |
| ambiguityInfo | object | optional | 歸類邏輯資訊 | see below |
| metadata | object | required | 元數據 | see below |
| expiresAt | timestamp | required | 過期時間 | default: createdAt + 30 minutes |
| completedTransactionId | string | optional | 完成後的收支ID | 轉換為正式收支後的ID |
| completedAt | timestamp | optional | 完成時間 | |

**Substructures**:
```javascript
parsedData: {
  amount: number,           // 已解析的金額
  description: string,      // 描述資訊
  rawCategory: string,       // 原始科目關鍵字
  rawWallet: string         // 原始支付方式關鍵字
}

stageData: {
  categorySelected: boolean,     // 科目是否已選擇
  walletSelected: boolean,      // 錢包是否已選擇
  selectedCategory: {            // 已選擇的科目資訊
    categoryId: string,          // 科目ID (主鍵)
    categoryName: string         // 科目名稱
  },
  selectedWallet: {             // 已選擇的錢包資訊
    walletId: string,           // 錢包ID (對應wallets.walletId)
    walletName: string,         // 錢包名稱
  }
}

ambiguityInfo: {
  currentAmbiguity: string,     // 當前歸類類型: category/wallet/none
  categoryOptions: array,        // 科目選項列表
  walletOptions: array          // 支付方式選項列表
}

metadata: {
  source: string,               // 來源平台 (default: LINE)
  module: string,               // 處理模組 (default: LBK)
  version: string,              // 模組版本
  processId: string,            // 處理ID
  pendingId: string,            // Pending Record ID
  completionSource: string      // 完成來源標識
}
```

**State Machine**:
```
PENDING_CATEGORY → PENDING_WALLET → COMPLETED
PENDING_CATEGORY → COMPLETED (直接完成)
任何狀態 → CANCELLED (使用者取消)
```

**Business Rules**:
- 記錄預設30分鐘後過期，最多可延長至120分鐘
- 過期記錄自動清理，保留7天歷史記錄
- 狀態轉換必須符合定義的轉換規則
- COMPLETED 狀態的記錄將轉換為正式收支記錄
- 支援科目與支付方式的歸類邏輯
- 與 wallets 子集合建立 walletId 外鍵關聯
- 與 categories 子集合建立 categoryId 外鍵關聯

**Integration Points**:
- **Reference Collections**: `ledgers/{ledgerId}/categories` (科目解析), `ledgers/{ledgerId}/wallets` (支付方式解析)
- **Target Collection**: `ledgers/{ledgerId}/transactions` (完成後轉換目標)
- **Event Triggers**: onCreate (設定過期時間), onUpdate (驗證狀態轉換), onExpire (清理過期記錄)
- **Synonym Learning**: 支援科目與支付方式的同義詞學習機制

#### 4.2.1.4 (待改)Subcollection: budgets
**Subcollection Path**: `ledgers/{ledgerId}/budgets`
**管理模組**: BM (預算管理)
**用途**: 預算管理
**配置來源**: `無`

##### 4.2.1.4.1 (待改)Document: ledgers/{ledgerId}/budgets/{budgetId}
**Document Path**: `ledgers/{ledgerId}/budgets/{budgetId}`
**管理模組**: LBK、BK (記帳管理)
**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | must exist in users |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| budgetId | string | required | 預算唯一識別碼 | primary key |
| budgetName | string | required | 預算名稱 | |
| budgetType | string | required | 預算類型 | enum: monthly/yearly/quarterly/project/category |
| amount | number | required | 預算總金額 | |
| consumedAmount | number | required | 已使用金額 | |
| currency | string | required | 貨幣單位 | default: TWD |
| budgetStartdate | timestamp/date | required | 預算開始時間 | |
| budgetEnddate | timestamp/date | required | 預算結束時間 | |
| budgetCategories | array | optional | 預算分類配置 | |
| alertRules | object | required | 警示規則設定 | see below |
| createdBy | string | required | 建立者ID | |
| config_source | string | optional | 配置來源 | |

**Substructures**:
```javascript
alert_rules: {
  warning_threshold: number,      // 警告閾值 (%)
  critical_threshold: number,     // 嚴重閾值 (%)
  enable_notifications: boolean   // 啟用通知
}

categories: [
  {
    id: string,
    name: string,
    allocated_amount: number,
    used_amount: number,
    percentage: number,
    alert_threshold: number
  }
]
```

#### 4.2.1.5 Subcollection: transactions
**Subcollection Path**: `ledgers/{ledgerId}/transactions`
**管理模組**: LBK、BK (記帳管理)
**用途**: 記帳管理
**配置來源**: `無`

##### 4.2.1.5.1 Document: transactions
**Document Path**: `ledgers/{ledgerId}/transactions/{transactionId}`
**管理模組**: LBK、BK (記帳管理)
**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者ID | |
| ledgerId | string | required | 帳本ID | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| status | string | required | 帳號狀態 | enum：active / archived / deleted / inactive / suspended |
| transactionId | string | required | 收支ID | primary key |
| transactionName | string | required | 收支名稱 | |
| transactionAmount | number | required | 收支金額 | |
| categoryId | number | required | 科目ID | |
| categoryName | string | required | 科目名稱 | |
| categorySynonyms | string | required | 科目同義詞 | comma separated |
| categoryType | string | required | 科目收支類型 | enum: income/expense |
| walletId | string | required | 帳本ID | |
| walletName | string | required | 帳戶名稱 | max 50 chars |
| walletSynonyms | string | required | 帳戶同義詞 | comma separated |

## 4.3 (待改)集合：協作管理

**架構**:
Collection：collaborations
  Documents：{collaborationId}
    Subcollction：members
    Subcollction：invitations
    Subcollction：wallets
    Subcollction：categories
    Subcollction：transactions
    Subcollction：budgets
    Subcollction：pendingTransactions

#### 4.3.1 (待改)Collection: collaborations
**Document ID**: ledgerId

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| ledgerId | string | required | 帳本ID | primary key |
| ownerId | string | required | 帳本擁有者ID | |
| collaborationType | string | required | 協作類型 | enum: shared/project/category |
| status | string | required | 協作狀態 | enum：active / archived / deleted / inactive / suspended |
| members | array | required | 成員清單 | see below |
| settings | object | required | 協作設定 | see below |
| permissions | object | optional | 權限配置 | |
| createdAt | timestamp | required | 建立時間 | |
| updatedAt | timestamp | required | 更新時間 | |

**Substructures**:
```javascript
members: [
  {
    memberId: string,
    UID: string,
    permissionLevel: string,    // owner/admin/member/viewer
    joinedAt: timestamp,
    invitedBy: string,
    status: string             // active/invited/suspended
  }
]

settings: {
  allowInvite: boolean,
  allowEdit: boolean,
  allowDelete: boolean,
  requireApproval: boolean,
  maxMembers: number,
  invitationExpireDays: number
}

permissions: {
  owner: string,
  admins: array,
  members: array,
  viewers: array
}
```

**Subcollections**:
| Subcollection | Description |
|---------------|-------------|
| members | 成員管理子集合 |
| invitations | 邀請管理子集合 |

#### 4.3.1.1 (待改)Subcollection: collaborations/{ledgerId}/members
**Collection Path**: `collaborations/{ledgerId}/members`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| UID | string | required | 使用者唯一識別碼 | primary key |
| email | string | optional | 使用者電子郵件 | |
| role | string | required | 角色 | enum: owner/admin/member/viewer |
| permissions | object | optional | 權限設定 | |
| joinedAt | timestamp | required | 加入時間 | |
| status | string | required | 成員狀態 | enum：active / archived / deleted / inactive / suspended |
| createdAt | timestamp | required | 創建時間 | |
| updatedAt | timestamp | required | 更新時間 | |
| createdBy | string | required | 創建者 | |

#### 4.3.1.2 (待改)Subcollection: collaborations/{ledgerId}/invitations
**Collection Path**: `collaborations/{ledgerId}/invitations`

**Fields**:
| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| invitationId | string | required | 邀請唯一識別碼 | primary key |
| inviterId | string | required | 邀請者ID | |
| inviteeEmail | string | required | 被邀請者email | |
| role | string | required | 預設角色 | |
| status | string | required | 邀請狀態 | enum：active / archived / deleted / inactive / suspended |
| createdAt | timestamp | required | 建立時間 | |
| expiresAt | timestamp | required | 邀請過期時間 | |

#### 4.3.1.3 (待改)Subcollection: collaborations/{ledgerId}/wallets
**Subcollection Path**: `collaborations/{ledgerId}/wallets`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 錢包、帳戶
**配置來源**: `0302. Default_wallet.json`

**Fields**:
同4.2.1.1

#### 4.3.1.4 (待改)Subcollection: collaborations/{ledgerId}/categories
**Subcollection Path**: `collaborations/{ledgerId}/categories`
**管理模組**: WCM (帳戶與科目管理)
**用途**: 科目
**配置來源**: `0099. Subject_code.json`

**Fields**:
同4.2.1.2

#### 4.3.1.5 (待改)Subcollection: collaborations/{ledgerId}/pendingTransactions
**Subcollection Path**: `collaborations/{ledgerId}/pendingTransactions`
**管理模組**: LBK (快速記帳模組)
**用途**: 暫存多階段處理的記帳資料，支援科目與支付方式歸類邏輯
**配置來源**: `0305. Default_pendingTransaction.json`

**Fields**:
同4.2.1.3

#### 4.3.1.6 (待改)Subcollection: collaborations/{ledgerId}/budgets
**Subcollection Path**: `collaborations/{ledgerId}/budgets`
**管理模組**: BM (預算管理)
**用途**: 預算管理
**配置來源**: `無`

**Fields**:
同4.2.1.4

#### 4.3.1.7 (待改)Subcollection: collaborations/{ledgerId}/transactions
**Subcollection Path**: `collaborations/{ledgerId}/transactions`
**管理模組**: LBK、BK (記帳管理)
**用途**: 記帳管理
**配置來源**: `無`

**Fields**:
同4.2.1.5

## 4.4 (待改)集合：系統配置

#### 4.4.1 Collection: _system
**Document ID**: config_name

用於儲存各種系統架構定義、預設設定配置、模組結構配置等文檔。

**重要配置來源**: 所有預設配置來自**03. Default_config資料夾**，包括：
- `0301. Default_config.json` - 系統主要配置
- `0302. Default_wallet.json` - 預設帳戶配置  
- `0303. Default_currency.json` - 預設貨幣配置
- `0304. Default_assessment.json` - 預設評估配置
- `0305. Default_pendingTransaction.json` - Pending Record預設配置
- `0099. Subject_code.json` - 科目代碼配置

**動態路徑解析機制**: 支援WCM和BM模組的動態路徑解析功能，自動識別：
- 獨立帳本路徑：`ledgers/{ledgerId}/wallets` 或 `ledgers/{ledgerId}/budgets`
- 協作帳本路徑：`collaborations/{ledgerId}/members/{memberId}/wallets` 或類似結構

# 5. (待改)關聯架構 (Relations)

### 5.1 主要關聯關係
• **users.UID** → **ledgers.owner**
• **users.UID** → **ledgers.UID**  
• **users.UID** → **collaborations.ownerId**
• **users.UID** → **collaborations.members.UID**
• **ledgers.id** → **collaborations.ledgerId**
• **ledgers.id** → **budgets.ledgerId**
• **ledgers.id** → **wallets.ledgerId**
• **ledgers.id** → **categories.ledgerId**

### 5.2 模組間資料流
```
users (1) ——— (many) ledgers
users (1) ——— (many) collaborations
ledgers (1) ——— (many) wallets
ledgers (1) ——— (many) categories  
ledgers (1) ——— (many) budgets
collaborations (1) ——— (many) members
collaborations (1) ——— (many) invitations
```

________________________________________

# 6. (待改)驗證規則 (Validation Rules)

### 6.1 使用者類型驗證
- userType 必須為 M/S/J 之一
- M 類型：可建立多個帳本，具管理權限
- S 類型：單一帳本使用者
- J 類型：僅可加入他人帳本

### 6.2 權限等級驗證
- owner: level 4, actions: ["all"]
- admin: level 3, actions: ["invite", "remove", "edit", "view", "manage_permissions"]  
- member: level 2, actions: ["edit", "view", "invite_limited"]
- viewer: level 1, actions: ["view"]

### 6.3 業務邏輯驗證
- amount 必須 > 0
- consumedAmount >= 0
- consumedAmount <= amount * 1.5 (允許超支 50%)
- budgetStartdate < budgetEnddate

________________________________________

# 7. (待改)資料生命週期 (Lifecycle)

### 7.1 狀態轉換規則

#### 使用者狀態
```
active → suspended → deleted
active → deleted (直接刪除)
```

#### 帳本狀態  
```
active → archived → deleted
```

### 7.2 模組特定週期

#### 協作狀態
```
active → suspended → archived
active → archived (正常結束)
```

#### 預算狀態
```
active → completed → archived
active → archived (提前結束)
```

________________________________________

# 8. (待改)索引配置 (Indexes)

### 8.1 效能最佳化索引

#### 複合索引
```javascript
// collaborations
{
  "collectionGroup": "collaborations",
  "fields": [
    {"fieldPath": "ledgerId", "order": "ASCENDING"},
    {"fieldPath": "UID", "order": "ASCENDING"}, 
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// budgets
{
  "collectionGroup": "budgets", 
  "fields": [
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "budgetStartdate", "order": "ASCENDING"}
  ]
}
```

### 8.2 複合查詢索引
```javascript
// wallets
{
  "collectionGroup": "wallets",
  "fields": [
    {"fieldPath": "UID", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// categories  
{
  "collectionGroup": "categories",
  "fields": [
    {"fieldPath": "UID", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "type", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 基本查詢索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "UID", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "processingStage", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 過期記錄清理索引
{
  "collectionGroup": "pendingTransactions", 
  "fields": [
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "expiresAt", "order": "ASCENDING"}
  ]
}

// pendingTransactions - 狀態機轉換索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "UID", "order": "ASCENDING"},
    {"fieldPath": "processingStage", "order": "ASCENDING"},
    {"fieldPath": "updatedAt", "order": "DESCENDING"}
  ]
}

// pendingTransactions - 歸類邏輯索引
{
  "collectionGroup": "pendingTransactions",
  "fields": [
    {"fieldPath": "UID", "order": "ASCENDING"},
    {"fieldPath": "ambiguityInfo.currentAmbiguity", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}

// users
{
  "collectionGroup": "users",
  "fields": [
    {"fieldPath": "userType", "order": "ASCENDING"},
    {"fieldPath": "status", "order": "ASCENDING"},
    {"fieldPath": "createdAt", "order": "DESCENDING"}
  ]
}
```

________________________________________

# 9. 刪除

# 10. (待改)安全考量 (Security Considerations)

### 10.1 存取權限
- 使用者僅可存取自己的 ledgers 和相關子集合
- 協作帳本依據 members 權限等級控制存取
- 系統管理員可存取 _system 集合

### 10.2 資料隔離
- 每個 ledger 的子集合完全隔離
- 跨平台帳號關聯需要驗證
- 敏感資訊 (如 device info) 需加密儲存

### 10.3 審計追蹤
- 所有重要操作記錄於 collaboration_logs
- 模組操作包含 module 和 version 資訊
- 保留完整的時間戳追蹤

