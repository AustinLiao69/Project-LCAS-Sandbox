------------------------------------------          
20251115. ç ”ç©¶å¦‚ä½•è¨­å®šfirebase authenctication

äº†è§£ï¼Œä½ çš„å¾Œç«¯æ¶æ§‹æ˜¯ **APL â†’ ASL â†’ BL â†’ Firebase**ï¼Œå…¶ä¸­ï¼š

* **APL / ASL = åƒ…è² è²¬è½‰ç™¼è«‹æ±‚ï¼Œä¸å«æ¥­å‹™é‚è¼¯**
* **BL (Business Logic) = æ”¾æ‰€æœ‰æ¥­å‹™é‚è¼¯ï¼ŒåŒ…å« Auth Middleware**
* **Firebase Admin (Service Account)** åªæœƒåœ¨ **BL** ä½¿ç”¨

æˆ‘ä¾ç…§ä½ çš„å¯¦éš›æ¶æ§‹ **é‡æ–°æ•´ç†ä¸¦é‡å¯«ä¸€æ•´å¥— Firebase Authentication è¨­å®šæµç¨‹**ï¼ˆmobile app + Node.js å¾Œç«¯ï¼Œauth middleware æ”¾åœ¨ BLï¼‰ã€‚

---

# âœ… **Firebase Authentication è¨­å®šæµç¨‹ï¼ˆä¾ç…§ä½ çš„æƒ…å¢ƒé‡æ–°æ’°å¯«ï¼‰**

---

# **ğŸ”¥ A. Firebase Console ç«¯è¨­å®š**

é€™äº›å‹•ä½œåªæœƒåœ¨ *Firebase console* åšä¸€æ¬¡ï¼š

### **1. é–‹å•Ÿ Authentication æ¨¡çµ„**

Firebase Console â†’ Authentication â†’ **Get Started**

### **2. é–‹å•Ÿä½ è¦æ”¯æ´çš„ç™»å…¥æ–¹å¼**

ä¾‹å¦‚ï¼š

* Email/Password
* Google Sign-In
* Apple Sign-In
* Phone Auth

---

# **ğŸ”¥ B. Mobile App ç«¯ï¼ˆAndroid / iOS / Flutterï¼‰**

å› ç‚ºä½ è¦åšçš„æ˜¯ mobile appï¼ˆä¸æ˜¯ webï¼‰ï¼Œæ‰€ä»¥ç™»å…¥è¡Œç‚ºç”± APP ç«¯å®Œæˆï¼š

### **æµç¨‹ï¼š**

1. **App ç”¨ Firebase Auth ç™»å…¥**
2. Firebase å›å‚³ **ID Token**
3. App å°‡ ID Token æ”¾é€² header â†’ Call ä½ çš„å¾Œç«¯

### **App â†’ Backend API Exampleï¼š**

```http
POST /api/xxx
Authorization: Bearer <firebase_id_token>
```

å¾Œç«¯ **ä¸ç”¢ Token**ï¼Œåªè² è²¬é©—è­‰ Tokenã€‚

---

# **ğŸ”¥ C. Node.js å¾Œç«¯ï¼ˆBL å±¤ï¼‰ä½¿ç”¨ Firebase Admin é©—è­‰ Token**

å› ç‚º APL / ASL ä¸å…è¨±æ¥­å‹™é‚è¼¯
ğŸ‘‡ æ‰€ä»¥ **Auth Middleware å¿…é ˆæ”¾åœ¨ BL**

ä½ çš„ BL è¦åšï¼š

1. å®‰è£ Firebase Admin
2. ä½¿ç”¨ Service Account åˆå§‹åŒ–
3. å¯«ä¸€å€‹ `verifyFirebaseIdToken` middleware
4. æ‰€æœ‰éœ€è¦ç™»å…¥çš„ API éƒ½è¦å…ˆç¶“éé€™å€‹ middleware

---

# **1ï¸âƒ£ åœ¨ BL å®‰è£ Firebase Admin**

```bash
npm install firebase-admin
```

---

# **2ï¸âƒ£ ä½¿ç”¨ Service Account åˆå§‹åŒ– Adminï¼ˆBL å±¤ï¼‰**

```js
// bl/firebase.js
const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

module.exports = admin;
```

---

# **3ï¸âƒ£ åœ¨ BL å»ºç«‹ Auth Middleware**

```js
// bl/middlewares/auth.js
const admin = require("../firebase");

async function verifyFirebaseIdToken(req, res, next) {
  const header = req.headers.authorization || "";
  const token = header.startsWith("Bearer ") ? header.slice(7) : null;

  if (!token) {
    return res.status(401).json({ error: "Missing token" });
  }

  try {
    const decoded = await admin.auth().verifyIdToken(token);
    req.user = decoded; // å¾ŒçºŒ BL handler å¯å–å¾— user.uid ç­‰è³‡æ–™
    next();
  } catch (err) {
    return res.status(401).json({ error: "Invalid token" });
  }
}

module.exports = verifyFirebaseIdToken;
```

---

# **4ï¸âƒ£ åœ¨ BL API ä½¿ç”¨ Middleware**

APL â†’ ASL â†’ **BLï¼ˆé€™é‚Šæ‰æ”¾ middlewareï¼‰**

```js
// bl/routes/user.js
const express = require("express");
const router = express.Router();
const verifyFirebaseIdToken = require("../middlewares/auth");

router.get("/profile", verifyFirebaseIdToken, async (req, res) => {
  const user = req.user; // Firebase user info
  res.json({ uid: user.uid, email: user.email });
});

module.exports = router;
```

---

# **5ï¸âƒ£ APL / ASL çš„å·¥ä½œï¼šå®Œå…¨åªè½‰ç™¼**

### APL / ASL ä¸èƒ½é©—è­‰ Tokenï¼Œåªè½‰çµ¦ BLï¼š

```js
// apl â†’ è½‰ç™¼æ‰€æœ‰ header å’Œ body
axios.post("http://asl/xxx", req.body, { headers: req.headers });
```

ASL åŒç†ï¼Œåªè² è²¬ forwardï¼Œä¸åŒ…å«æ¥­å‹™é‚è¼¯ã€‚

---

# **ğŸ“Œ æœ€çµ‚å®Œæ•´æµç¨‹åœ–ï¼ˆä¾ä½ çš„æ¶æ§‹ï¼‰**

```
Mobile App
   â†“    (Firebase Auth login)
Firebase Authentication
   â†“  (App æ‹¿åˆ° ID Token)
Mobile App
   â†“  (Authorization: Bearer <token>)
APL (è½‰ç™¼)
   â†“
ASL (è½‰ç™¼)
   â†“
BL (é©—è­‰ Token + åŸ·è¡Œæ¥­å‹™é‚è¼¯)
   â†“
Firestore / Storage / å…¶ä»–è³‡æ–™
```

---

# **ğŸ¯ æœ€çµ‚ä½ è¦å®Œæˆçš„äº‹æƒ…**

| å±¤ç´š               | éœ€è¦åšçš„äº‹                                        |
| ---------------- | -------------------------------------------- |
| Firebase Console | é–‹å•Ÿ Auth æ¨¡çµ„èˆ‡å„ç™»å…¥æ–¹å¼                             |
| Mobile App       | ä½¿ç”¨ Firebase Auth ç”¢ç”Ÿ ID Token                 |
| APL              | åªè½‰ç™¼ï¼ˆä¸åšé‚è¼¯ï¼‰                                    |
| ASL              | åªè½‰ç™¼ï¼ˆä¸åšé‚è¼¯ï¼‰                                    |
| **BLï¼ˆä½ çš„é‡é»ï¼‰**     | åˆå§‹åŒ– Firebase Adminã€å»ºç«‹ Auth middlewareã€ä¿è­· API |

---

# â­ æˆ‘å¯ä»¥å¹«ä½ åšæ›´å®Œæ•´çš„ç‰ˆæœ¬

å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘å¯ä»¥ï¼š

* å¹«ä½ å¯«å‡º **å®Œæ•´çš„åˆ†å±¤æ¶æ§‹ç¯„ä¾‹ï¼ˆAPL/ASL/BLï¼‰**
* å¹«ä½ å¯«å‡º **Flutter / iOS / Android ç«¯ç™»å…¥ä¸¦å‚³ token çš„ç¯„ä¾‹**
* å»ºç«‹ä¸€å¥— **æ¨™æº–åŒ–çš„ Auth Flow**ï¼ˆåƒä½  Project LCAS çš„æ¶æ§‹ï¼‰

ä½ æƒ³è¦å“ªä¸€å¡Šï¼Ÿ



------------------------------------------
20251115. ç ”ç©¶å¦‚ä½•è¨­å®šfirebase authenctication


å¤ªå¥½äº†ï¼â€¨ç…§ä½ ç›®å‰çš„ç‹€æ³ï¼Œå…¶å¯¦ Firebase Authentication çš„è¨­å®šï¼Œä½ å·²ç¶“å®Œæˆ 90% äº†ã€‚
å‰©ä¸‹çš„ï¼Œå°±æ˜¯è®“ã€Œä½ çš„å¾Œç«¯ã€çŸ¥é“æ€éº¼è¾¨è­˜ã€Œå“ªå€‹ mobile ä½¿ç”¨è€…å·²ç™»å…¥ã€ã€‚
ä¸‹é¢æ˜¯æ ¹æ“šä½ ç›®å‰çš„ç‹€æ³ï¼Œæœ€å¾Œéœ€è¦å®Œæˆçš„è¨­å®šæµç¨‹ï¼ˆä¹Ÿæ˜¯ Firebase Auth çš„æœ€å¾Œä¸€å¡Šï¼‰ã€‚

ğŸ¯ ä½ ç›®å‰ Firebase Auth çš„è¨­å®šé€²åº¦
æ­¥é©Ÿ
ç‹€æ…‹
å»ºç«‹ Firebase å°ˆæ¡ˆ
âœ” å®Œæˆ
å•Ÿç”¨ Sign-in providersï¼ˆEmail/Google ç­‰ï¼‰
âœ” å®Œæˆ
ä¸éœ€è¦ Web
âœ” å› ç‚ºä½ æ˜¯ Mobile
ä¸‹è¼‰ service accountï¼ˆAdmin SDKï¼‰
âœ” å®Œæˆï¼Œç”¨ä¾†åš Firestore
æ‰€ä»¥ Firebase Authenticationã€ŒConsole ç«¯ã€ä½ å·²ç¶“è¨­å®šå…¨éƒ¨äº†ã€‚
ä½ ç¾åœ¨åªå·® å¾Œç«¯çš„ Auth é©—è­‰é‚è¼¯ã€‚

ğŸ”¥ Firebase Authenticationã€Œå®Œæ•´è¨­å®šã€é‚„å·®æœ€å¾Œä¸€å¡Šï¼š
ğŸ”µ Step 4ï¼šå¾Œç«¯å¢åŠ  verifyIdTokenï¼ˆèº«ä»½é©—è­‰ Middlewareï¼‰
å› ç‚ºæœªä¾†ä½ çš„ Android/iOS App æœƒï¼š
  1	åœ¨è£ç½®ä¸Šç™»å…¥ Firebaseï¼ˆEmail/Google/etc.ï¼‰
  2	å¾—åˆ°ä¸€å€‹ ID Token
  3	æŠŠé€™å€‹ token å‚³çµ¦ä½ çš„ Node.js API
ä½ çš„å¾Œç«¯å¿…é ˆé©—è­‰é€™å€‹ token æ‰èƒ½çŸ¥é“æ˜¯å“ªä½ä½¿ç”¨è€…åœ¨å‘¼å« APIã€‚
ä½ å·²ç¶“æœ‰ Admin SDKï¼Œå¯ä»¥ç›´æ¥åšä¸‹é¢é€™æ®µï¼š

âœ” ç¬¬ä¸€æ­¥ï¼šåœ¨å¾Œç«¯æ–°å¢ Auth Middleware


1. å°±project lcasä¾†èªªï¼Œé€™æ˜¯ä¸€å€‹æ¨¡çµ„çš„æ„æ€å—ï¼Ÿ é‚£ä»–çš„è·è²¬æ˜¯ä»€éº¼ï¼Ÿè«‹è©³ç´°èªªæ˜

2. ä¸‹é¢çš„ä»£ç¢¼æ˜¯node.jså—ï¼Ÿ


import admin from "firebase-admin";

export async function authMiddleware(req, res, next) {
  const header = req.headers.authorization || "";
  const token = header.startsWith("Bearer ") ? header.substring(7) : null;

  if (!token) {
    return res.status(401).json({ error: "Missing token" });
  }

  try {
    // é©—è­‰ ID Token
    const decoded = await admin.auth().verifyIdToken(token);
    req.user = decoded; // æŠŠä½¿ç”¨è€…è³‡æ–™æ”¾é€² req.user
    next();
  } catch (err) {
    return res.status(401).json({ error: "Invalid token" });
  }
}

âœ” ç¬¬äºŒæ­¥ï¼šæŠŠ middleware ç”¨åœ¨éœ€è¦ç™»å…¥çš„ API
=>ä¸‹é¢è£œå……ä¸€ä¸‹ç¾åœ¨çš„project lcasæ¶æ§‹

PLè·ŸAPLæ˜¯æ”¾åœ¨mobileç«¯ï¼ŒPLåŒ…å«UIä»¥åŠæ¥­å‹™é‚è¼¯çš„éƒ¨åˆ†ï¼Œä½†ç¾åœ¨æˆ‘å°ˆæ³¨åœ¨æ¥­å‹™é‚è¼¯ã€‚

æ‰€ä»¥é€™å€‹Auth Middlewareæ”¾ç½®çš„ä½ç½®æ˜¯åœ¨BLï¼Œdata flowæœƒæ˜¯å¾PLæ‰“ä¸€å€‹ä½¿ç”¨è€…è³‡æ–™éä¾†åˆ°æ­¤æ¨¡çµ„ï¼Œç„¶å¾Œæ­¤æ¨¡çµ„å†å»call firebase authå°å—ï¼Ÿ


### 0.4 PLæŒ‡Presentation layerï¼Œå³Mobileç«¯ä¹‹é é¢ç¾¤èˆ‡åŠŸèƒ½ç¾¤ã€‚
### 0.5 APLæŒ‡Application layerï¼Œå³Mobileç«¯ä¹‹RESTful APIè½‰ç™¼çª—å£ã€‚
### 0.6 ASLæŒ‡Application service layerï¼Œå³å¾Œç«¯ä¹‹ä¹‹RESTful APIè½‰ç™¼çª—å£ã€‚
### 0.7 BLæŒ‡Business layerï¼Œå³å¾Œç«¯ä¹‹æ¥­å‹™é‚è¼¯ã€‚
### 0.8 DL(Firebase)æŒ‡Data layerï¼Œå³å„²å­˜ä½¿ç”¨è€…è¨˜å¸³ã€å¸³è™Ÿã€logç›¸é—œä¹‹Firebaseè³‡æ–™åº«ã€‚

import express from "express";
import { authMiddleware } from "./authMiddleware.js";

const app = express();

app.get("/profile", authMiddleware, async (req, res) => {
  res.json({
    uid: req.user.uid,
    email: req.user.email,
  });
});
å¦‚æ­¤ä¸€ä¾†ï¼Œ
  â€¢	ä»»ä½•å‰ç«¯ï¼ˆä½ çš„ mobile appï¼‰
  â€¢	åªè¦æœ‰å¸¶ Firebase ID Tokenâ€¨å¾Œç«¯å°±èƒ½çŸ¥é“æ˜¯èª°ç™»å…¥ã€‚

âœ” ç¬¬ä¸‰æ­¥ï¼ˆæœªä¾† App é–‹ç™¼æ™‚æ‰æœƒç”¨ï¼‰ï¼š
å–å¾— ID Tokenï¼ˆç¯„ä¾‹ï¼šFlutterï¼‰

final user = FirebaseAuth.instance.currentUser;
final token = await user?.getIdToken();
ç„¶å¾Œå‘¼å« APIï¼š

Authorization: Bearer <ID_TOKEN>

ğŸ“Œ ç¸½çµï¼ˆä½ ç¾åœ¨é‚„éœ€è¦åšçš„åªæœ‰é€™å€‹ï¼‰
ä½ å·²ç¶“å®Œæˆï¼š
  â€¢	Firebase Authentication è¨­å®š
  â€¢	Firestore è¨­å®š
  â€¢	Admin SDK è¨­å®š
å‰©ä¸‹æœ€å¾Œä¸€ä»¶ï¼š
ğŸ‘‰ åœ¨ Node.js å¾Œç«¯å¢åŠ  verifyIdToken middleware
åšå®Œé€™ä»¶äº‹å¾Œï¼ŒFirebase Auth çš„è¨­å®šå°± 100% å®Œæˆäº†ã€‚

å¦‚æœä½                     é¡˜æ„ï¼Œæˆ‘å¯ä»¥å”åŠ©ä½ ï¼š
  â€¢	å¹«ä½ ç”¢ç”Ÿå®Œæ•´çš„ Node.js å¾Œç«¯ Auth + Firestore å°è£
  â€¢	å¹«ä½ è¨­è¨ˆ mobile app æœªä¾†çš„ç™»å…¥æµç¨‹ï¼ˆEmailã€Googleã€Apple çš†å¯ï¼‰
  â€¢	å¹«ä½ èª¿æ•´ Firestore è¦å‰‡ï¼ˆä¾ç…§ä½ æ˜¯å¾Œç«¯ä¸»æ§æˆ–å‰ç«¯ç›´æ¥å­˜å–ï¼‰


ä½ éœ€è¦æˆ‘ä¸‹ä¸€æ­¥åšå“ªå€‹ï¼Ÿ

