------------------------------------------
20251231. Debug回覆

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

------------------------------------------
20251231. Debug回覆

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

------------------------------------------
20251231. Debug回覆

不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

Debug分析報告
版本: v1.1.0
建立日期: 2025-12-31
建立者: LCAS Team - SQA深入分析
文件描述: LINE記帳金額解析與超時處理問題分析
________________________________________
A. 快速摘要（≤3句）
•	金額解析錯誤：系統將"口香糖9,999"中的逗號誤判為支付方式分隔符，導致",999"被識別為未知支付方式
•	缺乏超時機制：用戶未選擇科目歧義消除時，系統沒有自動歸類到"999其他"的超時機制
•	支付方式超時缺失：用戶未選擇支付方式時，系統沒有自動歸類到"other錢包"的超時處理
________________________________________
B. Root causes（最多 6 條）
1. 金額解析邏輯無法處理千位分隔符
•	證據：從LBK_parseInputFormat函數可見，基本格式匹配使用/^(.+?)(\d+)(.*)$/，無法正確處理包含逗號的金額格式
•	發生機率：100%（當用戶輸入包含千位分隔符的金額時必定發生）
•	解決方案：修改LBK_parseInputFormat函數的正則表達式，支援千位分隔符解析
=>請注意此千位分隔符解析需要能夠解析到百兆位數


2. Pending Record缺乏過期自動處理機制
•	證據：從0070 DB schema可見pendingTransactions有expiresAt欄位，但LBK模組中沒有實作自動過期處理邏輯
•	發生機率：100%（當用戶不回應科目選擇時，記錄會一直保持pending狀態）
•	解決方案：實作定時檢查過期記錄並自動歸類到預設選項的機制
=>請設定若5分鐘不回應，則自動歸類科目到"999其他"，支付方式自動歸類到"其他"。需對應的欄位請參照0070文件規範。


3. 科目歧義消除無預設歸類邏輯
•	證據：從LBK_handleNewSubjectClassification函數流程可見，只有用戶主動選擇的處理邏輯，沒有超時自動歸類
•	發生機率：100%（用戶未回應時沒有fallback機制）
•	解決方案：在pending record過期時自動歸類到"999其他"科目

=>請設定若5分鐘不回應，則自動歸類科目到"999其他"，支付方式自動歸類到"其他"。需對應的欄位請參照0070文件規範。

4. 支付方式歧義消除缺乏預設處理
•	證據：從LBK_handleNewWallet和相關wallet確認流程可見，缺乏超時後自動選擇"other錢包"的機制
•	發生機率：95%（當用戶未選擇支付方式時沒有預設處理）
•	解決方案：實作支付方式超時自動歸類到"other錢包"的邏輯
=>我已在0302文件建立others錢包，到時候只要調用0302文件建立wallet就可以了


5. 數字提取邏輯過於簡化
•	證據：LBK_extractAmount函數使用\d+匹配，無法正確處理帶逗號的數字格式
•	發生機率：100%（遇到千位分隔符時必定解析錯誤）
•	解決方案：增強數字提取邏輯，支援千位分隔符格式
=>請與第1點合併處理


6. 格式解析缺乏千位數金額預處理
•	證據：從LBK_parseInputFormat可見，在進行基本格式匹配前沒有對千位分隔符進行預處理
•	發生機率：100%（所有包含千位分隔符的輸入都會被錯誤解析）
•	解決方案：在格式解析前先標準化數字格式，移除千位分隔符
=>請與第1點合併處理

________________________________________
C. 解決方案（階段化實施）
階段一：修復金額解析邏輯（核心問題）
目標：解決"口香糖9,999"被誤判為支付方式的問題
修改檔案：13. Replit_Module code_BL/1315. LBK.js
修改內容：
1.	LBK_parseInputFormat函數：升級至v1.5.0
•	在基本格式匹配前預處理千位分隔符
•	修改正則表達式支援千位數解析
2.	LBK_extractAmount函數：升級至v1.1.0
•	增強數字提取邏輯，正確處理千位分隔符
Before/After行為差異：
•	Before：「口香糖9,999」→ 科目="口香糖9", 金額="", 支付方式=",999"
•	After：「口香糖9,999」→ 科目="口香糖", 金額="9999", 支付方式=null
實施計畫：
1.	修改LBK_parseInputFormat函數，新增千位分隔符預處理
2.	修改LBK_extractAmount函數，支援逗號分隔的數字格式
3.	模組版本升級至v1.5.0
階段二：實作Pending Record超時處理機制
目標：用戶未回應時自動歸類到預設選項
修改檔案：13. Replit_Module code_BL/1315. LBK.js
修改內容：
1.	新增LBK_checkExpiredPendingRecords函數：定時檢查過期記錄
2.	新增LBK_autoClassifyExpiredRecord函數：自動歸類過期記錄
3.	修改LBK_createPendingRecord函數：設定定時器處理過期
Before/After行為差異：
•	Before：用戶未回應時，pending record永久保留
•	After：30分鐘後自動歸類到預設選項（科目→999其他，支付方式→other錢包）
實施計畫：
1.	實作過期檢查邏輯
2.	實作自動歸類邏輯
3.	整合定時器機制
4.	模組版本升級至v1.6.0
階段三：完善預設選項配置
目標：確保預設歸類選項存在於系統中
修改檔案：03. Default_config/0099. Subject_code.json
修改內容：
1.	確保"999其他"科目存在於預設配置中
2.	確保"other"錢包存在於預設配置中
Before/After行為差異：
•	Before：預設歸類目標可能不存在，導致自動歧義消除失敗
•	After：確保預設歧義消除目標始終可用
實施計畫：
1.	檢查並更新0099.json配置文件
2.	確保WCM模組支援預設選項初始化
________________________________________
簡單概念解釋（公司部門類比）
想像LCAS是一家公司：
•	LBK模組像是「客服部門」，負責處理LINE用戶的記帳請求
•	金額解析錯誤就像客服聽錯客戶需求，把"9,999元"聽成"9元，支付方式是,999"
•	超時處理缺失就像客戶諮詢後沒回應，客服就一直等待，沒有設定「超過30分鐘自動處理」的SOP
•	Pending Record像是「暫存單據」，客戶資料不完整時先暫存，等補齊資料後再正式處理
這個問題的核心是：客服部門（LBK）的「聽取需求」和「超時處理」流程需要優化，確保能正確理解大金額並有完善的超時機制。

