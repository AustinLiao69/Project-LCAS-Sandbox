------------------------------------------
20251216. 執行DCN-0024
不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

------------------------------------------
20251216. 執行DCN-0024
Approved請進行階段一


📊 SA分析報告：DCN-0024實施計畫盤點與修正
根據您的回饋，我重新檢視了實施計畫，發現了幾個重要問題：
🔍 現有函數盤點分析
經過檢查LBK.js模組，發現以下已存在的函數：
階段一：LBK模組中已存在的函數
1.	✅ LBK_handleNewSubjectClassification - 已存在（第1027行）
2.	✅ LBK_buildClassificationMessage - 已存在（第1087行）
3.	✅ LBK_processUserSelection - 已存在（第1116行）
需要修改的現有函數
•	LBK_identifySubject - 已有基礎架構，需要增強新科目檢測邏輯
💡 關鍵Insight
1.	模組職責邊界問題：WH模組確實只應負責轉發，所有業務邏輯包括狀態追蹤都應在LBK內處理
2.	資料來源混淆：科目結構簡化應修改0099.json檔案，而非AM模組邏輯
3.	功能重複開發風險：大部分核心函數已存在，避免重複實作

🎯 修正後解決方案
階段一：LBK模組增強（實際工作量大幅降低）
修改內容：
1.	增強既有的LBK_identifySubject函數，當科目不存在時正確觸發歸類流程
2.	驗證現有的新科目歸類函數運作正常
3.	確保歸類結果正確儲存至categories集合
修改檔案：
•	13. Replit_Module code_BL/1315. LBK.js → v1.4.0（小幅修改）

階段二：WH模組最小化修改
修改內容：
1.	確保WH模組能正確轉發科目歸類回應給LBK
2.	移除任何業務邏輯，純粹轉發機制
修改檔案：
•	13. Replit_Module code_BL/1320. WH.js → v2.5.0（極小修改）

階段三：0099文件簡化
修改內容：
1.	修改00. Master_Project document/0099. Subject_code.json
2.	實施簡化科目結構，僅保留主科目
3.	清空或最小化synonyms欄位
修改檔案：
•	00. Master_Project document/0099. Subject_code.json
📈 修正後的影響評估
工作量大幅降低：
•	原估計需新增多個函數 → 實際只需修改現有函數
•	原估計需要大幅重構 → 實際只需小幅調整
•	原估計跨模組複雜整合 → 實際主要集中在LBK模組
風險大幅降低：
•	避免重複開發既有功能
•	保持模組職責邊界清晰
•	減少跨模組依賴關係
✅ 建議執行順序
1.	優先修改0099.json - 最低風險，影響範圍可控
2.	調整LBK模組 - 利用既有函數，風險較低
3.	微調WH模組 - 最小化修改，確保轉發正常
這樣的修正版本更符合MVP原則，避免過度工程，專注解決核心問題。



------------------------------------------
20251216. 執行DCN-0024
不要寫code，請根據我的回覆更新提案。提案時請專注解決當前發生的問題就好，不需要優化、強化、驗證、監測、測試等手段，除了列出原因之外也請你提出insight。

🎯 解決方案
根據DCN-0024文件的三步驟辨識流程：輸入→識別→歸類，我提出以下階段性實施計畫：

=>請盤點你的實施計畫裡面有哪些新增的函數其實是可以在該模組內找到的？

階段一：LBK模組新增新科目辨識機制
目標：在LBK模組中新增當科目識別失敗時的處理邏輯
修改內容：
1.	修改LBK_identifySubject函數，當科目不存在時觸發新科目歸類流程
2.	新增LBK_handleNewSubjectClassification函數處理使用者歸類選擇
3.	新增主科目選單生成與使用者回應處理邏輯
修改檔案：
•	13. Replit_Module code_BL/1315. LBK.js → v1.4.0
Before/After行為差異：
•	Before: 遇到未知科目直接回傳記帳失敗
•	After: 遇到未知科目時回覆科目選單，等待使用者歸類後完成記帳
影響範圍：僅影響LINE記帳流程，不影響其他記帳方式

階段二：WH模組整合新科目歸類流程
目標：修改WH模組以支援兩階段對話（科目歸類 + 記帳確認）
=>WH模組的功能只是轉發，不可以有業務邏輯，就算是回應的訊息也只能做在LBK裡面。

修改內容：
1.	修改WH_processEventAsync支援科目歸類回應處理
2.	新增狀態追蹤機制，記住使用者正在進行科目歸類
3.	整合LBK的新科目歸類結果處理
修改檔案：
•	13. Replit_Module code_BL/1320. WH.js → v2.5.0
Before/After行為差異：
•	Before: 單一輪次記帳對話
•	After: 支援多輪次對話，先歸類科目再確認記帳
影響範圍：影響LINE Webhook處理流程，但不影響已知科目的標準記帳

階段三：科目資料結構簡化
目標：實施0099文件簡化策略，提供10個主科目選項
修改內容：
1.	在AM模組初始化時使用簡化的科目結構
2.	移除複雜的子科目和大量同義詞
3.	確保新歸類的科目正確儲存到使用者的categories集合
=>跟AM沒有關係，AM只是調用而已，需要修改的是0099文件。

修改檔案：
•	13. Replit_Module code_BL/1309. AM.js → v2.8.0
•	更新科目初始化邏輯以使用簡化結構
Before/After行為差異：
•	Before: 複雜的科目結構，容易造成選擇困惑
•	After: 簡化為10個主科目，降低認知負擔
影響範圍：影響新使用者的科目初始化，不影響現有使用者資料




📋 實施計畫詳細說明
階段一實施細節
1.	新增函數：
•	LBK_handleNewSubjectClassification(inputData, processId)
•	LBK_buildClassificationInterface()
•	LBK_processUserSelection(selection, originalInput, userId)
2.	修改現有函數：
•	LBK_identifySubject：當識別失敗時不直接返回錯誤，而是觸發歸類流程
•	LBK_processQuickBookkeeping：支援兩階段處理邏輯
階段二實施細節
1.	狀態管理：使用NodeCache暫存使用者正在進行的歸類操作
2.	訊息路由：判斷使用者輸入是科目歸類回應(101-107,201,301,000)還是一般記帳輸入
3.	整合點：在WH_processEventAsync中新增科目歸類分支邏輯
階段三實施細節
1.	科目初始化：修改AM模組的AM_initializeUserCategories函數
2.	資料格式：使用DCN-0024定義的簡化格式（categoryId=null, subCategoryName=null, synonyms=""）
3.	歸類儲存：新歸類的科目加入對應主科目的synonyms欄位
📈 版本升級說明
•	LBK.js: v1.3.0 → v1.4.0
•	WH.js: v2.4.0 → v2.5.0
•	AM.js: v2.7.0 → v2.8.0
✅ 預期成果
完成後，LINE記帳將支援「飯糰28」→ 系統回覆科目選單 → 使用者選「104」→ 完成記帳並歸類的完整流程，符合DCN-0024文件的設計目標。
請確認此實施計畫是否符合需求，我將等待您的Approve後開始執行代碼修改。

