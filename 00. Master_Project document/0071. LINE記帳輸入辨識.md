
# 0071. LINE記帳輸入辨識

**版本**: 1.0.0  
**建立日期**: 2025-12-15  
**建立者**: LCAS Team  
**文件描述**: LINE記帳模式的簡化科目辨識流程設計

---

## 📑 目次 (Table of Contents)

1. [設計理念](#1-設計理念)
2. [功能分層策略](#2-功能分層策略)
3. [流程設計](#3-流程設計)
4. [技術實作要點](#4-技術實作要點)
5. [使用者體驗考量](#5-使用者體驗考量)
6. [資料結構設計](#6-資料結構設計)

---

## 1. 設計理念

### 1.1 核心概念
LINE記帳模式採用**簡化科目分類**策略，將複雜的子科目管理功能轉移至APP端的Expert模式，讓LINE記帳專注於快速、直覺的記帳體驗。

### 1.2 設計原則
- **簡化優先**: LINE端只處理主要科目分類（categoryName）
- **功能分層**: 子科目管理（subcategoryName）專屬於APP端Expert模式
- **使用者自主**: 新科目歸類由使用者主動選擇
- **資料保留**: 資料庫結構保持完整，僅在介面層簡化

---

## 2. 功能分層策略

### 2.1 LINE記帳模式
- **功能範圍**: 僅處理主科目分類（categoryName）
- **操作流程**: 文字輸入 → 主科目識別 → 快速記帳
- **新科目處理**: 引導使用者選擇主科目歸類

### 2.2 APP Expert模式
- **功能範圍**: 完整的主科目與子科目管理
- **操作權限**: 可編輯、創建、刪除子科目
- **管理功能**: 同義詞管理、科目階層調整

### 2.3 資料庫設計
- **欄位保留**: subcategoryName欄位完全保留
- **預設值**: LINE記帳時自動設定為預設子科目
- **編輯權限**: 僅APP端可修改subcategoryName

---

## 3. 流程設計

### 3.1 標準記帳流程
```
使用者輸入 → 科目識別 → 直接記帳完成
例：「午餐150」→ 識別為「餐飲費用」→ 記帳成功
```

### 3.2 新科目辨識流程

#### 步驟1: 使用者輸入
```
使用者在LINE輸入: "飯糰28"
```

#### 步驟2: 科目識別失敗處理
```
系統檢測：預設科目庫中無「飯糰」科目
觸發：新科目歸類流程
```

#### 步驟3: 主科目選擇介面
```
系統回覆：
"請問這是屬於什麼科目(輸入數字就好)？
101 生活家用
102 餐飲費用
103 交通費用
104 娛樂消遣
105 學習費用
201 財務支出
其他"
```

#### 步驟4: 使用者選擇主科目
```
使用者輸入: "102"
系統識別：選擇「餐飲費用」類別
```

#### 步驟5: 子科目設定確認
```
系統詢問：
"是否要設定子項科目？Yes or No?"
```

#### 步驟6: 子科目自動分配（選擇Yes時）
```
使用者輸入: "Yes"
系統處理：
- 查詢102類別下現有子科目代碼
- 自動分配空的子項代碼（如10206）
- 建立新的子科目記錄
```

#### 步驟7: 完成確認
```
系統回覆：
"已設定為 10206 飯糰"
完成記帳：金額28元，科目「飯糰」，歸類至「餐飲費用」
```

### 3.3 簡化流程（選擇No時）
```
使用者輸入: "No"
系統處理：
- 使用預設子科目（如10201 一般餐飲）
- 將「飯糰」設定為同義詞指向預設子科目
系統回覆：
"已歸類至餐飲費用，記帳完成"
```

---

## 4. 技術實作要點

### 4.1 LBK模組調整
- **科目查詢**: 優先查詢categoryName層級
- **同義詞管理**: 建立categoryName層級的同義詞對應
- **流程控制**: 實作多輪對話狀態管理

### 4.2 WCM模組支援
- **子科目分配**: 自動查詢可用的子項代碼
- **同義詞創建**: 動態建立新的同義詞關聯
- **資料驗證**: 確保科目代碼唯一性

### 4.3 對話狀態管理
```javascript
// 對話狀態結構
dialogState = {
  userId: "LINE_USER_ID",
  step: "awaiting_category_selection", // 當前步驟
  originalInput: "飯糰28",             // 原始輸入
  parsedAmount: 28,                    // 解析金額
  parsedItem: "飯糰",                  // 解析項目
  selectedCategory: null,              // 選擇的主科目
  timestamp: "2025-12-15T10:00:00Z"
}
```

### 4.4 科目映射邏輯
```
科目歸類優先順序：
1. 精確匹配 (完全相符的同義詞)
2. 模糊匹配 (部分相符的同義詞)
3. 新科目流程 (無匹配時觸發)
```

---

## 5. 使用者體驗考量

### 5.1 操作簡化
- **數字輸入**: 使用數字代碼降低輸入複雜度
- **二元選擇**: Yes/No簡化決策過程
- **即時確認**: 每步驟都有明確的回饋訊息

### 5.2 學習成本
- **一次設定**: 新科目設定後自動記憶
- **漸進學習**: 常用科目逐步建立個人化詞庫
- **容錯設計**: 錯誤輸入有適當的錯誤提示

### 5.3 頻率最佳化
- **常用優先**: 餐飲費用等高頻科目排在前面
- **彈性結構**: 支援個人化的科目順序調整
- **快速跳出**: 提供「其他」選項處理特殊情況

---

## 6. 資料結構設計

### 6.1 LINE記帳資料格式
```json
{
  "id": "timestamp_id",
  "userId": "LINE_USER_ID",
  "amount": 28,
  "description": "飯糰",
  "categoryId": "102",
  "categoryName": "餐飲費用",
  "subCategoryId": "10206", 
  "subCategoryName": "飯糰",    // 自動生成或預設
  "source": "LINE",
  "created_at": "2025-12-15T10:00:00Z"
}
```

### 6.2 同義詞對應表
```json
{
  "飯糰": {
    "categoryId": "102",
    "categoryName": "餐飲費用",
    "subCategoryId": "10206",
    "subCategoryName": "飯糰",
    "source": "user_defined",
    "created_by": "LINE_USER_ID"
  }
}
```

### 6.3 主科目清單
```json
{
  "categories": [
    {"id": "101", "name": "生活家用", "order": 1},
    {"id": "102", "name": "餐飲費用", "order": 2},
    {"id": "103", "name": "交通費用", "order": 3},
    {"id": "104", "name": "娛樂消遣", "order": 4},
    {"id": "105", "name": "學習費用", "order": 5},
    {"id": "201", "name": "財務支出", "order": 6}
  ]
}
```

---

## 實作優先順序

### Phase 1: 基礎流程實作
- [ ] 新科目辨識邏輯
- [ ] 主科目選擇介面
- [ ] 對話狀態管理

### Phase 2: 進階功能
- [ ] 子科目自動分配
- [ ] 同義詞動態建立
- [ ] 個人化科目順序

### Phase 3: 體驗優化
- [ ] 錯誤處理完善
- [ ] 使用統計分析
- [ ] 智慧推薦功能

---

**文件狀態**: Draft  
**下一步行動**:
1. LBK模組開發團隊評估技術可行性
2. UX團隊確認互動流程設計
3. 測試團隊制定測試案例
4. 開始Phase 1功能開發

**變更歷史**:
- v1.0.0 (2025-12-15): 初版建立，定義LINE記帳簡化科目辨識流程
